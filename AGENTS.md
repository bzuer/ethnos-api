# AGENTS.md — Definitive Guide for Agents in This Repository

This document guides automated agents and collaborators on how to analyze, implement, and document features in Ethnos_API. Follow it to maintain technical consistency, security, and standardization.

## Project Overview
- Runtime: Node.js (>= 18)
- Framework: Express
- Application entry: `src/app.js`
- Structure:
  - Routes: `src/routes/`
  - Controllers: `src/controllers/`
  - Services: `src/services/`
  - DTOs: `src/dto/`
  - Middleware: `src/middleware/`
  - Utils: `src/utils/`
  - OpenAPI: `config/swagger.config.js`
  - Generated documentation: `docs/`

Operational directive: keep absolute cleanliness, technical clarity, hierarchy, and standardization. Do not version generated artifacts, logs, backups, or dumps. Remove out-of-scope content.

## Response Conventions
- Respond via `responseFormatter` (global in `src/app.js`).
- Envelopes (see `src/utils/responseBuilder.js`):
  - SuccessEnvelope: `{ status: 'success', data, pagination?, meta? }`
  - ErrorEnvelope: `{ status: 'error', message, code, timestamp, meta? }`
- Pagination is mandatory for listings: `createPagination/normalizePagination` from `src/utils/pagination.js`.
  - Support both `page/limit` and `offset/limit` simultaneously.

## Security and Internal Access
- Protected endpoints require `X-Access-Key` header (case-insensitive: `x-access-key`, `x-internal-key`, `x-api-key`).
- Middleware: `src/middleware/accessKey.js`.
  - `requireInternalAccessKey` checks, in order: `API_KEY`, `INTERNAL_ACCESS_KEY`, `SECURITY_ACCESS_KEY`, `API_ACCESS_KEY`, `ETHNOS_API_KEY`, `ETHNOS_API_ACCESS_KEY`, `API_SECRET_KEY`.
  - `createAccessKeyGuard` for specific contexts.
- OpenAPI defines `securitySchemes.XAccessKey`.

## Development Standards
- Validation: `express-validator`.
- DTOs per domain (e.g., `work.dto.js`, `person.dto.js`, `organization.dto.js`, `venue.dto.js`).
- Errors: `res.fail(...)` and `res.error(err, ...)` with `ERROR_CODES`.
- Raw SQL via `sequelize.query`.
- Schema source of truth: `database/data_db.schema.sql`.

## Documentation (OpenAPI)
- UI: `/docs` (Swagger UI) sourced from `/docs.json`.
- JSON: `GET /docs.json`.
- YAML: `GET /docs.yaml` (aliases: `/openapi.yaml`, `/openapi.yml`).
- Generation scripts:
  - `npm run docs:generate`
  - `npm run docs:generate:yaml`
- Update Swagger JSDoc in routes when creating or modifying endpoints.
- Document `page`, `limit`, `offset` and use `$ref` for envelopes and pagination.

## Execution and Environments
- Runtime env: `/etc/node-backend.env` as single source of truth.
- Tests: `.env.test`.
- Development: `npm run dev`.
- Build: `npm run build`.
- Production: `./server.sh start`.

## Important Scripts
- `scripts/manage.sh` — deploy, tests, Sphinx, Swagger.
  - Deploy: stop API and Sphinx, clear caches, install deps (including dev), generate docs, start Sphinx, index, repair broken indexes, run tests, restart API.
  - Indexing: `scripts/manage.sh index` and `scripts/manage.sh index:fast`.
  - Sphinx: `scripts/manage.sh sphinx start|stop|status`.
- `scripts/process.sh` — standard build/dev/deploy flow (clears caches/runtime/logs, refreshes deps, warms docs cache, and runs tests or delegates deploy).
- `scripts/generate-swagger.js` — generates `docs/swagger.json` and `docs/swagger.yaml`.
- `rsync.sh` — syncs repo to `server@192.168.18.50:/home/server/api` and sends Sphinx indexes from `/var/lib/ethnos-api/sphinx`.

## Sphinx
- Template: `config/sphinx-unified.conf` (no secrets).
- Runtime config: `/var/run/ethnos-api/sphinx.conf` (generated by `manage.sh` from `/etc/node-backend.env`).
- Runtime: `/var/lib/ethnos-api/sphinx`, logs: `/var/log/ethnos-api`, PID: `/var/run/ethnos-api/sphinx.pid`.

## Repository Hygiene
- Ignore/clean: `logs/`, `coverage/`, `venv/`, `backup/`, `database/*.sql`, `node_modules/`.
- Valid folders: `src/`, `config/`, `tests/`, `docs/`, `scripts/`, `models/`, `ssl/`.
- Remove stale or out-of-scope content.
- Repo logs must be cleared at the start of `deploy` and `restart`.
- `runtime/` must not contain Sphinx indexes (use only `/var/lib/ethnos-api/sphinx`).
- `config/` must contain only `swagger.config.js` and `sphinx-unified.conf`.

## Code Style and Comments
- Comments are forbidden in code, except Swagger JSDoc and strictly necessary annotations.
- Forbidden: TODO, FIXME, HACK, NOTE, BUG, XXX, commented-out code.
- Keep logs objective; avoid noise.

## Quality and Naming
- Use technical English for new variable names, functions, files, tests, and system messages.
- Keep code and scripts clean: no comments beyond the allowed exceptions.
- Do not add inline CSS/JS in API documentation examples or responses.

## Configuration and Security
- Never version secrets or credentials; use `/etc/node-backend.env` as the source.
- Do not expose keys or sensitive data in responses, logs, or error payloads.

## Endpoints State
- Documented total: 57 operations in `docs/swagger.json`.
- Disabled endpoints: `/signatures`, `/subjects` (root).
- Nested endpoints remain active.

## Tests
- Framework: Jest + Supertest.
- Commands: `npm test`, `npm run test:watch`, `npm run test:coverage`.
- When changing behavior, prefer adding or updating tests in `tests/`.

## Quick References
- Envelopes: `src/utils/responseBuilder.js`
- Pagination: `src/utils/pagination.js`
- Internal access: `src/middleware/accessKey.js`
- Monitoring: `src/middleware/monitoring.js`
