<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Sphinx 3 manual</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style>
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; } /* Alert */
code span.an { color: #008000; } /* Annotation */
code span.at { } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #0000ff; } /* ControlFlow */
code span.ch { color: #008080; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; } /* Comment */
code span.cv { color: #008000; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #0000ff; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #ff4000; } /* Other */
code span.pp { color: #ff4000; } /* Preprocessor */
code span.sc { color: #008080; } /* SpecialChar */
code span.ss { color: #008080; } /* SpecialString */
code span.st { color: #008080; } /* String */
code span.va { } /* Variable */
code span.vs { color: #008080; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */
  </style>
  <style type="text/css">

  /* based on https://gist.github.com/dashed/6714393 */
  /*! normalize.css v2.1.3 | MIT License | git.io/normalize */

  /* ==========================================================================
     HTML5 display definitions
     ========================================================================== */

  /**
   * Correct `block` display not defined in IE 8/9.
   */

  article,
  aside,
  details,
  figcaption,
  figure,
  footer,
  header,
  hgroup,
  main,
  nav,
  section,
  summary {
      display: block;
  }

  /**
   * Correct `inline-block` display not defined in IE 8/9.
   */

  audio,
  canvas,
  video {
      display: inline-block;
  }

  /**
   * Prevent modern browsers from displaying `audio` without controls.
   * Remove excess height in iOS 5 devices.
   */

  audio:not([controls]) {
      display: none;
      height: 0;
  }

  /**
   * Address `[hidden]` styling not present in IE 8/9.
   * Hide the `template` element in IE, Safari, and Firefox < 22.
   */

  [hidden],
  template {
      display: none;
  }

  /* ==========================================================================
     Base
     ========================================================================== */

  /**
   * 1. Set default font family to sans-serif.
   * 2. Prevent iOS text size adjust after orientation change, without disabling
   *    user zoom.
   */

  html {
      font-family: sans-serif; /* 1 */
      -ms-text-size-adjust: 100%; /* 2 */
      -webkit-text-size-adjust: 100%; /* 2 */
  }

  /**
   * Remove default margin.
   */

  body {
      margin: 0;
  }

  /* ==========================================================================
     Links
     ========================================================================== */

  /**
   * Remove the gray background color from active links in IE 10.
   */

  a {
      background: transparent;
  }

  /**
   * Address `outline` inconsistency between Chrome and other browsers.
   */

  a:focus {
      outline: thin dotted;
  }

  /**
   * Improve readability when focused and also mouse hovered in all browsers.
   */

  a:active,
  a:hover {
      outline: 0;
  }

  /* ==========================================================================
     Typography
     ========================================================================== */

  /**
   * Address variable `h1` font-size and margin within `section` and `article`
   * contexts in Firefox 4+, Safari 5, and Chrome.
   */

  h1 {
      font-size: 2em;
      margin: 0.67em 0;
  }

  /**
   * Address styling not present in IE 8/9, Safari 5, and Chrome.
   */

  abbr[title] {
      border-bottom: 1px dotted;
  }

  /**
   * Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome.
   */

  b,
  strong {
      font-weight: 600;
  }

  /**
   * Address styling not present in Safari 5 and Chrome.
   */

  dfn {
      font-style: italic;
  }

  /**
   * Address differences between Firefox and other browsers.
   */

  hr {
      -moz-box-sizing: content-box;
      box-sizing: content-box;
      height: 0;
  }

  /**
   * Address styling not present in IE 8/9.
   */

  mark {
      background: #ff0;
      color: #000;
  }

  /**
   * Correct font family set oddly in Safari 5 and Chrome.
   */

  code,
  kbd,
  pre,
  samp {
      font-family: monospace, serif;
      font-size: 1em;
  }

  /**
   * Improve readability of pre-formatted text in all browsers.
   */

  pre {
      white-space: pre-wrap;
  }

  /**
   * Set consistent quote types.
   */

  q {
      quotes: "\201C" "\201D" "\2018" "\2019";
  }

  /**
   * Address inconsistent and variable font size in all browsers.
   */

  small {
      font-size: 80%;
  }

  /**
   * Prevent `sub` and `sup` affecting `line-height` in all browsers.
   */

  sub,
  sup {
      font-size: 75%;
      line-height: 0;
      position: relative;
      vertical-align: baseline;
  }

  sup {
      top: -0.5em;
  }

  sub {
      bottom: -0.25em;
  }

  /* ==========================================================================
     Embedded content
     ========================================================================== */

  /**
   * Remove border when inside `a` element in IE 8/9.
   */

  img {
      border: 0;
  }

  /**
   * Correct overflow displayed oddly in IE 9.
   */

  svg:not(:root) {
      overflow: hidden;
  }

  /* ==========================================================================
     Figures
     ========================================================================== */

  /**
   * Address margin not present in IE 8/9 and Safari 5.
   */

  figure {
      margin: 0;
  }

  /* ==========================================================================
     Forms
     ========================================================================== */

  /**
   * Define consistent border, margin, and padding.
   */

  fieldset {
      border: 1px solid #c0c0c0;
      margin: 0 2px;
      padding: 0.35em 0.625em 0.75em;
  }

  /**
   * 1. Correct `color` not being inherited in IE 8/9.
   * 2. Remove padding so people aren't caught out if they zero out fieldsets.
   */

  legend {
      border: 0; /* 1 */
      padding: 0; /* 2 */
  }

  /**
   * 1. Correct font family not being inherited in all browsers.
   * 2. Correct font size not being inherited in all browsers.
   * 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome.
   */

  button,
  input,
  select,
  textarea {
      font-family: inherit; /* 1 */
      font-size: 100%; /* 2 */
      margin: 0; /* 3 */
  }

  /**
   * Address Firefox 4+ setting `line-height` on `input` using `!important` in
   * the UA stylesheet.
   */

  button,
  input {
      line-height: normal;
  }

  /**
   * Address inconsistent `text-transform` inheritance for `button` and `select`.
   * All other form control elements do not inherit `text-transform` values.
   * Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+.
   * Correct `select` style inheritance in Firefox 4+ and Opera.
   */

  button,
  select {
      text-transform: none;
  }

  /**
   * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
   *    and `video` controls.
   * 2. Correct inability to style clickable `input` types in iOS.
   * 3. Improve usability and consistency of cursor style between image-type
   *    `input` and others.
   */

  button,
  html input[type="button"], /* 1 */
  input[type="reset"],
  input[type="submit"] {
      -webkit-appearance: button; /* 2 */
      cursor: pointer; /* 3 */
  }

  /**
   * Re-set default cursor for disabled elements.
   */

  button[disabled],
  html input[disabled] {
      cursor: default;
  }

  /**
   * 1. Address box sizing set to `content-box` in IE 8/9/10.
   * 2. Remove excess padding in IE 8/9/10.
   */

  input[type="checkbox"],
  input[type="radio"] {
      box-sizing: border-box; /* 1 */
      padding: 0; /* 2 */
  }

  /**
   * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
   * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
   *    (include `-moz` to future-proof).
   */

  input[type="search"] {
      -webkit-appearance: textfield; /* 1 */
      -moz-box-sizing: content-box;
      -webkit-box-sizing: content-box; /* 2 */
      box-sizing: content-box;
  }

  /**
   * Remove inner padding and search cancel button in Safari 5 and Chrome
   * on OS X.
   */

  input[type="search"]::-webkit-search-cancel-button,
  input[type="search"]::-webkit-search-decoration {
      -webkit-appearance: none;
  }

  /**
   * Remove inner padding and border in Firefox 4+.
   */

  button::-moz-focus-inner,
  input::-moz-focus-inner {
      border: 0;
      padding: 0;
  }

  /**
   * 1. Remove default vertical scrollbar in IE 8/9.
   * 2. Improve readability and alignment in all browsers.
   */

  textarea {
      overflow: auto; /* 1 */
      vertical-align: top; /* 2 */
  }

  /* ==========================================================================
     Tables
     ========================================================================== */

  /**
   * Remove most spacing between table cells.
   */

  table {
      border-collapse: collapse;
      border-spacing: 0;
  }

  .go-top {
  position: fixed;
  bottom: 2em;
  right: 2em;
  text-decoration: none;
  background-color: #E0E0E0;
  font-size: 12px;
  padding: 1em;
  display: inline;
  }

  /* Github css */

  html,body{color:black;}
  *:not('#mkdbuttons'){margin:0;padding:0}
  body{font:13.34px -apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif;-webkit-font-smoothing:subpixel-antialiased;}
  body{background-color:#fff;padding:0px;margin:30px 50px;font-size:16px;line-height:1.6}
  nav ul{line-height:1.7}
  body>*:first-child{margin-top:0!important}
  body>*:last-child{margin-bottom:0!important}

  a{color:#4183c4;text-decoration:none}
  a:hover{text-decoration:underline}
  a code{color:#4183c4;}
  p code, li code, h1 code, h2 code, h3 code, h4 code {background-color: #f3f4f4;}

  h1,h2,h3,h4,h5,h6{margin:20px 0 10px;padding:0;font-weight:600;-webkit-font-smoothing:subpixel-antialiased;cursor:text}
  h1{font-size:32px;color:#000}
  h2{font-size:24px;border-bottom:1px solid #ccc;color:#000}
  h3{font-size:20px;color:#333}
  h4{font-size:18px;color:#333}
  h5{font-size:16px;color:#333}
  h6{font-size:14px;color:#777}

  p,blockquote,table,pre{margin:15px 0}
  ul{padding-left:30px}ol{padding-left:30px}
  ol li ul:first-of-type{margin-top:0}
  hr{background:transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAEAQMAAACXytwAAAAABlBMVEUAAAAAAAClZ7nPAAAAAnRSTlMzAIL4qAgAAAAQSURBVAjXY3jAcIShh0EGAAu8Ak3MBNBbAAAAAElFTkSuQmCC) repeat-x 0 0;border:0 none;color:#ccc;height:4px;padding:0}
  body>h2:first-child{margin-top:0;padding-top:0}
  body>h1:first-child{margin-top:0;padding-top:0}
  body>h1:first-child+h2{margin-top:0;padding-top:0}
  body>h3:first-child,body>h4:first-child,body>h5:first-child,body>h6:first-child{margin-top:0;padding-top:0}
  a:first-child h1,a:first-child h2,a:first-child h3,a:first-child h4,a:first-child h5,a:first-child h6{margin-top:0;padding-top:0}
  h1+p,h2+p,h3+p,h4+p,h5+p,h6+p,ul li>:first-child,ol li>:first-child{margin-top:0}
  dl{padding:0}
  dl dt{font-size:14px;font-weight:bold;font-style:italic;padding:0;margin:15px 0 5px}
  dl dt:first-child{padding:0}dl dt>:first-child{margin-top:0}dl dt>:last-child{margin-bottom:0}
  dl dd{margin:0 0 15px;padding:0 15px}dl dd>:first-child{margin-top:0}
  dl dd>:last-child{margin-bottom:0}
  blockquote{border-left:4px solid #DDD;padding:8px 16px;}
  blockquote>:first-child{margin-top:0}
  blockquote>:last-child{margin-bottom:0}
  table{border-collapse:collapse;border-spacing:0;font-size:100%;font:inherit}
  table th{font-weight:600;border:1px solid #ccc;padding:6px 13px}
  table td{border:1px solid #ccc;padding:6px 13px}
  table tr{border-top:1px solid #ccc;background-color:#fff}
  table tr:nth-child(2n){background-color:#f6f8fa}
  img{max-width:100%}
  code,tt{margin:0 2px;padding:0 5px;white-space:nowrap;border:1px solid #eaeaea;background-color:#f6f8fa;border-radius:3px;font-family:Consolas,'Liberation Mono',Courier,monospace;font-size:95%;color:#333;}
  pre>code{margin:0;padding:0;white-space:pre;border:0;background:transparent}
  pre.sourceCode>code{font-size:100%;line-height:1.5}
  pre{background-color:#f6f8fa;border:none;font-size:100%;line-height:1.4;overflow:auto;padding:16px;border-radius:3px}
  pre code,pre tt{background-color:transparent;border:0}
  .sourceCode{overflow:auto}
  sup,sub,a.footnote{font-size:1.4ex;height:0;line-height:1;vertical-align:super;position:relative}
  sub{vertical-align:sub;top:-1px}

  @media print{
  	body{background:#fff}
  	img,pre,blockquote,table,figure{page-break-inside:avoid}
  	body{background:#fff;border:0}
  	code{background-color:#fff;color:#333!important;padding:0 .2em;border:1px solid #dedede}
  	pre{background:#fff}
  	pre code{background-color:white!important;overflow:visible}}
  @media screen{
  	body.inverted{color:#eee!important;border-color:#555;box-shadow:none}
  	.inverted body,.inverted hr .inverted p,.inverted td,.inverted li,.inverted h1,.inverted h2,.inverted h3,.inverted h4,.inverted h5,.inverted h6,.inverted th,.inverted .math,.inverted caption,.inverted dd,.inverted dt,.inverted blockquote{color:#eee!important;border-color:#555;box-shadow:none}
  	.inverted td,.inverted th{background:#333}
  	.inverted h2{border-color:#555}
  	.inverted hr{border-color:#777;border-width:1px!important}
  	::selection{background:rgba(157,193,200,0.5)}
  	h1::selection{background-color:rgba(45,156,208,0.3)}
  	h2::selection{background-color:rgba(90,182,224,0.3)}
  	h3::selection,h4::selection,h5::selection,h6::selection,li::selection,ol::selection{background-color:rgba(133,201,232,0.3)}
  	code::selection{background-color:rgba(0,0,0,0.7);color:#eee}
  	code span::selection{background-color:rgba(0,0,0,0.7)!important;color:#eee!important}
  	a::selection{background-color:rgba(255,230,102,0.2)}
  	.inverted a::selection{background-color:rgba(255,230,102,0.6)}
  	td::selection,th::selection,caption::selection{background-color:rgba(180,237,95,0.5)}
  	.inverted{background:#0b2531;background:#252a2a}
  	.inverted body{background:#252a2a}
  	.inverted a{color:#acd1d5}}

  /* Sphinx3 specific highlighting hacks here
   * kw == keyword, st == string, dv == decimal value, fl == float?, dt == datatype, ot == other, fu == function
   */
  code span.kw {color: #07a}
  code span.st {color: #690}
  code span.dv {color: #905}
  code span.fl {color: #905}
  code span.dt {color: #07a}
  code span.ot {color: #888}
  code span.fu {color: #d46}
    
  nav {
  	display: block;
  	position: fixed;
  	top: 0px;
  	bottom: 0px;
  	left: 0px;
  	width: 350px;
  	height: 100%;
  	overflow-y: auto;
  	overflow-x: hidden;
  }
  @media print{nav{display:none;}}

  .docbody {
  	display: block;
  	overflow: auto;
  	margin: 0 0 0 350px;
  	padding: 40px;
  	max-width: 66em;
  	border-radius:3px;-moz-border-radius:3px;-webkit-border-radius:3px;
  }
  @media screen{.docbody{box-shadow:0 0 0 1px #cacaca,0 0 0 4px #eee}}
  @media print{.docbody{margin:30px;}}

  nav li.toggle > span { cursor: pointer; position: absolute; left: 10px; color: #337ab7; }
  nav li.expn > span { transform: rotate(90deg); transition: 0.15s; }
  nav li.coll > span { transform: rotate(0deg); transition: 0.15s; }
  nav li.coll > ul { display: none; }
  nav > p { padding-left: 30px; font-size: 80%; }
  nav > ul { padding-right: 8px; }
  nav > ul > li { list-style: none; }
  nav li a { padding-left: 8px; padding-right: 8px; display: block; }
  nav li.active > a { background-color: #5490ca; border-radius: 4px; color: #fff; }

  nav::-webkit-scrollbar { background-color: #eee; width: 10px; }
  nav::-webkit-scrollbar-thumb { background-color: #d5d5d5; border-radius: 6px; background-clip: padding-box; }

  #logo {
  	display: inline-block;
  	width: 100%;
  	background: url("data:image/png;base64,\
  iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAMAAAD04JH5AAAA21BMVEX///8jHyBEtOQaFxcfGxwV\
  ERIoJSb8+/wsKSlpZmc8suQiGBb39/fa2dnFxMREuOm3trY1MTIvLC41seTd3d2/vr57eXlPTU22\
  5/np6enU1NSHhYWBfn9KR0g7ODnu7u7m5eWsq6uSkJBxbm9CPz9Fve+xsLCamZk/e5ddWltVVFVH\
  teXi4eHQzs7N7/yko6Ognp6Miosis+krsufKycm7urri9v3y8vJIvvBwzO+pp6diYGD4/f+T2PRc\
  yPDu+v43u+47Znw7S1Sc4PhHq9ZGncNXveg/iqqnu8QfzqdgAAAEyElEQVR42u3YaXeaQBQG4Du5\
  MwNYpEAQVNy1WndtNIu2aZImbf//LyrmJCGyKC6R03Pm+eYX7uu9M4MOCIIgCIIgCIIgHEatFWc5\
  vb5YLOr6XCsOqhKcylVWW0yViswJobhCKeGy6did9qwAH0uycpOmwQmyVdV3KKXIGCVyt6FbH9QL\
  Nas3HE5XZeJRZJQ7jdzROzHoKC2vOBLfphDE7JWKx+t70e3KjPk9TxZC7jUGx6g+LJU5Q0p2h8xc\
  6hIcoqaXyoQh2RdFWi5pe1dvN2Xqf/c9IaNdXYWdFeYlAxklx4BYrqs7VncN6lc/HKKTuAuq1W6a\
  iavTT+9tjpCTthefNZQWT9b5VT3OjYf7+68v7h8MTj7R2AjU0SFWMTdxm70KYYg0wRZHwh/uv/55\
  enzsX19ff3l2fd1/fPpz/8BjO4F0WYQYCkPmL/jNxXnLrf997Ht1P3vOfN6nL9f9p69ehphHMXkM\
  0TSa6HCjFWXazqoAPzJe5UheCC9Dj0fPEUlMD6QyJjha7ZwKzy77fsWoDHc/hk0zOsIQotVxc3Wz\
  62bhTT5ztlHmFsCy5YgIPAsxeozEiHit/Dg/2+zzTwDIKjz4UBofYMajh4bcmVoQcJM522IEK8Mu\
  waQBoB4OQBl1xlkJgr7/3hYgk39d3T1GEwaAZmgIhh19ev3snyUNAOrCYMTHLYhVqwTbpYNvzw54\
  sgri2zPlGsQbBhNUxhDtZmuAEbzTdliiADA0MbD+mxL4dtgFmUt4T3UpJgkAueBWYM0qRMhntm/D\
  de0KSxIAdBpM4GQh7HJL/fNbCCooSL0AZgE26wQToJnbfRFc/Ip6NEcvwBVsoXMMvj+mEDLaGCDz\
  5TtEsJYMtweAnIzBN8GysH0jhhsQJjUov4KtdIJkHauExpCP3wd9fwWE5FpV2E4rM7IOeUdNvBPP\
  70YQy1IhgcKShd4K3WJgCDfRCfqZixEcTCohDTWhvimBX/9bHo6hEVoIlNq19VfSbUSCi7s8HMe8\
  giS0Ftvq+jr4HIhwfnF7CZGuqrCrqh0eA5a19RPx193Feeat+rebmPFnS0YHdjeWMfyrVimuR8jf\
  3F18e3b7K7p8dbK6XRjDHopdFp6DbFuw5uco7xlF917KNSuIlOAY9iGNKyz8O81UJkVIYtB+vV5A\
  osF+ak2K4QhIehOtChtZdYXjSweZkYO96S1GSQgiqdj1YQEiVWeTLn/7m4lUseAA1ZLsRwg0wlA6\
  7Zl1JcErtVCcdxSDMHy3dXQ4UFHhuOmfsuEodsMztZctma9d6yAaHQkOl1UokjiUIrJnoftT1lpU\
  4Tg0P0JSyIxOFY5HW+5yY0cZtiY1OK6ZW0akyb68rNSrcHzSuCsz3FqdlF0LPkq21No0CmTcsTUJ\
  PpKk2Y6XAaMGT5zSUIKPJw2nSouTADSVmQQno04wcBy4Azgpbb2+PIcTq8mU+LAOJ9fEd/VtOL25\
  H4DyAZxewaRvDVAgDSVGXrAJpEGjqSxBn9TD1wALSEX7LcAYUlF4PQqYC2nwr1exLEEqBib17+FT\
  MX1tQRvSobbQP4lSMSfUvwc/PX8IrAMpueo9J8AupGVgIFnRIC3DFlspq5CWgV1yXXdaAEEQBEEQ\
  BEEQBEEQ/i//ADEdaI45+k1UAAAAAElFTkSuQmCC");
  	background-size: contain;
  	background-repeat: no-repeat;
  	vertical-align: middle;
  }

  h2>a, h3>a, h4>a { visibility: hidden;
  	display: inline-block;
  	margin-left: -24px;
  	width: 16px;
  	height: 16px;
  	background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg>");
  	background-repeat: no-repeat;
  	vertical-align: middle;
  }
  h2:hover>a, h3:hover>a, h4:hover>a { visibility: visible; }

  blockquote.note { border-left: 4px solid #0969da; }
  blockquote.warn { border-left: 4px solid #d1242f; }
  p.note {
    color: #0969da;
    text-indent: 32px;
    height: 24px;
    font-weight: 600;
    background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%230969da' aria-hidden='true'><path d='M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z'></path></svg>");
    background-repeat: no-repeat;
    vertical-align: middle;
  }
  p.warn {
    color: #d1242f;
    text-indent: 32px;
    height: 24px;
    font-weight: 600;
    background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23d1242f' aria-hidden='true'><path d='M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z'></path></svg>");
    background-repeat: no-repeat;
    vertical-align: middle;
  }

  </style>
</head>

<body>
<nav id="TOC" role="doc-toc">

<h3><div id="logo" style="width:24px;height:24px;margin-left:8px;"></div> Sphinx 3</h3>
<p><a href="#" onclick="return SetToggles('expn');">▾ expand</a> | <a href="#" onclick="return SetToggles('coll');">▸ collapse</a></p>

<!--tocbegin-->

<ul>
<li><a href="#features-overview" id="toc-features-overview">Features
overview</a></li>
<li><a href="#features-cheat-sheet"
id="toc-features-cheat-sheet">Features cheat sheet</a></li>
<li><a href="#getting-started" id="toc-getting-started">Getting
started</a>
<ul>
<li><a href="#getting-started-on-linux-and-macos"
id="toc-getting-started-on-linux-and-macos">Getting started on Linux
(and MacOS)</a></li>
<li><a href="#getting-started-on-windows"
id="toc-getting-started-on-windows">Getting started on Windows</a></li>
<li><a href="#running-queries-via-mysql-shell"
id="toc-running-queries-via-mysql-shell">Running queries via MySQL
shell</a></li>
<li><a href="#sphinxql-basics" id="toc-sphinxql-basics">SphinxQL
basics</a></li>
<li><a href="#sphinxql-vs-regular-sql"
id="toc-sphinxql-vs-regular-sql">SphinxQL vs regular SQL</a></li>
<li><a href="#writing-your-first-config"
id="toc-writing-your-first-config">Writing your first config</a></li>
<li><a href="#running-queries-from-php-python-etc"
id="toc-running-queries-from-php-python-etc">Running queries from PHP,
Python, etc</a></li>
<li><a href="#installing-sql-drivers"
id="toc-installing-sql-drivers">Installing SQL drivers</a></li>
</ul></li>
<li><a href="#main-concepts" id="toc-main-concepts">Main concepts</a>
<ul>
<li><a href="#indexes" id="toc-indexes">Indexes</a></li>
<li><a href="#documents" id="toc-documents">Documents</a></li>
<li><a href="#fields" id="toc-fields">Fields</a></li>
<li><a href="#attributes" id="toc-attributes">Attributes</a></li>
<li><a href="#schemas" id="toc-schemas">Schemas</a></li>
<li><a href="#index-types" id="toc-index-types">Index types</a></li>
</ul></li>
<li><a href="#using-index-schemas" id="toc-using-index-schemas">Using
index schemas</a>
<ul>
<li><a href="#schemas-index-config"
id="toc-schemas-index-config">Schemas: index config</a></li>
<li><a href="#schemas-create-table"
id="toc-schemas-create-table">Schemas: CREATE TABLE</a></li>
<li><a href="#schemas-query-order" id="toc-schemas-query-order">Schemas:
query order</a></li>
<li><a href="#schemas-autocomputed-attributes"
id="toc-schemas-autocomputed-attributes">Schemas: autocomputed
attributes</a></li>
<li><a href="#schemas-data-sources"
id="toc-schemas-data-sources">Schemas: data sources</a></li>
</ul></li>
<li><a href="#using-select" id="toc-using-select">Using SELECT</a>
<ul>
<li><a href="#select-basics" id="toc-select-basics">SELECT
basics</a></li>
<li><a href="#select-filtering-and-ordering"
id="toc-select-filtering-and-ordering">SELECT filtering and
ordering</a></li>
<li><a href="#select-grouping" id="toc-select-grouping">SELECT
grouping</a></li>
<li><a href="#select-options-explained"
id="toc-select-options-explained">SELECT options explained</a></li>
<li><a href="#faceted-searches-with-select"
id="toc-faceted-searches-with-select">Faceted searches with
SELECT</a></li>
<li><a href="#nested-selects-aka-subselects"
id="toc-nested-selects-aka-subselects">Nested SELECTs (aka
subselects)</a></li>
</ul></li>
<li><a href="#using-docstore" id="toc-using-docstore">Using
DocStore</a></li>
<li><a href="#using-attribute-indexes"
id="toc-using-attribute-indexes">Using attribute indexes</a>
<ul>
<li><a href="#query-optimizer-and-index-hints"
id="toc-query-optimizer-and-index-hints">Query optimizer, and index
hints</a></li>
<li><a href="#create-and-drop-index-performance"
id="toc-create-and-drop-index-performance">CREATE and DROP index
performance</a></li>
<li><a href="#using-universal-index"
id="toc-using-universal-index">Using universal index</a></li>
<li><a href="#universal-index-internals"
id="toc-universal-index-internals">Universal index internals</a></li>
</ul></li>
<li><a href="#using-annotations" id="toc-using-annotations">Using
annotations</a>
<ul>
<li><a href="#annotations-overview"
id="toc-annotations-overview">Annotations overview</a></li>
<li><a href="#annotations-index-setup"
id="toc-annotations-index-setup">Annotations index setup</a></li>
<li><a href="#annotations-scores"
id="toc-annotations-scores">Annotations scores</a></li>
<li><a href="#accessing-matched-annotations"
id="toc-accessing-matched-annotations">Accessing matched
annotations</a></li>
<li><a href="#annotation-specific-ranking-factors"
id="toc-annotation-specific-ranking-factors">Annotation-specific ranking
factors</a></li>
</ul></li>
<li><a href="#using-k-batches" id="toc-using-k-batches">Using
k-batches</a></li>
<li><a href="#doing-bulk-data-loads"
id="toc-doing-bulk-data-loads">Doing bulk data loads</a></li>
<li><a href="#using-json" id="toc-using-json">Using JSON</a>
<ul>
<li><a href="#indexing-json-data" id="toc-indexing-json-data">Indexing
JSON data</a></li>
<li><a href="#querying-json-columns"
id="toc-querying-json-columns">Querying JSON columns</a></li>
<li><a href="#json-syntax-extensions"
id="toc-json-syntax-extensions">JSON syntax extensions</a></li>
<li><a href="#json-comparison-quirks"
id="toc-json-comparison-quirks">JSON comparison quirks</a></li>
</ul></li>
<li><a href="#using-array-attributes"
id="toc-using-array-attributes">Using array attributes</a></li>
<li><a href="#using-set-attributes" id="toc-using-set-attributes">Using
set attributes</a></li>
<li><a href="#using-blob-attributes"
id="toc-using-blob-attributes">Using blob attributes</a></li>
<li><a href="#using-mappings" id="toc-using-mappings">Using mappings</a>
<ul>
<li><a href="#pre-morph-mappings" id="toc-pre-morph-mappings">Pre-morph
mappings</a></li>
<li><a href="#post-morph-mappings"
id="toc-post-morph-mappings">Post-morph mappings</a></li>
<li><a href="#document-only-mappings"
id="toc-document-only-mappings">Document-only mappings</a></li>
</ul></li>
<li><a href="#using-morphdict" id="toc-using-morphdict">Using
morphdict</a></li>
<li><a href="#migrating-legacy-wordforms"
id="toc-migrating-legacy-wordforms">Migrating legacy wordforms</a></li>
<li><a href="#using-udfs" id="toc-using-udfs">Using UDFs</a>
<ul>
<li><a href="#udfs-overview" id="toc-udfs-overview">UDFs
overview</a></li>
<li><a href="#udf-programming-introduction"
id="toc-udf-programming-introduction">UDF programming
introduction</a></li>
<li><a href="#udf-argument-and-return-types"
id="toc-udf-argument-and-return-types">UDF argument and return
types</a></li>
<li><a href="#udf-library-initialization"
id="toc-udf-library-initialization">UDF library initialization</a></li>
<li><a href="#udf-call-batching" id="toc-udf-call-batching">UDF call
batching</a></li>
<li><a href="#udfs-that-return-arrays"
id="toc-udfs-that-return-arrays">UDFs that return arrays</a></li>
<li><a href="#using-factors-in-udfs"
id="toc-using-factors-in-udfs">Using <code>FACTORS()</code> in
UDFs</a></li>
<li><a href="#udf-calls-sequences" id="toc-udf-calls-sequences">UDF
calls sequences</a></li>
</ul></li>
<li><a href="#using-ranker-plugins" id="toc-using-ranker-plugins">Using
ranker plugins</a></li>
<li><a href="#using-table-functions"
id="toc-using-table-functions">Using table functions</a>
<ul>
<li><a href="#remove_repeats-table-function"
id="toc-remove_repeats-table-function">REMOVE_REPEATS table
function</a></li>
<li><a href="#pessimize_rank-table-function"
id="toc-pessimize_rank-table-function">PESSIMIZE_RANK table
function</a></li>
</ul></li>
<li><a href="#using-distributed-indexes"
id="toc-using-distributed-indexes">Using distributed indexes</a>
<ul>
<li><a href="#agent-mirror-selection-strategies"
id="toc-agent-mirror-selection-strategies">Agent mirror selection
strategies</a></li>
</ul></li>
<li><a href="#using-replication" id="toc-using-replication">Using
replication</a>
<ul>
<li><a href="#replication-mini-tutorial"
id="toc-replication-mini-tutorial">Replication mini-tutorial</a></li>
<li><a href="#replication-glossary"
id="toc-replication-glossary">Replication glossary</a></li>
<li><a href="#replication-overview"
id="toc-replication-overview">Replication overview</a></li>
<li><a href="#notable-replication-restrictions"
id="toc-notable-replication-restrictions">Notable replication
restrictions</a></li>
<li><a href="#managing-replicated-indexes-on-the-fly"
id="toc-managing-replicated-indexes-on-the-fly">Managing replicated
indexes on-the-fly</a></li>
<li><a href="#monitoring-replication"
id="toc-monitoring-replication">Monitoring replication</a></li>
<li><a href="#configuring-replication-settings"
id="toc-configuring-replication-settings">Configuring replication
settings</a></li>
<li><a href="#cloning-via-replication"
id="toc-cloning-via-replication">Cloning via replication</a></li>
</ul></li>
<li><a href="#using-datadir" id="toc-using-datadir">Using
datadir</a></li>
<li><a href="#migrating-to-datadir"
id="toc-migrating-to-datadir">Migrating to datadir</a></li>
<li><a href="#indexing-data-sources"
id="toc-indexing-data-sources">Indexing: data sources</a></li>
<li><a href="#indexing-sql-databases"
id="toc-indexing-sql-databases">Indexing: SQL databases</a></li>
<li><a href="#indexing-csv-and-tsv-files"
id="toc-indexing-csv-and-tsv-files">Indexing: CSV and TSV files</a></li>
<li><a href="#indexing-xml-files" id="toc-indexing-xml-files">Indexing:
XML files</a></li>
<li><a href="#indexing-join-sources"
id="toc-indexing-join-sources">Indexing: join sources</a>
<ul>
<li><a href="#text-join-sources" id="toc-text-join-sources">Text join
sources</a></li>
<li><a href="#join-by-attribute" id="toc-join-by-attribute">Join by
attribute</a></li>
<li><a href="#binary-join-sources" id="toc-binary-join-sources">Binary
join sources</a></li>
<li><a href="#caching-text-join-sources"
id="toc-caching-text-join-sources">Caching text join sources</a></li>
<li><a href="#binding-index-join-targets"
id="toc-binding-index-join-targets">Binding index join targets</a></li>
<li><a href="#joins-ram-usage" id="toc-joins-ram-usage">Joins RAM
usage</a></li>
</ul></li>
<li><a href="#indexing-special-chars-blended-tokens-and-mixed-codes"
id="toc-indexing-special-chars-blended-tokens-and-mixed-codes">Indexing:
special chars, blended tokens, and mixed codes</a>
<ul>
<li><a href="#blended-tokens-with-special-characters"
id="toc-blended-tokens-with-special-characters">Blended tokens (with
special characters)</a></li>
<li><a href="#mixed-codes-with-letters-and-digits"
id="toc-mixed-codes-with-letters-and-digits">Mixed codes (with letters
and digits)</a></li>
<li><a href="#blending-modes" id="toc-blending-modes">Blending
modes</a></li>
<li><a href="#searching-vs-blended-tokens-and-mixed-codes"
id="toc-searching-vs-blended-tokens-and-mixed-codes">Searching vs
blended tokens and mixed codes</a></li>
</ul></li>
<li><a href="#indexing-pretraining-faiss_dot-indexes"
id="toc-indexing-pretraining-faiss_dot-indexes">Indexing: pretraining
FAISS_DOT indexes</a></li>
<li><a href="#searching-query-syntax"
id="toc-searching-query-syntax">Searching: query syntax</a>
<ul>
<li><a href="#operators" id="toc-operators">Operators</a></li>
<li><a href="#modifiers" id="toc-modifiers">Modifiers</a></li>
<li><a href="#cheat-sheet" id="toc-cheat-sheet">Cheat sheet</a></li>
<li><a href="#keyword-modifiers" id="toc-keyword-modifiers">Keyword
modifiers</a></li>
<li><a href="#boolean-operators-brackets-and-or-not"
id="toc-boolean-operators-brackets-and-or-not">Boolean operators
(brackets, AND, OR, NOT)</a></li>
<li><a href="#phrase-operator" id="toc-phrase-operator">Phrase
operator</a></li>
<li><a href="#maybe-operator" id="toc-maybe-operator">MAYBE
operator</a></li>
<li><a href="#term-or-operator" id="toc-term-or-operator">Term-OR
operator</a></li>
<li><a href="#field-and-position-limit-operator"
id="toc-field-and-position-limit-operator">Field and position limit
operator</a></li>
<li><a href="#proximity-and-near-operators"
id="toc-proximity-and-near-operators">Proximity and NEAR
operators</a></li>
<li><a href="#quorum-operator" id="toc-quorum-operator">Quorum
operator</a></li>
<li><a href="#strict-order-operator-before"
id="toc-strict-order-operator-before">Strict order operator
(BEFORE)</a></li>
<li><a href="#sentence-and-paragraph-operators"
id="toc-sentence-and-paragraph-operators">SENTENCE and PARAGRAPH
operators</a></li>
<li><a href="#zone-and-zonespan-operators"
id="toc-zone-and-zonespan-operators">ZONE and ZONESPAN
operators</a></li>
</ul></li>
<li><a href="#searching-expressions-and-operators"
id="toc-searching-expressions-and-operators">Searching: expressions and
operators</a>
<ul>
<li><a href="#expression-types" id="toc-expression-types">Expression
types</a></li>
<li><a href="#arithmetic-operators"
id="toc-arithmetic-operators">Arithmetic operators</a></li>
<li><a href="#comparison-operators"
id="toc-comparison-operators">Comparison operators</a></li>
<li><a href="#logical-operators" id="toc-logical-operators">Logical
operators</a></li>
<li><a href="#bitwise-operators" id="toc-bitwise-operators">Bitwise
operators</a></li>
<li><a href="#operator-priority" id="toc-operator-priority">Operator
priority</a></li>
</ul></li>
<li><a href="#searching-geosearches"
id="toc-searching-geosearches">Searching: geosearches</a>
<ul>
<li><a href="#attribute-indexes-for-geosearches"
id="toc-attribute-indexes-for-geosearches">Attribute indexes for
geosearches</a></li>
<li><a href="#multigeo-support" id="toc-multigeo-support">Multigeo
support</a></li>
</ul></li>
<li><a href="#searching-percolate-queries"
id="toc-searching-percolate-queries">Searching: percolate
queries</a></li>
<li><a href="#searching-vector-searches"
id="toc-searching-vector-searches">Searching: vector searches</a></li>
<li><a href="#searching-vector-indexes"
id="toc-searching-vector-indexes">Searching: vector indexes</a>
<ul>
<li><a href="#ann-index-types" id="toc-ann-index-types">ANN index
types</a></li>
<li><a href="#faiss_dot-indexes" id="toc-faiss_dot-indexes">FAISS_DOT
indexes</a></li>
<li><a href="#faiss_l1-indexes" id="toc-faiss_l1-indexes">FAISS_L1
indexes</a></li>
<li><a href="#hnsw-indexes" id="toc-hnsw-indexes">HNSW indexes</a></li>
<li><a href="#sq-indexes" id="toc-sq-indexes">SQ indexes</a></li>
<li><a href="#common-ann-indexing-tips"
id="toc-common-ann-indexing-tips">Common ANN indexing tips</a></li>
<li><a href="#common-ann-searching-tips"
id="toc-common-ann-searching-tips">Common ANN searching tips</a></li>
<li><a href="#fine-tuning-ann-searches"
id="toc-fine-tuning-ann-searches">Fine-tuning ANN searches</a></li>
</ul></li>
<li><a href="#searching-query-cache"
id="toc-searching-query-cache">Searching: query cache</a></li>
<li><a href="#searching-memory-budgets"
id="toc-searching-memory-budgets">Searching: memory budgets</a></li>
<li><a href="#searching-distributed-query-errors"
id="toc-searching-distributed-query-errors">Searching: distributed query
errors</a></li>
<li><a href="#ranking-factors" id="toc-ranking-factors">Ranking:
factors</a>
<ul>
<li><a href="#accessing-ranking-factors"
id="toc-accessing-ranking-factors">Accessing ranking factors</a></li>
<li><a href="#factor-aggregation-functions"
id="toc-factor-aggregation-functions">Factor aggregation
functions</a></li>
<li><a href="#keyword-flags" id="toc-keyword-flags">Keyword
flags</a></li>
<li><a href="#query-level-ranking-factors"
id="toc-query-level-ranking-factors">Query-level ranking
factors</a></li>
<li><a href="#document-level-ranking-factors"
id="toc-document-level-ranking-factors">Document-level ranking
factors</a></li>
<li><a href="#field-level-ranking-factors"
id="toc-field-level-ranking-factors">Field-level ranking
factors</a></li>
</ul></li>
<li><a href="#ranking-built-in-ranker-formulas"
id="toc-ranking-built-in-ranker-formulas">Ranking: built-in ranker
formulas</a></li>
<li><a href="#ranking-idf-magics" id="toc-ranking-idf-magics">Ranking:
IDF magics</a>
<ul>
<li><a href="#using-global-idfs" id="toc-using-global-idfs">Using global
IDFs</a></li>
<li><a href="#how-sphinx-computes-idf"
id="toc-how-sphinx-computes-idf">How Sphinx computes IDF</a></li>
</ul></li>
<li><a href="#ranking-field-lengths"
id="toc-ranking-field-lengths">Ranking: field lengths</a></li>
<li><a href="#ranking-picking-fields-with-rank_fields"
id="toc-ranking-picking-fields-with-rank_fields">Ranking: picking fields
with <code>rank_fields</code></a></li>
<li><a href="#xfactors" id="toc-xfactors">Ranking: using different
keywords than matching</a></li>
<li><a href="#ranking-trigrams-and-bpe-tokens"
id="toc-ranking-trigrams-and-bpe-tokens">Ranking: trigrams and BPE
tokens</a>
<ul>
<li><a href="#trigram-tokenizer-details"
id="toc-trigram-tokenizer-details">Trigram tokenizer details</a></li>
<li><a href="#bpe-tokenizer-details" id="toc-bpe-tokenizer-details">BPE
tokenizer details</a></li>
</ul></li>
<li><a href="#ranking-clickstats" id="toc-ranking-clickstats">Ranking:
clickstats</a></li>
<li><a href="#ranking-tokhashes-and-wordpair_ctr"
id="toc-ranking-tokhashes-and-wordpair_ctr">Ranking: tokhashes and
<code>wordpair_ctr</code></a></li>
<li><a href="#ranking-token-classes"
id="toc-ranking-token-classes">Ranking: token classes</a></li>
<li><a href="#ranking-two-stage-ranking"
id="toc-ranking-two-stage-ranking">Ranking: two-stage ranking</a></li>
<li><a href="#operations-rt-index-internals"
id="toc-operations-rt-index-internals">Operations: RT index
internals</a></li>
<li><a href="#siege-mode" id="toc-siege-mode">Operations: “siege mode”,
temporary global query limits</a></li>
<li><a href="#operations-network-internals"
id="toc-operations-network-internals">Operations: network internals</a>
<ul>
<li><a href="#incoming-client-queries"
id="toc-incoming-client-queries">Incoming (client) queries</a></li>
<li><a href="#outgoing-distributed-queries"
id="toc-outgoing-distributed-queries">Outgoing (distributed)
queries</a></li>
<li><a href="#request-hedging" id="toc-request-hedging">Request
hedging</a></li>
</ul></li>
<li><a href="#operations-dumping-data"
id="toc-operations-dumping-data">Operations: dumping data</a></li>
<li><a href="#operations-binlogs"
id="toc-operations-binlogs">Operations: binlogs</a></li>
<li><a href="#operations-query-logs"
id="toc-operations-query-logs">Operations: query logs</a></li>
<li><a href="#operations-user-auth"
id="toc-operations-user-auth">Operations: user auth</a>
<ul>
<li><a href="#sha1-security-notes" id="toc-sha1-security-notes">SHA1
security notes</a></li>
</ul></li>
<li><a href="#operations-altering-distributed-indexes"
id="toc-operations-altering-distributed-indexes">Operations: altering
distributed indexes</a></li>
<li><a href="#sphinxql-reference" id="toc-sphinxql-reference">SphinxQL
reference</a>
<ul>
<li><a href="#alter-syntax" id="toc-alter-syntax">ALTER syntax</a></li>
<li><a href="#alter-column-syntax" id="toc-alter-column-syntax">ALTER
COLUMN syntax</a></li>
<li><a href="#alter-remote-syntax" id="toc-alter-remote-syntax">ALTER
REMOTE syntax</a></li>
<li><a href="#alter-option-syntax" id="toc-alter-option-syntax">ALTER
OPTION syntax</a></li>
<li><a href="#attach-index-syntax" id="toc-attach-index-syntax">ATTACH
INDEX syntax</a></li>
<li><a href="#bulk-update-syntax" id="toc-bulk-update-syntax">BULK
UPDATE syntax</a></li>
<li><a href="#call-syntax" id="toc-call-syntax">CALL syntax</a></li>
<li><a href="#call-keywords-syntax" id="toc-call-keywords-syntax">CALL
KEYWORDS syntax</a></li>
<li><a href="#clone-syntax" id="toc-clone-syntax">CLONE syntax</a></li>
<li><a href="#clone-index-syntax" id="toc-clone-index-syntax">CLONE
INDEX syntax</a></li>
<li><a href="#create-index-syntax" id="toc-create-index-syntax">CREATE
INDEX syntax</a></li>
<li><a href="#create-table-syntax" id="toc-create-table-syntax">CREATE
TABLE syntax</a></li>
<li><a href="#create-universal-index-syntax"
id="toc-create-universal-index-syntax">CREATE UNIVERSAL INDEX
syntax</a></li>
<li><a href="#describe-syntax" id="toc-describe-syntax">DESCRIBE
syntax</a></li>
<li><a href="#drop-index-syntax" id="toc-drop-index-syntax">DROP INDEX
syntax</a></li>
<li><a href="#drop-table-syntax" id="toc-drop-table-syntax">DROP TABLE
syntax</a></li>
<li><a href="#drop-universal-index-syntax"
id="toc-drop-universal-index-syntax">DROP UNIVERSAL INDEX
syntax</a></li>
<li><a href="#explain-select-syntax"
id="toc-explain-select-syntax">EXPLAIN SELECT syntax</a></li>
<li><a href="#flush-index-syntax" id="toc-flush-index-syntax">FLUSH
INDEX syntax</a></li>
<li><a href="#flush-manifest-syntax"
id="toc-flush-manifest-syntax">FLUSH MANIFEST syntax</a></li>
<li><a href="#insert-syntax" id="toc-insert-syntax">INSERT
syntax</a></li>
<li><a href="#pull-syntax" id="toc-pull-syntax">PULL syntax</a></li>
<li><a href="#kill-syntax" id="toc-kill-syntax">KILL syntax</a></li>
<li><a href="#lock-user-syntax" id="toc-lock-user-syntax">LOCK USER
syntax</a></li>
<li><a href="#reload-users-syntax" id="toc-reload-users-syntax">RELOAD
USERS syntax</a></li>
<li><a href="#replace-syntax" id="toc-replace-syntax">REPLACE
syntax</a></li>
<li><a href="#select-syntax" id="toc-select-syntax">SELECT
syntax</a></li>
<li><a href="#select-expr-syntax" id="toc-select-expr-syntax">SELECT
expr syntax</a></li>
<li><a href="#select-uservar-syntax"
id="toc-select-uservar-syntax">SELECT <span class="citation"
data-cites="uservar">@uservar</span> syntax</a></li>
<li><a href="#select-sysvar-syntax" id="toc-select-sysvar-syntax">SELECT
@<span class="citation" data-cites="sysvar">@sysvar</span>
syntax</a></li>
<li><a href="#show-create-table-syntax"
id="toc-show-create-table-syntax">SHOW CREATE TABLE syntax</a></li>
<li><a href="#show-followers-syntax" id="toc-show-followers-syntax">SHOW
FOLLOWERS syntax</a></li>
<li><a href="#show-index-agent-status-syntax"
id="toc-show-index-agent-status-syntax">SHOW INDEX AGENT STATUS
syntax</a></li>
<li><a href="#show-index-from-syntax"
id="toc-show-index-from-syntax">SHOW INDEX FROM syntax</a></li>
<li><a href="#show-index-status-syntax"
id="toc-show-index-status-syntax">SHOW INDEX STATUS syntax</a></li>
<li><a href="#show-index-segment-status-syntax"
id="toc-show-index-segment-status-syntax">SHOW INDEX SEGMENT STATUS
syntax</a></li>
<li><a href="#show-meta-syntax" id="toc-show-meta-syntax">SHOW META
syntax</a></li>
<li><a href="#show-optimize-status-syntax"
id="toc-show-optimize-status-syntax">SHOW OPTIMIZE STATUS
syntax</a></li>
<li><a href="#show-profile-syntax" id="toc-show-profile-syntax">SHOW
PROFILE syntax</a></li>
<li><a href="#show-replicas-syntax" id="toc-show-replicas-syntax">SHOW
REPLICAS syntax</a></li>
<li><a href="#show-status-syntax" id="toc-show-status-syntax">SHOW
STATUS syntax</a></li>
<li><a href="#show-manifest-syntax" id="toc-show-manifest-syntax">SHOW
MANIFEST syntax</a></li>
<li><a href="#show-threads-syntax" id="toc-show-threads-syntax">SHOW
THREADS syntax</a></li>
<li><a href="#show-variables-syntax" id="toc-show-variables-syntax">SHOW
VARIABLES syntax</a></li>
<li><a href="#truncate-index-syntax"
id="toc-truncate-index-syntax">TRUNCATE INDEX syntax</a></li>
<li><a href="#update-syntax" id="toc-update-syntax">UPDATE
syntax</a></li>
<li><a href="#like-and-ignore-clause"
id="toc-like-and-ignore-clause">LIKE and IGNORE clause</a></li>
</ul></li>
<li><a href="#functions-reference"
id="toc-functions-reference">Functions reference</a>
<ul>
<li><a href="#annots-function"
id="toc-annots-function"><code>ANNOTS()</code> function</a></li>
<li><a href="#bigint_set-function"
id="toc-bigint_set-function"><code>BIGINT_SET()</code> function</a></li>
<li><a href="#bitcount-function"
id="toc-bitcount-function"><code>BITCOUNT()</code> function</a></li>
<li><a href="#bitscmpseq-function"
id="toc-bitscmpseq-function"><code>BITSCMPSEQ()</code> function</a></li>
<li><a href="#bitscountseq-function"
id="toc-bitscountseq-function"><code>BITSCOUNTSEQ()</code>
function</a></li>
<li><a href="#bitsget-function"
id="toc-bitsget-function"><code>BITSGET()</code> function</a></li>
<li><a href="#coalesce-function"
id="toc-coalesce-function"><code>COALESCE()</code> function</a></li>
<li><a href="#contains-function"
id="toc-contains-function"><code>CONTAINS()</code> function</a></li>
<li><a href="#containsany-function"
id="toc-containsany-function"><code>CONTAINSANY()</code>
function</a></li>
<li><a href="#curtime-function"
id="toc-curtime-function"><code>CURTIME()</code> function</a></li>
<li><a href="#document-function"
id="toc-document-function"><code>DOCUMENT()</code> function</a></li>
<li><a href="#dot-function" id="toc-dot-function"><code>DOT()</code>
function</a></li>
<li><a href="#dump-function" id="toc-dump-function"><code>DUMP()</code>
function</a></li>
<li><a href="#exist-function"
id="toc-exist-function"><code>EXIST()</code> function</a></li>
<li><a href="#factors-function"
id="toc-factors-function"><code>FACTORS()</code> function</a></li>
<li><a href="#float-function"
id="toc-float-function"><code>FLOAT()</code> function</a></li>
<li><a href="#fvec-function" id="toc-fvec-function"><code>FVEC()</code>
function</a></li>
<li><a href="#fvecx-function"
id="toc-fvecx-function"><code>FVECX()</code> function</a></li>
<li><a href="#geodist-function"
id="toc-geodist-function"><code>GEODIST()</code> function</a></li>
<li><a href="#group_count-function"
id="toc-group_count-function"><code>GROUP_COUNT()</code>
function</a></li>
<li><a href="#integer-function"
id="toc-integer-function"><code>INTEGER()</code> function</a></li>
<li><a href="#intersect_len-function"
id="toc-intersect_len-function"><code>INTERSECT_LEN()</code>
function</a></li>
<li><a href="#l1dist-function"
id="toc-l1dist-function"><code>L1DIST()</code> function</a></li>
<li><a href="#l2dist-function"
id="toc-l2dist-function"><code>L2DIST()</code> function</a></li>
<li><a href="#mingeodist-function"
id="toc-mingeodist-function"><code>MINGEODIST()</code> function</a></li>
<li><a href="#mingeodistex-function"
id="toc-mingeodistex-function"><code>MINGEODISTEX()</code>
function</a></li>
<li><a href="#pp-function" id="toc-pp-function"><code>PP()</code>
function</a></li>
<li><a href="#pqmatched-function"
id="toc-pqmatched-function"><code>PQMATCHED()</code> function</a></li>
<li><a href="#query-function"
id="toc-query-function"><code>QUERY()</code> function</a></li>
<li><a href="#slice-functions" id="toc-slice-functions">Slice
functions</a></li>
<li><a href="#snippet-function"
id="toc-snippet-function"><code>SNIPPET()</code> function</a></li>
<li><a href="#strpos-function"
id="toc-strpos-function"><code>STRPOS()</code> function</a></li>
<li><a href="#timediff-function"
id="toc-timediff-function"><code>TIMEDIFF()</code> function</a></li>
<li><a href="#uint-function" id="toc-uint-function"><code>UINT()</code>
function</a></li>
<li><a href="#utc_time-function"
id="toc-utc_time-function"><code>UTC_TIME()</code> function</a></li>
<li><a href="#utc_timestamp-function"
id="toc-utc_timestamp-function"><code>UTC_TIMESTAMP()</code>
function</a></li>
<li><a href="#vadd-function" id="toc-vadd-function"><code>VADD()</code>
function</a></li>
<li><a href="#vdiv-function" id="toc-vdiv-function"><code>VDIV()</code>
function</a></li>
<li><a href="#vmul-function" id="toc-vmul-function"><code>VMUL()</code>
function</a></li>
<li><a href="#vslice-function"
id="toc-vslice-function"><code>VSLICE()</code> function</a></li>
<li><a href="#vsort-function"
id="toc-vsort-function"><code>VSORT()</code> function</a></li>
<li><a href="#vsub-function" id="toc-vsub-function"><code>VSUB()</code>
function</a></li>
<li><a href="#vsum-function" id="toc-vsum-function"><code>VSUM()</code>
function</a></li>
<li><a href="#wordpairctr-function"
id="toc-wordpairctr-function"><code>WORDPAIRCTR()</code>
function</a></li>
<li><a href="#zonespanlist-function"
id="toc-zonespanlist-function"><code>ZONESPANLIST()</code>
function</a></li>
</ul></li>
<li><a href="#server-variables-reference"
id="toc-server-variables-reference">Server variables reference</a>
<ul>
<li><a href="#agent-connection-variables"
id="toc-agent-connection-variables">Agent connection variables</a></li>
<li><a href="#agent-request-hedging-variables"
id="toc-agent-request-hedging-variables">Agent request hedging
variables</a></li>
<li><a href="#attrindex_thresh-variable"
id="toc-attrindex_thresh-variable"><code>attrindex_thresh</code>
variable</a></li>
<li><a href="#client_timeout-variable"
id="toc-client_timeout-variable"><code>client_timeout</code>
variable</a></li>
<li><a href="#cpu_stats-variable"
id="toc-cpu_stats-variable"><code>cpu_stats</code> variable</a></li>
<li><a href="#ha_period_karma-variable"
id="toc-ha_period_karma-variable"><code>ha_period_karma</code>
variable</a></li>
<li><a href="#ha_ping_interval-variable"
id="toc-ha_ping_interval-variable"><code>ha_ping_interval</code>
variable</a></li>
<li><a href="#ha_weight-variable"
id="toc-ha_weight-variable"><code>ha_weight</code> variable</a></li>
<li><a href="#log_debug_filter-variable"
id="toc-log_debug_filter-variable"><code>log_debug_filter</code>
variable</a></li>
<li><a href="#log_level-variable"
id="toc-log_level-variable"><code>log_level</code> variable</a></li>
<li><a href="#max_filters-variable"
id="toc-max_filters-variable"><code>max_filters</code> variable</a></li>
<li><a href="#max_filter_values-variable"
id="toc-max_filter_values-variable"><code>max_filter_values</code>
variable</a></li>
<li><a href="#net_spin_msec-variable"
id="toc-net_spin_msec-variable"><code>net_spin_msec</code>
variable</a></li>
<li><a href="#query-cache-variables"
id="toc-query-cache-variables">Query cache variables</a></li>
<li><a href="#query_log_min_msec-variable"
id="toc-query_log_min_msec-variable"><code>query_log_min_msec</code>
variable</a></li>
<li><a href="#read_timeout-variable"
id="toc-read_timeout-variable"><code>read_timeout</code>
variable</a></li>
<li><a href="#repl_blacklist-variable"
id="toc-repl_blacklist-variable"><code>repl_blacklist</code>
variable</a></li>
<li><a href="#sphinxql_timeout-variable"
id="toc-sphinxql_timeout-variable"><code>sphinxql_timeout</code>
variable</a></li>
<li><a href="#sql_fail_filter-variable"
id="toc-sql_fail_filter-variable"><code>sql_fail_filter</code>
variable</a></li>
<li><a href="#sql_log_file-variable"
id="toc-sql_log_file-variable"><code>sql_log_file</code>
variable</a></li>
<li><a href="#sql_log_filter-variable"
id="toc-sql_log_filter-variable"><code>sql_log_filter</code>
variable</a></li>
<li><a href="#use_avx512-variable"
id="toc-use_avx512-variable"><code>use_avx512</code> variable</a></li>
</ul></li>
<li><a href="#index-config-reference"
id="toc-index-config-reference">Index config reference</a>
<ul>
<li><a href="#annot_eot-directive"
id="toc-annot_eot-directive"><code>annot_eot</code> directive</a></li>
<li><a href="#annot_field-directive"
id="toc-annot_field-directive"><code>annot_field</code>
directive</a></li>
<li><a href="#annot_scores-directive"
id="toc-annot_scores-directive"><code>annot_scores</code>
directive</a></li>
<li><a href="#attr_bigint-directive"
id="toc-attr_bigint-directive"><code>attr_bigint</code>
directive</a></li>
<li><a href="#attr_bigint_set-directive"
id="toc-attr_bigint_set-directive"><code>attr_bigint_set</code>
directive</a></li>
<li><a href="#attr_blob-directive"
id="toc-attr_blob-directive"><code>attr_blob</code> directive</a></li>
<li><a href="#attr_bool-directive"
id="toc-attr_bool-directive"><code>attr_bool</code> directive</a></li>
<li><a href="#attr_float-directive"
id="toc-attr_float-directive"><code>attr_float</code> directive</a></li>
<li><a href="#attr_float_array-directive"
id="toc-attr_float_array-directive"><code>attr_float_array</code>
directive</a></li>
<li><a href="#attr_int8_array-directive"
id="toc-attr_int8_array-directive"><code>attr_int8_array</code>
directive</a></li>
<li><a href="#attr_int_array-directive"
id="toc-attr_int_array-directive"><code>attr_int_array</code>
directive</a></li>
<li><a href="#attr_json-directive"
id="toc-attr_json-directive"><code>attr_json</code> directive</a></li>
<li><a href="#attr_string-directive"
id="toc-attr_string-directive"><code>attr_string</code>
directive</a></li>
<li><a href="#attr_uint-directive"
id="toc-attr_uint-directive"><code>attr_uint</code> directive</a></li>
<li><a href="#attr_uint_set-directive"
id="toc-attr_uint_set-directive"><code>attr_uint_set</code>
directive</a></li>
<li><a href="#blackhole-directive"
id="toc-blackhole-directive"><code>blackhole</code> directive</a></li>
<li><a href="#blackhole_sample_div-directive"
id="toc-blackhole_sample_div-directive"><code>blackhole_sample_div</code>
directive</a></li>
<li><a href="#blend_mixed_codes-directive"
id="toc-blend_mixed_codes-directive"><code>blend_mixed_codes</code>
directive</a></li>
<li><a href="#bpe_merges_file-directive"
id="toc-bpe_merges_file-directive"><code>bpe_merges_file</code>
directive</a></li>
<li><a href="#create_index-directive"
id="toc-create_index-directive"><code>create_index</code>
directive</a></li>
<li><a href="#docstore_block-directive"
id="toc-docstore_block-directive"><code>docstore_block</code>
directive</a></li>
<li><a href="#docstore_comp-directive"
id="toc-docstore_comp-directive"><code>docstore_comp</code>
directive</a></li>
<li><a href="#docstore_type-directive"
id="toc-docstore_type-directive"><code>docstore_type</code>
directive</a></li>
<li><a href="#field-directive"
id="toc-field-directive"><code>field</code> directive</a></li>
<li><a href="#field_string-directive"
id="toc-field_string-directive"><code>field_string</code>
directive</a></li>
<li><a href="#global_avg_field_lengths-directive"
id="toc-global_avg_field_lengths-directive"><code>global_avg_field_lengths</code>
directive</a></li>
<li><a href="#global_idf-directive"
id="toc-global_idf-directive"><code>global_idf</code> directive</a></li>
<li><a href="#hl_fields-directive"
id="toc-hl_fields-directive"><code>hl_fields</code> directive</a></li>
<li><a href="#index_bpetok_fields-directive"
id="toc-index_bpetok_fields-directive"><code>index_bpetok_fields</code>
directive</a></li>
<li><a href="#index_tokclass_fields-directive"
id="toc-index_tokclass_fields-directive"><code>index_tokclass_fields</code>
directive</a></li>
<li><a href="#index_tokhash_fields-directive"
id="toc-index_tokhash_fields-directive"><code>index_tokhash_fields</code>
directive</a></li>
<li><a href="#index_trigram_fields-directive"
id="toc-index_trigram_fields-directive"><code>index_trigram_fields</code>
directive</a></li>
<li><a href="#index_words_clickstat_fields-directive"
id="toc-index_words_clickstat_fields-directive"><code>index_words_clickstat_fields</code>
directive</a></li>
<li><a href="#join_attrs-directive"
id="toc-join_attrs-directive"><code>join_attrs</code> directive</a></li>
<li><a href="#kbatch-directive"
id="toc-kbatch-directive"><code>kbatch</code> directive</a></li>
<li><a href="#kbatch_source-directive"
id="toc-kbatch_source-directive"><code>kbatch_source</code>
directive</a></li>
<li><a href="#mappings-directive"
id="toc-mappings-directive"><code>mappings</code> directive</a></li>
<li><a href="#mixed_codes_fields-directive"
id="toc-mixed_codes_fields-directive"><code>mixed_codes_fields</code>
directive</a></li>
<li><a href="#morphdict-directive"
id="toc-morphdict-directive"><code>morphdict</code> directive</a></li>
<li><a href="#pq_max_rows-directive"
id="toc-pq_max_rows-directive"><code>pq_max_rows</code>
directive</a></li>
<li><a href="#pretrained_index-directive"
id="toc-pretrained_index-directive"><code>pretrained_index</code>
directive</a></li>
<li><a href="#query_words_clickstat-directive"
id="toc-query_words_clickstat-directive"><code>query_words_clickstat</code>
directive</a></li>
<li><a href="#repl_follow-directive"
id="toc-repl_follow-directive"><code>repl_follow</code>
directive</a></li>
<li><a href="#required-directive"
id="toc-required-directive"><code>required</code> directive</a></li>
<li><a href="#rt_mem_limit-directive"
id="toc-rt_mem_limit-directive"><code>rt_mem_limit</code>
directive</a></li>
<li><a href="#stored_fields-directive"
id="toc-stored_fields-directive"><code>stored_fields</code>
directive</a></li>
<li><a href="#stored_only_fields-directive"
id="toc-stored_only_fields-directive"><code>stored_only_fields</code>
directive</a></li>
<li><a href="#tokclasses-directive"
id="toc-tokclasses-directive"><code>tokclasses</code> directive</a></li>
<li><a href="#index-type-directive" id="toc-index-type-directive">Index
<code>type</code> directive</a></li>
<li><a href="#universal_attrs-directive"
id="toc-universal_attrs-directive"><code>universal_attrs</code>
directive</a></li>
<li><a href="#updates_pool-directive"
id="toc-updates_pool-directive"><code>updates_pool</code>
directive</a></li>
</ul></li>
<li><a href="#source-config-reference"
id="toc-source-config-reference">Source config reference</a>
<ul>
<li><a href="#csvpipe_command-directive"
id="toc-csvpipe_command-directive"><code>csvpipe_command</code>
directive</a></li>
<li><a href="#csvpipe_delimiter-directive"
id="toc-csvpipe_delimiter-directive"><code>csvpipe_delimiter</code>
directive</a></li>
<li><a href="#csvpipe_header-directive"
id="toc-csvpipe_header-directive"><code>csvpipe_header</code>
directive</a></li>
<li><a href="#join_by_attr-directive"
id="toc-join_by_attr-directive"><code>join_by_attr</code>
directive</a></li>
<li><a href="#join_cache-directive"
id="toc-join_cache-directive"><code>join_cache</code> directive</a></li>
<li><a href="#join_file-directive"
id="toc-join_file-directive"><code>join_file</code> directive</a></li>
<li><a href="#join_header-directive"
id="toc-join_header-directive"><code>join_header</code>
directive</a></li>
<li><a href="#join_ids-directive"
id="toc-join_ids-directive"><code>join_ids</code> directive</a></li>
<li><a href="#join_optional-directive"
id="toc-join_optional-directive"><code>join_optional</code>
directive</a></li>
<li><a href="#join_schema-directive"
id="toc-join_schema-directive"><code>join_schema</code>
directive</a></li>
<li><a href="#mysql_ssl_ca-directive"
id="toc-mysql_ssl_ca-directive"><code>mysql_ssl_ca</code>
directive</a></li>
<li><a href="#mysql_ssl_cert-directive"
id="toc-mysql_ssl_cert-directive"><code>mysql_ssl_cert</code>
directive</a></li>
<li><a href="#mysql_ssl_key-directive"
id="toc-mysql_ssl_key-directive"><code>mysql_ssl_key</code>
directive</a></li>
<li><a href="#sql_db-directive"
id="toc-sql_db-directive"><code>sql_db</code> directive</a></li>
<li><a href="#sql_host-directive"
id="toc-sql_host-directive"><code>sql_host</code> directive</a></li>
<li><a href="#sql_pass-directive"
id="toc-sql_pass-directive"><code>sql_pass</code> directive</a></li>
<li><a href="#sql_port-directive"
id="toc-sql_port-directive"><code>sql_port</code> directive</a></li>
<li><a href="#sql_query_kbatch-directive"
id="toc-sql_query_kbatch-directive"><code>sql_query_kbatch</code>
directive</a></li>
<li><a href="#sql_query_set-directive"
id="toc-sql_query_set-directive"><code>sql_query_set</code>
directive</a></li>
<li><a href="#sql_query_set_range-directive"
id="toc-sql_query_set_range-directive"><code>sql_query_set_range</code>
directive</a></li>
<li><a href="#sql_sock-directive"
id="toc-sql_sock-directive"><code>sql_sock</code> directive</a></li>
<li><a href="#sql_user-directive"
id="toc-sql_user-directive"><code>sql_user</code> directive</a></li>
<li><a href="#tsvpipe_command-directive"
id="toc-tsvpipe_command-directive"><code>tsvpipe_command</code>
directive</a></li>
<li><a href="#tsvpipe_header-directive"
id="toc-tsvpipe_header-directive"><code>tsvpipe_header</code>
directive</a></li>
<li><a href="#source-type-directive"
id="toc-source-type-directive">Source <code>type</code>
directive</a></li>
<li><a href="#unpack_mysqlcompress-directive"
id="toc-unpack_mysqlcompress-directive"><code>unpack_mysqlcompress</code>
directive</a></li>
<li><a href="#unpack_mysqlcompress_maxsize-directive"
id="toc-unpack_mysqlcompress_maxsize-directive"><code>unpack_mysqlcompress_maxsize</code>
directive</a></li>
<li><a href="#unpack_zlib-directive"
id="toc-unpack_zlib-directive"><code>unpack_zlib</code>
directive</a></li>
</ul></li>
<li><a href="#common-config-reference"
id="toc-common-config-reference">Common config reference</a>
<ul>
<li><a href="#attrindex_thresh-directive"
id="toc-attrindex_thresh-directive"><code>attrindex_thresh</code>
directive</a></li>
<li><a href="#datadir-directive"
id="toc-datadir-directive"><code>datadir</code> directive</a></li>
<li><a href="#json_autoconv_keynames-directive"
id="toc-json_autoconv_keynames-directive"><code>json_autoconv_keynames</code>
directive</a></li>
<li><a href="#json_autoconv_numbers-directive"
id="toc-json_autoconv_numbers-directive"><code>json_autoconv_numbers</code>
directive</a></li>
<li><a href="#json_float-directive"
id="toc-json_float-directive"><code>json_float</code> directive</a></li>
<li><a href="#on_json_attr_error-directive"
id="toc-on_json_attr_error-directive"><code>on_json_attr_error</code>
directive</a></li>
<li><a href="#plugin_libinit_arg-directive"
id="toc-plugin_libinit_arg-directive"><code>plugin_libinit_arg</code>
directive</a></li>
<li><a href="#use_avx512-directive"
id="toc-use_avx512-directive"><code>use_avx512</code> directive</a></li>
<li><a href="#vecindex_threads-directive"
id="toc-vecindex_threads-directive"><code>vecindex_threads</code>
directive</a></li>
<li><a href="#vecindex_thresh-directive"
id="toc-vecindex_thresh-directive"><code>vecindex_thresh</code>
directive</a></li>
<li><a href="#vecindex_builds-directive"
id="toc-vecindex_builds-directive"><code>vecindex_builds</code>
directive</a></li>
</ul></li>
<li><a href="#indexer-config-reference"
id="toc-indexer-config-reference"><code>indexer</code> config
reference</a>
<ul>
<li><a href="#lemmatizer_cache-directive"
id="toc-lemmatizer_cache-directive"><code>lemmatizer_cache</code>
directive</a></li>
<li><a href="#max_file_field_buffer-directive"
id="toc-max_file_field_buffer-directive"><code>max_file_field_buffer</code>
directive</a></li>
<li><a href="#max_iops-directive"
id="toc-max_iops-directive"><code>max_iops</code> directive</a></li>
<li><a href="#max_iosize-directive"
id="toc-max_iosize-directive"><code>max_iosize</code> directive</a></li>
<li><a href="#max_xmlpipe2_field-directive"
id="toc-max_xmlpipe2_field-directive"><code>max_xmlpipe2_field</code>
directive</a></li>
<li><a href="#mem_limit-directive"
id="toc-mem_limit-directive"><code>mem_limit</code> directive</a></li>
<li><a href="#on_file_field_error-directive"
id="toc-on_file_field_error-directive"><code>on_file_field_error</code>
directive</a></li>
<li><a href="#write_buffer-directive"
id="toc-write_buffer-directive"><code>write_buffer</code>
directive</a></li>
</ul></li>
<li><a href="#searchd-config-reference"
id="toc-searchd-config-reference"><code>searchd</code> config
reference</a>
<ul>
<li><a href="#agent_hedge-directive"
id="toc-agent_hedge-directive"><code>agent_hedge</code>
directive</a></li>
<li><a href="#agent_hedge_delay_min_msec-directive"
id="toc-agent_hedge_delay_min_msec-directive"><code>agent_hedge_delay_min_msec</code>
directive</a></li>
<li><a href="#agent_hedge_delay_pct-directive"
id="toc-agent_hedge_delay_pct-directive"><code>agent_hedge_delay_pct</code>
directive</a></li>
<li><a href="#auth_users-directive"
id="toc-auth_users-directive"><code>auth_users</code> directive</a></li>
<li><a href="#binlog-directive"
id="toc-binlog-directive"><code>binlog</code> directive</a></li>
<li><a href="#binlog_erase_delay_sec-directive"
id="toc-binlog_erase_delay_sec-directive"><code>binlog_erase_delay_sec</code>
directive</a></li>
<li><a href="#binlog_flush_mode-directive"
id="toc-binlog_flush_mode-directive"><code>binlog_flush_mode</code>
directive</a></li>
<li><a href="#binlog_manifest_flush-directive"
id="toc-binlog_manifest_flush-directive"><code>binlog_manifest_flush</code>
directive</a></li>
<li><a href="#binlog_max_log_size-directive"
id="toc-binlog_max_log_size-directive"><code>binlog_max_log_size</code>
directive</a></li>
<li><a href="#binlog_path-directive"
id="toc-binlog_path-directive"><code>binlog_path</code>
directive</a></li>
<li><a href="#docstore_cache_size-directive"
id="toc-docstore_cache_size-directive"><code>docstore_cache_size</code>
directive</a></li>
<li><a href="#expansion_limit-directive"
id="toc-expansion_limit-directive"><code>expansion_limit</code>
directive</a></li>
<li><a href="#ha_weight_scales-directive"
id="toc-ha_weight_scales-directive"><code>ha_weight_scales</code>
directive</a></li>
<li><a href="#listen-directive"
id="toc-listen-directive"><code>listen</code> directive</a></li>
<li><a href="#listen_backlog-directive"
id="toc-listen_backlog-directive"><code>listen_backlog</code>
directive</a></li>
<li><a href="#meta_slug-directive"
id="toc-meta_slug-directive"><code>meta_slug</code> directive</a></li>
<li><a href="#net_spin_msec-directive"
id="toc-net_spin_msec-directive"><code>net_spin_msec</code>
directive</a></li>
<li><a href="#persistent_connections_limit-directive"
id="toc-persistent_connections_limit-directive"><code>persistent_connections_limit</code>
directive</a></li>
<li><a href="#predicted_time_costs-directive"
id="toc-predicted_time_costs-directive"><code>predicted_time_costs</code>
directive</a></li>
<li><a href="#qcache_max_bytes-directive"
id="toc-qcache_max_bytes-directive"><code>qcache_max_bytes</code>
directive</a></li>
<li><a href="#qcache_thresh_msec-directive"
id="toc-qcache_thresh_msec-directive"><code>qcache_thresh_msec</code>
directive</a></li>
<li><a href="#qcache_ttl_sec-directive"
id="toc-qcache_ttl_sec-directive"><code>qcache_ttl_sec</code>
directive</a></li>
<li><a href="#repl_binlog_packet_size-directive"
id="toc-repl_binlog_packet_size-directive"><code>repl_binlog_packet_size</code>
directive</a></li>
<li><a href="#repl_epoll_wait_msec-directive"
id="toc-repl_epoll_wait_msec-directive"><code>repl_epoll_wait_msec</code>
directive</a></li>
<li><a href="#repl_follow-directive-1"
id="toc-repl_follow-directive-1"><code>repl_follow</code>
directive</a></li>
<li><a href="#repl_net_timeout_sec-directive"
id="toc-repl_net_timeout_sec-directive"><code>repl_net_timeout_sec</code>
directive</a></li>
<li><a href="#repl_sync_tick_msec-directive"
id="toc-repl_sync_tick_msec-directive"><code>repl_sync_tick_msec</code>
directive</a></li>
<li><a href="#repl_threads-directive"
id="toc-repl_threads-directive"><code>repl_threads</code>
directive</a></li>
<li><a href="#repl_uid-directive"
id="toc-repl_uid-directive"><code>repl_uid</code> directive</a></li>
<li><a href="#wordpairs_ctr_file-directive"
id="toc-wordpairs_ctr_file-directive"><code>wordpairs_ctr_file</code>
directive</a></li>
</ul></li>
<li><a href="#indexer-cli-reference"
id="toc-indexer-cli-reference"><code>indexer</code> CLI
reference</a></li>
<li><a href="#searchd-cli-reference"
id="toc-searchd-cli-reference"><code>searchd</code> CLI reference</a>
<ul>
<li><a href="#searchd-subcommands"
id="toc-searchd-subcommands"><code>searchd</code> subcommands</a></li>
<li><a href="#common-searchd-options"
id="toc-common-searchd-options">Common <code>searchd</code>
options</a></li>
<li><a href="#searchd-decode-command"
id="toc-searchd-decode-command"><code>searchd decode</code>
command</a></li>
<li><a href="#searchd-run-command"
id="toc-searchd-run-command"><code>searchd run</code> command</a></li>
<li><a href="#searchd-run-options"
id="toc-searchd-run-options"><code>searchd run</code> options</a></li>
<li><a href="#searchd-run-debugging-options"
id="toc-searchd-run-debugging-options"><code>searchd run</code>
debugging options</a></li>
</ul></li>
<li><a href="#changes-in-3.x" id="toc-changes-in-3.x">Changes in 3.x</a>
<ul>
<li><a href="#version-3.9.1-18-dec-2025"
id="toc-version-3.9.1-18-dec-2025">Version 3.9.1, 18 dec 2025</a></li>
<li><a href="#version-3.8.1-12-may-2025"
id="toc-version-3.8.1-12-may-2025">Version 3.8.1, 12 may 2025</a></li>
<li><a href="#version-3.7.1-28-mar-2024"
id="toc-version-3.7.1-28-mar-2024">Version 3.7.1, 28 mar 2024</a></li>
<li><a href="#version-3.6.1-04-oct-2023"
id="toc-version-3.6.1-04-oct-2023">Version 3.6.1, 04 oct 2023</a></li>
<li><a href="#version-3.5.1-02-feb-2023"
id="toc-version-3.5.1-02-feb-2023">Version 3.5.1, 02 feb 2023</a></li>
<li><a href="#version-3.4.1-09-jul-2021"
id="toc-version-3.4.1-09-jul-2021">Version 3.4.1, 09 jul 2021</a></li>
<li><a href="#version-3.3.1-06-jul-2020"
id="toc-version-3.3.1-06-jul-2020">Version 3.3.1, 06 jul 2020</a></li>
<li><a href="#version-3.2.1-31-jan-2020"
id="toc-version-3.2.1-31-jan-2020">Version 3.2.1, 31 jan 2020</a></li>
<li><a href="#version-3.1.1-17-oct-2018"
id="toc-version-3.1.1-17-oct-2018">Version 3.1.1, 17 oct 2018</a></li>
<li><a href="#version-3.0.3-30-mar-2018"
id="toc-version-3.0.3-30-mar-2018">Version 3.0.3, 30 mar 2018</a></li>
<li><a href="#version-3.0.2-25-feb-2018"
id="toc-version-3.0.2-25-feb-2018">Version 3.0.2, 25 feb 2018</a></li>
<li><a href="#version-3.0.1-18-dec-2017"
id="toc-version-3.0.1-18-dec-2017">Version 3.0.1, 18 dec 2017</a></li>
</ul></li>
<li><a href="#changes-since-v.2.x" id="toc-changes-since-v.2.x">Changes
since v.2.x</a></li>
<li><a href="#references" id="toc-references">References</a></li>
<li><a href="#copyrights" id="toc-copyrights">Copyrights</a></li>
</ul>
</nav>
<div class="docbody">
<h1 id="sphinx-3"><div id="logo" style="width:48px;height:48px"></div> Sphinx 3</h1>
<p>Sphinx is a free, dual-licensed search server (aka database with
advanced text searching features). Sphinx is written in C++, and focuses
on query performance and search relevance.</p>
<p>The primary client API is SphinxQL, a dialect of SQL. Almost any
MySQL connector should work.</p>
<p>(Native APIs for a number of languages (PHP, Python, Ruby, C, Java,
etc) also still exist but those are deprecated. Use SphinxQL
instead.)</p>
<p>This document is an effort to build a better documentation for Sphinx
v.3.x and up. Think of it as a book or a tutorial which you could
actually <em>read</em>; think of the previous “reference manual” as of a
“dictionary” where you look up specific syntax features. The two might
(and should) eventually converge.</p>
<h2 id="features-overview">Features overview</h2>
<p>Top level picture, <strong>what does Sphinx offer</strong>?</p>
<p>Sphinx nowadays (as of 2020s) really is a <strong>specialized
database</strong>. Naturally it’s focused on full-text searches, but
definitely not <em>only</em> those. It handles many other workloads
really well: geo searches, vector searches, JSON queries, “regular”
parameter-based queries, and so on. So key Sphinx capabilities are
(briefly) the following.</p>
<ul>
<li>Extensive SQL API, and native MySQL wire protocol support</li>
<li>Online NRT (Near Real Time) indexing, and offline batch
indexing</li>
<li>Advanced full-text searches, with a bunch of specialized
features</li>
<li>Advanced non-text searches (geosearches, vector searches, etc)</li>
<li>State-of-the-art relevance ranking, from basic formulas to ML
models</li>
<li>Native JSON support, enabling a mixed relational/document model</li>
<li>Federated results from multiple servers, helping scale-out</li>
<li>Decent performance</li>
</ul>
<p>At a glance, <strong>Sphinx is a NoSQL database with an SQL
interface</strong>, designed for <strong>all kinds of search-related
OLTP workloads</strong>. It scales to tens of billions of documents and
billions of queries/day in our production clusters.</p>
<p>Sphinx <strong>data model is mixed relational/document</strong>.
Because even though our <strong>documents are based on relational-like
rows</strong>, some/all data can be stored in <strong>JSON-typed
columns</strong> instead. In our opinion this lets you combine the best
of both worlds.</p>
<p><strong>Sphinx can be used without any full-text indexing at
all.</strong> That’s perfectly legal operational mode. Sphinx does
require having at least one full-text field, but it does not require
<em>populating</em> that field! So “full-text indexes” without any text
in them are perfectly legal.</p>
<p><strong>Non-text queries are first-class citizens.</strong> Meaning
that geo, vector, JSON, and other non-text queries do not even
<em>require</em> any full-text magic. They work great without any
full-text query parts, they can have their own non-text indexes,
etc.</p>
<p>Sphinx supports <strong>multiple (data) index types</strong> that
speed up different kinds of queries. Our primary, always-on index is
<strong>the inverted (full-text) index</strong> on text fields, required
by full-text searches. Optional <strong>secondary indexes</strong> on
non-text attributes are also supported. Sphinx can currently maintain
either <strong>B-tree indexes</strong> or <strong>vector
indexes</strong> (formally, Approximate Nearest Neighbor indexes).</p>
<p>For those coming fom SQL databases, Sphinx is
<strong>non-transactional</strong> (non-ACID) by design and <strong>does
not do JOINs</strong> (basically for performance reasons); but
<strong>durable by default</strong> with WALs, and with a few other
guarantees.</p>
<p>Well, that should be it for a 30-second overview. Then, of course,
there are tons of specific features that we’ve been building over
decades. Here go a few that might be worth an early mention.
(Disclaimer, the following list is likely incomplete at all times, and
definitely in random order.)</p>
<ul>
<li>Morphology and text-processing tools
<ul>
<li>Fully flexible tokenization (see <code>charset_table</code> and
<code>exceptions</code>)</li>
<li>Proper morphology (lemmatizer) for English, Russian, and German (see
<code>morphology</code>)</li>
<li>Basic morphology (stemmer) for many other languages</li>
<li>User-specified mappings, <code>core 2 duo =&gt; c2d</code></li>
<li>Advanced tools such as sentence/paragraph/zone indexing, trigram
hashes, blended tokens and mixed codes tokens indexing, annotation
indexes, etc</li>
</ul></li>
<li>Geosearches support</li>
<li>Fast expressions engine</li>
<li>Query suggestions</li>
<li>Snippets builder</li>
<li>Vector searches support</li>
<li>Percolate (reverse) searches support</li>
</ul>
<h2 id="features-cheat-sheet">Features cheat sheet</h2>
<p>This section is supposed to provide a bit more detail on all the
available features; to cover them more or less fully; and give you some
further pointers into the specific reference sections (on the related
config directives and SphinxQL statements).</p>
<ul>
<li>Full-text search queries, see
<code>SELECT ... WHERE MATCH('this')</code> SphinxQL statement
<ul>
<li>Boolean matching operators (implicit AND, explicit OR, NOT, and
brackets), as in <code>(one two) | (three !four)</code></li>
<li>Boolean matching optimizations, see
<code>OPTION boolean_simplify=1</code> in <code>SELECT</code>
statement</li>
<li>Advanced text matching operators
<ul>
<li>Field restrictions, <code>@title hello world</code> or
<code>@!title hello</code> or <code>@(title,body) any of the two</code>
etc</li>
<li>In-field position restrictions, <code>@title[50] hello</code></li>
<li>MAYBE operator for optional keyword matching,
<code>cat MAYBE dog</code></li>
<li>phrase matching, <code>"roses are red"</code></li>
<li>quorum matching,
<code>"pick any 3 keywords out of this entire set"/3</code></li>
<li>proximity matching,
<code>"within 10 positions all terms in yoda order"~10</code> or
<code>hello NEAR/3 world NEAR/4 "my test"</code></li>
<li>strict order matching,
<code>(bag of words) &lt;&lt; "exact phrase" &lt;&lt; this|that</code></li>
<li>sentence matching,
<code>all SENTENCE words SENTENCE "in one sentence"</code></li>
<li>paragraph matching,
<code>"Bill Gates" PARAGRAPH "Steve Jobs"</code></li>
<li>zone and zone-span matching,
<code>ZONE:(h3,h4) in any of these title tags</code> and
<code>ZONESPAN:(h2) only in a single instance</code></li>
</ul></li>
<li>Keyword modifiers (that can usually be used within operators)
<ul>
<li>exact (pre-morphology) form modifier,
<code>raining =cats and =dogs</code></li>
<li>field-start and field-end modifiers, <code>^hello world$</code></li>
<li>IDF (ranking) boost, <code>boosted^1.234</code></li>
</ul></li>
<li>Substring and wildcard searches
<ul>
<li>see <code>min_prefix_len</code> and <code>min_infix_len</code>
directives</li>
<li>use <code>th?se three keyword% wild*cards *verywher*</code>
(<code>?</code> = 1 char exactly; <code>%</code> = 0 or 1 char;
<code>*</code> = 0 or more chars)</li>
</ul></li>
</ul></li>
<li>…</li>
</ul>
<p>TODO: describe more, add links!</p>
<h2 id="getting-started">Getting started</h2>
<p>That should now be rather simple. No magic installation required! On
any platform, the <em>sufficient</em> thing to do is:</p>
<ol type="1">
<li>Get the binaries.</li>
<li>Run <code>searchd</code>.</li>
<li>Create the RT indexes.</li>
<li>Run queries.</li>
</ol>
<p>This is the <strong>easiest</strong> way to get up and running.
Sphinx RT indexes (and yes, “RT” stands for “real-time”) are very much
like SQL tables. So you run the usual <code>CREATE TABLE</code> query to
create an RT index, then run a few <code>INSERT</code> queries to
populate that index with data, then a <code>SELECT</code> to search, and
so on. See more details on all that just below.</p>
<p>Or alternatively, you can also ETL your existing data stored in SQL
(or CSV or XML) “offline”, using the <code>indexer</code> tool. That
requires a config, as <code>indexer</code> needs to know where to fetch
the index data from.</p>
<ol type="1">
<li>Get the binaries.</li>
<li>Create <code>sphinx.conf</code>, with at least 1 <code>index</code>
section.</li>
<li>Run <code>indexer build --all</code> once, to initially create the
“plain” indexes.</li>
<li>Run <code>searchd</code>.</li>
<li>Run queries.</li>
<li>Run <code>indexer build --rotate --all</code> regularly, to “update”
the indexes.</li>
</ol>
<p>This in turn is the easiest way to index (and search!) your
<strong>existing</strong> data stored in something that
<code>indexer</code> supports. <code>indexer</code> can then grab data
from your SQL database (or a plain file); process that data “offline”
and (re)build a so-called “plain” index; and then hand that off to
<code>searchd</code> for searching. “Plain” indexes are a bit limited
compared to “RT” indexes, but can be easily “converted” to RT. Again,
more details below, we discuss this approach in the <a
href="#writing-your-first-config">“Writing your first config”</a>
section.</p>
<p>For now, back to simple fun “online” searching with RT indexes!</p>
<h3 id="getting-started-on-linux-and-macos">Getting started on Linux
(and MacOS)</h3>
<p>Versions and file names <em>will</em> vary, and you most likely
<em>will</em> want to configure Sphinx at least a little, but for an
immediate quickstart:</p>
<pre><code>$ wget -q https://sphinxsearch.com/files/sphinx-3.6.1-c9dbeda-linux-amd64.tar.gz
$ tar zxf sphinx-3.6.1-c9dbeda-linux-amd64.tar.gz
$ cd sphinx-3.6.1/bin/
$ ./searchd
Sphinx 3.6.1 (commit c9dbedab)
Copyright (c) 2001-2023, Andrew Aksyonoff
Copyright (c) 2008-2016, Sphinx Technologies Inc (http://sphinxsearch.com)

no config file and no datadir, using &#39;./sphinxdata&#39;...
listening on all interfaces, port=9312
listening on all interfaces, port=9306
loading 0 indexes...
$</code></pre>
<p>That’s it! The daemon should now be running and accepting connections
on port 9306 in background. And you can connect to it using MySQL CLI
(see below for more details, or just try <code>mysql -P9306</code> right
away).</p>
<p>For the record, to stop the daemon cleanly, you can either run it
with <code>--stop</code> switch, or just kill it with
<code>SIGTERM</code> (it properly handles that signal).</p>
<pre><code>$ ./searchd --stop
Sphinx 3.6.1 (commit c9dbedab)
Copyright (c) 2001-2023, Andrew Aksyonoff
Copyright (c) 2008-2016, Sphinx Technologies Inc (http://sphinxsearch.com)

no config file and no datadir, using &#39;./sphinxdata&#39;...
stop: successfully sent SIGTERM to pid 3337005</code></pre>
<p>Now to querying (just after a tiny detour for Windows users).</p>
<h3 id="getting-started-on-windows">Getting started on Windows</h3>
<p>Pretty much the same story, except that on Windows
<code>searchd</code> does <strong>not</strong> automatically go into
background.</p>
<pre><code>C:\sphinx-3.6.1\bin&gt;searchd.exe
Sphinx 3.6.1-dev (commit c9dbedabf)
Copyright (c) 2001-2023, Andrew Aksyonoff
Copyright (c) 2008-2016, Sphinx Technologies Inc (http://sphinxsearch.com)

no config file and no datadir, using &#39;./sphinxdata&#39;...
listening on all interfaces, port=9312
listening on all interfaces, port=9306
loading 0 indexes...
accepting connections</code></pre>
<p>This is alright. It isn’t hanging, it’s waiting for you queries. Do
not kill it. Just switch to a separate session and start querying.</p>
<h3 id="running-queries-via-mysql-shell">Running queries via MySQL
shell</h3>
<p>Run the MySQL CLI and point it to a port 9306. For example on
Windows:</p>
<pre><code>C:\&gt;mysql -h127.0.0.1 -P9306
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 1
Server version: 3.0-dev (c3c241f)
...</code></pre>
<p>I have intentionally used <code>127.0.0.1</code> in this example for
two reasons (both caused by MySQL CLI quirks, not Sphinx):</p>
<ul>
<li>sometimes, an IP address is required to use the <code>-P9306</code>
switch, not <code>localhost</code></li>
<li>sometimes, <code>localhost</code> works but causes a connection
delay</li>
</ul>
<p>But in the simplest case even just <code>mysql -P9306</code> should
work fine.</p>
<p>And from there, just run some SphinxQL queries!</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">CREATE</span> <span class="kw">TABLE</span> test (<span class="kw">id</span> bigint, title field stored, content field stored,</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> gid uint);</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> test (<span class="kw">id</span>, title) <span class="kw">VALUES</span> (<span class="dv">123</span>, <span class="st">&#39;hello world&#39;</span>);</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> test (<span class="kw">id</span>, gid, content) <span class="kw">VALUES</span> (<span class="dv">234</span>, <span class="dv">345</span>, <span class="st">&#39;empty title&#39;</span>);</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test;</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------+-------------+</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | gid  | title       | content     |</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------+-------------+</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> |    <span class="dv">0</span> | hello world |             |</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">234</span> |  <span class="dv">345</span> |             | <span class="kw">empty</span> title |</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------+-------------+</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello&#39;</span>);</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------+---------+</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | gid  | title       | content |</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------+---------+</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> |    <span class="dv">0</span> | hello world |         |</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------+---------+</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test <span class="kw">WHERE</span> MATCH(<span class="st">&#39;@content hello&#39;</span>);</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="kw">Empty</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>SphinxQL is our own SQL dialect, described in more detail in the
respective <a href="#sphinxql-reference">SphinxQL Reference</a> section.
Simply read on for the most important basics, though, we discuss them a
little below.</p>
<p>Before we begin, though, this (simplest) example only uses
<code>searchd</code>, and while that’s also fine, there’s a different,
convenient operational mode where you can <strong>easily index your
pre-existing SQL data</strong> using the <code>indexer</code> tool.</p>
<p>The bundled <code>etc/sphinx-min.conf.dist</code> and
<code>etc/example.sql</code> example files show exactly that. <a
href="#writing-your-first-config">“Writing your first config”</a>
section below steps through that example and explains everything.</p>
<p>Now back to CREATEs, INSERTs, and SELECTs. Alright, so what just
happened?!</p>
<h3 id="sphinxql-basics">SphinxQL basics</h3>
<p>We just created our first <strong>full-text index</strong> with a
<code>CREATE TABLE</code> statement, called <code>test</code>
(naturally).</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> test (</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> BIGINT,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  title FIELD STORED,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  content FIELD STORED,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  gid UINT);</span></code></pre></div>
<p>Even though we’re using MySQL client, we’re talking to Sphinx here,
not MySQL! And we’re using its SQL dialect (with <code>FIELD</code> and
<code>UINT</code> etc).</p>
<p>We configured 2 full-text <strong>fields</strong> called
<code>title</code> and <code>content</code> respectively, and 1 integer
<strong>attribute</strong> called <code>gid</code> (group ID, whatever
that might be).</p>
<p>We then issued a couple of <code>INSERT</code> queries, and that
inserted a couple rows into our index. Formally those are called
<strong>documents</strong>, but we will use both terms
interchangeably.</p>
<p>Once <code>INSERT</code> says OK, those rows (aka documents!) become
immediately available for <code>SELECT</code> queries. Because
<strong>RT index</strong> is “real-time” like that.</p>
<pre><code>mysql&gt; SELECT * FROM test;
+------+------+-------------+-------------+
| id   | gid  | title       | content     |
+------+------+-------------+-------------+
|  123 |    0 | hello world |             |
|  234 |  345 |             | empty title |
+------+------+-------------+-------------+
2 rows in set (0.00 sec)</code></pre>
<p>Now, what was that <code>STORED</code> thingy all about? That enables
<strong>DocStore</strong> and explicitly tells Sphinx to <strong>store
the original field text</strong> into our full-text index. And what if
we don’t?</p>
<pre><code>mysql&gt; CREATE TABLE test2 (id BIGINT, title FIELD, gid UINT);
Query OK, 0 rows affected (0.00 sec)

mysql&gt; INSERT INTO test2 (id, title) VALUES (321, &#39;hello world&#39;);
Query OK, 1 row affected (0.00 sec)

mysql&gt; SELECT * FROM test2;
+------+------+
| id   | gid  |
+------+------+
|  321 |    0 |
+------+------+
1 row in set (0.00 sec)</code></pre>
<p>As you see, <strong>by default Sphinx does not store the original
field text</strong>, and <strong>only</strong> keeps the full-text
index. So you can search but you can’t read those fields. A bit more
details on that are in <a href="#using-docstore">“Using DocStore”</a>
section.</p>
<p>Text searches with <code>MATCH()</code> are going to work at all
times. Whether we have DocStore or not. Because Sphinx is a full-text
search engine first.</p>
<pre><code>mysql&gt; SELECT * FROM test WHERE MATCH(&#39;hello&#39;);
+------+------+-------------+---------+
| id   | gid  | title       | content |
+------+------+-------------+---------+
|  123 |    0 | hello world |         |
+------+------+-------------+---------+
1 row in set (0.00 sec)

mysql&gt; SELECT * FROM test2 WHERE MATCH(&#39;hello&#39;);
+------+------+
| id   | gid  |
+------+------+
|  321 |    0 |
+------+------+
1 row in set (0.00 sec)</code></pre>
<p>Then we used <strong>full-text query syntax</strong> to run a fancier
query than just simply matching <code>hello</code> in any (full-text
indexed) <strong>field</strong>. We limited our searches to the
<code>content</code> field and… got zero results.</p>
<pre><code>mysql&gt; SELECT * FROM test WHERE MATCH(&#39;@content hello&#39;);
Empty set (0.00 sec)</code></pre>
<p>But that’s as expected. Our greetings were in the title, right?</p>
<pre><code>mysql&gt; SELECT *, WEIGHT() FROM test WHERE MATCH(&#39;@title hello&#39;);
+------+-------------+---------+------+-----------+
| id   | title       | content | gid  | weight()  |
+------+-------------+---------+------+-----------+
|  123 | hello world |         |    0 | 10315.066 |
+------+-------------+---------+------+-----------+
1 row in set (0.00 sec)</code></pre>
<p>Right. By default <code>MATCH()</code> only matches documents (aka
rows) that have <strong>all</strong> the keywords, but those matching
keywords are allowed to occur <strong>anywhere</strong> in the document,
in <strong>any</strong> of the indexed fields.</p>
<pre><code>mysql&gt; INSERT INTO test (id, title, content) VALUES (1212, &#39;one&#39;, &#39;two&#39;);
Query OK, 1 row affected (0.00 sec)

mysql&gt; SELECT * FROM test WHERE MATCH(&#39;one two&#39;);
+------+-------+---------+------+
| id   | title | content | gid  |
+------+-------+---------+------+
| 1212 | one   | two     |    0 |
+------+-------+---------+------+
1 row in set (0.00 sec)

mysql&gt; SELECT * FROM test WHERE MATCH(&#39;one three&#39;);
Empty set (0.00 sec)</code></pre>
<p>To limit matching to a given field, we must use a <strong>field limit
operator</strong>, and <code>@title</code> is Sphinx syntax for that.
There are many more operators than that, see <a
href="#searching-query-syntax">“Searching: query syntax”</a>
section.</p>
<p>Now, when <strong>many</strong> documents match, we usually must
<strong>rank</strong> them somehow. Because we want documents that are
more <strong>relevant</strong> to our query to come out first. That’s
exactly what <code>WEIGHT()</code> is all about.</p>
<pre><code>mysql&gt; INSERT INTO test (id, title) VALUES (124, &#39;hello hello hello&#39;);
Query OK, 1 row affected (0.00 sec)

mysql&gt; SELECT *, WEIGHT() FROM test WHERE MATCH(&#39;hello&#39;);
+------+-------------------+---------+------+-----------+
| id   | title             | content | gid  | weight()  |
+------+-------------------+---------+------+-----------+
|  124 | hello hello hello |         |    0 | 10495.105 |
|  123 | hello world       |         |    0 | 10315.066 |
+------+-------------------+---------+------+-----------+
2 rows in set (0.00 sec)</code></pre>
<p>The default Sphinx <strong>ranking function</strong> uses just two
<strong>ranking signals</strong> per each field, namely BM15 (a
variation of the classic BM25 function), and LCS (aka Longest Common
Subsequence length). Very basically, LCS “ensures” that closer phrase
matches are ranked higher than scattered keywords, and BM15 mixes that
with per-keyword statistics.</p>
<p>This default ranker (called <code>PROXIMITY_BM15</code>) is an okay
baseline. It is fast enough, and provides <em>some</em> search quality
to start with. Sphinx has a few more <strong>built-in rankers</strong>
that <em>might</em> either yield better quality (see
<code>SPH04</code>), or perform even better (see <code>BM15</code>).</p>
<p>However, <strong>proper ranking is much more complicated than just
that.</strong> Once you switch away from super-simple built-in rankers,
Sphinx computes <strong>tens</strong> of very different
<strong>(dynamic) text ranking signals</strong> in runtime, per each
field. Those signals can then be used in either a <strong>custom ranking
formula</strong>, or (better yet) passed to an external <strong>UDF
(user-defined function)</strong> that, these days, usually uses an ML
trained model to compute the final weight.</p>
<p>The specific signals (also historically called
<strong>factors</strong> in Sphinx lingo) are covered in the <a
href="#ranking-factors">“Ranking: factors”</a> section. If you know a
bit about ranking in general, have your training corpus and baseline
NDCG ready for immediate action, and you just need to figure out what
this little weird Sphinx system can do specifically, start there. If
not, you need a book, and this isn’t that book. <strong>“Introduction to
Information Retrieval”</strong> by Christopher Manning is one excellent
option, and freely available online.</p>
<p>Well, that escalated quickly! Before the Abyss of the Dreaded Ranking
starts staring back at us, let’s get back to easier, more everyday
topics.</p>
<h3 id="sphinxql-vs-regular-sql">SphinxQL vs regular SQL</h3>
<p>Our SphinxQL examples so far looked almost like regular SQL. Yes,
there already were a few syntax extensions like <code>FIELD</code> or
<code>MATCH()</code>, but overall it looked deceptively SQL-ish, now
didn’t.</p>
<p>Only, there <strong>are</strong> several very important SphinxQL
<code>SELECT</code> differences that should be mentioned early.</p>
<p><strong>SphinxQL <code>SELECT</code> always has an implicit
<code>ORDER BY</code> and <code>LIMIT</code> clauses</strong>, those are
<code>ORDER BY WEIGHT() DESC, id ASC LIMIT 20</code> specifically. So by
default you get “top-20 most relevant rows”, and that is very much
<em>unlike</em> regular SQL, which would give you “all the matching rows
in pseudo-random order” instead.</p>
<p><code>WEIGHT()</code> is just always 1 when there’s no
<code>MATCH()</code>, so you get “top-20 rows with the smallest IDs”
that way. <code>SELECT id, price FROM products</code> does actually mean
<code>SELECT id, price FROM products ORDER BY id ASC LIMIT 20</code> in
Sphinx.</p>
<p>You can raise <code>LIMIT</code> much higher, but <em>some</em> limit
is always there, refer to <a
href="#searching-memory-budgets">“Searching: memory budgets”</a> for
details.</p>
<p><strong>Almost-arbitrary SphinxQL <code>WHERE</code> conditions are
fine.</strong> Starting with v.3.8, we (finally!) support arbitrary
expressions in our <code>WHERE</code> clause, for example,
<code>WHERE a=123 OR b=456</code>, or
<code>WHERE cos(phi)&lt;0.5</code>, or pretty much anything else.
(Previously, that was not the case for just about forever, our
<code>WHERE</code> support was much more limited.)</p>
<p><strong>However, <code>WHERE</code> conditions with
<code>MATCH()</code> are a little restricted.</strong> When using
<code>MATCH()</code> or <code>PQMATCH()</code> there are a few natural
restrictions (because for queries like that we <strong>must</strong>
execute them using full-text matching as our very first step).
Specifically:</p>
<ol type="1">
<li>there <strong>must</strong> be exactly one instance of the
<code>MATCH()</code> operator,</li>
<li>it <strong>must</strong> be at the top level of the entire
<code>WHERE</code> expression, and</li>
<li>any extra top-level conditions <strong>must</strong> use
<code>AND</code> operators only.</li>
</ol>
<p>In other words, your top-level <code>WHERE</code> expression can only
combine <code>MATCH()</code> and anything else on <em>that</em> level
using <code>AND</code> operator, not <code>OR</code> or any other
operators. (However, <code>OR</code> and other operators are still okay
on deeper, more nested levels.) For example.</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a># OK!</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;this is allowed&#39;</span>) <span class="kw">AND</span> color <span class="op">=</span> <span class="st">&#39;red&#39;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a># OK too! we have <span class="kw">OR</span> but <span class="kw">not</span> <span class="kw">on</span> <span class="kw">the</span> <span class="op">*</span>top<span class="op">*</span> expression <span class="kw">level</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;this is allowed&#39;</span>) <span class="kw">AND</span> (color <span class="op">=</span> <span class="st">&#39;red&#39;</span> <span class="kw">OR</span> price <span class="op">&lt;</span> <span class="dv">100</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a># error! can<span class="st">&#39;t do MATCH-OR, only MATCH-AND</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE MATCH(&#39;</span>this <span class="kw">is</span> <span class="kw">not</span> allowed<span class="st">&#39;) OR price &lt; 100</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="st"># error! double match</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE MATCH(&#39;</span>this is<span class="st">&#39;) AND MATCH(&#39;</span>not allowed<span class="st">&#39;)</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="st"># error! MATCH not on top level</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE NOT MATCH(&#39;</span>this <span class="kw">is</span> <span class="kw">not</span> allowed<span class="st">&#39;)</span></span></code></pre></div>
<p><strong>Moving conditions to <code>WHERE</code> may cause performance
drops. Report those!</strong> Arbitrary expressions in
<code>WHERE</code> are a recent addition in v.3.8 (aka year 2025), so
you <strong>might</strong> encounter performance drops when/if a certain
case is not (yet) covered by index optimizations that did engage on
<code>SELECT</code> expressions, but fail to engage on
<code>WHERE</code> conditions. Just report those so we could fix
them.</p>
<p><strong>JSON keys can be used in <code>WHERE</code> checks with an
explicit numeric type cast.</strong> Sphinx does not support
<code>WHERE j.price &lt; 10</code>, basically because it does not
generally support <code>NULL</code> values. However,
<code>WHERE UINT(j.price) &lt; 10</code> works fine, once you provide an
explicit numeric type cast (ie. to <code>UINT</code>,
<code>BIGINT</code>, or <code>FLOAT</code> types). Missing or
incompatibly typed JSON values cast to zero.</p>
<p><strong>JSON keys can be checked for existence.</strong>
<code>WHERE j.foo IS NULL</code> condition works okay. As expected, it
accepts rows that do <em>not</em> have a <code>foo</code> key in their
JSON <code>j</code> column.</p>
<p>Next thing, <strong>aliases in <code>SELECT</code> list can be
immediately used in the list</strong>, meaning that
<code>SELECT id + 10 AS a, a * 2 AS b, b &lt; 1000 AS cond</code> are
perfectly legal. Again unlike regular SQL, but this time SphinxQL is
better!</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a># this <span class="kw">is</span> MySQL</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span> <span class="op">+</span> <span class="dv">10</span> <span class="kw">AS</span> a, a <span class="op">*</span> <span class="dv">2</span> <span class="kw">AS</span> b, b <span class="op">&lt;</span> <span class="dv">1000</span> <span class="kw">AS</span> cond <span class="kw">FROM</span> test;</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>ERROR <span class="dv">1054</span> (42S22): Unknown <span class="kw">column</span> <span class="st">&#39;a&#39;</span> <span class="kw">in</span> <span class="st">&#39;field list&#39;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a># this <span class="kw">is</span> Sphinx</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span> <span class="op">+</span> <span class="dv">10</span> <span class="kw">AS</span> a, a <span class="op">*</span> <span class="dv">2</span> <span class="kw">AS</span> b, b <span class="op">&lt;</span> <span class="dv">1000</span> <span class="kw">AS</span> cond <span class="kw">FROM</span> test;</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+------+</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>| a    | b    | cond |</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+------+</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">133</span> |  <span class="dv">266</span> |    <span class="dv">1</span> |</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+------+</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="writing-your-first-config">Writing your first config</h3>
<p>Using a config file and indexing an existing SQL database is also
actually rather simple. Of course, nothing beats the simplicity of “just
run <code>searchd</code>”, but we will literally need just 3 extra
commands using 2 bundled example files. Let’s step through that.</p>
<p>First step is the same, just download and extract Sphinx.</p>
<pre><code>$ wget -q https://sphinxsearch.com/files/sphinx-3.6.1-c9dbeda-linux-amd64.tar.gz
$ tar zxf sphinx-3.6.1-c9dbeda-linux-amd64.tar.gz
$ cd sphinx-3.6.1/</code></pre>
<p>Second step, populate a tiny test MySQL database from
<code>example.sql</code>, then run <code>indexer</code> to index that
database. (You should, of course, have MySQL or MariaDB server installed
at this point.)</p>
<pre><code>$ mysql -u test &lt; ./etc/example.sql
$ ./bin/indexer --config ./etc/sphinx-min.conf.dist --all
Sphinx 3.6.1 (commit c9dbedab)
Copyright (c) 2001-2023, Andrew Aksyonoff
Copyright (c) 2008-2016, Sphinx Technologies Inc (http://sphinxsearch.com)

using config file &#39;./etc/sphinx-min.conf.dist&#39;...
indexing index &#39;test1&#39;...
collected 4 docs, 0.0 MB
sorted 0.0 Mhits, 100.0% done
total 4 docs, 0.2 Kb
total 0.0 sec, 17.1 Kb/sec, 354 docs/sec
skipping non-plain index &#39;testrt&#39;...</code></pre>
<p>Third and final step is also the same, run <code>searchd</code> (now
with config!) and query it.</p>
<pre><code>$ ./bin/searchd --config ./etc/sphinx-min.conf.dist
Sphinx 3.6.1 (commit c9dbedab)
Copyright (c) 2001-2023, Andrew Aksyonoff
Copyright (c) 2008-2016, Sphinx Technologies Inc (http://sphinxsearch.com)

using config file &#39;./etc/sphinx-min.conf.dist&#39;...
listening on all interfaces, port=9312
listening on all interfaces, port=9306
loading 2 indexes...
loaded 2 indexes using 2 threads in 0.0 sec</code></pre>
<pre><code>$ mysql -h0 -P9306
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 1
Server version: 3.6.1 (commit c9dbedab)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.

mysql&gt; show tables;
+--------+-------+
| Index  | Type  |
+--------+-------+
| test1  | local |
| testrt | rt    |
+--------+-------+
2 rows in set (0.000 sec)

mysql&gt; select * from test1;
+------+----------+------------+
| id   | group_id | date_added |
+------+----------+------------+
|    1 |        1 | 1711019614 |
|    2 |        1 | 1711019614 |
|    3 |        2 | 1711019614 |
|    4 |        2 | 1711019614 |
+------+----------+------------+
4 rows in set (0.000 sec)</code></pre>
<p>What just happened? And why jump through all these extra hoops?</p>
<p>So examples before were all based on the <strong>config-less
mode</strong>, where <code>searchd</code> stores all the data and
settings in a <code>./sphinxdata</code> data folder, and you have to
manage everything via <code>searchd</code> itself. Neither
<code>indexer</code> nor any config file were really involved. That’s a
perfectly viable operational mode.</p>
<p>However, having a config file with a few general server-wide settings
still is convenient, even if you only use <code>searchd</code>. Also,
importing data with <code>indexer</code> <em>requires</em> a config
file. Time to cover that other operational mode.</p>
<p>But first, let’s briefly talk about that <code>./sphinxdata</code>
folder. More formally, <strong>Sphinx requires a datadir, ie. a folder
to store all its data and settings</strong>, and
<code>./sphinxdata</code> is just a default path for that. For a
detailed discussion, see <a href="#using-datadir">“Using datadir”</a>
section. For now, let’s just mention that a non-default datadir can be
set either from config, or from the command line.</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> searchd <span class="at">--datadir</span> /home/sphinx/sphinxdata</span></code></pre></div>
<p><strong>Config file location can be changed from the command line
too.</strong> The default location is <code>./sphinx.conf</code> but all
Sphinx programs take the <code>--config</code> switch.</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> indexer <span class="at">--config</span> /home/sphinx/etc/indexer.conf</span></code></pre></div>
<p><strong>Config file lets you control both global settings, and
individual indexes.</strong> Datadir path is a prominent global setting,
but just one of them, and there are <strong>many</strong> more.</p>
<p>For example, <code>max_children</code>, the server-wide worker
threads limit that helps prevent <code>searchd</code> from becoming
terminally overloaded. Or <code>auth_users</code>, the file with users
and their passwords hashes that <code>searchd</code> can use to impose
access restrictions. Or <code>mem_limit</code> that basically controls
how much RAM can <code>indexer</code> use for indexing. The complete
lists can be found in their respective sections.</p>
<ul>
<li><a href="#common-config-reference">Common config reference</a></li>
<li><a href="#indexer-config-reference"><code>indexer</code> config
reference</a></li>
<li><a href="#searchd-config-reference"><code>searchd</code> config
reference</a></li>
</ul>
<p><strong>Some settings can intentionally ONLY be enabled via
config.</strong> For instance, <code>auth_users</code> or
<code>json_float</code> <strong>MUST</strong> be configured that way. We
don’t plan to change those on the fly.</p>
<p>But perhaps even more importantly…</p>
<p><strong>Indexing pre-existing data with <code>indexer</code> requires
a config file</strong> that specifies the <strong>data sources</strong>
to get the raw data from, and sets up the target full-text index to put
the indexed data to. Let’s open <code>sphinx-min.conf.dist</code> and
see for ourselves.</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> src1</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span>        = mysql</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_host</span>    = localhost <span class="co"># for `sql_port` to work, use 127.0.0.1</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_user</span>    = test</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_pass</span>    =</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_db</span>      = test</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_port</span>    = 3306  <span class="co"># optional, default is 3306</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># use `example.sql` to populate `test.documents` table</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_query</span>   = SELECT id, group_id, UNIX_TIMESTAMP<span class="er">(</span><span class="ex">date_added</span><span class="kw">)</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>                  <span class="ex">AS</span> date_added, title, content FROM documents</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>This <strong>data source configuration</strong> tells
<code>indexer</code> what database to connect to, and what SQL query to
run. <strong>Arbitrary SQL queries can be used here</strong>, as Sphinx
does not limit that SQL anyhow. You can <code>JOIN</code> multiple
tables in your <code>SELECT</code>, or call stored procedures instead.
Anything works, as long as it talks SQL and returns some result set that
Sphinx can index. That covers the raw input data.</p>
<p><strong>Native database drivers</strong> currently exist for
<strong>MySQL, PostgreSQL, and ODBC</strong> (so MS SQL or Oracle or
anything else with an ODBC driver also works). Bit more on that in the
<a href="#indexing-data-sources">“Indexing: data sources”</a>
section.</p>
<p>Or you can pass your data to <code>indexer</code> in <strong>CSV,
TSV, or XML formats</strong>. Details in the (“Indexing: CSV and TSV
files”)[#indexing-csv-and-tsv-files] section.</p>
<p>Then the <strong>full-text index configuration</strong> tells
<code>indexer</code> what data sources to index, and what specific
settings to use. Index type and schema are mandatory. For the so-called
“plain” indexes that <code>indexer</code> works with, a list of data
sources is mandatory too. Let’s see.</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> test1</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span>        = plain</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">source</span>      = src1</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span>       = title, content</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span>   = group_id, date_added</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>That’s it. Now the <code>indexer</code> knows that to build an index
called <code>test1</code> it must take the input data from
<code>src1</code> source, index the 2 input columns as text fields
(<code>title</code> and <code>content</code>), store the 3 input columns
as attributes, and that’s it.</p>
<p>Not a typo, 3 (three) columns. There must <strong>always</strong> be
a unique document ID, so on top of the 2 explicit <code>group_id</code>
and <code>date_added</code> attributes, we always have another 1 called
<code>id</code>. We already saw it earlier.</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> test1;</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+------------+</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | <span class="fu">group_id</span> | date_added |</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+------------+</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> |        <span class="dv">1</span> | <span class="dv">1711019614</span> |</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> |        <span class="dv">1</span> | <span class="dv">1711019614</span> |</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> |        <span class="dv">2</span> | <span class="dv">1711019614</span> |</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">4</span> |        <span class="dv">2</span> | <span class="dv">1711019614</span> |</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+------------+</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.000</span> sec)</span></code></pre></div>
<p>Another important thing is <strong>the index type</strong>, that’s
the <code>type = plain</code> line in our example. Two base full-text
index types are the so-called <strong>RT indexes</strong> and
<strong>plain indexes</strong>, and <code>indexer</code> creates the
“plain” ones at the moment.</p>
<p><strong>Plain indexes are limited compared to “proper” RT
indexes</strong>, and the biggest difference is that <strong>you can’t
really modify any <em>full-text</em> data they store</strong>. You can
still run <code>UPDATE</code> and <code>DELETE</code> queries, even on
plain indexes. But you can <em>not</em> <code>INSERT</code> any new
full-text searchable data. However, when needed, you also “convert” a
plain index to an RT index with an <code>ATTACH</code> statement, and
then run <code>INSERT</code> queries on that.</p>
<p><strong>The only way to add rows to a plain index is to fully rebuild
it</strong> by running <code>indexer</code>, but fear not, existing
plain indexes served by <code>searchd</code> will <em>not</em> suddenly
stop working once you run <code>indexer</code>! It will create a
temporary shadow copy of the specified index(es), rebuild them offline,
and then sends a signal to <code>searchd</code> to pick up those newly
rebuilt shadow copies.</p>
<p><strong>Index schema is a list of index fields and
attributes.</strong> More details are in the (“Using index
schemas”)[#using-index-schemas] section.</p>
<p>Note how the MySQL query column order in <code>sql_query</code> and
the index schema order are different, and how
<code>UNIX_TIMESTAMP(date_added)</code> was aliased. That’s because
<strong>source columns are bound to index schema by name</strong>, and
the names must match. Sometimes you can configure Sphinx index columns
to perfectly match SQL table columns, and then the simplest
<code>sql_query = SELECT * ...</code> works, but usually it’s easier to
alias <code>sql_query</code> columns as needed for Sphinx.</p>
<p><strong>The very first <code>sql_query</code> must be the document
ID. Its name gets ignored.</strong> That’s the only exception from the
“names must match” rule.</p>
<p>Also, <strong>document IDs must be unique 64-bit signed
integers.</strong> For the record, Sphinx does not <em>need</em> those
IDs itself, they really are for <em>you</em> to uniquely identify the
rows stored in Sphinx, and (optionally) to cross-reference them with
your other databases. That works well for most applications: one usually
does have a PK, and that PK is frequently an <code>INT</code> or
<code>BIGINT</code> anyway! When your existing IDs do not easily convert
to integer (eg. GUIDs), you can hash them or generate sequences in your
<code>sql_query</code> and generate Sphinx-only IDs that way. Just make
sure they’re unique.</p>
<p>As a side note, in early 2024 MySQL still does not seem to support
sequences. See how that works in PostgreSQL. (In MySQL you could
probably emulate that with counter variables or recursive CTEs.)</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>postgres<span class="op">=</span># <span class="kw">CREATE</span> <span class="kw">TEMPORARY</span> <span class="kw">SEQUENCE</span> testseq <span class="kw">START</span> <span class="dv">123</span>;</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">SEQUENCE</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>postgres<span class="op">=</span># <span class="kw">SELECT</span> NEXTVAL(<span class="st">&#39;testseq&#39;</span>), <span class="op">*</span> <span class="kw">FROM</span> test;</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a> nextval |       title</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">---------+--------------------</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>     <span class="dv">123</span> | hello world</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>     <span class="dv">124</span> | document two</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>     <span class="dv">125</span> | third <span class="dt">time</span> a charm</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>(<span class="dv">3</span> <span class="kw">rows</span>)</span></code></pre></div>
<p>The ideal place for that <code>CREATE SEQUENCE</code> statement would
be <code>sql_query_pre</code> and that segues us into config settings
(we tend to call them <strong>directives</strong> in Sphinx). Well,
there are quite a few, and they are useful.</p>
<p>See <a href="#source-config-reference">“Source config reference”</a>
for all the source level ones. Sources are basically all about getting
the input data. So their directives let you flexibly configure all that
jazz (SQL access, SQL queries, CSV headers, etc).</p>
<p>See <a href="#index-config-reference">“Index config reference</a> for
all the index level directives. They are more diverse, but <strong>text
processing directives</strong> are worth a quick early mention here.</p>
<p><strong>Sphinx has a lot of settings that control full-text indexing
and searching.</strong> Flexible tokenization, morphology, mappings,
annotations, mixed codes, tunable HTML stripping, in-field zones, we got
all that and more.</p>
<p>Eventually, there must be a special nice chapter <em>explaining</em>
all that. Alas, right now, there isn’t. But some of the features are
already covered in their respective sections.</p>
<ul>
<li><a href="#using-annotations">Using annotations</a>, short “phrases”
all stored into one text field that can be matched and ranked
individually</li>
<li><a href="#using-mappings">Using mappings</a>, text processing stage
that lets you map keywords to keywords (either 1:1 or M:N, either before
or after morphology)</li>
<li><a href="#using-morphdict">Using morphdict</a>, custom 1:1 overrides
for morphology (stemming or lemmatization) processors</li>
<li><a
href="#indexing-special-chars-blended-tokens-and-mixed-codes">Special
chars, blending tokens, and mixed codes</a>: tools for processing magic
tokens like <code>C++</code>, or <code>@elonmusk</code>, or
<code>QN65S95DAFXZ</code></li>
</ul>
<p>And, of course, <em>all</em> the directives are always
<em>documented</em> in the index config reference.</p>
<p>To wrap up dissecting our example <code>sphinx-min.conf.dist</code>
config, let’s look at its last few lines.</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> testrt</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span>        = rt</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span>       = title, content</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span>   = gid</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p><strong>Config file also lets you create RT indexes. ONCE.</strong>
That <code>index testrt</code> section is <em>completely</em> equivalent
to this statement.</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> testrt</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">id</span> bigint, title field, content field, uint)</span></code></pre></div>
<p>Note that the <strong>RT index definition from the config only
applies ONCE</strong>, when you (re)start <code>searchd</code> with that
new definition for the very first time. It is <strong>not
enough</strong> to simply change the config definition in the config,
<code>searchd</code> will <strong>not</strong> automatically apply those
changes. Instead, it will warn about the differences. For example, if we
change the attrs to <code>attr_uint = gid, gid2</code> and restart, we
get this warning.</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ./bin/searchd <span class="at">-c</span> ./etc/sphinx-min.conf.dist</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="ex">WARNING:</span> index <span class="st">&#39;testrt&#39;</span>: attribute count mismatch <span class="er">(</span><span class="ex">3</span> in config, 2 in header<span class="kw">);</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="ex">EXISTING</span> INDEX TAKES PRECEDENCE</span></code></pre></div>
<p>And the schema stays unchanged.</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">desc</span> testrt;</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+--------+------------+------+</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>| Field   | <span class="kw">Type</span>   | Properties | <span class="kw">Key</span>  |</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+--------+------------+------+</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>      | bigint |            |      |</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>| title   | field  | <span class="kw">indexed</span>    |      |</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>| content | field  | <span class="kw">indexed</span>    |      |</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>| gid     | uint   |            |      |</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+--------+------------+------+</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>To add the new column, we need to either recreate that index, or use
the <code>ALTER</code> statement.</p>
<p>So what’s better for RT indexes, <code>sphinx.conf</code> definitions
or <code>CREATE TABLE</code> statements? Both approaches are now viable.
(Historically, <code>CREATE TABLE</code> did not support <em>all</em>
the directives that configs files did, but today it supports almost
everything.) So we have <strong>two different schema management
approaches</strong>, with their own pros and contras. Pick one to your
own taste, or even use both approaches for different indexes. Whatever
works best!</p>
<h3 id="running-queries-from-php-python-etc">Running queries from PHP,
Python, etc</h3>
<div class="sourceCode" id="cb30"><pre
class="sourceCode php"><code class="sourceCode php"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;?php</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="va">$conn</span> <span class="op">=</span> <span class="fu">mysqli_connect</span>(<span class="st">&quot;127.0.0.1:9306&quot;</span><span class="ot">,</span> <span class="st">&quot;&quot;</span><span class="ot">,</span> <span class="st">&quot;&quot;</span><span class="ot">,</span> <span class="st">&quot;&quot;</span>)<span class="ot">;</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">mysqli_connect_errno</span>())</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">die</span>(<span class="st">&quot;failed to connect to Sphinx: &quot;</span> <span class="op">.</span> <span class="fu">mysqli_connect_error</span>())<span class="ot">;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="va">$res</span> <span class="op">=</span> <span class="fu">mysqli_query</span>(<span class="va">$conn</span><span class="ot">,</span> <span class="st">&quot;SHOW VARIABLES&quot;</span>)<span class="ot">;</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (<span class="va">$row</span> <span class="op">=</span> <span class="fu">mysqli_fetch_row</span>(<span class="va">$res</span>))</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">print</span> <span class="st">&quot;</span><span class="va">$row</span>[<span class="dv">0</span>]<span class="st">: </span><span class="va">$row</span>[<span class="dv">1</span>]<span class="sc">\n</span><span class="st">&quot;</span><span class="ot">;</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymysql</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>conn <span class="op">=</span> pymysql.<span class="ex">connect</span>(host<span class="op">=</span><span class="st">&quot;127.0.0.1&quot;</span>, port<span class="op">=</span><span class="dv">9306</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>cur <span class="op">=</span> conn.cursor()</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>cur.execute(<span class="st">&quot;SHOW VARIABLES&quot;</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> cur.fetchall()</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> rows:</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(row)</span></code></pre></div>
<p>TODO: examples!</p>
<h3 id="installing-sql-drivers">Installing SQL drivers</h3>
<p>This only affects <code>indexer</code> ETL tool only. If you never
ever bulk load data from SQL sources that may require drivers, you can
safely skip this section. (Also, if you are on Windows, then all the
drivers are bundled, so also skip.)</p>
<p>Depending on your OS, the required package names may vary. Here are
some current (as of Mar 2018) package names for Ubuntu and CentOS:</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ubuntu$</span> apt-get install libmysqlclient-dev libpq-dev unixodbc-dev</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ubuntu$</span> apt-get install libmariadb-client-lgpl-dev-compat</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="ex">centos$</span> yum install mariadb-devel postgresql-devel unixODBC-devel</span></code></pre></div>
<p>Why might these be needed, and how they work?</p>
<p><code>indexer</code> natively supports MySQL (and MariaDB, and
anything else wire-protocol compatible), PostgreSQL, and UnixODBC
drivers. Meaning it can natively connect to those databases, run SQL
queries, extract results, and create full-text indexes from that. Sphinx
binaries now always come with that <em>support</em> enabled.</p>
<p>However, you still need to have a specific driver <em>library</em>
installed on your system, so that <code>indexer</code> could dynamically
load it, and access the database. Depending on the specific database and
OS you use, the package names might be different, as you can see just
above.</p>
<p>The driver libraries are loaded by name. The following names are
tried:</p>
<ul>
<li>MySQL: <code>libmysqlclient.so</code> and
<code>libmariadb.so</code></li>
<li>PostgreSQL: <code>libpq.so</code></li>
<li>ODBC: <code>libodbc.so</code></li>
</ul>
<p>To support MacOS, <code>.dylib</code> extension (in addition to
<code>.so</code>) is also tried.</p>
<p>Last but not least, if a specific package that you use on your
specific OS fails to properly install a driver, you might need to create
a link manually.</p>
<p>For instance, we have seen a package install
<code>libmysqlclient.so.19</code> alright, but fail to create a generic
<code>libmysqlclient.so</code> link for whatever reason. Sphinx could
not find that, because that extra <code>.19</code> is an internal
<em>driver</em> version, specific (and known) only to the driver, not
us! A mere <code>libmysqlclient.so</code> symlink fixed that.
Fortunately, most packages create the link themselves.</p>
<h2 id="main-concepts">Main concepts</h2>
<p>Alas, many projects tend to reinvent their own dictionary, and Sphinx
is no exception. Sometimes that probably creates confusion for no
apparent reason. For one, what SQL guys call “tables” (or even
“relations” if they are old enough to remember Edgar Codd), and MongoDB
guys call “collections”, we the text search guys tend to call “indexes”,
and not really out of mischief and malice either, but just because for
us, those things <em>are</em> primarily FT (full-text) indexes.
Thankfully, most of the concepts are close enough, so our personal
little Sphinx dictionary is tiny. Let’s see.</p>
<p>Short cheat sheet!</p>
<table>
<thead>
<tr class="header">
<th>Sphinx</th>
<th>Closest SQL equivalent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Index</td>
<td>Table</td>
</tr>
<tr class="even">
<td>Index type</td>
<td>Storage and/or query engine</td>
</tr>
<tr class="odd">
<td>Document</td>
<td>Row</td>
</tr>
<tr class="even">
<td>Field or attribute</td>
<td>Column and/or a full-text index</td>
</tr>
<tr class="odd">
<td>Indexed field</td>
<td><em>Just</em> a full-text index on a text column</td>
</tr>
<tr class="even">
<td>Stored field</td>
<td>Text column <em>and</em> a full-text index on it</td>
</tr>
<tr class="odd">
<td>Attribute</td>
<td>Column</td>
</tr>
<tr class="even">
<td>MVA</td>
<td>Column with an INT_SET type</td>
</tr>
<tr class="odd">
<td>JSON attribute</td>
<td>Column with a JSON type</td>
</tr>
<tr class="even">
<td>Attribute index</td>
<td>Index</td>
</tr>
<tr class="odd">
<td>Document ID, docid</td>
<td>Column called “id”, with a BIGINT type</td>
</tr>
<tr class="even">
<td>Row ID, rowid</td>
<td>Internal Sphinx row number</td>
</tr>
<tr class="odd">
<td>Schema</td>
<td>A list of columns</td>
</tr>
</tbody>
</table>
<p>And now for a little more elaborate explanation.</p>
<h3 id="indexes">Indexes</h3>
<p>Sphinx <strong>indexes</strong> are semi-structured collections of
documents. They may seem closer to SQL tables than to Mongo collections,
but in their core, they really are neither. The primary, foundational
data structure is a <strong>full-text index</strong>. The specific type
we use is an <strong>inverted index</strong>, a special data structure
that lets us respond very quickly to a query like “give me the
(internal) identifiers of all the documents that mention This or That
keyword”. Everything else that Sphinx provides (extra attributes,
document storage, various secondary indexes, our SphinxQL querying
dialect, and so on) is, in a certain sense, an addition on top of that
base data structure. Hence the “index” name.</p>
<p>Schema-wise, Sphinx indexes try to combine the best of schemaful and
schemaless worlds. For “columns” where you know the type upfront, you
can use the statically typed attributes, and get the absolute
efficiency. For more dynamic data, you can put it all into a JSON
attribute, and still get quite decent performance.</p>
<p>So in a sense, Sphinx indexes == SQL tables, except (a) full-text
searches are fast and come with a lot of full-text-search specific
tweaking options; (b) JSON “columns” (attributes) are quite natively
supported, so you can go schemaless; and (c) for full-text indexed
fields, you can choose to store <em>just</em> the full-text index and
ditch the original values.</p>
<p>Last but not least, there are multiple <strong>index types</strong>
that we discuss below.</p>
<h3 id="documents">Documents</h3>
<p>Documents are essentially just a list of named text fields, and
arbitrary-typed attributes. Quite similar to SQL rows; almost
indistinguishable, actually.</p>
<p>As of v.3.0.1, Sphinx still requires a unique <code>id</code>
attribute, and implicitly injects an <code>id BIGINT</code> column into
indexes (as you probably noticed in the <a
href="#getting-started">Getting started</a> section). We still use those
docids to identify specific rows in <code>DELETE</code> and other
statements. However, unlike in v.2.x, we no longer use docids to
identify documents internally. Thus, zero and negative docids are
already allowed.</p>
<h3 id="fields">Fields</h3>
<p>Fields are the texts that Sphinx indexes and makes
keyword-searchable. They always are <em>indexed</em>, as in full-text
indexed. Their original, unindexed contents can also be <em>stored</em>
into the index for later retrieval. By default, they are not, and Sphinx
is going to return attributes only, and <em>not</em> the contents.
However, if you explicitly mark them as stored (either with a
<code>stored</code> flag in <code>CREATE TABLE</code> or in the ETL
config file using <code>stored_fields</code> directive), you can also
fetch the fields back:</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">CREATE</span> <span class="kw">TABLE</span> test1 (title field);</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> test1 <span class="kw">VALUES</span> (<span class="dv">123</span>, <span class="st">&#39;hello&#39;</span>);</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test1 <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello&#39;</span>);</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   |</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> |</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">CREATE</span> <span class="kw">TABLE</span> test2 (title field stored);</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> test2 <span class="kw">VALUES</span> (<span class="dv">123</span>, <span class="st">&#39;hello&#39;</span>);</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test2 <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello&#39;</span>);</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | title |</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | hello |</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Stored fields contents are stored in a special index component called
document storage, or DocStore for short.</p>
<h3 id="attributes">Attributes</h3>
<p>Sphinx supports the following attribute types:</p>
<ul>
<li>UINT, unsigned 32-bit integer</li>
<li>UINT:N, unsigned N-bit integer (where 1 &lt;= N &lt;= 31)</li>
<li>BIGINT, signed 64-bit integer</li>
<li>FLOAT, 32-bit (single precision) floating point</li>
<li>BOOL, 1-bit boolean</li>
<li>STRING, a text string</li>
<li>BLOB, a binary string</li>
<li>JSON, a JSON document</li>
<li>UINT_SET aka MVA, an order-insensitive set of unique UINTs</li>
<li>BIGINT_SET aka MVA64, an order-insensitive set of unique
BIGINTs</li>
<li>INT_ARRAY, fixed-width array of signed 32-bit integers</li>
<li>INT8_ARRAY, fixed-width array of signed 8-bit integers</li>
<li>FLOAT_ARRAY, fixed-width array of 32-bit floats</li>
</ul>
<p>All of these are pretty common and straightforward. We assume that we
don’t have to explain what a “string” or a “float” is!</p>
<p>Storage is also pretty straightforward. Here’s a 15-second overview:
attribute storage is row-based; rows are split as a fixed-width and a
variable-width part (more on that below); all columns are stored “as is”
with minimal (often zero) overheads.</p>
<p>For example, 3 attributes with <code>UINT</code>,
<code>BIGINT</code>, and <code>FLOAT_ARRAY[3]</code> types are going to
be stored using 24 bytes per row total (4+8+12 bytes respectively). Zero
overheads, and easy to esimate.</p>
<p>Booleans and bitfields are a bit special. For performance reasons,
Sphinx rows are padded and aligned to 4 bytes. And all bitfields are
allocated within these 4-byte chunks too. So size-estimates-wise, your
1st boolean attribute actually adds 4 bytes to each row, not just 1 bit.
However, the next 31 boolean flags after that add nothing! If you
configure 32 boolean flags, they all get nicely packed into that 4-byte
chunk.</p>
<p>Also, JSON storage is automatically optimized. Sphinx uses an
efficient binary format internally (think “SphinxBSON”), and
storage-wise, here are the biggest things.</p>
<ul>
<li>All scalar values (integers, floats, doubles) are converted and
internally stored natively.</li>
<li>All scalar value <em>arrays</em> are detected and also internally
stored natively.</li>
<li>Unlike JSON spec, Sphinx defaults to 32-bit floats
(cf. <code>json_float</code>).</li>
<li>Even with non-default <code>json_float = double</code>, you can use
<code>123.45f</code> syntax extension and store compact 32-bit
floats.</li>
<li>All keys, however, are currently stored as is (so their length
matters).</li>
</ul>
<p>For example, when the following document is stored into a JSON column
in Sphinx:</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;title&quot;</span><span class="fu">:</span><span class="st">&quot;test&quot;</span><span class="fu">,</span> <span class="dt">&quot;year&quot;</span><span class="fu">:</span><span class="dv">2017</span><span class="fu">,</span> <span class="dt">&quot;tags&quot;</span><span class="fu">:</span><span class="ot">[</span><span class="dv">13</span><span class="ot">,</span><span class="dv">8</span><span class="ot">,</span><span class="dv">5</span><span class="ot">,</span><span class="dv">1</span><span class="ot">,</span><span class="dv">2</span><span class="ot">,</span><span class="dv">3</span><span class="ot">]</span><span class="fu">}</span></span></code></pre></div>
<p>Sphinx detects that the “tags” array consists of integers only, and
stores the array data using 24 bytes exactly, using just 4 bytes per
each of the 6 values. Of course, there still are the overheads of
storing the JSON keys, and the general document structure, so the
<em>entire</em> document will take more than that. Still, when it comes
to storing bulk data into Sphinx index for later use, just provide a
consistently typed JSON array, and that data will be stored - and
processed! - with maximum efficiency.</p>
<p>Attributes are supposed to fit into RAM, and Sphinx is optimized
towards that case. Ideally, of course, all your index data should fit
into RAM, while being backed by a fast enough SSD for persistence.</p>
<p>Now, there are <em>fixed-width</em> and <em>variable-width</em>
attributes among the supported types. Naturally, scalars like
<code>UINT</code> and <code>FLOAT</code> will always occupy exactly 4
bytes each, while <code>STRING</code> and <code>JSON</code> types can be
as short as, well, empty; or as long as several megabytes. How does that
work internally? Or in other words, why don’t I just save everything as
JSON?</p>
<p>The answer is performance. Internally, Sphinx has two separate
storages for those row parts. Fixed-width attributes, including hidden
system ones, are essentially stored in big static NxM matrix, where N is
the number of rows, and M is the number of fixed-width attributes. Any
accesses to those are very quick. All the variable-width attributes for
a single row are grouped together, and stored in a separate storage. A
single offset into that second storage (or “vrow” storage, short for
“variable-width row part” storage) is stored as hidden fixed-width
attribute. Thus, as you see, accessing a string or a JSON or an MVA
value, let alone a JSON key, is somewhat more complicated. For example,
to access that <code>year</code> JSON key from the example just above,
Sphinx would need to:</p>
<ul>
<li>read <code>vrow_offset</code> from a hidden attribute</li>
<li>access the vrow part using that offset</li>
<li>decode the vrow, and find the needed JSON attribute start</li>
<li>decode the JSON, and find the <code>year</code> key start</li>
<li>check the key type, just in case it needs conversion to integer</li>
<li>finally, read the <code>year</code> value</li>
</ul>
<p>Of course, optimizations are done on every step here, but still, if
you access a <em>lot</em> of those values (for sorting or filtering the
query results), there will be a performance impact. Also, the deeper the
key is buried into that JSON, the worse. For example, using a tiny test
with 1,000,000 rows and just 4 integer attributes plus exactly the same
4 values stored in a JSON, computing a sum yields the following:</p>
<table>
<thead>
<tr class="header">
<th>Attribute</th>
<th>Time</th>
<th>Slowdown</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Any UINT</td>
<td>0.032 sec</td>
<td>-</td>
</tr>
<tr class="even">
<td>1st JSON key</td>
<td>0.045 sec</td>
<td>1.4x</td>
</tr>
<tr class="odd">
<td>2nd JSON key</td>
<td>0.052 sec</td>
<td>1.6x</td>
</tr>
<tr class="even">
<td>3rd JSON key</td>
<td>0.059 sec</td>
<td>1.8x</td>
</tr>
<tr class="odd">
<td>4th JSON key</td>
<td>0.065 sec</td>
<td>2.0x</td>
</tr>
</tbody>
</table>
<p>And with more attributes it would eventually slowdown even worse than
2x times, especially if we also throw in more complicated attributes,
like strings or nested objects.</p>
<p>So bottom line, why not JSON everything? As long as your queries only
touch a handful of rows each, that is fine, actually! However, if you
have a <em>lot</em> of data, you should try to identify some of the
“busiest” columns for your queries, and store them as “regular” typed
columns, that somewhat improves performance.</p>
<h3 id="schemas">Schemas</h3>
<p><strong>Schema is an (ordered) list of columns (fields and
attributes).</strong> Sounds easy. Except that “column lists” quite
naturally turn up in quite a number of places, and in every specific
place, there just might be a few specific quirks.</p>
<p><strong>There usually are multiple different schemas at
play.</strong> Even “within” a single index or query!</p>
<p>Obviously, there always has to be some <strong>index schema</strong>,
the one that defines all the index fields and attributes. Or in other
words, it defines the structure of the indexed documents, so calling it
<strong>(index) document schema</strong> would also be okay.</p>
<p>Most SELECTs need to grab a custom list of columns and/or
expressions, so then there always is a <strong>result set
schema</strong> with that. And, coming from the query, it differs from
the index schema.</p>
<p>As a side note for the really curious <em>and</em> also for ourselves
the developers, internally there very frequently is yet another
intermediate “sorter” schema, which differs again. For example, consider
an <code>AVG(col)</code> expression. The index schema does not even have
that. The final result set schema must only return one (float) value.
But we have to store two values (the sum and the row counter) while
<em>processing</em> the rows. The intermediate schemas take care of
differences like that.</p>
<p>Back to user facing queries, INSERTs can also take an explicit list
of columns, and guess what, that is an <strong>insert schema</strong>
right there.</p>
<p>Thankfully, as engine users we mostly only need to care about the
index schemas. We discuss those in detail just below.</p>
<h3 id="index-types">Index types</h3>
<p>Sphinx supports several so-called <strong>index types</strong> as
needed for different operational scenarios. In engineer speak, they are
different storage and/or query backends. Here’s the list.</p>
<ul>
<li>the primary <code>rt</code> type, our main local physical storage
backend;</li>
<li>the legacy-but-default <code>plain</code> type, still useful for
offline rebuilds;</li>
<li>the networked <code>distributed</code> type, which federates cluster
search results;</li>
<li>the percolating <code>pq</code> type, which reverse-matches
documents against queries;</li>
<li>the limited <code>template</code> type, for common settings
reuse.</li>
</ul>
<p>The specific type must be set with the <a
href="#index-type-directive"><code>type</code></a> config directive. <a
href="#create-table-syntax"><code>CREATE TABLE</code></a> currently
creates RT indexes only (though we vaguely plan to add support for
distributed and PQ indexes).</p>
<p>Here’s a very slightly less brief summary of the types.</p>
<ul>
<li><p><strong>RT index.</strong> Local physical index. Fully supports
online writes (<code>INSERT</code> and <code>REPLACE</code> and
<code>UPDATE</code> and <code>DELETE</code>).</p></li>
<li><p><strong>Plain index.</strong> Local physical index. Must be built
offline with <code>indexer</code>; only supports limited online writes
(namely <code>UPDATE</code> and <code>DELETE</code>); can be “converted”
or “appended” to RT index using the <code>ATTACH</code>
statement.</p></li>
<li><p><strong>Distributed index.</strong> Virtual config-only index,
essentially a list of other indexes, either local or remote. Supports
reads properly (aggregates the results, does network retries, mirror
selection, etc). But does not really support writes.</p></li>
<li><p><strong>PQ index</strong>. Local physical index, for special
“reverse” searches, aka percolate queries. Always has a hardcoded
<code>bigint id, string query</code> schema. Supports basic reads and
writes on its contents (aka the stored queries). Supports special
<code>WHERE PQMATCH()</code> clause.</p></li>
<li><p><strong>Template index</strong>. Virtual config-only index,
essentially a set of indexing settings. Mostly intended to simplify
config management by inheriting other indexes from templates. However,
also supports a few special reads queries that only require settings and
no index data, such as <code>CALL KEYWORDS</code> statement.</p></li>
</ul>
<p>What are all these for, then?!</p>
<p>In most scenarios, <strong>a local “RT” index
(<code>type = rt</code>) is the default choice</strong>. Because RT
indexes are the ones most similar to regular SQL tables. With those, you
can do almost everything online.</p>
<p>Historically, a local plain index (aka <code>type = plain</code>) was
there first, though. And plain indexes are also similar to regular SQL
tables, but more limited. They do not fully support writes (no INSERTs).
Not the default choice!</p>
<p>However, <strong>“plain” indexes are still quite useful for “rebuild
from scratch”</strong> scenarios. Because an index config for
<code>indexer</code> with just a few SQL queries for your “source”
database (or a few shell commands that produce CSV/TSV/XML, maybe) is
usually both somewhat easier to make <strong>and</strong> performs
better than any custom code that’d read from the source database and
<code>INSERT</code> into Sphinx RT indexes.</p>
<p>Now, <strong>when one server is just not enough, you need
“distributed” indexes</strong>, which basically <strong>aggregate
<code>SELECT</code> results from several nodes</strong>. In SQL speak,
Sphinx distributed indexes let you easily implement federated
<code>SELECT</code> queries. They can also do retries, balancing, and a
bit more.</p>
<p>However, <strong>distributed indexes do not support writes!</strong>
Yes, they can federate reads (aka <code>SELECT</code> queries) from
machine A and machine B alright. But no, they do not support writes (aka
<code>INSERT</code> queries). Basically because “distributed” indexes
are too dumb, and do not even “know” where to properly store the
data.</p>
<p>Still, they’re a super-useful building block for both shards
<em>and</em> replicas, but they require a little bit of manual work.</p>
<p>Coming up next, <strong>“percolate” indexes to support “reverse”
searches</strong>, meaning that you use them to match incoming documents
against stored queries instead. See <a
href="#searching-percolate-queries">“Searching: percolate queries”</a>
section.</p>
<p>And last but not least, <strong>“template” indexes are for config
settings reuse</strong>. For instance, tokenization settings are often
identical across all the indexes, and it makes sense to declare them
once, then reuse. Of course, index settings inheritance could also work,
but that’s clumsy. Hence the template indexes that are essentially
nothing more than common settings holders.</p>
<h2 id="using-index-schemas">Using index schemas</h2>
<p>Just like SQL tables must have at least <em>some</em> columns in
them, Sphinx indexes <em>must</em> have at least 1 full-text indexed
field declared by you, the user. Also, there <em>must</em> be at least 1
attribute called <code>id</code> with the document ID. That one does not
need to be declared, as the system adds it automatically. So the most
basic “table” (aka index) <strong>always has at least two “columns” in
Sphinx</strong>: the system <code>id</code>, and the mandatory user
field. For example, <code>id</code> and <code>title</code>, or however
else you name your field.</p>
<p>Of course, <strong>you can define somewhat more fields and attributes
than that!</strong> For a running example, one still on the simple side,
let’s say that we want just a couple of fields, called
<code>title</code> and <code>content</code>, and a few more attributes,
say <code>user_id</code>, <code>thread_id</code>, and
<code>post_ts</code> (hmm, looks like forum messages).</p>
<p>Now, this set of fields and attributes is called a
<strong>schema</strong> and it affects a number of not unimportant
things. What columns does <code>indexer</code> expect from its data
sources? What’s the default column order as returned by
<code>SELECT</code> queries? What’s the order expected by
<code>INSERT</code> queries without an explicit column list? And so
on.</p>
<p>So this section discusses everything about the schemas. How exactly
to define them, examine them, change them, and whatnot. And, rather
importantly, what are the Sphinx-specific quirks.</p>
<h3 id="schemas-index-config">Schemas: index config</h3>
<p><strong>All fields and attributes must be declared upfront</strong>
for both plain and RT indexes in their configs. <strong>Fields go
first</strong> (using <code>field</code> or <code>field_string</code>
directives), and <strong>attributes go next</strong> (using
<code>attr_xxx</code> directives, where <code>xxx</code> picks a proper
type). Like so.</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> ex1</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = plain</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = title, content</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_bigint</span> = user_id, thread_id</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span> = post_ts</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p><strong>Sphinx automatically enforces the document ID
column.</strong> The type is <code>BIGINT</code>, the values must be
unique, and the column always is the very first one. Ah, and
<code>id</code> is the only attribute that does not ever have to be
explicitly declared.</p>
<p>That summarizes to <strong>“ID leads, then fields first, then
attributes next”</strong> as our general rule of thumb for column order.
Sphinx enforces that rule everywhere where some kind of a
<em>default</em> column order is needed.</p>
<p>The “ID/fields/attributes” rule affects the config declaration order
too. Simply to keep what you put in the config in sync with what you get
from <code>SELECT</code> and <code>INSERT</code> queries (at least by
default).</p>
<p><strong>Here’s the list of specific <code>attr_xxx</code>
types.</strong> Or, you can also refer to the <a
href="#index-config-reference">“Index config reference”</a> section.
(Spoiler: that list is checked automatically; this one is checked
manually.)</p>
<table>
<thead>
<tr class="header">
<th>Directive</th>
<th>Type description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>attr_bigint</code></td>
<td>signed 64-bit integer</td>
</tr>
<tr class="even">
<td><code>attr_bigint_set</code></td>
<td>a sorted set of signed 64-bit integers</td>
</tr>
<tr class="odd">
<td><code>attr_blob</code></td>
<td>binary blob (embedded zeroes allowed)</td>
</tr>
<tr class="even">
<td><code>attr_bool</code></td>
<td>1-bit boolean value, 1 or 0</td>
</tr>
<tr class="odd">
<td><code>attr_float</code></td>
<td>32-bit float</td>
</tr>
<tr class="even">
<td><code>attr_float_array</code></td>
<td>an array of 32-bit floats</td>
</tr>
<tr class="odd">
<td><code>attr_int_array</code></td>
<td>an array of 32-bit signed integers</td>
</tr>
<tr class="even">
<td><code>attr_int8_array</code></td>
<td>an array of 8-bit signed integers</td>
</tr>
<tr class="odd">
<td><code>attr_json</code></td>
<td>JSON object</td>
</tr>
<tr class="even">
<td><code>attr_string</code></td>
<td>text string (zero terminated)</td>
</tr>
<tr class="odd">
<td><code>attr_uint</code></td>
<td>unsigned 32-bit integer</td>
</tr>
<tr class="even">
<td><code>attr_uint_set</code></td>
<td>a sorted set of signed 32-bit integers</td>
</tr>
</tbody>
</table>
<p><strong>For array types, you must also declare the array
dimensions.</strong> You specify those just after the column name, like
so.</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_float_array</span> = vec1[3], vec2[5]</span></code></pre></div>
<p><strong>You can use either lists, or individual entries</strong> with
those directives. The following one-column-per-line variation works
identically fine.</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> ex1a</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = rt</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = title</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = content</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_bigint</span> = user_id</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_bigint</span> = thread_id</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span> = post_ts</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p><strong>The resulting index schema order must match the config
order.</strong> Meaning that the default <code>DESCRIBE</code> and
<code>SELECT</code> columns order should <strong>exactly</strong> match
your config declaration. Let’s check and see!</p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">desc</span> ex1a;</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+--------+------------+------+</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>| Field     | <span class="kw">Type</span>   | Properties | <span class="kw">Key</span>  |</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+--------+------------+------+</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>        | bigint |            |      |</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>| title     | field  | <span class="kw">indexed</span>    |      |</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>| content   | field  | <span class="kw">indexed</span>    |      |</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>| user_id   | bigint |            |      |</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>| thread_id | bigint |            |      |</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>| post_ts   | uint   |            |      |</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+--------+------------+------+</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="dv">6</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">insert</span> <span class="kw">into</span> ex1a <span class="kw">values</span> (<span class="dv">123</span>, <span class="st">&#39;hello world&#39;</span>,</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="st">&#39;some content&#39;</span>, <span class="dv">456</span>, <span class="dv">789</span>, <span class="dv">1234567890</span>);</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> ex1a <span class="kw">where</span> match(<span class="st">&#39;@title hello&#39;</span>);</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------+-----------+------------+</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | user_id | thread_id | post_ts    |</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------+-----------+------------+</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> |     <span class="dv">456</span> |       <span class="dv">789</span> | <span class="dv">1234567890</span> |</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------+-----------+------------+</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p><strong>Fields from <code>field_string</code> are “auto-copied” as
string attributes</strong> that have the same names as the original
fields. As for the order, the copied attributes columns sit between the
fields and the “regular” explicitly declared attributes. For instance,
what if we declare <code>title</code> using
<code>field_string</code>?</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> ex1b</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = rt</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field_string</span> = title</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = content</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_bigint</span> = user_id</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_bigint</span> = thread_id</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span> = post_ts</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>Compared to <code>ex1a</code> we would expect a single extra string
attribute just <em>before</em> <code>user_id</code> and that is indeed
what we get.</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">desc</span> ex1b;</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+--------+------------+------+</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>| Field     | <span class="kw">Type</span>   | Properties | <span class="kw">Key</span>  |</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+--------+------------+------+</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>        | bigint |            |      |</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>| title     | field  | <span class="kw">indexed</span>    |      |</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>| content   | field  | <span class="kw">indexed</span>    |      |</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>| title     | string |            |      |</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>| user_id   | bigint |            |      |</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>| thread_id | bigint |            |      |</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>| post_ts   | uint   |            |      |</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+--------+------------+------+</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="dv">7</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>This kinda reiterates our <strong>“fields first, attributes
next”</strong> rule of thumb. Fields go first, attributes go next, and
even in the attributes list, fields copies go first again. Which brings
us to the next order of business.</p>
<p><strong>Column names must be unique, across both fields and
attributes.</strong> Attempts to <em>explicitly</em> use the same name
twice for a field and an attribute must now fail.</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> ex1c</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = rt</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field_string</span> = title</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = content</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_bigint</span> = user_id</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_bigint</span> = thread_id</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span> = post_ts</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_string</span> = title <span class="co"># &lt;== THE OFFENDER</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>That fails with the
<code>duplicate attribute name 'title'; NOT SERVING</code> message,
because we attempt to <em>explicitly</em> redeclare <code>title</code>
here. The proper way is to use <code>field_string</code> directive
instead.</p>
<p><strong>Schemas either inherit fully, or reset completely.</strong>
Meaning, when the index settings are inherited from a parent index (as
in <code>index child : index base</code>), the parent schema initially
gets inherited too. However, if the child index then uses any of the
fields or attributes directives, the parent schema is discarded
immediately and completely, and only the new directives take effect. So
you must either inherit and use the parent index schema unchanged, or
fully define a new one from scratch. Somehow “extending” the parent
schema is not (yet) allowed.</p>
<p>Last but not least, <strong>config column order controls the
(default) query order</strong>, more on that below.</p>
<h3 id="schemas-create-table">Schemas: CREATE TABLE</h3>
<p><strong>Columns in CREATE TABLE must also follow the id/fields/attrs
rule.</strong> You must specify a leading <code>id BIGINT</code> at all
times, and then at least one field. Then any other fields and attributes
can follow. Our running example translates to SQL as follows.</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> ex1d (</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> BIGINT,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    title FIELD_STRING,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    content FIELD,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    user_id BIGINT,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    thread_id BIGINT,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    post_ts UINT);</span></code></pre></div>
<p>The resulting <code>ex1d</code> full-text index should be identical
to <code>ex1c</code> created earlier via the config.</p>
<h3 id="schemas-query-order">Schemas: query order</h3>
<p><code>SELECT</code> and <code>INSERT</code> (and its
<code>REPLACE</code> variation) base their column order on the schema
order in absence of an explicit query one, that is, in the
<code>SELECT *</code> case and the
<code>INSERT INTO myindex VALUES (...)</code> case, respectively. For
both implementation and performance reasons those orders need to differ
a bit from the config one. Let’s discuss that.</p>
<p>The star expansion order in <code>SELECT</code> is:</p>
<ul>
<li><code>id</code> first;</li>
<li>all available fields next, in config order;</li>
<li>all attributes next, in config order.</li>
</ul>
<p>The “ID/fields/attributes” motif continues here, but here’s the
catch, Sphinx does not always store the original field <em>contents</em>
when indexing. You have to explicitly request that with either
<code>field_string</code> or <code>stored_fields</code> and have the
content stored either as an attribute or into DocStore respectively.
Unless you do that, the original field content is <em>not</em>
available, and <code>SELECT</code> can not and does not return it. Hence
the “available” part in the wording.</p>
<p>Now, the default <code>INSERT</code> values order should match the
enforced config order completely, and the “ID/fields/attributes” rule
applies without the “available” clause:</p>
<ul>
<li><code>id</code> first;</li>
<li>all fields next, in config order;</li>
<li>all attributes next, in config order.</li>
</ul>
<p>Nothing omitted here, naturally. The default incoming document must
contain <em>all</em> the known columns, including <em>all</em> the
fields. You can choose to omit something explicitly using the
<code>INSERT</code> column list syntax. But not by default.</p>
<p>Keeping our example running, with this config:</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> ex1b</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = rt</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field_string</span> = title</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = content</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_bigint</span> = user_id</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_bigint</span> = thread_id</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span> = post_ts</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>We must get the following column sets:</p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># SELECT * returns:</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span>, title, user_id, thread_id, post_ts</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># INSERT expects:</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span>, title, content, user_id, thread_id, post_ts</span></code></pre></div>
<p>And we do!</p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">insert</span> <span class="kw">into</span> ex1b <span class="kw">values</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> (<span class="dv">123</span>, <span class="st">&#39;hello world&#39;</span>, <span class="st">&#39;my test content&#39;</span>, <span class="dv">111</span>, <span class="dv">222</span>, <span class="dv">333</span>);</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> ex1b <span class="kw">where</span> match(<span class="st">&#39;test&#39;</span>);</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------+---------+-----------+---------+</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | title       | user_id | thread_id | post_ts |</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------+---------+-----------+---------+</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | hello world |     <span class="dv">111</span> |       <span class="dv">222</span> |     <span class="dv">333</span> |</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------+---------+-----------+---------+</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="schemas-autocomputed-attributes">Schemas: autocomputed
attributes</h3>
<p><strong>Any autocomputed attributes should be appended after the user
ones.</strong></p>
<p>Depending on the index settings, Sphinx can compute a few things
automatically and store them as attributes. One notable example is
<code>index_field_lengths</code> that adds an extra
<strong>autocomputed</strong> length attributes for every field.</p>
<p>The specific order in which Sphinx adds them may vary. For instance,
as of time of this writing, the autocomputed attributes start with index
lengths, the token class masks are placed after the lengths, etc. That
<strong>may</strong> change in the future versions, and you <strong>must
not</strong> depend on this specific order.</p>
<p>However, it’s guaranteed that all the autocomputed attributes are
autoadded strictly after the user ones, at the very end of the
schema.</p>
<p>Also, <strong>autocomputed attributes are “skipped” from
INSERTs.</strong> Meaning that you should not specify them neither
explicitly by name, nor implicitly. Even if you have automatic
<code>title_len</code> in your index, you only ever have to specify
<code>title</code> in your <code>INSERT</code> statements, and the
<code>title_len</code> will be filled automatically.</p>
<h3 id="schemas-data-sources">Schemas: data sources</h3>
<p><strong>Starting from v.3.6 source-level schemas are
deprecated.</strong> You can not mix them with the new index-level
schemas, and you should convert your configs to index-level schemas
ASAP.</p>
<p>Converting is pretty straightforward. It should suffice to:</p>
<ol type="1">
<li>move the attributes declarations from the source level to index
level;</li>
<li>edit out the prefixes (ie. <code>sql_attr_bigint</code> becomes
<code>attr_bigint</code>);</li>
<li>add the explicit fields declarations if needed.</li>
</ol>
<p>You will also have to move the fields declarations before the
attributes. Putting fields before attributes is an error in the new
unified config syntax.</p>
<p>So, for example…</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># was: old source-level config (implicit fields, boring prefixes, crazy and</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="co"># less than predictable column order)</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> foo</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_query</span> = select id, price, lat, lon, title, created_ts FROM mydocs</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_attr_float</span> = lat</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_attr_float</span> = lon</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_attr_bigint</span> = price</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_attr_uint</span> = create_ts</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="co"># now: must move to new index-level config (explicit fields, shorter syntax,</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="co"># and columns in the index-defined order, AS THEY MUST BE (who said OCD?!))</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> foo</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_query</span> = select id, price, lat, lon, title, created_ts FROM mydocs</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> foo</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">source</span> = foo</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = title</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_float</span> = lat, lon</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_bigint</span> = price</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span> = create_ts</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>MVAs (aka integer set attributes) are the only exception that does
not convert using just a simple search/replace (arguably, a simple
regexp would suffice).</p>
<p>Legacy
<code>sql_attr_multi = {uint | bigint} &lt;attr&gt; from field</code>
syntax should now be converted to
<code>attr_uint_set = &lt;attr&gt;</code> (or
<code>attr_bigint_set</code> respectively). Still a simple
search/replace, that.</p>
<p>Legacy
<code>sql_attr_multi = {uint | bigint} &lt;attr&gt; from query; SELECT ...</code>
syntax should now be split to <code>attr_uint_set = &lt;attr&gt;</code>
declaration at index level, and
<code>sql_query_set = &lt;attr&gt;: SELECT ...</code> query at source
level.</p>
<p>Here’s an example.</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># that was then</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># less lines, more mess</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> bar</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_attr_multi</span> = bigint locations from field</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_attr_multi</span> = uint models from query<span class="kw">;</span> <span class="ex">SELECT</span> id, model_id FROM car2model</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="co"># this is now</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="co"># queries belong in the source, as ever</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> bar</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_query_set</span> = models: SELECT id, model_id FROM car2model</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="co"># but attributes belong in the index!</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> bar</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_bigint_set</span> = locations</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint_set</span> = models</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<h2 id="using-select">Using SELECT</h2>
<p><code>SELECT</code> is <strong>the</strong> main workhorse, and there
are really, really many different nooks and crannies to cover. Here’s
the plan. We are going to discuss various <code>SELECT</code>-related
topics right here, and split them into several independent-ish
subsections. So feel free to skip subsections that don’t immediately
apply. They should be skippable. Here’s the list.</p>
<ul>
<li><a href="#select-basics">SELECT basics</a></li>
<li><a href="#select-filtering-and-ordering">SELECT filtering and
ordering</a></li>
<li><a href="#select-grouping">SELECT grouping</a></li>
<li><a href="#select-options-explained">SELECT options
explained</a></li>
<li><a href="#faceted-searches-with-select">Faceted searches with
SELECT</a></li>
<li><a href="#nested-selects-aka-subselects">Nested SELECTs (aka
subselects)</a></li>
</ul>
<p>Plus, here are a few more heavily related sections.</p>
<ul>
<li><a href="#searching-expressions-and-operators">Expressions and
operators</a></li>
<li><a href="#using-table-functions">Using table functions</a></li>
</ul>
<p>Plus, there’s a formal syntax reference section later in this
documentation, with <strong>all</strong> the keywords, clauses, and
options mentioned and listed. Refer to <a href="#select-syntax">“SELECT
syntax”</a> for that. Here is where we <em>discuss</em> them all, in
hopefully readable prose and with a number of examples. There is where
we do keep track of everything, but in more concise lists and tables,
with cryptic one-line comments.</p>
<p>Plus, certain topics, even though <code>SELECT</code>-related at a
glance, deserve and get their very own documentation sections. Because
they’re big enough. For instance, we are <strong>not</strong> going to
discuss vector indexes or JSON columns here. Even though they obviously
do affect <code>SELECT</code> quite a lot.</p>
<p>All that said, let’s start with <code>SELECT</code> and let’s start
small, looking into simpler queries first!</p>
<h3 id="select-basics">SELECT basics</h3>
<p>Our <code>SELECT</code> is rooted in “regular” SQL, and the simplest
“give me that column” queries are identical between SphinxQL and any
other SQL RDBMS dialect.</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, price, title <span class="kw">FROM</span> books;</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> empno, ename, job <span class="kw">FROM</span> emp;</span></code></pre></div>
<p>However, SphinxQL diverges from regular SQL pretty much immediately,
with its own extensions <em>and</em> omissions both in the
<strong>column list (aka select items)</strong> clause (ie. all the
stuff between <code>SELECT</code> and <code>FROM</code>), and the
<code>FROM</code> clause.</p>
<p><strong>Column names, expressions, and the star (aka the asterisk)
are supported.</strong> No change there.
<code>SELECT id, price*1.23 FROM books</code> works in Sphinx.</p>
<p><strong>Column aliases are supported.</strong> You can either use or
omit the <code>AS</code> token too. No change again.
<code>SELECT id, price_usd*1.23 AS price_gbp FROM books</code>
works.</p>
<p><strong>Column aliases must be unique, unlike SQL.</strong> And that
applies to expressions without an explicit alias too. The following is
<strong>not</strong> legal in Sphinx.</p>
<div class="sourceCode" id="cb49"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span> aa, price aa <span class="kw">FROM</span> books;</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>ERROR <span class="dv">1064</span> (<span class="dv">42000</span>): <span class="kw">index</span> <span class="st">&#39;books&#39;</span>: alias <span class="st">&#39;aa&#39;</span> must be <span class="kw">unique</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  (conflicts <span class="kw">with</span> another alias)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span><span class="op">+</span><span class="dv">1</span>, <span class="kw">id</span><span class="op">+</span><span class="dv">1</span> <span class="kw">FROM</span> books;</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>ERROR <span class="dv">1064</span> (<span class="dv">42000</span>): <span class="kw">index</span> <span class="st">&#39;books&#39;</span>: alias <span class="st">&#39;id+1&#39;</span> must be <span class="kw">unique</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  (conflicts <span class="kw">with</span> another alias)</span></code></pre></div>
<p><strong>Column aliases can be referenced in subsequent
expressions.</strong> The uniqueness requirement is not in vain!</p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a># legal <span class="kw">in</span> Sphinx</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, price_usd <span class="op">*</span> <span class="fl">1.23</span> <span class="kw">AS</span> price_gbp, price_gbp <span class="op">*</span> <span class="dv">100</span> price_pence</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> books</span></code></pre></div>
<p><strong>The asterisk expands differently than in SQL.</strong>
Basically, it won’t include full-text fields by default (those are not
stored), and it won’t add duplicate columns. For details, see the <a
href="#star-expansion-quirks">“Star expansion quirks”</a> section.</p>
<p><strong><code>EXIST()</code> function replaces missing numeric
columns with default values.</strong> This is a weird little one,
occasionally useful for migrations, or for searches through multiple
“tables” (full-text indexes) at once.</p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a># <span class="kw">prepare</span> our queries <span class="cf">for</span> <span class="st">&#39;is_new_flag&#39;</span> upfront</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a># (<span class="kw">or</span> we could, <span class="kw">of</span> course, <span class="kw">update</span> <span class="ot">&quot;books&quot;</span> <span class="kw">table</span> <span class="fu">first</span> <span class="kw">and</span> code <span class="kw">next</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, EXIST(<span class="st">&#39;is_new_flag&#39;</span>, <span class="dv">0</span>) <span class="kw">AS</span> new_flag <span class="kw">FROM</span> books</span></code></pre></div>
<p>…and last, but quite importantly, one major <code>FROM</code> clause
difference.</p>
<p><strong><code>FROM</code> clause is NOT a join, it is a list of
indexes to search!</strong> Sphinx does not support joins. But searching
through multiple indexes at once <em>is</em> supported and
<code>FROM</code> may contain a list of indexes. Two principal use cases
for that are sharding and federated searches.</p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a># sharding example</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a># <span class="kw">all</span> shards expected <span class="kw">to</span> have <span class="kw">the</span> same <span class="kw">schema</span>, so <span class="kw">no</span> special worries</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, WEIGHT(), price, title, <span class="dt">year</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> shard1, shard2, shard3</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>);</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a># federation example</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a># different <span class="kw">indexes</span> may have different schemas!</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a># MUST make sure that <span class="ot">&quot;title&quot;</span> <span class="kw">is</span> omnipresent, <span class="kw">or</span> it<span class="st">&#39;s an error</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT id, WEIGHT(), title</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="st">FROM news, people, departments</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE MATCH(&#39;</span>hello world<span class="st">&#39;);</span></span></code></pre></div>
<h3 id="select-filtering-and-ordering">SELECT filtering and
ordering</h3>
<p>SphinxQL uses regular <code>WHERE</code>, <code>ORDER BY</code>, and
<code>LIMIT</code> clauses for result set filtering, ordering, and
limiting respectively, and introduces a few specific constraints. The
most important highlights are:</p>
<ul>
<li><code>WHERE MATCH()</code> special (optional) clause does full-text
matching;</li>
<li><code>WHERE MATCH()</code> can not work with <code>OR</code>, ie.
making a “union” of full-text matching and parametric filtering is not
supported;</li>
<li><code>ORDER BY</code> clause doesn’t support “in-place” expressions,
requires columns;</li>
<li><code>ORDER BY</code> clause requires explicit
<code>{ASC | DESC}</code> sorting order;</li>
<li><code>LIMIT</code> clause is <strong>never</strong> unlimited,
defaults to <code>LIMIT 0,20</code> for now;</li>
<li><code>LIMIT</code> clause is additionally constrained by sorting
memory budgets.</li>
</ul>
<blockquote>
<p>NOTE! “Columns” in this section always mean “result set columns”, not
only full-text index columns. Arbitrary expressions are included. For
example, <code>SELECT id, price, a*b+c</code> has 3 result set columns
(that include 2 index columns and 1 expression).</p>
</blockquote>
<p><strong><code>WHERE</code> clause is heavily optimized towards a
specific use-case.</strong> And that case is <code>AND</code> over
column-vs-value comparisons. While <code>WHERE</code> does now support
arbitrary expressions (to certain extent), and while <em>some</em>
frequent cases like
<code>WHERE indexed_column_A = 123 AND indexed_column_B = 234</code> are
already supported, generally, if your expression is complicated and does
<strong>not</strong> map well to that <code>MATCH-AND-AND-AND..</code>
structure, chances are that the secondary indexes will fail to
engage.</p>
<p>This is especially important when there’s no <code>MATCH()</code> in
your query. Because without <code>MATCH()</code> (that always uses the
full-text index) and without secondary indexes queries can only execute
as full scans!</p>
<p><strong>When do <code>WHERE</code> conditions use indexes,
then?</strong> As long as you stick to (any) of the following conditions
(and make sure that the respective secondary indexes do exist!), they
will highly likely engage the indexes, where appropriate.</p>
<ul>
<li>full-text matching: <code>MATCH()</code></li>
<li>comparisons: <code>=</code>, <code>!=</code>, <code>&lt;</code>,
<code>&gt;</code>, <code>&lt;=</code>, <code>&gt;=</code>,
<code>IN</code>, <code>BETWEEN</code></li>
<li>JSON value existence checks: <code>IS [NOT] NULL</code></li>
<li>geo functions: <code>CONTAINS</code>, <code>CONTAINSANY</code>,
<code>GEODIST</code>, <code>MINGEODIST</code></li>
<li><code>AND</code> operator (when at least one argument is
indexed)</li>
<li><code>OR</code> operator (when both arguments are indexed)</li>
</ul>
<p>For example.</p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a># MUST always <span class="kw">use</span> <span class="ot">&quot;primary&quot;</span> <span class="kw">full</span><span class="op">-</span>text <span class="kw">index</span>, because MATCH()</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a># may <span class="kw">use</span> <span class="ot">&quot;secondary&quot;</span> <span class="kw">index</span> <span class="kw">on</span> `price` too, <span class="cf">if</span> it<span class="st">&#39;s &quot;selective enough&quot;</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE MATCH(&#39;</span>foo<span class="st">&#39;) AND price &gt;= 100</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="st"># may use index on `json.magic_flag`, or on `price`, or both, or none</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="st">#</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="st"># for example, MUST use index on `price` when it&#39;</span>s <span class="ot">&quot;selective enough&quot;</span>,</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a># even <span class="cf">if</span> <span class="kw">no</span> other <span class="kw">indexes</span> exist (<span class="ot">&quot;any of the AND arguments&quot;</span> <span class="kw">rule</span>)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> json.magic_flag<span class="op">=</span><span class="dv">7</span> <span class="kw">AND</span> price <span class="kw">BETWEEN</span> <span class="dv">100</span> <span class="kw">AND</span> <span class="dv">120</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a># can <span class="kw">not</span> <span class="kw">use</span> a <span class="dt">single</span> <span class="kw">index</span> <span class="kw">on</span> `foo`</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a># may <span class="kw">use</span> <span class="kw">both</span> <span class="kw">indexes</span> <span class="kw">on</span> `foo` <span class="kw">and</span> `bar`</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a># MUST <span class="kw">use</span> <span class="kw">both</span> <span class="kw">indexes</span> <span class="cf">when</span> they<span class="st">&#39;re &quot;selective enough&quot;</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE foo=123 OR bar=456</span></span></code></pre></div>
<p>We use “where appropriate” and “selective enough” a lot here, what
does that specifically mean? Secondary indexes do not
<strong>necessarily</strong> help every single query, and Sphinx query
optimizer <strong>dynamically</strong> decides whether to use or skip
them, depending on specific requested values, and their occurrence
statistics.</p>
<p>For example, what if we have 10 million products, and just 500 match
<code>foo</code> keyword, but as many as 3 million are over $100? In
this case, it makes no sense for
<code>WHERE MATCH('foo') AND price &gt;= 100</code> query to engage the
secondary index on <code>price</code>. Because it’s not selective
enough. Intersecting 500 full-text matches against 3M price matches
would not be efficient.</p>
<p>But what if the occurrence statistics are different, and
<code>foo</code> matches as many as 700,000 documents, but just 200
products out of our 10M total are over $100? Suddenly,
<code>price &gt;= 100</code> part becomes very selective, and the
secondary index <strong>will</strong> engage. Moreover, it will even
help the primary full-text index matcher to skip most of the 700K
documents that it would have otherwise processed. Nice!</p>
<p><strong>All that index reading magic happens automatically.</strong>
Normally you don’t have to overthink this. Just beware the query
optimizer can’t always pierce through complex expressions, and therefore
your <code>WHERE</code> clauses might occasionally need a little
rewriting to help engage the secondary indexes.</p>
<p>To highlight a few anti-patterns as well, here are a few examples
that <strong>can’t</strong> engage secondary indexes, and revert to a
scan. Even when the secondary indexes exist and the values actually are
selective enough.</p>
<ul>
<li><code>WHERE NOT (userid=123 AND cityid=456)</code></li>
<li><code>WHERE COS(lat)&lt;0.5</code></li>
</ul>
<p><strong><code>EXPLAIN</code> shows all the secondary indexes that the
optimizer decides to use.</strong> We don’t yet print out very detailed
reports (with actual per-value statistics and the estimated costs), but
it does provide initial insights into actual index usage.</p>
<p><strong>Comparisons may also refer to certain special values</strong>
(that is, in addition to result set columns). Here’s what’s allowed in
<code>WHERE</code> comparisons.</p>
<ul>
<li>index columns, <code>WHERE price &lt;= 1000</code></li>
<li>result set columns, <code>WHERE cond = 1</code></li>
<li>full-text relevance, <code>WHERE WEIGHT() &gt;= 3.0</code></li>
<li>type-casted JSON values,
<code>WHERE FLOAT(j.geo.longitude) &lt; -90.1994</code></li>
<li>quantifiers over sets, <code>WHERE ANY(tags) = 1234</code></li>
</ul>
<p><strong>For the record, <code>WHERE MATCH()</code> is the full-text
search workhorse.</strong> That just needed to be said. Despite many
extra capabilities, Sphinx is a full-text search server first! Full-text
<code>MATCH()</code> query syntax is out of scope here, so refer to <a
href="#searching-query-syntax">“Searching: query syntax”</a> for
that.</p>
<p>One thing, though, <strong>MATCH(…) OR (..condition..) is not
possible.</strong> Full-text and parameter-based matching are way too
different internally. While it could be feasible to combine them on the
engine side, that seems like a lot of work, and for a questionable
purpose. In some cases, you could emulate OR conditions by adding magic
keywords to your documents, though.</p>
<div class="sourceCode" id="cb54"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a># <span class="kw">NOT</span> LEGAL</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a># fails <span class="kw">with</span> <span class="ot">&quot;syntax error, unexpected OR&quot;</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> test</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;&quot;we ship globally&quot;&#39;</span>) <span class="kw">OR</span> has_shipping <span class="op">=</span> <span class="dv">1</span>;</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a># however<span class="op">..</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> test</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;&quot;we ship globally&quot; | __magic_has_shipping&#39;</span>);</span></code></pre></div>
<p><strong>Naturally, there must be at most one MATCH() operator (or
none).</strong> Any combos can be expressed using the full-text query
syntax itself.</p>
<p>Now to the sorting oddities!</p>
<p><strong><code>ORDER BY</code> also does not (yet) support expressions
and requires columns.</strong> Just compute your complex sorting key (or
keys) in <code>SELECT</code>, pass those columns to
<code>ORDER BY</code>, and that works.</p>
<p>Besides columns, what works in comparisons, works too in
<code>ORDER BY</code> (except <code>ANY()</code> and <code>ALL()</code>
that naturally do not evaluate to a single sortable value). So ordering
by forcibly typed JSON columns (ie.
<code>ORDER BY UINT(myjson.foo) ASC</code>) also works, and so does
<code>ORDER BY WEIGHT() DESC</code>, etc.</p>
<p><strong><code>ORDER BY</code> requires an explicit <code>ASC</code>
or <code>DESC</code> order.</strong> For some now-unknown reason
(seriously, can’t remember why) there’s no default <code>ASC</code>
order.</p>
<p><strong><code>ORDER BY</code> supports composite sorting keys, up to
5 subkeys.</strong> In other words,
<code>ORDER BY this ASC, that DESC</code> is legal, and supports up to 5
key-order pairs.</p>
<p><strong><code>ORDER BY</code> subkeys can be strings, and comparisons
support collations.</strong> Built-in collations are
<code>libc_ci</code>, <code>libc_cs</code>,
<code>utf8_general_ci</code>, and <code>binary</code>. The default
collation is <code>libc_ci</code>, which calls good old
<code>strcasecmp()</code> under the hood.</p>
<p><strong><code>ORDER BY RAND()</code> is supported.</strong> Normally
it generates a new seed value for every query, or you can set
<code>OPTION rand_seed=&lt;N&gt;</code> for repeatable results.</p>
<p>Here are a few examples.</p>
<div class="sourceCode" id="cb55"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a># <span class="kw">all</span> good!</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> a<span class="op">*</span>b<span class="op">+</span>c <span class="kw">AS</span> mysortexpr, <span class="op">..</span>.</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> WEIGHT() <span class="kw">DESC</span>, price <span class="kw">ASC</span>, <span class="dt">FLOAT</span>(j.<span class="dt">year</span>) <span class="kw">DESC</span>, mysortexpr <span class="kw">DESC</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a># repeatable <span class="kw">random</span> <span class="kw">order</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>. <span class="kw">ORDER</span> <span class="kw">BY</span> RAND() <span class="kw">OPTION</span> rand_seed<span class="op">=</span><span class="dv">1234</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a># <span class="kw">not</span> supported, expression</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>. <span class="kw">ORDER</span> <span class="kw">BY</span> a<span class="op">*</span>b<span class="op">+</span>c <span class="kw">DESC</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a># <span class="kw">not</span> supported, too many subkeys</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>. <span class="kw">ORDER</span> <span class="kw">BY</span> col1 <span class="kw">ASC</span>, col2 <span class="kw">ASC</span>, col3 <span class="kw">ASC</span>, col4 <span class="kw">ASC</span>, col5 <span class="kw">ASC</span>, col6 <span class="kw">ASC</span></span></code></pre></div>
<p>And finally, limits.</p>
<p><strong><code>LIMIT &lt;count&gt;</code> and
<code>LIMIT &lt;offset&gt;, &lt;count&gt;</code> forms are
supported.</strong> We are copying MySQL syntax here. For those more
used to PostgreSQL syntax, instead of Postgres-style
<code>LIMIT 20 OFFSET 140</code> you write <code>LIMIT 140, 20</code> in
SphinxQL.</p>
<p><strong>Result sets are never unlimited, <code>LIMIT 20</code> is the
default implicit limit.</strong> This is Sphinx being a search server
first again. Search results that literally have millions of rows are not
infrequent. Limiting them is crucial.</p>
<p><strong>Result sets might also be additionally limited by memory
budgets.</strong> That’s tunable, the default is
<code>OPTION sort_mem=50M</code>, so 50 MB per every sorter. More
details in the <a href="#searching-memory-budgets">“Searching: memory
budgets”</a> section.</p>
<h3 id="select-grouping">SELECT grouping</h3>
<p>SphinxQL supports the usual <code>GROUP BY</code> and
<code>HAVING</code> clauses and all the usual aggregate functions, but
adds a few Sphinx-specific extensions:</p>
<ul>
<li>support for row representatives, all columns allowed (not only
aggregates)</li>
<li><code>TDIGEST()</code> aggregate that computes (approximate)
percentiles</li>
<li><code>GROUP &lt;N&gt; BY</code> clause that returns up to N
representative rows per group</li>
<li><code>WITHIN GROUP ORDER BY</code> clause that controls how to
choose representatives</li>
<li><code>GROUP BY</code> support for sets (<code>UINT_SET</code>,
<code>BIGINT_SET</code>) and JSON arrays</li>
<li><code>GROUPBY()</code> function that accesses current set (or array)
grouping key</li>
</ul>
<p>On a related note, Sphinx also has a <code>GROUP_COUNT()</code>
function <strong>instead of</strong> <code>GROUP BY</code> that helps
implement efficient grouping in “sparse” scenarios, when <em>most</em>
of your documents are not a part of a group, but just a few of them are.
Refer to <a href="#group_count-function">“GROUP_COUNT() function”</a>
for details.</p>
<p>Back to <code>GROUP BY</code> and friends.</p>
<p><strong>Row representatives are allowed.</strong> In other words, any
columns are legal in <code>GROUP BY</code> queries.
<code>SELECT foo GROUP BY bar</code> is legal even when <code>foo</code>
is <em>not</em> an aggregate function over the entire row group, but a
mere column. We have clear rules as to pick such representative rows,
see <code>WITHIN GROUP ORDER BY</code> clause below.</p>
<p><strong><code>GROUP BY</code> also does not (yet) support expressions
and requires columns.</strong> Same story as with <code>ORDER BY</code>,
just compute your keys explicitly, then group by those columns.</p>
<div class="sourceCode" id="cb56"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span>, user_id<span class="op">*</span><span class="dv">1000</span><span class="op">+</span>post_type <span class="kw">AS</span> grp <span class="kw">FROM</span> blogposts <span class="kw">GROUP</span> <span class="kw">BY</span> grp</span></code></pre></div>
<p><strong><code>GROUP BY</code> supports multiple columns, ie.
composite keys.</strong> There is no limit on the number of key parts.
Key parts can be either numeric or string. Strings are processed using
the current collation.</p>
<div class="sourceCode" id="cb57"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> products <span class="kw">GROUP</span> <span class="kw">BY</span> region, <span class="dt">year</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> title, <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">FROM</span> blogposts <span class="kw">GROUP</span> <span class="kw">BY</span> title <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">DESC</span></span></code></pre></div>
<p><strong>Implicit <code>GROUP BY</code> is supported.</strong> As in
regular SQL, it engages when there are aggregate functions in the query.
The following two queries should produce identical results, except for
an extra <code>grp</code> column in the other one.</p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">MAX</span>(<span class="kw">id</span>), <span class="fu">MIN</span>(<span class="kw">id</span>), <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FROM</span> books</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">MAX</span>(<span class="kw">id</span>), <span class="fu">MIN</span>(<span class="kw">id</span>), <span class="fu">COUNT</span>(<span class="op">*</span>), <span class="dv">1</span> <span class="kw">AS</span> grp <span class="kw">FROM</span> books <span class="kw">GROUP</span> <span class="kw">BY</span> grp</span></code></pre></div>
<p><strong>Standard numeric aggregates are supported (and over
expressions too).</strong> That includes <code>AVG()</code>,
<code>MIN()</code>, <code>MAX()</code>, <code>SUM()</code>, and
<code>COUNT(*)</code> aggregates. Argument <strong>expressions</strong>
must return a numeric type.</p>
<div class="sourceCode" id="cb59"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">AVG</span>(price <span class="op">-</span> <span class="kw">cost</span>) avg_markup <span class="kw">FROM</span> products </span></code></pre></div>
<p><strong><code>COUNT(DISTINCT &lt;column&gt;)</code> aggregate is
supported (but over columns only).</strong> At most one
<code>COUNT(DISTINCT)</code> per query is allowed, and in-place
expressions are <em>not</em> allowed here, only column names are. But
computed columns are fine, and string attributes are fine, too.</p>
<div class="sourceCode" id="cb60"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> IDIV(user_id,<span class="dv">10</span>) xid, <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> xid) <span class="kw">FROM</span> blogs</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> user_id, <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> title) num_titles <span class="kw">FROM</span> blogs <span class="kw">GROUP</span> <span class="kw">BY</span> user_id</span></code></pre></div>
<p><strong><code>GROUP_CONCAT(&lt;expr&gt;, [&lt;cutoff&gt;])</code>
aggregate is supported.</strong> This aggregate produces a
comma-separated list of <strong>all</strong> the argument expression
values, for all the rows in the group. For instance,
<code>GROUP_CONCAT(id)</code> returns all document ids for each
group.</p>
<p>The mandatory <code>&lt;expr&gt;</code> argument can be pretty much
any expression.</p>
<p>The optional <code>&lt;cutoff&gt;</code> argument limits the number
of list entries. By default, it’s <strong>unlimited</strong>, so
<code>&lt;cutoff&gt;</code> comes in quite handy when groups can get
huge (think thousands or even millions of matches), but either only a
few entries per group do suffice in our use case, or we want to limit
the performance impact, or both. For instance,
<code>GROUP_CONCAT(id,10)</code> returns at most 10 ids per group.</p>
<div class="sourceCode" id="cb61"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> user_id, GROUP_CONCAT(<span class="kw">id</span><span class="op">*</span><span class="dv">10</span>,<span class="dv">5</span>) <span class="kw">FROM</span> blogs</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;alien invasion&#39;</span>) <span class="kw">GROUP</span> <span class="kw">BY</span> user_id </span></code></pre></div>
<p><strong><code>TDIGEST(&lt;expr&gt;, [&lt;percentiles&gt;])</code>
aggregate is supported.</strong> This aggregate computes the requested
<strong>percentiles</strong> of an expression, directly on the server
side. For example!</p>
<div class="sourceCode" id="cb62"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> TDIGEST(price, [<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span>, <span class="fl">0.999</span>]) <span class="kw">FROM</span> products;</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------------------------------------------------+</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>| tdigest(price, [<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span>, <span class="fl">0.999</span>])                                   |</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------------------------------------------------+</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>| {<span class="ot">&quot;p10&quot;</span>: <span class="fl">505.42905</span>, <span class="ot">&quot;p50&quot;</span>: <span class="fl">2620.332</span>, <span class="ot">&quot;p90&quot;</span>: <span class="fl">20638.242</span>, <span class="ot">&quot;p999&quot;</span>: <span class="fl">1134161.0</span>} |</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------------------------------------------------+</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.878</span> sec)</span></code></pre></div>
<p>This means that our bottom 10% products are under 505 credits or less
(as per p10), our median price is 2620 credits (as per p50), and our top
0.1% products start at 1.13 million credits. Much more useful than
minimum and maximum prices, which in this example actually are 0 and
111.1 billion!</p>
<div class="sourceCode" id="cb63"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="fu">MIN</span>(price), <span class="fu">MAX</span>(price) <span class="kw">FROM</span> products;</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------+--------------+</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>| <span class="fu">min</span>(price) | <span class="fu">max</span>(price)   |</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------+--------------+</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>|          <span class="dv">0</span> | <span class="dv">111111111111</span> |</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------+--------------+</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.858</span> sec)</span></code></pre></div>
<p>Oh, and analyzing this on the client side would be less fun than a
single quick query in this example, because ~40 million products.</p>
<p>The expression must be scalar (that is, evaluate to integer or
float). Allowed percentiles must be from 0 to 1, inclusive. The default
percentiles, if omitted, are <code>[0, 0.25, 0.5, 0.75, 1.0]</code>.</p>
<p>The output format is JSON, with special key formatting rules (more
details below). For example, the default percentiles will produce the
following keys.</p>
<div class="sourceCode" id="cb64"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> tdigest(col1) <span class="kw">from</span> testdigest;</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------------------------------------------------+</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>| tdigest(col1)                                                     |</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------------------------------------------------+</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>| {<span class="ot">&quot;p0&quot;</span>: <span class="fl">3.0</span>, <span class="ot">&quot;p25&quot;</span>: <span class="fl">29.0</span>, <span class="ot">&quot;p50&quot;</span>: <span class="fl">46.0</span>, <span class="ot">&quot;p75&quot;</span>: <span class="fl">75.0</span>, <span class="ot">&quot;p100&quot;</span>: <span class="fl">100.0</span>} |</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------------------------------------------------+</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Basically, all the whole percentages format as <code>pXY</code>, as
evidenced just above. The interesting non-whole percentages such as 99.9
and 99.95 also format without separators, so <code>p999</code> and
<code>p9995</code> respectively. The formal rules are:</p>
<ul>
<li>percentiles over 10% are formatted as <code>pXYZ</code> (so 12.34
gives <code>p1234</code>);</li>
<li>percentiles under 10% are formatted as <code>pX_YZ</code> (so 1.234
gives <code>p1_234</code>);</li>
<li>all meaningful digits are retained;</li>
<li>any trailing zeroes are removed (so <code>p1_234</code> and never
<code>p1_234000</code>);</li>
<li>float precision does apply (so 6 or 7 digits max).</li>
</ul>
<p>The <code>TDIGEST()</code> percentiles are estimated using
<strong>the t-digest method</strong>, as per
https://github.com/tdunning/t-digest/ reference.</p>
<p>Distributed indexes are supported. Only the t-digests are sent over
the network, and as their sizes are strictly limited (to ~3 KB max),
percentile queries even over huge datasets will <em>not</em> generate
excessive network traffic.</p>
<p><strong>Grouping by sets (or JSON arrays) and <code>GROUPBY()</code>
function are supported.</strong> Rows are then assigned to
<strong>multiple</strong> groups, one group for every set (or JSON
array) value. And <code>GROUPBY()</code> function makes that value
accessible in the query.</p>
<div class="sourceCode" id="cb65"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">CREATE</span> <span class="kw">TABLE</span> test (<span class="kw">id</span> bigint, title field, tags uint_set);</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> test (<span class="kw">id</span>, tags) <span class="kw">VALUES</span> (<span class="dv">111</span>,(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)), (<span class="dv">112</span>,(<span class="dv">3</span>,<span class="dv">5</span>)),</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">113</span>,(<span class="dv">2</span>)), (<span class="dv">114</span>,(<span class="dv">7</span>,<span class="dv">40</span>));</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">4</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test;</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | tags  |</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">111</span> | <span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span> |</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">112</span> | <span class="dv">3</span>,<span class="dv">5</span>   |</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">113</span> | <span class="dv">2</span>     |</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">114</span> | <span class="dv">7</span>,<span class="dv">40</span>  |</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> GROUPBY(), <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FROM</span> test <span class="kw">GROUP</span> <span class="kw">BY</span> tags</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> groupby() <span class="kw">ASC</span>;</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+----------+</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>| groupby() | <span class="fu">count</span>(<span class="op">*</span>) |</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+----------+</span></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>|         <span class="dv">1</span> |        <span class="dv">1</span> |</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>|         <span class="dv">2</span> |        <span class="dv">2</span> |</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>|         <span class="dv">3</span> |        <span class="dv">2</span> |</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>|         <span class="dv">5</span> |        <span class="dv">1</span> |</span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>|         <span class="dv">7</span> |        <span class="dv">1</span> |</span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>|        <span class="dv">40</span> |        <span class="dv">1</span> |</span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+----------+</span></span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a><span class="dv">6</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Another example with the same data stored in a JSON array instead of
<code>UINT_SET</code> would be repetitive, but yes,
<code>GROUP BY j.tags</code> works just as well.</p>
<p><strong><code>GROUPBY()</code> also works with regular
<code>GROUP BY</code> by a scalar value.</strong> In which case it
basically becomes an extra alias for the grouping column. Not too useful
per se, just ensures that queries using <code>GROUPBY()</code> don’t
break depending on the underlying grouping column type.</p>
<p>For the record, <strong>multiple aggregates are supported.</strong>
To reiterate, the only restriction here is “at most one
<code>COUNT(DISTINCT)</code> per query”, other aggregates can be used in
any volumes.</p>
<div class="sourceCode" id="cb66"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span>, <span class="fu">AVG</span>(price) <span class="kw">AS</span> avg_price, <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> store_id) num_stores</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> products <span class="kw">WHERE</span> MATCH(<span class="st">&#39;ipod&#39;</span>) <span class="kw">GROUP</span> <span class="kw">BY</span> vendor_id</span></code></pre></div>
<p><strong><code>WITHIN GROUP ORDER BY</code> controls the in-group rows
ordering.</strong> Sphinx does <strong>not</strong> pick a
representative row for a group randomly. It compares rows using a
certain comparison criterion instead, as they get added into a group.
And this clause lets you control that criterion.</p>
<p>The default in-group order is
<code>WITHIN GROUP ORDER BY WEIGHT() DESC, id ASC</code>, which makes
the most relevant full-text match the “best” row in a group, and picked
as its representative. Makes perfect sense for full-text searches, but
reduces into oversimplified “minimum id is the best” for non-text ones.
Beware.</p>
<p>The syntax matches our <code>ORDER BY</code> clause, same features,
same restrictions.</p>
<p><strong><code>GROUP &lt;N&gt; BY</code> includes multiple “best”
group rows in the final result set.</strong> Up to <code>N</code>
representative rows per group (instead of the usual one) are retained
when this extension is used. (Naturally, there might be less than
<code>N</code> rows in any given group.)</p>
<p>The same <code>WITHIN GROUP ORDER BY</code> criterion applies, so
it’s top-N most relevant matches by default for full-text searches (and
top-N smallest ids for non-text).</p>
<p>For a proper example, here’s how to keep at most 3 cheapest iPhones
per each seller using these SphinxQL extensions (ie. in-group order and
N-grouping).</p>
<div class="sourceCode" id="cb67"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, price</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> products <span class="kw">WHERE</span> MATCH(<span class="st">&#39;iphone&#39;</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="dv">3</span> <span class="kw">BY</span> seller_id WITHIN <span class="kw">GROUP</span> <span class="kw">ORDER</span> <span class="kw">BY</span> price <span class="kw">ASC</span></span></code></pre></div>
<p><strong><code>HAVING</code> clause has limited support, with exactly
one comparison allowed.</strong> Same restrictions as in
<code>ORDER BY</code> and <code>GROUP BY</code> apply, ie. exactly one
comparison over result set columns only, no expressions, etc.</p>
<p>Yep, our current <code>HAVING</code> is an <em>extremely</em> simple
result set post-filter, added basically for a little convenience when
doing one-off ad-hoc collection analysis queries. But then again Sphinx
is not exactly an OLAP solution either, so these draconian restrictions
seem curiously alright. (As in, not a single request to improve
<code>HAVING</code>, ever.)</p>
<div class="sourceCode" id="cb68"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FROM</span> test <span class="kw">GROUP</span> <span class="kw">BY</span> whatever <span class="kw">HAVING</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="op">&gt;=</span> <span class="dv">10</span></span></code></pre></div>
<h3 id="select-options-explained">SELECT options explained</h3>
<p>SphinxQL introduces an optional <code>OPTION</code> clause that
passes custom fine-tuning options to very many different
<code>SELECT</code> parts (from query parsing to ANN search parameters
to distributed querying timeouts).</p>
<p>The <strong>complete</strong> list resides in the <a
href="#select-options">“SELECT options”</a> section in the reference
part of this document. Go there for a concise, lexically sorted table of
<strong>all</strong> the options and terse one-line descriptions.</p>
<p>In here, we will attempt to group them by functionality, and describe
them in more detail (yay, three-line descriptions!). Watch us, uhm,
attempt.</p>
<p>But first, the syntax! It’s a simple
<code>OPTION &lt;name&gt; = &lt;value&gt; [, ...]</code> list, and it
must happen at the very end of the <code>SELECT</code> query. After
<em>all</em> the other clauses (of which the last “regular” one is
currently <code>LIMIT</code>), like so.</p>
<div class="sourceCode" id="cb69"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test <span class="kw">WHERE</span> MATCH(<span class="st">&#39;phone&#39;</span>) <span class="kw">LIMIT</span> <span class="dv">10</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> global_idf<span class="op">=</span><span class="dv">1</span>, cutoff<span class="op">=</span><span class="dv">50000</span>, field_weights<span class="op">=</span>(title<span class="op">=</span><span class="dv">3</span>, <span class="kw">body</span><span class="op">=</span><span class="dv">1</span>)</span></code></pre></div>
<p><strong>Options for distributed queries (aka agent
queries).</strong></p>
<table>
<thead>
<tr class="header">
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>agent_query_timeout</td>
<td>Max agent query timeout, in msec</td>
</tr>
<tr class="even">
<td>lax_agent_errors</td>
<td>Lax agent error handling (treat as warnings)</td>
</tr>
<tr class="odd">
<td>retry_count</td>
<td>Max agent query retries count</td>
</tr>
<tr class="even">
<td>retry_delay</td>
<td>Agent query retry delay, in msec</td>
</tr>
</tbody>
</table>
<p>Queries to remote agents (in distributed indexes)
<strong>will</strong> definitely fail and time out. These options choose
how to handle failures, but a question may arise, why are they
<code>SELECT</code> options, and not global?</p>
<p>In fact, they <strong>are</strong> both global <em>and</em>
per-query. For instance, you can set <code>agent_query_timeout</code>
globally in <code>searchd</code> section, <em>and</em> override that
global settings for some special indexes only via their configs,
<em>and</em> further override that too in <code>SELECT</code> queries
themselves via the <code>OPTION</code> clause.</p>
<p>Because all queries are different. Say, most of your searches might
need to complete in 500 msec, because SLA, and global
<code>agent_query_timeout = 400</code> would then make sense. But that
global setting would then break any once-a-day robot queries that gather
statistics. Per-query overrides can then fix those back.</p>
<p>Specifically, <code>agent_query_timeout</code> is a maximum agent
query timeout. Master Sphinx instance only waits that much for a search
result, then forcibly kills the agent connection, then does up to
<code>retry_count</code> retries, with an optional
<code>retry_delay</code> delay between them (just some throttling in
case we are retrying the same agent over and over agent). The defaults
are 3000 msec (3 sec) query timeout, 0 retries (ie. no retries at all),
and 500 msec (0.5 sec) retry delay. See also <a
href="#outgoing-distributed-queries">“Outgoing (distributed)
queries”</a>.</p>
<p>The only other option is <code>lax_agent_errors</code> which defaults
to 0 (strict errors) and which we do <em>not</em> really recommend
switching back on. For details on that, see <a
href="#searching-distributed-query-errors">“Distributed query
errors”</a>.</p>
<p><strong>Options for debugging.</strong></p>
<table>
<thead>
<tr class="header">
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>comment</td>
<td>Set user comment (gets logged!)</td>
</tr>
</tbody>
</table>
<p><code>OPTION comment='...'</code> lets you attach custom “comment”
text to your query, which then gets copied to <code>SHOW THREADS</code>
and query logs. Absolutely zero effect on production, but pretty useful
for debugging (to differentiate query classes, or identify originating
clients, or whatever, the possibilities are endless.)</p>
<p><strong>Options that limit the amount of processing.</strong></p>
<table>
<thead>
<tr class="header">
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>cutoff</td>
<td>Max matches to process per-index</td>
</tr>
<tr class="even">
<td>expansion_limit</td>
<td>Per-query keyword expansion limit</td>
</tr>
<tr class="odd">
<td>inner_limit_per_index</td>
<td>Forcibly use per-index inner LIMIT</td>
</tr>
<tr class="even">
<td>low_priority</td>
<td>Use a low priority thread</td>
</tr>
<tr class="odd">
<td>max_predicted_time</td>
<td>Impose a virtual time limit, in units</td>
</tr>
<tr class="even">
<td>max_query_time</td>
<td>Impose a wall time limit, in msec</td>
</tr>
<tr class="odd">
<td>sort_mem</td>
<td>Per-sorter memory budget, in bytes</td>
</tr>
</tbody>
</table>
<p>These options impose additional limits on various query processing
stages, mostly in order to hit the CPU/RAM budgets.</p>
<p><strong><code>OPTION cutoff=&lt;N&gt;</code></strong> stops query
processing once N matches have been found. Matches mean rows that
satisfy the <code>WHERE</code> clause, full-text <code>MATCH()</code>
operator is unrelated, <code>WHERE price&lt;=1000 OPTION cutoff=1</code>
will stop immediately after seeing the very first row with a proper
price.</p>
<p>Cutoff might be a bit tricky performance control knob, though.</p>
<p>First, <strong>cutoff only counts proper <em>matches</em>, not
<em>processed</em> rows.</strong> Queries that process many rows but
filter away most (or even all) of those will still be slow. Queries like
<code>WHERE MATCH('odd') AND is_even=1</code> can work through
<strong>lots</strong> of rows but match none, and cutoff would never
trigger.</p>
<p>Second, <strong>cutoff is per-index, not global when searching
multiple indexes.</strong> That also includes distributed searches. With
<code>N</code> physical indexes involved in the search query, result set
can easily grow up to <code>cutoff * N</code> matches. Because
<code>cutoff</code> is per-physical-index.</p>
<div class="sourceCode" id="cb70"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> shard1, shard2, shard3</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> cutoff<span class="op">=</span><span class="dv">100</span> <span class="kw">LIMIT</span> <span class="dv">500</span> # returns up <span class="kw">to</span> <span class="dv">300</span> matches</span></code></pre></div>
<p><strong><code>OPTION expansion_limit=&lt;N&gt;</code></strong> limits
the number of specific keywords that every single wildcard term expands
to. And wildcards sometimes expand… wildly.</p>
<p>Even an innocuous <code>MATCH('hell* worl*')</code> might surprise:
on a small test corpus (1 million documents) we get 675 expansions for
<code>hell*</code> and 219 expansions for <code>worl*</code>
respectively. Of course there are internal optimizations for that, but
sometimes a limit just might be needed. Because <code>co*</code> expands
to 22101 unique keywords and that’s on a <em>small</em> corpus. Worst
case scenarios in larger collections <em>will</em> be even worse!</p>
<p><code>expansion_limit</code> defuses that by only including top-N
most frequent expansions for every wildcard.</p>
<p>See also <a
href="#expansion_limit-directive">“<code>expansion_limit</code>
directive”</a> which is the server-wide version of this limit.</p>
<p><strong><code>OPTION low_priority</code></strong> runs query thread
(or threads) with idle priority (<code>SCHED_IDLE</code> on Linux). This
is temporary. Thread priority <strong>is</strong> restored back to
normal on query completion. Further work must not be anyhow affected.
Can be useful for background tasks on busy servers.</p>
<p><strong><code>OPTION max_predicted_time=&lt;N&gt;</code></strong>
stops query processing once its modelled execution time reaches a given
budget. The model is a very simple linear one.</p>
<pre><code>predicted_time = A * processed_documents + B * processed_postings + ...</code></pre>
<p><a
href="#predicted_time_costs-directive"><code>predicted_time_costs</code>
directive</a> configures the model costs, then
<code>max_predicted_time</code> uses them to
<strong>deterministically</strong> stop too heavy queries. Refer there
for details.</p>
<p><strong><code>OPTION max_query_time=&lt;N&gt;</code></strong> stops
query processing once its actual execution time (as per wall clock)
reaches N msec. Easy to use, but non-deterministic!</p>
<p><strong><code>OPTION sort_mem=&lt;N&gt;</code></strong> limits
per-sorter RAM use. Per-sorter basically means per-query for most
searches, but per-facet for faceted searches. Sorters consume the vast
majority of query RAM, so this option is <strong>THE</strong> most
important tuning dial for that.</p>
<p>The default limit is 50 MB. And that’s not small, because the top
1000 rows can frequently fit into just 1 MB or even less. You’d usually
need to individually bump this limit for more complex
<code>GROUP BY</code> queries only. There’s a warning when
<code>sort_mem</code> limit gets hit, so don’t ignore warnings.</p>
<p>Refer to <a href="#searching-memory-budgets">“Searching: memory
budgets”</a> for details.</p>
<p><strong>Options for ranking.</strong></p>
<table>
<thead>
<tr class="header">
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>field_weights</td>
<td>Per-field weights map</td>
</tr>
<tr class="even">
<td>global_idf</td>
<td>Enable global IDF</td>
</tr>
<tr class="odd">
<td>index_weights</td>
<td>Per-index weights map</td>
</tr>
<tr class="even">
<td>local_df</td>
<td>Compute IDF over all the local query indexes</td>
</tr>
<tr class="odd">
<td>rank_fields</td>
<td>Use the listed fields only in FACTORS()</td>
</tr>
<tr class="even">
<td>ranker</td>
<td>Use a given ranker function (and expression)</td>
</tr>
</tbody>
</table>
<p>These options fine-tune relevance ranking. You can select one of the
built-in ranking formulas or provide your own, and tweak weights, fields
and IDF values. Let’s overview.</p>
<p><strong><code>OPTION ranker</code> selects the ranking formula for
<code>WEIGHT()</code>.</strong> The default one is a fast built-in
<code>proximity_bm15</code> formula that <strong>prioritizes phrase
matches</strong>. It combines the “proximity” part with BM15, a
simplified variant of a classic BM25 function. There are several other
built-in formulas, or you can even build your own custom one.
<strong>Sphinx computes over 50 full-text ranking signals,</strong> and
all those signals are accessible in formulas (and UDFs)! The two
respective syntax variants are as follows.</p>
<div class="sourceCode" id="cb72"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>. <span class="kw">OPTION</span> ranker<span class="op">=</span>sph04 # either <span class="kw">select</span> a built<span class="op">-</span><span class="kw">in</span> formula</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>. <span class="kw">OPTION</span> ranker<span class="op">=</span>expr(<span class="st">&#39;123&#39;</span>) # <span class="kw">or</span> provide your <span class="kw">own</span> formula</span></code></pre></div>
<p>See <a href="#ranking-factors">“Ranking: factors”</a> for a deeper
discussion of ranking in general, and available factors. For a quick
list of built-in rankers, you can jump to <a
href="#ranking-built-in-ranker-formulas">“Built-in ranker formulas”</a>,
but we do recommend to start at “Ranking: factors” first.</p>
<p><strong><code>OPTION field_weights=(...)</code> specifies custom
per-field weights for ranking.</strong> You can then access those
weights in your formula. Here’s an example.</p>
<div class="sourceCode" id="cb73"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, WEIGHT(), title <span class="kw">FROM</span> test</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  ranker<span class="op">=</span>expr(<span class="st">&#39;sum(lcs*user_weight)*10000 + bm25(1.2, 0.7)&#39;</span>),</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  field_weights<span class="op">=</span>(title<span class="op">=</span><span class="dv">15</span>, keywords<span class="op">=</span><span class="dv">13</span>, content<span class="op">=</span><span class="dv">10</span>)</span></code></pre></div>
<p>Several interesting things already happen here, even in this rather
simple example. One, we use a custom ranking formula, and “upgrade” the
“secondary” signal in <code>proximity_bm15</code> from a simpler
<code>bm15</code> function to a proper <code>bm25()</code> function.
Two, we boost phrase matches in <code>title</code> and
<code>keywords</code> fields, so that a match in <code>title</code>
ranks higher. Three, we carefully boost the “base” <code>content</code>
field weight, and we achieve a fractional boost strength even though
weights are integer. 2-word matches in <code>title</code> get a 1.5x
boost and contribute to <code>WEIGHT()</code> exactly as much as 3-word
matches in <code>content</code> field.</p>
<p>The default weights are all set to 1, so all fields are equal.</p>
<p><strong><code>OPTION index_weights=(...)</code> specifies custom
per-index <code>WEIGHT()</code> scales.</strong> This kicks in when
doing multi-index searches, and enables prioritizing matches from index
A over index B. <code>WEIGHT()</code> values are simply multiplied by
scaling factors from <code>index_weight</code> list.</p>
<div class="sourceCode" id="cb74"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a># boost <span class="kw">fresh</span> news 2x <span class="kw">over</span> archived ones</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, WEIGHT(), title <span class="kw">FROM</span> fresh_news, archived_news</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;alien invasion&#39;</span>) <span class="kw">OPTION</span> index_weights<span class="op">=</span>(fresh_news<span class="op">=</span><span class="dv">2</span>)</span></code></pre></div>
<p>The default weights are all set to 1 too, so all indexes are equal
too.</p>
<p><strong><code>OPTION global_idf=1</code> and
<code>OPTION local_df=1</code> control the IDF calculations.</strong>
IDF stands for Inverse Document Frequency, it’s a float weight
associated with every keyword that you search for, and it’s
<strong>extremely</strong> important for ranking (like half the ranking
signals depend on IDF to some extent). By default, Sphinx automatically
computes IDF values <strong>dynamically</strong>, based on the
statistics taken from the current full-text index <strong>only</strong>.
That causes all kinds of IDF jitter and doesn’t necessarily work well.
What works better? Sometimes it’s enough to use
<code>OPTION local_df=1</code> to just “align” the IDF values across
multiple indexes. Sometimes it’s necessary to attach a static global IDF
“registry” to indexes via a <strong><a
href="#global_idf-directive">per-index <code>global_idf</code>
setting</a></strong>, and <em>also</em> explicitly enable that in
queries using <code>OPTION global_idf=1</code> syntax.</p>
<p>Dedicated <a href="#ranking-idf-magics">“Ranking: IDF magics”</a>
section dives into bit more details.</p>
<p><strong><code>OPTION rank_fields='...'</code> limits the fields used
for ranking.</strong> It’s useful when you need to mix “magic” keywords
along with “regular” ones in your queries, as in
<code>WHERE MATCH('hello world @sys _category1234')</code> example.</p>
<p>Small <a href="#ranking-picking-fields-with-rank_fields">“Ranking:
picking fields…”</a> section covers that.</p>
<p><strong>Options for sampling.</strong></p>
<table>
<thead>
<tr class="header">
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>sample_div</td>
<td>Enable sampling with this divisor</td>
</tr>
<tr class="even">
<td>sample_min</td>
<td>Start sampling after this many matches</td>
</tr>
</tbody>
</table>
<p><code>SELECT</code> supports an interesting “sampling” mode when it
samples all the data instead of honestly processing everything. Unlike
all other “early bail” limits such as <code>cutoff</code> or
<code>max_query_time</code>, sampling keeps evaluating until the end.
But it aggressively skips rows once “enough” matches are found.</p>
<p>The syntax is pretty straightforward, eg.
<code>OPTION sample_min=100, sample_div=5</code> means “accumulate 100
matches normally, and then only process every 5-th row”.</p>
<p><a href="#index-sampling">“Index sampling”</a> section goes deeper
into our sampling implementation details and possible caveats.</p>
<p><strong>Misc options.</strong></p>
<table>
<thead>
<tr class="header">
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>boolean_simplify</td>
<td>Use boolean query simplification</td>
</tr>
<tr class="even">
<td>rand_seed</td>
<td>Use a specific RAND() seed</td>
</tr>
<tr class="odd">
<td>sort_method</td>
<td>Match sorting method (<code>pq</code> or <code>kbuffer</code>)</td>
</tr>
</tbody>
</table>
<p>And last, all the unique (and perhaps most obscure) options.</p>
<p><strong><code>OPTION boolean_simplify=1</code></strong> enables
boolean query simplification at query parsing stage.</p>
<p>Basically, when you’re searching for complex boolean expressions, it
might make sense to reorder ANDs and ORs around, or extract common query
parts, and so on. For performance. For example, the following two
queries match exactly the same documents, but the second one is clearly
simpler and actually easier to compute.</p>
<div class="sourceCode" id="cb75"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>. <span class="kw">WHERE</span> MATCH(<span class="st">&#39;(aaa !ccc) | (bbb !ccc)&#39;</span>) # slower</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>. <span class="kw">WHERE</span> MATCH(<span class="st">&#39;(aaa | bbb) !ccc&#39;</span>) # faster</span></code></pre></div>
<p>And simply adding <code>OPTION boolean_simplify=1</code> into the
first “slower” query makes Sphinx query parser
<strong>automatically</strong> detect this optimization possibility
(along with several more types!), and then internally rewrite the first
query into the second.</p>
<p>Why not enable this by default, then?! This optimization adds a small
constant CPU hit, plus muddles relevance ranking. Because suddenly, any
full-text query can get internally rewritten! So, Sphinx does not dare
make this choice on your behalf. It must be explicit.</p>
<p><strong><code>OPTION rand_seed=&lt;N&gt;</code> sets a seed for
<code>ORDER BY RAND()</code> clause.</strong> Making your randomized
results random, but repeatable.</p>
<p><strong><code>OPTION sort_method=kbuffer</code> forces a different
internal sorting method.</strong> Sphinx normally implements
<code>ORDER BY ... LIMIT N</code> by keeping a priority queue for top-N
rows. But in “backwards” cases, ie. when matches are found in exactly
the wrong order, a so-called K-buffer sorting method is faster. One
example is a reverse <code>ORDER BY id DESC</code> query against an
index where the rows were indexed and stored in the <code>id ASC</code>
order.</p>
<p>Now, <code>OPTION sort_method=kbuffer</code> is <strong>generally
slower</strong>, but in this specific backwards case, it helps. Might be
better in other extreme cases. Use with care, only if proven helpful.
(For the record, explicit <code>OPTION sort_method=pq</code> also is
legal. Absolutely useless, but legal.)</p>
<h3 id="faceted-searches-with-select">Faceted searches with SELECT</h3>
<p>Faceted searches are pretty easy in Sphinx. <code>SELECT</code> has a
special <code>FACET</code>clause for those. In its simplest form, you
just add a <code>FACET</code> clause for each faceting column, and
that’s it.</p>
<div class="sourceCode" id="cb76"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> products</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>FACET brand</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>FACET <span class="dt">year</span></span></code></pre></div>
<p>This example query scans all products once, but returns 3 result
sets, one for the “primary” select, one for each facet. Let’s get some
simple testing data in and see for ourselves.</p>
<div class="sourceCode" id="cb77"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">CREATE</span> <span class="kw">TABLE</span> products (<span class="kw">id</span> BIGINT, title FIELD_STRING,</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  brand STRING, <span class="dt">year</span> UINT);</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> products (<span class="kw">id</span>, <span class="dt">year</span>, brand, title) <span class="kw">VALUES</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span>, <span class="dv">2021</span>, <span class="st">&#39;Samsung&#39;</span>, <span class="st">&#39;Galaxy S21&#39;</span>),</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">2</span>, <span class="dv">2021</span>, <span class="st">&#39;Samsung&#39;</span>, <span class="st">&#39;Galaxy S21 Plus&#39;</span>),</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">3</span>, <span class="dv">2021</span>, <span class="st">&#39;Samsung&#39;</span>, <span class="st">&#39;Galaxy S21 Ultra&#39;</span>),</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">4</span>, <span class="dv">2022</span>, <span class="st">&#39;Samsung&#39;</span>, <span class="st">&#39;Galaxy S21 FE&#39;</span>),</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">5</span>, <span class="dv">2022</span>, <span class="st">&#39;Samsung&#39;</span>, <span class="st">&#39;Galaxy S22 Plus&#39;</span>),</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">6</span>, <span class="dv">2023</span>, <span class="st">&#39;Samsung&#39;</span>, <span class="st">&#39;Galaxy S23&#39;</span>),</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">7</span>, <span class="dv">2023</span>, <span class="st">&#39;Samsung&#39;</span>, <span class="st">&#39;Galaxy S23 FE&#39;</span>),</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">8</span>, <span class="dv">2023</span>, <span class="st">&#39;Apple&#39;</span>, <span class="st">&#39;iPhone 15 Pro&#39;</span>),</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">9</span>, <span class="dv">2023</span>, <span class="st">&#39;Apple&#39;</span>, <span class="st">&#39;iPhone 15&#39;</span>),</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">10</span>, <span class="dv">2022</span>, <span class="st">&#39;Apple&#39;</span>, <span class="st">&#39;iPhone 14 Plus&#39;</span>),</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">11</span>, <span class="dv">2022</span>, <span class="st">&#39;Apple&#39;</span>, <span class="st">&#39;iPhone SE (3rd)&#39;</span>),</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">12</span>, <span class="dv">2021</span>, <span class="st">&#39;Apple&#39;</span>, <span class="st">&#39;iPhone 13 Pro&#39;</span>),</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">13</span>, <span class="dv">2021</span>, <span class="st">&#39;Apple&#39;</span>, <span class="st">&#39;iPhone 13&#39;</span>);</span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">13</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> products FACET brand FACET <span class="dt">year</span>;</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------------+---------+------+</span></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | title            | brand   | <span class="dt">year</span> |</span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------------+---------+------+</span></span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> | Galaxy S21       | Samsung | <span class="dv">2021</span> |</span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> | Galaxy S21 Plus  | Samsung | <span class="dv">2021</span> |</span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> | Galaxy S21 Ultra | Samsung | <span class="dv">2021</span> |</span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">4</span> | Galaxy S21 FE    | Samsung | <span class="dv">2022</span> |</span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">5</span> | Galaxy S22 Plus  | Samsung | <span class="dv">2022</span> |</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">6</span> | Galaxy S23       | Samsung | <span class="dv">2023</span> |</span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">7</span> | Galaxy S23 FE    | Samsung | <span class="dv">2023</span> |</span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">8</span> | iPhone <span class="dv">15</span> Pro    | Apple   | <span class="dv">2023</span> |</span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">9</span> | iPhone <span class="dv">15</span>        | Apple   | <span class="dv">2023</span> |</span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">10</span> | iPhone <span class="dv">14</span> Plus   | Apple   | <span class="dv">2022</span> |</span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">11</span> | iPhone SE (3rd)  | Apple   | <span class="dv">2022</span> |</span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">12</span> | iPhone <span class="dv">13</span> Pro    | Apple   | <span class="dv">2021</span> |</span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">13</span> | iPhone <span class="dv">13</span>        | Apple   | <span class="dv">2021</span> |</span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------------+---------+------+</span></span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a><span class="dv">13</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+----------+</span></span>
<span id="cb77-42"><a href="#cb77-42" aria-hidden="true" tabindex="-1"></a>| brand   | <span class="fu">count</span>(<span class="op">*</span>) |</span>
<span id="cb77-43"><a href="#cb77-43" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+----------+</span></span>
<span id="cb77-44"><a href="#cb77-44" aria-hidden="true" tabindex="-1"></a>| Samsung |        <span class="dv">7</span> |</span>
<span id="cb77-45"><a href="#cb77-45" aria-hidden="true" tabindex="-1"></a>| Apple   |        <span class="dv">6</span> |</span>
<span id="cb77-46"><a href="#cb77-46" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+----------+</span></span>
<span id="cb77-47"><a href="#cb77-47" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.01</span> sec)</span>
<span id="cb77-48"><a href="#cb77-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-49"><a href="#cb77-49" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb77-50"><a href="#cb77-50" aria-hidden="true" tabindex="-1"></a>| <span class="dt">year</span> | <span class="fu">count</span>(<span class="op">*</span>) |</span>
<span id="cb77-51"><a href="#cb77-51" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb77-52"><a href="#cb77-52" aria-hidden="true" tabindex="-1"></a>| <span class="dv">2021</span> |        <span class="dv">5</span> |</span>
<span id="cb77-53"><a href="#cb77-53" aria-hidden="true" tabindex="-1"></a>| <span class="dv">2022</span> |        <span class="dv">4</span> |</span>
<span id="cb77-54"><a href="#cb77-54" aria-hidden="true" tabindex="-1"></a>| <span class="dv">2023</span> |        <span class="dv">4</span> |</span>
<span id="cb77-55"><a href="#cb77-55" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb77-56"><a href="#cb77-56" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.01</span> sec)</span></code></pre></div>
<p>That isn’t half bad already! And <code>FACET</code> can do much more
than that. Let’s take a look at its formal syntax. Spoiler, it’s a
mini-query on its own.</p>
<div class="sourceCode" id="cb78"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>FACET {expr_list}</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    [<span class="kw">BY</span> {expr_list}]</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    [<span class="kw">ORDER</span> <span class="kw">BY</span> {expr | FACET()} {<span class="kw">ASC</span> | <span class="kw">DESC</span>}]</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    [<span class="kw">LIMIT</span> [offset,] <span class="fu">count</span>]</span></code></pre></div>
<p>Here’s a more elaborate faceting syntax example.</p>
<div class="sourceCode" id="cb79"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> facetdemo</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;Product&#39;</span>) <span class="kw">AND</span> brand_id <span class="kw">BETWEEN</span> <span class="dv">1</span> <span class="kw">AND</span> <span class="dv">4</span> <span class="kw">LIMIT</span> <span class="dv">10</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>FACET brand_name, brand_id <span class="kw">BY</span> brand_id <span class="kw">ORDER</span> <span class="kw">BY</span> brand_id <span class="kw">ASC</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>FACET property <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">DESC</span> <span class="kw">LIMIT</span> <span class="dv">5</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>FACET <span class="dt">INTERVAL</span>(price,<span class="dv">200</span>,<span class="dv">400</span>,<span class="dv">600</span>,<span class="dv">800</span>) bracket <span class="kw">ORDER</span> <span class="kw">BY</span> FACET() <span class="kw">ASC</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>FACET categories <span class="kw">ORDER</span> <span class="kw">BY</span> FACET() <span class="kw">ASC</span> <span class="kw">LIMIT</span> <span class="dv">7</span></span></code></pre></div>
<p>This query seems pretty big at first glance, but hey, it returns 5
result sets, and effectively replaces 5 separate queries. With that in
mind on second glance it’s pretty damn compact!</p>
<p><strong>Facets are indeed concise and fast replacements for extra
grouping queries.</strong> Because facets <em>are</em> just groups after
all. The first facet in the example above <em>can</em> perfectly be
replaced with something like this.</p>
<div class="sourceCode" id="cb80"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a># <span class="dt">long</span> <span class="kw">and</span> slow: extra <span class="kw">query</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> brand_name, brand_id, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FROM</span> facetdemo</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;Product&#39;</span>) <span class="kw">AND</span> brand_id <span class="kw">BETWEEN</span> <span class="dv">1</span> <span class="kw">AND</span> <span class="dv">4</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> brand_id <span class="kw">ORDER</span> <span class="kw">BY</span> brand_id <span class="kw">ASC</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a># short <span class="kw">and</span> <span class="kw">fast</span>: facet</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>FACET brand_name, brand_id <span class="kw">BY</span> brand_id <span class="kw">ORDER</span> <span class="kw">BY</span> brand_id <span class="kw">ASC</span></span></code></pre></div>
<p>So, every <code>FACET</code> sort of replaces the select list,
<code>GROUP BY</code>, and <code>ORDER BY</code> clauses in the original
query, but keeps the <code>WHERE</code> clause. And throws in a bit more
syntax sugar too (an implicit <code>COUNT(*)</code>, an implicit
<code>GROUP BY</code>, etc). That makes it concise.</p>
<p>What makes it fast? <strong>The main query runs just once, facets
reuse its matches.</strong> That’s right, N queries for the price of 1
indeed! Well, that and a little tip, because even though
<code>WHERE MATCH(...) AND ...</code> part only runs once, its results
are processed in N different ways. But that is still <em>much</em>
faster than issuing N full-blown queries.</p>
<p>Now, let’s refresh the syntax once again, and discuss individual
subclauses.</p>
<div class="sourceCode" id="cb81"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>FACET {expr_list}</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    [<span class="kw">BY</span> {expr_list}]</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    [<span class="kw">ORDER</span> <span class="kw">BY</span> {expr | FACET()} {<span class="kw">ASC</span> | <span class="kw">DESC</span>}]</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    [<span class="kw">LIMIT</span> [offset,] <span class="fu">count</span>]</span></code></pre></div>
<p><strong><code>FACET &lt;smth&gt;</code> is a short form for
<code>FACET &lt;smth&gt; BY &lt;smth&gt;</code> full form.</strong> And
yes, in-place expressions <strong>are</strong> supported in facets. No
need to manually plug them into as extra columns to the main query.</p>
<div class="sourceCode" id="cb82"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>FACET brand       # <span class="kw">BY</span> brand</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>FACET brand, <span class="dt">year</span> # <span class="kw">BY</span> brand, <span class="dt">year</span></span></code></pre></div>
<p><strong><code>FACET foo BY bar</code> is equivalent to
<code>SELECT foo, COUNT(*) GROUP BY bar</code>.</strong> Yep, that
should be already clear, but let’s repeat it just a little.</p>
<p><strong>Composite <code>FACET BY</code> is supported, ie. you can
facet by multiple columns.</strong> Here’s an example.</p>
<div class="sourceCode" id="cb83"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> products <span class="kw">LIMIT</span> <span class="dv">1</span> FACET brand, <span class="dt">year</span>;</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------+---------+------+</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | title      | brand   | <span class="dt">year</span> |</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------+---------+------+</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> | Galaxy S21 | Samsung | <span class="dv">2021</span> |</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------+---------+------+</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+----------+</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>| brand   | <span class="dt">year</span> | <span class="fu">count</span>(<span class="op">*</span>) |</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+----------+</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>| Samsung | <span class="dv">2021</span> |        <span class="dv">3</span> |</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>| Samsung | <span class="dv">2022</span> |        <span class="dv">2</span> |</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>| Samsung | <span class="dv">2023</span> |        <span class="dv">2</span> |</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>| Apple   | <span class="dv">2023</span> |        <span class="dv">2</span> |</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>| Apple   | <span class="dv">2022</span> |        <span class="dv">2</span> |</span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>| Apple   | <span class="dv">2021</span> |        <span class="dv">2</span> |</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+----------+</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a><span class="dv">6</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p><strong>Expressions and aliases in <code>FACET</code> and
<code>FACET BY</code> are supported.</strong> As follows.</p>
<div class="sourceCode" id="cb84"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> products <span class="kw">LIMIT</span> <span class="dv">1</span> FACET <span class="dt">year</span>%<span class="dv">100</span> yy <span class="kw">BY</span> <span class="dt">year</span>%<span class="dv">2</span>;</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>| yy   | <span class="fu">count</span>(<span class="op">*</span>) |</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">21</span> |        <span class="dv">9</span> |</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">22</span> |        <span class="dv">4</span> |</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p><strong>The default <code>ORDER BY</code> is currently
<code>WEIGHT() DESC, id ASC</code>.</strong> That’s why Samsung goes
first in our example facets. Simply because its ids are lower.</p>
<blockquote>
<p>WARNING! We might change this order to <code>FACET() ASC</code> in
the future. Please do not rely on the <strong>current</strong> default
and specify an explicit <code>ORDER BY</code> where the order
matters.</p>
</blockquote>
<p><strong>Composite <code>ORDER BY</code> is supported.</strong> As
follows.</p>
<div class="sourceCode" id="cb85"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> products <span class="kw">LIMIT</span> <span class="dv">1</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  FACET brand, <span class="dt">year</span> <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span> <span class="kw">DESC</span>, brand <span class="kw">ASC</span>;</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.  </span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+----------+</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>| brand   | <span class="dt">year</span> | <span class="fu">count</span>(<span class="op">*</span>) |</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+----------+</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>| Apple   | <span class="dv">2023</span> |        <span class="dv">2</span> |</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>| Samsung | <span class="dv">2023</span> |        <span class="dv">2</span> |</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>| Apple   | <span class="dv">2022</span> |        <span class="dv">2</span> |</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>| Samsung | <span class="dv">2022</span> |        <span class="dv">2</span> |</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>| Apple   | <span class="dv">2021</span> |        <span class="dv">2</span> |</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>| Samsung | <span class="dv">2021</span> |        <span class="dv">3</span> |</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+----------+</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a><span class="dv">6</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p><strong><code>ORDER BY</code> supports a special <code>FACET()</code>
function.</strong> So that you can easily sort on what you facet. (For
simple keys, anyway. For composite keys… well, let’s just say it’s
complicated at the moment, and using an explicit <code>ORDER BY</code>
would be best.)</p>
<p><strong><code>LIMIT</code> applies to the <code>FACET</code> result
set.</strong> The default is <code>LIMIT 20</code>, same as in the main
query.</p>
<h3 id="nested-selects-aka-subselects">Nested SELECTs (aka
subselects)</h3>
<p>Regular <code>SELECT</code> queries can be enclosed in another outer
<code>SELECT</code>, thus making a <strong>nested select</strong>, or
less formally speaking, a so-called <strong>subselect</strong>.</p>
<p>(Yes, <em>strictly</em> speaking, “subselect” means inner
<code>SELECT</code>, and the <em>entire</em> double-decker of a query
would ideally only be pompously called “nested select” forever and ever,
filling the meticulous parts of our hearts with endless joy, but guess
how those messy, messssy living languages work. “Subselects” stuck.)</p>
<p>The nested select syntax is as follows.</p>
<div class="sourceCode" id="cb86"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> (</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="op">..</span>.</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>) [<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="op">&lt;</span>outer_sort<span class="op">&gt;</span>] [<span class="kw">LIMIT</span> <span class="op">&lt;</span>outer_limit<span class="op">&gt;</span>]</span></code></pre></div>
<p><strong>The outer <code>SELECT</code> is intentionally
limited.</strong> It only enables reordering and relimiting. Because
that’s exactly what it’s designed for.</p>
<p><strong>The inner <code>SELECT</code> cannot have facets.</strong> A
single regular result set to reorder and relimit is expected.</p>
<p>The two known use cases here are <strong>reranking</strong> and
<strong>distributed searches</strong>.</p>
<p><strong>Outer sort condition evaluation can be postponed.</strong> As
much as possible, and that enables reranking. Most rows can be sorted in
the inner select using some “fast” condition, then limited, then “slow”
reranked in the outer select.</p>
<div class="sourceCode" id="cb87"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> (</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="kw">id</span>, WEIGHT() fastrank, MYCUSTOMUDF(FACTORS()) slowrank</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> myindex <span class="kw">WHERE</span> MATCH(<span class="st">&#39;and bring me 10 million matches&#39;</span>)</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">OPTION</span> ranker<span class="op">=</span>expr(<span class="st">&#39;...&#39;</span>)</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ORDER</span> <span class="kw">BY</span> fastrank <span class="kw">DESC</span> <span class="kw">LIMIT</span> <span class="dv">1000</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>) <span class="kw">ORDER</span> <span class="kw">BY</span> slowrank <span class="kw">DESC</span> <span class="kw">LIMIT</span> <span class="dv">30</span></span></code></pre></div>
<p><code>fastrank</code> gets computed 10 million times and
<code>slowrank</code> only 1000 times here. Voila, that’s reranking for
you, also known as two-stage ranking. Refer to the <a
href="#ranking-two-stage-ranking">“Ranking: two stage ranking”</a>
section.</p>
<p><strong>Distributed indexes (and agents) only fill the inner
limit.</strong> That enables savings in CPU and/or network traffic.
Because we can request only a few rows from each shard, then bundle them
all together.</p>
<div class="sourceCode" id="cb88"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> (</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="op">..</span>. <span class="kw">FROM</span> sharded_x20 <span class="op">..</span>. <span class="kw">LIMIT</span> <span class="dv">500</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>) <span class="kw">LIMIT</span> <span class="dv">3000</span></span></code></pre></div>
<p>A regular <code>SELECT ... LIMIT 3000</code> would request 3000 rows
from each of the 20 shards, so 60K rows total. This nested select only
requests 500 rows per shard, so only 10K rows total are sent to and
sorted by the master. And chances are pretty high the top-3K rows that
we keep are going to be identical.</p>
<h2 id="using-docstore">Using DocStore</h2>
<p>Storing fields into your indexes is easy, just list those fields in a
<code>stored_fields</code> directive and you’re all set:</p>
<div class="sourceCode" id="cb89"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> mytest</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = rt</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = title</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = content</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">stored_fields</span> = title, content</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># hl_fields = title, content</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span> = gid</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>Let’s check how that worked:</p>
<div class="sourceCode" id="cb90"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">desc</span> mytest;</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+--------+-----------------+------+</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>| Field   | <span class="kw">Type</span>   | Properties      | <span class="kw">Key</span>  |</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+--------+-----------------+------+</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>      | bigint |                 |      |</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>| title   | field  | <span class="kw">indexed</span>, stored |      |</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>| content | field  | <span class="kw">indexed</span>, stored |      |</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>| gid     | uint   |                 |      |</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+--------+-----------------+------+</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">insert</span> <span class="kw">into</span> mytest (<span class="kw">id</span>, title) <span class="kw">values</span> (<span class="dv">123</span>, <span class="st">&#39;hello world&#39;</span>);</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> mytest <span class="kw">where</span> match(<span class="st">&#39;hello&#39;</span>);</span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------+---------+</span></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | gid  | title       | content |</span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------+---------+</span></span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> |    <span class="dv">0</span> | hello world |         |</span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------+---------+</span></span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Yay, original document contents! Not a huge step generally, not for a
database anyway; but a nice improvement for Sphinx which was initially
designed “for searching only” (oh, the mistakes of youth). And DocStore
can do more than that, namely:</p>
<ul>
<li>store indexed fields, <code>store_fields</code> directive</li>
<li>store unindexed fields, <code>stored_only_fields</code>
directive</li>
<li>store precomputed data to speedup snippets, <code>hl_fields</code>
directive</li>
<li>be fine-tuned a little, using <code>docstore_type</code>,
<code>docstore_comp</code>, and <code>docstore_block</code>
directives</li>
</ul>
<p>So DocStore can effectively replace the existing
<code>attr_string</code> directive. What are the differences, and when
to use each?</p>
<p><code>attr_string</code> creates an <em>attribute</em>, which is
uncompressed, and always in RAM. Attributes are supposed to be small,
and suitable for filtering (WHERE), sorting (ORDER BY), and other
operations like that, by the millions. So if you really need to run
queries like <code>... WHERE title='abc'</code>, or in case you want to
update those strings on the fly, you will still need attributes.</p>
<p>But complete original document contents are rather rarely accessed in
<em>that</em> way! Instead, you usually need just a handful of those, in
the order of 10s to 100s, to have them displayed in the final search
results, and/or create snippets. DocStore is designed exactly for that.
It compresses all the data it receives (by default), and tries to keep
most of the resulting “archive” on disk, only fetching a few documents
at a time, in the very end.</p>
<p>Snippets become pretty interesting with DocStore. You can generate
snippets from either specific stored fields, or the entire document, or
a subdocument, respectively:</p>
<div class="sourceCode" id="cb91"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, SNIPPET(title, <span class="kw">QUERY</span>()) <span class="kw">FROM</span> mytest <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello&#39;</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, SNIPPET(DOCUMENT(), <span class="kw">QUERY</span>()) <span class="kw">FROM</span> mytest <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello&#39;</span>)</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, SNIPPET(DOCUMENT({title}), <span class="kw">QUERY</span>()) <span class="kw">FROM</span> mytest <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello&#39;</span>)</span></code></pre></div>
<p>Using <code>hl_fields</code> can accelerate highlighting where
possible, sometimes making snippets <em>times</em> faster. If your
documents are big enough (as in, a little bigger than tweets), try it!
Without <code>hl_fields</code>, SNIPPET() function will have to reparse
the document contents every time. With it, the parsed representation is
compressed and stored into the index upfront, trading off a
not-insignificant amount of CPU work for more disk space, and a few
extra disk reads.</p>
<p>And speaking of disk space vs CPU tradeoff, these tweaking knobs let
you fine-tune DocStore for specific indexes:</p>
<ul>
<li><code>docstore_type = vblock_solid</code> (default) groups small
documents into a single compressed block, up to a given limit: better
compression, slower access</li>
<li><code>docstore_type = vblock</code> stores every document
separately: worse compression, faster access</li>
<li><code>docstore_block = 16k</code> (default) lets you tweak the block
size limit</li>
<li><code>docstore_comp = lz4hc</code> (default) uses LZ4HC algorithm
for compression: better compression, but slower</li>
<li><code>docstore_comp = lz4</code> uses LZ4 algorithm: worse
compression, but faster</li>
<li><code>docstore_comp = none</code> disables compression</li>
</ul>
<h2 id="using-attribute-indexes">Using attribute indexes</h2>
<p>Quick kickoff: we now have <a
href="#create-index-syntax"><code>CREATE INDEX</code> statement</a>
which lets you create secondary indexes, and sometimes (or most of times
even?!) it <em>does</em> make your queries faster!</p>
<div class="sourceCode" id="cb92"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> i1 <span class="kw">ON</span> mytest(<span class="fu">group_id</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="kw">DESC</span> mytest</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytest <span class="kw">WHERE</span> <span class="fu">group_id</span><span class="op">=</span><span class="dv">1</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytest <span class="kw">WHERE</span> <span class="fu">group_id</span> <span class="kw">BETWEEN</span> <span class="dv">10</span> <span class="kw">and</span> <span class="dv">20</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytest <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>) <span class="kw">AND</span> <span class="fu">group_id</span><span class="op">=</span><span class="dv">23</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">INDEX</span> i1 <span class="kw">ON</span> mytest</span></code></pre></div>
<p>Up to 64 attribute indexes per full-text index are currently
supported.</p>
<p>Point reads, range reads, and intersections between
<code>MATCH()</code> and index reads are all intended to work. Moreover,
<code>GEODIST()</code> can also automatically use indexes (see more
below). One of the goals is to completely eliminate the need to insert
“fake keywords” into your index. (Also, it’s possible to <em>update</em>
attribute indexes on the fly, as opposed to indexed text.)</p>
<p>Indexes on JSON keys should also work, but you might need to cast
them to a specific type when creating the index:</p>
<div class="sourceCode" id="cb93"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> j1 <span class="kw">ON</span> mytest(j.<span class="fu">group_id</span>)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> j2 <span class="kw">ON</span> mytest(UINT(j.<span class="dt">year</span>))</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> j3 <span class="kw">ON</span> mytest(<span class="dt">FLOAT</span>(j.latitude))</span></code></pre></div>
<p>The first statement (the one with <code>j1</code> and without an
explicit type cast) will default to <code>UINT</code> and emit a
warning. In the future, this warning might get promoted to a hard error.
Why?</p>
<p>The attribute index <em>must</em> know upfront what value type it
indexes. At the same time the engine can not assume any type for a JSON
field, because hey, JSON! Might not even <em>be</em> a single type
across the entire field, might even change row to row, which is
perfectly legal. So the burden of casting your JSON fields to a specific
indexable type lies with you, the user.</p>
<p>Indexes on MVA (ie. sets of <code>UINT</code> or <code>BIGINT</code>)
should also work:</p>
<div class="sourceCode" id="cb94"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> tags <span class="kw">ON</span> mytest(tags)</span></code></pre></div>
<p>Note that indexes over MVA can only currently improve performance on
either <code>WHERE ANY(mva) = ?</code> or
<code>WHERE ANY(mva) IN (?, ?, ...)</code> types of queries. For “rare
enough” reference values we can read the final matching rows from the
index; that is usually quicker than scanning all rows; and for “too
frequent” values query optimizer will fall back to scanning. Everything
as expected.</p>
<p>However, beware that in <code>ALL(mva)</code> case index will not be
used yet! Because even though technically we could read
<em>candidate</em> rows (the very same ones as in <code>ANY(mva)</code>
cases), and scanning <em>just</em> the candidates could very well be
still quicker that a full scan, there are internal architectural issues
that make such an implementation much more complicated. Given that we
also usually see just the <code>ANY(mva)</code> queries in production,
we postponed the <code>ALL(mva)</code> optimizations. Those might come
in a future release.</p>
<p>Here’s an example where we create an index and speed up
<code>ANY(mva)</code> query from 100 msec to under 1 msec, while
<code>ALL(mva)</code> query still takes 57 msec.</p>
<div class="sourceCode" id="cb95"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, tags <span class="kw">from</span> t1 <span class="kw">where</span> <span class="kw">any</span>(tags)<span class="op">=</span><span class="dv">1838227504</span> <span class="kw">limit</span> <span class="dv">1</span>;</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------------------+</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | tags               |</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------------------+</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">15</span> | <span class="dv">1106984</span>,<span class="dv">1838227504</span> |</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------------------+</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.10</span> sec)</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">create</span> <span class="kw">index</span> tags <span class="kw">on</span> t1(tags);</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">4.66</span> sec)</span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, tags <span class="kw">from</span> t1 <span class="kw">where</span> <span class="kw">any</span>(tags)<span class="op">=</span><span class="dv">1838227504</span> <span class="kw">limit</span> <span class="dv">1</span>;</span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------------------+</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | tags               |</span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------------------+</span></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">15</span> | <span class="dv">1106984</span>,<span class="dv">1838227504</span> |</span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------------------+</span></span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, tags <span class="kw">from</span> t1 <span class="kw">where</span> <span class="kw">all</span>(tags)<span class="op">=</span><span class="dv">1838227504</span> <span class="kw">limit</span> <span class="dv">1</span>;</span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a><span class="kw">Empty</span> <span class="kw">set</span> (<span class="fl">0.06</span> sec)</span></code></pre></div>
<p>For the record, <code>t1</code> test collection had 5 million rows
and 10 million <code>tags</code> values, meaning that
<code>CREATE INDEX</code> which completed in 4.66 seconds was going at
~1.07M rows/sec (and ~2.14M values/sec) indexing rate in this example.
In other words: creating an index is usually fast.</p>
<p>Attribute indexes can be created on both RT and plain indexes,
<code>CREATE INDEX</code> works either way. You can also use <a
href="#create_index-directive"><code>create_index</code></a> config
directive for indexes.</p>
<p>Geosearches with <code>GEODIST()</code> can also benefit quite a lot
from attribute indexes. They can automatically compute a bounding box
(or boxes) around a static reference point, and then process only a
fraction of data using index reads. Refer to <a
href="#searching-geosearches">Geosearches section</a> for more
details.</p>
<h3 id="query-optimizer-and-index-hints">Query optimizer, and index
hints</h3>
<p>Query optimizer is the mechanism that decides, on a per-query basis,
whether to use or to ignore specific indexes to compute the current
query.</p>
<p>The optimizer can usually choose any combination of any applicable
indexes. The specific index combination gets chosen based on cost
estimates. Curiously, that choice is not exactly completely obvious even
when we have just 2 indexes.</p>
<p>For instance, assume that we are doing a geosearch, something like
this:</p>
<div class="sourceCode" id="cb96"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>. <span class="kw">FROM</span> test1</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> (lat <span class="kw">BETWEEN</span> <span class="fl">53.23</span> <span class="kw">AND</span> <span class="fl">53.42</span>) <span class="kw">AND</span> (lon <span class="kw">BETWEEN</span> <span class="op">-</span><span class="fl">6.45</span> <span class="kw">AND</span> <span class="op">-</span><span class="fl">6.05</span>)</span></code></pre></div>
<p>Assume that we have indexes on both <code>lat</code> and
<code>lon</code> columns, and can use them. More, we can get an exact
final result set out of that index pair, without any extra checks
needed. But should we? Instead of using both indexes it is actually
sometimes more efficient to use just one! Because with 2 indexes, we
have to:</p>
<ol type="1">
<li>Perform <code>lat</code> range index read, get X <code>lat</code>
candidate rowids</li>
<li>Perform <code>lon</code> range index read, get Y <code>lon</code>
candidate rowids</li>
<li>Intersect X and Y rowids, get N matching rowids</li>
<li>Lookup N resulting rows</li>
<li>Process N resulting rows</li>
</ol>
<p>While when using 1 index on <code>lat</code> we only have to:</p>
<ol type="1">
<li>Perform <code>lat</code> range index read, get X <code>lat</code>
candidate rowids</li>
<li>Lookup X candidate rows</li>
<li>Perform X checks for <code>lon</code> range, get N matching
rows</li>
<li>Process N resulting rows</li>
</ol>
<p>Now, <code>lat</code> and <code>lon</code> frequently are somewhat
correlated. Meaning that X, Y, and N values can all be pretty close. For
example, let’s assume we have 11K matches in that specific latitude
range, 12K matches in longitude range, and 10K final matches, ie.
<code>X = 11000, Y = 12000, N = 10000</code>. Then using just 1 index
means that we can avoid reading 12K <code>lat</code> rowids and then
intersecting 23K rowids, introducing, however, 2K extra row lookups and
12K <code>lon</code> checks instead. Guess what, row lookups and extra
checks are actually cheaper operations, and we are doing less of them.
So with a few quick estimates, using only 1 index out of 2 applicable
ones suddenly looks like a better bet. That can be indeed confirm on
real queries, too.</p>
<p>And that’s exactly how the optimizer works. Basically, it checks
multiple possible index combinations, tries to estimate the associated
query costs, and then picks the best one it finds.</p>
<p>However, the number of possible combinations grows explosively with
the attribute index count. Consider a rather crazy (but possible) case
with as many as 20 applicable indexes. That means more than 1 million
possible “on/off” combinations. Even quick estimates for <em>all</em> of
them would take too much time. There are internal limits in the
optimizer to prevent that. Which in turn means that eventually some
“ideal” index set might not get selected. (But, of course, that is a
rare situation. Normally there are just a few applicable indexes, say
from 1 to 10, so the optimizer can afford “brute forcing” up to 1024
possible index combinations, and does so.)</p>
<p>Now, perhaps even worse, both the count and cost estimates are just
that, ie. only estimates. They might be slightly off, or way off. The
actual query costs might be somewhat different than estimated when we
execute the query.</p>
<p>For those reasons, optimizer might occasionally pick a suboptimal
query plan. In that event, or perhaps just for testing purposes, you can
tweak its behavior with <code>SELECT</code> hints, and make it forcibly
use or ignore specific attribute indexes. For a reference on the exact
syntax and behavior, refer to <a href="#index-hints-clause">“Index hints
clause”</a>.</p>
<h3 id="create-and-drop-index-performance">CREATE and DROP index
performance</h3>
<p>DISCLAIMER: your mileage may vary <em>enormously</em> here, because
there are many contributing factors. Still, we decided to provide at
least <em>some</em> performance datapoints.</p>
<p>Core count is not a factor because index creation and removal are
both single-threaded in v.3.4 that we used for these benchmarks.</p>
<p><strong>Scenario 1</strong>, index with ~38M rows, ~20 columns,
taking ~13 GB total. Desktop with 3.7 GHz CPU, 32 GB RAM, SATA3 SSD.</p>
<p><code>CREATE INDEX</code> on an <code>UINT</code> column with a few
(under 1000) distinct values took around 4-5 sec; on a pretty unique
<code>BIGINT</code> column with ~10M different values it took 26-27
sec.</p>
<p><code>DROP INDEX</code> took 0.1-0.3 sec.</p>
<h3 id="using-universal-index">Using universal index</h3>
<p><strong>Universal index</strong> is a special secondary index type
that only accelerates searches with <strong>equality checks</strong>
(ie. <code>WHERE key=value</code> queries). And it comes with a
superpower. It supports <strong>arbitrary keys per index</strong>,
indexing <strong>many</strong> columns or JSON keys, all at once. Hence
the “universal” name. Eeaao!</p>
<p>And “many” means “really many” as there are no built-in limits.
Unlike regular secondary indexes that only index 1 key (and are limited
to 64 per FT-index), universal index can index literally
<strong>thousands</strong> (or even millions) different columns and JSON
keys for you. This is great for sparse data models.</p>
<p>For example, what if we have 200 different document (aka product)
types, and store JSONs with 5 unique keys per document type? That isn’t
even really much (production data models can get even bigger), but
yields 1000 unique JSON keys in our entire dataset. And we can’t have
1000 different indexes, only 64.</p>
<p>But we can have just 1 universal index handle all those 1000 JSON
keys!</p>
<p>Universal index was designed for indexing <strong>JSON keys</strong>,
hence the support for arbitrary many keys, but it supports
<strong>regular columns</strong> too.</p>
<p>The indexed <strong>values</strong> stored in those JSON keys and/or
regular columns must either be integers (formally “integral values”) or
strings. That means <code>BOOL</code>, <code>UINT</code>,
<code>BIGINT</code>, <code>UINT_SET</code>, <code>BIGINT_SET</code>, and
<code>STRING</code> in Sphinx lingo.</p>
<p>To enable the universal index via the config file, list the
attributes to index in the <code>universal_attrs</code> directive, and
that’s it. Here’s an example.</p>
<div class="sourceCode" id="cb97"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> univtest</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span>            = rt</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span>           = title</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_string</span>     = category</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span>       = gid</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_json</span>       = params</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint_set</span>   = mva32</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_float</span>      = not_in_universal_index1</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_blob</span>       = not_in_universal_index2</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">universal_attrs</span> = category, gid, params, mva32</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>This creates an universal index on the 4 specified attributes. What’s
most important, within the JSON attribute <code>params</code> this
indexes <strong>all its keys</strong> automatically. So any searches for
exact integer or string matches, such as
<code>WHERE params.foo=123</code> or <code>WHERE params.foo='bar'</code>
will use the index, even though we never ever mention <code>foo</code>
explicitly. Nice!</p>
<p><strong>All JSON subkeys get indexed too.</strong> So queries like
<code>WHERE params.foo.bar=123</code> will also use the index.</p>
<p><strong>Atributes must have a supported attribute type</strong> (that
stores one of the supported <strong>value</strong> types); so it’s
integrals, strings, and JSONs; aka <code>BOOL</code>, <code>UINT</code>,
<code>BIGINT</code>, <code>UINT_SET</code>, <code>BIGINT_SET</code>,
<code>STRING</code>, and <code>JSON</code> column types. Other column
types will fail.</p>
<p>Alternatively, without a config, you can run a
<code>CREATE UNIVERSAL INDEX</code> query online. (Of course, its twin
<code>DROP</code> statement also works.)</p>
<div class="sourceCode" id="cb98"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> UNIVERSAL <span class="kw">INDEX</span> <span class="kw">ON</span> univtest(params, gid);</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> UNIVERSAL <span class="kw">INDEX</span> <span class="kw">ON</span> univtest;</span></code></pre></div>
<p><strong>A non-empty list of attributes is mandatory.</strong> Must
have <em>something</em> to index!</p>
<p><strong>The minimum index size threshold
(<code>attrindex_thresh</code>) applies.</strong> FT-indexes must have
enough data for <em>any</em> secondary index to engage.</p>
<p>As is usual with the config and its
<code>CREATE TABLE IF NOT EXISTS</code> semantics, <strong>changes to
<code>universal_attrs</code> are <em>NOT</em> auto-applied to
pre-existing indexes.</strong> So the <strong>only</strong> way to
include (or remove) attributes into your <strong>pre-existing</strong>
universal index is an online SphinxQL query. Like so.</p>
<div class="sourceCode" id="cb99"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> UNIVERSAL <span class="kw">INDEX</span> <span class="kw">ON</span> univtest <span class="kw">ADD</span> <span class="kw">category</span>;</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> UNIVERSAL <span class="kw">INDEX</span> <span class="kw">ON</span> univtest <span class="kw">DROP</span> params;</span></code></pre></div>
<p>However, when you first add a new <code>universal_attrs</code>
directive, a new universal index should be created on
<code>searchd</code> restart. Just as <code>create_index</code>
directives, it has <code>CREATE INDEX IF NOT EXISTS</code>
semantics.</p>
<p>Last but not least, on startup, we check for config vs index
differences, and report them.</p>
<div class="sourceCode" id="cb100"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ./searchd</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="ex">WARNING:</span> RT index <span class="st">&#39;univtest&#39;</span>, universal index: config vs header mismatch</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">(</span><span class="va">header</span><span class="op">=</span><span class="st">&#39;gid, params&#39;</span>, <span class="va">config</span><span class="op">=</span><span class="st">&#39;category, mva32&#39;</span><span class="kw">);</span> <span class="ex">header</span> takes precedence</span></code></pre></div>
<p><strong>To examine its configuration</strong>, use either the
<code>SHOW INDEX FROM</code> statement, or the <code>DESCRIBE</code>
statement. Universal index has a special <code>$universal</code>
name.</p>
<div class="sourceCode" id="cb101"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW <span class="kw">INDEX</span> <span class="kw">FROM</span> univtest;</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------+-----------+---------------------------+----------+------+------+</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>| Seq  | IndexName  | <span class="kw">IndexType</span> | AttrName                  | ExprType | Expr | Opts |</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------+-----------+---------------------------+----------+------+------+</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>| <span class="dv">0</span>    | $universal | universal | <span class="kw">category</span>,gid,params,mva32 |          |      |      |</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------+-----------+---------------------------+----------+------+------+</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">DESC</span> univtest;</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------+----------+------------+------------+</span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>| Field                   | <span class="kw">Type</span>     | Properties | <span class="kw">Key</span>        |</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------+----------+------------+------------+</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>                      | bigint   |            |            |</span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>| title                   | field    | <span class="kw">indexed</span>    |            |</span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>| <span class="kw">category</span>                | string   |            | $universal |</span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>| gid                     | uint     |            | $universal |</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>| params                  | json     |            | $universal |</span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>| mva32                   | uint_set |            | $universal |</span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>| not_in_universal_index1 | <span class="dt">float</span>    |            |            |</span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>| not_in_universal_index2 | <span class="dt">blob</span>     |            |            |</span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------+----------+------------+------------+</span></span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a><span class="dv">8</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Once we have the universal index, eligible queries (ie. queries with
equality checks and/or IN operators, <em>and</em> with supported values
types) <strong>will</strong> use it. In our running example, we included
<code>params</code> JSON in our universal index, and so we expect
eligible queries like <code>WHERE params.xxx = yyy</code> to use it.
Let’s check.</p>
<blockquote>
<p>NOTE! In the example just below, we change
<code>attrindex_thresh</code> to forcibly enable secondary indexes even
on tiny datasets. Normally, you shouldn’t.</p>
</blockquote>
<div class="sourceCode" id="cb102"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SET</span> <span class="kw">GLOBAL</span> attrindex_thresh<span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> univtest (<span class="kw">id</span>, params) <span class="kw">VALUES</span> (<span class="dv">123</span>, <span class="st">&#39;{&quot;foo&quot;:456}&#39;</span>);</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">EXPLAIN</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> univtest <span class="kw">WHERE</span> params.delivery_type<span class="op">=</span><span class="dv">5</span> \G</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="op">***************************</span> <span class="fl">1.</span> <span class="kw">row</span> <span class="op">***************************</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">Index</span>: univtest</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>AttrIndex:</span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a> Analysis: <span class="kw">Using</span> <span class="kw">attribute</span> <span class="kw">indexes</span> <span class="kw">on</span> <span class="fl">100.00</span>% <span class="kw">of</span> total <span class="kw">data</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">using</span> <span class="kw">on</span> <span class="fl">100.00</span>% <span class="kw">of</span> ram <span class="kw">data</span>, <span class="kw">not</span> <span class="kw">using</span> <span class="kw">on</span> disk <span class="kw">data</span>)</span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a><span class="op">***************************</span> <span class="fl">2.</span> <span class="kw">row</span> <span class="op">***************************</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">Index</span>: univtest</span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>AttrIndex: $universal</span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a> Analysis: <span class="kw">Using</span> <span class="kw">on</span> <span class="fl">100.00</span>% <span class="kw">of</span> ram <span class="kw">data</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Manual ignore/force hints are supported, the syntax is
<code>IGNORE UNIVERSAL INDEX</code> and
<code>FORCE UNIVERSAL INDEX</code> respectively.</p>
<div class="sourceCode" id="cb103"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, foo <span class="kw">FROM</span> rt IGNORE UNIVERSAL <span class="kw">INDEX</span> <span class="kw">WHERE</span> foo<span class="op">=</span><span class="dv">0</span></span></code></pre></div>
<p>Beware that “eligible” queries on JSON values <strong>differ</strong>
from those with regular secondary indexes! <strong>Universal indexes
require omitting the explicit casts.</strong></p>
<blockquote>
<p>WARNING! When migrating from indexes on specific JSON values to
universal index, ensure that you adjust your queries accordingly!</p>
</blockquote>
<p>With a regular B-tree index on an (individual) JSON value, we are
<strong>required</strong> to provide an <strong>explicit type
cast</strong> on the value, both when creating the index and when
searching. Like so.</p>
<div class="sourceCode" id="cb104"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">EXPLAIN</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> univtest <span class="kw">WHERE</span> UINT(params.delivery_type)<span class="op">=</span><span class="dv">5</span>;</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+-----------+---------------------------+</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">Index</span>    | AttrIndex | Analysis                  |</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+-----------+---------------------------+</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>| univtest |           | <span class="kw">Not</span> <span class="kw">using</span> <span class="kw">attribute</span> <span class="kw">index</span> |</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+-----------+---------------------------+</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>However, as the universal index does <strong>not</strong> store
forcibly type-casted values, it does <strong>not</strong> engage for
type-casted queries. Otherwise, it would return plain wrong results
when, say, <code>params.delivery_type</code> stores 5.2 as a float
(likely by mistake, but still). <code>UINT(5.2)</code> casts to 5,
<code>UINT(params.delivery_type) = 5</code> holds, that row must be
returned. But universal index does not even support floats and can’t
return it. Hence it can’t engage.</p>
<p>Also note that universal index only indexes individual values, not
arrays. So conditions like <code>WHERE params.foo[12] = 34</code> can’t
use it either.</p>
<h3 id="universal-index-internals">Universal index internals</h3>
<p>For the really curious, how does it work under the hood?</p>
<p>Universal index is basically a huge dictionary that maps the
key-and-value pairs (index-level keys) to lists of rowids (index-level
values), and stores all that data in a special simplified B-tree.</p>
<p>Index-level keys are essentially <code>K=V</code> strings, such as
literally <code>gid=1234</code> or <code>params.delivery_type=5</code>,
except in a compressed binary format.</p>
<p>Index-level values are lists of 32-bit integers (rowids), and those
are always sorted, and usually compressed. (Very short lists are not
compressed, but longer lists always are.)</p>
<p>This design lets universal index to efficiently support both sparse
JSON keys that only occur in a few rows, and dense JSON keys (and
regular columns) that occur in very many rows. Most writes or updates
only touch a few B-tree pages.</p>
<p>The same tree-based structure is used both for RAM and disk segments.
Disk segments <code>mmap()</code> the index file.</p>
<h2 id="using-annotations">Using annotations</h2>
<p>Sphinx v.3.5 introduces support for a special <strong>annotations
field</strong> that lets you store multiple short “phrases” (aka
annotations) into it, and then match and rank them individually. There’s
also an option to store arbitrary per-annotation payloads as JSON, and
access those based on what individual entries did match.</p>
<p>Annotations are small fragments of text (up to 64 tokens)
<em>within</em> a full-text field that you can later match and rank
separately and individually. (Or not. Regular matching and ranking also
still works.)</p>
<p>Think of a ruled paper page with individual sequentially numbered
lines, each line containing an individual short phrase. That “page” is
our full-text field, its “lines” are the annotations, and you can:</p>
<ol type="1">
<li>run special queries to match the individual “lines”
(annotations);</li>
<li>store per-annotation scores (to JSON), and use the best score for
ranking;</li>
<li>fetch a list of matched annotations numbers;</li>
<li>slice arbitrary JSON arrays using that list.</li>
</ol>
<p>Specific applications include storing multiple short text entries
(like user search queries, or location names, or price lists, etc) while
still having them associated with a single document.</p>
<h3 id="annotations-overview">Annotations overview</h3>
<p>Let’s kick off with a tiny working example. We will use just 2 rows,
store multiple locations names in each, and index those as
annotations.</p>
<div class="sourceCode" id="cb105"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># somewhere in .conf file</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> atest</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = rt</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = annot</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">annot_field</span> = annot</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">annot_eot</span> = EOT</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<div class="sourceCode" id="cb106"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a># our test <span class="kw">data</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">insert</span> <span class="kw">into</span> atest (<span class="kw">id</span>, annot) <span class="kw">values</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>       (<span class="dv">123</span>, <span class="st">&#39;new york EOT los angeles&#39;</span>),</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>       (<span class="dv">456</span>, <span class="st">&#39;port angeles EOT new orleans EOT los cabos&#39;</span>);</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">2</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Matching the <em>individual</em> locations with a regular search
would, as you can guess, be quite a grueling job. Arduous. Debilitating.
Excruciating. Sisyphean. Our keywords are all mixed up! But annotations
are evidently gonna rescue us.</p>
<div class="sourceCode" id="cb107"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span> <span class="kw">from</span> atest <span class="kw">where</span> match(<span class="st">&#39;eot&#39;</span>);</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span> <span class="kw">from</span> atest <span class="kw">where</span> match(<span class="st">&#39;@annot los angeles&quot;&#39;</span>);</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   |</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> |</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+</span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span> <span class="kw">from</span> atest <span class="kw">where</span> match(<span class="st">&#39;@annot new angeles&quot;&#39;</span>);</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>While that query looks regular you can see that it behaves
differently, thanks to <code>@annot</code> being a special
<strong>annotations field</strong> in our example. Note that
<strong>only one annotations field per index</strong> is supported at
this moment.</p>
<p>What’s different exactly?</p>
<p>First, querying for <code>eot</code> did not match anything. Because
we have <code>EOT</code> (case sensitive) configured via
<code>annot_eot</code> as our special separator token. Separators are
only used as boundaries when indexing, to kinda “split” the field into
the individual annotations. But <strong>separators are <em>not</em>
indexed themselves</strong>.</p>
<p>Second, querying for <code>los angeles</code> only matches document
123, but not 456. And that is actually the <em>core</em> annotations
functionality right there, which is matching “within” the individual
entries, not the entire field. Formal wording, <strong>explicitly
matching within the annotations field must only match on just the
individual annotations entries.</strong></p>
<p>Document <code>456</code> mentions both <code>angeles</code> and
<code>los</code> alright, but in two different entries, in two different
individual annotations that we had set apart using the <code>EOT</code>
separator. Hence, no match.</p>
<p>Mind, that only happens when we <strong>explicitly</strong> search in
the annotations field, calling it by name. <strong>Implicit matching in
annotations field works as usual.</strong></p>
<div class="sourceCode" id="cb108"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span> <span class="kw">from</span> atest <span class="kw">where</span> match(<span class="st">&#39;los angeles&quot;&#39;</span>);</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   |</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> |</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">456</span> |</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p><strong>Explicit multi-field searches also trigger the “annotations
matching” mode.</strong> Those must match as usual in the regular
fields, but only match individual entries in the annotations field.</p>
<div class="sourceCode" id="cb109"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>. <span class="kw">where</span> match(<span class="st">&#39;@(title,content,annot) hello world&#39;</span>)</span></code></pre></div>
<p>Another thing, <strong>only BOW (bag-of-words) syntax without
operators</strong> is supported in the explicit annotations query
“blocks” at the moment. But that affects just those <em>blocks</em>,
just the parts that explicitly require special matching in the special
fields, not even the rest of the query. Full-text operators are still
good anywhere <em>else</em> in the query. That includes combining
multiple annotations blocks using boolean operators.</p>
<div class="sourceCode" id="cb110"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a># ERROR, operators <span class="kw">in</span> @annot <span class="kw">block</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>. <span class="kw">where</span> match(<span class="st">&#39;@annot hello | world&#39;</span>);</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>. <span class="kw">where</span> match(<span class="st">&#39;@annot hello &lt;&lt; world&#39;</span>);</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a># okay, operators outside blocks are ok</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>. <span class="kw">where</span> match(<span class="st">&#39;(@annot black cat) | (@title white dog)&#39;</span>)</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>. <span class="kw">where</span> match(<span class="st">&#39;(@annot black cat) | (@annot white dog)&#39;</span>)</span></code></pre></div>
<p>The two erroneous queries above will fail with an “only AND operators
are supported in annotations field searches” message.</p>
<p><strong>All BOW keywords must match in the explicit “annotations
matching” mode.</strong> Rather naturally, if we’re looking for a
<code>black cat</code> in an individual <em>entry</em>, matching on
<code>black</code> in entry one and <code>cat</code> in entry two isn’t
what we want.</p>
<p>On a side note, analyzing the query tree to forbid the nested
operators seems trivial at the first glance, but it turned out
surprisingly difficult to implement (so many corner cases). So in the
initial v.3.5 roll-out some of the operators may still slip and get
accepted, even within the annotations block. Please do
<strong>not</strong> rely on that. That is <strong>not</strong>
supported.</p>
<p><strong>You can access the matched annotations numbers</strong> via
the <code>ANNOTS()</code> function and <strong>you can slice JSON arrays
with those numbers</strong> via its <code>ANNOTS(j.array)</code>
variant. So you can store arbitrary per-entry metadata into Sphinx, and
fetch a metadata slice with just the matched entries.</p>
<p>Case in point, assume that your documents are phone models, and your
annotations are phone specs like “8g/256g pink”, and you need prices,
current stocks, etc for every individual spec. You can store those
per-spec values as JSON arrays, match for “8g 256g” on a per-spec basis,
and fetch just the matched prices.</p>
<div class="sourceCode" id="cb111"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> ANNOTS(j.prices), ANNOTS(j.stocks) <span class="kw">FROM</span> phone_models</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;@spec 8g 256g&#39;</span>) <span class="kw">AND</span> <span class="kw">id</span><span class="op">=</span><span class="dv">123</span></span></code></pre></div>
<p>And, of course, as all the per-entry metadata here is stored in a
regular JSON attribute, you can easily update it on the fly.</p>
<p>Last but not least, <strong>you can assign optional per-entry scores
to annotations</strong>. Briefly, you store scores in a JSON array, tag
it as a special “scores” one, and the max score over matched entries
becomes an <code>annot_max_score</code> ranking signal.</p>
<p>That’s it for the overview, more details and examples below.</p>
<h3 id="annotations-index-setup">Annotations index setup</h3>
<p>The newly added per-index config directives are
<code>annot_field</code>, <code>annot_eot</code>, and
<code>annot_scores</code>. The latter one is optional, needed for
ranking (not matching), we will discuss that a bit later. The first two
are mandatory.</p>
<p>The <code>annot_field</code> directive takes a single field name. We
currently support just one annotations field per index at the moment,
seems both easier and sufficient.</p>
<p>The <code>annot_eot</code> directive takes a raw separator token. The
“EOT” is not a typo, it just means “end of text” (just in case you’re
curious). The separator token is intentionally case-sensitive, so be
careful with that.</p>
<p>For the record, we also toyed with an idea using just newlines or
other special characters for the separators, but that quickly proved
incovenient and fragile.</p>
<p>To summarize, the minimal extra config to add an annotations fields
is just two extra lines. Pick a field, pick a separator token, and
you’re all set.</p>
<div class="sourceCode" id="cb112"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> atest</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">annot_field</span> = annot</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">annot_eot</span> = EOT</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>Up to 64 tokens per annotation are indexed. Any remaining tokens are
thrown away.</p>
<p>Individual annotations are numbered sequentially in the field,
starting from 0. Multiple EOT tokens are allowed. They create empty
annotations entries (that will never ever match). So in this example our
two non-empty annotations entries get assigned numbers 0 and 3, as
expected.</p>
<div class="sourceCode" id="cb113"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">insert</span> <span class="kw">into</span> atest (<span class="kw">id</span>, annot) <span class="kw">values</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> (<span class="dv">123</span>, <span class="st">&#39;hello cat EOT EOT EOT hello dog&#39;</span>);</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, annots() <span class="kw">from</span> atest <span class="kw">where</span> match(<span class="st">&#39;@annot hello&#39;</span>);</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | annots() |</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | <span class="dv">0</span>,<span class="dv">3</span>      |</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="annotations-scores">Annotations scores</h3>
<p>You can (optionally) provide your own custom per-annotation scores,
and use those for ranking. For that, you just store an array of
per-entry scores into JSON, and mark that JSON array using the
<code>annot_scores</code> directive. Sphinx will then compute
<code>annot_max_score</code>, the max score over all the matched
annotations, and return it in <code>FACTORS()</code> as a document-level
ranking signal. That’s it, but of course there are a few more boring
details to discuss.</p>
<p>The <code>annot_scores</code> directive currently takes any top-level
JSON key name. (We may add support for nested keys in the future.)
Syntax goes as follows.</p>
<div class="sourceCode" id="cb114"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in general</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="ex">annot_scores</span> = <span class="op">&lt;</span>json_attr<span class="op">&gt;</span>.<span class="op">&lt;</span>scores_array<span class="op">&gt;</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="co"># for example</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="ex">annot_scores</span> = j.scores</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a><span class="co"># ERROR, illegal, not a top-level key</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a><span class="ex">annot_scores</span> = j.sorry.maybe.later</span></code></pre></div>
<p>For performance reasons, all scores must be floats. So the JSON
arrays must be float vectors. When in doubt, either use the
<code>DUMP()</code> function to check that, or just always use the
<code>float[...]</code> syntax to enforce that.</p>
<div class="sourceCode" id="cb115"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> atest (<span class="kw">id</span>, annot, j) <span class="kw">VALUES</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>(<span class="dv">123</span>, <span class="st">&#39;hello EOT world&#39;</span>, <span class="st">&#39;{&quot;scores&quot;: float[1.23, 4.56]}&#39;</span>)</span></code></pre></div>
<p>As the scores are just a regular JSON attribute, you can add, update,
or remove them on the fly. So you can make your scores dynamic.</p>
<p>You can also manage to “break” them, ie. store a scores array with a
mismatching length, or wrong (non-float) values, or not even an array,
etc. That’s fine too, there are no special safeguards or checks against
that. Your data, your choice. Sphinx will simply ignore missing or
unsupported scores arrays when computing the
<code>annot_max_score</code> and return a zero.</p>
<p>The score array of a mismatching length is <em>not</em> ignored
though. The scores that <em>can</em> be looked up in that array
<em>will</em> be looked up. So having just 3 scores is okay even if you
have 5 annotations entries. And vice versa.</p>
<p>In addition, regular scores should be non-negative (greater or equal
to zero), so the negative values will also be effectively ignored. For
example, a scores array with all-negative values like
<code>float[-1,-2,-3]</code> will always return a zero in the
<code>annot_max_score</code> signal.</p>
<p>Here’s an example that should depict (or at least sketch!) one of the
intended usages. Let’s store additional keywords (eg. extracted from
query logs) as our annotations. Let’s store per-keyword CTRs (click
through ratios) as our scores. Then let’s match through both regular
text and annotations, and pick the best CTR for ranking purposes.</p>
<div class="sourceCode" id="cb116"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> scored</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">annot_field</span> = annot</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">annot_eot</span> = EOT</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">annot_scores</span> = j.scores</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<div class="sourceCode" id="cb117"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> scored (<span class="kw">id</span>, title, annot, j) <span class="kw">VALUES</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">123</span>, <span class="st">&#39;samsung galaxy s22&#39;</span>,</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;flagship EOT phone&#39;</span>, <span class="st">&#39;{&quot;scores&quot;: [7.4f, 2.7f]}&#39;</span>),</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">456</span>, <span class="st">&#39;samsung galaxy s21&#39;</span>,</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;phone EOT flagship EOT 2021&#39;</span>, <span class="st">&#39;{&quot;scores&quot;: [3.9f, 2.9f, 5.3f]}&#39;</span>),</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">789</span>, <span class="st">&#39;samsung galaxy a03&#39;</span>,</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;cheap EOT phone&#39;</span>, <span class="st">&#39;{&quot;scores&quot;: [5.3f, 2.1f]}&#39;</span>)</span></code></pre></div>
<p>Meaning that according to our logs these Samsung models get (somehow)
found when searching for either “flagship” or “cheap” or “phone”, with
the respective CTRs. Now, consider the following query.</p>
<div class="sourceCode" id="cb118"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, title, FACTORS() <span class="kw">FROM</span> scored</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;flagship samsung phone&#39;</span>)</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> ranker<span class="op">=</span>expr(<span class="st">&#39;1&#39;</span>)</span></code></pre></div>
<p>We match the 2 flagship models (S21 and S22) on the extra annotations
keywords, but that’s not important. A regular field would’ve worked just
as well.</p>
<p>But! Annotations scores yield an extra ranking signal here.
<code>annot_max_score</code> picks the best score over the actually
matched entries. We get 7.4 for document 123 from the
<code>flagship</code> entry, and 3.9 for document 456 from the
<code>phone</code> entry. That’s the max score over all the matched
annotations, as promised. Even though the <em>annotations</em> matching
only happened on 1 keyword out of 3 keywords total.</p>
<div class="sourceCode" id="cb119"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="op">***************************</span> <span class="fl">1.</span> <span class="kw">row</span> <span class="op">***************************</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>           <span class="kw">id</span>: <span class="dv">123</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>        title: samsung galaxy s22</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>pp(factors()): { <span class="op">..</span>.</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">&quot;annot_max_score&quot;</span>: <span class="fl">7.4</span>, <span class="op">..</span>.</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a><span class="op">***************************</span> <span class="fl">2.</span> <span class="kw">row</span> <span class="op">***************************</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>           <span class="kw">id</span>: <span class="dv">456</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>        title: samsung galaxy s21</span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>pp(factors()): { <span class="op">..</span>.</span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>  <span class="ot">&quot;annot_max_score&quot;</span>: <span class="fl">3.9</span>, <span class="op">..</span>.</span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>And that’s obviously a useful signal. In fact, in this example it
could even make <em>all</em> the difference between S21 and S22.
Otherwise those documents would be pretty much indistinguishable with
regards to the “flagship phone” query.</p>
<p>However, beware of annotations syntax, and how it affects the regular
matching! Suddenly, the following query matches… absolutely nothing.</p>
<div class="sourceCode" id="cb120"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, title, FACTORS() <span class="kw">FROM</span> scored</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;@(title,annot) flagship samsung phone&#39;</span>)</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> ranker<span class="op">=</span>expr(<span class="st">&#39;1&#39;</span>)</span></code></pre></div>
<p>How come? Our matches just above happened in exactly the
<code>title</code> and <code>annot</code> fields anyway, the only thing
we added was a simple field limit, surely the matches must stay the
same, and this must be a bug?</p>
<p>Nope. Not a bug. Because that <code>@annot</code> part is
<em>not</em> a mere field limit anymore with annotations on. Once we
<em>explicitly</em> mention the annotations field, we also engage the
special “match me the entry” mode. Remember, all BOW keywords must match
in the explicit “annotations matching” mode. And as we do <em>not</em>
have any documents with <em>all</em> the 3 keywords in any of the
annotations entries, oops, zero matches.</p>
<h3 id="accessing-matched-annotations">Accessing matched
annotations</h3>
<p>You can access the per-document lists of matched annotations via the
<code>ANNOTS()</code> function. There are currently two ways to use
it.</p>
<ol type="1">
<li><code>ANNOTS()</code> called without arguments returns a
comma-separated list of the matched annotations entries indexes. The
indexes are 0-based.</li>
<li><code>ANNOTS(&lt;json_array&gt;)</code> called with a single JSON
key argument returns the array slice with just the matched
elements.</li>
</ol>
<p>So you can store arbitrary per-annotation payloads either externally
and grab just the payload indexes from Sphinx using the
<code>ANNOTS()</code> syntax, or keep them internally in Sphinx as a
JSON attribute and fetch them directly using the JSON slicing syntax.
Here’s an example.</p>
<div class="sourceCode" id="cb121"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> atest (<span class="kw">id</span>, annot, j) <span class="kw">VALUES</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> (<span class="dv">123</span>, <span class="st">&#39;apples EOT oranges EOT pears&#39;</span>,</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="st">&#39;{&quot;payload&quot;:[&quot;red&quot;, &quot;orange&quot;, &quot;yellow&quot;]}&#39;</span>);</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> ANNOTS() <span class="kw">FROM</span> atest <span class="kw">WHERE</span> MATCH(<span class="st">&#39;apples pears&#39;</span>);</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>| annots() |</span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>| <span class="dv">0</span>,<span class="dv">2</span>      |</span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+</span></span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> ANNOTS(j.payload) <span class="kw">FROM</span> atest <span class="kw">WHERE</span> MATCH(<span class="st">&#39;apples pears&#39;</span>);</span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------+</span></span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>| annots(j.payload) |</span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------+</span></span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>| [<span class="ot">&quot;red&quot;</span>,<span class="ot">&quot;yellow&quot;</span>]  |</span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------+</span></span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Indexes missing from the array are simply omitted when slicing. If
all indexes are missing, NULL is returned. If the argument is not an
existing JSON key, or not an array, NULL is also returned.</p>
<div class="sourceCode" id="cb122"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, j, ANNOTS(j.payload) <span class="kw">FROM</span> atest <span class="kw">WHERE</span> MATCH(<span class="st">&#39;apples pears&#39;</span>);</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------------------------------+-------------------+</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | j                                     | annots(j.payload) |</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------------------------------+-------------------+</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | {<span class="ot">&quot;payload&quot;</span>:[<span class="ot">&quot;red&quot;</span>,<span class="ot">&quot;orange&quot;</span>,<span class="ot">&quot;yellow&quot;</span>]} | [<span class="ot">&quot;red&quot;</span>,<span class="ot">&quot;yellow&quot;</span>]  |</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">124</span> | {<span class="ot">&quot;payload&quot;</span>:[<span class="ot">&quot;red&quot;</span>,<span class="ot">&quot;orange&quot;</span>]}          | [<span class="ot">&quot;red&quot;</span>]           |</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">125</span> | {<span class="ot">&quot;payload&quot;</span>:{<span class="ot">&quot;foo&quot;</span><span class="ch">:123</span>}}               | <span class="kw">NULL</span>              |</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------------------------------+-------------------+</span></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>As a side note (and for another example) using <code>ANNOTS()</code>
on the scores array discussed in the previous section will return the
matched scores, as expected.</p>
<div class="sourceCode" id="cb123"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, ANNOTS(j.scores) <span class="kw">FROM</span> scored</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">WHERE</span> MATCH(<span class="st">&#39;flagship samsung phone&#39;</span>);</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------------+</span></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | annots(j.scores) |</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------------+</span></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | [<span class="fl">7.4</span>,<span class="fl">2.7</span>]        |</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">456</span> | [<span class="fl">3.9</span>,<span class="fl">2.9</span>]        |</span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------------+</span></span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>However, the <code>annot_max_score</code> signal is still required.
Because the internal expression type returned from
<code>ANNOTS(&lt;json&gt;)</code> is a string, not a “real” JSON object.
Sphinx can’t compute the proper max value from that just yet.</p>
<h3 id="annotation-specific-ranking-factors">Annotation-specific ranking
factors</h3>
<p>Annotations introduce several new ranking signals. At the moment they
all are document-level, as we support just one annotations field per
index anyway. The names are:</p>
<ul>
<li><code>annot_exact_hit</code></li>
<li><code>annot_exact_order</code></li>
<li><code>annot_hit_count</code></li>
<li><code>annot_max_score</code></li>
<li><code>annot_sum_idf</code></li>
</ul>
<p><code>annot_exact_hit</code> is a boolean flag that returns 1 when
there was an exact hit in any of the matched annotations entries, ie. if
there was an entry completely “equal” to what we searched for (in the
annotations field). It’s identical to the regular <code>exact_hit</code>
signal but works on individual annotations entries rather than entire
full-text fields.</p>
<p><code>annot_exact_order</code> is a boolean flag that returns 1 when
all the queried words were matched in the exact order in any of the
annotations entries (perhaps with some extra words in between the
matched ones). Also identical to <code>exact_order</code> over
individual annotations rather than entire fields.</p>
<p><code>annot_hit_count</code> is an integer that returns the number of
different annotation <em>entries</em> matched. Attention, this is the
number of <strong><em>entries</em></strong>, and not the keyword hits
(postings) matched in those entries!</p>
<p>For example, <code>annot_hit_count</code> will be 1 with
<code>@annot one</code> query matched against
<code>one two one EOT two three two</code> field, because exactly one
annotations <em>entry</em> matches, even though two postings match. As a
side note, the number of matched <em>postings</em> (in the entire field)
will still be 2 in this example, of course, and that is available via
the <code>hit_count</code> per-field signal.</p>
<p><code>annot_max_score</code> is a float that returns the max
annotations score over the matched annotations. See <a
href="#annotations-scores">“Annotations scores”</a> section for
details.</p>
<p><code>annot_sum_idf</code> is a float that returns the
<code>sum(idf)</code> over all the unique keywords (not their
occurrences!) that were matched. This is just a convenience copy of the
<code>sum_idf</code> value for the annotations field.</p>
<p>All these signals should appear in the <code>FACTORS()</code> JSON
output based on whether you have an annotations field in your index or
not.</p>
<p>Beware that (just as any other conditional signals) they are
accessible in formulas and UDFs at <em>all</em> times, even for indexes
without an annotations field. The following two signals may return
special NULL values:</p>
<ol type="1">
<li><code>annot_hit_count</code> is -1 when there is no
<code>annot_field</code> at all. 0 means that we do have the annotations
field, but nothing was matched.</li>
<li><code>annot_max_score</code> is -1 when there is no
<code>annot_scores</code> configured at all. 0 means that we do have the
scores generally, but the current value is 0.</li>
</ol>
<h2 id="using-k-batches">Using k-batches</h2>
<p>K-batches (“kill batches”) let you bulk delete older versions of the
documents (rows) when bulk loading new data into Sphinx, for example,
adding a new delta index on top of an older main archive index.</p>
<p>K-batches in Sphinx v.3.x replace k-lists (“kill lists”) from v.2.x
and before. The major differences are that:</p>
<ol type="1">
<li>They are <em>not</em> anonymous anymore.</li>
<li>They are now only applied once on loading. (As oppposed to every
search, yuck).</li>
</ol>
<p>“Not anonymous” means that when loading a new index with an
associated k-batch into <code>searchd</code>, <strong>you now have to
explicitly specify target indexes</strong> that it should delete the
rows from. In other words, “deltas” now <em>must</em> explicitly specify
all the “main” indexes that they want to erase old documents from, at
index-time.</p>
<p>The effect of applying a k-batch is equivalent to running (just once)
a bunch of <code>DELETE FROM X WHERE id=Y</code> queries, for every
index X listed in <code>kbatch</code> directive, and every document id Y
stored in the k-batch. With the index format updates this is now both
possible, <strong>even in “plain” indexes</strong>, and quite efficient
too.</p>
<p>K-batch only gets applied once. After a successful application to all
the target indexes, the batch gets cleared.</p>
<p>So, for example, when you load an index called <code>delta</code>
with the following settings:</p>
<div class="sourceCode" id="cb124"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> delta</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_query_kbatch</span> = SELECT 12 UNION SELECT 13 UNION SELECT 14</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">kbatch</span> = main1, main2</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>The following (normally) happens:</p>
<ul>
<li><code>delta</code> kbatch file is loaded
<ul>
<li>in this example it will have 3 document ids: 12, 13, and 14</li>
</ul></li>
<li>documents with those ids are deleted from <code>main1</code></li>
<li>documents with those ids are deleted from <code>main2</code></li>
<li><code>main1</code>, <code>main2</code> save those deletions to
disk</li>
<li>if all went well, <code>delta</code> kbatch file is cleared</li>
</ul>
<p>All these operations are pretty fast, because deletions are now
internally implemented using a bitmap. So deleting a given document by
id results in a hash lookup and a bit flip. In plain speak, very
quick.</p>
<p>“Loading” can happen either by restarting or rotation or whatever,
k-batches should still try to apply themselves.</p>
<p>Last but not least, you can also use <code>kbatch_source</code> to
avoid explicitly storing all newly added document ids into a k-batch,
instead, you can use <code>kbatch_source = kl, id</code> or just
<code>kbatch_source = id</code>; this will automatically add all the
document ids from the index to its k-batch. The default value is
<code>kbatch_source = kl</code>, that is, to use explicitly provided
docids only.</p>
<h2 id="doing-bulk-data-loads">Doing bulk data loads</h2>
<p>TODO: describe rotations (legacy), RELOAD, ATTACH, etc.</p>
<h2 id="using-json">Using JSON</h2>
<p>For the most part using JSON in Sphinx should be very simple. You
just store pretty much arbitrary JSON in a proper column (aka
attribute). Then you access the necessary keys using a
<code>col1.key1.subkey2.subkey3</code> syntax. Or, you access the array
values using <code>col1.key1[123]</code> syntax. And that’s it.</p>
<p>Here’s a literally 30-second kickoff.</p>
<div class="sourceCode" id="cb125"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">CREATE</span> <span class="kw">TABLE</span> jsontest (<span class="kw">id</span> BIGINT, title FIELD, j JSON);</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> jsontest (<span class="kw">id</span>, j) <span class="kw">VALUES</span> (<span class="dv">1</span>, <span class="st">&#39;{&quot;foo&quot;:&quot;bar&quot;, &quot;year&quot;:2019,</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a><span class="st">  &quot;arr&quot;:[1,2,3,&quot;yarr&quot;], &quot;address&quot;:{&quot;city&quot;:&quot;Moscow&quot;, &quot;country&quot;:&quot;Russia&quot;}}&#39;</span>);</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> j.foo <span class="kw">FROM</span> jsontest;</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------+</span></span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>| j.foo |</span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------+</span></span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>| bar   |</span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------+</span></span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> j.<span class="dt">year</span><span class="op">+</span><span class="dv">10</span>, j.arr[<span class="dv">3</span>], j.address.city <span class="kw">FROM</span> jsontest;</span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+----------+----------------+</span></span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a>| j.<span class="dt">year</span><span class="op">+</span><span class="dv">10</span> | j.arr[<span class="dv">3</span>] | j.address.city |</span>
<span id="cb125-19"><a href="#cb125-19" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+----------+----------------+</span></span>
<span id="cb125-20"><a href="#cb125-20" aria-hidden="true" tabindex="-1"></a>|    <span class="fl">2029.0</span> | yarr     | Moscow         |</span>
<span id="cb125-21"><a href="#cb125-21" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+----------+----------------+</span></span>
<span id="cb125-22"><a href="#cb125-22" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Alright, so Sphinx can store JSON and work with what was stored.</p>
<p><strong>JSON is internally stored in an efficient binary
format.</strong> That’s essential for performance. Keeping the original
text would be horrendously slow.</p>
<p><strong>We currently keep the original key order, because we can, but
buyer beware.</strong> JSON itself does allow arbitrarily key-value
pairs reordering, after all, and the reordered JSON is considered
identical. Some future optimizations <em>may</em> require Sphinx to drop
the original key order.</p>
<p><strong>JSONs (as all other attributes) needs to fit in RAM.</strong>
For speed.</p>
<p><strong>JSONs must be under 4 MB in size (in the internal binary
form).</strong> Of course that’s per single JSON value, ie. every single
column in every single row that we insert into <code>jsontest</code> can
be up to 4 MB.</p>
<p><strong>Arbitrarily complex nested JSONs are supported.</strong>
Objecs, subobjects, arrays of whatever, anything goes. As long as the 4
MB size limit is met.</p>
<p>What else is there to it?</p>
<h3 id="indexing-json-data">Indexing JSON data</h3>
<p>Quick summary, we have a few config directives that tweak JSON
indexing, and a useful <code>DUMP()</code> function to examine the
resulting nitty-gritty. The directives are as follows (default value
goes first in the list).</p>
<ul>
<li><code>json_float = {float | double}</code> controls the default
float storage size;</li>
<li><code>json_autoconv_numbers = {0 | 1}</code> enables auto-converting
string values with numbers in them (such as
<code>{"foo": "3.141"}</code>);</li>
<li><code>json_autoconv_keynames = lowercase</code> enables
auto-lowercasing key names;</li>
<li><code>on_json_attr_error = {ignore_attr | fail_index}</code>
promotes JSON parsing issues from warnings (and a <code>NULL</code>
value) to hard errors.</li>
</ul>
<p>Now, details.</p>
<p><strong>Sphinx JSON defaults to single-precision 32-bit
floats.</strong> Unlike JavaScript, for one, which uses double-precision
64-bit doubles. Using floats is faster and saves RAM, and we find the
reduced precision a non-issue anyway.</p>
<p>However, you can set <code>json_float = double</code> to force the
defaults to doubles, and/or you can use our <a
href="#json-syntax-extensions">JSON syntax extensions</a> that let you
control the precision per-value.</p>
<p><strong>String values can be auto-converted to numbers.</strong> That
helps when, ahem, input data is not ideally formatted.
<code>json_autoconv_numbers = 1</code> adds an extra check that detects
and converts <strong>numbers disguised as strings</strong>, as
follows.</p>
<div class="sourceCode" id="cb126"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a># regular <span class="kw">mode</span>, json_autoconv_numbers <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> jsontest (<span class="kw">id</span>, j) <span class="kw">VALUES</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">123</span>, <span class="st">&#39;{&quot;foo&quot;: 456}&#39;</span>),</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">124</span>, <span class="st">&#39;{&quot;foo&quot;: &quot;789&quot;}&#39;</span>),</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">125</span>, <span class="st">&#39;{&quot;foo&quot;: &quot;3.141592&quot;}&#39;</span>),</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">126</span>, <span class="st">&#39;{&quot;foo&quot;: &quot;3.141592X&quot;}&#39;</span>);</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">3</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, j.foo<span class="op">*</span><span class="dv">10</span> <span class="kw">FROM</span> jsontest;</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | j.foo<span class="op">*</span><span class="dv">10</span> |</span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> |   <span class="fl">4560.0</span> |</span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">124</span> |      <span class="fl">0.0</span> |</span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">125</span> |      <span class="fl">0.0</span> |</span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">126</span> |      <span class="fl">0.0</span> |</span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a># autoconversion <span class="kw">mode</span>, json_autoconv_numbers <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a># (exactly <span class="kw">the</span> same <span class="kw">INSERT</span> skipped)</span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, j.foo<span class="op">*</span><span class="dv">10</span> <span class="kw">FROM</span> jsontest;</span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb126-24"><a href="#cb126-24" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | j.foo<span class="op">*</span><span class="dv">10</span> |</span>
<span id="cb126-25"><a href="#cb126-25" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb126-26"><a href="#cb126-26" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> |   <span class="fl">4560.0</span> |</span>
<span id="cb126-27"><a href="#cb126-27" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">124</span> |   <span class="fl">7890.0</span> |</span>
<span id="cb126-28"><a href="#cb126-28" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">125</span> | <span class="fl">31.41592</span> |</span>
<span id="cb126-29"><a href="#cb126-29" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">126</span> |      <span class="fl">0.0</span> |</span>
<span id="cb126-30"><a href="#cb126-30" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb126-31"><a href="#cb126-31" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p><strong>Keys can be auto-lowercased.</strong> That’s also intended to
help with noisy inputs (because keys are case-sensitive).
<code>json_autoconv_keynames = lowercase</code> enables that.</p>
<p><strong>JSON parsing issues can be handled more strictly, as hard
errors.</strong> By default any JSON parsing failures result in a NULL
value (naturally, because we failed to parse that non-JSON), and a mere
warning.</p>
<div class="sourceCode" id="cb127"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> jsontest (<span class="kw">id</span>, j) <span class="kw">VALUES</span> (<span class="dv">135</span>, <span class="st">&#39;{foo:bar}&#39;</span>);</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected, <span class="dv">1</span> warning (<span class="fl">0.00</span> sec)</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW WARNINGS;</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+------------------------------------------------------+</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>| <span class="kw">Level</span>   | Code | Message                                              |</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+------------------------------------------------------+</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>| warning | <span class="dv">1000</span> | syntax error, unexpected <span class="st">&#39;}&#39;</span>, expecting <span class="st">&#39;[&#39;</span> near <span class="st">&#39;}&#39;</span> |</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+------------------------------------------------------+</span></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> jsontest <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">=</span><span class="dv">135</span>;</span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+</span></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | j    |</span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">135</span> | <span class="kw">NULL</span> |</span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+</span></span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>That’s the default <code>on_json_attr_error = ignore_attr</code> mode
behavior. The other mode, available via
<code>on_json_attr_error = fail_index</code>, is more strict than that.
<strong>Warnings become hard errors.</strong> <code>indexer build</code>
fails the entire index, and <code>searchd</code> fails the entire query
(ie. <code>INSERT</code>, or <code>UPDATE</code>, or whatever).</p>
<div class="sourceCode" id="cb128"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> jsontest (<span class="kw">id</span>, j) <span class="kw">VALUES</span> (<span class="dv">135</span>, <span class="st">&#39;{foo:bar}&#39;</span>);</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>ERROR <span class="dv">1064</span> (<span class="dv">42000</span>): <span class="kw">column</span> j: JSON error: syntax error, unexpected <span class="st">&#39;}&#39;</span>,</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>  expecting <span class="st">&#39;[&#39;</span> near <span class="st">&#39;}&#39;</span></span></code></pre></div>
<p>Closing off, <strong><code>DUMP()</code> lets one examine the
resulting indexed JSON.</strong> Because between configurable
conversions covered above, Sphinx custom syntax extensions and storage
optimizations covered below, and occasional general unpredictability of
typing magics… <code>SELECT jsoncol</code> just never suffices. Never.
Case in point, how would you guess the following values are stored
internally? What <strong>exact</strong> types do they have, how many
bytes per integer do they use?</p>
<div class="sourceCode" id="cb129"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> jsontest <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">=</span><span class="dv">146</span>;</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------------------+</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | j                     |</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------------------+</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">146</span> | {<span class="ot">&quot;a&quot;</span><span class="ch">:1</span>,<span class="ot">&quot;b&quot;</span><span class="ch">:2</span>,<span class="ot">&quot;c&quot;</span>:[<span class="dv">3</span>]} |</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------------------+</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Pesonally, my first intuition would be regular 4-byte integers. My
second guess would be maybe even shorter integers, maybe Sphinx is
tedious and squeezes every possible byte. And both are quite reasonable
ideas, but in reality, it’s always and forever <strong>“impossible to
tell from this output”</strong>. Because look.</p>
<div class="sourceCode" id="cb130"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, <span class="fu">DUMP</span>(j) <span class="kw">FROM</span> jsontest <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">=</span><span class="dv">146</span>;</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------------------------------------------------------+</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | <span class="fu">dump</span>(j)                                                |</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------------------------------------------------------+</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">146</span> | (root){<span class="ot">&quot;a&quot;</span>:(int32)<span class="dv">1</span>,<span class="ot">&quot;b&quot;</span>:(int64)<span class="dv">2</span>,<span class="ot">&quot;c&quot;</span>:(int8_vector)[<span class="dv">3</span>]} |</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------------------------------------------------------+</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Wait, WHAT? Yes, this was specially crafted, but hey, it was
<em>easy</em> to make, with only a few extra keystrokes (using those
pesky syntax extensions).</p>
<div class="sourceCode" id="cb131"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> jsontest (<span class="kw">id</span>, j) <span class="kw">VALUES</span> (<span class="dv">146</span>, <span class="st">&#39;{&quot;a&quot;:1, &quot;b&quot;:2L, &quot;c&quot;:int8[3]}&#39;</span>);</span></code></pre></div>
<p>And it’s not about the syntax extensions, because hey, we can mess up
the types just as easily only using vanilla JSON syntax. Just one extra
SQL query and…</p>
<div class="sourceCode" id="cb132"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">REPLACE</span> <span class="kw">INTO</span> jsontest (<span class="kw">id</span>, j)</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">VALUES</span> (<span class="dv">146</span>, <span class="st">&#39;{&quot;a&quot;:1, &quot;b&quot;:9876543210123}&#39;</span>);</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">UPDATE</span> INPLACE jsontest <span class="kw">SET</span> j.b<span class="op">=</span><span class="dv">2</span> <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">=</span><span class="dv">146</span>;</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, j, <span class="fu">DUMP</span>(j) <span class="kw">FROM</span> jsontest <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">=</span><span class="dv">146</span>;</span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------+-----------------------------------+</span></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | j             | <span class="fu">dump</span>(j)                           |</span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------+-----------------------------------+</span></span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">146</span> | {<span class="ot">&quot;a&quot;</span><span class="ch">:1</span>,<span class="ot">&quot;b&quot;</span><span class="ch">:2</span>} | (root){<span class="ot">&quot;a&quot;</span>:(int32)<span class="dv">1</span>,<span class="ot">&quot;b&quot;</span>:(int64)<span class="dv">2</span>} |</span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------+-----------------------------------+</span></span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>The point is, when you need to <strong>precisely</strong> examine the
actual types, then <code>DUMP()</code>, and only <code>DUMP()</code>, is
your friend. <code>PP(DUMP(..))</code> pretty-printer also helps with
more complex JSONs.</p>
<div class="sourceCode" id="cb133"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, PP(<span class="fu">DUMP</span>(j)) <span class="kw">FROM</span> jsontest <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">=</span><span class="dv">146</span> \G</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="op">***************************</span> <span class="fl">1.</span> <span class="kw">row</span> <span class="op">***************************</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>         <span class="kw">id</span>: <span class="dv">146</span></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>pp(<span class="fu">dump</span>(j)): (root){</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">&quot;a&quot;</span>: (int32)<span class="dv">1</span>,</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">&quot;b&quot;</span>: (int64)<span class="dv">2</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Alright, we now know enough (or even too much) about putting JSON
into Sphinx, let’s proceed to getting it out!</p>
<h3 id="querying-json-columns">Querying JSON columns</h3>
<p><strong>Arbitrary element access (by keys and indexes) is
supported.</strong> We can store arbitrary JSONs, we must be able to
access any element, that only makes sense. Object values are accessed by
key names, array entries by indexes, the usual. That is supported both
in the <code>SELECT</code> items and in <code>WHERE</code> conditions.
So all the following example queries are legal.</p>
<div class="sourceCode" id="cb134"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> j.key1.key2.key3 <span class="kw">FROM</span> jsontest <span class="kw">WHERE</span> j.key1.key2.key3<span class="op">=</span><span class="st">&#39;value&#39;</span>;</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> jsontest <span class="kw">WHERE</span> j.a[<span class="dv">0</span>]<span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> jsontest <span class="kw">WHERE</span> j[<span class="dv">0</span>][<span class="dv">0</span>][<span class="dv">2</span>]<span class="op">=</span><span class="dv">3</span>;</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> jsontest <span class="kw">WHERE</span> j.key1.key2[<span class="dv">123</span>].key3<span class="op">=</span><span class="dv">456</span>;</span></code></pre></div>
<p><strong>Keys are case-sensitive!</strong> <code>j.mykey</code> and
<code>j.MyKey</code> refer to two <strong>different</strong> values.</p>
<p><strong>Numeric object keys are supported.</strong> Meaning that
JSONs like <code>{"123":456}</code> and the respective queries like
<code>SELECT j.123</code> are also legal.</p>
<p><strong>Bracket-style access to objects is supported.</strong> The
following two lines are completely functionally equivalent.</p>
<div class="sourceCode" id="cb135"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> j.key1.key2.key3 <span class="kw">FROM</span> jsontest;</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> j[<span class="st">&#39;key1&#39;</span>][<span class="st">&#39;key2&#39;</span>][<span class="st">&#39;key3&#39;</span>] <span class="kw">FROM</span> jsontest;</span></code></pre></div>
<p>This enables access to keys with spaces and/or other special
characters in them (but there’s more).</p>
<div class="sourceCode" id="cb136"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> j[<span class="st">&#39;keys with spaces {are crazy | do exist}&#39;</span>] <span class="kw">FROM</span> jsontest;</span></code></pre></div>
<p><strong>Bracket-style access supports expressions.</strong> Meaning
that you can access object <em>keys</em> with dynamically selected
values. That includes <em>string</em> values stored in that very
JSON.</p>
<p>For example, the following query is nuts, but legal! <em>And</em> it
will dynamically select 2 out of 3 keys down the path.</p>
<div class="sourceCode" id="cb137"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> j[<span class="kw">id</span>][j.selector[<span class="dv">6</span><span class="op">-</span><span class="dv">2</span><span class="op">*</span><span class="dv">3</span>]][<span class="st">&#39;key1&#39;</span>] <span class="kw">FROM</span> jsontest;</span></code></pre></div>
<p>Bracket-style access to arrays also allows expressions, but given
that those are just indexes, it’s much less crazy.</p>
<div class="sourceCode" id="cb138"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> j.somearray[<span class="kw">id</span><span class="op">+</span><span class="dv">3</span><span class="op">*</span><span class="dv">4</span><span class="op">-</span><span class="dv">1</span>] <span class="kw">FROM</span> jsontest;</span></code></pre></div>
<p><strong>Top-level arrays are supported.</strong> That’s an
awkward-ish use case, but hey, JSON supports it, and so do we.</p>
<div class="sourceCode" id="cb139"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> jsontest <span class="kw">VALUES</span> (<span class="dv">2</span>, <span class="st">&#39;&#39;</span>, <span class="st">&#39;[1, 2, 3, &quot;test&quot;]&#39;</span>);</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> jsontest <span class="kw">WHERE</span> j[<span class="dv">3</span>]<span class="op">=</span><span class="st">&#39;test&#39;</span>;</span></code></pre></div>
<p><strong>Mixed-type arrays are supported.</strong> We just stored
three integers and a string into an array. However, for performance we
do sometimes need the exact opposite: to enforce an uniform type over
the entire array.</p>
<p><strong>Special type-enforcing syntax extensions are
supported.</strong> More on them below, in a dedicated section, but for
now, a quick example.</p>
<div class="sourceCode" id="cb140"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> jsontest <span class="kw">VALUES</span> (<span class="dv">3</span>, <span class="st">&#39;&#39;</span>, <span class="st">&#39;float[1, 2.34, 3, 4]&#39;</span>);</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> jsontest <span class="kw">WHERE</span> j[<span class="dv">3</span>]<span class="op">&gt;</span><span class="dv">3</span>;</span></code></pre></div>
<p><strong><code>IN()</code> function supports JSON values.</strong>
JSON-aware <code>IN()</code> variant can checks whether a value belongs
to a set of either integer or string constants.</p>
<div class="sourceCode" id="cb141"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, <span class="kw">IN</span>(j.someint, <span class="dv">1</span>, <span class="dv">4</span>) <span class="kw">AS</span> cond <span class="kw">FROM</span> jsontest <span class="kw">WHERE</span> cond<span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, <span class="kw">IN</span>(j.somestr, <span class="st">&#39;t1&#39;</span>, <span class="st">&#39;t2&#39;</span>) <span class="kw">AS</span> cond <span class="kw">FROM</span> jsontest <span class="kw">WHERE</span> cond<span class="op">=</span><span class="dv">1</span>;</span></code></pre></div>
<p><strong><code>LEAST(), GREATEST(), and LENGTH()</code> functions
supports JSON arrays.</strong> These are thankfully boring. They
respectively return the minimum value, the maximum, and the array
length, all as expected.</p>
<div class="sourceCode" id="cb142"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">LEAST</span>(j.somearray) <span class="kw">FROM</span> jsontest;</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">LENGTH</span>(j.somearray) <span class="kw">FROM</span> jsontest;</span></code></pre></div>
<p><strong>Aggregates support type-casted JSON values.</strong> Other
expressions do too, but aggregates are special, so worth an explicit
mention.</p>
<div class="sourceCode" id="cb143"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">SUM</span>(<span class="dt">DOUBLE</span>(j.somefloat)) <span class="kw">FROM</span> jsontest;</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">AVG</span>(UINT(j.someint)) <span class="kw">FROM</span> jsontest;</span></code></pre></div>
<p><strong>Existence checks with <code>IS [NOT] NULL</code> are
supported.</strong> They apply to both objects <em>and</em> arrays, and
check for key or index existence respectively.</p>
<div class="sourceCode" id="cb144"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FROM</span> jsontest <span class="kw">WHERE</span> j.foo <span class="kw">IS</span> <span class="kw">NULL</span>;</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> jsontest <span class="kw">WHERE</span> j[<span class="dv">0</span>][<span class="dv">0</span>][<span class="dv">2</span>] <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span>;</span></code></pre></div>
<h3 id="json-syntax-extensions">JSON syntax extensions</h3>
<p>Vanilla JSON syntax is nice and simple, but not always enough. Mostly
for performance reasons. Sometimes we <strong>need</strong> to enforce
specific value types.</p>
<p>For that, we have both Sphinx-specific <strong>JSON syntax
extensions</strong>, and a few related <strong>important internal
implementation details</strong> to discuss. Briefly, those are as
follows:</p>
<ul>
<li>optimized scalar storage (for <code>int8</code>, <code>int32</code>,
<code>int64</code>, <code>bool</code>, <code>float</code>, and
<code>NULL</code> types)</li>
<li>optimized array storage (for <code>int8</code>, <code>int32</code>,
<code>int64</code>, <code>float</code>, <code>double</code>, and
<code>string</code> types)</li>
<li><code>0.0f</code> (and <code>0.0f32</code>) syntax extension for
32-bit float values</li>
<li><code>0.0d</code> (and <code>0.0f64</code>) syntax extension for
64-bit double values</li>
<li><code>0l</code> syntax extension for 64-bit integer values</li>
<li><code>int8[]</code>, <code>int64[]</code>, <code>float[]</code>, and
<code>double[]</code> syntax extensions for 8-bit and 64-bit integer,
32-bit float, and 64-bit double arrays, respectively</li>
</ul>
<p><strong>Optimized storage</strong> means that <em>usually</em> Sphinx
auto-detects the actual value types, both for standalone values and for
arrays, and then uses the smallest storage type that works.</p>
<p>So when a 32-bit (4-byte) integer is enough for a numeric value,
Sphinx would automatically store just that. If that overflows, no need
to worry, Sphinx would just automatically switch to 8-byte integer
values. But with an explicitly specified <code>l</code> suffix there
will always be an 8 byte integer value.</p>
<p>Ditto for arrays. When your arrays contain a mix of actual types,
Sphinx handles that just fine, and stores a generic array where every
element has a different type attached to it. That one shows as
<code>mixed_vector</code> in <code>DUMP()</code> output.</p>
<p>Now, when <em>all</em> the element types match, Sphinx auto-detects
that fact, omits per-element types, and stores an optimized
array-of-somethings instead. Those will show as <code>xxx_vector</code>
(for example <code>int32_vector</code>) in <code>DUMP()</code>
output.</p>
<p>All the built-in functions support all such optimized array types,
and have a special fast codepath to handle them, in a transparent
fashion.</p>
<p>As of v.3.2, array value types that can be optimized that way are
<code>int8</code>, <code>int32</code>, <code>int64</code>,
<code>float</code>, <code>double</code>, and <code>string</code>. This
covers pretty much all the usual numeric types, and therefore all you
have to do to ensure that the optimizations kick in is, well, to only
use one actual type in your data.</p>
<p>So everything is on autopilot, mostly. However, there are several
exceptions to that autopilot rule that still require a tiny bit of
effort from you!</p>
<p><strong>First, there might be a catch with <code>float</code> vs
<code>double</code> types.</strong> Sphinx now uses 32-bit
<code>float</code> by default, starting from v.3.7. But JSON standard
(kinda) pushes for high-precision, 64-bit <code>double</code> type. So
longer bigger values won’t round-trip by default.</p>
<p>We consider that a non-issue. We find that for <strong>all</strong>
our applications <code>float</code> is quite enough, saves both storage
and CPU, and it’s okay to default to float. However, you can still force
Sphinx to default to <code>double</code> storage if really needed. Just
set <code>json_float = double</code> in your config.</p>
<p>Or, you can explicitly specify types on a per-value basis. Sphinx has
a syntax extension for that.</p>
<p>The regular <code>{"scale": 1.23}</code> JSON syntax now stores
either a 4-byte float or an 8-byte double, depending on the
<code>json_float</code> setting. But with an explicit type suffix the
setting does not even apply. So <code>{"scale": 1.23f}</code> always
stores a 4-byte float, and <code>{"scale": 1.23d}</code> an 8-byte
double.</p>
<p>You can also use bigger, longer, and more explicit <code>f32</code>
and <code>f64</code> suffixes, as in <code>{"scale": 1.23f32}</code> and
<code>{"scale": 1.23f64}</code>.</p>
<p><strong>Second, <code>int8</code> arrays must be explicit.</strong>
Even though Sphinx can auto-detect the fact that all your array values
are integers in the -128 to 127 range, and can be stored efficiently
using just 1 byte per value, it does <em>not</em> just make that
assumption, and uses <code>int32</code> type instead.</p>
<p>And this happens because there is no way for Sphinx to tell by
looking at <em>just</em> those values whether you really wanted an
optimized <code>int8</code> vector, or the intent was to just have a
placeholder (filled with either <code>0</code>, or <code>-1</code>, or
what have you) <code>int32</code> vector for future updates. Given that
JSON updates are currently in-place, at this decision point Sphinx
chooses to go with the more conservative but flexible route, and store
an <code>int32</code> vector even for something that could be store more
efficiently like <code>[0, 0, 0, 0]</code>.</p>
<p>To force that vector into super-slim 1-byte values, you <em>have</em>
to use a syntax extension, and use <code>int8[0, 0, 0, 0]</code> as your
value.</p>
<p><strong>Third, watch out for integer vs float mixes.</strong> The
auto-detection happens on a per-value basis. Meaning that an array value
like <code>[1, 2, 3.0]</code> will be marked as mixing two different
types, <code>int32</code> and either <code>float</code> or
<code>double</code> (depending on the <code>json_float</code> setting).
So neither the <code>int32</code> nor (worse) <code>double</code> array
storage optimization can kick in for this particular array.</p>
<p>You can enforce any JSON-standard type on Sphinx here using regular
JSON syntax. To store it as integers, you should simply get rid of that
pesky dot that triggers floats, and use <code>[1, 2, 3]</code> syntax.
For floats, on the contrary, the dot should be everywhere, ie. you
should use <code>[1.0, 2.0, 3.0]</code> syntax.</p>
<p>Finally, for the non-standard <code>float</code> type extension, you
can also use the <code>f</code> suffix, ie.
<code>[1.0f, 2.0f, 3.0f]</code> syntax. But that might be inconvenient,
so you can also use the <code>float[1, 2, 3.0]</code> syntax instead.
Either of these two forms enables Sphinx to auto-convert your vector to
nice and fast optimized floats. Irregardless of the current
<code>json_float</code> setting.</p>
<p>For the record, that also works for doubles,
<code>[1.0d, 2.0d, 3.0d]</code> and <code>double[1,2,3]</code> forms are
both legal syntax too. Also overriding the current
<code>json_float</code> setting.</p>
<p>That was all about the values though. What about the keys?</p>
<p><strong>Keys are stored as is.</strong> Meaning that if you have a
<code>superLongKey</code> in (almost) every single document, that key
will be stored as a plain old text string, and repeated as many times as
there are documents. And all those repetitions would consume some RAM
bytes. Flexible, but not really efficient.</p>
<p>So the rule of thumb is, super-long key names are, well, okay, but
not really great. Just as with regular JSON. Of course, for smaller
indexes the savings might just be negligible. But for bigger ones, you
might want to consider shorter key names.</p>
<p><strong>Keys are limited to 127 bytes.</strong> After that, chop
chop, truncated. (We realize that, say, certain Java identifiers might
fail to fit. Tough luck.)</p>
<h3 id="json-comparison-quirks">JSON comparison quirks</h3>
<p>Comparisons with JSON can be a little tricky when it comes to value
types. Especially the numeric ones, because of all the <code>UINT</code>
vs <code>FLOAT</code> vs <code>DOUBLE</code> jazz. (And, mind you, by
default the floating-point values might be stored either as
<code>FLOAT</code> or <code>DOUBLE</code>.) Briefly, beware that:</p>
<ol type="1">
<li><p>String comparisons are strict, and require the string type.</p>
<p>Meaning that <code>WHERE j.str1='abc'</code> check must only pass
when <em>all</em> the following conditions are true: 1)
<code>str1</code> key exists; 2) <code>str1</code> value type is exactly
<code>string</code>; 3) the value matches.</p>
<p>Therefore, for a sudden <em>integer</em> value compared against a
string constant, for example, <code>{"str1":123}</code> value against a
<code>WHERE j.str1='123'</code> condition, the check will fail. As it
should, there are no implicit conversions here.</p></li>
<li><p>Numeric comparisons against integers match any numeric type, not
just integers.</p>
<p>Meaning that both <code>{"key1":123}</code> and
<code>{"key1":123.0}</code> values must pass the
<code>WHERE j.key1=123</code> check. Again, as expected.</p></li>
<li><p>Numeric comparisons against floats <em>forcibly</em> convert
double values to (single-precision) floats, and roundoff issues may
arise.</p>
<p>Meaning that when you store something like
<code>{"key1":123.0000001d}</code> into your index, then the
<code>WHERE j.key1=123.0</code> check will pass, because roundoff to
<code>float</code> loses that fractional part. However, at the same time
<code>WHERE j.key1=123</code> check will <em>not</em> pass, because
<em>that</em> check will use the original double value and compare it
against the integer constant.</p>
<p>This might be a bit confusing, but otherwise (without roundoff) the
situation would be arguably worse: in an even more counter-intuitive
fashion, <code>{"key1":2.22d}</code> does <em>not</em> pass the
<code>WHERE j.key1&gt;=2.22</code> check, because the reference constant
here is <code>float(2.22)</code>, and then because of rounding,
<code>double(2.22) &lt; float(2.22)</code>!</p></li>
</ol>
<h2 id="using-array-attributes">Using array attributes</h2>
<p>Array attributes let you save a fixed amount of integer or float
values into your index. The supported types are:</p>
<ul>
<li><code>attr_int_array</code> that stores signed 32-bit integers;</li>
<li><code>attr_int8_array</code> that stores signed 8-bit integers (-128
to 127 range);</li>
<li><code>attr_float_array</code> that stores 32-bit floats.</li>
</ul>
<p>To declare an array attribute, use the following syntax in your
index:</p>
<div class="sourceCode" id="cb145"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_{int</span><span class="kw">|</span><span class="ex">int8</span><span class="kw">|</span><span class="ex">float}_array</span> = NAME[SIZE]</span></code></pre></div>
<p>Where <code>NAME</code> is the attribute name, and <code>SIZE</code>
is the array size, in elements. For example:</p>
<div class="sourceCode" id="cb146"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> rt</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = rt</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = title</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = content</span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span> = gid <span class="co"># regular attribute</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_float_array</span> = vec1[5] <span class="co"># 5D array of floats</span></span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_int8_array</span> = vec2[7] <span class="co"># 7D array of small 8-bit integers</span></span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>The array dimensions must be between 2 and 8192, inclusive.</p>
<p>The array gets aligned to the nearest 4 bytes. This means that an
<code>int8_array</code> with 17 elements will actually use 20 bytes for
storage.</p>
<p>The expected input array value for both <code>INSERT</code> queries
and source indexing must be either:</p>
<ul>
<li>a comma or space-separated string with the values;</li>
<li>or an empty string;</li>
<li>or (special case for INT8 arrays only) a string with “base64:”
prefix.</li>
</ul>
<div class="sourceCode" id="cb147"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> rt (<span class="kw">id</span>, vec1) <span class="kw">VALUES</span> (<span class="dv">123</span>, <span class="st">&#39;3.14, -1, 2.718, 2019, 100500&#39;</span>);</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> rt (<span class="kw">id</span>, vec1) <span class="kw">VALUES</span> (<span class="dv">124</span>, <span class="st">&#39;&#39;</span>);</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> rt (<span class="kw">id</span>, vec2) <span class="kw">VALUES</span> (<span class="dv">125</span>, <span class="st">&#39;77, -66, 55, -44, 33, -22, 11&#39;</span>);</span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> rt (<span class="kw">id</span>, vec2) <span class="kw">VALUES</span> (<span class="dv">126</span>, <span class="st">&#39;base64:Tb431CHqCw=&#39;</span>);</span></code></pre></div>
<p>Empty strings will zero-fill the array. Non-empty strings are subject
to strict validation. First, there must be exactly as many values as the
array can hold. So you can not store 3 or 7 values into a 5-element
array. Second, the values ranges are also validated. So you will not be
able to store a value of 1000 into an <code>int8_array</code> because
it’s out of the -128..127 range.</p>
<p>Base64-encoded data string must decode into exactly as many bytes as
the array size is, or that’s an error. Trailing padding is not required,
but overpadding (that is, having over 2 trailing <code>=</code> chars)
also is an error, an invalid array value.</p>
<p>Base64 is only supported for INT8 arrays at the moment. That’s where
the biggest savings are. FLOAT and other arrays are viable too, so once
we start seeing datasets that can benefit from encoding, we can support
those too.</p>
<p>Attempting to <code>INSERT</code> an invalid array value will fail.
For example:</p>
<div class="sourceCode" id="cb148"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> rt (<span class="kw">id</span>, vec1) <span class="kw">VALUES</span> (<span class="dv">200</span>, <span class="st">&#39;1 2 3&#39;</span>);</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>ERROR <span class="dv">1064</span> (<span class="dv">42000</span>): bad <span class="dt">array</span> <span class="fu">value</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> rt (<span class="kw">id</span>, vec1) <span class="kw">VALUES</span> (<span class="dv">200</span>, <span class="st">&#39;1 2 3 4 5 6&#39;</span>);</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>ERROR <span class="dv">1064</span> (<span class="dv">42000</span>): bad <span class="dt">array</span> <span class="fu">value</span></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> rt (<span class="kw">id</span>, vec2) <span class="kw">VALUES</span> (<span class="dv">200</span>, <span class="st">&#39;0, 1, 2345&#39;</span>);</span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>ERROR <span class="dv">1064</span> (<span class="dv">42000</span>): bad <span class="dt">array</span> <span class="fu">value</span></span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> rt (<span class="kw">id</span>, vec2) <span class="kw">VALUES</span> (<span class="dv">200</span>, <span class="st">&#39;base64:AQID&#39;</span>);</span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a>ERROR <span class="dv">1064</span> (<span class="dv">42000</span>): bad <span class="dt">array</span> <span class="fu">value</span></span></code></pre></div>
<p>However, when batch indexing with <code>indexer</code>, an invalid
array value will be reported as a warning, and zero-fill the array, but
it will <strong>not</strong> fail the entire indexing batch.</p>
<p>Back to the special base64 syntax, it helps you save traffic and/or
<em>source</em> data storage for the longer INT8 arrays. We can observe
those savings even in the simple example above, where the longer
<code>77 -66 55 -44 33 -22 11</code> input and the shorter
<code>base64:Tb431CHqCw=</code> one encode absolutely <em>identical</em>
arrays.</p>
<p>The difference gets even more pronounced on longer arrays. Consider
for example this 24D one with a bit of real data (and mind that 24D is
still quite small, actual embeddings would be significantly bigger).</p>
<div class="sourceCode" id="cb149"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* text form */</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;-58 -71 21 -56 -5 40 -8 6 69 14 11 0 -41 -64 -12 56 -8 -48 -35 -21 23 -2 9 -66&#39;</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a><span class="co">/* base64 with prefix, as it should be passed to Sphinx */</span></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;base64:xrkVyPso+AZFDgsA18D0OPjQ3esX/gm+&#39;</span></span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a><span class="co">/* base64 only, eg. as stored externally */</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;xrkVyPso+AZFDgsA18D0OPjQ3esX/gm+&#39;</span></span></code></pre></div>
<p>Both versions take exactly 24 bytes in Sphinx, but the base64 encoded
version can save a bunch of space in your <em>other</em> storages that
you might use (think CSV files, or SQL databases, etc).</p>
<p><code>UPDATE</code> queries should now also support the special
base64 syntax. <code>BULK</code> and <code>INPLACE</code> update types
are good too. INT8 array updates are naturally inplace.</p>
<div class="sourceCode" id="cb150"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> rt <span class="kw">SET</span> vec2 <span class="op">=</span> <span class="st">&#39;base64:Tb431CHqCw=&#39;</span> <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">2</span>;</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="kw">BULK</span> <span class="kw">UPDATE</span> rt (<span class="kw">id</span>, vec2) <span class="kw">VALUES</span> (<span class="dv">2</span>, <span class="st">&#39;base64:Tb431CHqCw=&#39;</span>);</span></code></pre></div>
<p>Last but not least, how to use the arrays from here?</p>
<p>Of course, there’s always storage, ie. you could just fetch arrays
from Sphinx and pass them elsewhere. But native support for these arrays
in Sphinx means that some native processing can happen within Sphinx
too.</p>
<p>At the moment, pretty much the only “interesting” built-in functions
that work on array arguments are <code>DOT()</code>,
<code>L1DIST()</code>, and <code>L2DIST()</code>; so you can compute a
dot product, Manhattan, or (squared) Euclidean distance between an array
and a constant vector. Did we mention embeddings and vector searches?
Yeah, that.</p>
<div class="sourceCode" id="cb151"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, DOT(vec1,FVEC(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>)) d <span class="kw">FROM</span> rt;</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------------+</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | d            |</span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------------+</span></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | <span class="fl">510585.28125</span> |</span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">124</span> |            <span class="dv">0</span> |</span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------------+</span></span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h2 id="using-set-attributes">Using set attributes</h2>
<p><strong>Set attributes</strong> (aka <strong>intsets</strong>) let
you store and work with sets of unique <code>UINT</code> or
<code>BIGINT</code>values. (Another name for these in historical Sphinx
speak is <strong>MVA</strong>, meaning multi-valued attributes.)</p>
<p>Sets are useful to attach <strong>multiple</strong> tags, categories,
locations, editions or whatever else to your documents. You can then
search or group using those sets. The important building blocks are
these.</p>
<ul>
<li><code>attr_uint_set</code> and <code>attr_bigint_set</code> declare
set attributes;</li>
<li><code>sql_query_set</code> and <code>sql_query_set_range</code> let
you join on <code>indexer</code> side;</li>
<li><code>ANY()</code>, <code>ALL()</code>, <code>IN()</code>,
<code>INTERSECT_LEN()</code> and other functions that work with stored
sets.</li>
</ul>
<p>Without further ado, let’s have a tiny tasting set. Less than a case
(sigh).</p>
<div class="sourceCode" id="cb152"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">create</span> <span class="kw">table</span> wines (<span class="kw">id</span> bigint, title field, vintages uint_set);</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.01</span> sec)</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">insert</span> <span class="kw">into</span> wines <span class="kw">values</span></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> (<span class="dv">1</span>, <span class="st">&#39;Mucho Mas&#39;</span>, (<span class="dv">2019</span>, <span class="dv">2022</span>)),</span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> (<span class="dv">2</span>, <span class="st">&#39;Matsu El Picaro&#39;</span>, (<span class="dv">2024</span>, <span class="dv">2023</span>, <span class="dv">2021</span>)),</span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> (<span class="dv">3</span>, <span class="st">&#39;Cape Five Pinotage&#39;</span>, (<span class="dv">2019</span>, <span class="dv">2017</span>, <span class="dv">2023</span>, <span class="dv">2019</span>, <span class="dv">2020</span>));</span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">3</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> wines;</span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------------+</span></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | vintages            |</span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------------+</span></span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> | <span class="dv">2019</span>,<span class="dv">2022</span>           |</span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> | <span class="dv">2021</span>,<span class="dv">2023</span>,<span class="dv">2024</span>      |</span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> | <span class="dv">2017</span>,<span class="dv">2019</span>,<span class="dv">2020</span>,<span class="dv">2023</span> |</span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------------+</span></span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p><strong>Sets store unique values, sorted in the ascending
order.</strong> As we can pretty clearly see. We mentioned 2019 twice
for our pinotage (an intentional dupe), but nope, it only got stored
once.</p>
<p>Let’s get all the wines where we do have the 2023 vintage.</p>
<div class="sourceCode" id="cb153"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> wines <span class="kw">where</span> <span class="kw">any</span>(vintages) <span class="op">=</span> <span class="dv">2023</span>;</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------------+</span></span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | vintages            |</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------------+</span></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> | <span class="dv">2021</span>,<span class="dv">2023</span>,<span class="dv">2024</span>      |</span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> | <span class="dv">2017</span>,<span class="dv">2019</span>,<span class="dv">2020</span>,<span class="dv">2023</span> |</span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------------+</span></span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Let’s get ones where we do <strong>not</strong> have the 2023
vintage.</p>
<div class="sourceCode" id="cb154"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> wines <span class="kw">where</span> <span class="kw">all</span>(vintages)<span class="op">!=</span><span class="dv">2023</span>;</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------+</span></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | vintages  |</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------+</span></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> | <span class="dv">2019</span>,<span class="dv">2022</span> |</span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------+</span></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>In fact, let’s count our available wines per vintage.</p>
<div class="sourceCode" id="cb155"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> groupby() vintage, <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">from</span> wines</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">group</span> <span class="kw">by</span> vintages <span class="kw">order</span> <span class="kw">by</span> vintage <span class="kw">asc</span>;</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+----------+</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>| vintage | <span class="fu">count</span>(<span class="op">*</span>) |</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+----------+</span></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2017</span> |        <span class="dv">1</span> |</span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2019</span> |        <span class="dv">2</span> |</span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2020</span> |        <span class="dv">1</span> |</span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2021</span> |        <span class="dv">1</span> |</span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2022</span> |        <span class="dv">1</span> |</span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2023</span> |        <span class="dv">2</span> |</span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2024</span> |        <span class="dv">1</span> |</span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+----------+</span></span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a><span class="dv">7</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Nice!</p>
<p>Now, what if we’re using <code>indexer</code> instead of RT INSERTs?
Moreover, what if our sets are <strong>not</strong> stored conveniently
(for Sphinx) in each item, but properly normalized into a separate SQL
table? How do we index that?</p>
<p><strong><code>indexer</code> supports both SQL-side storage
approaches.</strong> Whether the vintages are stored within the document
rows or separately, they are easy to index.</p>
<p><strong><code>indexer</code> expects simple space or comma separated
strings for set values.</strong> For example!</p>
<div class="sourceCode" id="cb156"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>sql_query <span class="op">=</span> <span class="kw">select</span> <span class="dv">123</span> <span class="kw">as</span> <span class="kw">id</span>, <span class="st">&#39;2011 1973 1985&#39;</span> <span class="kw">as</span> vintages</span></code></pre></div>
<p>With normalized SQL tables, <strong>you can join and builds sets in
your SQL query.</strong> Like so.</p>
<div class="sourceCode" id="cb157"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="kw">source</span> wines</span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>    # GROUP_CONCAT <span class="kw">is</span> MySQL dialect; <span class="kw">use</span> STRING_AGG <span class="cf">for</span> Postgres</span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">type</span> <span class="op">=</span> mysql</span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>    sql_query <span class="op">=</span> \</span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SELECT</span> w.<span class="kw">id</span>, w.title, GROUP_CONCAT(w2v.<span class="dt">year</span>) <span class="kw">AS</span> vintages \</span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">FROM</span> wines w <span class="kw">JOIN</span> vintages w2v <span class="kw">ON</span> w2v.wine_id<span class="op">=</span>w.<span class="kw">id</span> \</span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">GROUP</span> <span class="kw">BY</span> w.<span class="kw">id</span></span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a><span class="kw">index</span> wines</span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">type</span> <span class="op">=</span> plain</span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">source</span> <span class="op">=</span> wines</span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a>    field <span class="op">=</span> title</span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a>    attr_uint_set <span class="op">=</span> vintages</span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Only, queries like that might be slow on the SQL side, and there’s
another way. <strong>Alternatively, you can make <code>indexer</code>
fetch and join sets itself.</strong> For that, you just need to write 1
extra SQL query to fetch <code>(doc_id, set_entry)</code> pairs and
<code>indexer</code> does the rest.</p>
<div class="sourceCode" id="cb158"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> wines</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = mysql</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_query</span> = SELECT id, title FROM wines</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_query_set</span> = vintages: SELECT wine_id, year FROM w2v</span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>That’s usually faster than SQL-side joins. There’s also an option to
split big slow <code>sql_query_set</code> queries into several
steps.</p>
<div class="sourceCode" id="cb159"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> wines</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = mysql</span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_query</span> = SELECT id, title FROM wines</span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_query_set</span> = vintages: SELECT wine_id, year FROM w2v <span class="dt">\</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>        WHERE id BETWEEN <span class="va">$start</span> AND <span class="va">$end</span></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_query_set_range</span> = vintages: SELECT MIN<span class="er">(</span><span class="ex">wine_id</span><span class="kw">)</span><span class="ex">,</span> MAX<span class="er">(</span><span class="ex">wine_id</span><span class="kw">)</span> <span class="ex">FROM</span> w2v</span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<h2 id="using-blob-attributes">Using blob attributes</h2>
<p>We added <code>BLOB</code> type support in v.3.5 to store variable
length binary data. You can declare blobs using the respective
<code>attr_blob</code> directive in your index. For example, the
following creates a RT index with 1 string and 1 blob column.</p>
<div class="sourceCode" id="cb160"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> rt</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span>        = rt</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span>       = title</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_string</span> = str1</span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_blob</span>   = blob2</span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>The major difference from <code>STRING</code> type is the
<strong>embedded zeroes handling</strong>. Strings auto-convert them to
spaces when storing the string data, because strings are zero-terminated
in Sphinx. (And, for the record, when searching, strings are currently
truncated at the first zero.) Blobs, on the other hand, must store all
the embedded zeroes verbatim.</p>
<div class="sourceCode" id="cb161"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">insert</span> <span class="kw">into</span> rt (<span class="kw">id</span>, str1, blob2) <span class="kw">values</span> (<span class="dv">123</span>, <span class="st">&#39;foo</span><span class="ch">\0</span><span class="st">bar&#39;</span>, <span class="st">&#39;foo</span><span class="ch">\0</span><span class="st">bar&#39;</span>);</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> rt <span class="kw">where</span> str1<span class="op">=</span><span class="st">&#39;foo bar&#39;</span>;</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------+------------------+</span></span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | str1    | blob2            |</span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------+------------------+</span></span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | foo bar | <span class="bn">0x666F6F00626172</span> |</span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------+------------------+</span></span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Note how the <code>SELECT</code> with a space matches the row.
Because the zero within <code>str1</code> was auto-converted during the
<code>INSERT</code> query. And in the <code>blob2</code> column we can
still see the original zero byte.</p>
<p>For now, you can only store and retrieve blobs. Additional blob
support (as in, in <code>WHERE</code> clauses, expressions, escaping and
formatting helpers) will be added later as needed.</p>
<p>The default hex representation (eg. <code>0x666F6F00626172</code>
above) is currently used for client <code>SELECT</code> queries only, to
avoid any potentional encoding issues.</p>
<h2 id="using-mappings">Using mappings</h2>
<p>Mappings are a text processing pipeline part that, basically, lets
you map keywords to keywords. They come in several different flavors.
Namely, mappings can differ:</p>
<ul>
<li>by term count: either “simple” 1:1, or generic “multiword” M:N;</li>
<li>by text processing stage: either pre-morphology, or
post-morphology;</li>
<li>by scope: either global, or document-only.</li>
</ul>
<p>We still differentiate between <strong>1:1 mappings</strong> and
<strong>M:N mappings</strong>, because there is one edge case where we
have to, see below.</p>
<p><strong>Pre-morphology</strong> and <strong>post-morphology</strong>
mappings, or pre-morph and post-morph for short, are applied before and
after morphology respectively.</p>
<p><strong>Document-only</strong> mappings only affect documents while
indexing, and never affect the queries. As opposed to
<strong>global</strong> ones, which affect both documents <em>and</em>
queries.</p>
<p>Most combinations of all these flavors work together just fine, but
with one exception. <strong>At post-morphology stage, only 1:1 mappings
are supported</strong>; mostly for operational reasons. While simply
enabling post-morph M:N mappings at the engine level is trivial,
carefully handling the edge cases in the engine and managing the
mappings afterwards seems hard. Because <em>partial</em> clashes between
multiword pre-morph and post-morph mappings are too fragile to
configure, too complex to investigate, and most importantly, not even
really required for production. All other combinations are
supported:</p>
<table>
<thead>
<tr class="header">
<th>Terms</th>
<th>Stage</th>
<th>Scope</th>
<th>Support</th>
<th>New</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1:1</td>
<td>pre-morph</td>
<td>global</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr class="even">
<td>M:N</td>
<td>pre-morph</td>
<td>global</td>
<td>yes</td>
<td>-</td>
</tr>
<tr class="odd">
<td>1:1</td>
<td>pre-morph</td>
<td>doc-only</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr class="even">
<td>M:N</td>
<td>pre-morph</td>
<td>doc-only</td>
<td>yes</td>
<td>-</td>
</tr>
<tr class="odd">
<td>1:1</td>
<td>post-morph</td>
<td>global</td>
<td>yes</td>
<td>-</td>
</tr>
<tr class="even">
<td>M:N</td>
<td>post-morph</td>
<td>global</td>
<td>-</td>
<td>-</td>
</tr>
<tr class="odd">
<td>1:1</td>
<td>post-morph</td>
<td>doc-only</td>
<td>yes</td>
<td>-</td>
</tr>
<tr class="even">
<td>M:N</td>
<td>post-morph</td>
<td>doc-only</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<p>“New” column means that this particular type is supported now, but
was <em>not</em> supported by the legacy <code>wordforms</code>
directive. Yep, that’s correct! Curiously, simple 1:1 pre-morph mappings
were indeed <em>not</em> easily available before.</p>
<p>Mappings reside in a separate text file (or a set of files), and can
be used in the index with a <code>mappings</code> directive.</p>
<p>You can specify either just one file, or several files, or even OS
patterns like <code>*.txt</code> (the latter should be expanded
according to your OS syntax).</p>
<div class="sourceCode" id="cb162"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> test1</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">mappings</span> = common.txt test1specific.txt map<span class="pp">*</span>.txt</span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>Semi-formal file syntax is as follows. (If it’s too hard, worry not,
there will be an example just a little below.)</p>
<div class="sourceCode" id="cb163"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mappings</span> := line, [line, [...]]</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a><span class="ex">line</span> := {comment <span class="kw">|</span> <span class="ex">mapping}</span></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a><span class="ex">comment</span> := <span class="st">&quot;#&quot;</span>, arbitrary_text</span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a><span class="ex">mapping</span> := input, separator, output, [comment]</span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a><span class="ex">input</span> := [flags], keyword, [keyword, [...]]</span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a><span class="ex">separator</span> := {<span class="st">&quot;=&gt;&quot;</span> <span class="kw">|</span> <span class="st">&quot;&gt;&quot;</span><span class="ex">}</span></span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a><span class="ex">output</span> := keyword, [keyword, [...]]</span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a><span class="ex">flags</span> := [<span class="st">&quot;!&quot;</span>], [<span class="st">&quot;~&quot;</span>]</span></code></pre></div>
<p>So generally mappings are just two lists of keywords (input list to
match, and output list to replace the input with, respectively) with a
special <code>=&gt;</code> separator token between them. Legacy
<code>&gt;</code> separator token is also still supported.</p>
<p>Mappings not marked with any flags are pre-morphology.</p>
<p>Post-morphology mappings are marked with <code>~</code> flag in the
very beginning.</p>
<p>Document-only mappings are marked with <code>!</code> flag in the
very beginning.</p>
<p>The two flags can be combined.</p>
<p>Comments begin with <code>#</code>, and everything from
<code>#</code> to the end of the current line is considered a comment,
and mostly ignored.</p>
<p>Magic <code>OVERRIDE</code> substring anywhere in the comment
suppresses mapping override warnings.</p>
<p>Now to the example! Mappings are useful for a variety of tasks, for
instance: correcting typos; implementing synonyms; injecting additional
keywords into documents (for better recall); contracting certain
well-known phrases (for performance); etc. Here’s an example that shows
all that.</p>
<div class="sourceCode" id="cb164"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co"># put this in a file, eg. mymappings.txt</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="co"># then point Sphinx to it</span></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="co"># mappings = mymappings.txt</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a><span class="co"># fixing individual typos, pre-morph</span></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a><span class="ex">mapings</span> =<span class="op">&gt;</span> mappings</span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a><span class="co"># fixing a class of typos, post-morph</span></span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a><span class="ex">~sucess</span> =<span class="op">&gt;</span> success</span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-12"><a href="#cb164-12" aria-hidden="true" tabindex="-1"></a><span class="co"># synonyms, also post-morph</span></span>
<span id="cb164-13"><a href="#cb164-13" aria-hidden="true" tabindex="-1"></a><span class="ex">~commence</span> =<span class="op">&gt;</span> begin</span>
<span id="cb164-14"><a href="#cb164-14" aria-hidden="true" tabindex="-1"></a><span class="ex">~gobbledygook</span> =<span class="op">&gt;</span> gibberish</span>
<span id="cb164-15"><a href="#cb164-15" aria-hidden="true" tabindex="-1"></a><span class="ex">~lorry</span> =<span class="op">&gt;</span> truck <span class="co"># random comment example</span></span>
<span id="cb164-16"><a href="#cb164-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-17"><a href="#cb164-17" aria-hidden="true" tabindex="-1"></a><span class="co"># global expansions</span></span>
<span id="cb164-18"><a href="#cb164-18" aria-hidden="true" tabindex="-1"></a><span class="ex">e8400</span> =<span class="op">&gt;</span> intel e8400</span>
<span id="cb164-19"><a href="#cb164-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-20"><a href="#cb164-20" aria-hidden="true" tabindex="-1"></a><span class="co"># global contractions</span></span>
<span id="cb164-21"><a href="#cb164-21" aria-hidden="true" tabindex="-1"></a><span class="ex">core</span> 2 duo =<span class="op">&gt;</span> c2d</span>
<span id="cb164-22"><a href="#cb164-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-23"><a href="#cb164-23" aria-hidden="true" tabindex="-1"></a><span class="co"># document-only expansions</span></span>
<span id="cb164-24"><a href="#cb164-24" aria-hidden="true" tabindex="-1"></a><span class="co"># (note that semicolons are for humans, engine will ignore them)</span></span>
<span id="cb164-25"><a href="#cb164-25" aria-hidden="true" tabindex="-1"></a><span class="ex">!united</span> kingdom =<span class="op">&gt;</span> uk<span class="kw">;</span> <span class="ex">united</span> kingdom<span class="kw">;</span> <span class="ex">england</span><span class="kw">;</span> <span class="ex">scotland</span><span class="kw">;</span> <span class="ex">wales</span></span>
<span id="cb164-26"><a href="#cb164-26" aria-hidden="true" tabindex="-1"></a><span class="ex">!grrm</span> =<span class="op">&gt;</span> grrm george martin</span>
<span id="cb164-27"><a href="#cb164-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-28"><a href="#cb164-28" aria-hidden="true" tabindex="-1"></a><span class="co"># override example</span></span>
<span id="cb164-29"><a href="#cb164-29" aria-hidden="true" tabindex="-1"></a><span class="co"># this is useful when using multiple mapping files</span></span>
<span id="cb164-30"><a href="#cb164-30" aria-hidden="true" tabindex="-1"></a><span class="co"># (eg. with different per-category mapping rules)</span></span>
<span id="cb164-31"><a href="#cb164-31" aria-hidden="true" tabindex="-1"></a><span class="ex">e8400</span> =<span class="op">&gt;</span> intel cpu e8400 <span class="co"># OVERRIDE</span></span></code></pre></div>
<h3 id="pre-morph-mappings">Pre-morph mappings</h3>
<p><strong>Pre-morph mappings</strong> are more “precise” in a certain
sense, because they only match specific forms, before any morphological
normalization. For instance, <code>apple trees =&gt; garden</code>
mapping will <em>not</em> kick in for a document mentioning just a
singular <code>apple tree</code>.</p>
<p>Pre-morph mapping outputs are processed further as per index
settings, and so they are <strong>subject to morphology</strong> when
the index has that enabled! For example,
<code>semiramis =&gt; hanging gardens</code> mapping with
<code>stem_en</code> stemmer should result in <code>hang garden</code>
text being stored into index.</p>
<p>To be completely precise, in this example the <em>mapping</em> emits
<code>hanging</code> and <code>gardens</code> tokens, and then the
subsequent <em>stemmer</em> normalizes them to <code>hang</code> and
<code>garden</code> respectively, and then (in the absence of any other
mappings etc), those two tokens are stored in the final index.</p>
<h3 id="post-morph-mappings">Post-morph mappings</h3>
<p>There is one very important caveat about the post-morph mappings.</p>
<p><strong>Post-morph mapping outputs are not morphology
normalized</strong> automatically, only their <strong>inputs</strong>
are. In other words, only the left (input) part is subject to
morphology, the output is stored into the index as is. More or less
naturally too, they are <strong>post</strong> morphology mappings, after
all. Sill, that can very well cause subtle-ish configuration bugs.</p>
<p>For example, <code>~semiramis =&gt; hanging gardens</code> mapping
with <code>stem_en</code> will store <code>hanging gardens</code> into
the index, not <code>hang garden</code>, because no morphology for
outputs.</p>
<p>This is obviously <em>not</em> our intent, right?! We actually want
<code>garden hang</code> query to match documents mentioning either
<code>semiramis</code> or <code>hanging gardens</code>, but with
<em>this</em> configuration, it will only match the former. So for now,
we have to <strong>manually</strong> morph our outputs (no syntax to
automatically morph them just yet). That would be done with a
<code>CALL KEYWORDS</code> statement:</p>
<div class="sourceCode" id="cb165"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">CALL</span> KEYWORDS(<span class="st">&#39;hanging gardens&#39;</span>, <span class="st">&#39;stem_test&#39;</span>);</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------+------------+</span></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>| qpos | tokenized | normalized |</span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------+------------+</span></span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>| <span class="dv">1</span>    | hanging   | hang       |</span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>| <span class="dv">2</span>    | gardens   | garden     |</span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------+------------+</span></span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>So our mapping should be changed to
<code>~semiramis =&gt; hang garden</code> in order to work as expected.
Caveat!</p>
<p>As a side note, both the original and updated mappings also affect
any documents mentioning <code>semirami</code> or
<code>semiramied</code> (because morphology for inputs), but that is
rarely an issue.</p>
<p>Bottom line, keep in mind that <strong>“post-morph mappings = morphed
inputs, but UNMOPRHED outputs”</strong>, configure your mappings
accordingly, and do <em>not</em> forget to morph the outputs if
needed!</p>
<p>In simple cases (eg. when you only use lemmatization) you might
eventually get away with “human” (natural language) normalization. One
might reasonably guess that the lemma for <code>gardens</code> is going
to be just <code>garden</code>, right?! Right.</p>
<p>However, even our simple example is not that simple, because of
innocuously looking <code>hanging</code>, because look how
<code>lemmatize_en</code> <em>actually</em> normalizes those different
forms of <code>hang</code>:</p>
<div class="sourceCode" id="cb166"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">CALL</span> KEYWORDS(<span class="st">&#39;hang hanged hanging&#39;</span>, <span class="st">&#39;lemmatize_test&#39;</span>);</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------+------------+</span></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>| qpos | tokenized | normalized |</span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------+------------+</span></span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>| <span class="dv">1</span>    | hang      | hang       |</span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a>| <span class="dv">2</span>    | hanged    | hang       |</span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a>| <span class="dv">3</span>    | hanging   | hanging    |</span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------+------------+</span></span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>It gets worse with more complex morphology stacks (where multiple
<code>morphdict</code> files, stemmers, or lemmatizers can engage). In
fact, it gets worse with just stemmers. For example, another classic
caveat, <code>stem_en</code> normalizes <code>business</code> to
<code>busi</code> and one would need to use <em>that</em> in the output.
Less easy to guess… Hence the current rule of thumb, run your outputs
through <code>CALL KEYWORDS</code> when configuring, and use the
normalized tokens.</p>
<p>Full disclosure, we consider additional syntax to mark the outputs to
auto-run through morphology (that would be so much easier to use than
having to manually filter through <code>CALL KEYWORDS</code>, right?!)
but that’s not implemented just yet.</p>
<h3 id="document-only-mappings">Document-only mappings</h3>
<p><strong>Document-only mappings</strong> are only applied to documents
at indexing time, and ignored at query time. This is pretty useful for
indexing time expansions, and that is why the <code>grrm</code> mapping
example above maps it to itself too, and not just
<code>george martin</code>.</p>
<p>In the “expansion” usecase, they are more efficient when
<em>searching</em>, compared to similar regular mappings.</p>
<p>Indeed, when searching for a source mapping, regular mappings would
expand to all keywords (in our example, to all 3 keywords,
<code>grrm george martin</code>), fetch and intersect them, and do all
that work for… nothing! Because we can obtain exactly the same result
much more efficiently by simply fetching just the source keywords (just
<code>grrm</code> in our example). And that’s exactly how document-only
mappings work when querying, they just skip the <em>query</em> expansion
altogether.</p>
<p>Now, when searching for (a part of) a destination mapping, nothing
would change. In that case both document-only and regular global
mappings would just execute the query completely identically. So
<code>george</code> must match in any event.</p>
<p>Bottom line, use document-only mappings when you’re doing expansions,
in order to avoid that unnecessary performance hit.</p>
<h2 id="using-morphdict">Using morphdict</h2>
<p><strong>Morphdict</strong> essentially lets you provide your own
(additional) morphology dictionary, ie. specify a list of form-to-lemma
normalizations. You can think of them as of “overrides” or “patches”
that take priority over any other morphology processors. Naturally, they
also are 1:1 only, ie. they <strong>must</strong> map a single
morphological form to a single lemma or stem.</p>
<p>There may be multiple <code>morphdict</code> directives specifying
multiple morphdict files (for instance, with patches for different
languages).</p>
<div class="sourceCode" id="cb167"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> test1</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">morphdict</span> = mymorph_english.txt</span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">morphdict</span> = mymorph_spanish.txt</span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>For example, we can use <code>morphdict</code> to fixup a few
well-known mistakes that the <code>stem_en</code> English stemmer is
known to make.</p>
<div class="sourceCode" id="cb168"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="ex">octopii</span> =<span class="op">&gt;</span> octopus</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="ex">business</span> =<span class="op">&gt;</span> business</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a><span class="ex">businesses</span> =<span class="op">&gt;</span> business</span></code></pre></div>
<p>Morphdict also lets you <strong>specify POS (Part Of Speech)
tags</strong> for the lemmas, using a small subset of Penn syntax. For
example:</p>
<div class="sourceCode" id="cb169"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mumps</span> =<span class="op">&gt;</span> mumps, NN <span class="co"># always plural</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="ex">impignorating</span> =<span class="op">&gt;</span> impignorate, VB</span></code></pre></div>
<p>Simple 1:1 normalizations, optional POS tags, and comments are
everything there is to morphdict. Yep, it’s as simple as that. Just for
the sake of completeness, semi-formal syntax is as follows.</p>
<div class="sourceCode" id="cb170"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="ex">morphdict</span> := line, [line, [...]]</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a><span class="ex">line</span> := {comment <span class="kw">|</span> <span class="ex">entry}</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a><span class="ex">comment</span> := <span class="st">&quot;#&quot;</span>, arbitrary_text</span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a><span class="ex">entry</span> := keyword, separator, keyword, [<span class="st">&quot;,&quot;</span> postag], [comment]</span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a><span class="ex">separator</span> := {<span class="st">&quot;=&gt;&quot;</span> <span class="kw">|</span> <span class="st">&quot;&gt;&quot;</span><span class="ex">}</span></span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a><span class="ex">postag</span> := {<span class="st">&quot;JJ&quot;</span> <span class="kw">|</span> <span class="st">&quot;NN&quot;</span> <span class="kw">|</span> <span class="st">&quot;RB&quot;</span> <span class="kw">|</span> <span class="st">&quot;VB&quot;</span><span class="ex">}</span></span></code></pre></div>
<p>Even though right now POS tags are only used to identify nouns in
queries and then compute a few related ranking signals, we decided to
support a little more tags than that.</p>
<ul>
<li><code>JJ</code>, adjective</li>
<li><code>NN</code>, noun</li>
<li><code>RB</code>, adverb</li>
<li><code>VB</code>, verb</li>
</ul>
<p>Optional POS tags are rather intended to fixup built-in lemmatizer
mistakes. However they should work alright with stemmers too.</p>
<p>When fixing up stemmers you generally have to proceed with extreme
care, though. Say, the following <code>stem_en</code> fixup example will
<em>not</em> work as expected!</p>
<div class="sourceCode" id="cb171"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="ex">geese</span> =<span class="op">&gt;</span> goose</span></code></pre></div>
<p>Problem is, <code>stem_en</code> stemmer (unlike
<code>lemmatize_en</code> lemmatizer) does <em>not</em> normalize
<code>goose</code> to itself. So when <code>goose</code> occurs in the
document text, it will emit <code>goos</code> stem instead. So in order
to fixup <code>stem_en</code> stemmer, you have to map to that
<em>stem</em>, with a <code>geese =&gt; goos</code> entry. Extreme
care.</p>
<h2 id="migrating-legacy-wordforms">Migrating legacy wordforms</h2>
<p>Mappings and morphdict were introduced in v.3.4 in order to replace
the legacy <code>wordforms</code> directive. Both the directive and
older indexes are still supported by v.3.4 specifically, of course, to
allow for a smooth upgrade. However, they are slated for quick
removal.</p>
<p>How to migrate legacy wordforms properly? That depends.</p>
<p>To change the behavior minimally, you should extract 1:1 legacy
wordforms into <code>morphdict</code>, because legacy 1:1 wordforms
replace the morphology. All the other entries can be used as
<code>mappings</code> rather safely. By the way, our loading code for
legacy <code>wordforms</code> works exactly this way.</p>
<p>However, unless you are using legacy wordforms to emulate (or
implement even) morphology, chances are quite high that your 1:1 legacy
wordforms were intended more for <code>mappings</code> rather than
<code>morphdict</code>. In which event you should simply rename
<code>wordforms</code> directive to <code>mappings</code> and that would
be it.</p>
<h2 id="using-udfs">Using UDFs</h2>
<h3 id="udfs-overview">UDFs overview</h3>
<p>Sphinx supports User Defined Functions (or UDFs for short) that let
you extend its expression engine:</p>
<div class="sourceCode" id="cb172"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, attr1, myudf(attr2, attr3<span class="op">+</span>attr4) <span class="op">..</span>.</span></code></pre></div>
<p>You can load and unload UDFs into <code>searchd</code> dynamically,
ie. without having to restart the daemon itself, and then use them in
most expressions when searching and ranking. Quick summary of the UDF
features is as follows.</p>
<ul>
<li>UDFs can accept most of the argument types that Sphinx supports,
namely:
<ul>
<li><strong>numerics</strong>, ie. integers (32-bit and 64-bit) and
floats (32-bit);</li>
<li><strong>MVAs</strong>, ie. sets of integers (32-bit and
64-bit);</li>
<li><strong>strings</strong>, including binary non-ASCIIZ blobs;</li>
<li><strong><code>FACTORS()</code></strong>, ie. special blobs with
ranking signals;</li>
<li><strong>JSON objects</strong>, including subobjects or individual
fields;</li>
<li><strong>float vectors</strong>, including float array
attributes.</li>
</ul></li>
<li>UDFs can return integer, float and string values.</li>
<li>UDFs can also return fixed-width float arrays.</li>
<li>UDFs can check the argument number, types, and names during the
query setup phase, and raise errors.</li>
</ul>
<p>UDFs have a wide variety of uses, for instance:</p>
<ul>
<li>adding custom mathematical or string functions;</li>
<li>accessing the database or files from within Sphinx;</li>
<li>implementing complex ranking functions.</li>
</ul>
<p>UDFs reside in the external dynamic libraries (<code>.so</code> files
on UNIX and <code>.dll</code> on Windows systems). Library files need to
reside in <code>$datadir/plugins</code> folder in datadir mode, for
obvious security reasons: securing a single folder is easy; letting
anyone install arbitrary code into <code>searchd</code> is a risk.</p>
<p>You can load and unload them dynamically into <code>searchd</code>
with <code>CREATE FUNCTION</code> and <code>DROP FUNCTION</code>
SphinxQL statements, respectively. Also, you can seamlessly reload UDFs
(and other plugins) with <code>RELOAD PLUGINS</code> statement. Sphinx
keeps track of the currently loaded functions, that is, every time you
create or drop an UDF, <code>searchd</code> writes its state to the
<code>sphinxql_state</code> file as a plain good old SQL script.</p>
<p>Once you successfully load an UDF, you can use it in your
<code>SELECT</code> or other statements just as any of the built-in
functions:</p>
<div class="sourceCode" id="cb173"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, MYCUSTOMFUNC(groupid, authorname), <span class="op">..</span>. <span class="kw">FROM</span> myindex</span></code></pre></div>
<p>Multiple UDFs (and other plugins) may reside in a single library.
That library will only be loaded once. It gets automatically unloaded
once all the UDFs and plugins from it are dropped.</p>
<p>Aggregation functions are not supported just yet. In other words,
your UDFs will be called for just a single document at a time and are
expected to return some value for that document. Writing a function that
can compute an aggregate value like <code>AVG()</code> over the entire
group of documents that share the same <code>GROUP BY</code> key is not
yet possible. However, you can use UDFs within the built-in aggregate
functions: that is, even though <code>MYCUSTOMAVG()</code> is not
supported yet, <code>AVG(MYCUSTOMFUNC())</code> should work alright!</p>
<p>UDFs are local. In order to use them on a cluster, you have to put
the same library on all its nodes and run proper
<code>CREATE FUNCTION</code> statements on all the nodes too. This might
change in the future versions.</p>
<h3 id="udf-programming-introduction">UDF programming introduction</h3>
<p>The UDF interface is plain C. So you would usually write your UDF in
C or C++. (Even though in theory it might be possible to use other
languages.)</p>
<p>Your very first starting point should be
<code>src/udfexample.c</code>, our example UDF library. That library
implements several different functions, to demonstrate how to use
several different techniques (stateless and stateful UDFs, different
argument types, batched calls, etc).</p>
<p>The files that provide the UDF interface are:</p>
<ul>
<li><code>src/sphinxudf.h</code> that declares the essential types and
helper functions;</li>
<li><code>src/sphinxudf.c</code> that implements those functions.</li>
</ul>
<p>For UDFs that <strong>do not</strong> implement ranking, and
therefore do not need to handle <code>FACTORS()</code> arguments, simply
including the <code>sphinxudf.h</code> header is sufficient.</p>
<p>To be able to parse the <code>FACTORS()</code> blobs from your UDF,
however, you will also need to compile and link with
<code>sphinxudf.c</code> source file.</p>
<p>Both <code>sphinxudf.h</code> and <code>sphinxudf.c</code> are
standalone. So you can copy around those files only. They do not depend
on any other bits of Sphinx source code.</p>
<p>Within your UDF, you should literally implement and export just two
functions.</p>
<p><strong>First</strong>, you must define
<code>int &lt;LIBRARYNAME&gt;_ver() { return SPH_UDF_VERSION; }</code>
in order to implement UDF interface version control.
<code>&lt;LIBRARYNAME&gt;</code> should be replaced with the name of
your library. Here’s an example:</p>
<div class="sourceCode" id="cb174"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sphinxudf.h&gt;</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a><span class="co">// our library will be called udfexample.so, thus, it must define</span></span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a><span class="co">// a version function named udfexample_ver()</span></span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> udfexample_ver<span class="op">()</span></span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> SPH_UDF_VERSION<span class="op">;</span></span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This version checker protects you from accidentally loading libraries
with mismatching UDF interface versions. (Which would in turn usually
cause either incorrect behavior or crashes.)</p>
<p><strong>Second</strong>, you must implement the actual function, too.
For example:</p>
<div class="sourceCode" id="cb175"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>sphinx_int64_t testfunc<span class="op">(</span>SPH_UDF_INIT <span class="op">*</span> init<span class="op">,</span> SPH_UDF_ARGS <span class="op">*</span> args<span class="op">,</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> error_message<span class="op">)</span></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> <span class="dv">123</span><span class="op">;</span></span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>UDF function names in SphinxQL are case insensitive. However, the
respective C/C++ <strong>function names must be all lower-case</strong>,
or the UDF will fail to load.</p>
<p>More importantly, it is vital that:</p>
<ol type="1">
<li>the calling convention is C (aka <code>__cdecl</code>);</li>
<li>arguments list matches the plugin system expectations exactly;</li>
<li>the return type matches the one you specify in
<code>CREATE FUNCTION</code>;</li>
<li>the implemented C/C++ functions are thread-safe.</li>
</ol>
<p>Unfortunately, there is no (easy) way for <code>searchd</code> to
automatically check for those mistakes when loading the function, and
they could crash the server and/or result in unexpected results.</p>
<p>Let’s discuss the simple <code>testfunc()</code> example in a bit
more detail.</p>
<p>The first argument, a pointer to <code>SPH_UDF_INIT</code> structure,
is essentially just a pointer to our function state. Using that state is
optional. In this example, the function is stateless, it simply returns
123 every time it gets called. So we do not have to define an
initialization function, and we can simply ignore that argument.</p>
<p>The second argument, a pointer to <code>SPH_UDF_ARGS</code>, is the
most important one. All the actual call arguments are passed to your UDF
via this structure. It contains the call argument count, names, types,
etc. So whether your function gets called like with simple constants,
like this:</p>
<div class="sourceCode" id="cb176"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, testfunc(<span class="dv">1</span>) <span class="op">..</span>.</span></code></pre></div>
<p>or with a bunch of subexpressions as its arguments, like this:</p>
<div class="sourceCode" id="cb177"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, testfunc(<span class="st">&#39;abc&#39;</span>, <span class="dv">1000</span><span class="op">*</span><span class="kw">id</span><span class="op">+</span>gid, WEIGHT()) <span class="op">..</span>.</span></code></pre></div>
<p>or anyhow else, it will receive the very same
<code>SPH_UDF_ARGS</code> structure, in <strong>all</strong> of these
cases. However, the <em>data</em> passed in the args structure can be a
little different.</p>
<p>In the <code>testfunc(1)</code> call example
<code>args-&gt;arg_count</code> will be set to 1, because, naturally we
have just one argument. In the second example, <code>arg_count</code>
will be equal to 3. Also <code>args-&gt;arg_types</code> array will
contain different type data for these two calls. And so on.</p>
<p>Finally, the third argument, <code>char * error_message</code> serves
both as error flag, and a method to report a human-readable message (if
any). UDFs should only raise that flag/message to indicate
<em>unrecoverable</em> internal errors; ones that would prevent any
subsequent attempts to evaluate that instance of the UDF call from
continuing.</p>
<p>You must <em>not</em> use this flag for argument type checks, or for
any other error reporting that is likely to happen during “normal” use.
This flag is designed to report sudden critical runtime errors only,
such as running out of memory.</p>
<p>If we need to, say, allocate temporary storage for our function to
use, or check upfront whether the arguments are of the supported types,
then we need to add two more functions, with UDF initialization and
deinitialization, respectively.</p>
<div class="sourceCode" id="cb178"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> testfunc_init<span class="op">(</span>SPH_UDF_INIT <span class="op">*</span> init<span class="op">,</span> SPH_UDF_ARGS <span class="op">*</span> args<span class="op">,</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> error_message<span class="op">)</span></span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// allocate and initialize a little bit of temporary storage</span></span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a>    init<span class="op">-&gt;</span>func_data <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">));</span></span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">*(</span><span class="dt">int</span><span class="op">*)</span>init<span class="op">-&gt;</span>func_data <span class="op">=</span> <span class="dv">123</span><span class="op">;</span></span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// return a success code</span></span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-12"><a href="#cb178-12" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> testfunc_deinit<span class="op">(</span>SPH_UDF_INIT <span class="op">*</span> init<span class="op">)</span></span>
<span id="cb178-13"><a href="#cb178-13" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb178-14"><a href="#cb178-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// free up our temporary storage</span></span>
<span id="cb178-15"><a href="#cb178-15" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>init<span class="op">-&gt;</span>func_data<span class="op">);</span></span>
<span id="cb178-16"><a href="#cb178-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Note how <code>testfunc_init()</code> also receives the call
arguments structure. At that point in time we do not yet have any actual
per-row <em>values</em> though, so the <code>args-&gt;arg_values</code>
will be <code>NULL</code>. But the argument names and types are already
known, and will be passed. You can check them in the initialization
function and return an error if they are of an unsupported type.</p>
<h3 id="udf-argument-and-return-types">UDF argument and return
types</h3>
<p>UDFs can receive arguments of pretty much any valid internal Sphinx
type. When in doubt, refer to <code>sphinx_udf_argtype</code> enum in
<code>sphinxudf.h</code> for a full list. For convenience, here’s a
short reference table:</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 74%" />
<col style="width: 6%" />
</colgroup>
<thead>
<tr class="header">
<th>UDF arg type</th>
<th>C/C++ type, and a short description</th>
<th>Len</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>UINT32</td>
<td><code>uint32_t</code>, unsigned 32-bit integer</td>
<td>-</td>
</tr>
<tr class="even">
<td>INT64</td>
<td><code>int64_t</code>, signed 64-bit integer</td>
<td>-</td>
</tr>
<tr class="odd">
<td>FLOAT</td>
<td><code>float</code>, single-precision (32-bit) IEEE754 float</td>
<td>-</td>
</tr>
<tr class="even">
<td>STRING</td>
<td><code>char *</code>, non-ASCIIZ string, with a separate length</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>UINT32SET</td>
<td><code>uint32_t *</code>, sorted set of u32 integers</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>INT64SET</td>
<td><code>int64_t *</code>, sorted set of i64 integers</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>FACTORS</td>
<td><code>void *</code>, special blob with ranking signals</td>
<td>-</td>
</tr>
<tr class="even">
<td>JSON</td>
<td><code>char *</code>, JSON (sub)object or field in a string
format</td>
<td>-</td>
</tr>
<tr class="odd">
<td>FLOAT_VEC</td>
<td><code>float *</code>, an unsorted array of floats</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p>The <code>Len</code> column in this table means that the argument
length is passed separately via <code>args-&gt;str_lengths[i]</code> in
addition to the argument value <code>args-&gt;arg_values[i]</code>
itself.</p>
<p>For <code>STRING</code> arguments, the length contains the string
length, in bytes. For all other types, it contains the number of
elements.</p>
<p>As for the return types, UDFs can currently return numeric or string
values, or fixed-width float arrays. The respective types are as
follows:</p>
<table>
<thead>
<tr class="header">
<th>Sphinx type</th>
<th>Regular return type</th>
<th>Batched output arg type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>UINT</code></td>
<td><code>sphinx_int64_t</code></td>
<td><code>int *</code></td>
</tr>
<tr class="even">
<td><code>BIGINT</code></td>
<td><code>sphinx_int64_t</code></td>
<td><code>sphinx_int64_t *</code></td>
</tr>
<tr class="odd">
<td><code>FLOAT</code></td>
<td><code>double</code></td>
<td><code>float *</code></td>
</tr>
<tr class="even">
<td><code>FLOAT_ARRAY</code></td>
<td>-</td>
<td><code>float *</code></td>
</tr>
<tr class="odd">
<td><code>STRING</code></td>
<td><code>char *</code></td>
<td>-</td>
</tr>
</tbody>
</table>
<p>Batched calls and float arrays are discussed below.</p>
<p>We still define our own <code>sphinx_int64_t</code> type in
<code>sphinxudf.h</code> for clarity and convenience, but these days,
any standard 64-bit integer type like <code>int64_t</code> or
<code>long long</code> should also suffice, and can be safely used in
your UDF code.</p>
<p>Any non-scalar return values in general (for now just the
<code>STRING</code> return type) <strong>MUST</strong> be allocated
using <code>args-&gt;fn_malloc</code> function.</p>
<p>Also, <code>STRING</code> values must (rather naturally) be
zero-terminated C/C++ strings, or the engine will crash.</p>
<p>It is safe to return a <code>NULL</code> value. At the moment (as of
v.3.4), that should be equivalent to returning an empty string.</p>
<p>Of course, <em>internally</em> in your UDF you can use whatever
allocator you want, so the <code>testfunc_init()</code> example above is
correct even though it uses <code>malloc()</code> directly. You manage
that pointer yourself, it gets freed up using a matching
<code>free()</code> call, and all is well. However, the
<em>returned</em> strings values will be managed by Sphinx, and we have
our own allocator. So for the return values specifically, you need to
use it too.</p>
<p>Note than when you set a non-empty error message, the engine will
immediately free the pointer that you return. So even in the error case,
you still <em>must</em> either return whatever you allocated with
<code>args-&gt;fn_malloc</code> (otherwise that would be a leak).
However, in this case it’s okay to return a garbage buffer (eg. not yet
fully initialized and therefore not zero-terminated), as the engine will
not attempt to interpret it as a string.</p>
<h3 id="udf-library-initialization">UDF library initialization</h3>
<p>Sphinx v.3.5 adds support for <strong>parametrized UDF library
initialization</strong>.</p>
<p>You can now implement
<code>int &lt;LIBRARYNAME&gt;_libinit(const char *)</code> in your
library, and if that exists, <code>searchd</code> will call that
function once, immediately after the library is loaded. This is
optional, you are not <em>required</em> to implement this function.</p>
<p>The string parameter passed to <code>_libinit</code> is taken from
the <code>plugin_libinit_arg</code> directive in the <code>common</code>
section. You can put any arbitrary string there. The default
<code>plugin_libinit_arg</code> value is an empty string.</p>
<p>There will be some macro expansion applied to that string. At the
moment, the only known macro is <code>$extra</code> that expands to
<code>&lt;DATADIR&gt;/extra</code>, where in turn
<code>&lt;DATADIR&gt;</code> means the current active datadir path. This
is to provide UDFs with an easy method access to datadir VFS root, where
all the resource files must be stored in the datadir mode.</p>
<p><strong>The library initialization function can fail.</strong> On
success, you must return 0. On failure, you can return any other code,
it will be reported.</p>
<p>To summarize, the library load sequence is as follows.</p>
<ul>
<li><code>dlopen()</code> that implicitly calls any C/C++ global
initializers;</li>
<li>the mandatory <code>&lt;LIBNAME&gt;_ver()</code> call;</li>
<li>the optional
<code>&lt;LIBNAME&gt;_libinit(&lt;plugin_libinit_arg&gt;)</code>
call.</li>
</ul>
<h3 id="udf-call-batching">UDF call batching</h3>
<p>Since v.3.3 Sphinx supports two types of the “main” UDF call with a
numeric return type:</p>
<ul>
<li>regular, called with exactly 1 row at a time;</li>
<li>batched, called with batches of 1 to 128 rows at a time.</li>
</ul>
<p>These two types have different C/C++ signatures, for example:</p>
<div class="sourceCode" id="cb179"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// regular call that RETURNS UINT</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// note the `sphinx_int64_t` ret type</span></span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>sphinx_int64_t foo<span class="op">(</span>SPH_UDF_INIT <span class="op">*</span> init<span class="op">,</span> SPH_UDF_ARGS <span class="op">*</span> args<span class="op">,</span></span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> error<span class="op">);</span></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a><span class="co">/// batched call that RETURNS UINT</span></span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a><span class="co">/// note the `int *` out arg type</span></span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> foo_batch<span class="op">(</span>SPH_UDF_INIT <span class="op">*</span> init<span class="op">,</span> SPH_UDF_ARGS <span class="op">*</span> args<span class="op">,</span></span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span> results<span class="op">,</span> <span class="dt">int</span> batch_size<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span> error<span class="op">);</span></span></code></pre></div>
<p>UDF must define at least 1 of these two functions. As of v.3.3, UDF
can define both functions, but batched calls take priority. So when both
<code>foo_batch()</code> and <code>foo()</code> are defined, the engine
will only use <code>foo_batch()</code>, and completely ignore
<code>foo()</code>.</p>
<p>Batched calls are needed for performance. For instance, processing
multiple documents at once with certain CatBoost ML models could be more
than 5x faster.</p>
<p>Starting from v.3.5 the engine can also batch the UDF calls when
doing no-text queries too (ie. <code>SELECT</code> queries without a
<code>MATCH()</code> clause). Initially we only batched them when doing
full-text queries.</p>
<p>As mentioned a little earlier, return types for batched calls differ
from regular ones, again for performance reasons. So yes, the types in
the example above are correct. Regular, single-row <code>foo()</code>
call must use <code>sphinx_int64_t</code> for its return type either
when the function was created with <code>RETURNS UINT</code> or
<code>RETURNS BIGINT</code>, for simplicity. However the batched
multi-row <code>foo_batch()</code> call <strong>must</strong> use an
output buffer typed as <code>int *</code> when created with
<code>RETURNS UINT</code>; or a buffer typed as
<code>sphinx_int64_t *</code> when created with
<code>RETURNS BIGINT</code>; just as mentioned in that types table
earlier.</p>
<p>Current target batch size is 128, but that size may change in either
direction in the future. Assume little about <code>batch_size</code>,
and very definitely do <em>not</em> hardcode the current limit anywhere.
(Say, it is reasonably safe to assume that batches will always be in 1
to 65536 range, though.)</p>
<p>Engine should accumulate matches up to the target size, so that most
UDF calls receive complete batches. However, trailing batches will be
sized arbitrarily. For example, for 397 matches there should be 4 calls
to <code>foo_batch()</code>, with 128, 128, 128, and 13 matches per
batch respectively.</p>
<p>Arguments (and their sizes where applicable) are stored into
<code>arg_values</code> (and <code>str_lengths</code>) sequentially for
every match in the batch. For example, you can access them as
follows:</p>
<div class="sourceCode" id="cb180"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> row <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> row <span class="op">&lt;</span> batch_size<span class="op">;</span> row<span class="op">++)</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> arg <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> arg <span class="op">&lt;</span> args<span class="op">-&gt;</span>arg_count<span class="op">;</span> arg<span class="op">++)</span></span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> index <span class="op">=</span> row <span class="op">*</span> args<span class="op">-&gt;</span>args_count <span class="op">+</span> arg<span class="op">;</span></span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>        use_arg<span class="op">(</span>args<span class="op">-&gt;</span>arg_values<span class="op">[</span>index<span class="op">],</span> args<span class="op">-&gt;</span>str_lengths<span class="op">[</span>index<span class="op">]);</span></span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<p>Batched UDF <strong>must</strong> fill the <strong>entire</strong>
results array with some sane default value, even if it decides to fail
with an unrecoverable error in the middle of the batch. It must never
return garbage results.</p>
<p>On error, engine will stop calling the batched UDF for the rest of
the current <code>SELECT</code> query (just as it does with regular
UDFs), and automatically zero out the rest of the values. However, it is
the UDFs responsbility to completely fill the failed batch anyway.</p>
<p>Batched calls are currently only supported for numeric UDFs, ie.
functions that return <code>UINT</code>, <code>BIGINT</code>, or
<code>FLOAT</code>; batching is not yet supported for
<code>STRING</code> functions. That may change in the future.</p>
<h3 id="udfs-that-return-arrays">UDFs that return arrays</h3>
<p>UDFs can also return <strong>fixed-width float arrays</strong> (for
one, that works well for passing ranking signals from L1 Sphinx UDFs to
external L2 ranking).</p>
<p>To register such UDFs on Sphinx side, use <code>FLOAT[N]</code>
syntax, as follows.</p>
<div class="sourceCode" id="cb181"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> foo RETURNS <span class="dt">FLOAT</span>[<span class="dv">20</span>] SONAME <span class="st">&#39;foo.so&#39;</span></span></code></pre></div>
<p>On C/C++ side, the respective functions have a bit different calling
convention: instead of returning anything, they must accept an extra
<code>void * out</code> argument, and fill that buffer (with as many
floats as specified in <code>CREATE FUNCTION</code>).</p>
<p>Batching is also supported, with <code>_batch()</code> suffix in
function name, and another extra <code>int size</code> argument (that
stores the batch size).</p>
<p>Here’s an example.</p>
<div class="sourceCode" id="cb182"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// regular call that RETURNS FLOAT[N]</span></span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// note the `void` return type, and output buffer</span></span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> foo<span class="op">(</span>SPH_UDF_INIT <span class="op">*</span> init<span class="op">,</span> SPH_UDF_ARGS <span class="op">*</span> args<span class="op">,</span></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> output<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span> error<span class="op">)</span></span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> <span class="op">*</span> r <span class="op">=</span> <span class="op">(</span><span class="dt">float</span> <span class="op">*)</span>output<span class="op">;</span></span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">20</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a>        r<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-11"><a href="#cb182-11" aria-hidden="true" tabindex="-1"></a><span class="co">/// batched call that RETURNS FLOAT[N]</span></span>
<span id="cb182-12"><a href="#cb182-12" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> foo_batch<span class="op">(</span>SPH_UDF_INIT <span class="op">*</span> init<span class="op">,</span> SPH_UDF_ARGS <span class="op">*</span> args<span class="op">,</span></span>
<span id="cb182-13"><a href="#cb182-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> output<span class="op">,</span> <span class="dt">int</span> size<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span> error<span class="op">)</span></span>
<span id="cb182-14"><a href="#cb182-14" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb182-15"><a href="#cb182-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> <span class="op">*</span> r <span class="op">=</span> <span class="op">(</span><span class="dt">float</span> <span class="op">*)</span>output<span class="op">;</span></span>
<span id="cb182-16"><a href="#cb182-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> size<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb182-17"><a href="#cb182-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">20</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb182-18"><a href="#cb182-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">*</span>r<span class="op">++</span> <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb182-19"><a href="#cb182-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Array dimensions must be in sync</strong> between the
<code>CREATE FUNCTION</code> call and C/C++ code. Sphinx does
<strong>not</strong> pass the dimensions to UDFs (basically because we
were too lazy to bump the UDF interface version).</p>
<p><strong>Dynamic (ie. variable-length) arrays are not
supported.</strong> Because we don’t have usecases for that just
yet.</p>
<p><strong>The minimum allowed <code>FLOAT[N]</code> size is 2.</strong>
Quite naturally.</p>
<p><strong>UDF must fill the entire buffer.</strong> Otherwise,
uninitialized values. Sphinx does <strong>not</strong> clean the buffer
before calling UDFs.</p>
<p><strong>UDF must NEVER overrun the buffer.</strong> Otherwise,
undefined (but bad) behavior, because corrupted memory. Best case, you
<strong>definitely</strong> get corrupted matches. Worst case, you crash
the entire daemon.</p>
<p><strong>The buffer is intentionally a void pointer, because
extensibility</strong>. We only support <code>FLOAT[N]</code> at the
moment, but we might add more types in the future.</p>
<h3 id="using-factors-in-udfs">Using <code>FACTORS()</code> in UDFs</h3>
<p>Most of the types map straightforwardly to the respective C types.
The most notable exception is the <code>SPH_UDF_TYPE_FACTORS</code>
argument type. You get that type by passing <code>FACTORS()</code>
expression as an argument to your UDF. The value that the UDF will
receive is a binary blob in a special internal format.</p>
<p>To extract individual ranking signals from that blob, you need to use
either of the two <code>sphinx_factors_XXX()</code> or
<code>sphinx_get_YYY_factor()</code> function families.</p>
<p>The first family consists of just 3 functions:</p>
<ul>
<li><code>sphinx_factors_init()</code> that initializes the unpacked
<code>SPH_UDF_FACTORS</code> structure;</li>
<li><code>sphinx_factors_unpack()</code> that unpacks a binary blob
value into it;</li>
<li><code>sphinx_factors_deinit()</code> that cleans up an deallocates
<code>SPH_UDF_FACTORS</code>.</li>
</ul>
<p>So you need to call <code>init()</code> and <code>unpack()</code>
first, then you can use the fields within the
<code>SPH_UDF_FACTORS</code> structure, and then you have to call
<code>deinit()</code> for cleanup. The resulting code would be rather
simple, like this:</p>
<div class="sourceCode" id="cb183"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="co">// init!</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>SPH_UDF_FACTORS F<span class="op">;</span></span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>sphinx_factors_init<span class="op">(&amp;</span>F<span class="op">);</span></span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>sphinx_factors_unpack<span class="op">((</span><span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">int</span> <span class="op">*)</span>args<span class="op">-&gt;</span>arg_values<span class="op">[</span><span class="dv">0</span><span class="op">],</span> <span class="op">&amp;</span>F<span class="op">))</span></span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a>    sphinx_factors_deinit<span class="op">(&amp;</span>F<span class="op">);</span> <span class="co">// no leaks please</span></span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb183-10"><a href="#cb183-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-11"><a href="#cb183-11" aria-hidden="true" tabindex="-1"></a><span class="co">// process!</span></span>
<span id="cb183-12"><a href="#cb183-12" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> result <span class="op">=</span> F<span class="op">.</span>field<span class="op">[</span><span class="dv">3</span><span class="op">].</span>hit_count<span class="op">;</span></span>
<span id="cb183-13"><a href="#cb183-13" aria-hidden="true" tabindex="-1"></a><span class="co">// ... maybe more math here ...</span></span>
<span id="cb183-14"><a href="#cb183-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-15"><a href="#cb183-15" aria-hidden="true" tabindex="-1"></a><span class="co">// cleanup!</span></span>
<span id="cb183-16"><a href="#cb183-16" aria-hidden="true" tabindex="-1"></a>sphinx_factors_deinit<span class="op">(&amp;</span>F<span class="op">);</span></span>
<span id="cb183-17"><a href="#cb183-17" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> result<span class="op">;</span></span></code></pre></div>
<p>However, this access simplicity has an obvious drawback. It will
cause several memory allocations per each processed document (made by
<code>init()</code> and <code>unpack()</code> and later freed by
<code>deinit()</code> respectively), which might be slow.</p>
<p>So there is another interface to access <code>FACTORS()</code> that
consists of a bunch of <code>sphinx_get_YYY_factor()</code> functions.
It is more verbose, but it accesses the blob data directly, and it
<em>guarantees</em> zero allocations and zero copying. So for top-notch
ranking UDF performance, you want that one. Here goes the matching
example code that also accesses just 1 signal from just 1 field:</p>
<div class="sourceCode" id="cb184"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="co">// init!</span></span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">int</span> <span class="op">*</span> F <span class="op">=</span> <span class="op">(</span><span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">int</span> <span class="op">*)</span>args<span class="op">-&gt;</span>arg_values<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">int</span> <span class="op">*</span> field3 <span class="op">=</span> sphinx_get_field_factors<span class="op">(</span>F<span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a><span class="co">// process!</span></span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> result <span class="op">=</span> sphinx_get_field_factor_int<span class="op">(</span>field3<span class="op">,</span> SPH_FIELDF_HIT_COUNT<span class="op">);</span></span>
<span id="cb184-7"><a href="#cb184-7" aria-hidden="true" tabindex="-1"></a><span class="co">// ... maybe more math here ...</span></span>
<span id="cb184-8"><a href="#cb184-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-9"><a href="#cb184-9" aria-hidden="true" tabindex="-1"></a><span class="co">// done! no cleanup needed</span></span>
<span id="cb184-10"><a href="#cb184-10" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> result<span class="op">;</span></span></code></pre></div>
<h3 id="udf-calls-sequences">UDF calls sequences</h3>
<p>Depending on how your UDFs are used in the query, the main function
call (<code>testfunc()</code> in our running example) might get called
in a rather different volume and order. Specifically,</p>
<ul>
<li><p>UDFs referenced in <code>WHERE</code>, <code>ORDER BY</code>, or
<code>GROUP BY</code> clauses must and will be evaluated for every
<strong>matched</strong> document. They will be called in the
<strong>natural matching order</strong>.</p></li>
<li><p>without subselects, “final stage” UDFs that are
<strong>not</strong> referenced in <code>WHERE</code>,
<code>ORDER BY</code>, or <code>GROUP BY</code> clauses can and will be
evaluated for every <strong>returned</strong> (not matched!) document
only. However, no UDF call order is guaranteed in this case. (Assume
that it can be random.)</p></li>
<li><p>with subselects, such “final stage” UDFs will also be evaluated
<em>after</em> applying the inner <code>LIMIT</code> clause.</p></li>
</ul>
<p>The calling sequence of the other functions is fixed, though.
Namely,</p>
<ul>
<li><p><code>testfunc_init()</code> is called once when initializing the
query. It can return a non-zero code to indicate a failure; in that case
query gets terminated early, and the error message from the
<code>error_message</code> buffer is returned.</p></li>
<li><p><code>testfunc()</code> or <code>testfunc_batch()</code> is
called for every eligible row batch (see above), whenever Sphinx needs
to compute the UDF value(s). This call can indicate an unrecoverable
error by writing either a value of 1, or some human-readable message to
the <code>error_message</code> argument. (So in other words, you can use
<code>error_message</code> either as a boolean flag, or a string
buffer.)</p></li>
<li><p>After getting a non-zero <code>error_message</code> from the main
UDF call, the engine guarantees to stop calling that UDF call for
subsequent rows for the rest of the query. A default return value of 0
for numerics and an empty string for strings will be used instead.
Sphinx might or might not choose to terminate such queries early,
neither behavior is currently guaranteed.</p></li>
<li><p><code>testfunc_deinit()</code> is called once when the query
processing (in a given index shard) ends. It must get called even if the
main call reported an unrecoverable error earlier.</p></li>
</ul>
<h2 id="using-ranker-plugins">Using ranker plugins</h2>
<p>Another method to extend Sphinx is <strong>ranker plugins</strong>
which can <strong>completely</strong> replace Sphinx-side ranking.
Ranker plugins basically get access to raw postings stream, and “in
exchange” they must compute <code>WEIGHT()</code> over that stream.</p>
<p>The simplest ranker plugin can be literally 3 lines of code. (For the
record, MSVC on Windows requires an extra
<code>__declspec(dllexport)</code> annotation here, but hey, still 3
lines.)</p>
<div class="sourceCode" id="cb185"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="co">// gcc -fPIC -shared -o myrank.so myrank.c</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;sphinxudf.h&quot;</span></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> myrank_ver<span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> SPH_UDF_VERSION<span class="op">;</span> <span class="op">}</span></span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> myrank_finalize<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>u<span class="op">,</span> <span class="dt">int</span> w<span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> <span class="dv">123</span><span class="op">;</span> <span class="op">}</span></span></code></pre></div>
<p>And this is how you use it.</p>
<div class="sourceCode" id="cb186"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">CREATE</span> PLUGIN myrank <span class="kw">TYPE</span> <span class="st">&#39;ranker&#39;</span> SONAME <span class="st">&#39;myrank.so&#39;</span>;</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, weight() <span class="kw">FROM</span> test1 <span class="kw">WHERE</span> MATCH(<span class="st">&#39;test&#39;</span>)</span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">OPTION</span> ranker<span class="op">=</span>myrank(<span class="st">&#39;customopt:456&#39;</span>);</span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | weight() |</span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> |      <span class="dv">123</span> |</span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> |      <span class="dv">123</span> |</span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+</span></span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.01</span> sec)</span></code></pre></div>
<p>So what just happened?</p>
<p>At this time Sphinx supports two plugin types, “function” plugins
(aka UDFs), and “ranker” plugins. Each plugin type has its unique
execution flow.</p>
<p>Brief ranker plugin flow is as follows.</p>
<ol type="1">
<li>optional per-query initialization via <code>xxx_init()</code>;</li>
<li>optional per-posting update via <code>xxx_update()</code>;</li>
<li><strong>mandatory</strong> per-document weighting via
<code>xxx_finalize()</code>;</li>
<li>optional per-query clean up via <code>xxx_deinit()</code>.</li>
</ol>
<p>In a bit more detail, what does each call get, and what must it
return?</p>
<p><code>xxx_init()</code> is called once per query (and per index for
multi-index searches), at the very beginning. Several query-wide options
including the user-provided <strong>options string</strong> are passed
in a <code>SPH_RANKER_INIT</code> structure. In the example above, the
options string is <code>customopt:456</code>, but our super-simple
ranker does not implement <code>init()</code>, so that gets ignored.</p>
<p><code>xxx_update()</code> gets called many times per each matched
document, for every matched <strong>posting</strong> (aka keyword
occurrence), with a <code>SPH_RANKER_HIT</code> structure argument.
Postings are <strong>guaranteed</strong> to be in the ascending
<code>hit-&gt;hit_pos</code> order within each document.</p>
<p><code>xxx_finalize()</code> gets called once per matched document,
once there are no more postings to pass to <code>update()</code>, and
<strong>this is the main workhorse</strong>. Because this function
<strong>must</strong> return the final <code>WEIGHT()</code> value for
the current document. Thus it’s the only <strong>mandatory</strong>
call.</p>
<p>Finally, <code>xxx_deinit()</code> gets called once per query (and
per index) for cleanup.</p>
<p>Here are the expected call prototypes. Note how
<code>xxx_ver()</code> is also required by the plugin system itself,
same as with UDFs.</p>
<div class="sourceCode" id="cb187"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="co">// xxx_init()</span></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">int</span> <span class="op">(*</span>PfnRankerInit<span class="op">)(</span><span class="dt">void</span> <span class="op">**</span> userdata<span class="op">,</span> SPH_RANKER_INIT <span class="op">*</span> ranker<span class="op">,</span></span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> error<span class="op">);</span></span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a><span class="co">// xxx_update()</span></span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> <span class="op">(*</span>PfnRankerUpdate<span class="op">)(</span><span class="dt">void</span> <span class="op">*</span> userdata<span class="op">,</span> SPH_RANKER_HIT <span class="op">*</span> hit<span class="op">);</span></span>
<span id="cb187-7"><a href="#cb187-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-8"><a href="#cb187-8" aria-hidden="true" tabindex="-1"></a><span class="co">// xxx_finalize(), MANDATORY</span></span>
<span id="cb187-9"><a href="#cb187-9" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">unsigned</span> <span class="dt">int</span> <span class="op">(*</span>PfnRankerFinalize<span class="op">)(</span><span class="dt">void</span> <span class="op">*</span> userdata<span class="op">,</span> <span class="dt">int</span> match_weight<span class="op">);</span></span>
<span id="cb187-10"><a href="#cb187-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-11"><a href="#cb187-11" aria-hidden="true" tabindex="-1"></a><span class="co">// xxx_deinit()</span></span>
<span id="cb187-12"><a href="#cb187-12" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">int</span> <span class="op">(*</span>PfnRankerDeinit<span class="op">)(</span><span class="dt">void</span> <span class="op">*</span> userdata<span class="op">);</span></span></code></pre></div>
<p>As you see, this is object-oriented. Indeed, <code>xxx_init()</code>
is a “constructor” that returns some state pointer via
<code>void ** userdata</code> out-parameter. Then that very
<code>(*userdata)</code> value gets passed to other “methods” and
“destructor”, ie. to <code>xxx_update()</code> and
<code>xxx_finalze()</code> and <code>xxx_deinit()</code>, so it works
exactly like <code>this</code> pointer.</p>
<p>Why this OOP-in-C complication? Because Sphinx is multi-threaded, and
plugins are frequently <strong>stateful</strong>. Passing around
<code>userdata</code> from <code>xxx_init()</code> is what makes
stateful plugins even possible. And simple stateless plugins can just
omit <code>xxx_init()</code> and <code>xxx_deinit()</code>, and ignore
<code>userdata</code> in other calls.</p>
<p>Frankly speaking, ranker plugins are an obscure little piece these
days, and that shows: <code>xxx_finalize()</code> still returns
<code>int</code> weights even though <code>WEIGHT()</code> is now
generally <code>float</code>; and <code>xxx_update()</code> is not even
batched (which seems essential for heavy-duty prod use). But hey, no
problem, we’ll just make those changes as soon as anyone running ranker
plugins in prod asks! (So yes, maybe never.)</p>
<h2 id="using-table-functions">Using table functions</h2>
<p>Table functions take an arbitrary result set as their input, and
return a new, processed, (completely) different one as their output.</p>
<p>First argument must always be the input result set, but a table
function can optionally take and handle more arguments. As for syntax,
it must be a <code>SELECT</code> <strong>in extra round braces</strong>,
as follows. Regular and nested SELECTs are both ok.</p>
<div class="sourceCode" id="cb188"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a># regular <span class="kw">select</span> <span class="kw">in</span> a tablefunc</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> SOMETABLEFUNC(</span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytest <span class="kw">LIMIT</span> <span class="dv">30</span>),</span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>.)</span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a># <span class="kw">nested</span> <span class="kw">select</span> <span class="kw">in</span> a tablefunc</span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> SOMETABLEFUNC(</span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span></span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytest <span class="kw">ORDER</span> <span class="kw">BY</span> price <span class="kw">ASC</span> <span class="kw">LIMIT</span> <span class="dv">500</span>)</span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ORDER</span> <span class="kw">BY</span> WEIGHT() <span class="kw">DESC</span> <span class="kw">LIMIT</span> <span class="dv">100</span>),</span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>.)</span></code></pre></div>
<p>Table function can completely change the result set including the
schema. Only built-in table functions are supported for now. (UDFs are
quite viable here, but all these years the demand ain’t been great.)</p>
<h3 id="remove_repeats-table-function">REMOVE_REPEATS table
function</h3>
<div class="sourceCode" id="cb189"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> REMOVE_REPEATS(result_set, <span class="kw">column</span>) [<span class="kw">LIMIT</span> [<span class="op">&lt;</span>offset<span class="op">&gt;</span>,] <span class="op">&lt;</span>row_count<span class="op">&gt;</span>]</span></code></pre></div>
<p>This function removes all <code>result_set</code> rows that have the
same <code>column</code> value as in the previous row. Then it applies
the <code>LIMIT</code> clause (if any) to the newly filtered result
set.</p>
<h3 id="pessimize_rank-table-function">PESSIMIZE_RANK table
function</h3>
<div class="sourceCode" id="cb190"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> PESSIMIZE_RANK(result_set, key_column, rank_column, base_coeff,</span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>    rank_fraction) [<span class="kw">LIMIT</span> [<span class="op">&lt;</span>offset<span class="op">&gt;</span>,] <span class="op">&lt;</span>row_count<span class="op">&gt;</span>]</span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a># example</span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> PESSIMIZE_RANK((<span class="kw">SELECT</span> user_id, <span class="fu">rank</span> <span class="kw">FROM</span> mytable <span class="kw">LIMIT</span> <span class="dv">500</span>),</span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>    user_id, <span class="fu">rank</span>, <span class="fl">0.95</span>, <span class="dv">1</span>) <span class="kw">LIMIT</span> <span class="dv">100</span></span></code></pre></div>
<p>This function gradually pessimizes <code>rank_column</code> values
when several result set rows share the same <code>key_column</code>
value. Then it reorders the entire set by newly pessimized
<code>rank_column</code> value, and finally applies the
<code>LIMIT</code> clause, if any.</p>
<p>In the example above it decreases <code>rank</code> (more and more)
starting from the 2nd input result set row with the same
<code>user_id</code>, ie. from the same user. Then it reorders by
<code>rank</code> again, and returns top 100 rows by the pessimized
rank.</p>
<p>Paging with non-zero offsets is also legal, eg.
<code>LIMIT 40, 20</code> instead of <code>LIMIT 100</code> would skip
first 40 rows and then return 20 rows, aka page number 3 with 20 rows
per page.</p>
<p>The specific pessimization formula is as follows. Basically,
<code>base_coeff</code> controls the exponential decay power, and
<code>rank_fraction</code> controls the lerp power between the original
and decayed <code>rank_column</code> values.</p>
<pre><code>pessimized_part = rank * rank_fraction * pow(base_coeff, prev_occurrences)
unchanged_part  = rank * (1 - rank_fraction)
rank            = pessimized_part + unchanged_part</code></pre>
<p><code>prev_occurrences</code> is the number of rows with the matching
<code>key_column</code> value that precede the current row in the input
result set. It follows that the result set is completely untouched when
all <code>key_column</code> values are unique.</p>
<p><code>PESSIMIZE_RANK()</code> also forbids non-zero offsets in
argument <code>SELECT</code> queries, meaning that
<code>(SELECT * FROM mytable LIMIT 10)</code> is ok, but
<code>(... LIMIT 30, 10)</code> must fail. Because the pessimization is
position dependent. And applying it to an arbitrarily offset slice
(rather than top rows) is kinda sorta meaningless. Or in other words,
with pessimization, <code>LIMIT</code> paging is only allowed outside of
<code>PESSIMIZE_RANK()</code> and forbidden inside it.</p>
<h2 id="using-distributed-indexes">Using distributed indexes</h2>
<p>TODO: write (so much) more.</p>
<h3 id="agent-mirror-selection-strategies">Agent mirror selection
strategies</h3>
<p>Sphinx implements several agent mirror selection strategies, and
<code>ha_strategy</code> directive lets you choose a specific one, on a
per-index basis.</p>
<table>
<colgroup>
<col style="width: 17%" />
<col style="width: 82%" />
</colgroup>
<thead>
<tr class="header">
<th>HA strategy</th>
<th>What it selects</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>roundrobin</code></td>
<td>Next mirror, in simple round-robin (RR) order</td>
</tr>
<tr class="even">
<td><code>random</code></td>
<td>Random mirror, with equal probabilities</td>
</tr>
<tr class="odd">
<td><code>nodeads</code></td>
<td>Random alive mirror, with latency-weighted probabilities</td>
</tr>
<tr class="even">
<td><code>noerrors</code></td>
<td>Random alive-and-well mirror, with latency-weighted
probabilities</td>
</tr>
<tr class="odd">
<td><code>weightedrr</code></td>
<td>Next alive mirror, in RR order, with agent-reported weights</td>
</tr>
<tr class="even">
<td><code>swrr</code></td>
<td>Next alive mirror, in RR order, with scaled agent weights</td>
</tr>
</tbody>
</table>
<p>Now let’s dive into a bit more detail than just this nonsense!</p>
<p>The first two strategies, <code>roundrobin</code> and
<code>random</code>, are extremely simple: <code>roundrobin</code> just
loops all the mirrors in order and picks the next one, and
<code>random</code> just picks a random one. Good classic baselines, but
not great.</p>
<p>Both <code>roundrobin</code> and <code>random</code> can still manage
to split traffic evenly, and that just might work okay. However, they
completely ignore the actual current cluster state and load. Got a
temporarily unreachable, or permanently dead, or temporarily overloaded
mirror? Don’t care, let’s try it anyway. Not great!</p>
<p>All other strategies do account for cluster state. What’s that
exactly? Every master <code>searchd</code> instance dynamically keeps a
few per-agent counters associated with every agent <code>searchd</code>
instance that it talks to.</p>
<ul>
<li>agent liveness flag, as observed by master</li>
<li>agent query latency, as observed by master</li>
<li>agent weight, as reported by agent</li>
</ul>
<p>These counters are frequently updated. <strong>Liveness flag</strong>
is updated by both search and ping requests, so normally, that happens
<strong>at least every second</strong> even on idle clusters (because
default <code>ha_ping_interval</code> is 1000 milliseconds).
<strong>Agent weight</strong> is updated by ping requests, so
<strong>every second</strong> too. Finally, <strong>(average) query
latency</strong> is normally updated <strong>every minute</strong>
(because default <code>ha_period_karma</code> is 60 seconds).</p>
<p>Knowng these <strong>recently observed query latencies</strong>
allows the master to adapt and send less traffic to mirrors that are
currently slower. Also, it makes sense to (temporarily) avoid querying
mirrors that don’t even respond. Also, it might make sense to
temporarily avoid mirrors that do respond, but report too many errors
for whatever reason. And that’s basically exactly what
<code>nodeads</code> and <code>noerrors</code> strategies do. They
<strong>dynamically adapt</strong> to overall cluster load, and split
the traffic to optimize the overall latencies and minimize errors.</p>
<p><strong>No deads</strong> (<code>nodeads</code>) strategy uses
latency-weighted probabilities, but only over alive mirrors. If a mirror
returns 3 hard errors in a row (that’s including network failures,
missing responses, etc), we consider it dead, and pick one of the alive
mirrors (preferring the ones with less errors-in-a-row).</p>
<p><strong>No errors</strong> (<code>noerrors</code>) strategy uses
latency-weighted probabilities, too, but the filtering and sorting logic
is a bit different. We skip mirrors that did not recently successfully
return any result sets, or respond to pings. Out of the remaining ones,
we pick the one with the lowest hard errors ratio.</p>
<p>Coming up next, <strong>Weighted Round Robin</strong>
(<code>weightedrr</code>) is yet different. Basically, it also loops
over all the mirrors in order, as <code>roundrobin</code> does, but in
weighted way, with a few twists. First, it adds
<strong>weights</strong>, so that some mirrors get more traffic than
others. Second, those <strong>weights are dynamic</strong> and reported
<strong>by mirrors themselves</strong>. That’s controlled by
<code>ha_weight</code> setting on the agent side, varying 0 to 100. Last
but not least, WRR checks for liveness, and avoids unreachable
mirrors.</p>
<p>For example, with a heterogeneous cluster it’s convenient to set
<code>ha_weight</code> to the number of cores. Or adjust it dynamically
based on local CPU load.</p>
<p>The last one is <strong>Scaled Weighted Round Robin</strong>
(<code>swrr</code>). It’s similar to WRR, except the mirror weights are
additionally scaled on the <strong>master</strong> side, using the
<code>ha_weight_scales</code> directive. Just as WRR, it checks for
liveness (and that includes cases when agent reports zero
<code>ha_weight</code>). But when looping through the alive mirrors, it
uses weights scaled by a specific factor for each agent.</p>
<p>But why? That’s for setting up <strong>emergency cross-DC
fallbacks</strong> on the master side (while still being able to manage
weights on the agent side). For instance, on masters in DC1 we want to
normally query our primary, local mirrors from DC1, and avoid cross-DC
traffic, but switch to “emergency fallback” mirrors from DC2 if
<strong>all</strong> our mirrors in DC1 fail. (And ditto in DC2.)</p>
<p>SWRR enables exactly that! We adjust the weight scaling coefficients
for our preferred mirrors (the default scale is 1), and that’s it.
Here’s an example.</p>
<div class="sourceCode" id="cb192"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="ex">searchd</span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># DC1 master config, prefers DC1 mirrors</span></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ha_weight_scales</span> = dc1box01:1, dc1box02:0.5, dc2box01:0.01, dc2box02:0.01</span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> dist1</span>
<span id="cb192-9"><a href="#cb192-9" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb192-10"><a href="#cb192-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">agent</span> = dc1box01:9312<span class="kw">|</span><span class="ex">dc1box02:9312</span><span class="kw">|</span><span class="ex">dc2box01:9312</span><span class="kw">|</span><span class="ex">dc2box02:9312:shardA</span></span>
<span id="cb192-11"><a href="#cb192-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">agent</span> = dc1box01:9312<span class="kw">|</span><span class="ex">dc1box02:9312</span><span class="kw">|</span><span class="ex">dc2box01:9312</span><span class="kw">|</span><span class="ex">dc2box02:9312:shardB</span></span>
<span id="cb192-12"><a href="#cb192-12" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>In this example, when all our hosts report the same
<code>ha_weight</code> in steady state, traffic gets split 100:50:1:1
between the four <code>dcNboxMM</code> servers. For every 150 queries to
DC1 there are 2 queries to DC2 which is negligible. The vast majority of
traffic stays local to DC1.</p>
<p>Now, if just one of the DC1 boxes fails, traffic gets split 50:1:1,
and still mostly stays in DC1. (And yes, <code>dc1box02</code> suddenly
gets 3x its previous traffic. Failure mode is failure mode.)</p>
<p>But, if both boxes in DC1 fail, then DC2 boxes jump in to the rescue,
and start handling all the DC1 traffic. The same happens if we manually
disable those two DC1 boxes for maintenance (by setting
<code>ha_weight</code> to zero). Convenient!</p>
<h2 id="using-replication">Using replication</h2>
<p>Starting from v.3.9, Sphinx supports <strong>asynchronous index
replication</strong>!</p>
<p>Key facts in 30 seconds.</p>
<ul>
<li>replication can be individually configured per-index;</li>
<li>replication is based on shipping WALs aka binlogs (the usual);</li>
<li>multi-layer setups are a work-in-progress, but intended and
supported;</li>
<li>we successfully deploy and run replication setups in
production.</li>
</ul>
<p>Getting started in 30 seconds.</p>
<ul>
<li>on both sides, ensure that <code>workers = thread_pool</code> (the
default);</li>
<li>on master side, ensure that there’s a SphinxAPI listener;</li>
<li>on replica side, create an RT index with
<code>repl_follow = &lt;host&gt;:&lt;api_port&gt;</code>.</li>
</ul>
<p>Basically, run the following 2 queries on the replica instance, and
it should begin automatically following the <code>repl</code> index from
the master instance.</p>
<div class="sourceCode" id="cb193"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> repl (<span class="kw">id</span> bigint, dummy field);</span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> repl <span class="kw">SET</span> <span class="kw">OPTION</span> repl_follow <span class="op">=</span> <span class="st">&#39;127.0.0.1:9312&#39;</span>;</span></code></pre></div>
<blockquote>
<p>NOTE! Use SphinxAPI port, <strong>not</strong> SphinxQL. The default
value is 9312.</p>
</blockquote>
<p>Or alternatively, you can specify <code>repl_follow</code> in your
config file.</p>
<div class="sourceCode" id="cb194"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in replica.conf</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> repl</span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = rt</span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = dummy</span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">repl_follow</span> = 127.0.0.1:9312</span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>That should be it. Replicated RT index <code>repl</code> on the
replica should now follow the original <code>repl</code> index on the
master.</p>
<p>You can also change manage the index replication role (ie. master or
replica) and master URL on the fly. In other words, you can disconnect
any replica from a master (or switch it to a different master) online,
at any time. Read on for details.</p>
<blockquote>
<p>NOTE! Trivial config schema (<code>field = dummy</code>) is required
for <code>CREATE TABLE</code>, but in this case (empty freshly created
index) it gets ignored, and the actual index schema (and data, of
course) gets replicated from the master.</p>
</blockquote>
<h3 id="replication-mini-tutorial">Replication mini-tutorial</h3>
<p>Let’s extend that 30-second kickoff to a tiny, but complete
walkthrough. TLDR, we are going to launch a first <code>searchd</code>
instance with a regular RT index. Then launch a <strong>second</strong>
instance and make it replicate that index.</p>
<div class="sourceCode" id="cb195"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd sphinx-3.9.1/bin</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ./searchd <span class="at">-q</span> <span class="at">--datadir</span> ./master</span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a><span class="ex">listening</span> on all interfaces, port=9312</span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a><span class="ex">listening</span> on all interfaces, port=9306</span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a><span class="ex">loading</span> 0 indexes...</span></code></pre></div>
<p>Okay, first instance up. Let’s create our test index.</p>
<div class="sourceCode" id="cb196"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>$ mysql <span class="op">-</span>h127.<span class="dv">0</span>.<span class="fl">0.1</span> <span class="op">-</span>P9306</span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">create</span> <span class="kw">table</span> test1 (<span class="kw">id</span> bigint, title field, price bigint, j json);</span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.006</span> sec)</span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">insert</span> <span class="kw">into</span> test1 <span class="kw">values</span> (<span class="dv">123</span>, <span class="st">&#39;hello world&#39;</span>, <span class="dv">100</span>, <span class="st">&#39;{&quot;foo&quot;:&quot;bar&quot;}&#39;</span>);</span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.002</span> sec)</span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> test1;</span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+---------------+</span></span>
<span id="cb196-10"><a href="#cb196-10" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | price | j             |</span>
<span id="cb196-11"><a href="#cb196-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+---------------+</span></span>
<span id="cb196-12"><a href="#cb196-12" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> |   <span class="dv">100</span> | {<span class="ot">&quot;foo&quot;</span>:<span class="ot">&quot;bar&quot;</span>} |</span>
<span id="cb196-13"><a href="#cb196-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+---------------+</span></span>
<span id="cb196-14"><a href="#cb196-14" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.002</span> sec)</span></code></pre></div>
<p>So far so good. But at the moment that’s just a regular index on a
regular instance. We can check that there are no connected
followers.</p>
<div class="sourceCode" id="cb197"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show followers;</span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Empty</span> <span class="kw">set</span> (<span class="fl">0.001</span> sec)</span></code></pre></div>
<p>Now to the fun part: let’s launch a second instance, and replicate
that index!</p>
<div class="sourceCode" id="cb198"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ./searchd <span class="at">-q</span> <span class="at">--datadir</span> ./replica <span class="at">--listen</span> 8306:mysql</span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a><span class="ex">listening</span> on all interfaces, port=8306</span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a><span class="ex">loading</span> 0 indexes...</span></code></pre></div>
<p>Second instance up! At the moment it’s empty, as it should be.</p>
<div class="sourceCode" id="cb199"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>$ mysql <span class="op">-</span>h127.<span class="dv">0</span>.<span class="fl">0.1</span> <span class="op">-</span>P8306</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show <span class="kw">tables</span>;</span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a><span class="kw">Empty</span> <span class="kw">set</span> (<span class="fl">0.001</span> sec)</span></code></pre></div>
<blockquote>
<p>NOTE! We explicitly specify MySQL listener port 8306 for the replica.
That’s <strong>only</strong> needed as we’re running the replica locally
for simplicity! Normally, replicas will run on <strong>separate</strong>
machines, the default listener ports will be available, and that
<code>--listen</code> will be unnecessary.</p>
</blockquote>
<p><strong>And now, enters replication!</strong> On our second (replica)
instance, let’s create the same index, then point it to our first
(master) instance.</p>
<div class="sourceCode" id="cb200"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">create</span> <span class="kw">table</span> test1 (<span class="kw">id</span> bigint, title field, price bigint, j json);</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.006</span> sec)</span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">alter</span> <span class="kw">table</span> test1 <span class="kw">set</span> <span class="kw">option</span> repl_follow<span class="op">=</span><span class="st">&#39;127.0.0.1:9312&#39;</span>;</span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.002</span> sec)</span></code></pre></div>
<blockquote>
<p>NOTE! We currently require the replica-side index schema to match the
master schema, to protect from accidentally killing data.</p>
</blockquote>
<p>In literally a moment, we can observe the replicated index data
appear on our <strong>second</strong> instance.</p>
<div class="sourceCode" id="cb201"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> test1;</span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+---------------+</span></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | price | j             |</span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+---------------+</span></span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> |   <span class="dv">100</span> | {<span class="ot">&quot;foo&quot;</span>:<span class="ot">&quot;bar&quot;</span>} |</span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+---------------+</span></span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.002</span> sec)</span></code></pre></div>
<blockquote>
<p>NOTE! There <strong>must</strong> be a tiny pause after
<code>ALTER</code> to see changes in <code>SELECT</code> output on the
replica. While replication setup on a tiny index will be quick, it will
not be absolutely instant. Normally, even 1 second should suffice.</p>
</blockquote>
<p>The replica becomes read-only; all writes must now go through the
master.</p>
<div class="sourceCode" id="cb202"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">update</span> test1 <span class="kw">set</span> price<span class="op">=</span><span class="dv">200</span> <span class="kw">where</span> <span class="kw">id</span><span class="op">=</span><span class="dv">123</span>;</span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>ERROR <span class="dv">1064</span> (<span class="dv">42000</span>): direct writes <span class="kw">to</span> replicated <span class="kw">indexes</span> are forbidden</span></code></pre></div>
<p>Well, let’s try that.</p>
<div class="sourceCode" id="cb203"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mysql <span class="at">-h127.0.0.1</span> <span class="at">-P9306</span> <span class="at">-e</span> <span class="st">&quot;update test1 set price=200 where id=123&quot;</span></span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sleep 1</span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mysql <span class="at">-h127.0.0.1</span> <span class="at">-P8306</span> <span class="at">-t</span> <span class="at">-e</span> <span class="st">&quot;select * from test1&quot;</span></span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a><span class="ex">+------+-------+---------------+</span></span>
<span id="cb203-5"><a href="#cb203-5" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="fu">id</span>   <span class="kw">|</span> <span class="ex">price</span> <span class="kw">|</span> <span class="ex">j</span>             <span class="kw">|</span></span>
<span id="cb203-6"><a href="#cb203-6" aria-hidden="true" tabindex="-1"></a><span class="ex">+------+-------+---------------+</span></span>
<span id="cb203-7"><a href="#cb203-7" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>  <span class="ex">123</span> <span class="kw">|</span>   <span class="ex">200</span> <span class="kw">|</span> <span class="ex">{</span><span class="st">&quot;foo&quot;</span><span class="ex">:</span><span class="st">&quot;bar&quot;</span><span class="ex">}</span> <span class="kw">|</span></span>
<span id="cb203-8"><a href="#cb203-8" aria-hidden="true" tabindex="-1"></a><span class="ex">+------+-------+---------------+</span></span></code></pre></div>
<p>It works!</p>
<h3 id="replication-glossary">Replication glossary</h3>
<table>
<colgroup>
<col style="width: 23%" />
<col style="width: 76%" />
</colgroup>
<thead>
<tr class="header">
<th>Term</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Follower</td>
<td>Host that follows N replicas on M remote masters</td>
</tr>
<tr class="even">
<td>Lag</td>
<td>Replica side delay since the last successful replicated write</td>
</tr>
<tr class="odd">
<td>Master (host)</td>
<td>Host that is being followed by X followers and Y replicas</td>
</tr>
<tr class="even">
<td>Master (index)</td>
<td>Index that is being replicated by K replicas</td>
</tr>
<tr class="odd">
<td>Replica</td>
<td>Local replicated index that follows a remote (master) index</td>
</tr>
<tr class="even">
<td>(Replica) join</td>
<td>Process when a replica (re-)connects to a master</td>
</tr>
<tr class="odd">
<td>RID</td>
<td>Replica ID, a unique 64-bit host ID</td>
</tr>
<tr class="even">
<td>Role</td>
<td>Per-index replication role, “master” (default) or “replica”</td>
</tr>
<tr class="odd">
<td>Snapshot transfer</td>
<td>Process when a replica fetches the entire index from master</td>
</tr>
</tbody>
</table>
<h3 id="replication-overview">Replication overview</h3>
<p>The only <strong>requirement</strong> is the <code>repl_follow</code>
directive on the replica side, specifying which master instance to
follow. From there, the replication process should be more or less
automatic.</p>
<p><strong>A single instance can follow multiple masters (for different
FT indexes).</strong> On <code>searchd</code> start, all replicated
indexes connect to their designated masters, using one network
connection per each replicated index.</p>
<p><strong>Any index can serve as both a master and a replica, at the
same time.</strong> That allows for flexible, multi-layer cluster
topologies where intermediate replicas serve as masters to lower-level
“leaf” replicas.</p>
<p><strong>A single instance can have both replicated and regular local
indexes.</strong> Mixing the replicated and non-replicated RT indexes is
fine.</p>
<p><strong>Replicated indexes on replicas are read-only.</strong> (For
convenience, we should eventually implement write forwarding to the
respective master, but hey, first ever public release here.)</p>
<p><strong>Replicated indexes pull the snapshot on join, then pull the
WAL updates.</strong> Snapshots basically only pull missing files, too.
Let’s elaborate that a bit.</p>
<p>During <strong>replica join</strong>, ie. when a connection to master
is (re-)established, the replica <strong>must</strong> first synchronize
index data with the master. For that, it builds the index
<strong>manifest</strong> first (essentially just a list of index data
files names and hashes), compares it to current master’s manifest, and
downloads any missing (or mismatching) files from the master.</p>
<p>After the <strong>snapshot transfer</strong>, ie. once all the index
files are synced with the master, replica enables the replicated index,
starts serving reads (<code>SELECT</code> queries) to its clients, and
continuously checking for and syncing with any incoming writes from the
master.</p>
<p>To <strong>stay</strong> synchronized, the replica constantly checks
master for any new writes, then downloads and applies them. The
<code>repl_sync_tick_msec</code> directive controls the frequency of
those checks. Its default value is 100 msec.</p>
<p>The network traffic during this “online” sync depends on your data
writes rate, and equals your binlog (aka WAL) write rate on the master
side. Replicas stream the master’s binlog over the network, and apply it
locally.</p>
<p><strong>Replicated indexes are read-only to clients.</strong> All
data-modifying operations (<code>INSERT</code>, <code>DELETE</code>,
<code>REPLACE</code>, <code>UPDATE</code>, etc) are forbidden.
Replicated indexes only ever change by receiving and apply writes from
the master.</p>
<p><strong>FLUSHes and OPTIMIZEs on replicas also follow the
master.</strong> Automatic flushes (as per <code>rt_flush_period</code>
directive) are disabled, and <code>FLUSH</code> and
<code>OPTIMIZE</code> statements are forbidden on replica side.</p>
<p>To summarize that, <strong>replicated index == fully automatic
read-only replica.</strong> Our target scenario is “setup-and-forget”,
ie. point your replicated index to follow a master once, point readers
to use it, and everything else should happen automatically.</p>
<p><strong>Replication works over the native SphinxAPI
protocol.</strong> For the record, there are two new internal SphinxAPI
commands: <code>JOIN</code> that sends complete index files, and
<code>BINLOG</code> that sends recent transactions.</p>
<p><strong>Replication clients are prioritized on master side.</strong>
Replication SphinxAPI commands are “always VIP”: they bypass the thread
pool used for regular queries, and <em>always</em> get a dedicated
execution thread on master side.</p>
<h3 id="notable-replication-restrictions">Notable replication
restrictions</h3>
<p><strong>Replication is only supported for RT indexes</strong> at the
moment. PQ indexes can not yet be replicated.</p>
<p><strong>Replication is asynchronous</strong>, so there
<em>always</em> is some <strong>replication lag</strong>, ie. the delay
between the moment when the <em>master</em> successfully completes some
write, and the moment when any given <em>replica</em> starts seeing that
newly written data in its read queries.</p>
<p>Normally, replication lag should never rise higher than the sync tick
length (the <code>repl_sync_tick_msec</code> setting). Of course, with
an overloaded replica or master the replication lag can grow severe.</p>
<h3 id="managing-replicated-indexes-on-the-fly">Managing replicated
indexes on-the-fly</h3>
<p>Replicated indexes do not <em>require</em> any config file changes.
They can also be nicely managed online using a few SphinxQL statements.
Here’s a short summary.</p>
<ul>
<li><code>ALTER TABLE ... SET OPTION role</code> turns replication on
and off.</li>
<li><code>ALTER TABLE ... SET OPTION repl_follow</code> changes current
master.</li>
<li><code>SET GLOBAL {role | repl_follow}</code> does that globally, for
all RT indexes.</li>
<li><code>PULL</code> forces an immediate new transactions checks (for
troubleshooting).</li>
<li><code>RELOAD</code> forces a clean replica rejoin (for
troubleshooting).</li>
</ul>
<p>To switch the replication role and/or the target master for a single
RT index, use <code>ALTER TABLE</code> and set the respective
option.</p>
<div class="sourceCode" id="cb204"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a># syntax</span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span><span class="kw">index</span><span class="op">&gt;</span> <span class="kw">SET</span> <span class="kw">OPTION</span> <span class="kw">role</span> <span class="op">=</span> {<span class="st">&#39;master&#39;</span> | <span class="st">&#39;replica&#39;</span>}</span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span><span class="kw">index</span><span class="op">&gt;</span> <span class="kw">SET</span> <span class="kw">OPTION</span> repl_follow <span class="op">=</span> <span class="st">&#39;&lt;host&gt;:&lt;port&gt;&#39;</span></span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-5"><a href="#cb204-5" aria-hidden="true" tabindex="-1"></a># example: <span class="kw">stop</span> replication <span class="kw">on</span> <span class="kw">index</span> `foo`</span>
<span id="cb204-6"><a href="#cb204-6" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> foo <span class="kw">SET</span> <span class="kw">OPTION</span> <span class="kw">role</span> <span class="op">=</span> <span class="st">&#39;master&#39;</span></span>
<span id="cb204-7"><a href="#cb204-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-8"><a href="#cb204-8" aria-hidden="true" tabindex="-1"></a># example: <span class="kw">change</span> <span class="kw">master</span> <span class="kw">on</span> <span class="kw">index</span> `bar`</span>
<span id="cb204-9"><a href="#cb204-9" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> bar <span class="kw">SET</span> <span class="kw">OPTION</span> repl_follow <span class="op">=</span> <span class="st">&#39;192.168.1.23:9312&#39;</span></span></code></pre></div>
<blockquote>
<p>NOTE! Changing <code>repl_follow</code> automatically changes the
index role to replica.</p>
</blockquote>
<p>To switch the replication role and/or the target master for
<strong>all</strong> RT indexes served by a given <code>searchd</code>
instance, use <code>SET GLOBAL</code> instead.</p>
<div class="sourceCode" id="cb205"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a># syntax</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> <span class="kw">role</span> <span class="op">=</span> {<span class="st">&#39;master&#39;</span> | <span class="st">&#39;replica&#39;</span>}</span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> repl_follow <span class="op">=</span> <span class="st">&#39;&lt;host&gt;:&lt;port&gt;&#39;</span></span></code></pre></div>
<p>Use <code>PULL</code> to force a replicated index to
<strong>immediately</strong> pull any new writes from the master. That’s
for troubleshooting, as normally such pulls just happen
automatically.</p>
<div class="sourceCode" id="cb206"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a># syntax</span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a>PULL <span class="op">&lt;</span><span class="kw">index</span><span class="op">&gt;</span> [<span class="kw">OPTION</span> <span class="kw">timeout</span> <span class="op">=</span> <span class="op">&lt;</span>sec<span class="op">&gt;</span>]</span></code></pre></div>
<p>Last but not least, use <code>RELOAD</code> when a replicated index
gets stuck and won’t automatically recover. Beware that
<code>RELOAD</code> forces a rejoin, which might end up doing a full
index state transfer.</p>
<div class="sourceCode" id="cb207"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a># syntax</span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>RELOAD <span class="op">&lt;</span><span class="kw">index</span><span class="op">&gt;</span></span></code></pre></div>
<p>This also is for troubleshooting. Replicated indexes should
auto-recover from (inevitable) temporary network errors. However, severe
network errors or local disk errors <strong>may</strong> still put the
replicated index in an unrecoverable state, requiring manual inspection
and intervention.</p>
<p><code>RELOAD</code> is the intervention tool. It forces a specific
replicated index rejoin, without having to restart the entire server.
Most importantly, replicated index data should get re-downloaded from
the master again. Clean slate!</p>
<h3 id="monitoring-replication">Monitoring replication</h3>
<p>On replica side, use the <code>SHOW REPLICAS</code> statement to
examine the <strong>replicas</strong>, that is, replicated indexes.</p>
<div class="sourceCode" id="cb208"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a># syntax</span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a>SHOW REPLICAS</span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a># example</span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW REPLICAS \G</span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a><span class="op">***************************</span> <span class="fl">1.</span> <span class="kw">row</span> <span class="op">***************************</span></span>
<span id="cb208-7"><a href="#cb208-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">index</span>: 512494f3<span class="op">-</span>c3a772e8<span class="ch">:repl</span></span>
<span id="cb208-8"><a href="#cb208-8" aria-hidden="true" tabindex="-1"></a>    host: <span class="dv">127</span>.<span class="dv">0</span>.<span class="fl">0.1</span><span class="ch">:9312</span></span>
<span id="cb208-9"><a href="#cb208-9" aria-hidden="true" tabindex="-1"></a>     tid: <span class="dv">1</span></span>
<span id="cb208-10"><a href="#cb208-10" aria-hidden="true" tabindex="-1"></a>   state: IDLE</span>
<span id="cb208-11"><a href="#cb208-11" aria-hidden="true" tabindex="-1"></a>     <span class="fu">lag</span>: <span class="dv">4</span> msec</span>
<span id="cb208-12"><a href="#cb208-12" aria-hidden="true" tabindex="-1"></a>download: <span class="op">-/-</span></span>
<span id="cb208-13"><a href="#cb208-13" aria-hidden="true" tabindex="-1"></a>  uptime: 0h<span class="ch">:00m:13s</span></span>
<span id="cb208-14"><a href="#cb208-14" aria-hidden="true" tabindex="-1"></a>   error: <span class="op">-</span></span>
<span id="cb208-15"><a href="#cb208-15" aria-hidden="true" tabindex="-1"></a>manifest: {}</span>
<span id="cb208-16"><a href="#cb208-16" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>It shows all the replicated indexes (one per row) along with key
replication status details (master address, lag, last applied
transaction ID, etc).</p>
<p>On master side, use the <code>SHOW FOLLOWERS</code> statement to
examine all the currently registered <strong>followers</strong> (and
their replicas).</p>
<div class="sourceCode" id="cb209"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a># syntax</span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a>SHOW FOLLOWERS</span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a># example</span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW FOLLOWERS;</span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+-----------------+------+---------+</span></span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a>| replica                | addr            | tid  | <span class="fu">lag</span>     |</span>
<span id="cb209-8"><a href="#cb209-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+-----------------+------+---------+</span></span>
<span id="cb209-9"><a href="#cb209-9" aria-hidden="true" tabindex="-1"></a>| 512494f3<span class="op">-</span>c3a772e8<span class="ch">:repl</span> | <span class="dv">127</span>.<span class="dv">0</span>.<span class="fl">0.1</span><span class="ch">:54368</span> | <span class="dv">2</span>    | <span class="dv">39</span> msec |</span>
<span id="cb209-10"><a href="#cb209-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+-----------------+------+---------+</span></span>
<span id="cb209-11"><a href="#cb209-11" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>It shows all the recently active followers. “Recent” means 5 minutes.
Followers (or more precisely, replicas) that haven’t been active during
the past 5 minutes are automatically no longer considered active by the
master.</p>
<h3 id="configuring-replication-settings">Configuring replication
settings</h3>
<p>Ideally, replication should work fine “out-of-the-box”, and the
<code>repl_follow</code> config directive should be sufficient. However,
there always are special cases, and there <strong>are</strong> several
other tweakable directives that affect replication.</p>
<p>The most important one, <strong>set high enough
<code>binlog_erase_delay_sec</code> delay.</strong> We currently
recommend anything in the 30 to 600 seconds range, or even more.</p>
<p>Why? By default, master binlog files get <strong>immediately</strong>
erased during periodic disk flushes. So if an unlucky replica gets
temporarily disconnected just before the flush and reconnects after,
then the specific transaction range that it just missed while being away
might not be available any more. And then that replica gets
<strong>forced</strong> to perform a complete rejoin and state transfer.
Yuck. Avoid.</p>
<p><strong>For smaller replication lag, lower
<code>repl_sync_tick_msec</code> delay.</strong> Its allowed range
begins at 10 msec. So going lower than the default 100 msec should
improve the average replication lag. However, it puts extra pressure on
both the master and the replica. So use with care.</p>
<p><strong>For smaller replication lag, also lower
<code>repl_epoll_wait_msec</code> timeout.</strong> Replication uses a
single thread that multiplexes all replica-master networking (with
multiple network connections to different masters). This setting
controls the maximum possible “idle” timeout in that thread. It defaults
to 1000 msec.</p>
<p>A lower value results in a bit quicker master response handling on
the replica side, but may increase replica side CPU usage. A higher
value reduces CPU usage, but may increase replication lag (not always,
but under certain circumstances).</p>
<p>To absolutely minimize the average replication lag, you can try
setting this lower. We currently recommend anything in the range of 100
to 500 msec.</p>
<p><strong>With many replicated indexes, increase
<code>repl_threads</code> for better throughput.</strong>
<code>repl_threads</code> is the number of threads used for syncing the
replicated indexes, and it defaults to 4 threads. Usually that’s
sufficient, but when there are many replicated indexes (say more than
100) and/or very many writes, having more threads can improve replica
side write throughput.</p>
<p>And vice versa, when there are just a few replicated indexes and/or
very little writes, then <code>repl_threads</code> can be safely
reduced.</p>
<p><strong>With low loads, higher <code>repl_sync_tick_msec</code> may
reduce network load.</strong> Speaking of “very little writes”, when
writes are rare and/or replication lag isn’t a concern, setting
<code>repl_sync_tick_msec</code> <em>higher</em> (say from 1000 to 5000
msec) might slightly reduce network and CPU load, on both the master
side and the replica side.</p>
<p>This is a <em>very</em> borderline usecase. So if not
<em>completely</em> sure, don’t.</p>
<p><strong>For unstable networks, tweak packet sizes and
timeouts.</strong> Under unstable network conditions, it might be useful
to reduce <code>repl_binlog_packet_size</code> and/or increase
<code>repl_net_timeout_sec</code> to improve reliability. (Another
borderline usecase.)</p>
<h3 id="cloning-via-replication">Cloning via replication</h3>
<p>Replication also enables one-off cloning of either individual indexes
or entire instances. Here’s how!</p>
<p><strong>To clone an individual index, use the
<code>CLONE INDEX</code> statement</strong>, as follows.</p>
<div class="sourceCode" id="cb210"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CLONE</span> <span class="kw">INDEX</span> index1 <span class="kw">FROM</span> <span class="st">&#39;srchost.internal:9312`</span></span></code></pre></div>
<p>This example <code>CLONE INDEX</code> connects to
<code>srchost.internal</code>, becomes its follower, fetches its current
snapshot of <code>index1</code> (same as <code>repl_follow</code>
would), but then (unlike <code>repl_follow</code>) it immediately
disconnects.</p>
<p>So on success, the resulting <code>index1</code> on the current host
will contain a fresh <strong>writable</strong> snapshot of
<code>index1</code> as taken from <code>srchost.internal</code> at the
start of the <code>CLONE INDEX</code> execution. Effectively, this is
<strong>one-shot replication</strong> (as opposed to the regular
<strong>continuous</strong> replication).</p>
<p><strong>To clone all matching indexes, use the <code>CLONE</code>
statement</strong>, as follows.</p>
<div class="sourceCode" id="cb211"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CLONE</span> <span class="kw">FROM</span> <span class="st">&#39;srchost.internal:9312&#39;</span></span></code></pre></div>
<p>This automatically clones RT indexes that “match” across the current
host and the source host, ie. all indexes that exist on
<strong>both</strong> hosts.</p>
<p>This behavior must initially seem rather weird. The thing is, our
very first target use-case for <code>CLONE</code> is <em>not</em>
populating a clean new instance. Instead, it’s for <strong>cross-DC
disaster recovery</strong>, and for a specific setup that avoids
continuous cross-DS replication, too.</p>
<p>(Also, work in progress! We will likely extended <code>CLONE</code>
syntax in the future.)</p>
<p><strong>What is cloning even for?</strong></p>
<p>Cloning is <strong>very</strong> useful for a number of tasks: making
backups and snapshots, populating staging instances, recovering data
from a good host, etc.</p>
<p>Now, some nuts and bolts!</p>
<p><strong>Cloning is asynchronous!</strong> Both <code>CLONE</code>
statements start the cloning process, but they do <strong>not</strong>
block until its completion. To monitor its progress, you can use
<code>SHOW REPLICAS</code> and/or tail the <code>searchd.log</code>
file.</p>
<p><strong>Cloning can be interrupted.</strong> As cloning is based on
replication, switching any replicas back to master “as usual” stops it
too.</p>
<p>So <code>ALTER TABLE &lt;rtindex&gt; SET OPTION role='master'</code>
stops cloning of a specific individual index. And
<code>SET GLOBAL role='master'</code> globally stops all replication
(including cloning) on the current host.</p>
<p><strong>Existing replicas take priority.</strong> Trying to clone an
index that is already being continuously replicated must return an
error.</p>
<p><strong>Existing local data is protected by default.</strong> By
default, both <code>CLONE INDEX</code> and <code>CLONE</code> will only
clone indexes that are <strong>empty</strong> on the current, target
host. However, you can force them to drop any local data as needed.</p>
<div class="sourceCode" id="cb212"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CLONE</span> <span class="kw">FROM</span> <span class="st">&#39;srchost.internal:9312&#39;</span> <span class="kw">OPTION</span> <span class="kw">FORCE</span><span class="op">=</span><span class="dv">1</span></span></code></pre></div>
<p><strong>On any replication failure, cloning aborts.</strong> For
example, if <code>index1</code> does not exist on <code>srchost</code>,
the existing local <code>index1</code> should stay unchanged.</p>
<p><strong>On certain failures, indexes can remain
inconsistent.</strong> Think disk or network issues. To minimize
user-facing errors, we currently strongly recommend:</p>
<ul>
<li>temporarily disabling searches on the target host while
cloning;</li>
<li>checking <code>searchd.log</code> to verify that cloning completed
successfully.</li>
</ul>
<h2 id="using-datadir">Using datadir</h2>
<p>Starting with v.3.5 we are actively converting to <strong>datadir
mode</strong> that unifies Sphinx data files layout. Legacy non-datadir
configs are still supported as of v.3.5, but that support is slated for
removal. You should convert ASAP.</p>
<p>The key changes that the datadir mode introduces are as follows.</p>
<ol type="1">
<li>Sphinx now keeps all its data files in a single “datadir”
folder.</li>
<li>Most (or all) of the configurable paths are now deprecated.</li>
<li>Most (or all) the “resource” files must now be referenced by name
only.</li>
</ol>
<p><strong>“Data files” include pretty much everything</strong>, except
perhaps <code>.conf</code> files. Completely everything! Both Sphinx
data files (ie. FT indexes, binlogs, searchd logs, query logs, etc),
<em>and</em> custom user “resource” files (ie. stopwords, mappings,
morphdicts, lemmatizer dictionaries, global IDFs, UDF binaries, etc)
<em>must</em> now all be placed in datadir.</p>
<p><strong>The default datadir name is
<code>./sphinxdata</code></strong>, however, you can (and really
<em>should</em>!) specify some non-default location instead. Either with
a <code>datadir</code> directive in the <code>common</code> section of
your config file, or using the <code>--datadir</code> CLI switch. It’s
prudent to use <em>absolute</em> paths rather than relative ones,
too.</p>
<p><strong>The CLI switch takes priority over the config.</strong> Makes
working with multiple instances easier.</p>
<p><strong>Datadirs are designed to be location-agnostic.</strong>
Moving the entire Sphinx instance <em>must</em> be as simple as moving
the datadir (and maybe the config), and changing that single
<code>datadir</code> config directive.</p>
<p><strong>Internal datadir folder layout is now predefined.</strong>
For reference, there are the following subfolders.</p>
<table>
<thead>
<tr class="header">
<th>Folder</th>
<th>Contents</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>binlogs</code></td>
<td>Per-index WAL files</td>
</tr>
<tr class="even">
<td><code>extra</code></td>
<td>User resource files, with <strong>unique</strong> filenames</td>
</tr>
<tr class="odd">
<td><code>indexes</code></td>
<td>FT indexes, one <code>indexes/&lt;NAME&gt;/</code> subfolder per
index</td>
</tr>
<tr class="even">
<td><code>logs</code></td>
<td>Logs, ie. <code>searchd.log</code>, <code>query.log</code>, etc</td>
</tr>
<tr class="odd">
<td><code>plugins</code></td>
<td>User UDF binaries, ie. the <code>.so</code> files</td>
</tr>
</tbody>
</table>
<p>There also are a few individual “system” files too, such as PID file,
dynamic state files, etc, currently placed in the root folder.</p>
<p><strong>Resource files must now be referenced by base file names
only.</strong> In datadir mode, you now <strong><em>must</em></strong>
do the following.</p>
<ol type="1">
<li>place all your resource files into <code>$datadir/extra/</code>
folder;</li>
<li>give them unique names (unique within the <code>extra</code>
folder);</li>
<li>refer to those files (from config directives) by name only.</li>
</ol>
<p>Very briefly, you now must use names only, like
<code>stopwords = mystops.txt</code>, and you now must place that
<code>mystops.txt</code> anywhere within the <code>extra/</code> folder.
For more details see <a href="#migrating-to-datadir">“Migrating to
datadir”</a>.</p>
<p><strong>Any subfolder structure within <code>extra</code> is
intentionally ignored.</strong> This lets you very easily rearrange the
resource files whenever and however you find convenient. This is also
one of the reasons why the names must be unique.</p>
<p><strong>Logs and binlogs are now stored in a fixed location; still
can be disabled.</strong> They are enabled by default, with
<code>query_log_min_msec = 1000</code> threshold for the query log.
However, you can still disable them. For binlogs, there now is a new
<code>binlog</code> directive for that.</p>
<ul>
<li><code>log =</code> (no value) or <code>log = no</code> disables the
daemon log (NOT recommended!);</li>
<li><code>query_log =</code> or <code>query_log = no</code> disables the
query log;</li>
<li><code>binlog = 0</code> disables all binlogs, ie. WALs.</li>
</ul>
<h2 id="migrating-to-datadir">Migrating to datadir</h2>
<p>Legacy non-datadir configs are still supported in v.3.5. However,
that support just <em>might</em> get dropped as soon as in v.3.6. So you
should convert ASAP.</p>
<p>Once you add a datadir directive, your config becomes subject to
extra checks, and your files layout changes. Here’s a little extra info
on how to upgrade.</p>
<p><strong>The index <code>path</code> is now deprecated!</strong> Index
data files are now automatically placed into “their” respective folders,
following the <code>$datadir/indexes/$name/</code> pattern, where
<code>$name</code> is the index name. And the <code>path</code>
directives must now be removed from the datadir-mode configs.</p>
<p><strong>The index format is still generally backwards
compatible.</strong> Meaning that you may be able to simply move the
older index files “into” the new layout. Those should load and work
okay, save for a few warnings to convert to basenames. However,
non-unique resource files names may prevent that, see below.</p>
<p><strong>Resource files should be migrated, and their names should be
made unique</strong>. This is probably best explained with an example.
Assume that you had <code>stopwords</code> and <code>mappings</code> for
index <code>test1</code> configured as follows.</p>
<div class="sourceCode" id="cb213"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> test1</span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">stopwords</span> = /home/sphinx/morph/stopwords/test1.txt</span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">mappings</span> = /home/sphinx/morph/mappings/test1.txt</span>
<span id="cb213-6"><a href="#cb213-6" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>Assume that you placed your datadir at
<code>/home/sphinx/sphinxdata</code> when upgrading. You should then
move these resource files into <code>extra</code>, assign them unique
names along the way, and update the config respectively.</p>
<div class="sourceCode" id="cb214"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /home/sphinx</span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> sphinxdata/extra/stopwords</span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> sphinxdata/extra/mappings</span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mv</span> morph/stopwords/test1.txt sphinxdata/extra/stopwords/test1stops.txt</span>
<span id="cb214-5"><a href="#cb214-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mv</span> morph/mappings/test1.txt sphinxdata/extra/mappings/test1maps.txt</span></code></pre></div>
<div class="sourceCode" id="cb215"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> test1</span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb215-3"><a href="#cb215-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb215-4"><a href="#cb215-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">stopwords</span> = test1stops.txt</span>
<span id="cb215-5"><a href="#cb215-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">mappings</span> = test1maps.txt</span>
<span id="cb215-6"><a href="#cb215-6" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p><strong>Note that non-unique resource files names might be embedded
in your indexes.</strong> Alas, in that case you’ll have to rebuild your
indexes. Because once you switch to datadir, Sphinx can no longer
differentiate between the two <code>test1.txt</code> base names, you
gotta be more specific that that.</p>
<p><strong>A few config directives “with paths” should be
updated.</strong> These include <code>log</code>,
<code>query_log</code>, <code>binlog_path</code>, <code>pid_file</code>,
<code>lemmatizer_base</code>, and <code>sphinxql_state</code>
directives. The easiest and recommended way is to rely on the current
defaults, and simply remove all these directives. As for lemmatizer
dictionary files (ie. the <code>.pak</code> files), those should now
placed anywhere in the <code>extra</code> folder.</p>
<p>Last but not least, <strong>BACKUP YOUR INDEXES</strong>.</p>
<h2 id="indexing-data-sources">Indexing: data sources</h2>
<p>Data that <code>indexer</code> (the ETL tool) grabs and indexes must
come from somewhere, and we call that “somewhere” a <strong>data
source</strong>.</p>
<p>Sphinx supports 10 different source types that fall into 3 major
kinds:</p>
<ul>
<li>SQL sources (<code>mysql</code>, <code>pgsql</code>,
<code>odbc</code>, and <code>mssql</code>),</li>
<li>pipe sources (<code>csvpipe</code>, <code>tsvpipe</code>, and
<code>xmlpipe2</code>), and</li>
<li>join sources (<code>tsvjoin</code>, <code>csvjoin</code>,
<code>binjoin</code>).</li>
</ul>
<p>So every source declaration in Sphinx rather naturally begins with <a
href="#source-type-directive">a <code>type</code> directive</a>.</p>
<p><strong>SQL and pipe sources are the primary data sources.</strong>
At least one of those is required in every <code>indexer</code>-indexed
index (sorry, just could not resist).</p>
<p><strong>Join sources are secondary, and optional.</strong> They
basically enable joins across different systems, performed on
<code>indexer</code> side. For instance, think of joining MySQL query
result against a CSV file. We discuss them below.</p>
<p><strong>All per-source directives depend on the source type.</strong>
That is even reflected in their names. For example,
<code>tsvpipe_header</code> is not legal for <code>mysql</code> source
type. (However, the current behavior still is to simply ignore such
directives rather that to raise errors.)</p>
<p>For the record, the <code>sql_xxx</code> directives are legal in all
the SQL types, ie. <code>mysql</code>, <code>pgsql</code>,
<code>odbc</code>, and <code>mssql</code>.</p>
<p><strong>The pipe and join types are always supported.</strong>
Meaning that support for <code>csvpipe</code>, <code>tsvpipe</code>,
<code>xmlpipe2</code>, <code>csvjoin</code>, <code>tsvjoin</code> and
<code>binjoin</code> types is always there. It’s fully built-in and does
not require any external libraries.</p>
<p><strong>The SQL types require an installed driver.</strong> To access
this or that SQL DB, public Sphinx builds <em>require</em> the
respective dynamic client library installed. See the section on <a
href="#installing-sql-drivers">installing SQL drivers</a> for a bit more
details.</p>
<p><strong><code>mssql</code> source type is currently only available on
Windows.</strong> That one uses the native driver, might be a bit easier
to configure and use. But if you have to run <code>indexer</code> on a
different platform, you can still access MS SQL too, just use the
<code>odbc</code> driver for that.</p>
<h2 id="indexing-sql-databases">Indexing: SQL databases</h2>
<p><code>indexer</code> can connect to most SQL databases (MySQL,
PostgreSQL, MS SQL, Oracle, Firebird are known to work), query them, and
<strong>index the SQL query result.</strong></p>
<p>As always, you can start in under a minute, just setup your access
credentials and the “main” query that fetches data to index, and we are
a go.</p>
<div class="sourceCode" id="cb216"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> my1</span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = mysql</span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_host</span> = 127.0.0.1</span>
<span id="cb216-6"><a href="#cb216-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_port</span> = 3306</span>
<span id="cb216-7"><a href="#cb216-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_user</span> = test</span>
<span id="cb216-8"><a href="#cb216-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_pass</span> =</span>
<span id="cb216-9"><a href="#cb216-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_db</span> = test</span>
<span id="cb216-10"><a href="#cb216-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-11"><a href="#cb216-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_query</span> = SELECT <span class="pp">*</span> FROM documents</span>
<span id="cb216-12"><a href="#cb216-12" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p><code>type</code> must be one of <code>mysql</code>,
<code>pgsql</code>, or <code>odbc</code>, and the respective driver must
be present. See also <a href="#installing-sql-drivers">“Installing SQL
drivers”</a>. Also, on Windows we natively support <code>mssql</code>;
either <code>odbc</code> or <code>mssql</code> works.</p>
<p><code>sql_host</code>, <code>sql_port</code> and
<code>sql_sock</code> directives specify host, TCP port, and UNIX socket
for the connection, respectively. <code>sql_user</code> and
<code>sql_pass</code> specify the <strong>database</strong> user and
password, these are the access credentials. <code>sql_port</code> and
<code>sql_sock</code> are optional, all the other ones are mandatory.
It’s convenient to specify them just once, and then reuse them by
inheriting, like so.</p>
<div class="sourceCode" id="cb217"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> base</span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = mysql</span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_host</span> = 127.0.0.1</span>
<span id="cb217-5"><a href="#cb217-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_user</span> = test</span>
<span id="cb217-6"><a href="#cb217-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_pass</span> =</span>
<span id="cb217-7"><a href="#cb217-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_db</span> = test</span>
<span id="cb217-8"><a href="#cb217-8" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb217-9"><a href="#cb217-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-10"><a href="#cb217-10" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> my1 : base</span>
<span id="cb217-11"><a href="#cb217-11" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb217-12"><a href="#cb217-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_query</span> = SELECT <span class="pp">*</span> FROM documents</span>
<span id="cb217-13"><a href="#cb217-13" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb217-14"><a href="#cb217-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-15"><a href="#cb217-15" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> my2 : base</span>
<span id="cb217-16"><a href="#cb217-16" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb217-17"><a href="#cb217-17" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_query</span> = SELECT <span class="pp">*</span> FROM forumthreads</span>
<span id="cb217-18"><a href="#cb217-18" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>Here’s one pretty important note on <code>sql_host</code> in MySQL
case specifically. Beware that MySQL client libraries
(<code>libmysqlclient</code> and <code>libmariadb-client</code> and
maybe others too) <strong>choose TCP/IP or UNIX socket based on the host
name.</strong></p>
<p>To elaborate, using <code>localhost</code> makes them connect via
UNIX socket, while using <code>127.0.0.1</code> or other numeric IPs
makes them connect via TCP/IP. To support that in Sphinx, we have
<code>sql_sock</code> and <code>sql_port</code> directives that override
client library defaults for UNIX socket path and TCP port,
respectively.</p>
<p><code>sql_db</code> is what MySQL calls “database” and PostgreSQL
calls “schema”, and both pretty much require to specify. It’s also
mandatory.</p>
<p>And the final mandatory setting is <code>sql_query</code> that
<code>indexer</code> will be indexing. <strong>Any query works, as long
as it returns a result set.</strong> Sphinx itself does not have any
checks or constraints on that. It simply passes your
<code>sql_query</code> to your SQL database, and indexes whatever
response it gets. <code>sql_query</code> does not even have to be a
<code>SELECT</code> query! For example, you can easily index the results
of, say, a stored procedure <code>CALL</code> just as well.</p>
<p><strong>All columns coming from <code>sql_query</code> must (later)
map to index schema.</strong> That was covered in <a
href="#schemas-index-config">“Schemas: index config”</a>, as you surely
remember.</p>
<p><strong>You would usually avoid SELECT-star queries.</strong> That’s
where our example above diverges instantly with the real world. Because
SQL schemas change all the time! So you would almost always want to use
an <strong>explicit</strong> list of columns instead.</p>
<div class="sourceCode" id="cb218"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> my1 : base</span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_query</span> = SELECT id, group_id, title, content FROM documents</span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>What else is there to indexing SQL sources, at a glance?</p>
<ul>
<li>ranged queries (a must for larger datasets)</li>
<li>pre-queries and post-queries, for setup and cleanup,
respectively</li>
<li>additional queries to fetch set attributes, and/or K-batches</li>
<li>database-specific directives (such as
<code>mysql_connect_flags</code>)</li>
<li>debugging and profiling switches to <code>indexer build</code></li>
<li>(obscure) SSL connections to MySQL servers</li>
<li>(obscure) indexer-side decompression</li>
</ul>
<p>TODO: document all that!</p>
<h2 id="indexing-csv-and-tsv-files">Indexing: CSV and TSV files</h2>
<p><code>indexer</code> supports indexing data in both CSV and TSV
formats, via the <code>csvpipe</code> and <code>tsvpipe</code> source
types, respectively. Here’s a brief cheat sheet on the respective source
directives.</p>
<ul>
<li><code>csvpipe_command = ...</code> specifies a command to run (for
instance, <code>csvpipe_command = cat mydata.csv</code> in the simplest
case).</li>
<li><code>csvpipe_header = 1</code> tells the <code>indexer</code> to
pick the column list from the first row (otherwise, by default, the
column list has to be specified in the config file).</li>
<li><code>csvpipe_delimiter</code> changes the column delimiter to a
given character (this is <code>csvpipe</code> only; <code>tsvpipe</code>
naturally uses tabs).</li>
</ul>
<p>When working with TSV, you would use the very same directives, but
start them with <code>tsvpipe</code> prefix (ie.
<code>tsvpipe_command</code>, <code>tsvpipe_header</code>, etc).
Everything below applies to both CSV and TSV.</p>
<p>The first column is currently always treated as <code>id</code>, and
must be a unique document identifier.</p>
<p>The first row can either be treated as a named list of columns (when
<code>csvpipe_header = 1</code>), or as a first row of actual data. By
default it’s treated as data. The column names are trimmed, so a bit of
extra whitespace should not hurt.</p>
<p><code>csvpipe_header</code> affects how CSV input columns are matched
to Sphinx attributes and fields.</p>
<p>With <code>csvpipe_header = 0</code> the input file only contains
data, and the index schema (which defines the expect CSV columns order)
is taken from the config. Thus, the order of <code>attr_XXX</code> and
<code>field</code> directives (in the respective index) is quite
important in this case. You have to explicitly declare <em>all</em> the
fields and attributes (except the leading <code>id</code>), and in
<em>exactly</em> the same order they appear in the CSV file.
<code>indexer</code> will help and warn if there were unmatched or
extraneous columns.</p>
<p>With <code>csvpipe_header = 1</code> the input file starts with the
column names list, so the declarations from the config file are only
used to set the types. In that case, the index schema <em>order</em>
does not matter that much any more. The proper CSV columns will be found
by name alright.</p>
<p>In other words, <strong>you can easily “reorder” CSV columns via
<code>csvpipe_header</code></strong>. Say, what if your source CSV (or
TSV) data has got some column order that’s not compatible with Sphinx
order: that is, full-text fields scattered randomly, and definitely
<strong>not</strong> all nicely packed together immediately after the
<code>id</code> column? No problem really, just prepend a single header
line that declares <strong>your</strong> order, and throw in the
<code>csvpipe_header</code> directive, as follows.</p>
<div class="sourceCode" id="cb219"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat data.csv</span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a><span class="ex">123,</span> 11, hello world, 347540, document number one</span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a><span class="ex">124,</span> 12, hello again, 928879, document number two</span>
<span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-5"><a href="#cb219-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat header.csv</span>
<span id="cb219-6"><a href="#cb219-6" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span>, gid, title, price, content</span>
<span id="cb219-7"><a href="#cb219-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-8"><a href="#cb219-8" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat sphinx.conf</span>
<span id="cb219-9"><a href="#cb219-9" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> csv1</span>
<span id="cb219-10"><a href="#cb219-10" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb219-11"><a href="#cb219-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = csvpipe</span>
<span id="cb219-12"><a href="#cb219-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">csvpipe_command</span> = cat header.csv data.csv</span>
<span id="cb219-13"><a href="#cb219-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">csvpipe_header</span> = 1</span>
<span id="cb219-14"><a href="#cb219-14" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb219-15"><a href="#cb219-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-16"><a href="#cb219-16" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> csv1</span>
<span id="cb219-17"><a href="#cb219-17" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb219-18"><a href="#cb219-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">source</span> = csv1</span>
<span id="cb219-19"><a href="#cb219-19" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = title, content</span>
<span id="cb219-20"><a href="#cb219-20" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span> = gid, price</span>
<span id="cb219-21"><a href="#cb219-21" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>At the moment, <strong>you can’t ignore CSV columns</strong>. In
other words, can’t just drop that “price” from <code>attr_uint</code>
list, <code>indexer</code> will bark. That isn’t hard to add, but
frankly, we’ve yet to see <strong>one</strong> use case where filtering
input CSVs just could not be done elsewhere.</p>
<p>That’s it, except here goes a bit of pre-3.6 migration advice. (Just
ignore that if you’re on v.3.7 and newer.)</p>
<p><strong>LEGACY WARNING:</strong> with the deprecated
<code>csvpipe_attr_xxx</code> schema definition syntax at the source
level <em>and</em> <code>csvpipe_header = 1</code>, any CSV columns that
were not configured explicitly would get auto-configured as full-text
fields. When migrating such configs to use index level schema
definitions, you now <em>have</em> to explicitly list all the fields.
For example.</p>
<div class="sourceCode" id="cb220"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="ex">1.csv:</span></span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span>, gid, title, content</span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a><span class="ex">123,</span> 11, hello world, document number one</span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a><span class="ex">124,</span> 12, hello again, document number two</span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-7"><a href="#cb220-7" aria-hidden="true" tabindex="-1"></a><span class="ex">sphinx.conf:</span></span>
<span id="cb220-8"><a href="#cb220-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-9"><a href="#cb220-9" aria-hidden="true" tabindex="-1"></a><span class="co"># note how &quot;title&quot; and &quot;content&quot; were implicitly configured as fields</span></span>
<span id="cb220-10"><a href="#cb220-10" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> legacy_csv1</span>
<span id="cb220-11"><a href="#cb220-11" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb220-12"><a href="#cb220-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = csvpipe</span>
<span id="cb220-13"><a href="#cb220-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">csvpipe_command</span> = cat 1.csv</span>
<span id="cb220-14"><a href="#cb220-14" aria-hidden="true" tabindex="-1"></a>    <span class="ex">csvpipe_header</span> = 1</span>
<span id="cb220-15"><a href="#cb220-15" aria-hidden="true" tabindex="-1"></a>    <span class="ex">csvpipe_attr_uint</span> = gid</span>
<span id="cb220-16"><a href="#cb220-16" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb220-17"><a href="#cb220-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-18"><a href="#cb220-18" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> csv1</span>
<span id="cb220-19"><a href="#cb220-19" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb220-20"><a href="#cb220-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = csvpipe</span>
<span id="cb220-21"><a href="#cb220-21" aria-hidden="true" tabindex="-1"></a>    <span class="ex">csvpipe_command</span> = cat 1.csv</span>
<span id="cb220-22"><a href="#cb220-22" aria-hidden="true" tabindex="-1"></a>    <span class="ex">csvpipe_header</span> = 1</span>
<span id="cb220-23"><a href="#cb220-23" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb220-24"><a href="#cb220-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-25"><a href="#cb220-25" aria-hidden="true" tabindex="-1"></a><span class="co"># note how we have to explicitly configure &quot;title&quot; and &quot;content&quot; now</span></span>
<span id="cb220-26"><a href="#cb220-26" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> csv1</span>
<span id="cb220-27"><a href="#cb220-27" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb220-28"><a href="#cb220-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">source</span> = csv1</span>
<span id="cb220-29"><a href="#cb220-29" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = title, content</span>
<span id="cb220-30"><a href="#cb220-30" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span> = gid</span>
<span id="cb220-31"><a href="#cb220-31" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<h2 id="indexing-xml-files">Indexing: XML files</h2>
<p><code>indexer</code> also supports indexing data in XML format, via
the <code>xmlpipe2</code> source type. The relevant directives are:</p>
<ul>
<li><code>xmlpipe_command = ...</code> specifies a command to run (for
instance, <code>xmlpipe_command = cat mydata.xml</code> in the simplest
case).</li>
<li><code>xmlpipe_fixup_utf8 = 1</code> makes <code>indexer</code>
ignore UTF-8 errors.</li>
<li><code>max_xmlpipe2_field</code> puts a size limit on XML fields,
default’s 2 MB.</li>
</ul>
<p>In Sphinx eyes it’s just another format for shipping data into
Sphinx; sometimes maybe more convenient than CSV, TSV, or SQL; sometimes
not.</p>
<p><strong>Sphinx requires a few special XML tags to distinguish
individual documents.</strong> Those would usually need to be injected
into your XMLs (and usually regexps and <code>sed</code> work much
better than XSLT).</p>
<p>Also, you can embed a kill-batch (aka k-batch) in the same XML stream
along with your documents. But that’s optional.</p>
<p>Here’s an example XML document that Sphinx can handle.</p>
<div class="sourceCode" id="cb221"><pre
class="sourceCode xml"><code class="sourceCode xml"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;utf-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">sphinx:docset</span>&gt;</span>
<span id="cb221-3"><a href="#cb221-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-4"><a href="#cb221-4" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">sphinx:document</span><span class="ot"> id=</span><span class="st">&quot;1234&quot;</span>&gt;</span>
<span id="cb221-5"><a href="#cb221-5" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">content</span>&gt;this is the main content <span class="bn">&lt;![CDATA[</span>[and this &lt;cdata&gt; entry</span>
<span id="cb221-6"><a href="#cb221-6" aria-hidden="true" tabindex="-1"></a>must be handled properly by xml parser lib<span class="bn">]]&gt;</span>&lt;/<span class="kw">content</span>&gt;</span>
<span id="cb221-7"><a href="#cb221-7" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">published</span>&gt;1012325463&lt;/<span class="kw">published</span>&gt;</span>
<span id="cb221-8"><a href="#cb221-8" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">subject</span>&gt;note how field/attr tags can be</span>
<span id="cb221-9"><a href="#cb221-9" aria-hidden="true" tabindex="-1"></a>in &lt;<span class="kw">b</span><span class="ot"> class=</span><span class="st">&quot;red&quot;</span>&gt;randomized&lt;/<span class="kw">b</span>&gt; order&lt;/<span class="kw">subject</span>&gt;</span>
<span id="cb221-10"><a href="#cb221-10" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">misc</span>&gt;some undeclared element&lt;/<span class="kw">misc</span>&gt;</span>
<span id="cb221-11"><a href="#cb221-11" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">sphinx:document</span>&gt;</span>
<span id="cb221-12"><a href="#cb221-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-13"><a href="#cb221-13" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">sphinx:document</span><span class="ot"> id=</span><span class="st">&quot;1235&quot;</span>&gt;</span>
<span id="cb221-14"><a href="#cb221-14" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">subject</span>&gt;another subject&lt;/<span class="kw">subject</span>&gt;</span>
<span id="cb221-15"><a href="#cb221-15" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">content</span>&gt;here comes another document, and i am given to understand,</span>
<span id="cb221-16"><a href="#cb221-16" aria-hidden="true" tabindex="-1"></a>that in-document field order must not matter, sir&lt;/<span class="kw">content</span>&gt;</span>
<span id="cb221-17"><a href="#cb221-17" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">published</span>&gt;1012325467&lt;/<span class="kw">published</span>&gt;</span>
<span id="cb221-18"><a href="#cb221-18" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">sphinx:document</span>&gt;</span>
<span id="cb221-19"><a href="#cb221-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-20"><a href="#cb221-20" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ... even more sphinx:document entries here ... --&gt;</span></span>
<span id="cb221-21"><a href="#cb221-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-22"><a href="#cb221-22" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">sphinx:killlist</span>&gt;</span>
<span id="cb221-23"><a href="#cb221-23" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">id</span>&gt;1234&lt;/<span class="kw">id</span>&gt;</span>
<span id="cb221-24"><a href="#cb221-24" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">id</span>&gt;4567&lt;/<span class="kw">id</span>&gt;</span>
<span id="cb221-25"><a href="#cb221-25" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">sphinx:killlist</span>&gt;</span>
<span id="cb221-26"><a href="#cb221-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-27"><a href="#cb221-27" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">sphinx:docset</span>&gt;</span></code></pre></div>
<p>And here’s it’s complementary config.</p>
<div class="sourceCode" id="cb222"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> xml1</span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = xmlpipe2</span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">xmlpipe_command</span> = cat data.xml</span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb222-6"><a href="#cb222-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-7"><a href="#cb222-7" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> xml1</span>
<span id="cb222-8"><a href="#cb222-8" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb222-9"><a href="#cb222-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">source</span> = xml1</span>
<span id="cb222-10"><a href="#cb222-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = subject, content</span>
<span id="cb222-11"><a href="#cb222-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span> = published, author_id</span>
<span id="cb222-12"><a href="#cb222-12" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p><strong>Arbitrary fields and attributes in arbitrary order are
allowed.</strong> The order within each
<code>&lt;sphinx:document&gt;</code> tag does not matter. Because
<code>indexer</code> binds XML tags contents using the schema declared
in the FT index.</p>
<p><strong>There is a restriction on maximum field length.</strong> By
default, fields longer than 2 MB will be truncated.
<code>max_xmlpipe2_field</code> controls that.</p>
<p><strong>The schema must now be declared at the FT index
level.</strong> The in-XML schemas that were previously supported before
are now deprecated and will be removed.</p>
<p><strong>Unknown document-level tags are ignored with a
warning.</strong> In the example above <code>&lt;misc&gt;</code> does
not map to any field or attribute, and gets ignored, loudly.</p>
<div class="sourceCode" id="cb223"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> indexer <span class="at">-q</span> <span class="at">--datadir</span> ./sphinxdata xml1</span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WARNING:</span> source <span class="st">&#39;xml1&#39;</span>: unknown field/attribute <span class="st">&#39;misc&#39;</span><span class="kw">;</span></span>
<span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">ignored</span> <span class="er">(</span><span class="va">line</span><span class="op">=</span>10, <span class="va">pos</span><span class="op">=</span>0, <span class="va">docid</span><span class="op">=</span>0<span class="kw">)</span></span></code></pre></div>
<p><strong>Unknown embedded tags (and their attributes) are silently
ignored.</strong> For one, those <code>&lt;b&gt;</code> tags in document
1234’s <code>&lt;subject&gt;</code> are silently ignored.</p>
<p><strong>UTF-8 is expected, several UTF-16 and single-byte encodings
are supported.</strong> They are exactly what’d one expect from
<code>libiconv</code>, so for example <code>cp1251</code>,
<code>iso-8859-1</code>, <code>latin1</code>, and so on. In fact, there
are more than 200 supported aliases for more than 50 single-byte legacy
encodings, intentionally <strong>not</strong> listed here. I’m writing
this in 2024 and very definitely <strong>not</strong> endorsing anything
except UTF-8. You’re still using SBCS in the roaring ’20s?! Tough luck.
Figure it out. Or, finally, convert.</p>
<p><strong><code>xmlpipe_fixup_utf8 = 1</code> ignores UTF-8 decoding
errors.</strong> Simple as that, it just skips the bytes that don’t
properly decode. Again, maybe not <em>the</em> tool for the current era,
but hey, sometimes data files do break.</p>
<p>And at last, here’s a tiny reference of <strong>xmlpipe2 specific
tags.</strong> Yep, all three of them.</p>
<table>
<colgroup>
<col style="width: 30%" />
<col style="width: 14%" />
<col style="width: 55%" />
</colgroup>
<thead>
<tr class="header">
<th>Tag</th>
<th>Required</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>&lt;sphinx:docset&gt;</code></td>
<td>yes</td>
<td>Top-level document set container</td>
</tr>
<tr class="even">
<td><code>&lt;sphinx:document&gt;</code></td>
<td>yes</td>
<td>Individual document container</td>
</tr>
<tr class="odd">
<td><code>&lt;sphinx:killlist&gt;</code></td>
<td>no</td>
<td>Optional K-batch, with <code>&lt;id&gt;</code> entries</td>
</tr>
</tbody>
</table>
<p>The example we started off with demoes pretty much everything. The
only known (and required!) attribute here is <code>"id"</code> for
<code>&lt;sphinx:document&gt;</code>, also demoed before. What’s left…
Perhaps just my quick take on the smallest-ish legal Sphinx XML input,
for the sheer fun of it?</p>
<div class="sourceCode" id="cb224"><pre
class="sourceCode xml"><code class="sourceCode xml"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;utf-8&quot;</span><span class="fu">?&gt;</span>&lt;<span class="kw">sphinx:docset</span>&gt;&lt;<span class="kw">sphinx:document</span><span class="ot"> id=</span><span class="st">&quot;1&quot;</span>&gt;</span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">f</span>&gt;hi&lt;/<span class="kw">f</span>&gt;&lt;/<span class="kw">sphinx:document</span>&gt;&lt;/<span class="kw">sphinx:docset</span>&gt;</span></code></pre></div>
<p>Nah, that’s barely useful. Oh, I know, here’s a <em>useful</em>
tip!</p>
<p><strong><code>xmlpipe2</code> source can provide K-batches for
<code>csvpipe</code> sources.</strong> For running entirely off plain
old good data files, avoiding any murky databases. Like so!</p>
<div class="sourceCode" id="cb225"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat d.csv</span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span>, title</span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a><span class="ex">123,</span> hello world</span>
<span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-5"><a href="#cb225-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat k.xml</span>
<span id="cb225-6"><a href="#cb225-6" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span><span class="ex">?xml</span> version=<span class="st">&quot;1.0&quot;</span> encoding=<span class="st">&quot;utf-8&quot;</span><span class="pp">?</span><span class="op">&gt;</span></span>
<span id="cb225-7"><a href="#cb225-7" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>sphinx:docset<span class="op">&gt;</span></span>
<span id="cb225-8"><a href="#cb225-8" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>sphinx:killlist<span class="op">&gt;</span></span>
<span id="cb225-9"><a href="#cb225-9" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>id<span class="op">&gt;</span>123<span class="op">&lt;</span>/id<span class="op">&gt;</span></span>
<span id="cb225-10"><a href="#cb225-10" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>id<span class="op">&gt;</span>456<span class="op">&lt;</span>/id<span class="op">&gt;</span></span>
<span id="cb225-11"><a href="#cb225-11" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>id<span class="op">&gt;</span>789<span class="op">&lt;</span>/id<span class="op">&gt;</span></span>
<span id="cb225-12"><a href="#cb225-12" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>/sphinx:killlist<span class="op">&gt;</span></span>
<span id="cb225-13"><a href="#cb225-13" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>/sphinx:docset<span class="op">&gt;</span></span>
<span id="cb225-14"><a href="#cb225-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-15"><a href="#cb225-15" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat sphinx.conf</span>
<span id="cb225-16"><a href="#cb225-16" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> data</span>
<span id="cb225-17"><a href="#cb225-17" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb225-18"><a href="#cb225-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = csvpipe</span>
<span id="cb225-19"><a href="#cb225-19" aria-hidden="true" tabindex="-1"></a>    <span class="ex">csvpipe_command</span> = cat d.csv</span>
<span id="cb225-20"><a href="#cb225-20" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb225-21"><a href="#cb225-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-22"><a href="#cb225-22" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> kbatch</span>
<span id="cb225-23"><a href="#cb225-23" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb225-24"><a href="#cb225-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = xmlpipe2</span>
<span id="cb225-25"><a href="#cb225-25" aria-hidden="true" tabindex="-1"></a>    <span class="ex">xmlpipe_command</span> = cat k.xml</span>
<span id="cb225-26"><a href="#cb225-26" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb225-27"><a href="#cb225-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-28"><a href="#cb225-28" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> delta</span>
<span id="cb225-29"><a href="#cb225-29" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb225-30"><a href="#cb225-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">source</span> = data   <span class="co"># grab data from .csv</span></span>
<span id="cb225-31"><a href="#cb225-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">source</span> = kbatch <span class="co"># grab K-batch from .xml</span></span>
<span id="cb225-32"><a href="#cb225-32" aria-hidden="true" tabindex="-1"></a>    <span class="ex">kbatch</span> = main   <span class="co"># apply K-batch to `main` on load</span></span>
<span id="cb225-33"><a href="#cb225-33" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span>  = title  <span class="co"># also, the simplest schema</span></span>
<span id="cb225-34"><a href="#cb225-34" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<h2 id="indexing-join-sources">Indexing: join sources</h2>
<p>Join sources let you do cross-storage pseudo-joins, and augment your
primary data (coming from regular data sources) with additional column
values (coming from join sources).</p>
<p>For example, you might want to create <em>most</em> of your FT index
from a regular database, fetching the data using a regular SQL query,
but fetch a few columns from a separate CSV file. Effectively that is a
cross-storage, SQL by CSV join. And that’s exactly what join sources
do.</p>
<p>Let’s take a look at a simple example. It’s far-fetched, but should
illustrate the core idea. Assume that for some reason per-product
discounts are not stored in our primary SQL database, but in a separate
CSV file, updated once per week. (Maybe the CEO likes to edit those
personally on weekends in Excel, who knows.) We can then fill a default
discount percentage value in our <code>sql_query</code>, and load
specific discounts from that CSV using <code>join_attrs</code> as
follows.</p>
<div class="sourceCode" id="cb226"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> products</span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb226-4"><a href="#cb226-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sql_query</span> = SELECT id, title, price, 50 AS discount FROM products</span>
<span id="cb226-5"><a href="#cb226-5" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb226-6"><a href="#cb226-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-7"><a href="#cb226-7" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> join_discounts</span>
<span id="cb226-8"><a href="#cb226-8" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb226-9"><a href="#cb226-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = csvjoin</span>
<span id="cb226-10"><a href="#cb226-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_file</span> = discounts.csv</span>
<span id="cb226-11"><a href="#cb226-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_schema</span> = bigint id, uint discount</span>
<span id="cb226-12"><a href="#cb226-12" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb226-13"><a href="#cb226-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-14"><a href="#cb226-14" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> products</span>
<span id="cb226-15"><a href="#cb226-15" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb226-16"><a href="#cb226-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb226-17"><a href="#cb226-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">source</span> = products  </span>
<span id="cb226-18"><a href="#cb226-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">source</span> = join_discounts</span>
<span id="cb226-19"><a href="#cb226-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-20"><a href="#cb226-20" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field_string</span> = title</span>
<span id="cb226-21"><a href="#cb226-21" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span> = price</span>
<span id="cb226-22"><a href="#cb226-22" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span> = discount</span>
<span id="cb226-23"><a href="#cb226-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-24"><a href="#cb226-24" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_attrs</span> = discount</span>
<span id="cb226-25"><a href="#cb226-25" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>The <code>discount</code> value will now be either 50 by default (as
in <code>sql_query</code>), or whatever was specified in
<code>discounts.csv</code> file.</p>
<div class="sourceCode" id="cb227"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat discounts.csv</span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a><span class="ex">2181494041,5450</span></span>
<span id="cb227-3"><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a><span class="ex">3312929434,6800</span></span>
<span id="cb227-4"><a href="#cb227-4" aria-hidden="true" tabindex="-1"></a><span class="ex">3521535453,1300</span></span>
<span id="cb227-5"><a href="#cb227-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-6"><a href="#cb227-6" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mysql <span class="at">-h0</span> <span class="at">-P9306</span> <span class="at">-e</span> <span class="st">&quot;SELECT * FROM products&quot;</span></span>
<span id="cb227-7"><a href="#cb227-7" aria-hidden="true" tabindex="-1"></a><span class="ex">+------------+-----------------------------------------+-------+----------+</span></span>
<span id="cb227-8"><a href="#cb227-8" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="fu">id</span>         <span class="kw">|</span> <span class="ex">title</span>                                   <span class="kw">|</span> <span class="ex">price</span> <span class="kw">|</span> <span class="ex">discount</span> <span class="kw">|</span></span>
<span id="cb227-9"><a href="#cb227-9" aria-hidden="true" tabindex="-1"></a><span class="ex">+------------+-----------------------------------------+-------+----------+</span></span>
<span id="cb227-10"><a href="#cb227-10" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">2643432049</span> <span class="kw">|</span> <span class="ex">Logitech</span> M171 Wireless Mouse            <span class="kw">|</span>  <span class="ex">3900</span> <span class="kw">|</span>       <span class="ex">50</span> <span class="kw">|</span></span>
<span id="cb227-11"><a href="#cb227-11" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">2181494041</span> <span class="kw">|</span> <span class="ex">Razer</span> DeathAdder Essential Gaming Mouse <span class="kw">|</span> <span class="ex">12900</span> <span class="kw">|</span>     <span class="ex">5450</span> <span class="kw">|</span></span>
<span id="cb227-12"><a href="#cb227-12" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">3353405378</span> <span class="kw">|</span> <span class="ex">HP</span> S1000 Plus Silent USB Mouse          <span class="kw">|</span>  <span class="ex">2480</span> <span class="kw">|</span>       <span class="ex">50</span> <span class="kw">|</span></span>
<span id="cb227-13"><a href="#cb227-13" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">3312929434</span> <span class="kw">|</span> <span class="ex">Apple</span> Magic Mouse                       <span class="kw">|</span> <span class="ex">32900</span> <span class="kw">|</span>     <span class="ex">6800</span> <span class="kw">|</span></span>
<span id="cb227-14"><a href="#cb227-14" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">4034510058</span> <span class="kw">|</span> <span class="ex">Logitech</span> M330 Silent Plus               <span class="kw">|</span>  <span class="ex">6700</span> <span class="kw">|</span>       <span class="ex">50</span> <span class="kw">|</span></span>
<span id="cb227-15"><a href="#cb227-15" aria-hidden="true" tabindex="-1"></a><span class="ex">+------------+-----------------------------------------+-------+----------+</span></span></code></pre></div>
<p>So the two lines from <code>discounts.csv</code> that mentioned
existing product IDs got joined and did override the default
<code>discount</code>, the third line that mentioned some non-existing
ID got ignored, and products not mentioned were not affected. Everything
as expected.</p>
<p>But why not just import that CSV into our database, and then do an
extra <code>JOIN</code> (with a side of <code>COALESCE</code>) in
<code>sql_query</code>? Two reasons.</p>
<p>First, optimization. Having <code>indexer</code> do these joins
instead of the primary database can offload the latter quite
significantly. For the record, this was exactly our own main rationale
initially.</p>
<p>Second, simplification. Primary data source isn’t even necessarily a
database. It might be file-based itself.</p>
<p>At the moment, we support joins against CSV or TSV files with the
respective <code>csvjoin</code> and <code>tsvjoin</code> types, or
against binary files with the <code>binjoin</code> type. More join
source types (and input formats) might come in the future.</p>
<p>There are no restrictions imposed on the primary sources. Note that
join sources are secondary, meaning that at least one primary source is
still required.</p>
<p>Join sources support the following directives:</p>
<ul>
<li><code>join_file = &lt;FILE&gt;</code> specifies the input data
file;</li>
<li><code>join_cache = {0 | 1}</code> enables caching the parsed
<code>join_file</code>;</li>
<li><code>join_header = {0 | 1}</code> specifies if there’s a header
line;</li>
<li><code>join_ids = &lt;FILE&gt;</code> specifies the
<code>binjoin</code> input IDs file;</li>
<li><code>join_optional = {0 | 1}</code> relaxes the checks for empty
input data;</li>
<li><code>join_schema = &lt;col_type col_name&gt; [, ...]</code> defines
the input data schema;</li>
<li><code>join_by_attr = {0 | 1}</code> enables joining by another
attribute (not ID).</li>
</ul>
<p>And last but not least, <code>join_attrs</code> at the
<strong>index</strong> level defines which join source columns (as
defined in <code>join_schema</code>) should be joined into which index
columns exactly.</p>
<h3 id="text-join-sources">Text join sources</h3>
<p>For example!</p>
<div class="sourceCode" id="cb228"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> joined</span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = csvjoin</span>
<span id="cb228-4"><a href="#cb228-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_file</span> = joined.csv</span>
<span id="cb228-5"><a href="#cb228-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_header</span> = 1</span>
<span id="cb228-6"><a href="#cb228-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_schema</span> = bigint id, float score, uint price, bigint uid</span>
<span id="cb228-7"><a href="#cb228-7" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb228-8"><a href="#cb228-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-9"><a href="#cb228-9" aria-hidden="true" tabindex="-1"></a><span class="co"># joined.csv:</span></span>
<span id="cb228-10"><a href="#cb228-10" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb228-11"><a href="#cb228-11" aria-hidden="true" tabindex="-1"></a><span class="co"># id,score,price,uid</span></span>
<span id="cb228-12"><a href="#cb228-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 1,12.3,4567,89</span></span>
<span id="cb228-13"><a href="#cb228-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 100500,3.141,592,653</span></span></code></pre></div>
<p><code>join_file</code> and <code>join_schema</code> are required.
There must always be data to join. We must always know what exactly to
process.</p>
<p>The expected <code>join_file</code> format depends on the specific
join source type. You can either use text formats (CSV or TSV), or a
simple raw binary format (more details on that below).</p>
<p>For text formats, CSV/TSV parser is rather limited (for performance
reasons), so quotes and newlines are not supported. Numbers and spaces
are generally fine. When parsing arrays, always-allowed separator is
space, and in TSV you can also use commas (naturally, without quotes you
can’t use those in CSV).</p>
<p>Speaking of performance, input files might be huge (think 100 GB
scale), <em>and</em> they could be reused across multiple indexes.
<code>join_cache = 1</code> allows Sphinx to run parsing just once, and
cache the results. Details below.</p>
<p><code>join_header</code> is optional, and defaults to 0. When set to
1, <code>indexer</code> parses the first <code>join_file</code> line as
a list of columns, and checks that vs the schema.</p>
<p><code>join_schema</code> must contain the input schema, that is, a
comma-separated list of <code>&lt;type&gt; &lt;column&gt;</code> pairs
that fully describes all input columns.</p>
<p>The first column must always be typed <code>bigint</code> and contain
the document ID. Joining will happen based on those IDs. The column name
is used for validation in <code>join_header = 1</code> case only, and
with <code>join_header = 0</code> it is ignored.</p>
<p>The schema is required to contain 2 or more entries, because one ID
column, and at least one data column that we are going to join.</p>
<p>To reiterate, the schema must list <strong>all</strong> the columns
from <code>join_file</code>, and in proper order.</p>
<p>Note that you can later choose to only join in <strong>some</strong>
(not all!) columns from <code>join_file</code> into your index.
<code>join_attrs</code> directive in the index (we discuss it below)
lets you do that. But that’s for the particular <strong>index</strong>
to decide, and at a later stage. Here, at the source stage,
<code>join_schema</code> must just list all the expected
<strong>input</strong> columns.</p>
<p>The supported types include numerics and arrays: <code>bigint</code>,
<code>float</code>, and <code>uint</code> for numerics, and
<code>float_array</code>, <code>int_array</code>, and
<code>int8_array</code> for fixed-width arrays. Array dimensions syntax
is <code>float_array name[10]</code> as usual.</p>
<p>Non-ID column names (ie. except the first column) must be unique
across all join sources used in any given index.</p>
<p>To summarize, join sources just quickly configure the input file and
its schema, and that’s it.</p>
<h3 id="join-by-attribute">Join by attribute</h3>
<p>We mostly discuss joins on <code>id</code> but take note that
<code>indexer</code> can join on other attributes, too. It’s actually a
one-line change. Just ensure that the 1st input column name (and type!)
match that of the required index “join key” column, then enable
<code>join_by_attr = 1</code>, and you’re all set.</p>
<div class="sourceCode" id="cb229"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="co"># user2score.csv</span></span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a><span class="ex">user_id,</span> user_score</span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a><span class="ex">123,</span> 4.56</span>
<span id="cb229-4"><a href="#cb229-4" aria-hidden="true" tabindex="-1"></a><span class="ex">124,</span> 0.1</span>
<span id="cb229-5"><a href="#cb229-5" aria-hidden="true" tabindex="-1"></a><span class="ex">125,</span> <span class="at">-7.89</span></span>
<span id="cb229-6"><a href="#cb229-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-7"><a href="#cb229-7" aria-hidden="true" tabindex="-1"></a><span class="co"># sphinx.conf</span></span>
<span id="cb229-8"><a href="#cb229-8" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> user_score_join</span>
<span id="cb229-9"><a href="#cb229-9" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb229-10"><a href="#cb229-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = csvjoin</span>
<span id="cb229-11"><a href="#cb229-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_by_attr</span> = 1</span>
<span id="cb229-12"><a href="#cb229-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_header</span> = 1</span>
<span id="cb229-13"><a href="#cb229-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_file</span> = user2score.csv</span>
<span id="cb229-14"><a href="#cb229-14" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_schema</span> = uint user_id, float user_score</span>
<span id="cb229-15"><a href="#cb229-15" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb229-16"><a href="#cb229-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-17"><a href="#cb229-17" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> posts</span>
<span id="cb229-18"><a href="#cb229-18" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb229-19"><a href="#cb229-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">source</span> = posts</span>
<span id="cb229-20"><a href="#cb229-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">source</span> = user_score_join</span>
<span id="cb229-21"><a href="#cb229-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb229-22"><a href="#cb229-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-23"><a href="#cb229-23" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = title, content</span>
<span id="cb229-24"><a href="#cb229-24" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span> = user_id</span>
<span id="cb229-25"><a href="#cb229-25" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_float</span> = user_score</span>
<span id="cb229-26"><a href="#cb229-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb229-27"><a href="#cb229-27" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_attrs</span> = user_score</span>
<span id="cb229-28"><a href="#cb229-28" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>For the record, if posts in this example were stored in some SQL DB,
then yes indeed, we <strong>could</strong> instead import
<code>user2score.csv</code> into a (temp) table on SQL side before
indexing, edit <code>sql_query</code> a little, and do joins on SQL side
rather than <code>indexer</code> side.</p>
<div class="sourceCode" id="cb230"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a>sql_query <span class="op">=</span> <span class="kw">SELECT</span> p.<span class="kw">id</span>, p.title, p.content, p.user_id, u2s.user_score</span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> posts p</span>
<span id="cb230-3"><a href="#cb230-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">LEFT</span> <span class="kw">JOIN</span> user2score u2s <span class="kw">ON</span> u2s.user_id <span class="op">=</span> p.user_id</span></code></pre></div>
<p>Note how <code>join_by_attr = 1</code> makes <code>indexer</code>
<strong>use</strong> that 1st column name from the
<code>join_schema</code> list. So when an input CSV has a header line,
its 1st column <strong>must</strong> also exist in the index. Joins
<strong>must</strong> know what to join on, ie. what “join key” column
to use to match joined columns to primary source rows.</p>
<p>So in other words, <strong>join key name must match.</strong> Rather
naturally.</p>
<p>Also, <strong>join key type must be integer.</strong> We only join on
<code>UINT</code> or <code>BIGINT</code> now.</p>
<p>Also, <strong>join key type must match.</strong> Checks are
intentionally strict, to prevent accidentally losing joined values. If a
join key is declared <code>UINT</code> in the index then it
<strong>must</strong> be declared <code>UINT</code> in
<code>join_schema</code> as well.</p>
<p>Also, <strong>join keys must NOT be joined themselves.</strong> In
the example above you <strong>can not</strong> mention
<code>user_id</code> itself in <code>join_attrs</code> anymore, making
it a target for some other join. (Resolving circular dependencies is too
much of a hassle!)</p>
<h3 id="binary-join-sources">Binary join sources</h3>
<p>Now that we covered schemas and types and such, let’s get back to
<code>binjoin</code> type and its input formats. Basically,
<code>join_schema</code> directly defines that, too.</p>
<p>With <code>binjoin</code> type Sphinx requires <em>two</em> binary
input files. You must extract and store all the document IDs separately
in <code>join_ids</code>, and all the <em>other</em> columns from
<code>join_schema</code> separately in <code>join_file</code>, row by
row. Columns in each <code>join_file</code> row must be exactly in
<code>join_schema</code> order.</p>
<p>All values must be in native binary, so integers must be in
low-endian byte order, floats must be in IEEE-754, no suprises there.
Speaking of which, there is no implicit padding either. Whatever you
specify in <code>join_schema</code> must get written into
<code>join_file</code> exactly as is.</p>
<p><code>indexer</code> infers the joined rows count from
<code>join_ids</code> size, so that must be divisible by 8, because
<code>BIGINT</code> is 8 bytes. <code>indexer</code> also checks the
expected <code>join_file</code> size too.</p>
<p>Let’s dissect a small example. Assume that we have the following 3
rows to join.</p>
<pre class="csv"><code>id, score, year
2345, 3.14, 2022
7890, 2.718, 2023
123, 1.0, 2020</code></pre>
<p>Assume that <code>score</code> is <code>float</code> and that
<code>year</code> is <code>uint</code>, as per this schema.</p>
<div class="sourceCode" id="cb232"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> binjoin1</span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = binjoin</span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_ids</span> = ids.bin</span>
<span id="cb232-5"><a href="#cb232-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_file</span> = rows.bin</span>
<span id="cb232-6"><a href="#cb232-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_schema</span> = bigint id, float score, uint year</span>
<span id="cb232-7"><a href="#cb232-7" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>How would that data look in binary? Well, it begins with 24-byte
docids file, with 8 bytes per each document ID.</p>
<div class="sourceCode" id="cb233"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> struct</span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;ids.bin&#39;</span>, <span class="st">&#39;wb+&#39;</span>) <span class="im">as</span> fp:</span>
<span id="cb233-3"><a href="#cb233-3" aria-hidden="true" tabindex="-1"></a>    fp.write(struct.pack(<span class="st">&#39;qqq&#39;</span>, <span class="dv">2345</span>, <span class="dv">7890</span>, <span class="dv">123</span>))</span></code></pre></div>
<div class="sourceCode" id="cb234"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> xxd <span class="at">-c8</span> <span class="at">-g1</span> <span class="at">-u</span> ids.bin</span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a><span class="ex">00000000:</span> 29 09 00 00 00 00 00 00  <span class="er">)</span><span class="ex">.......</span></span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a><span class="ex">00000008:</span> D2 1E 00 00 00 00 00 00  ........</span>
<span id="cb234-4"><a href="#cb234-4" aria-hidden="true" tabindex="-1"></a><span class="ex">00000010:</span> 7B 00 00 00 00 00 00 00  {.......</span></code></pre></div>
<p>The rows data file in this example must also have 8 bytes per row,
with 4 bytes for score and 4 more for year.</p>
<div class="sourceCode" id="cb235"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> struct</span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;rows.bin&#39;</span>, <span class="st">&#39;wb+&#39;</span>) <span class="im">as</span> fp:</span>
<span id="cb235-3"><a href="#cb235-3" aria-hidden="true" tabindex="-1"></a>    fp.write(struct.pack(<span class="st">&#39;fififi&#39;</span>, <span class="fl">3.14</span>, <span class="dv">2022</span>, <span class="fl">2.718</span>, <span class="dv">2023</span>, <span class="fl">1.0</span>, <span class="dv">2020</span>))</span></code></pre></div>
<div class="sourceCode" id="cb236"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> xxd <span class="at">-c8</span> <span class="at">-g1</span> <span class="at">-u</span> rows.bin</span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a><span class="ex">00000000:</span> C3 F5 48 40 E6 07 00 00  ..H@....</span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a><span class="ex">00000008:</span> B6 F3 2D 40 E7 07 00 00  ..-@....</span>
<span id="cb236-4"><a href="#cb236-4" aria-hidden="true" tabindex="-1"></a><span class="ex">00000010:</span> 00 00 80 3F E4 07 00 00  ...<span class="pp">?</span>....</span></code></pre></div>
<p>Let’s visually check the second row. It starts at offset 8 in both
our files. Document ID from <code>ids.bin</code> is 0x1ED2 hex, year
from <code>rows.bin</code> is 0x7E7 hex, that’s 7890 and 2023 in
decimal, alright! Everything computes.</p>
<p>Arrays are also allowed with <code>binjoin</code> sources. (And more
than that, arrays actually are a primary objective for binary format.
Because it saves especially much on bigger arrays.)</p>
<div class="sourceCode" id="cb237"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> binjoin2</span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb237-3"><a href="#cb237-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = csvjoin</span>
<span id="cb237-4"><a href="#cb237-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_ids</span> = ids.bin</span>
<span id="cb237-5"><a href="#cb237-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_file</span> = data.bin</span>
<span id="cb237-6"><a href="#cb237-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_schema</span> = bigint id, float score, float_array embeddings[100]</span>
<span id="cb237-7"><a href="#cb237-7" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>But why do all these <code>binjoin</code> hoops? Performance,
performance, performance. <strong>When your data is already
binary</strong> in the first place, shipping it as binary is somewhat
faster (and likely easier to implement too). With <code>binjoin</code>
we fully eliminate text formatting step on the data source side and text
parsing step on Sphinx side. Those steps are <em>very</em> noticeable
when processing millions of rows! Of course, if your data is in text
format, then either CSV or TSV are fine.</p>
<h3 id="caching-text-join-sources">Caching text join sources</h3>
<p>Binary join sources are faster, as they skip the text parsing step.
However, even with text sources that step can be, at the very least,
cached.</p>
<p>Consider a setup where a very same 100 GB TSV file gets joined 50
times over, into 50 different indexes. (Because it’s easy to export that
monolithic TSV, but hard to match the desired target 50-way split.) We’d
want to parse those 100 GB just once, and reuse the parsing results.</p>
<p><code>join_cache = 1</code> does exactly that, it caches and reuses
the parsing results. With cache enabled, every text join source attempts
to use or create a special cache file for every <code>join_file</code>
when invoked.</p>
<p>The cache is placed right next to <code>join_file</code> using a
<code>.joincache</code> suffix, eg. with
<code>join_file = mydata.tsv</code> Sphinx will use
<code>mydata.tsv.joincache</code> for cache. In datadir mode, it gets
placed in the very same folder as the input file.</p>
<p><code>.joincache</code> files are temporary, and safe to delete as
needed. They usually are as big as the input data. They also store some
metadata (size and timestamps) from their respective
<code>join_file</code> inputs, for automatic invalidation.</p>
<p><code>indexer build</code> then checks for <code>.joincache</code>
files first and uses those instead when possible (ie. when the metadata
matches). Otherwise, it reverts to honestly parsing
<code>join_file</code>, and attempts to recreate the
<code>.joincache</code> file as it goes. So that any subsequent
<code>indexer build</code> run could quickly reuse the cache.</p>
<p><code>indexer build</code> readers impose a shared lock on
<code>.joincache</code> files, and writers impose an exclusive locks, so
they should properly lock each other out.</p>
<p>But what if you simultaneously run N builds in parallel with caching
enabled, but <em>no</em> cache file existing just yet? 1 writer wins the
lock (and works on refreshing the cache for <em>future</em> runs), but
all the other N-1 <em>current</em> writers revert to parsing. Not
ideal.</p>
<p><code>indexer prejoin</code> command lets you avoid that, and
forcibly create <code>.joincache</code> files upfront, so that
<code>indexer build</code> runs can <strong>rely</strong> on having the
caches. Also, it’s handily multi-threaded.</p>
<div class="sourceCode" id="cb238"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> indexer prejoin <span class="at">--threads</span> 16 jointest1 jointest2</span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb238-3"><a href="#cb238-3" aria-hidden="true" tabindex="-1"></a><span class="ex">using</span> config file <span class="st">&#39;./sphinx.conf&#39;</span>...</span>
<span id="cb238-4"><a href="#cb238-4" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> <span class="st">&#39;jointest1&#39;</span>: cache updated ok, took 0.4 sec</span>
<span id="cb238-5"><a href="#cb238-5" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> <span class="st">&#39;jointest2&#39;</span>: cache updated ok, took 0.6 sec</span>
<span id="cb238-6"><a href="#cb238-6" aria-hidden="true" tabindex="-1"></a><span class="ex">total</span> 2 sources, 2 threads, 0.6 sec</span></code></pre></div>
<h3 id="binding-index-join-targets">Binding index join targets</h3>
<p>Join sources do provide the input data, but actual joins are then
performed “by” FT indexes, based on the join source(s) added to the
index using the <code>source</code> directive, and on
<code>join_attrs</code> setup. Example!</p>
<div class="sourceCode" id="cb239"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> jointest</span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb239-3"><a href="#cb239-3" aria-hidden="true" tabindex="-1"></a>   <span class="ex">...</span></span>
<span id="cb239-4"><a href="#cb239-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">source</span> = primarydb</span>
<span id="cb239-5"><a href="#cb239-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">source</span> = joined</span>
<span id="cb239-6"><a href="#cb239-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-7"><a href="#cb239-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = title</span>
<span id="cb239-8"><a href="#cb239-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span> = price</span>
<span id="cb239-9"><a href="#cb239-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_bigint</span> = ts</span>
<span id="cb239-10"><a href="#cb239-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_float</span> = weight</span>
<span id="cb239-11"><a href="#cb239-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-12"><a href="#cb239-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_attrs</span> = ts:ts, weight:score, price</span>
<span id="cb239-13"><a href="#cb239-13" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>Compared to a regular index, we added just 2 lines:
<code>source = joined</code> to define the source of our joined data,
and <code>join_attrs</code> to define which index columns need to be
populated with which joined columns.</p>
<p>Multiple join sources may be specified per one index. Every source is
expected to have its own unique columns names. In the example above,
<code>price</code> column name is now taken by <code>joined</code>
source, so if we add another <code>joined2</code> source, none of its
columns can be called <code>price</code> any more.</p>
<p><code>join_attrs</code> is a comma-separated list of
<code>index_attr:joined_column</code> pairs that binds target index
attributes to source joined columns, by their names.</p>
<p>Index attribute name and joined column name are <strong>not</strong>
required to match. Note how the <code>score</code> column from CSV gets
mapped to <code>weight</code> in the index.</p>
<p>But they <strong>can</strong> match. When they do, the joined column
name can be skipped for brevity. That’s what happens with the
<code>price</code> bit. Full blown <code>price:price</code> is still
legal syntax too, of course.</p>
<p><strong>Join targets can be JSON paths, not just index
attributes.</strong> So an arbitrary path like
<code>json_attr.foo.bar:joined_column</code> also works! As long as
there’s that <code>json_attr</code> column in your index, and as long as
it’s JSON.</p>
<p><strong>Joins always win.</strong> When the “original” JSON (as
fetched from regular data sources) contains any data at the specified
path, joined value overwrites that data. When it doesn’t, joined value
gets injected where requested. No type checking is performed, old data
gets completely discarded.</p>
<p><strong>Multiple different paths can point into one JSON
attribute.</strong> For instance, the following is perfectly legal.</p>
<div class="sourceCode" id="cb240"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> jointest</span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb240-3"><a href="#cb240-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb240-4"><a href="#cb240-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_attrs</span> = <span class="dt">\</span></span>
<span id="cb240-5"><a href="#cb240-5" aria-hidden="true" tabindex="-1"></a>        params.extra.reason:reason, <span class="dt">\</span></span>
<span id="cb240-6"><a href="#cb240-6" aria-hidden="true" tabindex="-1"></a>        params.size.width:width, <span class="dt">\</span></span>
<span id="cb240-7"><a href="#cb240-7" aria-hidden="true" tabindex="-1"></a>        params.size.height:height</span>
<span id="cb240-8"><a href="#cb240-8" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>However, <strong>partially or fully matching paths are NOT
supported.</strong> We do perform some basic checks to prevent those,
but anyway, avoid.</p>
<div class="sourceCode" id="cb241"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> ILLEGAL_DUPE</span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb241-4"><a href="#cb241-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_attrs</span> = <span class="dt">\</span></span>
<span id="cb241-5"><a href="#cb241-5" aria-hidden="true" tabindex="-1"></a>        params.size.width:width, <span class="dt">\</span></span>
<span id="cb241-6"><a href="#cb241-6" aria-hidden="true" tabindex="-1"></a>        params.size.width:height</span>
<span id="cb241-7"><a href="#cb241-7" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb241-8"><a href="#cb241-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-9"><a href="#cb241-9" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> ILLEGAL_PREFIX</span>
<span id="cb241-10"><a href="#cb241-10" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb241-11"><a href="#cb241-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb241-12"><a href="#cb241-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">join_attrs</span> = <span class="dt">\</span></span>
<span id="cb241-13"><a href="#cb241-13" aria-hidden="true" tabindex="-1"></a>        params.size:size, <span class="dt">\</span></span>
<span id="cb241-14"><a href="#cb241-14" aria-hidden="true" tabindex="-1"></a>        params.size.width:width</span>
<span id="cb241-15"><a href="#cb241-15" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>The two examples just above <em>might</em> backfire. Don’t do
that.</p>
<p>Since joined column names must be unique across all join sources, we
don’t have to have source names in <code>join_attrs</code>, the (unique)
joined column names suffice.</p>
<p>With regular columns (unlike JSON paths), types are checked and must
match perfectly. You can’t join neither int to string nor float to int.
Array types and dimensions must match perfectly too.</p>
<p>All column names are case-insensitive.</p>
<p>A single join source is currently limited to at most 1 billion
rows.</p>
<p>First entry with a given document ID seen in the join source wins,
subsequent entries with the same ID are ignored.</p>
<p>Non-empty data files are <strong>required</strong> by default. If
missing or empty data files are not an error, use
<code>join_optional = 1</code> directive to explicitly allow that.</p>
<h3 id="joins-ram-usage">Joins RAM usage</h3>
<p>Last but not least, note that joins might eat a huge lot of RAM!</p>
<p>In the current implementation <code>indexer</code> fully parses all
the join sources upfront (before fetching any row data), then keeps all
parsed data in RAM, completely irregardless of the
<code>mem_limit</code> setting.</p>
<p>This implementation is an intentional tradeoff, for simplicity and
performance, given that in the end all the attributes (including the
joined ones) are anyway expected to more or less fit into RAM.</p>
<p>However, this also means that you can’t expect to efficiently join a
huge 100 GB CSV file into a tiny 1 million row index on a puny 32 GB
server. (Well, it might even work, but definitely with a lot of swapping
and screaming.) Caveat emptor.</p>
<p>Except, note that in <code>binjoin</code> sources this “parsed data”
means <code>join_ids</code> only! Row data stored in
<code>join_file</code> is already binary, no parsing step needed there,
so <code>join_file</code> just gets memory-mapped and then used
directly.</p>
<p>So <code>binjoin</code> sources are more RAM efficient. Because in
<code>csvjoin</code> and <code>tsvjoin</code> types the entire text
<code>join_file</code> <em>has</em> to be parsed and stored in RAM, and
that step does not exist in <code>binjoin</code> sources. On the other
hand, (semi) random reads from mapped <code>join_file</code> might be
heavier on IO. Caveat emptor iterum.</p>
<h2 id="indexing-special-chars-blended-tokens-and-mixed-codes">Indexing:
special chars, blended tokens, and mixed codes</h2>
<p>Sphinx provides tools to help you better index (and then later
search):</p>
<ul>
<li>terms that have special characters in them, like
<code>@Rihanna</code>, or <code>Procter&amp;Gamble</code> or
<code>U.S.A</code>, etc;</li>
<li>terms that mix letters and digits, like
<code>UE53N5740AU</code>.</li>
</ul>
<p>The general approach, so-called “blending”, is the same in both
cases:</p>
<ul>
<li>we always store a certain “base” (most granular) tokenization;</li>
<li>we also additionally store (“blend”) extra tokens, as
configured;</li>
<li>we then let you search for either original or extra tokens.</li>
</ul>
<p>So in the examples just above Sphinx can:</p>
<ul>
<li>index base tokens, such as <code>rihanna</code> or
<code>ue53n5740au</code>;</li>
<li>index special tokens, such as <code>@rihanna</code>;</li>
<li>index parts of mixed-codes tokens, such as <code>ue 53</code> and
<code>ue53</code>.</li>
</ul>
<h3 id="blended-tokens-with-special-characters">Blended tokens (with
special characters)</h3>
<p>To index <strong>blended tokens</strong>, ie. tokens with special
characters in them, you should:</p>
<ul>
<li>add your special “blended” characters to the
<code>blend_chars</code> directive;</li>
<li>configure several processing modes for the extra tokens (optionally)
using the <code>blend_mode</code> directive;</li>
<li>rebuild your index.</li>
</ul>
<p>Blended characters are going to be indexed both as separators, and
<em>at the same time</em> as valid characters. They are considered
separators when generating the base tokenization (or “base split” for
short). But in addition they also are processed as valid characters when
generating extra tokens.</p>
<p>For instance, when you set <code>blend_chars = @, &amp;, .</code> and
index the text <code>@Rihanna Procter&amp;Gamble U.S.A</code>, the base
split stores the following six tokens into the final index:
<code>rihanna</code>, <code>procter</code>, <code>gamble</code>,
<code>u</code>, <code>s</code>, and <code>a</code>. Exactly like it
would without the <code>blend_chars</code>, based on just the
<code>charset_table</code>.</p>
<p>And because of <code>blend_chars</code> settings, the following three
<em>extra</em> tokens get stored: <code>@rihanna</code>,
<code>procter&amp;gamble</code>, and <code>u.s.a</code>. Regular
characters are still case-folded according to
<code>charset_table</code>, but those special blended characters are now
preserved. As opposed to being treated as whitespace, like they were in
the base split. So far so good.</p>
<p>But why not just add <code>@, &amp;, .</code> to
<code>charset_table</code> then? Because that way we would completely
lose the base split. <em>Only</em> the three “magic” tokens like
<code>@rihanna</code> would be stored. And then searching for their
“parts” (for example, for just <code>rihanna</code> or just
<code>gamble</code>) would not work. Meh.</p>
<p>Last but not least, the in-field token positions are adjusted
accordingly, and shared between the base and extra tokens:</p>
<ul>
<li>pos 1, <code>rihanna</code> and <code>@rihanna</code></li>
<li>pos 2, <code>procter</code> and <code>procter&amp;gamble</code></li>
<li>pos 3, <code>gamble</code></li>
<li>pos 4, <code>u</code> and <code>u.s.a</code></li>
<li>pos 5, <code>s</code></li>
<li>pos 6, <code>a</code></li>
</ul>
<p>Bottom line, <code>blend_chars</code> lets you enrich the index and
store extra tokens with special characters in those. That might be a
handy addition to your regular tokenization based on
<code>charset_table</code>.</p>
<h3 id="mixed-codes-with-letters-and-digits">Mixed codes (with letters
and digits)</h3>
<p>To index <strong>mixed codes</strong>, ie. terms that mix letters and
digits, you need to enable <code>blend_mixed_codes = 1</code> setting
(and reindex).</p>
<p>That way Sphinx adds extra spaces on <em>letter-digit boundaries</em>
when making the base split, but still stores the full original token as
an extra. For example, <code>UE53N5740AU</code> gets broken down to as
much as 5 parts:</p>
<ul>
<li>pos 1, <code>ue</code> and <code>ue53n5740au</code></li>
<li>pos 2, <code>53</code></li>
<li>pos 3, <code>n</code></li>
<li>pos 4, <code>5740</code></li>
<li>pos 5, <code>au</code></li>
</ul>
<p>Besides the “full” split and the “original” code, it is also possible
to store prefixes and suffixes. See <code>blend_mode</code> discussion
just below.</p>
<p>Also note that on certain input data mixed codes indexing can
generate a lot of undesired noise tokens. So when you have a number of
fields with special terms that do <em>not</em> need to be processed as
mixed codes (consider either terms like <code>_category1234</code>, or
just long URLs), you can use the <code>mixed_codes_fields</code>
directive and limit mixed codes indexing to human-readable text fields
only. For instance:</p>
<div class="sourceCode" id="cb242"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="ex">blend_mixed_codes</span> = 1</span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a><span class="ex">mixed_codes_fields</span> = title, content</span></code></pre></div>
<p>That could save you a noticeable amount of both index size and
indexing time.</p>
<h3 id="blending-modes">Blending modes</h3>
<p>There’s somewhat more than one way to generate extra tokens. So there
is a directive to control that. It’s called <code>blend_mode</code> and
it lets you list all the different processing variants that you
require:</p>
<ul>
<li><code>trim_none</code>, store a full token with all the blended
characters;</li>
<li><code>trim_head</code>, store a token with heading blended
characters trimmed;</li>
<li><code>trim_tail</code>, store a token with trailing blended
characters trimmed;</li>
<li><code>trim_both</code>, store a token with both heading and trailing
blended characters trimmed;</li>
<li><code>skip_pure</code>, do <em>not</em> store tokens that only
contain blended characters;</li>
<li><code>prefix_tokens</code>, store all possible prefix tokens;</li>
<li><code>suffix_tokens</code>, store all possible suffix tokens.</li>
</ul>
<p>To visualize all those trims a bit, consider the following setup:</p>
<div class="sourceCode" id="cb243"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="ex">blend_chars</span> = @, !</span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a><span class="ex">blend_mode</span> = trim_none, trim_head, trim_tail, trim_both</span>
<span id="cb243-3"><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-4"><a href="#cb243-4" aria-hidden="true" tabindex="-1"></a><span class="ex">doc_title</span> = @someone!</span></code></pre></div>
<p>Quite a bunch of extra tokens will be indexed in this case:</p>
<ul>
<li><code>someone</code> for the base split;</li>
<li><code>@someone!</code> for <code>trim_none</code>;</li>
<li><code>someone!</code> for <code>trim_head</code>;</li>
<li><code>@someone</code> for <code>trim_tail</code>;</li>
<li><code>someone</code> (yes, again) for <code>trim_both</code>.</li>
</ul>
<p><code>trim_both</code> option might seem redundant here for a moment.
But do consider a bit more complicated term like
<code>&amp;U.S.A!</code> where all the special characters are blended.
It’s base split is three tokens (<code>u</code>, <code>s</code>, and
<code>a</code>); it’s original full form (stored for
<code>trim_none</code>) is lower-case <code>&amp;u.s.a!</code>; and so
for this term <code>trim_both</code> is the only way to still generate
the cleaned-up <code>u.s.a</code> variant.</p>
<p><code>prefix_tokens</code> and <code>suffix_tokens</code> actually
begin to generate something non-trivial on that very same
<code>&amp;U.S.A!</code> example, too. For the record, that’s because
its base split is long enough, 3 or more tokens.
<code>prefix_tokens</code> would be the only way to store the (useful)
<code>u.s</code> prefix; and <code>suffix_tokens</code> would in turn
store the (questionable) <code>s.a</code> suffix.</p>
<p>But <code>prefix_tokens</code> and <code>suffix_tokens</code> modes
are, of course, especially useful for indexing mixed codes. The
following gets stored with <code>blend_mode = prefix_tokens</code> in
our running example:</p>
<ul>
<li>pos 1, <code>ue</code>, <code>ue53</code>, <code>ue53n</code>,
<code>ue53n5740</code>, and <code>ue53n5740au</code></li>
<li>pos 2, <code>53</code></li>
<li>pos 3, <code>n</code></li>
<li>pos 4, <code>5740</code></li>
<li>pos 5, <code>au</code></li>
</ul>
<p>And with <code>blend_mode = suffix_tokens</code> respectively:</p>
<ul>
<li>pos 1, <code>ue</code> and <code>ue53n5740au</code></li>
<li>pos 2, <code>53</code> and <code>53n5740au</code></li>
<li>pos 3, <code>n</code> and <code>n5740au</code></li>
<li>pos 4, <code>5740</code> and <code>5740au</code></li>
<li>pos 5, <code>au</code></li>
</ul>
<p>Of course, there still can be missing combinations. For instance,
<code>ue 53n</code> query will still not match any of that. However, for
now we intentionally decided to avoid indexing <em>all</em> the possible
base token subsequences, as that seemed to produce way too much
noise.</p>
<h3 id="searching-vs-blended-tokens-and-mixed-codes">Searching vs
blended tokens and mixed codes</h3>
<p>The rule of thumb is quite simple. All the extra tokens are
<strong>indexing-only</strong>. And in queries, all tokens are treated
“as is”.</p>
<p><strong>Blended characters</strong> are going to be handled as valid
characters in the queries, and <em>require</em> matching.</p>
<p>For example, querying for <code>"@rihanna"</code> will <em>not</em>
match <code>Robyn Rihanna Fenty is a Barbadian-born singer</code>
document. However, querying for just <code>rihanna</code> will match
both that document, and
<code>@rihanna doesn't tweet all that much</code> document.</p>
<p><strong>Mixed codes</strong> are <em>not</em> going to be
automatically “sliced” in the queries.</p>
<p>For example, querying for <code>UE53</code> will <em>not</em>
automatically match neither <code>UE 53</code> nor <code>UE 37 53</code>
documents. You need to manually add extra whitespace into your query
term for that.</p>
<h2 id="indexing-pretraining-faiss_dot-indexes">Indexing: pretraining
FAISS_DOT indexes</h2>
<p>Note: we discuss specific vector index construction details here. For
an initial introduction into vector searches and indexes in general,
refer to the following sections first:</p>
<ul>
<li><a href="#searching-vector-searches">Vector searches</a></li>
<li><a href="#searching-vector-indexes">Vector indexes</a></li>
</ul>
<p>Now, assuming that you do know what vector indexes generally are, let
us look at how they get built, and how “pretraining” helps. TLDR: with
<code>FAISS_DOT</code> indexes, you can precompute clusters upfront just
once (that’s a slow process), and reuse them when building actual
indexes, making index construction (much) faster. Now, to the
details!</p>
<p>Sphinx <code>FAISS_DOT</code> index always <strong>clusters</strong>
the vectors. Meaning, it splits all its input vectors into a number of
so-called clusters when (initially) indexing, based on distance. Vectors
close to each other are placed into the same cluster, vectors far from
each other end up in different clusters. Searches can then work through
clusters first, and quickly skip entire clusters that are “too far” from
our query vector. Think of a map: when searching for points (vectors)
closest to the Empire State Building, once the <strong>farthest</strong>
of our current top-N results is in Manhattan, we are safe to skip the
entire Hamptons (and Queens, and Honolulu) without even looking at
specific addresses. That’s a great optimization.</p>
<p>We <strong>must</strong> compute such clusters when creating a
<code>FAISS_DOT</code> index for the very first time. Clustering takes a
lot of compute. It is a lengthy process. The more data we have, the
lengthier. But what about the <em>second</em> time?!</p>
<p><strong>Vector clusters rarely change significantly.</strong> That
does happen when your data or model changes severely. But with smaller
everyday updates, it does not! Think of a map again: as long as we are
indexing US addresses, clusters that represent states, cities, or
boroughs are still good. If we also add Ireland to our index, that’s a
severe data change, and we have to update our clusters: placing all the
Irish addresses in the cluster for Maine isn’t useful. But changes of
that scale are not frequent. So clusters can be reused a lot. They can
get rebuilt once per month, or quarter, or even a year, and still be
fairly efficient.</p>
<p>Also, <strong>clustering does not require the full dataset.</strong>
The dataset for building clusters doesn’t need to be huge. But it must
be diverse. In our map example, we want points from every state, city,
and neighborhood. If we build clusters from New York points only, then
the searches in San Francisco can’t be efficient, and vice versa. At the
same time, we don’t really need 10 million unique points from Queens to
identify that cluster. A few thousand would likely be enough.</p>
<p>All that said, what instead of clustering every single time (that
does happen by default) we could compute and store clusters just
<em>once</em>? Wouldn’t that speed up creating our vector indexes,
then?</p>
<p>We can, and it does. Pretraining (aka <code>indexer pretrain</code>
command) does <em>exactly</em> that. <strong>Pretraining computes vector
clusters, and saves them for future reuse.</strong></p>
<p>More specifically, <code>indexer pretrain</code> does the
following:</p>
<ul>
<li>it grabs a list of FT indexes from the command line;</li>
<li>it extracts all the <code>FAISS_DOT</code> indexes out of those FT
indexes;</li>
<li>it precomputes the clusters using the available source data;</li>
<li>it saves the pretrained clusters into the given <code>--out</code>
file.</li>
</ul>
<p>The <a
href="#pretrained_index-directive"><code>pretrained_index</code></a>
directive can then be used to plug that output file into <em>any</em>
target FT index. Matching vector indexes can then skip the expensive
training (aka clustering) step, and use the “pre-cooked” clusters from
the <code>pretrained_index</code> file. Instant speedup!</p>
<p>“Matching” indexes <strong>must</strong> have the same column name
<em>and</em> vector dimensions as those saved in the pretrained file.
128D clusters are <em>not</em> compatible with 256D vectors. And
matching FT index vectors to <code>pretrained_index</code> clusters
happens by column name.</p>
<p><strong>All clusters for all columns are fused together into just 1
pretrained file.</strong> That’s to enforce operational simplicity. We
do feel that 1 per-FT-index file is simpler to manage than N individual
per-vector-index files.</p>
<p><strong>Clusters are (currently) comparatively tiny.</strong> They
only take about 1.6 MB per each 128D vector (so 3.2 MB per 256D vector
respectively, etc).</p>
<p><strong>Clusters only even apply to <code>FAISS_DOT</code> vector
index subtype.</strong> Other (vector) index subtypes do not use
clustering at all.</p>
<p><strong>Sphinx forcibly limits clustering to around 1 billion
component values.</strong> Note that this limit ignores vector
dimensions <em>and</em> precision! It could be 1 million 1000D float32
vectors, it could be 100M 10D int8 vectors, neither dimensions nor
precision matter. We draw our current line at 1B individual component
values.</p>
<p><strong>Your training dataset should probably be even
smaller.</strong> Even “just” 1B values can take a bunch of CPU time to
train. We don’t support GPU training yet.</p>
<p><strong>Your training dataset <em>must</em> be a representative
sample.</strong> You’re fine as long as your training data is a “random
enough” sample of the actual production data. You’re busted if, for
instance, you’re training on your first 100K rows that all happen to be
in Hangul, while the remaning 9900K rows are somehow all in Telugu. (And
nope, we can’t spell “representative” neither in Hangul nor Telugu.)</p>
<p><strong>Bottom line</strong>, pretraining is nice. If you’re using
<code>FAISS_DOT</code> vector indexes to speed up
<code>ORDER BY DOT()</code> searches, you really <strong>must</strong>
check it out.</p>
<p>And it’s not hard either. Craft a good data sample; run
<code>indexer pretrain</code> once; use <code>pretrained_index</code>
and plug the resulting clusters file into your FT indexes happily ever
after; and voila, <code>DOT()</code> indexes <em>must</em> now build
somewhat faster, while working just as good.</p>
<div class="sourceCode" id="cb244"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> indexer pretrain <span class="at">--out</span> testvec.bin testvec</span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> vim sphinx.conf</span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span> and add <span class="st">&quot;pretrained_index = testvec.bin&quot;</span> to <span class="st">&quot;testvec&quot;</span> index ... </span>
<span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> indexer build testvec</span>
<span id="cb244-5"><a href="#cb244-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> indexer build testvec</span>
<span id="cb244-6"><a href="#cb244-6" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> indexer build testvec</span></code></pre></div>
<h2 id="searching-query-syntax">Searching: query syntax</h2>
<p>By default, full-text queries in Sphinx are treated as simple “bags
of words”, and all keywords are required in a document to match. In
other words, by default we perform a strict boolean AND over all
keywords.</p>
<p>However, text queries are much more flexible than just that, and
Sphinx has its own full-text query language to expose that
flexibility.</p>
<p>You essentially use that language <em>within</em> the
<code>MATCH()</code> clause in your <code>SELECT</code> statements. So
in this section, when we refer to just the <code>hello world</code>
(text) query for brevity, the actual complete SphinxQL statement that
you would run is something like
<code>SELECT *, WEIGHT() FROM myindex WHERE MATCH('hello world')</code>.</p>
<p>That said, let’s begin with a couple key concepts, and a cheat
sheet.</p>
<h3 id="operators">Operators</h3>
<p>Operators generally work on arbitrary subexpressions. For instance,
you can combine keywords using operators AND and OR (and brackets) as
needed, and build any boolean expression that way.</p>
<p>However, there is a number of exceptions. Not all operators are
universally compatible. For instance, phrase operator (double quotes)
naturally only works on keywords. You can’t build a “phrase” from
arbitrary boolean expressions.</p>
<p>Some of the operators use special characters, like the phrase
operator uses double quotes: <code>"this is phrase"</code>. Thus,
sometimes you might have to filter out a few special characters from
end-user queries, to avoid unintentionally triggering those
operators.</p>
<p>Other ones are literal, and their syntax is an all-caps keyword. For
example, MAYBE operator would quite literally be used as
<code>(rick MAYBE morty)</code> in a query. To avoid triggering those
operators, it should be sufficient to lower-case the query:
<code>rick maybe morty</code> is again just a regular bag-of-words query
that just requires all 3 keywords to match.</p>
<h3 id="modifiers">Modifiers</h3>
<p>Modifiers are attached to individual keywords, and they must work at
all times, and must be allowed within any operator. So no compatibility
issues there!</p>
<p>A couple examples would be the exact form modifier or the field start
modifier, <code>=exact ^start</code>. They limit matching of “their”
keyword to either its exact morphological form, or at the very start of
(any) field, respectively.</p>
<h3 id="cheat-sheet">Cheat sheet</h3>
<p>As of v.3.2, there are just 4 per-keyword modifiers.</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 16%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="header">
<th>Modifier</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>exact form</td>
<td><code>=cats</code></td>
<td>Only match this exact form, needs
<code>index_exact_words</code></td>
</tr>
<tr class="even">
<td>field start</td>
<td><code>^hello</code></td>
<td>Only match at the very start of (any) field</td>
</tr>
<tr class="odd">
<td>field end</td>
<td><code>world$</code></td>
<td>Only match at the very end of (any) field</td>
</tr>
<tr class="even">
<td>IDF boost</td>
<td><code>boost^1.23</code></td>
<td>Multiply keyword IDF by a given value when ranking</td>
</tr>
</tbody>
</table>
<p>The operators are a bit more interesting!</p>
<table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 28%" />
<col style="width: 54%" />
</colgroup>
<thead>
<tr class="header">
<th>Operator</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>brackets</td>
<td><code>(one two)</code></td>
<td>Group a subexpression</td>
</tr>
<tr class="even">
<td>AND</td>
<td><code>one two</code></td>
<td>Match both args</td>
</tr>
<tr class="odd">
<td>OR</td>
<td><code>one | two</code></td>
<td>Match any arg</td>
</tr>
<tr class="even">
<td>term-OR</td>
<td><code>one || two</code></td>
<td>Match any keyword, and reuse in-query position</td>
</tr>
<tr class="odd">
<td>NOT</td>
<td><code>one -two</code></td>
<td>Match 1st arg, but exclude matches of 2nd arg</td>
</tr>
<tr class="even">
<td>NOT</td>
<td><code>one !two</code></td>
<td>Match 1st arg, but exclude matches of 2nd arg</td>
</tr>
<tr class="odd">
<td>MAYBE</td>
<td><code>one MAYBE two</code></td>
<td>Match 1st arg, but include 2nd arg when ranking</td>
</tr>
<tr class="even">
<td>field limit</td>
<td><code>@title one @body two</code></td>
<td>Limit matching to a given field</td>
</tr>
<tr class="odd">
<td>fields limit</td>
<td><code>@(title,body) test</code></td>
<td>Limit matching to given fields</td>
</tr>
<tr class="even">
<td>fields limit</td>
<td><code>@!(phone,year) test</code></td>
<td>Limit matching to all but given fields</td>
</tr>
<tr class="odd">
<td>fields limit</td>
<td><code>@* test</code></td>
<td>Reset any previous field limits</td>
</tr>
<tr class="even">
<td>position limit</td>
<td><code>@title[50] test</code></td>
<td>Limit matching to N first positions in a field</td>
</tr>
<tr class="odd">
<td>phrase</td>
<td><code>"one two"</code></td>
<td>Match all keywords as an (exact) phrase</td>
</tr>
<tr class="even">
<td>phrase</td>
<td><code>"one * * four"</code></td>
<td>Match all keywords as an (exact) phrase</td>
</tr>
<tr class="odd">
<td>proximity</td>
<td><code>"one two"~3</code></td>
<td>Match all keywords within a proximity window</td>
</tr>
<tr class="even">
<td>quorum</td>
<td><code>"uno due tre"/2</code></td>
<td>Match any N out of all keywords</td>
</tr>
<tr class="odd">
<td>quorum</td>
<td><code>"uno due tre"/0.7</code></td>
<td>Match any given fraction of all keywords</td>
</tr>
<tr class="even">
<td>BEFORE</td>
<td><code>one &lt;&lt; two</code></td>
<td>Match args in this specific order only</td>
</tr>
<tr class="odd">
<td>NEAR</td>
<td><code>one NEAR/3 "two three"</code></td>
<td>Match args in any order within a given distance</td>
</tr>
<tr class="even">
<td>SENTENCE</td>
<td><code>one SENTENCE "two three"</code></td>
<td>Match args in one sentence; needs <code>index_sp</code></td>
</tr>
<tr class="odd">
<td>PARAGRAPH</td>
<td><code>one PARAGRAPH two</code></td>
<td>Match args in one paragraph; needs <code>index_sp</code></td>
</tr>
<tr class="even">
<td>ZONE</td>
<td><code>ZONE:(h3,h4) one two</code></td>
<td>Match in given zones only; needs <code>index_zones</code></td>
</tr>
<tr class="odd">
<td>ZONESPAN</td>
<td><code>ZONESPAN:(h3,h4) one two</code></td>
<td>Match in contiguous spans only; needs <code>index_zones</code></td>
</tr>
</tbody>
</table>
<p>Now let’s discuss all these modifiers and operators in a bit more
detail.</p>
<h3 id="keyword-modifiers">Keyword modifiers</h3>
<p><strong>Exact form</strong> modifier is only applicable when
morphology (ie. either stemming or lemmatizaion) is enabled. With
morphology on, Sphinx searches for normalized keywords by default. This
modifier lets you search for an exact original form. It requires
<code>index_exact_words</code> setting to be enabled.</p>
<p>The syntax is <code>=</code> at the keyword start.</p>
<pre><code>=exact</code></pre>
<p>For the sake of an example, assume that English stemming is enabled,
ie. that the index was configured with <code>morphology = stem_en</code>
setting. Also assume that we have these three sample documents:</p>
<pre><code>id, content
1, run
2, runs
3, running</code></pre>
<p>Without <code>index_exact_words</code>, only the normalized form,
namely <code>run</code>, is stored into the index for every document.
Even with the modifier, it is impossible to differentiate between
them.</p>
<p>With <code>index_exact_words = 1</code>, both the normalized and
original keyword forms are stored into the index. However, by default
the keywords are also normalized when searching. So a query
<code>runs</code> will get normalized to <code>run</code>, and will
still match all 3 documents.</p>
<p>And finally, with <code>index_exact_words = 1</code> and with the
exact form modifier, a query like <code>=runs</code> will be able to
match just the original form, and return just the document #2.</p>
<p>For convenience, you can also apply this particular modifier to an
entire phrase operator, and it will propagate down to all keywords.</p>
<pre><code>=&quot;runs down the hills&quot;
&quot;=runs =down =the =hills&quot;</code></pre>
<p><strong>Field start modifier</strong> makes the keyword match if and
only if it occurred at the very beginning of (any) full-text field.
(Technically, it will only match postings with an in-field position of
1.)</p>
<p>The syntax is <code>^</code> at the keyword start, mimicked after
regexps.</p>
<pre><code>^fieldstart</code></pre>
<p><strong>Field end modifier</strong> makes the keyword match if and
only if it occurred at the very end of (any) full-text field.
(Technically, it will only match postings with a special internal
“end-of-field” flag.)</p>
<p>The syntax is <code>$</code> at the keyword start, mimicked after
regexps.</p>
<pre><code>fieldend$</code></pre>
<p><strong>IDF boost modifier</strong> lets you adjust the keyword IDF
value (used for ranking), it multiplies the IDF value by a given
constant. That affects a number of ranking factors that build upon the
IDF. That in turn also affects default ranking.</p>
<p>The syntax is <code>^</code> followed by a scale constant. Scale must
be non-negative and must start with a digit or a dot. Scale can be zero,
both <code>^0</code> and <code>^0.0</code> should be legal.</p>
<pre><code>boostme^1.23</code></pre>
<h3 id="boolean-operators-brackets-and-or-not">Boolean operators
(brackets, AND, OR, NOT)</h3>
<p>These let you implement grouping (with brackets) and classic boolean
logic. The respective formal syntax is as follows:</p>
<ul>
<li>brackets: <code>(expr1)</code></li>
<li>AND: <code>expr1 expr2</code></li>
<li>OR: <code>expr1 | expr2</code></li>
<li>NOT: <code>-expr1</code> or <code>!expr1</code></li>
</ul>
<p>Where <code>expr1</code> and <code>expr2</code> are either keywords,
or any other computable text query expressions. Here go a few query
examples showing all of the operators.</p>
<pre><code>(shaken !stirred)
&quot;barack obama&quot; (alaska | california | texas | &quot;new york&quot;)
one -(two | (three -four))</code></pre>
<p>Nothing too exciting to see here. But still there are a few quirks
worth a quick mention. Here they go, in no particular order.</p>
<p><strong>OR operator precedence is higher than AND.</strong></p>
<p>In other words, ORs take priority, they are evaluated first, ANDs are
then evaluated on top of ORs. Thus,
<code>looking for cat | dog | mouse</code> query is equivalent to
<code>looking for (cat | dog | mouse)</code>, and <em>not</em>
<code>(looking for cat) | dog | mouse</code>.</p>
<p><strong>ANDs are implicit.</strong></p>
<p>There isn’t any explicit syntax for them in Sphinx. Just put two
expressions right next to each other, and that’s it.</p>
<p><strong>No all-caps versions for AND/OR/NOT, those are valid
keywords.</strong></p>
<p>So something like <code>rick AND morty</code> is equivalent to
<code>rick and morty</code>, and both these queries require all 3
keywords to match, including that literal <code>and</code>.</p>
<p>Notice the difference in behavior between this, and, say,
<code>rick MAYBE morty</code>, where the syntax for operator MAYBE is
that all-caps keyword.</p>
<p><strong>Field and zone limits affect the entire
(sub)expression.</strong></p>
<p>Meaning that <code>@title</code> limit in a
<code>@title hello world</code> query applies to all keywords, not just
a keyword or expression immediately after the limit operator. Both
keywords in this example would need to match in the <code>title</code>
field, not only the first <code>hello</code>. An explicit way to write
this query, with an explicit field limit for every keyword, would be
<code>(@title hello) (@title world)</code>.</p>
<p><strong>Brackets push and pop field and zone limits.</strong></p>
<p>For example, <code>(@title hello) world</code> query requires
<code>hello</code> to be matched in <code>title</code> only. But that
limit ends on a closing bracket, and <code>world</code> can then match
anywhere in the document again. Therefore <em>this</em> query is
equivalent to something like <code>(@title hello) (@* world)</code>.</p>
<p>Even more curiously, but quite predictably,
<code>@body (@title hello) world</code> query would in turn be
equivalent to <code>(@title hello) (@body world)</code>. The first
<code>@body</code> limit gets pushed on an opening bracket, and then
restored on a closing one.</p>
<p>Sames rules apply to zones, see <code>ZONE</code> and
<code>ZONESPAN</code> operators below.</p>
<p><strong>In-query positions in boolean operators are
sequential.</strong></p>
<p>And while those do not affect <em>matching</em> (aka text based
filtering), they do noticeably affect <em>ranking</em>. For example,
even if you splice a phrase with ORs, a rather important “phrase match
degree” ranking factor (the one called ‘lcs’) does not change at all,
even though matching changes quite a lot:</p>
<div class="sourceCode" id="cb252"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, weight(), title <span class="kw">from</span> test1</span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> match(<span class="st">&#39;@title little black dress&#39;</span>);</span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------+----------+--------------------+</span></span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>     | weight() | title              |</span>
<span id="cb252-5"><a href="#cb252-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------+----------+--------------------+</span></span>
<span id="cb252-6"><a href="#cb252-6" aria-hidden="true" tabindex="-1"></a>| <span class="dv">334757</span> |     <span class="dv">3582</span> | Little black dress |</span>
<span id="cb252-7"><a href="#cb252-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------+----------+--------------------+</span></span>
<span id="cb252-8"><a href="#cb252-8" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.01</span> sec)</span>
<span id="cb252-9"><a href="#cb252-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-10"><a href="#cb252-10" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, weight(), title <span class="kw">from</span> test1</span>
<span id="cb252-11"><a href="#cb252-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> match(<span class="st">&#39;@title little | black | dress&#39;</span>);</span>
<span id="cb252-12"><a href="#cb252-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------+----------+------------------------+</span></span>
<span id="cb252-13"><a href="#cb252-13" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>     | weight() | title                  |</span>
<span id="cb252-14"><a href="#cb252-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------+----------+------------------------+</span></span>
<span id="cb252-15"><a href="#cb252-15" aria-hidden="true" tabindex="-1"></a>| <span class="dv">334757</span> |     <span class="dv">3582</span> | Little black dress     |</span>
<span id="cb252-16"><a href="#cb252-16" aria-hidden="true" tabindex="-1"></a>| <span class="dv">420209</span> |     <span class="dv">2549</span> | Little Black Backpack. |</span>
<span id="cb252-17"><a href="#cb252-17" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span></code></pre></div>
<p>So in a sense, everything you construct using brackets and operators
still looks like a single huge “phrase” (bag of words, really) to the
ranking code. As if there were no brackets and no operators.</p>
<p><strong>Operator NOT is really operator ANDNOT.</strong></p>
<p>While a query like <code>-something</code> technically can be
computed, more often than not such a query is just a programming error.
And a potentially expensive one at that, because an implicit list of
<em>all</em> the documents in the index could be quite big. Here go a
few examples.</p>
<div class="sourceCode" id="cb253"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="co">// correct query, computable at every level</span></span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>aaa <span class="op">-(</span>bbb <span class="op">-(</span>ccc ddd<span class="op">))</span></span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a><span class="co">// non-computable queries</span></span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>aaa</span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a>aaa <span class="op">|</span> <span class="op">-</span>bbb</span></code></pre></div>
<p>(On a side note, that might also raise the philosophical question of
ranking documents that contain zero matched keywords; thankfully, from
an engineering perspective it would be extremely easy to brutally cut
that Gordian knot by merely setting the weight to zero, too.)</p>
<p>For that reason, NOT operator requires something computable to its
left. An isolated NOT will raise a query error. In case that you
<em>absolutely</em> must, you can append some special magic keyword
(something like <code>__allmydocs</code>, to your taste) to all your
documents when indexing. Two example non-computable queries just above
would then become:</p>
<pre><code>(__allmydocs -aaa)
aaa | (__allmydocs -bbb)</code></pre>
<p><strong>Operator NOT only works at term start.</strong></p>
<p>In order to trigger, it must be preceded with a whitespace, or a
bracket, or other clear keyword boundary. For instance,
<code>cat-dog</code> is by default actually equivalent to merely
<code>cat dog</code>, while <code>cat -dog</code> with a space does
apply the operator NOT to <code>dog</code>.</p>
<h3 id="phrase-operator">Phrase operator</h3>
<p>Phrase operator uses the de-facto standard double quotes syntax and
basically lets you search for an exact phrase, ie. several keywords in
this exact order, without any gaps between them. For example.</p>
<pre><code>&quot;mary had a little lamb&quot;</code></pre>
<p>Yep, boring. But of course there is a bit more even to this simple
operator.</p>
<p><strong>Exact form modifier works on the entire operator.</strong> Of
course, any modifiers must work within a phrase, that’s what modifiers
are all about. But with exact form modifiers there’s extra syntax sugar
that lets you apply it to the entire phrase at once:
<code>="runs down the hills"</code> form is a bit easier to write than
<code>"=runs =down =the =hills"</code>.</p>
<p><strong>Standalone star “matches” any keyword.</strong> Or rather,
they skip that position when matching the phrase. Text queries do not
really work with document texts. They work with just the specified
keywords, and analyze their in-document and in-query positions. Now, a
special star token within a phrase operator will not actually match
anything, it will simply adjust the query position when parsing the
query. So there will be no impact on search performance at all, but the
phrase keyword positions will be shifted. For example.</p>
<pre><code>&quot;mary had * * lamb&quot;</code></pre>
<p><strong>Stopwords “match” any keyword.</strong> The very same logic
applies to stopwords. Stopwords are not even stored in the index, so we
have nothing to match. But even on stopwords, we still need adjust both
the in-document positions when indexing, and in-query positions when
matching.</p>
<p>This sometimes causes a little counter-intuitive and unexpected (but
inevitable!) matching behavior. Consider the following set of
documents:</p>
<pre><code>id, content
1, Microsoft Office 2016
2, we are using a lot of software from Microsoft in the office
3, Microsoft opens another office in the UK</code></pre>
<p>Assume that <code>in</code> and <code>the</code> are our only
stopwords. What documents would be matched by the following two phrase
queries?</p>
<ol type="1">
<li><code>"microsoft office"</code></li>
<li><code>"microsoft in the office"</code></li>
</ol>
<p>Query #1 only matches document #1, no big surprise there. However, as
we just discussed, query #2 is in fact equivalent to
<code>"microsoft * * office"</code>, because of stopwords. And so it
matches both documents #2 and #3.</p>
<h3 id="maybe-operator">MAYBE operator</h3>
<p>Operator MAYBE is occasionally needed for ranking. It takes two
arbitrary expressions, and only requires the first one to match, but
uses the (optional) matches of the second expression for ranking.</p>
<pre><code>expr1 MAYBE expr2</code></pre>
<p>For instance, <code>rick MAYBE morty</code> query matches exactly the
same documents as just <code>rick</code>, but with that extra MAYBE,
documents that mention both <code>rick</code> and <code>morty</code>
will get ranked higher.</p>
<p>Arbitrary expressions are supported, so this is also valid:</p>
<pre><code>rick MAYBE morty MAYBE (season (one || two || three) -four&#39;)</code></pre>
<h3 id="term-or-operator">Term-OR operator</h3>
<p>Term-OR operator (double pipe) essentially lets you specify “properly
ranked” per-keyword synonyms at query time.</p>
<p>Matching-wise, it just does regular boolean OR over several keywords,
but ranking-wise (and unlike the regular OR operator), it does
<em>not</em> increment their in-query positions. That keeps any
positional ranking factors intact.</p>
<p>Naturally, it only accepts individual keywords, you can not term-OR a
keyword and a phrase or any other expression. Also, term-OR is currently
not supported within phrase or proximity operators, though that is an
interesting possibility.</p>
<p>It should be easiest to illustrate it with a simple example. Assume
we are still searching for that little black dress, as we did in our
example on the regular OR operator.</p>
<div class="sourceCode" id="cb260"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, weight(), title <span class="kw">from</span> rt</span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> match(<span class="st">&#39;little black dress&#39;</span>);</span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+-----------------------------------------------+</span></span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | weight() | title                                         |</span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+-----------------------------------------------+</span></span>
<span id="cb260-6"><a href="#cb260-6" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> |     <span class="dv">3566</span> | little black dress                            |</span>
<span id="cb260-7"><a href="#cb260-7" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> |     <span class="dv">1566</span> | huge black<span class="op">/</span>charcoal dress <span class="kw">with</span> a little white |</span>
<span id="cb260-8"><a href="#cb260-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+-----------------------------------------------+</span></span>
<span id="cb260-9"><a href="#cb260-9" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>So far so good. But looks like <code>charcoal</code> is a synonym
that we could use here. Let’s try to use it using the regular OR
operator.</p>
<div class="sourceCode" id="cb261"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, weight(), title <span class="kw">from</span> rt</span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> match(<span class="st">&#39;little black|charcoal dress&#39;</span>);</span>
<span id="cb261-3"><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+-----------------------------------------------+</span></span>
<span id="cb261-4"><a href="#cb261-4" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | weight() | title                                         |</span>
<span id="cb261-5"><a href="#cb261-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+-----------------------------------------------+</span></span>
<span id="cb261-6"><a href="#cb261-6" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> |     <span class="dv">3632</span> | huge black<span class="op">/</span>charcoal dress <span class="kw">with</span> a little white |</span>
<span id="cb261-7"><a href="#cb261-7" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> |     <span class="dv">2566</span> | little black dress                            |</span>
<span id="cb261-8"><a href="#cb261-8" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> |     <span class="dv">2566</span> | little charcoal dress                         |</span>
<span id="cb261-9"><a href="#cb261-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+-----------------------------------------------+</span></span>
<span id="cb261-10"><a href="#cb261-10" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Oops, what just happened? We now also match document #2, which is
good, but why is the document #3 ranked so high all of a sudden?</p>
<p>That’s because with regular ORs ranking would, basically, look for
the entire query as if without any operators, ie. the ideal phrase match
would be not just <code>"little black dress"</code>, but the entire
<code>"little black charcoal dress"</code> query with all special
operators removed.</p>
<p>There is no such a “perfect” 4 keyword full phrase match in our small
test database. (If there was, it would get top rank.) From the phrase
ranking point of view, the next kinda-best thing to it is the
<code>"black/charcoal dress"</code> part, where a 3 keyword subphrase
matches the query. And that’s why it gets ranked higher that
<code>"little black dress"</code>, where the longest common subphrase
between the document and the query is <code>"little black"</code>, only
2 keywords long, not 3.</p>
<p>But that’s not what we wanted in this case at all; we just wanted to
introduce a synonym for <code>black</code>, rather than break ranking!
And that’s exactly what term-OR operator is for.</p>
<div class="sourceCode" id="cb262"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, weight(), title <span class="kw">from</span> rt</span>
<span id="cb262-2"><a href="#cb262-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> match(<span class="st">&#39;little black||charcoal dress&#39;</span>);</span>
<span id="cb262-3"><a href="#cb262-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+-----------------------------------------------+</span></span>
<span id="cb262-4"><a href="#cb262-4" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | weight() | title                                         |</span>
<span id="cb262-5"><a href="#cb262-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+-----------------------------------------------+</span></span>
<span id="cb262-6"><a href="#cb262-6" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> |     <span class="dv">3566</span> | little black dress                            |</span>
<span id="cb262-7"><a href="#cb262-7" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> |     <span class="dv">3566</span> | little charcoal dress                         |</span>
<span id="cb262-8"><a href="#cb262-8" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> |     <span class="dv">2632</span> | huge black<span class="op">/</span>charcoal dress <span class="kw">with</span> a little white |</span>
<span id="cb262-9"><a href="#cb262-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+-----------------------------------------------+</span></span>
<span id="cb262-10"><a href="#cb262-10" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Good, ranking is back to expected. Both the original exact match
<code>"little black dress"</code> and synonymical
<code>"little charcoal dress"</code> are now at the top again, because
of a perfect phrase match (which is favored by the default ranker).</p>
<p>Note that while all the examples above revolved around a single
positional factor <code>lcs</code> (which is used in the default
ranker), there are more positional factors than just that. See the
section on <a href="#ranking-factors">Ranking factors</a> for more
details.</p>
<h3 id="field-and-position-limit-operator">Field and position limit
operator</h3>
<p>Field limit operator limits matching of the subsequent expressions to
a given field, or a set of fields. Field names must exist in the index,
otherwise the query will fail with an error.</p>
<p>There are several syntax forms available.</p>
<ol type="1">
<li><p><code>@field</code> limits matching to a single given field. This
is the simplest form. <code>@(field)</code> is also valid.</p></li>
<li><p><code>@(f1,f2,f3)</code> limits matching to multiple given
fields. Note that the match might happen just partially in one of the
fields. For example, <code>@(title,body) hello world</code> does
<em>not</em> require that both keywords match in the very same field!
Document like <code>{"id":123, "title":"hello", "body":"world"}</code>
(pardon my JSON) does match this query.</p></li>
<li><p><code>@!(f1,f2,f3)</code> limits matching to all the fields
<em>except</em> given ones. This can be useful to avoid matching
end-user queries against some internal system fields, for one.
<code>@!f1</code> is also valid syntax in case you want to skip just the
one field.</p></li>
<li><p><code>@*</code> syntax resets any previous limits, and re-enables
matching all fields.</p></li>
</ol>
<p>In addition, all forms except <code>@*</code> can be followed by an
optional <code>[N]</code> clause, which limits the matching to
<code>N</code> first tokens (keywords) within a field. All of the
examples below are valid:</p>
<ul>
<li><code>@title[50] test</code></li>
<li><code>@(title,body)[50] test</code></li>
<li><code>@!title[50] test</code></li>
</ul>
<p>To reiterate, field limits are “contained” by brackets, or more
formally, any current limits are stored on an opening bracket, and
restored on a closing one.</p>
<p>When in doubt, use <code>SHOW PLAN</code> to figure out what limits
are actually used:</p>
<div class="sourceCode" id="cb263"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">set</span> profiling<span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> rt <span class="kw">where</span> match(<span class="st">&#39;(@title[50] hello) world&#39;</span>) <span class="kw">limit</span> <span class="dv">0</span>;</span>
<span id="cb263-3"><a href="#cb263-3" aria-hidden="true" tabindex="-1"></a>  show <span class="kw">plan</span> \G</span>
<span id="cb263-4"><a href="#cb263-4" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb263-5"><a href="#cb263-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-6"><a href="#cb263-6" aria-hidden="true" tabindex="-1"></a><span class="op">***************************</span> <span class="fl">1.</span> <span class="kw">row</span> <span class="op">***************************</span></span>
<span id="cb263-7"><a href="#cb263-7" aria-hidden="true" tabindex="-1"></a>Variable: transformed_tree</span>
<span id="cb263-8"><a href="#cb263-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">Value</span>: <span class="kw">AND</span>(</span>
<span id="cb263-9"><a href="#cb263-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span>(fields<span class="op">=</span>(title), max_field_pos<span class="op">=</span><span class="dv">50</span>, KEYWORD(hello, querypos<span class="op">=</span><span class="dv">1</span>)),</span>
<span id="cb263-10"><a href="#cb263-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span>(KEYWORD(world, querypos<span class="op">=</span><span class="dv">2</span>)))</span>
<span id="cb263-11"><a href="#cb263-11" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>We can see that <code>@title</code> limit was only applied to
<code>hello</code>, and reset back to matching all fields (and
positions) on a closing bracket, as expected.</p>
<h3 id="proximity-and-near-operators">Proximity and NEAR operators</h3>
<p><strong>Proximity operator</strong> matches all the specified
keywords, in any order, and allows for a number of gaps between those
keywords. The formal syntax is as follows:</p>
<pre><code>&quot;keyword1 keyword2 ... keywordM&quot;~N</code></pre>
<p>Where <code>N</code> has a little weird meaning. It is the allowed
number of gaps (other keywords) that can occur between those
<code>M</code> specified keywords, but additionally incremented by
1.</p>
<p>For example, consider a document that reads
<code>"Mary had a little lamb whose fleece was white as snow"</code>,
and consider two queries: <code>"lamb fleece mary"~4</code>, and
<code>"lamb fleece mary"~5</code>. We have exactly 4 extra words between
<code>mary</code>, <code>lamb</code>, and <code>fleece</code>, namely
those 4 are <code>had</code>, <code>a</code>, <code>little</code>, and
<code>whose</code>. This means that the first query with
<code>N = 4</code> will <em>not</em> match, because with
<code>N = 4</code> the proximity operator actually allows for 3 gaps
only, not 4. And thus the second example query will match, as with
<code>N = 5</code> it allows for 4 gaps (plus 1 permutation).</p>
<p><strong>NEAR operator</strong> is a generalized version of proximity
operator. Its syntax is:</p>
<pre><code>expr1 NEAR/N expr2</code></pre>
<p>Where <code>N</code> has the same meaning as in the proximity
operator, the number of allowed gaps plus one. But with NEAR we can use
arbitrary expressions, not just individual keywords.</p>
<pre><code>(binary | &quot;red black&quot;) NEAR/2 tree</code></pre>
<p>Left and right expressions can still match in any order. For example,
a query <code>progress NEAR/2 bar</code> would match both these
documents:</p>
<ol type="1">
<li><code>progress bar</code></li>
<li><code>a bar called Progress</code></li>
</ol>
<p>NEAR is left associative, meaning that
<code>arg1 NEAR/X arg2 NEAR/Y arg3</code> will be evaluated as
<code>(arg1 NEAR/X arg2) NEAR/Y arg3</code>. It has the same (lowest)
precedence as BEFORE.</p>
<p>Note that while with just 2 keywords proximity and NEAR operators are
identical (eg. <code>"one two"~N</code> and <code>one NEAR/N two</code>
should behave exactly the same), with more keywords that is <em>not</em>
the case.</p>
<p>Because when you stack multiple keywords with NEAR, then up to
<code>N - 1</code> gaps are allowed per <em>each</em> keyword in the
stack. Consider this example with two stacked NEAR operators:
<code>one NEAR/3 two NEAR/3 three</code>. It allows up to 2 gaps between
<code>one</code> and <code>two</code>, and then for 2 more gaps between
<code>two</code> and three. That’s less restrictive than the proximity
operator with the same N (<code>"one two three"~3</code>), as the
proximity operator will only allow 2 gaps total. So a document with
<code>one aaa two bbb ccc three</code> text will match the NEAR query,
but <em>not</em> the proximity query.</p>
<p>And vice versa, what if we bump the limit in proximity to match the
total limit allowed by all NEARs? We get <code>"one two three"~5</code>
(4 gaps allowed, plus that magic 1), so that anything that matches the
NEARs variant would also match the proximity variant. But now a document
<code>one two aaa bbb ccc ddd three</code> ceases to match the NEARs,
because the gap between <code>two</code> and <code>three</code> is too
big. And now the proximity operator becomes less restrictive.</p>
<p>Bottom line is, the proximity operator and a stack of NEARs are
<em>not</em> really interchangeable, they match a bit different
things.</p>
<h3 id="quorum-operator">Quorum operator</h3>
<p>Quorum matching operator essentially lets you perform fuzzy matching.
It’s less strict than matching all the argument keywords. It will match
all documents with at least N keywords present out of M total specified.
Just like with proximity (or with AND), those N can occur in any
order.</p>
<pre><code>&quot;keyword1 keyword2 ... keywordM&quot;/N
&quot;keyword1 keyword2 ... keywordM&quot;/fraction</code></pre>
<p>For a specific example,
<code>"the world is a wonderful place"/3</code> will match all documents
that have any 3 of the specified words, or more.</p>
<p>Naturally, N must be less or equal to M. Also, M must be anywhere
from 1 to 256 keywords, inclusive. (Even though quorum with just 1
keyword makes little sense, that is allowed.)</p>
<p>Fraction must be from 0.0 to 1.0, more details below.</p>
<p>Quorum with <code>N = 1</code> is effectively equivalent to a stack
of ORs, and can be used as syntax sugar to replace that. For instance,
these two queries are equivalent:</p>
<pre><code>red | orange | yellow | green | blue | indigo | violet
&quot;red orange yellow green blue indigo violet&quot;/1</code></pre>
<p>Instead of an absolute number <code>N</code>, you can also specify a
fraction, a floating point number between 0.0 and 1.0. In this case
Sphinx will automatically compute <code>N</code> based on the number of
keywords in the operator. This is useful when you don’t or can’t know
the keyword count in advance. The example above can be rewritten as
<code>"the world is a wonderful place"/0.5</code>, meaning that we want
to match at least 50% of the keywords. As there are 6 words in this
query, the autocomputed match threshold would also be 3.</p>
<p>Fractional threshold is rounded up. So with 3 keywords and a fraction
of 0.5 we would get a final threshold of 2 keywords, as
<code>3 * 0.5 = 1.5</code> rounds up as 2. There’s also a lower safety
limit of 1 keyword, as matching zero keywords makes zero sense.</p>
<p>When the quorum threshold is too restrictive (ie. when N is greater
than M), the operator gets automatically replaced with an AND operator.
The same fallback happens when there are more than 256 keywords.</p>
<h3 id="strict-order-operator-before">Strict order operator
(BEFORE)</h3>
<p>This operator enforces a strict “left to right” order (ie. the query
order) on its arguments. The arguments can be arbitrary expressions. The
syntax is <code>&lt;&lt;</code>, and there is no all-caps version.</p>
<pre><code>expr1 &lt;&lt; expr2</code></pre>
<p>For instance, <code>black &lt;&lt; cat</code> query will match a
<code>black and white cat</code> document but <em>not</em> a
<code>that cat was black</code> document.</p>
<p>Strict order operator has the lowest priority, same as NEAR
operator.</p>
<p>It can be applied both to just keywords and more complex expressions,
so the following is a valid query:</p>
<pre><code>(bag of words) &lt;&lt; &quot;exact phrase&quot; &lt;&lt; red|green|blue</code></pre>
<h3 id="sentence-and-paragraph-operators">SENTENCE and PARAGRAPH
operators</h3>
<p>These operators match the document when both their arguments are
within the same sentence or the same paragraph of text, respectively.
The arguments can be either keywords, or phrases, or the instances of
the same operator. (That is, you can stack several SENTENCE operators or
PARAGRAPH operators. Mixing them is however not supported.) Here are a
few examples:</p>
<pre><code>one SENTENCE two
one SENTENCE &quot;two three&quot;
one SENTENCE &quot;two three&quot; SENTENCE four</code></pre>
<p>The order of the arguments within the sentence or paragraph does not
matter.</p>
<p><a href="sphinx2.html#conf-index-sp"><code>index_sp = 1</code></a>
setting (sentence and paragraph indexing) is required for these
operators to work. They revert to a mere <code>AND</code> otherwise.
Refer to documentation on <code>index_sp</code> for additional details
on what’s considered a sentence or a paragraph.</p>
<h3 id="zone-and-zonespan-operators">ZONE and ZONESPAN operators</h3>
<p>Zone limit operator is a bit similar to field limit operator, but
restricts matching to a given in-field zone (or a list of zones). The
following syntax variants are supported:</p>
<pre><code>ZONE:h1 test
ZONE:(h2,h3) test
ZONESPAN:h1 test
ZONESPAN:(h2,h3) test</code></pre>
<p>Zones are named regions within a field. Essentially they map to HTML
(or XML) markup. Everything between <code>&lt;h1&gt;</code> and
<code>&lt;/h1&gt;</code> is in a zone called <code>h1</code> and could
be matched by that <code>ZONE:h1 test</code> query.</p>
<p>Note that ZONE and ZONESPAN limits will get reset not only on a
closing bracket, or on the next zone limit operator, but on a next
<em>field</em> limit operator too! So make sure to specify zones
explicitly for every field. Also, this makes operator <code>@*</code> a
<em>full</em> reset, ie. it should reset both field and zone limits.</p>
<p>Zone limits require indexes built with zones support (see
documentation on <a
href="sphinx2.html#conf-index-zones"><code>index_zones</code></a> for a
bit more details).</p>
<p>The difference between ZONE and ZONESPAN limit is that the former
allows its arguments to match in multiple disconnected spans of the same
zone, and the latter requires that all matching occurs within a single
contiguous span.</p>
<p>For instance, <code>(ZONE:th hello world)</code> query <em>will</em>
match this example document.</p>
<div class="sourceCode" id="cb273"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;th&gt;</span>Table 1. Local awareness of Hello Kitty brand.<span class="kw">&lt;/th&gt;</span></span>
<span id="cb273-2"><a href="#cb273-2" aria-hidden="true" tabindex="-1"></a>.. some table data goes here ..</span>
<span id="cb273-3"><a href="#cb273-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;th&gt;</span>Table 2. World-wide brand awareness.<span class="kw">&lt;/th&gt;</span></span></code></pre></div>
<p>In this example we have 2 spans of <code>th</code> zone,
<code>hello</code> will match in the first one, and <code>world</code>
in the second one. So in a sense ZONE works on a concatenation of all
the zone spans.</p>
<p>And if you need to further limit matching to any of the individual
contiguous spans, you should use the ZONESPAN operator.
<code>(ZONESPAN:th hello world)</code> query does <em>not</em> match the
document above. <code>(ZONESPAN:th hello kitty)</code> however does!</p>
<h2 id="searching-expressions-and-operators">Searching: expressions and
operators</h2>
<p>Arbitrary expressions such as <code>SELECT 1+2*3</code> can be
computed in <code>SELECT</code> and this section aims to cover them.
Types, operators, quirks, all that acid jazz.</p>
<h3 id="expression-types">Expression types</h3>
<p>Let’s start with the top-1 quirk in the Sphinx expressions, and that
definitely is the ghastly <code>INT</code> vs <code>UINT</code>
mismatch.</p>
<p><strong>Numeric expressions</strong> internally compute in 3 types:
<code>INT</code>, <code>BIGINT</code>, and <code>FLOAT</code>, and one
important thing to note here is that expressions use
<strong>signed</strong> 32-bit <code>INT</code>, but 32-bit integer
columns are of the <strong>unsigned</strong> <code>UINT</code> type.
(For the record, integer JSON values use either <code>INT</code> or
<code>BIGINT</code> type.)</p>
<p>However, results are <strong><em>printed</em></strong> using the
<code>UINT</code> type. That’s basically for <code>UINT</code>
attributes sake, so they would print back as inserted. But that
sometimes causes not-quite-expected results in <em>other</em> places.
For instance!</p>
<div class="sourceCode" id="cb274"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="dv">1</span><span class="op">-</span><span class="dv">2</span>;</span>
<span id="cb274-2"><a href="#cb274-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------+</span></span>
<span id="cb274-3"><a href="#cb274-3" aria-hidden="true" tabindex="-1"></a>| <span class="dv">1</span><span class="op">-</span><span class="dv">2</span>        |</span>
<span id="cb274-4"><a href="#cb274-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------+</span></span>
<span id="cb274-5"><a href="#cb274-5" aria-hidden="true" tabindex="-1"></a>| <span class="dv">4294967295</span> |</span>
<span id="cb274-6"><a href="#cb274-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------+</span></span>
<span id="cb274-7"><a href="#cb274-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb274-8"><a href="#cb274-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb274-9"><a href="#cb274-9" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="dv">1</span><span class="op">-</span><span class="dv">2</span><span class="op">+</span><span class="dv">9876543210</span><span class="op">-</span><span class="dv">9876543210</span>;</span>
<span id="cb274-10"><a href="#cb274-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------+</span></span>
<span id="cb274-11"><a href="#cb274-11" aria-hidden="true" tabindex="-1"></a>| <span class="dv">1</span><span class="op">-</span><span class="dv">2</span><span class="op">+</span><span class="dv">9876543210</span><span class="op">-</span><span class="dv">9876543210</span> |</span>
<span id="cb274-12"><a href="#cb274-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------+</span></span>
<span id="cb274-13"><a href="#cb274-13" aria-hidden="true" tabindex="-1"></a>| <span class="op">-</span><span class="dv">1</span>                        |</span>
<span id="cb274-14"><a href="#cb274-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------+</span></span>
<span id="cb274-15"><a href="#cb274-15" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>There’s a method to this madness. For constants, we default to the
most compact type, and <code>UINT</code> is quite enough for 1 and 2
here. For basic arithmetic, we keep the argument type, so
<code>1-2</code> ends up being <code>UINT</code> too. And
<code>UINT(-1)</code> <strong>does</strong> convert to that well-known 4
billion value.</p>
<p>Now, in the second example 9876543210 is a big enough constant that
does <em>not</em> fit into 32 bits. All the calculations are thus in
<code>BIGINT</code> from the very start, and printed as such in the very
end. And so we get -1 here. We can force that behavior explicitly by
using <code>BIGINT(1-2)</code> instead.</p>
<p>Bottom line, in Sphinx expressions both <code>UINT</code> attributes
(expectedly) <em>and</em> “small enough” constants (less so!) are both
<strong>unsigned</strong>, and basic arithmetic over <code>UINT</code>
also stays <code>UINT</code> where possible.</p>
<p><strong>Non-numeric expressions</strong> should be much more boring
than that. Can’t even instantly recall any top-2 quirk related to
those.</p>
<p>Non-numeric types are much more diverse. Naturally, all the supported
attribute types are also supported in expressions,
<code>SELECT column</code> must work at all times. So expressions can
work with strings, JSONs, arrays, sets, etc.</p>
<p>But other than that, pretty much the only “interesting” type that the
engine adds and exposes is the <code>FACTORS</code> type with all the
ranking signals, as returned by the <code>FACTORS()</code> built-in
function.</p>
<p>And yes, that <em>is</em> a special type. Even though it
<strong>prints</strong> as JSON, and most of its contents can be
accessed in very similar way (eg. <code>FACTORS().bm15</code> or
<code>FACTORS().fields.title.lcs</code> etc), internally storing signals
as generic JSON would be <em>very</em> inefficient, and so we have a
special underlying type.</p>
<p><strong>Non-numeric types never really convert, and operators are
limited.</strong> Unlike numeric types. And that’s what makes them
boring (in a good way).</p>
<p>There aren’t really many quirks that are there with the numeric
types, such as that <code>1 - 2</code>, or <code>1 + 16777216.0</code>,
etc. Simply because you can <strong>not</strong>, say, add a
<code>BIGINT_SET</code> column and a JSON key.
<code>SELECT set1 + json2.key3</code> simply fails with a syntax
error.</p>
<p>That being said, <strong>numerics and JSON still auto-mix, and
evaluate as <code>FLOAT</code>.</strong> An expression like
<code>j.foo + 1</code> is legal syntax, and it means
<code>FLOAT(j.foo) + 1</code>, for (some) convenience. If you need a
conversion to <code>BIGINT</code> instead, you can specify that
explicitly.</p>
<div class="sourceCode" id="cb275"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> j, j.foo <span class="op">+</span> <span class="dv">1</span>, bigint(j.foo) <span class="op">+</span> <span class="dv">1</span> <span class="kw">from</span> test;</span>
<span id="cb275-2"><a href="#cb275-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------+------------+-------------------+</span></span>
<span id="cb275-3"><a href="#cb275-3" aria-hidden="true" tabindex="-1"></a>| j                | j.foo <span class="op">+</span> <span class="dv">1</span>  | bigint(j.foo) <span class="op">+</span> <span class="dv">1</span> |</span>
<span id="cb275-4"><a href="#cb275-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------+------------+-------------------+</span></span>
<span id="cb275-5"><a href="#cb275-5" aria-hidden="true" tabindex="-1"></a>| {<span class="ot">&quot;foo&quot;</span><span class="ch">:16777216</span>} | <span class="fl">16777216.0</span> |          <span class="dv">16777217</span> |</span>
<span id="cb275-6"><a href="#cb275-6" aria-hidden="true" tabindex="-1"></a>| {<span class="ot">&quot;foo&quot;</span><span class="ch">:789</span><span class="fl">.0</span>}    |      <span class="fl">790.0</span> |               <span class="dv">790</span> |</span>
<span id="cb275-7"><a href="#cb275-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------+------------+-------------------+</span></span>
<span id="cb275-8"><a href="#cb275-8" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="arithmetic-operators">Arithmetic operators</h3>
<p><strong>Arithmetic operators</strong> are supported for all the
numeric argument types, and they are as follows.</p>
<table>
<thead>
<tr class="header">
<th>Operator</th>
<th>Description</th>
<th>Example</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>+</code></td>
<td>Addition</td>
<td><code>1 - 2</code></td>
<td><code>4294967295</code></td>
</tr>
<tr class="even">
<td><code>-</code></td>
<td>Subtraction</td>
<td><code>3.4 - 5.6</code></td>
<td><code>-2.1999998</code></td>
</tr>
<tr class="odd">
<td><code>-</code></td>
<td>Negation</td>
<td><code>-sqrt(2)</code></td>
<td><code>-1.4142135</code></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td><code>1---1</code></td>
<td><code>0</code></td>
</tr>
<tr class="odd">
<td><code>*</code></td>
<td>Multiplication</td>
<td><code>111111 * 111111</code></td>
<td><code>3755719729</code></td>
</tr>
<tr class="even">
<td><code>/</code></td>
<td>Division</td>
<td><code>-13 / 5</code></td>
<td><code>-2.6000001</code></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td><code>-(13 / 5)</code></td>
<td><code>-2.6</code></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td><code>1 / 0</code></td>
<td><code>0.0</code></td>
</tr>
<tr class="odd">
<td><code>%</code>, <code>MOD</code></td>
<td>Integer modulus</td>
<td><code>-13 % 5</code></td>
<td><code>-3</code></td>
</tr>
<tr class="even">
<td><code>DIV</code></td>
<td>Integer division</td>
<td><code>-13 DIV 5</code></td>
<td><code>-2</code></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td><code>10.5 DIV 3</code></td>
<td><code>3</code></td>
</tr>
</tbody>
</table>
<p>We tried to make the usual boring examples slightly interesting. What
was your WTF rate over the last 30 seconds?</p>
<p><strong>Evaluation happens using the widest argument type.</strong>
Not infrequently, that type is just too narrow!</p>
<p>The basic numeric types that Sphinx uses everywhere (including the
expressions) are <code>UINT</code> (u32), <code>BIGINT</code> (i64), and
<code>FLOAT</code> (f32). So <code>1 - 2</code> actually means
<code>UINT(1 - 2)</code> and that gives us <code>pow(2,32) - 1</code>
and that is <code>4294967295</code>. Same story with
<code>111111 * 111111</code> which wraps around to
<code>pow(111111,2) - 2*pow(2,32)</code> or <code>3755719729</code>.
Mystery solved.</p>
<p><strong>Explicit type casts work, and can help.</strong>
<code>SELECT BIGINT(1 - 2)</code> gives <code>-1</code>, as kinda
expected. <code>BIGINT</code> has its limits too, and as (now) kinda
expected <code>9223372036854775808 + 9223372036854775808</code> gives
<code>0</code>, but hey, math is hard.</p>
<p><strong><code>FLOAT</code> is a single-precision 32-bit
float.</strong> Hence <code>-2.1999998</code>, because of the classic
precision and roundtrip issues. Care for a quick refresher?</p>
<p><code>3.4</code> and <code>5.6</code> are finite (and short!) in
decimal, but they are <strong>infinite</strong> fractions in binary.
Just as finite ternary <code>0.1</code> is infinite
<code>0.33333...</code> back in decimal. So computers <em>have</em> to
store the closest <strong>finite binary fraction</strong> instead, and
lose some digits. So the <strong>exact</strong> values in our example
actually are <code>3.400000095367431640625</code> and
<code>5.599999904632568359375</code>, and the <strong>exact</strong>
difference is <code>-2.19999980926513671875</code>, and that’s
<strong>precision loss</strong> rearing its ugly head.</p>
<p>Fortunately, the <strong>shortest decimal value</strong> that parses
back to that exact value (always) requires less digits, and
<code>-2.1999998</code> is enough. Alas, if we cut just one more digit,
<code>-2.199999</code> parses back to
<code>-2.1999990940093994140625</code> and that obviously is a different
number. Can’t have that, must have <strong>roundtrip</strong>.</p>
<p>On that note, <strong>Sphinx guarantees <code>FLOAT</code>
roundtrip.</strong> Meaning, decimal <code>FLOAT</code> values that it
returns are <strong>guaranteed</strong> to parse back exactly, bit for
bit.</p>
<p>Alright, that explains <code>3.4 - 5.6</code>, but how come that
<code>-13/5</code> and <code>-(13/5)</code> are different?! Why are
these magics only happening in the first expression?</p>
<p><strong>Expressions are internally optimized.</strong> Constants get
precomputed, operators get reordered and fused and replaced with other
(mathematically) identical ones. Why? For better performance, of
course.</p>
<p>So basically, our two expressions parse slightly differently in the
first place, and that affects the specific optimizations order, leading
to different results. Specifically, <code>-(13/5)</code> parses to
<code>neg(div(13,5))</code>, then <code>div(13,5)</code> optimizes to
<code>2.6</code> (approximately!), then <code>neg(2.6)</code> optimizes
to <code>-2.6</code>.</p>
<p>But <code>-13/5</code> parses differently to
<code>div(neg(13),5)</code>, then optimizes differently to
<code>mul(neg(13),0.2)</code> and then to <code>mul(-13,0.2)</code>, and
<em>that</em> gives <code>-2.6000001</code>, because the
<strong>exact</strong> value for that <code>0.2</code> is approximately
<code>0.200000003</code> even though it <strong>prints</strong> as
<code>0.2</code>! And when that tiny “invisible” delta gets scaled by
13, it becomes visible. Precision loss again. Did we ever mention that
math is hard? (But fun.)</p>
<p>Next order of business, <strong>division by zero intentionally
produces zero</strong>, basically because <strong>Sphinx does not really
support NULL</strong>. Yes, ideally we would return <code>NULL</code>
here, but our current expressions are designed differently.</p>
<p><strong>Integer division (<code>DIV</code>) casts its arguments to
integer.</strong> So <code>10.5/3</code> gives <code>10/3</code> and
that is 3. <strong>Integer division by zero also gives zero by
design</strong>, same reason, no NULLs.</p>
<h3 id="comparison-operators">Comparison operators</h3>
<p><strong>Comparison operators</strong> are supported for most
combinations of numeric, string, and JSON types, and they are as
follows.</p>
<table>
<thead>
<tr class="header">
<th>Operator</th>
<th>Description</th>
<th>Example</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>&lt;</code></td>
<td>Strictly less than</td>
<td><code>1 &lt; 2</code></td>
<td><code>1</code></td>
</tr>
<tr class="even">
<td><code>&gt;</code></td>
<td>Strictly greater than</td>
<td><code>1 &gt; 2</code></td>
<td><code>0</code></td>
</tr>
<tr class="odd">
<td><code>&lt;=</code></td>
<td>Less than or equal</td>
<td><code>1 &lt;= 2</code></td>
<td><code>1</code></td>
</tr>
<tr class="even">
<td><code>&gt;=</code></td>
<td>Greater than or equal</td>
<td><code>1 &gt;= 2</code></td>
<td><code>0</code></td>
</tr>
<tr class="odd">
<td><code>=</code></td>
<td>Is equal</td>
<td><code>2+3=4</code></td>
<td><code>0</code></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td><code>2+(3=4)</code></td>
<td><code>2</code></td>
</tr>
<tr class="odd">
<td><code>!=</code>, <code>&lt;&gt;</code></td>
<td>Is not equal</td>
<td><code>2+2&lt;&gt;4</code></td>
<td><code>0</code></td>
</tr>
</tbody>
</table>
<p><strong>Comparisons evaluate to either 0 or 1 in numeric
contexts.</strong> And they <strong>can</strong> be used in numeric
contexts, as in the <code>2+(3=4)</code> example.</p>
<p><strong>Equality comparisons work on strings, and support
collations.</strong> Operators <code>=</code> and <code>!=</code>
support string arguments, and their behavior depends on the per-session
<strong>collation</strong> variable.</p>
<div class="sourceCode" id="cb276"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">create</span> <span class="kw">table</span> colltest (<span class="kw">id</span> bigint, title field_string);</span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb276-3"><a href="#cb276-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb276-4"><a href="#cb276-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">insert</span> <span class="kw">into</span> colltest <span class="kw">values</span> (<span class="dv">123</span>, <span class="st">&#39;hello&#39;</span>);</span>
<span id="cb276-5"><a href="#cb276-5" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb276-6"><a href="#cb276-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb276-7"><a href="#cb276-7" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> colltest <span class="kw">where</span> title<span class="op">=</span><span class="st">&#39;HellO&#39;</span>;</span>
<span id="cb276-8"><a href="#cb276-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+</span></span>
<span id="cb276-9"><a href="#cb276-9" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | title |</span>
<span id="cb276-10"><a href="#cb276-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+</span></span>
<span id="cb276-11"><a href="#cb276-11" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | hello |</span>
<span id="cb276-12"><a href="#cb276-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+</span></span>
<span id="cb276-13"><a href="#cb276-13" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p><strong>The default collation is <code>libc_ci</code>,</strong>
meaning that for strings comparisons, Sphinx defaults to
<code>strcasecmp()</code> call. That one is usually is case insensitive,
<em>and</em> it depends on a specific locale. Most locales do support
Latin characters, hence our example comparison for <code>HellO</code>
did return <code>hello</code> even though the case was different.</p>
<p><strong>There are 4 built-in collations, including one with basic
UTF-8 support.</strong> Namely.</p>
<table>
<thead>
<tr class="header">
<th>Collation</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>libc_ci</code></td>
<td>Calls <code>strcasecmp()</code> from <code>libc</code></td>
</tr>
<tr class="even">
<td><code>libc_cs</code></td>
<td>Calls <code>strcoll()</code> from <code>libc</code></td>
</tr>
<tr class="odd">
<td><code>utf8_general_ci</code></td>
<td>Basic own implementation, <strong>not</strong> UCA</td>
</tr>
<tr class="even">
<td><code>binary</code></td>
<td>Calls <code>strcmp()</code> from <code>libc</code></td>
</tr>
</tbody>
</table>
<p>Look, there <strong>are</strong> two case sensitive ones we could
use!</p>
<div class="sourceCode" id="cb277"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">set</span> collation_connection<span class="op">=</span>libc_cs;</span>
<span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb277-3"><a href="#cb277-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-4"><a href="#cb277-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> colltest <span class="kw">where</span> title<span class="op">=</span><span class="st">&#39;HellO&#39;</span>;</span>
<span id="cb277-5"><a href="#cb277-5" aria-hidden="true" tabindex="-1"></a><span class="kw">Empty</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb277-6"><a href="#cb277-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-7"><a href="#cb277-7" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> colltest <span class="kw">where</span> title<span class="op">=</span><span class="st">&#39;hello&#39;</span>;</span>
<span id="cb277-8"><a href="#cb277-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+</span></span>
<span id="cb277-9"><a href="#cb277-9" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | title |</span>
<span id="cb277-10"><a href="#cb277-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+</span></span>
<span id="cb277-11"><a href="#cb277-11" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | hello |</span>
<span id="cb277-12"><a href="#cb277-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+</span></span>
<span id="cb277-13"><a href="#cb277-13" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Using <code>binary</code> collation instead of <code>libc_cs</code>
would have worked here too. But there <em>is</em> a subtle difference
and that’s the locale.</p>
<p><strong>Locale (eg. <code>LC_ALL</code>) still affects
<code>libc_ci</code> and <code>libc_cs</code> collations.</strong>
Mostly for historical reasons. Sphinx pretty much requires UTF-8
strings, and that’s a multibyte encoding. But <code>strcasecmp()</code>
and <code>strcoll()</code> and therefore <code>libc_ci</code> and
<code>libc_cs</code> collations only really supports single-byte
encodings (aka SBCS). So these days the applications are, ahem,
limited.</p>
<p><strong>Locale does <em>not</em> affect the <code>binary</code>
collation.</strong> Because <code>strcmp()</code> does not use the
locale.</p>
<p><strong>Basic Unicode support is provided via
<code>utf8_general_ci</code> collation.</strong> Ideally we’d also
support full-blown UCA (Unicode Collation Algorithm) and/or a few more
language-specific Unicode collations, but there’s zero demand for
that.</p>
<p>Bottom line, <strong>we default to case insensitive single-byte
string comparisons</strong>, but you can use either <code>binary</code>
collation for case-sens; or <code>utf8_general_ci</code> for basic UTF-8
aware case-insens; or with Latin-1 strings, even the legacy-ish
<code>libc_ci</code> and <code>libc_cs</code> collations might be of
some use. String comparsions are rarely used within Sphinx so this is a
rather obscure place.</p>
<p>Moving on, <strong>comparisons with JSON keys are supported</strong>,
even though values coming from JSON are naturally polymorphic. How’s
that work?</p>
<p><strong>JSON key vs numeric comparisons require a numeric
value.</strong> When the respective stored value is not numeric (or does
not even exist), <strong>any comparison fails</strong>, and returns 0
(aka false). For the record, ideally this would return NULL, but no
NULLs in Sphinx.</p>
<div class="sourceCode" id="cb278"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, j.nosuchkey <span class="op">&lt;</span> <span class="dv">123</span> <span class="kw">from</span> test;</span>
<span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------------+</span></span>
<span id="cb278-3"><a href="#cb278-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | j.nosuchkey <span class="op">&lt;</span> <span class="dv">123</span> |</span>
<span id="cb278-4"><a href="#cb278-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------------+</span></span>
<span id="cb278-5"><a href="#cb278-5" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> |                 <span class="dv">0</span> |</span>
<span id="cb278-6"><a href="#cb278-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------------+</span></span>
<span id="cb278-7"><a href="#cb278-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb278-8"><a href="#cb278-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-9"><a href="#cb278-9" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, j.nosuchkey <span class="op">&gt;</span> <span class="dv">123</span> <span class="kw">from</span> test;</span>
<span id="cb278-10"><a href="#cb278-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------------+</span></span>
<span id="cb278-11"><a href="#cb278-11" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | j.nosuchkey <span class="op">&gt;</span> <span class="dv">123</span> |</span>
<span id="cb278-12"><a href="#cb278-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------------+</span></span>
<span id="cb278-13"><a href="#cb278-13" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> |                 <span class="dv">0</span> |</span>
<span id="cb278-14"><a href="#cb278-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------------+</span></span>
<span id="cb278-15"><a href="#cb278-15" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p><strong>Double JSON values are forcibly truncated to
<code>FLOAT</code> (f32) for comparisons.</strong> That actually
<strong>helps</strong>. Expressions generally are in <code>FLOAT</code>,
and truncation ends up being <em>less</em> confusing. There
<em>always</em> are inevitable edge cases when comparing floats, because
of the float precision and roundoff issues. We find that
<em>without</em> this seemingly weird truncation we get much
<em>more</em> of those!</p>
<p>Here’s an example, and a real-world one at that.
<code>SELECT j.doubleval &gt;= 2.22</code> without the truncation
evaluated to 0 even though <code>j.doubleval</code> printed
<code>2.22</code>; what sorcery is this?! Well, that’s that pesky
infinite fraction roundoff issue discussed earlier. Neither double nor
float can store <code>2.22</code> <strong>exactly</strong>, but as
double is <strong>more</strong> precise, it gets <strong>closer</strong>
to the target value, and we have
<code>double(2.22) &lt; float(2.22)</code>, counter-intuitively failing
the comparison.</p>
<p><a href="#json-comparison-quirks">“JSON comparison quirks”</a> has a
couple more examples.</p>
<h3 id="logical-operators">Logical operators</h3>
<p><strong>Logical operators</strong> are supported for integer
arguments, with zero value being the logical <code>FALSE</code> value,
and everything else the <code>TRUE</code> value.</p>
<table>
<thead>
<tr class="header">
<th>Operator</th>
<th>Description</th>
<th>Example</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>AND</code></td>
<td>Logical AND</td>
<td><code>4 AND 2</code></td>
<td><code>1</code></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td><code>2 + (3 AND 4)</code></td>
<td><code>3</code></td>
</tr>
<tr class="odd">
<td><code>OR</code></td>
<td>Logical OR</td>
<td><code>4 OR 2</code></td>
<td><code>1</code></td>
</tr>
<tr class="even">
<td><code>NOT</code></td>
<td>Logical NOT</td>
<td><code>NOT 4 OR 2</code></td>
<td><code>1</code></td>
</tr>
</tbody>
</table>
<p>These are very boring and very similar to every other system
(thankfully), but even so, we think there are a few things worth writing
down.</p>
<p><strong>Logical operators also evaluate to either 0 or 1</strong>,
just as comparisons do. Hence the <code>2 + (3 AND 4) = 2 + 1 = 3</code>
result.</p>
<p><strong><code>NOT</code> has highest priority</strong>, so
<code>NOT 4 OR 2 = (NOT 4) OR 2 = FALSE OR TRUE</code> and we get
<code>TRUE</code> aka <code>1</code> in that example.
<code>NOT(4 OR 2)</code> gives zero.</p>
<p><strong><code>AND</code> has higher priority than <code>OR</code>,
and they are left-associative</strong>. Knowing that, we should be able
to place brackets in something as seemingly complex as
<code>aaa AND bbb OR NOT ccc AND ddd</code> exactly at Sphinx does. It’s
<strong>left to right</strong> because left-associative; we do
<strong>NOTs first, ANDs next, and ORs last</strong> because operator
priorities; so it should be
<code>(aaa AND bbb) OR ((NOT ccc) AND ddd)</code>. Very boring.
Thankfully. But one still might wanna use explicit brackets.</p>
<h3 id="bitwise-operators">Bitwise operators</h3>
<p><strong>Bitwise operators</strong> are supported for integer
arguments.</p>
<table>
<thead>
<tr class="header">
<th>Operator</th>
<th>Description</th>
<th>Example</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>&amp;</code></td>
<td>Bitwise AND</td>
<td><code>22 &amp; 5</code></td>
<td><code>4</code></td>
</tr>
<tr class="even">
<td><code>|</code></td>
<td>Bitwise OR</td>
<td><code>22 | 5</code></td>
<td><code>23</code></td>
</tr>
<tr class="odd">
<td><code>^</code></td>
<td>Bitwise XOR</td>
<td><code>2 ^ 7</code></td>
<td><code>5</code></td>
</tr>
<tr class="even">
<td><code>~</code></td>
<td>Bitwise NOT</td>
<td><code>~0</code></td>
<td><code>4294967295</code></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td><code>~BIGINT(0)</code></td>
<td><code>-1</code></td>
</tr>
<tr class="even">
<td><code>&lt;&lt;</code></td>
<td>Left shift</td>
<td><code>1 &lt;&lt; 35</code></td>
<td><code>0</code></td>
</tr>
<tr class="odd">
<td><code>&gt;&gt;</code></td>
<td>Right shift</td>
<td><code>7 &gt;&gt; 1</code></td>
<td><code>3</code></td>
</tr>
</tbody>
</table>
<p><strong>Bitwise operators avoid extending input types.</strong>
That’s why <code>1 &lt;&lt; 35</code> is zero, and why <code>~0</code>
is <code>4294967295</code>, and why <code>BIGINT(1 &lt;&lt; 35)</code>
is also zero. Our inputs in all these examples get a 32-bit
<code>UINT</code> type. Then the bitwise operators work with 32-bit
values, and return 32-bit results. But we can still force the 64-bit
results, <code>BIGINT(1) &lt;&lt; 35</code> returns
<code>34359738368</code> as expected, and <code>~BIGINT(0)</code>
returns <code>-1</code> also as expected.</p>
<p><strong>Shifts are logical (unsigned), NOT arithmetic (signed), even
on <code>BIGINT</code>.</strong> Meaning that
<code>-9223372036854775808 &gt;&gt; 1</code> gives us
<code>4611686018427387904</code>, because the sign bit gets shifted
away. This is intentional, we expect bitwise operators on Sphinx side to
be mostly useful for <strong>working with bitmasks</strong>, and for
that, unsigned shifts are best.</p>
<h3 id="operator-priority">Operator priority</h3>
<p><strong>Sphinx operator priority mimics C/C++.</strong> Priority
groups in higher priority to lower priority order (ie. evaluated first
to last) are as follows. (Yes, smaller priority value means
<em>higher</em> priority, priority 1 beats priority 5.)</p>
<table>
<thead>
<tr class="header">
<th>Priority</th>
<th>Operators</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><code>~</code></td>
</tr>
<tr class="even">
<td>2</td>
<td><code>NOT</code></td>
</tr>
<tr class="odd">
<td>3</td>
<td><code>*</code>, <code>/</code>, <code>%</code>, <code>DIV</code>,
<code>MOD</code></td>
</tr>
<tr class="even">
<td>4</td>
<td><code>+</code>, <code>-</code></td>
</tr>
<tr class="odd">
<td>5</td>
<td><code>&lt;&lt;</code>, <code>&gt;&gt;</code></td>
</tr>
<tr class="even">
<td>6</td>
<td><code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>,
<code>&gt;=</code></td>
</tr>
<tr class="odd">
<td>7</td>
<td><code>=</code>, <code>!=</code></td>
</tr>
<tr class="even">
<td>8</td>
<td><code>&amp;</code></td>
</tr>
<tr class="odd">
<td>9</td>
<td><code>^</code></td>
</tr>
<tr class="even">
<td>10</td>
<td><code>\|</code></td>
</tr>
<tr class="odd">
<td>11</td>
<td><code>AND</code></td>
</tr>
<tr class="even">
<td>12</td>
<td><code>OR</code></td>
</tr>
</tbody>
</table>
<h2 id="searching-geosearches">Searching: geosearches</h2>
<p>Efficient geosearches are possible with Sphinx, and the related
features are:</p>
<ul>
<li><a href="#geodist-function"><code>GEODIST()</code> function</a> that
computes a distance between two geopoints</li>
<li><a href="#mingeodist-function"><code>MINGEODIST()</code>
function</a> that computes a minimum 1-to-N points geodistance</li>
<li><a href="#mingeodistex-function"><code>MINGEODISTEX()</code>
function</a> that does the same, but additionally returns the nearest
point’s index</li>
<li><a href="#contains-function"><code>CONTAINS()</code> function</a>
that checks if a geopoint is inside a geopolygon</li>
<li><a href="#containsany-function"><code>CONTAINSANY()</code>
function</a> that checks if any of the points are inside a
geopolygon</li>
<li><a href="#using-attribute-indexes">attribute indexes</a> that enable
speeding up <code>GEODIST()</code> searches (they are used for fast,
early distance checks)</li>
<li>special <a href="#multigeo-support"><code>MULTIGEO()</code>
attribute index variant</a> that enables speeding up
<code>MINGEODST()</code> searches</li>
</ul>
<h3 id="attribute-indexes-for-geosearches">Attribute indexes for
geosearches</h3>
<p>When you create indexes on your latitude and longitude columns (and
you should), query optimizer can utilize those in a few important
<code>GEODIST()</code> usecases:</p>
<ol type="1">
<li>Single constant anchor case:</li>
</ol>
<div class="sourceCode" id="cb279"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> GEODIST(lat, lon, $lat, $lon) dist <span class="op">..</span>.</span>
<span id="cb279-2"><a href="#cb279-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> dist <span class="op">&lt;=</span> $radius</span></code></pre></div>
<ol start="2" type="1">
<li>Multiple constant anchors case:</li>
</ol>
<div class="sourceCode" id="cb280"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a>  GEODIST(lat, lon, $lat1, $lon1) dist1,</span>
<span id="cb280-3"><a href="#cb280-3" aria-hidden="true" tabindex="-1"></a>  GEODIST(lat, lon, $lat2, $lon2) dist2,</span>
<span id="cb280-4"><a href="#cb280-4" aria-hidden="true" tabindex="-1"></a>  GEODIST(lat, lon, $lat3, $lon3) dist3,</span>
<span id="cb280-5"><a href="#cb280-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">..</span>.,</span>
<span id="cb280-6"><a href="#cb280-6" aria-hidden="true" tabindex="-1"></a>  (dist1 <span class="op">&lt;</span> $radius1 <span class="kw">OR</span> dist2 <span class="op">&lt;</span> $radius2 <span class="kw">OR</span> dist3 <span class="op">&lt;</span> $radius3 <span class="op">..</span>.) ok</span>
<span id="cb280-7"><a href="#cb280-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> ok<span class="op">=</span><span class="dv">1</span></span></code></pre></div>
<p>These cases are known to the query optimizer, and once it detects
them, it can choose to perform an approximate attribute index read (or
reads) first, instead of scanning the entire index. When the quick
approximate read is selective enough, which frequently happens with
small enough search distances, savings can be huge.</p>
<p>Case #1 handles your typical “give me everything close enough to a
certain point” search. When the anchor point and radius are all
constant, Sphinx will automatically precompute a bounding box that fully
covers a “circle” with a required radius around that anchor point, ie.
find some two internal min/max values for latitude and longitude,
respectively. It will then quickly check attribute indexes statistics,
and if the bounding box condition is selective enough, it will switch to
attribute index reads instead of a full scan.</p>
<p>Here’s a working query example:</p>
<div class="sourceCode" id="cb281"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span>, GEODIST(lat,lon,<span class="fl">55.7540</span>,<span class="fl">37.6206</span>,{<span class="kw">in</span><span class="op">=</span>deg,<span class="kw">out</span><span class="op">=</span>km}) <span class="kw">AS</span> dist</span>
<span id="cb281-2"><a href="#cb281-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> myindex <span class="kw">WHERE</span> dist<span class="op">&lt;=</span><span class="dv">100</span></span></code></pre></div>
<p>Case #2 handles multi-anchor search, ie. “give me documents that are
either close enough to point number 1, or to point number 2, etc”. The
base approach is exactly the same, but <em>multiple</em> bounding boxes
are generated, multiple index reads are performed, and their results are
all merged together.</p>
<p>Here’s another example:</p>
<div class="sourceCode" id="cb282"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>,</span>
<span id="cb282-2"><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a>  GEODIST(lat, lon, <span class="fl">55.777</span>, <span class="fl">37.585</span>, {<span class="kw">in</span><span class="op">=</span>deg,<span class="kw">out</span><span class="op">=</span>km}) d1,</span>
<span id="cb282-3"><a href="#cb282-3" aria-hidden="true" tabindex="-1"></a>  GEODIST(lat, lon, <span class="fl">55.569</span>, <span class="fl">37.576</span>, {<span class="kw">in</span><span class="op">=</span>deg,<span class="kw">out</span><span class="op">=</span>km}) d2,</span>
<span id="cb282-4"><a href="#cb282-4" aria-hidden="true" tabindex="-1"></a>  geodist(lat, lon, <span class="fl">56.860</span>, <span class="fl">35.912</span>, {<span class="kw">in</span><span class="op">=</span>deg,<span class="kw">out</span><span class="op">=</span>km}) d3,</span>
<span id="cb282-5"><a href="#cb282-5" aria-hidden="true" tabindex="-1"></a>  (d1<span class="op">&lt;</span><span class="dv">1</span> <span class="kw">OR</span> d2<span class="op">&lt;</span><span class="dv">1</span> <span class="kw">OR</span> d3<span class="op">&lt;</span><span class="dv">1</span>) ok</span>
<span id="cb282-6"><a href="#cb282-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> myindex <span class="kw">WHERE</span> ok<span class="op">=</span><span class="dv">1</span></span></code></pre></div>
<p>Note that if we reformulate the queries a little, and the optimizer
does not recognize the eligible cases any more, the optimization will
<em>not</em> trigger. For example:</p>
<div class="sourceCode" id="cb283"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span>, <span class="dv">2</span><span class="op">*</span>GEODIST(lat,lon,<span class="fl">55.7540</span>,<span class="fl">37.6206</span>,{<span class="kw">in</span><span class="op">=</span>deg,<span class="kw">out</span><span class="op">=</span>km})<span class="op">&lt;=</span><span class="dv">100</span> <span class="kw">AS</span> flag</span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> myindex <span class="kw">WHERE</span> flag<span class="op">=</span><span class="dv">1</span></span></code></pre></div>
<p>Obviously, “the bounding box optimization” is actually still feasible
in this case, but the optimizer will not recognize that and switch to
full scan.</p>
<p>To ensure whether these optimizations are working for you, use
<code>EXPLAIN</code> on your query. Also, make sure the radius small
enough when doing those checks.</p>
<p>Another interesting bit is that sometimes optimizer can quite
<em>properly</em> choose to only use one index instead of two, or avoid
using the indexes at all.</p>
<p>Say, what if our radius covers the entire country? All our documents
will be within the bounding box anyway, and simple full scan will indeed
be faster. That’s why you should use some “small enough” test radius
with <code>EXPLAIN</code>.</p>
<p>Or say, what if we have another, super-selective
<code>AND id=1234</code> condition in our query? Doing index reads will
be just as extraneous, the optimizer will choose to perform a lookup by
<code>id</code> instead.</p>
<h3 id="multigeo-support">Multigeo support</h3>
<p><a href="#mingeodist-function"><code>MINGEODIST()</code></a>, <a
href="#mingeodistex-function"><code>MINGEODISTEX()</code></a> and <a
href="#containsany-function"><code>CONTAINSANY()</code></a> functions
let you have a <em>variable</em> number of geopoints per row, stored as
a simple JSON array of 2D coordinates. You can then find either “close
enough” rows with <code>MINGEODIST()</code>, additionally identify the
best geopoint in each such row with <code>MINGEODISTEX()</code>, or find
rows that have at least one geopoint in a given search polygon using
<code>CONTAINSANY()</code>. You can also speed up searches with a
special <code>MULTIGEO</code> index.</p>
<p>The points must be stored as simple arrays of lat/lon values, in that
order. (For the record, we considered arrays of arrays as our “base”
syntax too, but rejected that idea.) We strongly recommend using
degrees, even though there is support for radians and one can still
manage if one absolutely must. Here goes an example with just a couple
of points (think home and work addresses).</p>
<div class="sourceCode" id="cb284"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> test (<span class="kw">id</span>, j) <span class="kw">VALUES</span></span>
<span id="cb284-2"><a href="#cb284-2" aria-hidden="true" tabindex="-1"></a>(<span class="dv">123</span>, <span class="st">&#39;{&quot;points&quot;: [39.6474, -77.463, 38.8974, -77.0374]}&#39;</span>)</span></code></pre></div>
<p>And you can then compute the distance to a given point to “the entire
row”, or more formally, a minimum distance between some given point and
all the points stored in that row.</p>
<div class="sourceCode" id="cb285"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> MINGEODIST(j.points, <span class="fl">38.889</span>, <span class="op">-</span><span class="fl">77.009</span>, {<span class="kw">in</span><span class="op">=</span>deg}) md <span class="kw">FROM</span> test</span></code></pre></div>
<p>If you also require the specific point index, not just the distance,
then use <code>MINGEODISTEX()</code> instead. It returns
<code>&lt;distance&gt;, &lt;index&gt;</code> pair, but behaves as
<code>&lt;distance&gt;</code> in both <code>WHERE</code> and
<code>ORDER BY</code> clauses. So the following returns distances
<em>and</em> geopoint indexes, sorted by distance.</p>
<div class="sourceCode" id="cb286"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> MINGEODISTEX(j.points, <span class="fl">38.889</span>, <span class="op">-</span><span class="fl">77.009</span>, {<span class="kw">in</span><span class="op">=</span>deg}) mdx <span class="kw">FROM</span> test</span>
<span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> mdx <span class="kw">DESC</span></span></code></pre></div>
<p>Queries that limit <code>MINGEODIST()</code> to a certain radius can
also be sped up using attribute indexes too, just like “regular”
<code>GEODIST()</code> queries!</p>
<p>For that, we must let Sphinx know in advance that our JSON field
stores an array of lat/lon pairs. That requires using the special
<code>MULTIGEO()</code> “type” when creating the attribute index on that
field.</p>
<div class="sourceCode" id="cb287"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> points <span class="kw">ON</span> test(MULTIGEO(j.points))</span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> MINGEODIST(j.points, <span class="fl">38.889</span>, <span class="op">-</span><span class="fl">77.009</span>, {<span class="kw">in</span><span class="op">=</span>deg, <span class="kw">out</span><span class="op">=</span>mi}) md</span>
<span id="cb287-3"><a href="#cb287-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> test <span class="kw">WHERE</span> md<span class="op">&lt;</span><span class="dv">10</span></span></code></pre></div>
<p>With the <code>MULTIGEO</code> index in place, the
<code>MINGEODIST()</code> and <code>MINGEODISTEX()</code> queries can
use bounding box optimizations discussed just above.</p>
<h2 id="searching-percolate-queries">Searching: percolate queries</h2>
<p>Sphinx supports special percolate queries and indexes that let you
perform “reverse” searches and match documents against previously stored
queries.</p>
<p>You create a special “percolate query index”
(<code>type = pq</code>), you store queries (literally contents of
<code>WHERE</code> clauses) into that index, and you run special
percolate queries with <code>PQMATCH(DOCS(...))</code> syntax that match
document contents to previously stored queries. Here’s a quick kick-off
as to how.</p>
<div class="sourceCode" id="cb288"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> pqtest</span>
<span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb288-3"><a href="#cb288-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = pq</span>
<span id="cb288-4"><a href="#cb288-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">field</span> = title</span>
<span id="cb288-5"><a href="#cb288-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">attr_uint</span> = gid</span>
<span id="cb288-6"><a href="#cb288-6" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<div class="sourceCode" id="cb289"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> pqtest <span class="kw">VALUES</span></span>
<span id="cb289-2"><a href="#cb289-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> (<span class="dv">1</span>, <span class="st">&#39;id &gt; 5&#39;</span>),</span>
<span id="cb289-3"><a href="#cb289-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> (<span class="dv">2</span>, <span class="st">&#39;MATCH(\&#39;</span>keyword\<span class="st">&#39;)&#39;</span>),</span>
<span id="cb289-4"><a href="#cb289-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> (<span class="dv">3</span>, <span class="st">&#39;gid = 456&#39;</span>);</span>
<span id="cb289-5"><a href="#cb289-5" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">3</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb289-6"><a href="#cb289-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-7"><a href="#cb289-7" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pqtest <span class="kw">WHERE</span> PQMATCH(DOCS(</span>
<span id="cb289-8"><a href="#cb289-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> {<span class="dv">111</span>, <span class="st">&#39;this is doc1 with keyword&#39;</span>, <span class="dv">123</span>},</span>
<span id="cb289-9"><a href="#cb289-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> {<span class="dv">777</span>, <span class="st">&#39;this is doc2&#39;</span>, <span class="dv">234</span>}));</span>
<span id="cb289-10"><a href="#cb289-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------------+</span></span>
<span id="cb289-11"><a href="#cb289-11" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | <span class="kw">query</span>            |</span>
<span id="cb289-12"><a href="#cb289-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------------+</span></span>
<span id="cb289-13"><a href="#cb289-13" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> | MATCH(<span class="st">&#39;keyword&#39;</span>) |</span>
<span id="cb289-14"><a href="#cb289-14" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> | <span class="kw">id</span> <span class="op">&gt;</span> <span class="dv">5</span>           |</span>
<span id="cb289-15"><a href="#cb289-15" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------------+</span></span>
<span id="cb289-16"><a href="#cb289-16" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Now to the nitty gritty!</p>
<p><strong>The own, intrinsic schema of any PQ index is always just two
columns.</strong> First column must be a <code>BIGINT</code> query id.
Second column must be a query <code>STRING</code> that stores a valid
<code>WHERE</code> clause, such as those <code>id &gt; 5</code> or
<code>MATCH(...)</code> clauses we used just above.</p>
<p><strong>In addition, PQ index must know its document schema.</strong>
We declare <em>that</em> schema with <code>field</code> and
<code>attr_xxx</code> config directives. And document schemas may and do
vary from one PQ index to another.</p>
<p><strong>In addition, PQ index must know its document text processing
settings.</strong> Meaning that all the tokenizing, mapping, morphology,
etc settings are all perfectly supported, and will be used for
<code>PQMATCH()</code> matching.</p>
<p><strong>Knowing all that, <code>PQMATCH()</code> matches stored
queries to incoming documents.</strong> (Or to be precise, stored
<code>WHERE</code> predicates, as they aren’t complete queries.)</p>
<p><strong>Stored queries are essentially <code>WHERE</code>
conditions.</strong> Sans the <code>WHERE</code> itself. Formally, you
should be able to use any legal <code>WHERE</code> expression as your
stored query.</p>
<p><strong>Stored queries that match <em>ANY</em> of documents are
returned.</strong> In our example, query 1 matches both tested documents
(ids 111 and 777), query 2 only matches one document (id 111), and query
3 matches none. Queries 1 and 2 get returned.</p>
<p><strong>Percolate queries work off temporary per-query RT
indexes.</strong> Every <code>PQMATCH()</code> query does indeed create
a tiny in-memory index with the documents it was given. Then it
basically runs all the previously stored searches against that index,
and drops it. So in theory you could get more or less the same results
manually.</p>
<div class="sourceCode" id="cb290"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> tmp (title FIELD, attr UINT);</span>
<span id="cb290-2"><a href="#cb290-2" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> tmp <span class="kw">VALUES</span></span>
<span id="cb290-3"><a href="#cb290-3" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">111</span>, <span class="st">&#39;this is doc1 with keyword&#39;</span>, <span class="dv">123</span>),</span>
<span id="cb290-4"><a href="#cb290-4" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">777</span>, <span class="st">&#39;this is doc2&#39;</span>, <span class="dv">234</span>);</span>
<span id="cb290-5"><a href="#cb290-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="dv">1</span> <span class="kw">FROM</span> tmp <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">&gt;</span> <span class="dv">5</span>;</span>
<span id="cb290-6"><a href="#cb290-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="dv">2</span> <span class="kw">FROM</span> tmp <span class="kw">WHERE</span> MATCH(<span class="st">&#39;keyword&#39;</span>);</span>
<span id="cb290-7"><a href="#cb290-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="dv">3</span> <span class="kw">FROM</span> tmp <span class="kw">WHERE</span> gid <span class="op">=</span> <span class="dv">456</span>;</span>
<span id="cb290-8"><a href="#cb290-8" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> tmp;</span></code></pre></div>
<p>Except that PQ indexes are optimized for that. First, PQ indexes
avoid a bunch of overheads that regular <code>CREATE</code>,
<code>INSERT</code>, and <code>SELECT</code> statements incur. Second,
PQ indexes also analyze <code>MATCH()</code> conditions as you
<code>INSERT</code> queries, and very quickly reject documens that
definitely <em>don’t</em> match later when you <code>PQMATCH()</code>
the documents.</p>
<p>Still, <strong><code>PQMATCH()</code> works (much!) faster with
batches of documents.</strong> While those overheads are reduced, they
are not completely gone, and you can save on that by batching. Running
100 percolate queries with just 1 document can easily get 10 to 20
<em>times</em> slower than running just 1 equivalent percolate query
with all 100 documents in it. So if you can batch, do batch.</p>
<p><strong>PQ queries can return the matched docids too, via
PQMATCHED().</strong> This special function only works with
<code>PQMATCH()</code> queries. It returns a comma-separated list of
documents IDs from <code>DOCS(...)</code> that did match the “current”
stored query, for instance:</p>
<div class="sourceCode" id="cb291"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, PQMATCHED(), <span class="kw">query</span> <span class="kw">FROM</span> pqtest</span>
<span id="cb291-2"><a href="#cb291-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">WHERE</span> PQMATCH(DOCS({<span class="dv">123</span>, <span class="st">&#39;keyword&#39;</span>}, {<span class="dv">234</span>, <span class="st">&#39;another&#39;</span>}));</span>
<span id="cb291-3"><a href="#cb291-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------+--------+</span></span>
<span id="cb291-4"><a href="#cb291-4" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | PQMATCHED() | <span class="kw">query</span>  |</span>
<span id="cb291-5"><a href="#cb291-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------+--------+</span></span>
<span id="cb291-6"><a href="#cb291-6" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> | <span class="dv">123</span>,<span class="dv">234</span>     | <span class="kw">id</span> <span class="op">&gt;</span> <span class="dv">0</span> |</span>
<span id="cb291-7"><a href="#cb291-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------+--------+</span></span>
<span id="cb291-8"><a href="#cb291-8" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p><strong><code>DOCS()</code> rows must have all columns, and in proper
“insert schema” order.</strong> Meaning, documents in
<code>DOCS()</code> must have all their columns (including ID), and the
columns must be in the exact PQ index config order.</p>
<p>Sounds kinda scary, but in reality you simply pass exactly the same
data in <code>DOCS()</code> as you would in <code>INSERT</code>document,
and that’s it. On any mismatch, <code>PQMATCH()</code> just fails, with
a hopefully helpful error message.</p>
<p><strong><code>DOCS()</code> is currently limited to at most 10000
documents.</strong> So checking 50K documents must be split into 5
different <code>PQMATCH()</code> queries.</p>
<p><strong>PQ queries can use multiple cores with
<code>OPTION threads=&lt;N&gt;</code>.</strong> Queries against larger
PQ indexes (imagine millions of stored searches) with just 1 thread
could get too slow. You can use <code>OPTION threads=&lt;N&gt;</code> to
let them spawn N threads. That improves latency almost linearly.</p>
<div class="sourceCode" id="cb292"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> pqtest <span class="kw">WHERE</span> PQMATCH(DOCS({<span class="dv">123</span>, <span class="st">&#39;keyword&#39;</span>}, <span class="op">..</span>.))</span>
<span id="cb292-2"><a href="#cb292-2" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> threads<span class="op">=</span><span class="dv">8</span></span></code></pre></div>
<p>Beware that <code>OPTION threads</code> does <strong>NOT</strong>
take threads from the common <code>searchd</code> pool. <strong>It
forcibly creates new threads instead</strong>, so the total thread count
can get as high as <code>max_children * N</code> with this option. Use
with care.</p>
<p>The default value is 1 thread. The upper limit is 32 threads per
query.</p>
<p><strong>To manage data stored in PQ indexes, use basic CRUD
queries.</strong> The supported ones are very basic and limited just
yet, but they get the job done.</p>
<ul>
<li><code>INSERT</code> and <code>REPLACE</code> both work;</li>
<li><code>SELECT ... LIMIT ...</code> works;</li>
<li><code>DELETE ... WHERE id ...</code> works;</li>
<li><code>TRUNCATE INDEX ...</code> works.</li>
</ul>
<p>For instance!</p>
<div class="sourceCode" id="cb293"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> pqtest;</span>
<span id="cb293-2"><a href="#cb293-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------------+</span></span>
<span id="cb293-3"><a href="#cb293-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | <span class="kw">query</span>            |</span>
<span id="cb293-4"><a href="#cb293-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------------+</span></span>
<span id="cb293-5"><a href="#cb293-5" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> | <span class="kw">id</span> <span class="op">&gt;</span> <span class="dv">5</span>           |</span>
<span id="cb293-6"><a href="#cb293-6" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> | MATCH(<span class="st">&#39;keyword&#39;</span>) |</span>
<span id="cb293-7"><a href="#cb293-7" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> | gid <span class="op">=</span> <span class="dv">456</span>        |</span>
<span id="cb293-8"><a href="#cb293-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------------+</span></span>
<span id="cb293-9"><a href="#cb293-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p><strong>PQ indexes come with a built-in size sanity check.</strong>
There’s a maximum row count (aka maximum stored queries count),
controlled by <code>pq_max_rows</code> directive. It defaults to
1,000,000 queries. (Because a million queries must be enough for eve..
er, for one core.)</p>
<p>Once you hit it, you can’t insert more stored queries until you
either remove some, or adjust the limit. That can be done online
easily.</p>
<div class="sourceCode" id="cb294"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> pqtest <span class="kw">SET</span> <span class="kw">OPTION</span> pq_max_rows<span class="op">=</span><span class="dv">2000000</span>;</span></code></pre></div>
<p>Why even bother? Stored queries take very little RAM, but they may
burn quite a lot of CPU. Remember that <em>every</em>
<code>PQMATCH()</code> query needs to test its incoming
<code>DOCS()</code> against <em>all</em> the stored queries. There
should be <em>some</em> safety net, and <code>pq_max_rows</code> is
it.</p>
<p><strong>PQ indexes are binlogged.</strong> So basically the data you
<code>INSERT</code> is crash-safe. They are also periodically flushed to
the disk (manual <code>FLUSH INDEX</code> works as well).</p>
<p><strong>PQ indexes are <em>not</em> regular FT indexes, and they are
additionally limited.</strong> In a number of ways. Many familiar
operations won’t work (some yet, some ever). Here are a few tips.</p>
<ul>
<li><code>SELECT</code> does not support any <code>WHERE</code> or
<code>ORDER</code> etc clauses yet;</li>
<li><code>INSERT</code> does not support column list, it’s always
<code>(id, 'query')</code> pairs;</li>
<li><code>DELETE</code> only supports explicit <code>WHERE id=...</code>
and <code>WHERE id IN (...)</code>;</li>
<li><code>DESCRIBE</code> does not work yet;</li>
<li>PQ indexes can not be used in distributed indexes.</li>
</ul>
<h2 id="searching-vector-searches">Searching: vector searches</h2>
<p>You can implement vector searches with Sphinx and there are several
different features intended for that, namely:</p>
<ul>
<li>fixed array attributes, eg.
<code>attr_int8_array = vec1[128]</code></li>
<li>JSON array attributes, eg. <code>{"vec2": int8[1,2,3,4]}</code></li>
<li><a href="#dot-function"><code>DOT()</code> function</a> to compute
dot products</li>
<li><a href="#l1dist-function"><code>L1DIST()</code> function</a> to
compute Manhattan distances</li>
<li><a href="#l2dist-function"><code>L2DIST()</code> function</a> to
compute Euclidean distances</li>
<li><a href="#fvec-function"><code>FVEC()</code> function</a> to specify
vector constants</li>
<li><a href="#searching-vector-indexes">ANN vector indexes</a> for
larger collections</li>
</ul>
<p>Let’s see how all these parts connect together. Extremely briefly, as
follows.</p>
<ol type="1">
<li>Store your vectors, better as array attributes.</li>
<li>For slower exact searches, just order by
<code>DOT/L1DIST/L2DIST()</code> expression.</li>
<li>For faster approximate searches, create some vector index (aka ANN
index).</li>
<li>For even faster searches, fine-tune everything.</li>
</ol>
<p>And now, of course, we dive into details and these four lines
magically turn into several pages.</p>
<p><strong>First, storage.</strong> You can store your per-document
vectors using any of the following options:</p>
<ul>
<li>fixed-size fixed-type arrays, ie. <code>attr_XXX_array</code>
directive</li>
<li>JSON arrays with implicit types, ie. regular <code>[1,2,3,4]</code>
values in JSON</li>
<li>JSON arrays with explicit types, ie. <code>int8[1,2,3,4]</code> or
<code>float[1,2,3,4]</code> syntax extensions</li>
</ul>
<p>Fixed arrays are the fastest to access, and (intentionally) the only
vector storage eligible for ANN indexing. <strong>For ANN indexes you
must use arrays.</strong></p>
<p>Their RAM requirements are minimal, with zero overheads. For
instance, a fixed array with 32 floats in Sphinx speak (also known as
32D f32 vector in ML speak) consumes exactly 128 bytes per
<em>every</em> row.</p>
<div class="sourceCode" id="cb295"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_float_array</span> = test1[32] <span class="co"># 32D f32 vector, 128 bytes/row</span></span></code></pre></div>
<p>However, fixed arrays are not great when not all of your documents
have actual data (and arrays without any explicit data will be filled
with zeroes).</p>
<p>JSON arrays are slower to access, and consume a bit more memory per
row, but that memory is only consumed per <em>used</em> row. Meaning
that when your vectors are defined sparsely (for, say, just 1M documents
out of the entire 10M collection), then it might make sense to use JSON
anyway to save some RAM.</p>
<p>JSON arrays are also “mixed” by default, that is, can contain values
with arbitrary different types. With vector searches however you would
normally want to use optimized arrays, with a single type attached to
<em>all</em> values. Sphinx can auto-detect integer arrays in JSON, with
values that fit into either int32 or int64 range, and store and later
process them efficiently. However, to enforce either int8 or float type
on a JSON array, you have to <em>explicitly</em> use our JSON syntax
extensions.</p>
<p>To store an array of <code>float</code> values in JSON, you have
to:</p>
<ul>
<li>either specify <code>float</code> type in each value with
<code>1.234f</code> syntax (because by default <code>1.234</code> gets a
<code>double</code> type in JSON), eg:
<code>[1.0f, 2.0f, 3.0f]</code></li>
<li>or specify array type with <code>float[...]</code> syntax, eg:
<code>float[1,2,3]</code></li>
</ul>
<p>To store an array of <code>int8</code> values (ie. from -128 to 127
inclusive) in JSON, the only option is to:</p>
<ul>
<li>specify array type with <code>int8[...]</code> syntax, eg:
<code>int8[1,2,3]</code></li>
</ul>
<p>In both these cases, we require an explicit type to differentiate
between the two possible options (<code>float</code> vs
<code>double</code>, or <code>int8</code> vs <code>int</code> case), and
by default, we choose to use higher precision rather than save
space.</p>
<p><strong>Second, calculations.</strong> The workhorse here is the
<code>DOT()</code> function that computes a dot product between the two
vector arguments. Alternatively you can use <code>L1DIST()</code> and
<code>L2DIST()</code> distance functions.</p>
<p>Here go the mandatory stupid Linear Algebra 101 formulas. (Here also
goes a tiny sliver of hope they do sometimes help people who actually
read docs.)</p>
<pre><code>dot(a, b) = sum(a[i] * b[i])
l1dist(a, b) = sum(abs(a[i] - b[i]))
l2dist(a, b) = sum(pow(a[i] - b[i], 2))</code></pre>
<p>The most frequent usecase is, of course, computing a
<code>DOT()</code> between some per-document array (stored either as an
attribute or in JSON) and a constant. The latter should be specified
with <code>FVEC()</code>:</p>
<div class="sourceCode" id="cb297"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, DOT(vec1, FVEC(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>)) <span class="kw">FROM</span> mydocuments</span>
<span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, DOT(json.vec2, FVEC(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>)) <span class="kw">FROM</span> mydocuments</span></code></pre></div>
<p>Note that <code>DOT()</code> internally optimizes its execution
depending on the actual argument types (ie. float vectors, or integer
vectors, etc). That is why the two following queries perform very
differently:</p>
<div class="sourceCode" id="cb298"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, DOT(vec1, FVEC(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="op">..</span>.)) d</span>
<span id="cb298-2"><a href="#cb298-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> mydocuments <span class="kw">ORDER</span> <span class="kw">BY</span> d <span class="kw">DESC</span> <span class="kw">LIMIT</span> <span class="dv">3</span>;</span>
<span id="cb298-3"><a href="#cb298-3" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb298-4"><a href="#cb298-4" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.047</span> sec)</span>
<span id="cb298-5"><a href="#cb298-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb298-6"><a href="#cb298-6" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, DOT(vec1, FVEC(<span class="fl">1.0</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="op">..</span>.)) d</span>
<span id="cb298-7"><a href="#cb298-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> mydocuments <span class="kw">ORDER</span> <span class="kw">BY</span> d <span class="kw">DESC</span> <span class="kw">LIMIT</span> <span class="dv">3</span>;</span>
<span id="cb298-8"><a href="#cb298-8" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb298-9"><a href="#cb298-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.073</span> sec)</span></code></pre></div>
<p>In this example, <code>vec1</code> is an integer array, and we
<code>DOT()</code> it against either an integer constant vector, or a
float constant vector. Obviously, int-by-int vs int-by-float
multiplications are a bit different, and hence the performance
difference.</p>
<p><strong>That’s it!</strong> There frankly isn’t anything else to
vector searches, at least not in their simplest “honestly bruteforce
everything” form above.</p>
<p>Now, making vector searches fast (and not that bruteforce),
especially at scale, is where all the fun is. Enter vector indexes, aka
ANN indexes.</p>
<h2 id="searching-vector-indexes">Searching: vector indexes</h2>
<blockquote>
<p>NOTE! Starting with v.3.8 we aim to support all vector index types on
all platforms in public builds.</p>
<p>However, <strong>PERFORMANCE MAY VARY</strong> everywhere except
<strong>Linux on x64</strong> which is our target server platform. For
instance, FAISS IVFPQ indexes are going to be (somewhat) slower on
Windows, because we fallback to generic unoptimized code.</p>
<p>Bottom line, <strong>ONLY BENCHMARK VECTOR INDEXES ON X64
LINUX</strong>. Other platforms <strong>must</strong> work fine for
testing, but <strong>may</strong> perform very differently.</p>
</blockquote>
<p>In addition to brute-force vector searches described just above,
Sphinx also supports fast approximate searches with “vector indexes”, or
more formally, <strong>ANN indexes (Approximate Nearest Neighbor
indexes)</strong>. They can accelerate certain types of <strong>top-K
searches</strong> for documents <strong>closest</strong> to some given
constant reference vector. Let’s jumpstart.</p>
<p>The simplest way to check out vector indexes in action is as
follows.</p>
<ol type="1">
<li>Create an attribute index on an array column with your vector.</li>
<li>Have or insert “enough” rows into your FT index.</li>
<li>Run <code>SELECT</code> queries with <code>ORDER BY DOT()</code>,
sorting by vector distance.</li>
</ol>
<p>In addition to <code>DOT()</code> distance function (or “metric”),
you can use <code>L1DIST()</code> and <code>L2DIST()</code> as well.
<strong>Fast ANN searches support all metrics!</strong> However, that
requires a <strong>compatible</strong> vector index. We will discuss
those shortly.</p>
<p>For example, assuming that the we have an FT index called
<code>rt</code> with a 4D float array column <code>vec</code> declared
with <code>attr_float_array = vec[4]</code>, and assuming that we have
enough data in <strong>disk</strong> segments of that index (say, 1M
rows):</p>
<div class="sourceCode" id="cb299"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- slower exact query, scans all rows</span></span>
<span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, DOT(vec, FVEC(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>)) d <span class="kw">FROM</span> rt <span class="kw">ORDER</span> <span class="kw">BY</span> d <span class="kw">DESC</span>;</span>
<span id="cb299-3"><a href="#cb299-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-4"><a href="#cb299-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- create the vector index (may take a while)</span></span>
<span id="cb299-5"><a href="#cb299-5" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_vec <span class="kw">ON</span> rt(vec);</span>
<span id="cb299-6"><a href="#cb299-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-7"><a href="#cb299-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- faster ANN query now</span></span>
<span id="cb299-8"><a href="#cb299-8" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, DOT(vec, FVEC(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>)) d <span class="kw">FROM</span> rt <span class="kw">ORDER</span> <span class="kw">BY</span> d <span class="kw">DESC</span>;</span>
<span id="cb299-9"><a href="#cb299-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-10"><a href="#cb299-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- slower exact query is still possible too</span></span>
<span id="cb299-11"><a href="#cb299-11" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, DOT(vec, FVEC(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>)) d <span class="kw">FROM</span> rt IGNORE <span class="kw">INDEX</span>(idx_vec) <span class="kw">ORDER</span> <span class="kw">BY</span> d <span class="kw">DESC</span>;</span></code></pre></div>
<p>In this example we used a <strong>default</strong> vector index
subtype. At the moment, that default type is <code>FAISS_DOT</code> and
it speeds up <strong>top-K max DOT() searches</strong>, or in other
words, <code>FAISS_DOT</code> speeds up <code>ORDER BY DOT() DESC</code>
clauses.</p>
<p>Only, Sphinx supports more vector index types than one!</p>
<h3 id="ann-index-types">ANN index types</h3>
<p>The supported vector index (aka ANN index) types are as follows.</p>
<table>
<colgroup>
<col style="width: 14%" />
<col style="width: 10%" />
<col style="width: 43%" />
<col style="width: 10%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="header">
<th>Type name</th>
<th>Binary</th>
<th>Indexing method details</th>
<th>Metric</th>
<th>Component</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>FAISS_DOT</td>
<td>FAISS</td>
<td>FAISS IVF-PQ-x4fs</td>
<td>IP</td>
<td>any!</td>
</tr>
<tr class="even">
<td>FAISS_L1</td>
<td>FAISS</td>
<td>FAISS HNSW</td>
<td>L1</td>
<td>any!</td>
</tr>
<tr class="odd">
<td>HNSW_DOT</td>
<td>any!</td>
<td>Sphinx HNSW</td>
<td>IP</td>
<td><code>FLOAT</code>, <code>INT8</code></td>
</tr>
<tr class="even">
<td>HNSW_L1</td>
<td>any!</td>
<td>Sphinx HNSW</td>
<td>L1</td>
<td><code>FLOAT</code>, <code>INT8</code></td>
</tr>
<tr class="odd">
<td>HNSW_L2</td>
<td>any!</td>
<td>Sphinx HNSW</td>
<td>L2</td>
<td><code>FLOAT</code>, <code>INT8</code></td>
</tr>
<tr class="even">
<td>SQ4</td>
<td>any!</td>
<td>Sphinx 4-bit scalar quantization</td>
<td>any!</td>
<td><code>FLOAT</code></td>
</tr>
<tr class="odd">
<td>SQ8</td>
<td>any!</td>
<td>Sphinx 8-bit scalar quantization</td>
<td>any!</td>
<td><code>FLOAT</code></td>
</tr>
</tbody>
</table>
<p><strong>Type name</strong> lets you choose a specific indexing method
using a <code>USING</code> clause (sorry, could not resist) of the
<code>CREATE INDEX</code> statement, as follows.</p>
<div class="sourceCode" id="cb300"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> <span class="kw">ON</span> rt(vec) <span class="kw">USING</span> SQ8</span></code></pre></div>
<p>Historically we default to <code>FAISS_DOT</code> type (simply the
first one implemented), but that absolutely does <strong>not</strong>
mean that <code>FAISS_DOT</code> is always best! Different workloads
<strong>will</strong> work best with different ANN index types, so you
want to test carefully, and we do suggest an explicit <code>USING</code>
clause.</p>
<p><strong>Binary</strong> means the Sphinx binaries type. Normally this
mustn’t be an issue, but <code>FAISS_xxx</code> indexes naturally
require builds with FAISS, which on <strong>some</strong> platforms are
just too finicky for us to properly support. (Out primary target
platform is Linux x64.) Also, we may sometimes skip FAISS support in
certain internal builds. To check for that, run
<code>indexer version</code> and look for <code>faiss</code> in the
“Compiled features” string in the output. To reiterate, should not
normally be an issue.</p>
<p><strong>Component</strong> is the supported vector component type.
Generally Sphinx can store vectors with <code>FLOAT</code>,
<code>INT8</code>, and <code>INT</code> components (aka f32, i8, and
i32). But specific ANN index types might be more restrictive. For
instance, <code>SQ8</code> indexes with <code>INT8</code> components
make no sense.</p>
<h3 id="faiss_dot-indexes">FAISS_DOT indexes</h3>
<p><code>FAISS_DOT</code> type maps to FAISS IVF index with 3000
clusters, PQ quantization (to half of the input dimensions), “fast scan”
optimization (if possible), and inner product metric. So it speeds up
<code>ORDER BY DOT(..) DESC</code> queries.</p>
<p>You can override the number of clusters by using the
<code>ivf_clusters</code> directive in the <code>OPTION</code> clause.
Increasing the number of clusters <strong>will</strong> increase the
index build time, but it <strong>may</strong> also improve search
quality.</p>
<p>Building the clusters is a slow process, but clusters can be cached
and reused. See the <a
href="#indexing-pretraining-faiss_dot-indexes">pretraining</a>
section.</p>
<p><code>FAISS_DOT</code> supports all input component types. They get
converted to f32, because that’s how FAISS takes them.</p>
<h3 id="faiss_l1-indexes">FAISS_L1 indexes</h3>
<p><code>FAISS_L1</code> type maps to FAISS HNSW index with M=64 and L1
metric. So it speeds up <code>ORDER BY L1DIST(..) ASC</code>
queries.</p>
<p><code>FAISS_L1</code> supports all input component types. They get
converted to f32, because that’s how FAISS takes them.</p>
<h3 id="hnsw-indexes">HNSW indexes</h3>
<p><code>HNSW_L1</code>, <code>HNSW_L2</code>, and <code>HNSW_DOT</code>
types map to Sphinx HNSW index built with the respective metric, and
used to speed up the respective <code>ORDER BY &lt;metric&gt;</code>
queries.</p>
<p>Sphinx HNSW currently supports <code>FLOAT</code> and
<code>INT8</code> vectors (stored in array attributes).</p>
<p>Our HNSW index parameters are as follows.</p>
<table style="width:100%;">
<colgroup>
<col style="width: 20%" />
<col style="width: 21%" />
<col style="width: 10%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr class="header">
<th>Option</th>
<th>Paper name</th>
<th>Default</th>
<th>Quick Summary</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>hnsw_conn</code></td>
<td><code>M_max</code></td>
<td>16</td>
<td>Non-base level graph connectivity</td>
</tr>
<tr class="even">
<td><code>hnsw_connbase</code></td>
<td><code>M_max0</code></td>
<td>32</td>
<td>Base-level graph connectivity</td>
</tr>
<tr class="odd">
<td><code>hnsw_expbuild</code></td>
<td><code>efConstruction</code></td>
<td>128</td>
<td>Expansion (top-N) level at build time</td>
</tr>
<tr class="even">
<td><code>hnsw_exp</code></td>
<td><code>ef</code></td>
<td>64</td>
<td>Minimum expansion (top-N) for searches</td>
</tr>
</tbody>
</table>
<p>“Paper name” means the parameter name as in the original HNSW paper
(“Efficient and robust approximate nearest neighbor search using
Hierarchical Navigable Small World graphs”), available at <a
href="https://arxiv.org/abs/1603.09320v4">arXiv</a>.</p>
<p>You can override the defaults using an <code>OPTION</code> clause.
This is supported by both the <code>CREATE INDEX</code> statement in
SphinxQL and the <code>create_index</code> config directive. For
example!</p>
<div class="sourceCode" id="cb301"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> vectest1</span>
<span id="cb301-2"><a href="#cb301-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb301-3"><a href="#cb301-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb301-4"><a href="#cb301-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">create_index</span> = idx_emb on emb using hnsw_l2 <span class="dt">\</span></span>
<span id="cb301-5"><a href="#cb301-5" aria-hidden="true" tabindex="-1"></a>        option hnsw_conn=32, hnsw_connbase=64</span>
<span id="cb301-6"><a href="#cb301-6" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>Current Sphinx-specific subtleties are as follows.</p>
<p><code>hnsw_connbase</code> must never be less than
<code>hnsw_conn</code>, and Sphinx silently auto-adjusts for that.
<code>CREATE INDEX ... OPTION hnsw_conn=20, hnsw_connbase=10</code> will
actually set both parameters to 20, and subsequent
<code>SHOW INDEX FROM</code> should show that.</p>
<p><code>hnsw_exp</code> silently imposes an (internal) minimum on
<code>ann_top</code> when searching. For example, with the default
<code>hnsw_exp=64</code> setting <code>OPTION ann_top=10</code> should
<strong>not</strong> have any significant effect on performance. Because
the internal fanout during HNSW graph search will be 64 anyway.</p>
<p><code>vecindex_threads</code> can usually be set higher with HNSW
indexes than with FAISS IVFPQ indexes. Basically, HNSW seems to scale to
more cores better.</p>
<p>On Intel CPUs with AVX-512 support, HNSW indexes automatically switch
to AVX-512 optimized codepath. But on certain older CPU models that can
<em>hurt</em> performance, because of throttling. <a
href="#use_avx512-directive"><code>use_avx512</code></a> config
directive can forcibly disable AVX-512 optimizations, if that’s the
case.</p>
<h3 id="sq-indexes">SQ indexes</h3>
<p><code>SQ4</code> and <code>SQ8</code> index types quantize input
vector to 4-bit and 8-bit integers, respectively. SQ stands for Scalar
Quantization. SQ indexes are metric independent, and can speed up both
<code>DOT()</code> and <code>L1DIST()</code> queries.</p>
<p>SQ indexes only support <code>FLOAT</code> vectors, because
quantizing <code>INT8</code> vectors makes less than zero sense. (We
could quantize <code>INT</code> vectors, but nobody uses those.)</p>
<p>SQ indexes currently <em>only</em> do super-dumb uniform
quantization, and absolutely nothing else. So “searches” really are
scans. The horror!</p>
<p>Except, they do speed up searches 2-3x+ anyway, because SQ scans
process 4-8x less data (8x less with SQ4, and 4x less with SQ8). Also,
they are <em>extremely</em> fast to build, up to 1-2 GB/sec fast. That
makes them an occasionally useful tradeoff.</p>
<h3 id="common-ann-indexing-tips">Common ANN indexing tips</h3>
<p>We intentionally do not (yet!) have many tweaking knobs here.
However, gotta elaborate on that recurring “have enough rows” theme.</p>
<p><strong>Vector indexes only currently get built for disk segments,
not RAM.</strong> Because proper vector indexes are not fast to build,
and RAM segments change frequently. Honestly updating
<code>FAISS_DOT</code> indexes in RAM slowed down writes significantly,
even with that minimum segment size threshold.</p>
<p>However, as more vector index types are supported now, we are going
to research this again, and make changes. For one, SQ indexes are doable
in RAM. For two, hybrid “FAISS on disk, SQ in RAM” approach seems
interesting.</p>
<p><strong>Vector index construction has a thread limit, and you can
configure that.</strong> The setting name is
<code>vecindex_threads</code>, and it imposes a server-wide limit on the
number of threads that a single vector index construction operation
(whoa, fancy words for <code>CREATE INDEX</code>) is allowed to use.
Specifically, <code>FAISS_DOT</code> and <code>HNSW_xxx</code> indexes
support multi-threaded building, and <code>SQ</code> indexes do not
(they are fast enough to stay single-threaded).</p>
<p>On most systems, this limit defaults to 20. In Apple (so macOS)
builds, however, this limit defaults to 1, because compiler/OpenMP
bugs.</p>
<p>You can change this limit either in the config file (and then that
affects <code>indexer</code> too), or on the fly using the
<code>SET GLOBAL vecindex_threads=N</code> syntax.</p>
<p><strong>Active implicit vector index builds are limited to 1 by
default.</strong> That limit can be lifted using the
<code>vecindex_builds</code> setting.</p>
<p>What are these “implicit” builds? Basically, any builds that
<code>searchd</code> performs, <strong>except</strong> ones caused by an
explicit <code>CREATE INDEX</code> query. Any writes
<strong>can</strong> very well trigger creating a new disk segment. And
that, by definition, includes building all the kinds of indexes,
including vector ones. And that’s generally alright! Absolutely normal
operation.</p>
<p>Only, when <strong>multiple</strong> implicit builds are triggered in
parallel (by literally anything from a tiny <code>INSERT</code> to an
expectedly heavy <code>OPTIMIZE</code>), they can very easily exhaust
all the CPUs. Guess what happens when, say, 8 index shards start
simultaneously creating 8 vector indexes and <em>very</em> actively
using 32 threads <em>each</em> on a box with 64 vCPUs. Guess how we know
that…</p>
<p><code>vecindex_builds</code> avoids that purely hypothetical
scenario. Implicit builds now get jointly capped at
<code>vecindex_builds * vecindex_threads</code> active threads, tops.
Great success!</p>
<p><strong><code>FAISS_DOT</code> indexes only engage on a large
collection; and intentionally so.</strong> For that particular index
type, both maintenance <em>and</em> queries come with their overheads,
and we found that for not-so-large segments (under 170K documents) it
was quicker on average to honestly compute <code>DOT()</code>,
especially with our SIMD-optimized implementations.</p>
<p><strong>Other vector indexes always engage.</strong> Other vector
index types that we now also have, such as SQ or HNSW, have very
different performance profiles. So for them,
<code>vecindex_thresh</code> does not apply. You can build an
<code>HNSW_xxx</code> index even on a tiny 100-row disk segment.
(However, beware that the optimizer can still choose to ignore that
index, and switch to full scan.)</p>
<p><strong>There’s a tweakable size threshold that you might not really
wanna tweak.</strong> The setting is <a
href="#vecindex_thresh-directive"><code>vecindex_thresh</code></a>; it
only affects <code>FAISS_DOT</code> at the moment; it is server-wide,
and its current default value is 170000 (170K documents), derived from
our tests on various mixed workloads (so hopefully “generic
enough”).</p>
<p>Of course, as your workloads might differ, your own optimal threshold
might differ. However, if you decide to go that route and optimize tweak
that, beware that our defaults <em>may</em> change in future releases.
Simply to optimize better for any future internal changes. You would
have to retest then. You also wouldn’t want to ignore the
changelogs.</p>
<p><strong>Pretraining can greatly improve <code>FAISS_DOT</code> index
construction.</strong> Basically, you can run
<code>indexer pretrain</code> once against a “smaller” training dataset
once; then reuse “training” results for building “larger” production
indexes via the <a
href="#pretrained_index-directive"><code>pretrained_index</code></a>
directive; and save CPU time. More details in the respective <a
href="#indexing-pretraining-faiss_dot-indexes">“Pretraining FAISS_DOT
indexes”</a> section.</p>
<h3 id="common-ann-searching-tips">Common ANN searching tips</h3>
<p>These generally apply to <em>all</em> vector index subtypes. (Unless
explicitly stated otherwise.)</p>
<p><strong>Vector indexes only engage for top-K distance
queries.</strong> Or in other words, the “nearest neighbors” queries.
That’s the only type of query (a significant one though!) they can help
with.</p>
<p><strong>Vector indexes may and <em>will</em> produce approximate
results!</strong> Naturally again, they are approximate, meaning that
for the sake of the speed they may and <em>will</em> lose one of the
very best matches in your top-K set.</p>
<p><strong>Vector indexes do not universally help; and you should rely
on the planner.</strong> Assume that a very selective <code>WHERE</code>
condition only matches a few rows; say, literally 10 rows. Directly
computing just 10 dot products and ordering by those is (much) cheaper
than even <em>initializing</em> a vector query. Query planer takes that
into account, and tries to pick the better execution path, either with
or without the vector indexes.</p>
<p><strong>You can force the vector indexes on and off using the
FORCE/IGNORE syntax.</strong> Just as with the regular ones. This is
useful either when planner fails, or just for performance testing.</p>
<p><strong>Vector queries only utilize a single core per local
index.</strong> Intentionally. While using many available CPU cores for
a single search is viable, and does improve one-off latencies, that only
works well with exactly 1 client. And with <em>multiple</em> concurrent
clients and mixed workloads (that mix vector and regular queries) we
find that to be a complete and utter operational nightmare, as in,
overbooking cores by a factor of 10 one second, then underusing then by
a factor of 10 the very next second. Hence, no. Just no.</p>
<p><strong>Vectors stored in JSON are intentionally not
supported.</strong> That’s both slower and harder to properly maintain
(again on the ops side, not really Sphinx side). Basically, because the
data in JSON is just not typed strongly enough. Vector indexes always
have a fixed number of dimensions anyway, and arrays guarantee that
easily, while storing that kind of data in JSON is quite error prone
(and slower to access too).</p>
<h3 id="fine-tuning-ann-searches">Fine-tuning ANN searches</h3>
<p><strong>TLDR version:</strong> Sphinx currently fetches <strong>at
least 2000 approximate matches</strong> from any ANN index. With
non-HNSW indexes, it also “refines” them, by computing exact distances.
All that for better recall. Because <strong>we prioritize
recall</strong>.</p>
<p>To prioritize <strong>performance</strong> instead,
<code>OPTION ann_top=&lt;N&gt;</code> clause can tweak that default
fetch depth, and speed up searches (but maybe losing in recall).</p>
<p>(Also, the refinement step can be disabled for performance, but it
normally shouldn’t be.)</p>
<p><strong>Long version:</strong> our most frequent use case is
<em>not</em> really an ANN-only search! By default we optimize for
<em>combined</em> searches with both <code>WHERE</code> conditions and
ANN-eligible <code>ORDER BY</code> clause. We also require high recall,
0.99 and more. That’s why Sphinx currently defaults to fetch
<code>max(2000, 7*estimated_rows)</code> from ANN indexes: so that even
after <code>WHERE</code> filters, and even if estimates were way off, we
would still have enough results.</p>
<p>However, that’s suboptimal for ANN-only queries with no
<code>WHERE</code> conditions and low <code>LIMIT</code> values.
Fetching and reranking top 2000 rows is overkill for a query that only
asked for top 10 rows.</p>
<p><code>OPTION ann_top=&lt;N&gt;</code> overrides that and makes Sphinx
fetch and rerank less rows, helping such queries.</p>
<div class="sourceCode" id="cb302"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, DOT(myvec, FVEC(<span class="op">..</span>.)) dist <span class="kw">FROM</span> myindex</span>
<span id="cb302-2"><a href="#cb302-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> dist <span class="kw">DESC</span> <span class="kw">LIMIT</span> <span class="dv">10</span> <span class="kw">OPTION</span> ann_top<span class="op">=</span><span class="dv">100</span></span></code></pre></div>
<p>Also, <strong>all ANN index types except HNSW internally use
<em>approximate</em> vectors,</strong> for performance reasons.
<strong>Not</strong> the original, exact ones as stored by Sphinx.</p>
<p>So with non-HNSW indexes, Sphinx does a so-called <strong>refine
step</strong> after the ANN search. It computes the
<strong>exact</strong> distances (using the original vectors), and sorts
the final results based on those. That uses a little more CPU but
improves recall.</p>
<p>However, the approximation impact on recall just might be negligible,
anyway. <code>OPTION ann_refine=0</code> can then squeeze a little extra
performance by skipping the refine step.</p>
<blockquote>
<p>WARNING! However, beware that distances <strong>might
mismatch</strong> across RT index segments, severely affecting
recall.</p>
</blockquote>
<p>For instance, there are currently <strong>no IVFPQ indexes on RAM
segments</strong>. So disk segments may return very different
PQ-transformed distances, while RAM segments perform full scans, and
return the original exact distances. Without the refine step, we would
end up mixing mismatching, not-even-comparable distances from two
different vector spaces, and (greatly) lose in recall.</p>
<p>However, <code>OPTION ann_refine=0</code> can be useful even with
IVFPQ indexes, anyway! Because, for one, the above is not an issue with
static “plain” indexes.</p>
<p>And with HNSW indexes, the refine step is skipped by default. Because
they do not use approximations. They directly access the exact original
vectors, and so the distances are also exact. However, an explicit
<code>OPTION ann_refine=1</code> still forces Sphinx to recompute
distances, even in HNSW case, as user’s wish is our command.</p>
<h2 id="searching-query-cache">Searching: query cache</h2>
<p>Query cache stores a compressed <strong>filtered full-text
search</strong> result set in memory, and then reuses it for subsequent
queries if possible. The idea here is that “refining” queries could
reuse cached results instead of re-running heavy matching and/or
filtering all over again. For instance.</p>
<div class="sourceCode" id="cb303"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb303-1"><a href="#cb303-1" aria-hidden="true" tabindex="-1"></a># <span class="fu">first</span> run, heavy because <span class="kw">of</span> matching vs stopwords</span>
<span id="cb303-2"><a href="#cb303-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, WEIGHT() <span class="kw">FROM</span> docs <span class="kw">WHERE</span> MATCH(<span class="st">&#39;the who&#39;</span>);</span>
<span id="cb303-3"><a href="#cb303-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-4"><a href="#cb303-4" aria-hidden="true" tabindex="-1"></a># <span class="dt">second</span> run, should <span class="kw">execute</span> comparatively quickly <span class="kw">from</span> <span class="kw">cache</span>!</span>
<span id="cb303-5"><a href="#cb303-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, user_id <span class="kw">FROM</span> docs <span class="kw">WHERE</span> MATCH(<span class="st">&#39;the who&#39;</span>) <span class="kw">AND</span> user_id<span class="op">=</span><span class="dv">1234</span>;</span></code></pre></div>
<p>The relevant config directives are:</p>
<ul>
<li><a
href="#qcache_max_bytes-directive"><code>qcache_max_bytes</code></a>,
RAM use limit (defaults to 0, meaning “disable caching”);</li>
<li><a
href="#qcache_thresh_msec-directive"><code>qcache_thresh_msec</code></a>,
min query wall time, defaults to 3000, meaning 3 sec or more;</li>
<li><a href="#qcache_ttl_sec-directive"><code>qcache_ttl_sec</code></a>,
cached entry TTL, defaults to 60 sec.</li>
</ul>
<p><code>qcache_max_bytes</code> puts a limit on cached queries RAM use,
shared over <strong>all</strong> the queries. This defaults to 0, which
disables the query cache, so you <strong>must</strong> explicitly set
this to a non-trivial size (at least a few megabytes) in order to enable
the query cache.</p>
<p><code>qcache_thresh_msec</code> is the minimum wall query time to
cache. Queries faster than this will <em>not</em> be cached. We
naturally want to cache slow queries only, and this setting controls
“how slow” they should be. It defaults to 3000 msec, so 3 seconds (maybe
too conservatively).</p>
<p>Zero <code>qcache_thresh_msec</code> threshold means “cache
everything”, so use that value with care. To enable or disable the
cache, use the <code>qcache_max_bytes</code> limit.</p>
<p><code>qcache_ttl_sec</code> is cached entry TTL, ie. time to live.
Slow queries (that took more than <code>qcache_thresh_msec</code> to
execute) stay cached for this long. This one defaults to 60 seconds, so
1 minute.</p>
<p><strong>All these settings can be changed on the fly</strong> via
<code>SET GLOBAL</code> statement:</p>
<div class="sourceCode" id="cb304"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> qcache_max_bytes<span class="op">=</span><span class="dv">128000000</span>;</span></code></pre></div>
<p>Such changes are applied <strong>immediately</strong>. For one,
cached result sets that no longer satisfy the constraints (either on TTL
or size) must <strong>immediately</strong> get discarded. So yes,
<code>SET GLOBAL</code> works for reducing the cache size too, not only
increasing it. When reducing the cache size on the fly, MRU (most
recently used) result sets win.</p>
<p><strong>Internally, query cache works as follows.</strong> Every
“slow” search result gets stored in memory. That happens after full-text
matching, filtering, and ranking. So we store <code>total_found</code>
pairs of <code>{docid, weight}</code> values. In their raw form those
would take 12 bytes per entry (8 for <code>docid</code> and 4 for
<code>weight</code>). However, we do compress them, and
<strong>compressed</strong> matches can take as low as 2 bytes per
entry. (This mostly depends on the deltas between the subsequent
docids.) Once the query completes, we check the wall time and size
thresholds, and either save that compressed result set for future reuse,
or discard it (either if the query was fast enough, or if the result set
is too big and does not fit).</p>
<p>Thus, note how the <strong>query cache impact on RAM is not
<em>completely</em> limited</strong> by <code>qcache_max_bytes</code>,
and how <strong>query cache incurs CPU impact too</strong>. Because with
query cache enabled, <strong>every</strong> single query must save its
full <strong>intermediate</strong> result set for
<strong>possible</strong> future reuse! Even if that set gets discarded
later (because our query ends up being fast enough), it still needs to
be stored, and that takes extra RAM and CPU. Nowadays that’s usually
negligible, as even with 100 concurrent queries in flight and 1 million
average matches per <em>each</em> query we are looking at just 1-2 gigs
of RAM (1.2 GB of raw data, minus compression, plus allocation
overheads), but still worth a mention.</p>
<p>Anyway, query cache lets slow queries get cached, and subsequent
queries can then (quickly) use that cache instead of (slowly) computing
something all over again, but of course there are natural conditions.
Namely!</p>
<ul>
<li><code>MATCH()</code> must be a bytewise match.</li>
<li>Ranker must be a bytewise match.</li>
<li>Filters must be compatible (ie. a superset of the original
filters).</li>
</ul>
<p><strong>The full-text query (ie. <code>MATCH()</code> argument) must
be a bytewise match.</strong> Because query cache works on the text, not
AST. So even a single extra space makes a query a new and different one,
as long as query cache is concerned.</p>
<p><strong>The ranker (and its parameters) must also be a bytewise
match.</strong> Because caching <code>WEIGHT()</code> is easy and
caching all the postings is much harder. Usually this isn’t an issue at
all but, again, just a single extra space in your ranking formula passed
to <code>OPTION ranker=expr(...)</code> and you have a new and different
query and result set. Joey does not share food. Query cache does
<strong>not</strong> rerank.</p>
<p>Finally, <strong>the filters must be compatible</strong>, ie. a
superset of the filters that were used in the query that got cached. So
basically, you can add extra filters, and still expect to hit the cache.
(In this case, the extra filters will just be applied to the cached
result.) But if you <em>remove</em> one, that means a new and different
query.</p>
<p>Another important thing is that the “widest” query (without any
<code>WHERE</code> filters) is <strong>not</strong> necessarily the
slowest one! Consider the following example.</p>
<div class="sourceCode" id="cb305"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a># Q1. what <span class="cf">if</span><span class="op">..</span> caching does <span class="kw">not</span> yet happen here, because <span class="kw">fast</span> enough?</span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> test <span class="kw">WHERE</span> MATCH(<span class="st">&#39;the what&#39;</span>);</span>
<span id="cb305-3"><a href="#cb305-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb305-4"><a href="#cb305-4" aria-hidden="true" tabindex="-1"></a># Q2. but <span class="cf">then</span><span class="op">..</span> caching happens here, <span class="kw">as</span> JSON <span class="kw">filter</span> slows us down?</span>
<span id="cb305-5"><a href="#cb305-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> test <span class="kw">WHERE</span> MATCH(<span class="st">&#39;the what&#39;</span>) <span class="kw">AND</span> json.foo.bar<span class="op">=</span><span class="dv">123</span>;</span>
<span id="cb305-6"><a href="#cb305-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb305-7"><a href="#cb305-7" aria-hidden="true" tabindex="-1"></a># Q3. <span class="kw">and</span> thus <span class="op">*</span><span class="kw">no</span><span class="op">*</span> <span class="kw">cache</span> <span class="kw">reuse</span> happens here!</span>
<span id="cb305-8"><a href="#cb305-8" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> test <span class="kw">WHERE</span> MATCH(<span class="st">&#39;the what&#39;</span>) <span class="kw">AND</span> price<span class="op">=</span><span class="dv">234</span>;</span></code></pre></div>
<p>This behavior might be unexpected at first glance, but in fact
everything works perfectly by design. Indeed, despite frequent keywords,
the first query <strong>can</strong> be fast enough, and not hit the
<code>qcache_thresh_msec</code> threshold. Then the extra JSON filtering
work in the second query pushes it over the edge, and it ends up cached.
But <strong>the filters are not compatible</strong> between the 3rd and
2nd queries; Q3 filers are not a superset of Q2 ones; Q3 <strong>could
not</strong> reuse Q2’s cached results in our example. (It could use
Q1’s results. But that query was too fast to get cached.) So, no cache
hits so far.</p>
<p>However, this final 4th query <strong>must</strong> hit the query
cache in both cases. Because its filters (and <code>MATCH</code> clause)
are compatible with both the 1st and 2nd queries.</p>
<div class="sourceCode" id="cb306"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a># Q4. finally, a (<span class="kw">cache</span>) hit</span>
<span id="cb306-2"><a href="#cb306-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> test <span class="kw">WHERE</span> MATCH(<span class="st">&#39;the what&#39;</span>) <span class="kw">AND</span> json.foo.bar<span class="op">=</span><span class="dv">123</span> <span class="kw">AND</span> price<span class="op">=</span><span class="dv">234</span>;</span></code></pre></div>
<p>Moving on!</p>
<p><strong>Cache entries expire with TTL</strong>, quite naturally. The
default time to live is set at 1 minute. Adjust at will.</p>
<p><strong>Cache entries are invalidated on <code>TRUNCATE</code>, on
<code>ATTACH</code>, and on rotation.</strong> This is only natural. New
index data, new life, new cache. Makes sense.</p>
<p><strong>Cache entries are <em>NOT</em> invalidated on other
writes!</strong> That is, mere <code>INSERT</code> or
<code>UPDATE</code> queries do <em>not</em> invalidate everything we
have cached. So a cached query <strong>might</strong> be returning older
results, for the duration of its TTL. Natural again, but worth an
explicit mention.</p>
<p>Finally, <strong>cache status can be inspected with
<code>SHOW STATUS</code> statement.</strong> Look for all the
<code>qcache_xxx</code> counters.</p>
<div class="sourceCode" id="cb307"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW STATUS <span class="kw">LIKE</span> <span class="st">&#39;qcache%&#39;</span>;</span>
<span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------------+----------+</span></span>
<span id="cb307-3"><a href="#cb307-3" aria-hidden="true" tabindex="-1"></a>| Counter               | <span class="fu">Value</span>    |</span>
<span id="cb307-4"><a href="#cb307-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------------+----------+</span></span>
<span id="cb307-5"><a href="#cb307-5" aria-hidden="true" tabindex="-1"></a>| qcache_max_bytes      | <span class="dv">16777216</span> |</span>
<span id="cb307-6"><a href="#cb307-6" aria-hidden="true" tabindex="-1"></a>| qcache_thresh_msec    | <span class="dv">3000</span>     |</span>
<span id="cb307-7"><a href="#cb307-7" aria-hidden="true" tabindex="-1"></a>| qcache_ttl_sec        | <span class="dv">60</span>       |</span>
<span id="cb307-8"><a href="#cb307-8" aria-hidden="true" tabindex="-1"></a>| qcache_cached_queries | <span class="dv">0</span>        |</span>
<span id="cb307-9"><a href="#cb307-9" aria-hidden="true" tabindex="-1"></a>| qcache_used_bytes     | <span class="dv">0</span>        |</span>
<span id="cb307-10"><a href="#cb307-10" aria-hidden="true" tabindex="-1"></a>| qcache_hits           | <span class="dv">0</span>        |</span>
<span id="cb307-11"><a href="#cb307-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------------+----------+</span></span>
<span id="cb307-12"><a href="#cb307-12" aria-hidden="true" tabindex="-1"></a><span class="dv">6</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h2 id="searching-memory-budgets">Searching: memory budgets</h2>
<p>Result sets in Sphinx never are arbitrarily big. There always is a
<code>LIMIT</code> clause, either an explicit or an implicit one.</p>
<p>Result set sorting and grouping therefore never consumes an
arbitrarily large amount of RAM. Or in other words, sorters always run
on a memory budget.</p>
<p>Previously, the actual “byte value” for that budget depended on few
things, including the pretty quirky <code>max_matches</code> setting. It
was rather complicated to figure out that “byte value” too.</p>
<p>Starting with v.3.5, <strong>we are now counting that budget merely
in bytes</strong>, and <strong>the default budget is 50 MB per each
sorter</strong>. (Which is <em>much</em> higher than the previous
default value of just 1000 matches per sorter.) You can override this
budget on a per query basis using the <code>sort_mem</code> query
option, too.</p>
<div class="sourceCode" id="cb308"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> gid, <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">FROM</span> test <span class="kw">GROUP</span> <span class="kw">BY</span> gid <span class="kw">OPTION</span> sort_mem<span class="op">=</span><span class="dv">100000000</span></span></code></pre></div>
<p>Size suffixes (<code>k</code>, <code>m</code>, and <code>g</code>,
case-insensitive) are supported. The maximum value is <code>2G</code>,
ie. 2 GB per sorter.</p>
<div class="sourceCode" id="cb309"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test <span class="kw">OPTION</span> sort_mem<span class="op">=</span><span class="dv">1024</span>; <span class="co">/* this is bytes */</span></span>
<span id="cb309-2"><a href="#cb309-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test <span class="kw">OPTION</span> sort_mem<span class="op">=</span>128k;</span>
<span id="cb309-3"><a href="#cb309-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test <span class="kw">OPTION</span> sort_mem<span class="op">=</span>256M;</span></code></pre></div>
<p>“Per sorter” budget applies to each facet. For example, the default
budget means either 50 MB per query for queries without facets, or 50 MB
per each facet for queries <em>with</em> facets, eg. up to 200 MB for a
query with 4 facets (as in, 1 main leading query, and 3
<code>FACET</code> clauses).</p>
<p><strong>Hitting that budget WILL affect your search
results!</strong></p>
<p>There are two different cases here, namely, queries with and without
<code>GROUP BY</code> (or <code>FACET</code>) clauses.</p>
<p><strong>Case 1, simple queries without any GROUP BY.</strong> For
non-grouping queries you can only manage to hit the budget by setting
the <code>LIMIT</code> high enough.</p>
<div class="sourceCode" id="cb310"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* requesting 1 billion matches here.. probably too much eh */</span></span>
<span id="cb310-2"><a href="#cb310-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> myindex <span class="kw">LIMIT</span> <span class="dv">1000000000</span></span></code></pre></div>
<p>In this example <code>SELECT</code> simply warns about exceeding the
memory budget, and returns fewer matches than requested. Even if the
index has enough. Sorry, not enough memory to hold and sort <em>all</em>
those matches. The returned matches are still in the proper order,
everything but the <code>LIMIT</code> must also be fine, and
<code>LIMIT</code> is effectively auto-adjusted to fit into
<code>sort_mem</code> budget. All very natural.</p>
<p><strong>Case 2, queries with GROUP BY.</strong> For grouping queries,
ie. those with either <code>GROUP BY</code> and/or <code>FACET</code>
clauses (that also perform grouping!) the <code>SELECT</code> behavior
gets a little more counter-intuitive.</p>
<p>Grouping queries must ideally keep <em>all</em> the “interesting”
groups in RAM at all times, whatever the <code>LIMIT</code> value. So
that they could <em>precisely</em> compute the final aggregate values
(counts, averages, etc) in the end.</p>
<p>But if there are extremely many groups, just way too many to keep
within the allowed <code>sort_mem</code> budget, the sorter <em>has</em>
to throw something away, right?! And sometimes that may even happen to
the “best” row or the entire “best” group! Just because at the earlier
point in time when the sorter threw it away it didn’t yet know that it’d
be our best result in the end.</p>
<p>Here’s an actual example with a super-tiny budget that only fits 2
groups, and where the “best”, most frequent group gets completely thrown
out.</p>
<div class="sourceCode" id="cb311"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb311-1"><a href="#cb311-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span>, <span class="fu">count</span>(<span class="op">*</span>) cnt <span class="kw">from</span> rt <span class="kw">group</span> <span class="kw">by</span> x <span class="kw">order</span> <span class="kw">by</span> cnt <span class="kw">desc</span>;</span>
<span id="cb311-2"><a href="#cb311-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----+----+-----+</span></span>
<span id="cb311-3"><a href="#cb311-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span> | x  | cnt |</span>
<span id="cb311-4"><a href="#cb311-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----+----+-----+</span></span>
<span id="cb311-5"><a href="#cb311-5" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">3</span> | <span class="dv">30</span> |   <span class="dv">3</span> |</span>
<span id="cb311-6"><a href="#cb311-6" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">1</span> | <span class="dv">10</span> |   <span class="dv">2</span> |</span>
<span id="cb311-7"><a href="#cb311-7" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">2</span> | <span class="dv">20</span> |   <span class="dv">2</span> |</span>
<span id="cb311-8"><a href="#cb311-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----+----+-----+</span></span>
<span id="cb311-9"><a href="#cb311-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb311-10"><a href="#cb311-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb311-11"><a href="#cb311-11" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span>, <span class="fu">count</span>(<span class="op">*</span>) cnt <span class="kw">from</span> rt <span class="kw">group</span> <span class="kw">by</span> x <span class="kw">order</span> <span class="kw">by</span> cnt <span class="kw">desc</span> <span class="kw">option</span> sort_mem<span class="op">=</span><span class="dv">200</span>;</span>
<span id="cb311-12"><a href="#cb311-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----+----+-----+</span></span>
<span id="cb311-13"><a href="#cb311-13" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span> | x  | cnt |</span>
<span id="cb311-14"><a href="#cb311-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----+----+-----+</span></span>
<span id="cb311-15"><a href="#cb311-15" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">1</span> | <span class="dv">10</span> |   <span class="dv">2</span> |</span>
<span id="cb311-16"><a href="#cb311-16" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">2</span> | <span class="dv">20</span> |   <span class="dv">2</span> |</span>
<span id="cb311-17"><a href="#cb311-17" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----+----+-----+</span></span>
<span id="cb311-18"><a href="#cb311-18" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb311-19"><a href="#cb311-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb311-20"><a href="#cb311-20" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show warnings;</span>
<span id="cb311-21"><a href="#cb311-21" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+-----------------------------------------------------------------------------------+</span></span>
<span id="cb311-22"><a href="#cb311-22" aria-hidden="true" tabindex="-1"></a>| <span class="kw">Level</span>   | Code | Message                                                                           |</span>
<span id="cb311-23"><a href="#cb311-23" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+-----------------------------------------------------------------------------------+</span></span>
<span id="cb311-24"><a href="#cb311-24" aria-hidden="true" tabindex="-1"></a>| warning | <span class="dv">1000</span> | sorter <span class="kw">out</span> <span class="kw">of</span> memory budget; <span class="kw">rows</span> might be missing; aggregates might be imprecise |</span>
<span id="cb311-25"><a href="#cb311-25" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+-----------------------------------------------------------------------------------+</span></span>
<span id="cb311-26"><a href="#cb311-26" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Of course, to alleviate the issue a little there’s a warning that
<code>SELECT</code> ran out of memory, had to throw out some data, and
that the result set <em>may</em> be off. Unfortunately, it’s impossible
to tell how much off it is. There’s no memory to tell that!</p>
<p>Bottom line, if you ever need huge result sets with lots of groups,
you might either need to extend <code>sort_mem</code> respectively to
make your results precise, or have to compromise between query speed and
resulting accuracy. If (and only if!) the <code>sort_mem</code> budget
limit is reached, then the smaller the limit is, the faster the query
will execute, but with lower accuracy.</p>
<p><strong>How many is “too many” in rows (or groups), not
bytes?</strong> What if after all we occasionally need to approximately
map the <code>sort_mem</code> limit from bytes to rows?</p>
<p>For the record, internally Sphinx <em>estimates</em> the sorter
memory usage rather than rigorously tracking every byte. <strong>That
makes <code>sort_mem</code> a soft limit</strong>, and actual RAM usage
might be just a bit off. That also makes it still possible, if a whiff
complicated, to estimate the limits in matches (rows or groups) rather
than bytes.</p>
<p>Sorters must naturally keep all computed expressions for every row.
Note how those include internal counters for grouping itself and
computing aggregates: that is, the grouping key, row counts, etc. In
addition, any sorter needs a few extra overhead bytes per each row for
“bookkeeping”: as of v.3.5, 32 bytes for a sorter without grouping, 44
bytes for a sorter with <code>GROUP BY</code>, and 52 bytes for a
<code>GROUP &lt;N&gt; BY</code> sorter.</p>
<p>For instance,
<code>SELECT id, title, id+1 q, COUNT(*) FROM test GROUP BY id</code>
would use the memory as follows:</p>
<ul>
<li>20 bytes per row for expressions
<ul>
<li>8 bytes for <code>id+1</code></li>
<li>8 bytes for <code>GROUP BY</code> key</li>
<li>4 bytes for <code>COUNT(*)</code></li>
</ul></li>
<li>44 bytes per row for sorter</li>
<li>64 bytes per row total</li>
</ul>
<p>With a default 50 MB limit that gives us 819200 groups. If we have
more groups than that, we either must bump <code>sort_mem</code>, or
accept the risk that the query result won’t be exact.</p>
<p>Last but not least, <strong>sorting memory budget does NOT apply to
result sets!</strong> Assume that the average <code>title</code> length
just above is 100 bytes, each result set group takes a bit over 120
bytes, and with 819200 groups we get a beefy 98.3 MB result set.</p>
<p>And that result set gets returned in full, without any truncation.
Even with the default 50 MB budget. Because the <code>sort_mem</code>
limit only affects sorting and grouping internals, not the final result
sets.</p>
<h2 id="searching-distributed-query-errors">Searching: distributed query
errors</h2>
<p><strong>Distributed query errors are now intentionally strict
starting from v.3.6.</strong> In other words, <strong>queries must now
fail if any single agent (or local) fails.</strong></p>
<p>Previously, the default behavior has very long been was to convert
individual component (agent or local index) errors into warnings. Sphinx
kinda tried hard to return at least partially “salvaged” result set
built from whatever it could get from the non-erroneous components.</p>
<p>These days we find that behavior misleading and hard to operate.
Monitoring, retries, and debugging all become too complicated. We now
consider “partial” errors hard errors by default.</p>
<p><strong>You can still easily enable the old behavior</strong> (to
help migrating from older Sphinx versions) by using
<code>OPTION lax_agent_errors=1</code> in your queries. Note that we
strongly suggest only using that option temporarily, though. Most all
queries must <em>NOT</em> default to the lax mode.</p>
<p>For example, consider a case where we have 2 index shards in our
distributed index, both local. Assume that we have just run a successful
online <code>ALTER</code> on the first shard, adding a new “tag” column,
but not on the second one just yet. This is a valid scenario so far, and
queries in general would work okay. Because the distributed index
components are quite allowed to have differing schemas.</p>
<div class="sourceCode" id="cb312"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> shard1;</span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----+------+</span></span>
<span id="cb312-3"><a href="#cb312-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | <span class="fu">uid</span> | tag  |</span>
<span id="cb312-4"><a href="#cb312-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----+------+</span></span>
<span id="cb312-5"><a href="#cb312-5" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">41</span> |   <span class="dv">1</span> |  <span class="dv">404</span> |</span>
<span id="cb312-6"><a href="#cb312-6" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">42</span> |   <span class="dv">1</span> |  <span class="dv">404</span> |</span>
<span id="cb312-7"><a href="#cb312-7" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">43</span> |   <span class="dv">1</span> |  <span class="dv">404</span> |</span>
<span id="cb312-8"><a href="#cb312-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----+------+</span></span>
<span id="cb312-9"><a href="#cb312-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb312-10"><a href="#cb312-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-11"><a href="#cb312-11" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> shard2;</span>
<span id="cb312-12"><a href="#cb312-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----+</span></span>
<span id="cb312-13"><a href="#cb312-13" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | <span class="fu">uid</span> |</span>
<span id="cb312-14"><a href="#cb312-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----+</span></span>
<span id="cb312-15"><a href="#cb312-15" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">51</span> |   <span class="dv">2</span> |</span>
<span id="cb312-16"><a href="#cb312-16" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">52</span> |   <span class="dv">2</span> |</span>
<span id="cb312-17"><a href="#cb312-17" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">53</span> |   <span class="dv">2</span> |</span>
<span id="cb312-18"><a href="#cb312-18" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----+</span></span>
<span id="cb312-19"><a href="#cb312-19" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb312-20"><a href="#cb312-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-21"><a href="#cb312-21" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> dist;</span>
<span id="cb312-22"><a href="#cb312-22" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----+</span></span>
<span id="cb312-23"><a href="#cb312-23" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | <span class="fu">uid</span> |</span>
<span id="cb312-24"><a href="#cb312-24" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----+</span></span>
<span id="cb312-25"><a href="#cb312-25" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">41</span> |   <span class="dv">1</span> |</span>
<span id="cb312-26"><a href="#cb312-26" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">42</span> |   <span class="dv">1</span> |</span>
<span id="cb312-27"><a href="#cb312-27" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">43</span> |   <span class="dv">1</span> |</span>
<span id="cb312-28"><a href="#cb312-28" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">51</span> |   <span class="dv">2</span> |</span>
<span id="cb312-29"><a href="#cb312-29" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">52</span> |   <span class="dv">2</span> |</span>
<span id="cb312-30"><a href="#cb312-30" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">53</span> |   <span class="dv">2</span> |</span>
<span id="cb312-31"><a href="#cb312-31" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----+</span></span>
<span id="cb312-32"><a href="#cb312-32" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>However, if we start using the newly added <code>tag</code> column
with the <code>dist</code> index that’s exactly the kind of an issue
that is now a hard error. Too soon, because the column was not yet added
everywhere.</p>
<div class="sourceCode" id="cb313"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb313-1"><a href="#cb313-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, tag <span class="kw">FROM</span> dist;</span>
<span id="cb313-2"><a href="#cb313-2" aria-hidden="true" tabindex="-1"></a>ERROR <span class="dv">1064</span> (<span class="dv">42000</span>): <span class="kw">index</span> <span class="st">&#39;shard2&#39;</span>: parse error: unknown <span class="kw">column</span>: tag</span></code></pre></div>
<p>We used local indexes in our example, but this works (well, fails!)
in exactly the same way when using the remote agents. The specific error
message may differ but the error <em>must</em> happen.</p>
<p>Previously you would get a partial result set with a warning instead.
That can still be done but now that requires an explicit option.</p>
<div class="sourceCode" id="cb314"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, tag <span class="kw">FROM</span> dist <span class="kw">OPTION</span> lax_agent_errors<span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb314-2"><a href="#cb314-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+</span></span>
<span id="cb314-3"><a href="#cb314-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | tag  |</span>
<span id="cb314-4"><a href="#cb314-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+</span></span>
<span id="cb314-5"><a href="#cb314-5" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">41</span> |  <span class="dv">404</span> |</span>
<span id="cb314-6"><a href="#cb314-6" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">42</span> |  <span class="dv">404</span> |</span>
<span id="cb314-7"><a href="#cb314-7" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">43</span> |  <span class="dv">404</span> |</span>
<span id="cb314-8"><a href="#cb314-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+</span></span>
<span id="cb314-9"><a href="#cb314-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span>, <span class="dv">1</span> warning (<span class="fl">0.00</span> sec)</span>
<span id="cb314-10"><a href="#cb314-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-11"><a href="#cb314-11" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW META;</span>
<span id="cb314-12"><a href="#cb314-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+--------------------------------------------------+</span></span>
<span id="cb314-13"><a href="#cb314-13" aria-hidden="true" tabindex="-1"></a>| Variable_name | <span class="fu">Value</span>                                            |</span>
<span id="cb314-14"><a href="#cb314-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+--------------------------------------------------+</span></span>
<span id="cb314-15"><a href="#cb314-15" aria-hidden="true" tabindex="-1"></a>| warning       | <span class="kw">index</span> <span class="st">&#39;shard2&#39;</span>: parse error: unknown <span class="kw">column</span>: tag |</span>
<span id="cb314-16"><a href="#cb314-16" aria-hidden="true" tabindex="-1"></a>| total         | <span class="dv">3</span>                                                |</span>
<span id="cb314-17"><a href="#cb314-17" aria-hidden="true" tabindex="-1"></a>| total_found   | <span class="dv">3</span>                                                |</span>
<span id="cb314-18"><a href="#cb314-18" aria-hidden="true" tabindex="-1"></a>| <span class="dt">time</span>          | <span class="fl">0.000</span>                                            |</span>
<span id="cb314-19"><a href="#cb314-19" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+--------------------------------------------------+</span></span>
<span id="cb314-20"><a href="#cb314-20" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Beware that these errors may become unavoidably srtict, and this
workaround-ish option just <em>MAY</em> get deprecated and then removed
at some future point. So if your index setup somehow really absolutely
unavoidably requires “intentionally semi-erroneous” queries like that,
you should rewrite them using other SphinxQL features that, well, let
you avoid errors.</p>
<p>To keep our example going, even if for some reason we absolutely must
utilize the new column ASAP (and could not even wait for the second
<code>ALTER</code> to finish), we can use the <code>EXIST()</code>
pseudo-function:</p>
<div class="sourceCode" id="cb315"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb315-1"><a href="#cb315-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, EXIST(<span class="st">&#39;tag&#39;</span>, <span class="dv">0</span>) xtag <span class="kw">FROM</span> dist;</span>
<span id="cb315-2"><a href="#cb315-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+</span></span>
<span id="cb315-3"><a href="#cb315-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | xtag |</span>
<span id="cb315-4"><a href="#cb315-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+</span></span>
<span id="cb315-5"><a href="#cb315-5" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">41</span> |  <span class="dv">404</span> |</span>
<span id="cb315-6"><a href="#cb315-6" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">42</span> |  <span class="dv">404</span> |</span>
<span id="cb315-7"><a href="#cb315-7" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">43</span> |  <span class="dv">404</span> |</span>
<span id="cb315-8"><a href="#cb315-8" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">51</span> |    <span class="dv">0</span> |</span>
<span id="cb315-9"><a href="#cb315-9" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">52</span> |    <span class="dv">0</span> |</span>
<span id="cb315-10"><a href="#cb315-10" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">53</span> |    <span class="dv">0</span> |</span>
<span id="cb315-11"><a href="#cb315-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+</span></span>
<span id="cb315-12"><a href="#cb315-12" aria-hidden="true" tabindex="-1"></a><span class="dv">6</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>That’s no errors, no warnings, and more data. Usually considered a
good thing.</p>
<p>A few more quick notes about this change, in no particular order:</p>
<ul>
<li><code>FACET</code> queries are <em>not</em> affected, only the
distributed indexes are. Facet queries remain “independent” in the sense
that an error in an individual facet does not affect any other
facets;</li>
<li>both local and remote indexes are affected, as they are considered
completely equal from the perspective of the encompassing distributed
index;</li>
<li>so despite the name, <code>lax_agent_errors</code> also applies very
well to the local components of distributed index
(<code>relaxed_agent_or_local_errors</code> would be more precise but
way too long);</li>
<li>“implicit” distributed indexes are also affected, meaning that
queries like <code>SELECT ... FROM shard1, shard2</code> are now more
strict too.</li>
</ul>
<h2 id="ranking-factors">Ranking: factors</h2>
<p>Sphinx lets you specify custom ranking formulas for
<code>weight()</code> calculations, and tailor text-based relevance
ranking for your needs. For instance:</p>
<div class="sourceCode" id="cb316"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span>, WEIGHT() <span class="kw">FROM</span> myindex <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>)</span>
<span id="cb316-2"><a href="#cb316-2" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> ranker<span class="op">=</span>expr(<span class="st">&#39;sum(lcs)*10000+bm15&#39;</span>)</span></code></pre></div>
<p>This mechanism is called the <strong>expression ranker</strong> and
its ranking formulas (expressions) can access a few more special
variables, called ranking factors, than a regular expression. (Of
course, all the per-document attributes and all the math and other
functions are still accessible to these formulas, too.)</p>
<p><strong>Ranking factors (aka ranking signals)</strong> are,
basically, a bunch of different values computed for every document (or
even field), based on the current search query. They essentially
describe various aspects of the specific document match, and so they are
used as input variables in a ranking formula, or a ML model.</p>
<p>There are three types (or levels) of factors, that determine when
exactly some given factor can and will be computed:</p>
<ul>
<li><strong>query factors</strong>: values that only depend on the
search query, but not the document, like
<code>query_word_count</code>;</li>
<li><strong>document factors</strong>: values that depend on both the
query <em>and</em> the matched document, like
<code>doc_word_count</code> or <code>bm15</code>;</li>
<li><strong>field factors</strong>: values that depend on both the query
<em>and</em> the matched full-text field, like <code>word_count</code>
or <code>lcs</code>.</li>
</ul>
<p><strong>Query factors</strong> are naturally computed just once at
the query start, and from there they stay constant. Those are usually
simple things, like a number of unique keywords in the query. You can
use them anywhere in the ranking formula.</p>
<p><strong>Document factors</strong> additionally depend on the document
text, and so they get computed for every matched document. You can use
them anywhere in the ranking formula, too. Of these, a few variants of
the classic <code>bm25()</code> function are arguably the most important
for relevance ranking.</p>
<p>Finally, <strong>field factors</strong> are even more granular, they
get computed for every single field. And thus they then have to be
aggregated into a singular value by some <strong>factor aggregation
function</strong> (as of v.3.2, the supported functions are either
<code>SUM()</code> or <code>TOP()</code>).</p>
<p><strong>Factors can be optional, aka null.</strong> For instance, by
default no fields are implicitly indexed for trigrams, and all the
trigram factors are undefined, and they get null values. Those null
values are suppressed from <code>FACTORS()</code> JSON output. However,
internally they are implemented using some magic values of the original
factor type rather than some “true” nulls of a special type. So in both
UDFs and ranking expressions you will get those magic values, and you
may have to interpret them as nulls.</p>
<p>Keeping the trigrams example going, trigram factors are nullified
when <code>trf_qt</code> (which has a <code>float</code> type) is set to
-1, while non-null values of <code>trf_qt</code> must always be in 0..1
range. All the other <code>trf_xxx</code> signals get zeroed out. Thus,
to properly differentiate between null and zero values of some
<em>other</em> factor, let’s pick <code>trf_i2u</code> for example, you
will have to check not even the <code>trf_i2u</code> value itself
(because it’s zero in both zero and null cases), but you have to check
<code>trf_qt</code> value for being less than zero. Ranking is fun.</p>
<p>And before we discuss every specific factor in a bit more detail,
here goes the obligatory <strong>factors cheat sheet</strong>. Note
that:</p>
<ul>
<li><strong>Hits</strong> in Sphinx == postings in IR == formally “a
number of (a certain type of) matching keyword occurrences in the
current field”</li>
<li><strong>“Opt”</strong> column says “yes” when the factor (ie.
signal) is optional</li>
</ul>
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 3%" />
<col style="width: 68%" />
</colgroup>
<thead>
<tr class="header">
<th>Name</th>
<th>Level</th>
<th>Type</th>
<th>Opt</th>
<th>Summary</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>has_digit_words</td>
<td>query</td>
<td>int</td>
<td></td>
<td>number of <code>has_digit</code> words that contain
<code>[0-9]</code> chars (but may also contain other chars)</td>
</tr>
<tr class="even">
<td>is_latin_words</td>
<td>query</td>
<td>int</td>
<td></td>
<td>number of <code>is_latin</code> words, ie. words with
<code>[a-zA-Z]</code> chars only</td>
</tr>
<tr class="odd">
<td>is_noun_words</td>
<td>query</td>
<td>int</td>
<td></td>
<td>number of <code>is_noun</code> words, ie. tagged as nouns (by the
lemmatizer)</td>
</tr>
<tr class="even">
<td>is_number_words</td>
<td>query</td>
<td>int</td>
<td></td>
<td>number of <code>is_number</code> words, ie. integers with
<code>[0-9]</code> chars only</td>
</tr>
<tr class="odd">
<td>max_lcs</td>
<td>query</td>
<td>int</td>
<td></td>
<td>maximum possible LCS value for the current query</td>
</tr>
<tr class="even">
<td>query_tokclass_mask</td>
<td>query</td>
<td>int</td>
<td>yes</td>
<td>mask of token classes (if any) found in the current query</td>
</tr>
<tr class="odd">
<td>query_word_count</td>
<td>query</td>
<td>int</td>
<td></td>
<td>number of unique inclusive keywords in a query</td>
</tr>
<tr class="even">
<td>words_clickstat</td>
<td>query</td>
<td>float</td>
<td>yes</td>
<td><code>sum(clicks)/sum(events)</code> over matching words with
“clickstats” in the query</td>
</tr>
<tr class="odd">
<td>annot_exact_hit</td>
<td>doc</td>
<td>int</td>
<td>yes</td>
<td>whether any annotations entry == annot-field query</td>
</tr>
<tr class="even">
<td>annot_exact_order</td>
<td>doc</td>
<td>int</td>
<td>yes</td>
<td>whether all the annot-field keywords were a) matched and b) in query
order, in any entry</td>
</tr>
<tr class="odd">
<td>annot_hit_count</td>
<td>doc</td>
<td>int</td>
<td>yes</td>
<td>number of individual annotations matched by annot-field query</td>
</tr>
<tr class="even">
<td>annot_max_score</td>
<td>doc</td>
<td>float</td>
<td>yes</td>
<td>maximum score over matched annotations, additionally clamped by
0</td>
</tr>
<tr class="odd">
<td>annot_sum_idf</td>
<td>doc</td>
<td>float</td>
<td>yes</td>
<td>sum_idf for annotations field</td>
</tr>
<tr class="even">
<td>bm15</td>
<td>doc</td>
<td>float</td>
<td></td>
<td>quick estimate of <code>BM25(1.2, 0)</code> without query syntax
support</td>
</tr>
<tr class="odd">
<td>bm25a(k1, b)</td>
<td>doc</td>
<td>int</td>
<td></td>
<td>precise <code>BM25()</code> value with configurable <code>K1</code>,
<code>B</code> constants and syntax support</td>
</tr>
<tr class="even">
<td>bm25f(k1, b, …)</td>
<td>doc</td>
<td>int</td>
<td></td>
<td>precise <code>BM25F()</code> value with extra configurable field
weights</td>
</tr>
<tr class="odd">
<td>doc_word_count</td>
<td>doc</td>
<td>int</td>
<td></td>
<td>number of unique keywords matched in the document</td>
</tr>
<tr class="even">
<td>field_mask</td>
<td>doc</td>
<td>int</td>
<td></td>
<td>bit mask of the matched fields</td>
</tr>
<tr class="odd">
<td>atc</td>
<td>field</td>
<td>float</td>
<td></td>
<td>Aggregate Term Closeness,
<code>log(1+sum(idf1*idf2*pow(dist, -1.75))</code> over “best” term
pairs</td>
</tr>
<tr class="even">
<td>bpe_aqt</td>
<td>field</td>
<td>float</td>
<td>yes</td>
<td>BPE Filter Alphanumeric Query Tokens ratio</td>
</tr>
<tr class="odd">
<td>bpe_i2f</td>
<td>field</td>
<td>float</td>
<td>yes</td>
<td>BPE Filter Intersection To Field ratio</td>
</tr>
<tr class="even">
<td>bpe_i2q</td>
<td>field</td>
<td>float</td>
<td>yes</td>
<td>BPE Filter Intersection to Query ratio</td>
</tr>
<tr class="odd">
<td>bpe_i2u</td>
<td>field</td>
<td>float</td>
<td>yes</td>
<td>BPE Filter Intersection to Union ratio</td>
</tr>
<tr class="even">
<td>bpe_naqt</td>
<td>field</td>
<td>float</td>
<td>yes</td>
<td>BPE Filter Number of Alphanumeric Query Tokens</td>
</tr>
<tr class="odd">
<td>bpe_qt</td>
<td>field</td>
<td>float</td>
<td>yes</td>
<td>BPE Filter Query BPE tokens ratio</td>
</tr>
<tr class="even">
<td>exact_field_hit</td>
<td>field</td>
<td>bool</td>
<td></td>
<td>whether field is fully covered by the query, in the query term
order</td>
</tr>
<tr class="odd">
<td>exact_hit</td>
<td>field</td>
<td>bool</td>
<td></td>
<td>whether query == field</td>
</tr>
<tr class="even">
<td>exact_order</td>
<td>field</td>
<td>bool</td>
<td></td>
<td>whether all query keywords were a) matched and b) in query
order</td>
</tr>
<tr class="odd">
<td>full_field_hit</td>
<td>field</td>
<td>bool</td>
<td></td>
<td>whether field is fully covered by the query, in arbitrary term
order</td>
</tr>
<tr class="even">
<td>has_digit_hits</td>
<td>field</td>
<td>int</td>
<td></td>
<td>number of <code>has_digit</code> keyword hits</td>
</tr>
<tr class="odd">
<td>hit_count</td>
<td>field</td>
<td>int</td>
<td></td>
<td>total number of any-keyword hits</td>
</tr>
<tr class="even">
<td>is_latin_hits</td>
<td>field</td>
<td>int</td>
<td></td>
<td>number of <code>is_latin</code> keyword hits</td>
</tr>
<tr class="odd">
<td>is_noun_hits</td>
<td>field</td>
<td>int</td>
<td></td>
<td>number of <code>is_noun</code> keyword hits</td>
</tr>
<tr class="even">
<td>is_number_hits</td>
<td>field</td>
<td>int</td>
<td></td>
<td>number of <code>is_number</code> keyword hits</td>
</tr>
<tr class="odd">
<td>lccs</td>
<td>field</td>
<td>int</td>
<td></td>
<td>Longest Common Contiguous Subsequence between query and document, in
words</td>
</tr>
<tr class="even">
<td>lcs</td>
<td>field</td>
<td>int</td>
<td></td>
<td>Longest Common Subsequence between query and document, in words</td>
</tr>
<tr class="odd">
<td>max_idf</td>
<td>field</td>
<td>float</td>
<td></td>
<td><code>max(idf)</code> over keywords matched in this field</td>
</tr>
<tr class="even">
<td>max_window_hits(n)</td>
<td>field</td>
<td>int</td>
<td></td>
<td><code>max(window_hit_count)</code> computed over all N-word windows
in the current field</td>
</tr>
<tr class="odd">
<td>min_best_span_pos</td>
<td>field</td>
<td>int</td>
<td></td>
<td>first maximum LCS span position, in words, 1-based</td>
</tr>
<tr class="even">
<td>min_gaps</td>
<td>field</td>
<td>int</td>
<td></td>
<td>min number of gaps between the matched keywords over the matching
spans</td>
</tr>
<tr class="odd">
<td>min_hit_pos</td>
<td>field</td>
<td>int</td>
<td></td>
<td>first matched occurrence position, in words, 1-based</td>
</tr>
<tr class="even">
<td>min_idf</td>
<td>field</td>
<td>float</td>
<td></td>
<td><code>min(idf)</code> over keywords matched in this field</td>
</tr>
<tr class="odd">
<td>phrase_decay10</td>
<td>field</td>
<td>float</td>
<td></td>
<td>field to query phrase “similarity” with 2x weight decay per 10
positions</td>
</tr>
<tr class="even">
<td>phrase_decay30</td>
<td>field</td>
<td>float</td>
<td></td>
<td>field to query phrase “similarity” with 2x weight decay per 30
positions</td>
</tr>
<tr class="odd">
<td>sum_idf</td>
<td>field</td>
<td>float</td>
<td></td>
<td><code>sum(idf)</code> over unique keywords matched in this
field</td>
</tr>
<tr class="even">
<td>sum_idf_boost</td>
<td>field</td>
<td>float</td>
<td></td>
<td><code>sum(idf_boost)</code> over unique keywords matched in this
field</td>
</tr>
<tr class="odd">
<td>tf_idf</td>
<td>field</td>
<td>float</td>
<td></td>
<td><code>sum(tf*idf)</code> over unique matched keywords, ie.
<code>sum(idf)</code> over all occurrences</td>
</tr>
<tr class="even">
<td>trf_aqt</td>
<td>field</td>
<td>float</td>
<td>yes</td>
<td>Trigram Filter Alphanumeric Query Trigrams ratio</td>
</tr>
<tr class="odd">
<td>trf_i2f</td>
<td>field</td>
<td>float</td>
<td>yes</td>
<td>Trigram Filter Intersection To Field ratio</td>
</tr>
<tr class="even">
<td>trf_i2q</td>
<td>field</td>
<td>float</td>
<td>yes</td>
<td>Trigram Filter Intersection to Query ratio</td>
</tr>
<tr class="odd">
<td>trf_i2u</td>
<td>field</td>
<td>float</td>
<td>yes</td>
<td>Trigram Filter Intersection to Union ratio</td>
</tr>
<tr class="even">
<td>trf_naqt</td>
<td>field</td>
<td>float</td>
<td>yes</td>
<td>Trigram Filter Number of Alphanumeric Query Trigrams</td>
</tr>
<tr class="odd">
<td>trf_qt</td>
<td>field</td>
<td>float</td>
<td>yes</td>
<td>Trigram Filter Query Trigrams ratio</td>
</tr>
<tr class="even">
<td>user_weight</td>
<td>field</td>
<td>int</td>
<td></td>
<td>user-specified field weight (via
<code>OPTION field_weights</code>)</td>
</tr>
<tr class="odd">
<td>wlccs</td>
<td>field</td>
<td>float</td>
<td></td>
<td>Weighted LCCS, <code>sum(idf)</code> over contiguous keyword
spans</td>
</tr>
<tr class="even">
<td>word_count</td>
<td>field</td>
<td>int</td>
<td></td>
<td>number of unique keywords matched in this field</td>
</tr>
<tr class="odd">
<td>wordpair_ctr</td>
<td>field</td>
<td>float</td>
<td></td>
<td><code>sum(clicks) / sum(views)</code> over all the matching
query-vs-field raw token pairs</td>
</tr>
</tbody>
</table>
<h3 id="accessing-ranking-factors">Accessing ranking factors</h3>
<p>You can access the ranking factors in several different ways. Most of
them involve using the special <code>FACTORS()</code> function.</p>
<ol type="1">
<li><code>SELECT FACTORS()</code> formats all the (non-null) factors as
a JSON document. <strong>This is the intended method for ML export
tasks</strong>, but also useful for debugging.</li>
<li><code>SELECT MYUDF(FACTORS())</code> passes all the factors
(<em>including</em> null ones) to your UDF function. <strong>This is the
intended method for ML inference tasks</strong>, but it could of course
be used for something else, for instance, exporting data in a special
format.</li>
<li><code>SELECT FACTORS().xxx.yyy</code> returns an individual signal
as a scalar value (either <code>UINT</code> or <code>FLOAT</code> type).
<strong>This is mostly intended for debugging.</strong> However, note
some of the factors are not yet supported as of v.3.5.</li>
<li>For the record,
<code>SELECT WEIGHT() ... OPTION ranker=expr('...')</code> returns the
ranker formula evaluation result in the <code>WEIGHT()</code> and a
carefully crafted formula could also extract individual factors. That’s
a legacy debugging workaround though. Also, as of v.3.5 some of the
factors might not be accessible to formulas, too. (By oversight rather
than by design.)</li>
</ol>
<p>Bottom line, <code>FACTORS()</code> and <code>MYUDF(FACTORS())</code>
are our primary workhorses, and those have full access to
everything.</p>
<p>But <code>FACTORS()</code> output gets rather big these days, so it’s
frequently useful to pick out individual signals, and
<code>FACTORS().xxx.yyy</code> syntax does just that.</p>
<p>As of v.3.5 it lets you access most of the field-level signals,
either by field index or field name. Missing fields or null values will
be fixed up to zeroes.</p>
<pre><code>SELECT id, FACTORS().fields[3].atc ...
SELECT id, FACTORS().fields.title.lccs ...</code></pre>
<h3 id="factor-aggregation-functions">Factor aggregation functions</h3>
<p>Formally, a (field) factor aggregation function is a single argument
function that takes an expression with field-level factors, iterates it
over all the matched fields, and computes the final result over the
individual per-field values.</p>
<p>Currently supported aggregation functions are:</p>
<ul>
<li><code>SUM()</code>, sums the argument expression over all matched
fields. For instance, <code>sum(1)</code> should return a number of
matched fields.</li>
<li><code>TOP()</code>, returns the greatest value of the argument over
all matched fields. For instance, <code>top(max_idf)</code> should
return a maximum per-keyword IDF over the entire document.</li>
</ul>
<p>Naturally, these are only needed over expressions with field-level
factors, query-level and document-level factors can be used in the
formulas “as is”.</p>
<h3 id="keyword-flags">Keyword flags</h3>
<p>When searching and ranking, Sphinx classifies every query keyword
with regards to a few classes of interest. That is, it flags a keyword
with a “noun” class when the keyword is a (known) noun, or flags it with
a “number” class when it is an integer, etc.</p>
<p>At the moment we identify 4 keyword classes and assign the respective
flags. Those 4 flags in turn generate 8 ranking factors, 4 query-level
per-flag keyword counts, and 4 field-level per-class hit counts. The
flags are described in a bit more detail just below.</p>
<p>It’s important to understand that all the flags are essentially
assigned at <em>query</em> parsing time, without looking into any actual
index <em>data</em> (as opposed to tokenization and morphology
settings). Also, query processing rules apply. Meaning that the valid
keyword modifiers are effectively stripped before assigning the
flags.</p>
<h4 id="has_digit-flag"><code>has_digit</code> flag</h4>
<p>Keyword is flagged as <code>has_digit</code> when there is at least
one digit character, ie. from <code>[0-9]</code> range, in that
keyword.</p>
<p>Other characters are allowed, meaning that <code>l33t</code> is a
<code>has_digit</code> keyword.</p>
<p>But they are not required, and thus, any <code>is_number</code>
keyword is by definition a <code>has_digit</code> keyword.</p>
<h4 id="is_latin-flag"><code>is_latin</code> flag</h4>
<p>Keyword is flagged as <code>is_latin</code> when it completely
consists of Latin letters, ie. any of the <code>[a-zA-Z]</code>
characters. No other characters are allowed.</p>
<p>For instance, <code>hello</code> is flagged as <code>is_latin</code>,
but <code>l33t</code> is <em>not</em>, because of the digits.</p>
<p>Also note that wildcards like <code>abc*</code> are <em>not</em>
flagged as <code>is_latin</code>, even if all the actual expansions are
latin-only. Technically, query keyword flagging only looks at the query
itself, and not the index data, and can not know anything about the
actual expansions yet. (And even if it did, then inserting a new row
with a new expansion could suddenly break the <code>is_latin</code>
property.)</p>
<p>At the same time, as query keyword modifiers like <code>^abc</code>
or <code>=abc</code> still get properly processed, these keywords
<em>are</em> flagged as <code>is_latin</code> alright.</p>
<h4 id="is_noun-flag"><code>is_noun</code> flag</h4>
<p>Keyword is flagged as <code>is_noun</code> when (a) there is at least
one lemmatizer enabled for the index, and (b) that lemmatizer classifies
that standalone keyword as a noun.</p>
<p>For example, with <code>morphology = lemmatize_en</code> configured
in our example index, we get the following:</p>
<pre><code>mysql&gt; CALL KEYWORDS(&#39;deadly mortal sin&#39;, &#39;en&#39;, 1 AS stats);
+------+-----------+------------+------+------+-----------+------------+----------------+----------+---------+-----------+-----------+
| qpos | tokenized | normalized | docs | hits | plain_idf | global_idf | has_global_idf | is_latin | is_noun | is_number | has_digit |
+------+-----------+------------+------+------+-----------+------------+----------------+----------+---------+-----------+-----------+
| 1    | deadly    | deadly     | 0    | 0    | 0.000000  | 0.000000   | 0              | 1        | 0       | 0         | 0         |
| 2    | mortal    | mortal     | 0    | 0    | 0.000000  | 0.000000   | 0              | 1        | 1       | 0         | 0         |
| 3    | sin       | sin        | 0    | 0    | 0.000000  | 0.000000   | 0              | 1        | 1       | 0         | 0         |
+------+-----------+------------+------+------+-----------+------------+----------------+----------+---------+-----------+-----------+
3 rows in set (0.00 sec)</code></pre>
<p>However, as you can see from this very example, <code>is_noun</code>
POS tagging is not completely precise.</p>
<p>For now it works on individual words rather than contexts. So even
though in <em>this</em> particular query context we could technically
guess that “mortal” is not a noun, in general it sometimes is. Hence the
<code>is_noun</code> flags in this example are 0/1/1, though ideally
they would be 0/0/1 respectively.</p>
<p>Also, at the moment the tagger prefers to overtag. That is, when “in
doubt”, ie. when the lemmatizer reports that a given wordform can either
be a noun or not, we do not (yet) analyze the probabilities, and just
always set the flag.</p>
<p>Another tricky bit is the handling of non-dictionary forms. As of
v.3.2 the lemmatizer reports all such predictions as nouns.</p>
<p>So use with care; this can be a noisy signal.</p>
<h4 id="is_number-flag"><code>is_number</code> flag</h4>
<p>Keyword is flagged as <code>is_number</code> when <em>all</em> its
characters are digits from the <code>[0-9]</code> range. Other
characters are not allowed.</p>
<p>So, for example, <code>123</code> will be flagged
<code>is_number</code>, but neither <code>0.123</code> nor
<code>0x123</code> will be flagged.</p>
<p>To nitpick on this particular example a bit more, note that
<code>.</code> does not even get parsed as a character by default. So
with the default <code>charset_table</code> that query text will not
even produce a single keyword. Instead, by default it gets tokenized as
two tokens (keywords), <code>0</code> and <code>123</code>, and
<em>those</em> tokens in turn <em>are</em> flagged
<code>is_number</code>.</p>
<h3 id="query-level-ranking-factors">Query-level ranking factors</h3>
<p>These are perhaps the simplest factors. They are entirely independent
from the documents being ranked; they only describe the query. So they
only get computed once, at the very start of query processing.</p>
<h4 id="has_digit_words">has_digit_words</h4>
<p>Query-level, a number of unique <code>has_digit</code> keywords in
the query. Duplicates should only be accounted once.</p>
<h4 id="is_latin_words">is_latin_words</h4>
<p>Query-level, a number of unique <code>is_latin</code> keywords in the
query. Duplicates should only be accounted once.</p>
<h4 id="is_noun_words">is_noun_words</h4>
<p>Query-level, a number of unique <code>is_noun</code> keywords in the
query. Duplicates should only be accounted once.</p>
<h4 id="is_number_words">is_number_words</h4>
<p>Query-level, a number of unique <code>is_number</code> keywords in
the query. Duplicates should only be accounted once.</p>
<h4 id="max_lcs">max_lcs</h4>
<p>Query-level, maximum possible value that the
<code>sum(lcs*user_weight)</code> expression can take. This can be
useful for weight boost scaling. For instance, (legacy)
<code>MATCHANY</code> ranker formula uses this factor to
<em>guarantee</em> that a full phrase match in <em>any</em> individual
field ranks higher than any combination of partial matches in all
fields.</p>
<h4 id="query_word_count">query_word_count</h4>
<p>Query-level, a number of unique and inclusive keywords in a query.
“Inclusive” means that it’s additionally adjusted for a number of
excluded keywords. For example, both <code>one one one one</code> and
<code>(one !two)</code> queries should assign a value of 1 to this
factor, because there is just one unique non-excluded keyword.</p>
<h3 id="document-level-ranking-factors">Document-level ranking
factors</h3>
<p>These are a few factors that “look” at both the query and the
(entire) matching document being ranked. The most useful among these are
several variants of the classic BM-family factors (as in Okapi
BM25).</p>
<h4 id="bm15">bm15</h4>
<p>Document-level, a quick estimate of a classic <code>BM15(1.2)</code>
value. It is computed without keyword occurrence filtering (ie. over all
the term postings rather than just the matched ones). Also, it ignores
the document and fields lengths.</p>
<p>For example, if you search for an exact phrase like
<code>"foo bar"</code>, and both <code>foo</code> and <code>bar</code>
keywords occur 10 times each in the document, but the <em>phrase</em>
only occurs once, then this <code>bm15</code> estimate will still use 10
as TF (Term Frequency) values for both these keywords, ie. account all
the term occurrences (postings), instead of “accounting” just 1 actual
matching posting.</p>
<p>So <code>bm15</code> uses pre-computed document TFs, rather that
computing actual matched TFs on the fly. By design, that makes zero
difference all when running a simple bag-of-words query against the
entire document. However, once you start using pretty much <em>any</em>
query syntax, the differences become obvious.</p>
<p>To discuss one, what if you limit all your searches to a single field
with, and the query is <code>@title foo bar</code>? Should the weights
really depend on contents of any other fields, as we clearly intended to
limit our searches to titles? They should not. However, with the
<code>bm15</code> approximation they will. But this really is just a
performance vs quality tradeoff.</p>
<p>Last but not least, a couple historical quirks.</p>
<p>Before v.3.0.2 this factor was not-quite-correctly named
<code>bm25</code> and that lasted for just about ever. It got renamed to
<code>bm15</code> in v.3.0.2. (It can be argued that in a way it did
compute the BM25 value, for a very specific <code>k1 = 1.2</code> and
<code>b = 0</code> case. But come on. There is a special name for that
<code>b = 0</code> family of cases, and it is <code>bm15</code>.)</p>
<p>Before v.3.5 this factor returned rounded-off int values. That caused
slight mismatches between the built-in rankers and the respective
expressions. Starting with v.3.5 it returns float values, and the
mismatches are eliminated.</p>
<h4 id="bm25a">bm25a()</h4>
<p>Document-level, parametrized, computes a value of classic
<code>BM25(k1,b)</code> function with the two given (required)
parameters. For example:</p>
<div class="sourceCode" id="cb319"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>. <span class="kw">OPTION</span> ranker<span class="op">=</span>expr(<span class="st">&#39;10000*bm25a(2.0, 0.7)&#39;</span>)</span></code></pre></div>
<p>Unlike <code>bm15</code>, this factor only account the
<em>matching</em> occurrences (postings) when computing TFs. It also
requires <code>index_field_lengths = 1</code> setting to be on, in order
to compute the current and average document lengths (which is in turn
required by BM25 function with non-zero <code>b</code> parameters).</p>
<p>It is called <code>bm25a</code> only because <code>bm25</code> was
initially taken (mistakenly) by that <code>BM25(1.2, 0)</code> value
estimate that we now (properly) call <code>bm15</code>; no other hidden
meaning in that <code>a</code> suffix.</p>
<h4 id="bm25f">bm25f()</h4>
<p>Document-level, parametrized, computes a value of an extended
<code>BM25F(k1,b)</code> function with the two given (required)
parameters, and an extra set of named per-field weights. For
example:</p>
<div class="sourceCode" id="cb320"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb320-1"><a href="#cb320-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>. <span class="kw">OPTION</span> ranker<span class="op">=</span>expr(<span class="st">&#39;10000*bm25f(2.0, 0.7, {title = 3})&#39;</span>)</span></code></pre></div>
<p>Unlike <code>bm15</code>, this factor only account the
<em>matching</em> occurrences (postings) when computing TFs. It also
requires <code>index_field_lengths = 1</code> setting to be on.</p>
<p>BM25F extension lets you assign bigger weights to certain fields.
Internally those weights will simply pre-scale the TFs before plugging
them into the original BM25 formula. For the original TR, see <a
href="https://trec.nist.gov/pubs/trec13/papers/microsoft-cambridge.web.hard.pdf">Zaragoza
et al (1994), “Microsoft Cambridge at TREC-13: Web and HARD tracks”</a>
paper.</p>
<h4 id="doc_word_count">doc_word_count</h4>
<p>Document-level, a number of unique keywords matched in the entire
document.</p>
<h4 id="field_mask">field_mask</h4>
<p>Document-level, a 32-bit mask of matched fields. Fields with numbers
33 and up are ignored in this mask.</p>
<h3 id="field-level-ranking-factors">Field-level ranking factors</h3>
<p>Generally, a field-level factor is just some numeric value computed
by the ranking engine for every matched in-document text field, with
regards to the current query, describing this or this aspect of the
actual match.</p>
<p>As a query can match multiple fields, but the final weight needs to
be a single value, these per-field values need to be folded into a
single one. Meaning that, unlike query-level and document-level factors,
you can’t use them directly in your ranking formulas:</p>
<div class="sourceCode" id="cb321"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, weight() <span class="kw">FROM</span> test1 <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>)</span>
<span id="cb321-2"><a href="#cb321-2" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> ranker<span class="op">=</span>expr(<span class="st">&#39;lcs&#39;</span>);</span>
<span id="cb321-3"><a href="#cb321-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-4"><a href="#cb321-4" aria-hidden="true" tabindex="-1"></a>ERROR <span class="dv">1064</span> (<span class="dv">42000</span>): <span class="kw">index</span> <span class="st">&#39;test1&#39;</span>: field factors must <span class="kw">only</span></span>
<span id="cb321-5"><a href="#cb321-5" aria-hidden="true" tabindex="-1"></a>occur within field aggregates <span class="kw">in</span> a ranking expression</span></code></pre></div>
<p>The correct syntax should use one of the aggregation functions.
Multiple different aggregations are allowed:</p>
<div class="sourceCode" id="cb322"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb322-1"><a href="#cb322-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, weight() <span class="kw">FROM</span> test1 <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>)</span>
<span id="cb322-2"><a href="#cb322-2" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> ranker<span class="op">=</span>expr(<span class="st">&#39;sum(lcs) + top(max_idf) * 1000&#39;</span>);</span></code></pre></div>
<p>Now let’s discuss the individual factors in a bit more detail.</p>
<h4 id="atc">atc</h4>
<p>Field-level, Aggregate Term Closeness. This is a proximity based
measure that grows higher when the document contains more groups of more
closely located and more important (rare) query keywords.</p>
<p><strong>WARNING:</strong> you should use ATC with
<code>OPTION idf='plain,tfidf_unnormalized'</code>; otherwise you could
get rather unexpected results.</p>
<p>ATC basically works as follows. For every keyword <em>occurrence</em>
in the document, we compute the so called <em>term closeness</em>. For
that, we examine all the other closest occurrences of all the query
keywords (keyword itself included too), both to the left and to the
right of the subject occurrence. We then compute a distance dampening
coefficient as <code>k = pow(distance, -1.75)</code> for all those
occurrences, and sum the dampened IDFs. Thus for every occurrence of
every keyword, we get a “closeness” value that describes the “neighbors”
of that occurrence. We then multiply those per-occurrence closenesses by
their respective subject keyword IDF, sum them all, and finally, compute
a logarithm of that sum.</p>
<p>Or in other words, we process the best (closest) matched keyword
pairs in the document, and compute pairwise “closenesses” as the product
of their IDFs scaled by the distance coefficient:</p>
<div class="sourceCode" id="cb323"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb323-1"><a href="#cb323-1" aria-hidden="true" tabindex="-1"></a>pair_tc <span class="op">=</span> idf<span class="op">(</span>pair_word1<span class="op">)</span> <span class="op">*</span> idf<span class="op">(</span>pair_word2<span class="op">)</span> <span class="op">*</span> pow<span class="op">(</span>pair_distance<span class="op">,</span> <span class="op">-</span><span class="fl">1.75</span><span class="op">)</span></span></code></pre></div>
<p>We then sum such closenesses, and compute the final, log-dampened ATC
value:</p>
<div class="sourceCode" id="cb324"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb324-1"><a href="#cb324-1" aria-hidden="true" tabindex="-1"></a>atc <span class="op">=</span> log<span class="op">(</span><span class="dv">1</span> <span class="op">+</span> sum<span class="op">(</span>pair_tc<span class="op">))</span></span></code></pre></div>
<p>Note that this final dampening logarithm is exactly the reason you
should use <code>OPTION idf=plain</code>, because without it, the
expression inside the <code>log()</code> could be negative.</p>
<p>Having closer keyword occurrences actually contributes <em>much</em>
more to ATC than having more frequent keywords. Indeed, when the
keywords are right next to each other, we get <code>distance = 1</code>
and <code>k = 1</code>; and when there is only one extra word between
them, we get <code>distance = 2</code> and <code>k = 0.297</code>; and
with two extra words in-between, we get <code>distance = 3</code> and
<code>k = 0.146</code>, and so on.</p>
<p>At the same time IDF attenuates somewhat slower. For example, in a 1
million document collection, the IDF values for 3 example keywords that
are found in 10, 100, and 1000 documents would be 0.833, 0.667, and
0.500, respectively.</p>
<p>So a keyword pair with two rather rare keywords that occur in just 10
documents each but with 2 other words in between would yield
<code>pair_tc = 0.101</code> and thus just barely outweigh a pair with a
100-doc and a 1000-doc keyword with 1 other word between them and
<code>pair_tc = 0.099</code>.</p>
<p>Moreover, a pair of two <em>unique</em>, 1-document keywords with
ideal IDFs, and with just 3 words between them would fetch a
<code>pair_tc = 0.088</code> and lose to a pair of two 1000-doc keywords
located right next to each other, with a
<code>pair_tc = 0.25</code>.</p>
<p>So, basically, while ATC does combine both keyword frequency and
proximity, it is still heavily favoring the proximity.</p>
<h4 id="bpe_aqt">bpe_aqt</h4>
<p>Field-level, float, a fraction of alphanumeric-only query trigrams
matched by the field BPE tokens filter. Takes values in 0..1 range.</p>
<p>See <a href="#ranking-trigrams-and-bpe-tokens">“Ranking: trigrams and
BPE tokens”</a> section for more details.</p>
<h4 id="bpe_i2f">bpe_i2f</h4>
<p>Field-level, float, a ratio of query-and-field intersection filter
bitcount to field filter bitcount (Intersection to Field). Takes values
in 0..1 range.</p>
<p>See <a href="#ranking-trigrams-and-bpe-tokens">“Ranking: trigrams and
BPE tokens”</a> section for more details.</p>
<h4 id="bpe_i2q">bpe_i2q</h4>
<p>Field-level, float, a ratio of query-and-field intersection filter
bitcount to query filter bitcount (Intersection to Query). Takes values
in 0..1 range.</p>
<p>See <a href="#ranking-trigrams-and-bpe-tokens">“Ranking: trigrams and
BPE tokens”</a> section for more details.</p>
<h4 id="bpe_i2u">bpe_i2u</h4>
<p>Field-level, float, a ratio of query-and-field intersection filter
bitcount to query-or-field union filter bitcount (Intersection to
Union). Takes values in 0..1 range.</p>
<p>See <a href="#ranking-trigrams-and-bpe-tokens">“Ranking: trigrams and
BPE tokens”</a> section for more details.</p>
<h4 id="bpe_naqt">bpe_naqt</h4>
<p>Field-level, float, a number of alphanumeric-only query BPE tokens
matched by the field BPE tokens filter. Takes non-negative integer
values (ie. 0, 1, 2, etc), but stored as float anyway, for
consistency.</p>
<p>See <a href="#ranking-trigrams-and-bpe-tokens">“Ranking: trigrams and
BPE tokens”</a> section for more details.</p>
<h4 id="bpe_qt">bpe_qt</h4>
<p>Field-level, float, a fraction of query BPE tokens matched by the
field BPE filter. Either in 0..1 range, or -1 when there is no field
filter.</p>
<p>See <a href="#ranking-trigrams-and-bpe-tokens">“Ranking: trigrams and
BPE tokens”</a> section for more details.</p>
<h4 id="exact_field_hit">exact_field_hit</h4>
<p>Field-level, boolean, whether the current field was (seemingly) fully
covered by the query, and in the right (query) term order, too.</p>
<p>This flag should be set when the field is basically either “equal” to
the entire query, or equal to a query with a few terms thrown away. Note
that term order matters, and it must match, too.</p>
<p>For example, if our query is <code>one two three</code>, then either
<code>one two three</code>, or just <code>one three</code>, or
<code>two three</code> should all have <code>exact_field_hit = 1</code>,
because in these examples all the <em>field</em> keywords are matched by
the query, and they are in the right order. However,
<code>three one</code> should get <code>exact_field_hit = 0</code>,
because of the wrong (non-query) term order. And then if we throw in any
extra terms, <code>one four three</code> field should also get
<code>exact_field_hit = 0</code>, because <code>four</code> was not
matched by the query, ie. this field is not covered fully.</p>
<p>Also, beware that stopwords and other text processing tools might
“break” this factor.</p>
<p>For example, when the field is <code>one stop three</code>, where
<code>stop</code> is a stopword, we would still get 0 instead of 1, even
though intuitively it should be ignored, and the field should be kinda
equal to <code>one three</code>, and we get a 1 for that. How come?</p>
<p>This is because stopwords are <em>not</em> really ignored completely.
They do still affect <em>positions</em> (and that’s intentional, so that
matching operators and other ranking factors would work as expected,
just in some other example cases).</p>
<p>Therefore, this field gets indexed as <code>one * three</code>, where
star marks a skipped position. So when matching the
<code>one two three</code> query, the engine knows that positions number
1 and 3 were matched alright. But there is no (efficient) way for it to
tell what exactly was in that missed position 2 in the original field;
ie. was there a stopword, or was there any <em>regular</em> word that
the query simply did not mention (like in the
<code>one four three</code> example). So when computing this factor, we
see that there was an unmatched position, therefore we assume that the
field was not covered fully (by the query terms), and set the factor to
0.</p>
<h4 id="exact_hit">exact_hit</h4>
<p>Field-level, boolean, whether a query was a full and exact match of
the entire current field (that is, after normalization, morphology,
etc). Used in the SPH04 ranker.</p>
<h4 id="exact_order">exact_order</h4>
<p>Field-level, boolean, whether all of the query keywords were matched
in the current field in the exact query order. (In other words, whether
our field “covers” the entire query, and in the right order, too.)</p>
<p>For example, <code>(microsoft office)</code> query would yield
<code>exact_order = 1</code> in a field with the
<code>We use Microsoft software in our office.</code> content.</p>
<p>However, the very same query in a field with
<code>(Our office is Microsoft free.)</code> text would yield
<code>exact_order = 0</code> because, while the coverage is there (all
words are matched), the order is wrong.</p>
<h4 id="full_field_hit">full_field_hit</h4>
<p>Field-level, boolean, whether the current field was (seemingly) fully
covered by the query.</p>
<p>This flag should be set when all the <em>field</em> keywords are
matched by the query, in whatever order. In other words, this factor
requires “full coverage” of the field by the query, and “allows” to
reorder the words.</p>
<p>For example, a field <code>three one</code> should get
<code>full_field_hit = 1</code> against a query
<code>one two three</code>. Both keywords were “covered” (matched), and
the order does not matter.</p>
<p>Note that all documents where <code>exact_field_hit = 1</code> (which
is even more strict) must also get <code>full_field_hit = 1</code>, but
not vice versa.</p>
<p>Also, beware that stopwords and other text processing tools might
“break” this factor, for exactly the same reasons that we discussed a
little earlier in <a href="#exact_field_hit">exact_field_hit</a>.</p>
<h4 id="has_digit_hits">has_digit_hits</h4>
<p>Field-level, total matched field hits count over just the
<code>has_digit</code> keywords.</p>
<h4 id="hit_count">hit_count</h4>
<p>Field-level, total field hits count over all keywords. In other
words, total number of keyword occurrences that were matched in the
current field.</p>
<p>Note that a single keyword may occur (and match!) multiple times. For
example, if <code>hello</code> occurs 3 times in a field and
<code>world</code> occurs 5 times, <code>hit_count</code> will be 8.</p>
<h4 id="is_noun_hits">is_noun_hits</h4>
<p>Field-level, total matched field hits count over just the
<code>is_noun</code> keywords.</p>
<h4 id="is_latin_hits">is_latin_hits</h4>
<p>Field-level, total matched field hits count over just the
<code>is_latin</code> keywords.</p>
<h4 id="is_number_hits">is_number_hits</h4>
<p>Field-level, total matched field hits count over just the
<code>is_number</code> keywords.</p>
<h4 id="lccs">lccs</h4>
<p>Field-level, Longest Common Contiguous Subsequence. A length of the
longest contiguous subphrase between the query and the document,
computed in keywords.</p>
<p>LCCS factor is rather similar to LCS but, in a sense, more
restrictive. While LCS could be greater than 1 even though no two query
words are matched right next to each other, LCCS would only get greater
than 1 if there are <em>exact</em>, contiguous query subphrases in the
document.</p>
<p>For example, <code>one two three four five</code> query vs
<code>one hundred three hundred five hundred</code> document would yield
<code>lcs = 3</code>, but <code>lccs = 1</code>, because even though
mutual dispositions of 3 matched keywords (<code>one</code>,
<code>three</code>, and <code>five</code>) do match between the query
and the document, none of the occurrences are actually next to each
other.</p>
<p>Note that LCCS still does not differentiate between the frequent and
rare keywords; for that, see WLCCS factor.</p>
<h4 id="lcs">lcs</h4>
<p>Field-level, Longest Common Subsequence. This is the length of a
maximum “verbatim” match between the document and the query, counted in
words.</p>
<p>By construction, it takes a minimum value of 1 when only “stray”
keywords were matched in a field, and a maximum value of a query length
(in keywords) when the entire query was matched in a field “as is”, in
the exact query order.</p>
<p>For example, if the query is <code>hello world</code> and the field
contains these two words as a subphrase anywhere in the field,
<code>lcs</code> will be 2. Another example, this works on
<em>subsets</em> of the query too, ie. with
<code>hello world program</code> query the field that only contains
<code>hello world</code> subphrase also a gets an <code>lcs</code> value
of 2.</p>
<p>Note that any <em>non-contiguous</em> subset of the query keyword
works here, not just a subset of adjacent keywords. For example, with
<code>hello world program</code> query and
<code>hello (test program)</code> field contents, <code>lcs</code> will
be 2 just as well, because both <code>hello</code> and
<code>program</code> matched in the same respective positions as they
were in the query. In other words, both the query and field match a
non-contiguous 2-keyword subset <code>hello * program</code> here, hence
the value of 2 of <code>lcs</code>.</p>
<p>However, if we keep the <code>hello world program</code> query but
our field changes to <code>hello (test computer program)</code>, then
the longest matching subset is now only 1-keyword long (two subsets
match here actually, either <code>hello</code> or <code>program</code>),
and <code>lcs</code> is therefore 1.</p>
<p>Finally, if the query is <code>hello world program</code> and the
field contains an exact match <code>hello world program</code>,
<code>lcs</code> will be 3. (Hopefully that is unsurprising at this
point.</p>
<h4 id="max_idf">max_idf</h4>
<p>Field-level, <code>max(idf)</code> over all keywords that were
matched in the field.</p>
<h4 id="max_window_hits">max_window_hits()</h4>
<p>Field-level, parametrized, computes
<code>max(window_hit_count)</code> over all N-keyword windows (where N
is the parameter). For example:</p>
<div class="sourceCode" id="cb325"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span>, weight() <span class="kw">FROM</span> test1 <span class="kw">WHERE</span> MATCH(<span class="st">&#39;one two&#39;</span>)</span>
<span id="cb325-2"><a href="#cb325-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">OPTION</span> ranker<span class="op">=</span>expr(<span class="st">&#39;sum(max_window_hits(3))&#39;</span>);</span>
<span id="cb325-3"><a href="#cb325-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------------+----------+</span></span>
<span id="cb325-4"><a href="#cb325-4" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | title             | weight() |</span>
<span id="cb325-5"><a href="#cb325-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------------+----------+</span></span>
<span id="cb325-6"><a href="#cb325-6" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> | one two           |        <span class="dv">2</span> |</span>
<span id="cb325-7"><a href="#cb325-7" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> | one aa two        |        <span class="dv">2</span> |</span>
<span id="cb325-8"><a href="#cb325-8" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">4</span> | one one aa bb two |        <span class="dv">1</span> |</span>
<span id="cb325-9"><a href="#cb325-9" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> | one aa bb two     |        <span class="dv">1</span> |</span>
<span id="cb325-10"><a href="#cb325-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------------+----------+</span></span>
<span id="cb325-11"><a href="#cb325-11" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>So in this example we are looking at rather short 3-keyword windows,
and in document number 3 our matched keywords are too far apart, so the
factor is 1. However, in document number 4 the <code>one one aa</code>
window has 2 occurrences (even though of just one keyword), so the
factor is 2 there. Documents number 1 and 2 are straightforward.</p>
<h4 id="min_best_span_pos">min_best_span_pos</h4>
<p>Field-level, the position of the first maximum LCS keyword span.</p>
<p>For example, assume that our query was
<code>hello world program</code>, and that the <code>hello world</code>
subphrase was matched twice in the current field, in positions 13 and
21. Now assume that <code>hello</code> and <code>world</code>
additionally occurred elsewhere in the field (say, in positions 5, 8,
and 34), but as those occurrences were not next to each other, they did
not count as a subphrase match. In this example,
<code>min_best_span_pos</code> will be 13, ie. the position of a first
occurrence of a longest (maximum) match, LCS-wise.</p>
<p>Note how for the single keyword queries
<code>min_best_span_pos</code> must always equal
<code>min_hit_pos</code>.</p>
<h4 id="min_gaps">min_gaps</h4>
<p>Field-level, the minimum number of positional gaps between (just) the
keywords matched in field. Always 0 when less than 2 keywords match;
always greater or equal than 0 otherwise.</p>
<p>For example, with the same <code>big wolf</code> query,
<code>big bad wolf</code> field would yield <code>min_gaps = 1</code>;
<code>big bad hairy wolf</code> field would yield
<code>min_gaps = 2</code>; <code>the wolf was scary and big</code> field
would yield <code>min_gaps = 3</code>; etc. However, a field like
<code>i heard a wolf howl</code> would yield <code>min_gaps = 0</code>,
because only one keyword would be matching in that field, and,
naturally, there would be no gaps <em>matched</em> keywords.</p>
<p>Therefore, this is a rather low-level, “raw” factor that you would
most likely want to <em>adjust</em> before actually using for
ranking.</p>
<p>Specific adjustments depend heavily on your data and the resulting
formula, but here are a few ideas you can start with:</p>
<ul>
<li>any <code>min_gaps</code> based boosts could be simply ignored when
<code>word_count &lt; 2</code>;</li>
<li>non-trivial <code>min_gaps</code> values (ie. when
<code>word_count &lt;= 2</code>) could be clamped with a certain “worst
case” constant while trivial values (ie. when <code>min_gaps = 0</code>
and <code>word_count &lt; 2</code>) could be replaced by that
constant;</li>
<li>a transfer function like <code>1 / (1 + min_gaps)</code> could be
applied (so that better, smaller min_gaps values would maximize it and
worse, bigger <code>min_gaps</code> values would fall off slowly).</li>
</ul>
<h4 id="min_hit_pos">min_hit_pos</h4>
<p>Field-level, the position of the first matched keyword occurrence,
counted in words. Positions begins from 1, so
<code>min_hit_pos = 0</code> must be impossible in an actually matched
field.</p>
<h4 id="min_idf">min_idf</h4>
<p>Field-level, <code>min(idf)</code> over all keywords (not
occurrences!) that were matched in the field.</p>
<h4 id="phrase_decay10">phrase_decay10</h4>
<p>Field-level, position-decayed (0.5 decay per 10 positions) and
proximity-based “similarity” of a matched field to the query interpreted
as a phrase.</p>
<p>Ranges from 0.0 to 1.0, and maxes out at 1.0 when the entire field is
a query phrase repeated one or more times. For instance,
<code>[cats dogs]</code> query will yield
<code>phrase_decay10 = 1.0</code> against
<code>title = [cats dogs cats dogs]</code> field (with two repeats), or
just <code>title = [cats dogs]</code>, etc.</p>
<p>Note that <code>[dogs cats]</code> field yields a smaller
<code>phrase_decay10</code> because of no phrase match. The exact value
is going to vary because it also depends on IDFs. For instance:</p>
<div class="sourceCode" id="cb326"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, title, weight() <span class="kw">from</span> rt</span>
<span id="cb326-2"><a href="#cb326-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">where</span> match(<span class="st">&#39;cats dogs&#39;</span>)</span>
<span id="cb326-3"><a href="#cb326-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">option</span> ranker<span class="op">=</span>expr(<span class="st">&#39;sum(phrase_decay10)&#39;</span>);</span>
<span id="cb326-4"><a href="#cb326-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------+---------------------+------------+</span></span>
<span id="cb326-5"><a href="#cb326-5" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>     | title               | weight()   |</span>
<span id="cb326-6"><a href="#cb326-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------+---------------------+------------+</span></span>
<span id="cb326-7"><a href="#cb326-7" aria-hidden="true" tabindex="-1"></a>| <span class="dv">400001</span> | cats dogs           |        <span class="fl">1.0</span> |</span>
<span id="cb326-8"><a href="#cb326-8" aria-hidden="true" tabindex="-1"></a>| <span class="dv">400002</span> | cats dogs cats dogs |        <span class="fl">1.0</span> |</span>
<span id="cb326-9"><a href="#cb326-9" aria-hidden="true" tabindex="-1"></a>| <span class="dv">400003</span> | dogs cats           | <span class="fl">0.87473994</span> |</span>
<span id="cb326-10"><a href="#cb326-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------+---------------------+------------+</span></span>
<span id="cb326-11"><a href="#cb326-11" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>The signal calculation is somewhat similar to ATC. We begin with
assigning an exponentially discounted, position-decayed IDF weight to
every matched hit. The number 10 in the signal name is in fact the
half-life distance, so that the decay coefficient is 1.0 at position 1,
0.5 at position 11, 0.25 at 21, etc. Then for each adjacent hit we
multiply the per-hits weights and obtain the pair weight; compute an
expected adjacent hit position (ie. where it should had been in the
ideal phrase match case); and additionally decay the pair weight based
on the difference between the expected and actual position. In the end,
we also perform normalization so that the signal fits into 0 to 1
range.</p>
<p>To summarize, the signal decays when hits are more sparse and/or in a
different order in the field than in the query, and also decays when the
hits are farther from the beginning of the field, hence the
“phrase_decay” name.</p>
<p>Note that this signal calculation is relatively heavy, also similarly
to <code>atc</code> signal. Even though we actually did not observe any
significant slowdowns on our production workloads, neither on average
nor at 99th percentile, your mileage may vary, because our synthetic
<em>worst case</em> test queries were significantly slower on our tests,
up to 2x and more in extreme cases. For that reason we also added
<code>no_decay=1</code> flag to <code>FACTORS()</code> that lets you
skip computing this signal at all if you do not actually use it.</p>
<h4 id="phrase_decay30">phrase_decay30</h4>
<p>Field-level, position-decayed (0.5 decay per 30 positions) and
proximity-based “similarity” of a matched field to the query interpreted
as a phrase.</p>
<p>Completely similar to <code>phrase_decay10</code> signal, except that
the position-based half-life is 30 rather than 10. In other words,
<code>phrase_decay30</code> decays somewhat slower based on the in-field
position (for example, decay coefficient is going to be 0.5 rather than
0.125 at position 31). Therefore it penalizes more “distant” matches
less than <code>phrase_decay10</code> would.</p>
<h4 id="sum_idf">sum_idf</h4>
<p>Field-level, <code>sum(idf)</code> over all keywords (not
occurrences!) that were matched in the field.</p>
<h4 id="sum_idf_boost">sum_idf_boost</h4>
<p>Field-level, <code>sum(idf_boost)</code> over all keywords (not
occurrences!) that were matched in the field.</p>
<h4 id="tf_idf">tf_idf</h4>
<p>Field-level, a sum of <code>tf*idf</code> over all the keywords
matched in the field. (Or, naturally, a sum of <code>idf</code> over all
the matched postings.)</p>
<p>For the record, <code>TF</code> is the Term Frequency, aka the number
of (matched) keyword occurrences in the current field.</p>
<p>And <code>IDF</code> is the Inverse Document Frequency, a floating
point value between 0 and 1 that describes how frequent this keyword is
in the index.</p>
<p>Basically, frequent (and therefore <em>not</em> really interesting)
words get lower IDFs, hitting the minimum value of 0 when the keyword is
present in all of the indexed documents. And vice versa, rare, unique,
and therefore interesting words get higher IDFs, maxing out at 1 for
unique keywords that occur in just a single document.</p>
<h4 id="trf_aqt">trf_aqt</h4>
<p>Field-level, float, a fraction of alphanumeric-only query trigrams
matched by the field trigrams filter. Takes values in 0..1 range.</p>
<p>See <a href="#ranking-trigrams-and-bpe-tokens">“Ranking: trigrams and
BPE tokens”</a> section for more details.</p>
<h4 id="trf_i2f">trf_i2f</h4>
<p>Field-level, float, a ratio of query-and-field intersection filter
bitcount to field filter bitcount (Intersection to Field). Takes values
in 0..1 range.</p>
<p>See <a href="#ranking-trigrams-and-bpe-tokens">“Ranking: trigrams and
BPE tokens”</a> section for more details.</p>
<h4 id="trf_i2q">trf_i2q</h4>
<p>Field-level, float, a ratio of query-and-field intersection filter
bitcount to query filter bitcount (Intersection to Query). Takes values
in 0..1 range.</p>
<p>See <a href="#ranking-trigrams-and-bpe-tokens">“Ranking: trigrams and
BPE tokens”</a> section for more details.</p>
<h4 id="trf_i2u">trf_i2u</h4>
<p>Field-level, float, a ratio of query-and-field intersection filter
bitcount to query-or-field union filter bitcount (Intersection to
Union). Takes values in 0..1 range.</p>
<p>See <a href="#ranking-trigrams-and-bpe-tokens">“Ranking: trigrams and
BPE tokens”</a> section for more details.</p>
<h4 id="trf_naqt">trf_naqt</h4>
<p>Field-level, float, a number of alphanumeric-only query trigrams
matched by the field trigrams filter. Takes non-negative integer values
(ie. 0, 1, 2, etc), but stored as float anyway, for consistency.</p>
<p>See <a href="#ranking-trigrams-and-bpe-tokens">“Ranking: trigrams and
BPE tokens”</a> section for more details.</p>
<h4 id="trf_qt">trf_qt</h4>
<p>Field-level, float, a fraction of query trigrams matched by the field
trigrams filter. Either in 0..1 range, or -1 when there is no field
filter.</p>
<p>See <a href="#ranking-trigrams-and-bpe-tokens">“Ranking: trigrams and
BPE tokens”</a> section for more details.</p>
<h4 id="user_weight">user_weight</h4>
<p>Field-level, a user specified per-field weight (for a bit more
details on how to set those, refer to <a
href="sphinx2.html#sphinxql-select"><code>OPTION field_weights</code></a>
section). By default all these weights are set to 1.</p>
<h4 id="wlccs">wlccs</h4>
<p>Field-level, Weighted Longest Common Contiguous Subsequence. A sum of
IDFs over the keywords of the longest contiguous subphrase between the
current query and the field.</p>
<p>WLCCS is computed very similarly to LCCS, but every “suitable”
keyword occurrence increases it by the keyword IDF rather than just by 1
(which is the case with both LCS and LCCS). That lets us rank sequences
of more rare and important keywords higher than sequences of frequent
keywords, even if the latter are longer. For example, a query
<code>Zanzibar bed and breakfast</code> would yield
<code>lccs = 1</code> against a <code>hotels of Zanzibar</code> field,
but <code>lccs = 3</code> against a
<code>London bed and breakfast</code> field, even though
<code>Zanzibar</code> could be actually somewhat more rare than the
entire <code>bed and breakfast</code> phrase. WLCCS factor alleviates
(to a certain extent) by accounting the keyword frequencies.</p>
<h4 id="word_count">word_count</h4>
<p>Field-level, the number of unique keywords matched in the field. For
example, if both <code>hello</code> and <code>world</code> occur in the
current field, <code>word_count</code> will be 2, regardless of how many
times do both keywords occur.</p>
<h2 id="ranking-built-in-ranker-formulas">Ranking: built-in ranker
formulas</h2>
<p>All of the built-in Sphinx lightweight rankers can be reproduced
using the expression based ranker. You just need to specify a proper
formula in the <code>OPTION ranker</code> clause.</p>
<p>This is definitely going to be (significantly) slower than using the
built-in rankers, but useful when you start fine-tuning your ranking
formulas using one of the built-in rankers as your baseline.</p>
<p>(Also, the formulas define the nitty gritty built-in ranker details
in a nicely readable fashion.)</p>
<table>
<colgroup>
<col style="width: 17%" />
<col style="width: 82%" />
</colgroup>
<thead>
<tr class="header">
<th>Ranker</th>
<th>Formula</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>PROXIMITY_BM15</td>
<td><code>sum(lcs*user_weight)*10000 + bm15</code></td>
</tr>
<tr class="even">
<td>BM15</td>
<td><code>bm15</code></td>
</tr>
<tr class="odd">
<td>NONE</td>
<td><code>1</code></td>
</tr>
<tr class="even">
<td>WORDCOUNT</td>
<td><code>sum(hit_count*user_weight)</code></td>
</tr>
<tr class="odd">
<td>PROXIMITY</td>
<td><code>sum(lcs*user_weight)</code></td>
</tr>
<tr class="even">
<td>MATCHANY</td>
<td><code>sum((word_count + (lcs - 1)*max_lcs)*user_weight)</code></td>
</tr>
<tr class="odd">
<td>FIELDMASK</td>
<td><code>field_mask</code></td>
</tr>
<tr class="even">
<td>SPH04</td>
<td><code>sum((4*lcs + 2*(min_hit_pos==1) + exact_hit)*user_weight)*10000 + bm15</code></td>
</tr>
</tbody>
</table>
<p>And here goes a complete example query:</p>
<div class="sourceCode" id="cb327"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb327-1"><a href="#cb327-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, weight() <span class="kw">FROM</span> test1</span>
<span id="cb327-2"><a href="#cb327-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>)</span>
<span id="cb327-3"><a href="#cb327-3" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> ranker<span class="op">=</span>expr(<span class="st">&#39;sum(lcs*user_weight)*10000 + bm15&#39;</span>)</span></code></pre></div>
<h2 id="ranking-idf-magics">Ranking: IDF magics</h2>
<p>Sphinx supports several different IDF (Inverse Document Frequency)
calculation options. Those can affect your relevance ranking (aka
scoring) when you are:</p>
<ul>
<li><em>either</em> sharding your data, even with built-in rankers;</li>
<li><em>or</em> doing any custom ranking work, even on a single
shard.</li>
</ul>
<p>By default, term IDFs are (a) per-shard, and (b) computed online. So
they might fluctuate significantly when ranking. And several other
ranking factors rely on them, so the entire rank might change a lot in a
seemingly random fashion. The reasons are twofold.</p>
<p>First, IDFs usually differ across shards (ie. individual indexes that
make up a bigger combined index). This means that a completely identical
document might rank differently depending on a specific shard it ends up
in. Not great.</p>
<p>Second, IDFs might change from query to query, as you update the
index data. That instability in time might or might not be a desired
effect.</p>
<p>And IDFs are <strong>extremely</strong> important for ranking. They
directly affect our fast simple built-in rankers
(<code>PROXIMITY_BM15</code> and <code>SPH04</code>), and all the BM25
ranking signals, and many other ranking signals that internally utilize
IDFs. This isn’t really an issue as long as you’re using simple
monolithic indexes. But if you’re doing any serious ranking work at
scale, then these IDF differences quickly become quite an issue: for
one, immediately as you start <strong>sharding</strong> (even locally,
within just one server).</p>
<p>To help alleviate these quirks (if they affect your use case), Sphinx
offers two features:</p>
<ol type="1">
<li><code>local_df</code> option to aggregate sharded IDFs.</li>
<li><code>global_idf</code> feature to enforce prebuilt static
IDFs.</li>
</ol>
<p><code>local_df</code> syntax is
<code>SELECT ... OPTION local_df=1</code> and enabling that option tells
the query to compute IDFs (more) precisely, ie. over the entire index
rather than individual shards. The default value is 0 (off) for
performance reasons.</p>
<p><code>global_idf</code> feature is more complicated and includes
several components:</p>
<ul>
<li><code>indextool dumpdict --stats</code> command that generates the
source data, ie. the per-shard dictionary dumps;</li>
<li><code>indextool buildidf</code> command that builds a static IDF
file from those;</li>
<li>per-shard <code>global_idf</code> config directive that lets you
assign a static IDF file to your shards;</li>
<li>per-query <code>OPTION global_idf=1</code> that forces the query to
use that file.</li>
</ul>
<p>Both these features affect the input variables used for IDF
calculations. More specifically:</p>
<ul>
<li>let <code>n</code> be the DF, document frequency (for a given
term);</li>
<li>let <code>N</code> be the corpus size, total number of
documents;</li>
<li>by default, both <code>n</code> and <code>N</code> are
per-shard;</li>
<li>with <code>local_df</code>, they both are summed across shards;</li>
<li>with <code>global_idf</code>, they both are taken from a static IDF
file.</li>
</ul>
<h3 id="using-global-idfs">Using global IDFs</h3>
<p>So what’s inside an IDF file?</p>
<p>To reiterate, global IDFs are needed to stabilize IDFs across
multiple machines and/or index shards. They literally are big stupid
“keyword to frequency” tables in binary format. Or, in those
<code>n</code> and <code>N</code> variables we just defined…</p>
<p>The static <code>global_idf</code> file actually stores a bunch of
<code>n</code> values for every individual term, and one <code>N</code>
value for the entire corpus. All such stored values are summed over all
the source files that were available to <code>indextool buildidf</code>
command.</p>
<p>Current (dynamic) DF values will be used at search time for any terms
not stored in the static <code>global_idf</code> file.
<code>local_df</code> will also still affect those DFs.</p>
<p>To avoid overflows, <code>N</code> is adjusted up for the actual
corpus size. Meaning that, for example, if the <code>global_idf</code>
file says there were 1000 documents, but your index carries 3000
documents, then <code>N</code> is set to the bigger value, ie. 3000.
Therefore, you should either avoid using too small data slices for
dictionary dumps, and/or manually adjust the frequencies, otherwise your
static IDFs might be quite off.</p>
<p>For the record, the terms themselves are not stored, and replaced
with 64-bit hashes instead. Collisions are possible in theory but
negligible in practice.</p>
<p>So how to build that IDF file?</p>
<p>You do that with <code>indextool</code>, in steps:</p>
<ol type="1">
<li>first you dump text dictionaries using
<code>indextool dumpdict</code>;</li>
<li>then you convert those to binary format using
<code>indextool buildidf</code>;</li>
<li>then you (optionally) merge <code>.idf</code> files with
<code>indextool mergeidf</code>.</li>
</ol>
<p>To keep the <code>global_idf</code> file compact, you can use the
<code>--skip-uniq</code> switch to <code>indextool buildidf</code>
command when building IDFs. It filters out all terms that only occur
once at build stage. That greatly reduces the <code>.idf</code> file
size, and still yields exact or near-exact results.</p>
<p>IDF files are shared across multiple indexes. That is,
<code>searchd</code> only loads one copy of an IDF file, even when many
indexes refer to it. Should the contents of an IDF file change, the new
contents can be reloaded with a <code>SIGHUP</code> signal.</p>
<h3 id="how-sphinx-computes-idf">How Sphinx computes IDF</h3>
<p>In v.3.4 we finished cleaning the legacy IDF code. Before, we used to
support two different methods to compute IDF, and we used to have
dubious IDF scaling. All that legacy is now gone, finally and fully, and
we do not plan any further significant changes.</p>
<p>Nowadays, Sphinx <strong>always</strong> uses the following formula
to compute IDF from <code>n</code> (document frequency) and
<code>N</code> (corpus size).</p>
<ul>
<li><code>idf = min(log(N/n), IDF_LIMIT) * term_idf_boost</code></li>
<li><code>IDF_LIMIT</code> is currently hardcoded at 20.0</li>
</ul>
<p>So we start with de-facto standard <code>raw_idf = log(N/n)</code>;
then clamp it with <code>IDF_LIMIT</code> (and stop differentiating
between extremely rare keywords); then apply per-term user boosts from
the query.</p>
<p>Note how with the current limit of 20.0 “extremely rare”
<em>specifically</em> means that just the keywords that occur less than
once per as much as ~485.2 million tokens will be considered “equal” for
ranking purposes. We may eventually change this limit.</p>
<p><code>term_idf_boost</code> naturally defaults to <code>1.0</code>
but can be changed for individual query terms by using the respective <a
href="#keyword-modifiers">keyword modifier</a>, eg.
<code>... WHERE MATCH('cat^1.2 dog')</code>.</p>
<h2 id="ranking-field-lengths">Ranking: field lengths</h2>
<p>BM25 and BM25F ranking functions require both per-document and
index-average field lengths as one of their inputs. Otherwise they
degrade to a simpler, less powerful BM15 function.</p>
<p>For the record, lengths can be computed in different units here,
normally either bytes, or characters, or tokens. Leading to (slightly)
different variants of the BM functions. Each approach has its pros and
cons. In Sphinx we choose to have our lengths in tokens.</p>
<p>Now, with <code>index_field_lengths = 1</code> Sphinx automatically
keeps track of all those lengths on the fly. Per-document lengths are
stored and index-wide totals are updated on every index write. And then
those (dynamic!) index-wide totals are used to compute averages for BMs
on every full-text search.</p>
<p>Yet sometimes those are <em>too</em> dynamic, and you might require
<em>static</em> averages instead. Happens for a number of various
reasons. For one, “merely” to ensure consistency between training data
and production indexes. Or, ensure identical BM25s over different
cluster nodes. Pretty legit.</p>
<p><code>global_avg_field_lengths</code> index setting does exactly
that. It lets you specify <strong>static index-average field lengths for
BM25 calculations</strong>.</p>
<p>Note that you still need <code>index_field_lengths</code> enabled
because BM25 requires both per-document lengths <em>and</em>
index-average lengths. The new setting only specifies the latter.</p>
<p>The setting is per-index, so different values can be specified for
different indexes. It takes a comma-separated list of
<code>field: weight</code> pairs, as follows.</p>
<div class="sourceCode" id="cb328"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb328-1"><a href="#cb328-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> test1</span>
<span id="cb328-2"><a href="#cb328-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb328-3"><a href="#cb328-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb328-4"><a href="#cb328-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">global_avg_field_lengths</span> = title: 1.23, content: 45.67</span>
<span id="cb328-5"><a href="#cb328-5" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>For now Sphinx considers it okay to <em>not</em> specify a length
here. The unlisted fields lengths are set to 0.0 by default. Think of
system fields that should not even be ranked. Those need no extra
config.</p>
<p>However, when you <strong>do</strong> specify a field, you
<strong>must</strong> specify an existing one. Otherwise, that’s an
error.</p>
<p>Using <code>global_idf</code> and
<code>global_avg_field_lengths</code> in concert enables fully “stable”
BM25 calculations. With these two settings, most BM25 values should
become completely repeatable, rather than jittering a bit (or a lot)
over time from write to write, or across instances, or both.</p>
<p>Here’s an example with two indexes, <code>rt1</code> and
<code>rt2</code>, where the second one only differs in that we have
<code>global_avg_field_lengths</code> enabled. After the first 3 inserts
we get this.</p>
<div class="sourceCode" id="cb329"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, title, weight() <span class="kw">from</span> rt1 <span class="kw">where</span> match(<span class="st">&#39;la&#39;</span>)</span>
<span id="cb329-2"><a href="#cb329-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">option</span> ranker<span class="op">=</span>expr(<span class="st">&#39;bm25a(1.2,0.7)&#39;</span>);</span>
<span id="cb329-3"><a href="#cb329-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+-----------+</span></span>
<span id="cb329-4"><a href="#cb329-4" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | title                            | weight()  |</span>
<span id="cb329-5"><a href="#cb329-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+-----------+</span></span>
<span id="cb329-6"><a href="#cb329-6" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> | che la diritta via era smarrita  | <span class="fl">0.5055966</span> |</span>
<span id="cb329-7"><a href="#cb329-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+-----------+</span></span>
<span id="cb329-8"><a href="#cb329-8" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb329-9"><a href="#cb329-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-10"><a href="#cb329-10" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, title, weight() <span class="kw">from</span> rt2 <span class="kw">where</span> match(<span class="st">&#39;la&#39;</span>)</span>
<span id="cb329-11"><a href="#cb329-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">option</span> ranker<span class="op">=</span>expr(<span class="st">&#39;bm25a(1.2,0.7)&#39;</span>);</span>
<span id="cb329-12"><a href="#cb329-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+------------+</span></span>
<span id="cb329-13"><a href="#cb329-13" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | title                            | weight()   |</span>
<span id="cb329-14"><a href="#cb329-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+------------+</span></span>
<span id="cb329-15"><a href="#cb329-15" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> | che la diritta via era smarrita  |  <span class="fl">0.2640895</span> |</span>
<span id="cb329-16"><a href="#cb329-16" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+------------+</span></span>
<span id="cb329-17"><a href="#cb329-17" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>The BM25 values differ as expected, because dynamic averages in
<code>rt1</code> differ from the specific static ones in
<code>rt2</code>, but let’s what happens after just a few more rows.</p>
<div class="sourceCode" id="cb330"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb330-1"><a href="#cb330-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, title, weight() <span class="kw">from</span> rt1 <span class="kw">where</span> match(<span class="st">&#39;la&#39;</span>) <span class="kw">and</span> <span class="kw">id</span><span class="op">=</span><span class="dv">3</span></span>
<span id="cb330-2"><a href="#cb330-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">option</span> ranker<span class="op">=</span>expr(<span class="st">&#39;bm25a(1.2,0.7)&#39;</span>);</span>
<span id="cb330-3"><a href="#cb330-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+-----------+</span></span>
<span id="cb330-4"><a href="#cb330-4" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | title                            | weight()  |</span>
<span id="cb330-5"><a href="#cb330-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+-----------+</span></span>
<span id="cb330-6"><a href="#cb330-6" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> | che la diritta via era smarrita  | <span class="fl">0.5307667</span> |</span>
<span id="cb330-7"><a href="#cb330-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+-----------+</span></span>
<span id="cb330-8"><a href="#cb330-8" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb330-9"><a href="#cb330-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb330-10"><a href="#cb330-10" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, title, weight() <span class="kw">from</span> rt2 <span class="kw">where</span> match(<span class="st">&#39;la&#39;</span>) <span class="kw">and</span> <span class="kw">id</span><span class="op">=</span><span class="dv">3</span></span>
<span id="cb330-11"><a href="#cb330-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">option</span> ranker<span class="op">=</span>expr(<span class="st">&#39;bm25a(1.2,0.7)&#39;</span>);</span>
<span id="cb330-12"><a href="#cb330-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+------------+</span></span>
<span id="cb330-13"><a href="#cb330-13" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | title                            | weight()   |</span>
<span id="cb330-14"><a href="#cb330-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+------------+</span></span>
<span id="cb330-15"><a href="#cb330-15" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> | che la diritta via era smarrita  |  <span class="fl">0.2640895</span> |</span>
<span id="cb330-16"><a href="#cb330-16" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+------------+</span></span>
<span id="cb330-17"><a href="#cb330-17" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Comparing these we see how the dynamic averages in <code>rt1</code>
caused BM25 to shift from 0.506 to 0.531 while the static
<code>global_avg_field_lengths</code> in <code>rt2</code> kept BM25
static too. And repeatable. That’s exactly what this setting is
about.</p>
<h2 id="ranking-picking-fields-with-rank_fields">Ranking: picking fields
with <code>rank_fields</code></h2>
<p>When your indexes and queries contain any special “fake” keywords
(usually used to speedup matching), it makes sense to exclude those from
ranking. That can be achieved by putting such keywords into special
fields, and then using <code>OPTION rank_fields</code> clause in the
<code>SELECT</code> statement to pick the fields with actual text for
ranking. For example:</p>
<div class="sourceCode" id="cb331"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb331-1"><a href="#cb331-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, weight(), title <span class="kw">FROM</span> myindex</span>
<span id="cb331-2"><a href="#cb331-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world @sys _category1234&#39;</span>)</span>
<span id="cb331-3"><a href="#cb331-3" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> rank_fields<span class="op">=</span><span class="st">&#39;title content&#39;</span></span></code></pre></div>
<p><code>rank_fields</code> is designed to work as follows. Only the
keyword occurrences in the ranked fields get processed when computing
ranking factors. Any other occurrences are ignored (by ranking, that
is).</p>
<p>Note a slight caveat here: for <em>query-level</em> factors, only the
<em>query</em> itself can be analyzed, not the index data.</p>
<p>This means that when you do not explicitly specify the fields in the
query, the query parser <em>must</em> assume that the keyword can
actually occur anywhere in the document. And, for example,
<code>MATCH('hello world _category1234')</code> will compute
<code>query_word_count=3</code> for that reason. This query does indeed
have 3 keywords, even if <code>_category1234</code> never
<em>actually</em> occurs anywhere except <code>sys</code> field.</p>
<p>Other than that, <code>rank_fields</code> is pretty straightforward.
<em>Matching</em> will still work as usual. But for <em>ranking</em>
purposes, any occurrences (hits) from the “system” fields can be ignored
and hidden.</p>
<h2 id="xfactors">Ranking: using different keywords than matching</h2>
<p>Text ranking signals are usually computed using <code>MATCH()</code>
query keywords. However, sometimes matching and ranking would need to
diverge. To support that, starting from v.3.5 you can <strong>explicitly
specify a set of keywords to rank</strong> via a text argument to
<code>FACTORS()</code> function.</p>
<p>Moreover, that works even when there is no <code>MATCH()</code>
clause at all. Meaning that you can now <strong>match by attributes
only, and then rank matches by keywords</strong>.</p>
<p>Examples!</p>
<div class="sourceCode" id="cb332"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb332-1"><a href="#cb332-1" aria-hidden="true" tabindex="-1"></a># match <span class="kw">with</span> additional special keywords, <span class="fu">rank</span> <span class="kw">without</span> them</span>
<span id="cb332-2"><a href="#cb332-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, FACTORS(<span class="st">&#39;hello world&#39;</span>) <span class="kw">FROM</span> myindex</span>
<span id="cb332-3"><a href="#cb332-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world @location locid123&#39;</span>)</span>
<span id="cb332-4"><a href="#cb332-4" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> ranker<span class="op">=</span>expr(<span class="st">&#39;1&#39;</span>)</span>
<span id="cb332-5"><a href="#cb332-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb332-6"><a href="#cb332-6" aria-hidden="true" tabindex="-1"></a># match <span class="kw">by</span> <span class="kw">attributes</span>, <span class="fu">rank</span> those matches <span class="kw">by</span> keywords</span>
<span id="cb332-7"><a href="#cb332-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, FACTORS(<span class="st">&#39;hello world&#39;</span>) <span class="kw">FROM</span> myindex</span>
<span id="cb332-8"><a href="#cb332-8" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> location_id<span class="op">=</span><span class="dv">123</span></span>
<span id="cb332-9"><a href="#cb332-9" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> ranker<span class="op">=</span>expr(<span class="st">&#39;1&#39;</span>)</span></code></pre></div>
<p>These two queries match documents quite differently, and they will
return different sets of documents, too. Still, the matched documents in
both sets must get <em>ranked</em> identically, using the provided
keywords. That is, for any document that makes it into any of the two
result sets, <code>FACTORS()</code> gets computed as if that document
was matched using <code>MATCH('hello world')</code>, no matter what the
actual <code>WHERE</code> clause looked like.</p>
<p>We refer to the keywords passed to <code>FACTORS()</code> as
<strong>the ranking query</strong>, while the keywords and operators
from the <code>MATCH()</code> clause are <strong>the matching
query</strong>.</p>
<p><strong>Explicit ranking queries are treated as BOWs</strong>, ie.
bags-of-words. Now, some of our ranking signals do account for the
“in-query” keyword positions, eg. LCS, to name one. So <strong>BOW
keyword order still matters</strong>, and randomly shuffling the
keywords may and will change (some of) the ranking signals.</p>
<p>But other than that, <strong>there is no syntax support in the
ranking queries</strong>, and that creates two subtle differences from
the matching queries.</p>
<ol type="1">
<li>Human-readable operators are considered keywords.</li>
<li>Operator NOT is ignored rather than accounted.</li>
</ol>
<p>Re human-readable operators, consider <code>cat MAYBE dog</code>
query. <code>MAYBE</code> is a proper matching operator according to
<code>MATCH()</code> query syntax, and the default BOW used for ranking
will have two keywords, <code>cat</code> and <code>dog</code>. But with
<code>FACTORS()</code> that <code>MAYBE</code> also gets used for
ranking, so we get three keywords in a BOW that way: <code>cat</code>,
<code>maybe</code>, <code>dog</code>.</p>
<p>Re operator NOT, consider <code>year -end</code> (with a space).
Again, <code>MATCH()</code> syntax dictates that <code>end</code> is an
excluded term here, so the default BOW is just <code>year</code>, while
the <code>FACTORS()</code> BOW is <code>year</code> and <code>end</code>
both.</p>
<p>Bottom line, <strong>avoid using Sphinx query syntax in ranking
queries</strong>. Queries with full-text operators may misbehave. Those
are intended for <code>MATCH()</code> only. On the other hand, passing
end-user syntax-less queries to <code>FACTORS()</code> should be a
breeze! Granted, those queries need some sanitizing anyway, as long as
you use them in <code>MATCH()</code> too, which ones usually does. Fun
fact, even that sanitizing should not be really needed for
<code>FACTORS()</code> though.</p>
<p>Now, unlike syntax, <strong>morphology is fully supported in the
ranking queries</strong>. Exceptions, mappings, stemmers, lemmatizers,
user morphology dictionaries, all that jazz is expected to work
fine.</p>
<p><strong>Ranking query keywords can be arbitrary.</strong> You can
rank the document anyhow you want. Matching becomes unrelated and does
not impose any restrictions.</p>
<p>As an important corollary, <strong>documents may now have 0 ranking
keywords</strong>, and therefore <strong>signals may now get completely
zeroed out</strong> (but only with the new ranking queries, of course).
The <code>doc_word_count</code> signal is an obvious example.
Previously, you would <em>never</em> ever see a zero
<code>doc_word_count</code>, now that can happen, and <strong>your
ranking formulas or ML models may need updating</strong>.</p>
<div class="sourceCode" id="cb333"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb333-1"><a href="#cb333-1" aria-hidden="true" tabindex="-1"></a># good <span class="kw">old</span> match <span class="kw">is</span> still good, <span class="kw">no</span> problem there</span>
<span id="cb333-2"><a href="#cb333-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, WEIGHT()</span>
<span id="cb333-3"><a href="#cb333-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> myindex <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>)</span>
<span id="cb333-4"><a href="#cb333-4" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> ranker<span class="op">=</span>expr(<span class="st">&#39;1/doc_word_count&#39;</span>)</span>
<span id="cb333-5"><a href="#cb333-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb333-6"><a href="#cb333-6" aria-hidden="true" tabindex="-1"></a># potential division <span class="kw">by</span> zero!</span>
<span id="cb333-7"><a href="#cb333-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, WEIGHT(), FACTORS(<span class="st">&#39;workers unite&#39;</span>)</span>
<span id="cb333-8"><a href="#cb333-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> myindex <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>)</span>
<span id="cb333-9"><a href="#cb333-9" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> ranker<span class="op">=</span>expr(<span class="st">&#39;1/doc_word_count&#39;</span>)</span></code></pre></div>
<p>And to reiterate just once, <strong>you can completely omit the
matching text query</strong> (aka the <code>MATCH()</code> clause), and
still have the retrieved documents ranked. <strong>Match by attributes,
rank by keywords</strong>, now legal, whee!</p>
<div class="sourceCode" id="cb334"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, FACTORS(<span class="st">&#39;lorem ipsum&#39;</span>), <span class="kw">id</span> % <span class="dv">27</span> <span class="kw">AS</span> val</span>
<span id="cb334-2"><a href="#cb334-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> myindex <span class="kw">WHERE</span> val <span class="op">&gt;</span> <span class="dv">10</span></span>
<span id="cb334-3"><a href="#cb334-3" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> ranker<span class="op">=</span>expr(<span class="st">&#39;1&#39;</span>)</span></code></pre></div>
<p>Finally, there are a few more rather specific and subtle restrictions
related to ranking queries.</p>
<ul>
<li>Expression ranker (<code>OPTION ranker=expr('...')</code>) is
required.</li>
<li>The same ranking query across all <code>FACTORS()</code> instances
is required.</li>
<li>When there is no <code>MATCH()</code> clause, “direct” filtering or
sorting by values that depend on <code>FACTORS()</code> is forbidden.
You can use subselects for that.</li>
</ul>
<div class="sourceCode" id="cb335"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb335-1"><a href="#cb335-1" aria-hidden="true" tabindex="-1"></a># <span class="kw">NOT</span> OK! different ranking queries, <span class="kw">not</span> supported</span>
<span id="cb335-2"><a href="#cb335-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>,</span>
<span id="cb335-3"><a href="#cb335-3" aria-hidden="true" tabindex="-1"></a>  udf1(factors(<span class="st">&#39;lorem ipsum&#39;</span>)) <span class="kw">AS</span> w1,</span>
<span id="cb335-4"><a href="#cb335-4" aria-hidden="true" tabindex="-1"></a>  udf2(factors(<span class="st">&#39;dolor sit&#39;</span>)) <span class="kw">AS</span> w2</span>
<span id="cb335-5"><a href="#cb335-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> idx</span>
<span id="cb335-6"><a href="#cb335-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb335-7"><a href="#cb335-7" aria-hidden="true" tabindex="-1"></a># <span class="kw">NOT</span> OK! filtering <span class="kw">on</span> factors() w<span class="op">/</span>o match() <span class="kw">is</span> forbidden</span>
<span id="cb335-8"><a href="#cb335-8" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, rankudf(factors(<span class="st">&#39;lorem ipsum&#39;</span>)) <span class="kw">AS</span> w</span>
<span id="cb335-9"><a href="#cb335-9" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> idx <span class="kw">WHERE</span> w <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb335-10"><a href="#cb335-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb335-11"><a href="#cb335-11" aria-hidden="true" tabindex="-1"></a># <span class="kw">NOT</span> OK! sorting <span class="kw">on</span> factors() w<span class="op">/</span>o match() <span class="kw">is</span> forbidden</span>
<span id="cb335-12"><a href="#cb335-12" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, rankudf(factors(<span class="st">&#39;lorem ipsum&#39;</span>)) <span class="kw">AS</span> w</span>
<span id="cb335-13"><a href="#cb335-13" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> idx <span class="kw">ORDER</span> <span class="kw">BY</span> w <span class="kw">DESC</span></span>
<span id="cb335-14"><a href="#cb335-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb335-15"><a href="#cb335-15" aria-hidden="true" tabindex="-1"></a># ok, but we can <span class="kw">use</span> subselect <span class="kw">to</span> workaround that</span>
<span id="cb335-16"><a href="#cb335-16" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> (</span>
<span id="cb335-17"><a href="#cb335-17" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, rankudf(factors(<span class="st">&#39;lorem ipsum&#39;</span>)) <span class="kw">AS</span> w <span class="kw">FROM</span> idx</span>
<span id="cb335-18"><a href="#cb335-18" aria-hidden="true" tabindex="-1"></a>) <span class="kw">WHERE</span> w <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb335-19"><a href="#cb335-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb335-20"><a href="#cb335-20" aria-hidden="true" tabindex="-1"></a># ok, sorting <span class="kw">on</span> factors() <span class="kw">with</span> match() does <span class="kw">work</span></span>
<span id="cb335-21"><a href="#cb335-21" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, rankudf(factors(<span class="st">&#39;lorem ipsum&#39;</span>)) <span class="kw">AS</span> w</span>
<span id="cb335-22"><a href="#cb335-22" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> idx <span class="kw">WHERE</span> MATCH(<span class="st">&#39;dolor sit&#39;</span>) <span class="kw">ORDER</span> <span class="kw">BY</span> w <span class="kw">DESC</span></span></code></pre></div>
<h2 id="ranking-trigrams-and-bpe-tokens">Ranking: trigrams and BPE
tokens</h2>
<p>Similarity signals based on alternative field tokenization can
improve ranking. Sphinx supports character trigrams and BPE tokens as
two such extra tokenizers. The respective ranking gains are rather
small, while the CPU and storage usage are significant. Even for
<em>short</em> fields (such as document titles) naively using full,
exact alt-token sets and computing exact alt-token signals gets way too
expensive to justify those gains.</p>
<p>However, we found that using <strong>coarse alt-token sets</strong>
(precomputed and stored as <strong>tiny Bloom filters</strong>) also
yields measurable ranking improvements, while having only a very small
impact on performance: about just 1-5% extra CPU load both when indexing
and searching. So we added trigram and BPE indexing and ranking support
based on those Bloom filters.</p>
<p>Here’s a quick overview of the essentials.</p>
<ul>
<li><p>When indexing, we can compute and store a per-field
<strong>“alt-token filter”</strong>, ie. a tiny Bloom filter
<em>coarsely</em> representing the field text alt-tokens.</p></li>
<li><p>Alt-token filter indexing is optional and must be enabled
explicitly, using either the <code>index_trigram_fields</code> or
<code>index_bpetok_fields</code> directive.</p></li>
<li><p>Alt-token filters are not exclusive, ie. you can enable both
simultaneously.</p></li>
<li><p>When searching, we use those filters (where available) to compute
a few additional alt-token (trigram or BPE) ranking signals.</p></li>
<li><p>Alt-token signals are accessible via <code>FACTORS()</code>
function as usual; their names have a prefix (<code>trf_</code> for
Trigram Filter, or <code>bpe_</code> for BPE ones).</p></li>
<li><p>Alt-token signals are <em>always</em> available to ranking
expressions and UDFs, but for fields without the respective filters,
they are all zeroed out (except for <code>trf_qt</code> and
<code>bpe_qt</code> which equal -1 in that case).</p></li>
</ul>
<p>That’s basically all the high-level notes; now let’s move on to the
nitty-gritty details.</p>
<p>Both plain and RT indexes are supported. The Bloom filter size is
currently hardcoded at 128 bits (ie. 16 bytes) per each field. The
filters are stored as hidden system document attributes.</p>
<p>Trigram filter indexing can be enabled by the
<code>index_trigram_fields</code> directive, for example:</p>
<div class="sourceCode" id="cb336"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb336-1"><a href="#cb336-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index_trigram_fields</span> = title, keywords</span></code></pre></div>
<p>BPE token filter indexing requires two directives,
<code>index_bpetok_fields</code> and <code>bpe_merges_file</code>
directive, for example:</p>
<div class="sourceCode" id="cb337"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb337-1"><a href="#cb337-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index_bpetok_fields</span> = title, keywords</span>
<span id="cb337-2"><a href="#cb337-2" aria-hidden="true" tabindex="-1"></a><span class="ex">bpe_merges_file</span> = merges.txt</span></code></pre></div>
<p>BPE details including the <code>bpe_merges_file</code> format are
discussed below.</p>
<p>Expression ranker (ie. <code>OPTION ranker=expr(...)</code>) then
checks for such filters when searching, and computes a few extra signals
for fields that have them. Here is a brief reference table.</p>
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="header">
<th>Signal</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>xxx_qt</code></td>
<td>Fraction of Query tokens present in field filter</td>
</tr>
<tr class="even">
<td><code>xxx_i2u</code></td>
<td>Ratio of Intersection to Union filter bitcounts</td>
</tr>
<tr class="odd">
<td><code>xxx_i2q</code></td>
<td>Ratio of Intersection to Query filter bitcounts</td>
</tr>
<tr class="even">
<td><code>xxx_i2f</code></td>
<td>Ratio of Intersection to Field filter bitcounts</td>
</tr>
<tr class="odd">
<td><code>xxx_aqt</code></td>
<td>Fraction of Alphanum Query tokens present in field filter</td>
</tr>
<tr class="even">
<td><code>xxx_naqt</code></td>
<td>Number of Alphanum Query tokens</td>
</tr>
</tbody>
</table>
<p><code>xxx</code> is <code>trf</code> for trigrams and
<code>bpe</code> for BPE tokens. So the actual signal names will be
<code>trf_qt</code>, or <code>bpe_i2u</code>, and so on.</p>
<p>Alt-tokens are computed over almost raw field and query text. “Almost
raw” means that we still apply <code>charset_table</code> for case
folding, but perform no other text processing. Even the special
characters should be retained.</p>
<p>Alt-token sets are then heavily pruned, again both for field and
query text, and then squashed into Bloom filters. This step makes our
internal representations quite coarse.</p>
<p>However, it also ensures that even the longer input texts never
overflow the resulting filter. Pruning only keeps a few select tokens,
and the exact limit is derived based on the filter size. So that the
false positive rate after compressing the pruned alt-tokens into a
filter is still reasonable.</p>
<p>That’s rather important, because in all the signal computations the
engine uses those coarse values, ie. pruned alt-token sets first, then
filters built from those next. Meaning that signals values are
occasionally way off from what one would intuitively expect. Note that
for very short input texts (say, up to 10-20 characters) the filters
could still yield exact results. But that can not be
<em>guaranteed</em>; not even for texts that short.</p>
<p>That said, all the alt-token signals are
<strong>specifically</strong> computed as follows. Let’s introduce the
following short names:</p>
<ul>
<li><code>qt</code>, pruned set of query alt-tokens</li>
<li><code>aqt</code>, subset of alphanumeric-only query alt-tokens</li>
<li><code>QF</code>, query alt-tokens filter (built from
<code>qt</code>)</li>
<li><code>FF</code>, field alt-token filter (built when indexing)</li>
<li><code>popcount()</code>, population count, ie. number of set bits
(in a filter)</li>
</ul>
<p>In those terms, the signals are computed as follows:</p>
<div class="sourceCode" id="cb338"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a>xxx_qt <span class="op">=</span> <span class="bu">len</span>([x <span class="cf">for</span> x <span class="kw">in</span> qt <span class="cf">if</span> FF.probably_has(x)]) <span class="op">/</span> <span class="bu">len</span>(qt)</span>
<span id="cb338-2"><a href="#cb338-2" aria-hidden="true" tabindex="-1"></a>xxx_i2u <span class="op">=</span> popcount(QF <span class="op">&amp;</span> FF) <span class="op">/</span> popcount(QF <span class="op">|</span> FF)</span>
<span id="cb338-3"><a href="#cb338-3" aria-hidden="true" tabindex="-1"></a>xxx_i2q <span class="op">=</span> popcount(QF <span class="op">&amp;</span> FF) <span class="op">/</span> popcount(QF)</span>
<span id="cb338-4"><a href="#cb338-4" aria-hidden="true" tabindex="-1"></a>xxx_i2f <span class="op">=</span> popcount(QF <span class="op">&amp;</span> FF) <span class="op">/</span> popcount(FF)</span></code></pre></div>
<p>So-called “alphanum” alt-tokens are extracted from additionally
filtered query text, keeping just the terms completely made of latin
alphanumeric characters (ie. <code>[a-z0-9]</code> characters only), and
ignoring any other terms (ie. with special characters, or in national
languages, etc).</p>
<div class="sourceCode" id="cb339"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb339-1"><a href="#cb339-1" aria-hidden="true" tabindex="-1"></a>xxx_aqt <span class="op">=</span> <span class="bu">len</span>([x <span class="cf">for</span> x <span class="kw">in</span> aqt <span class="cf">if</span> FF.probably_has(x)]) <span class="op">/</span> <span class="bu">len</span>(aqt)</span>
<span id="cb339-2"><a href="#cb339-2" aria-hidden="true" tabindex="-1"></a>xxx_naqt <span class="op">=</span> <span class="bu">len</span>(aqt)</span></code></pre></div>
<p>Any divisions by zero must be checked and must return 0.0 rather than
infinity.</p>
<p>Naturally, as almost all these signals (except <code>xxx_naqt</code>)
are ratios, they are floats in the 0..1 range.</p>
<p>However, the leading <code>xxx_qt</code> ratio is at the moment also
reused to signal that the token filter is not available for the current
field. In that case it gets set to -1. So you want to clamp it by zero
in your ranking formulas and UDFs.</p>
<p>All these signals are always accessible in both ranking expressions
and UDFs, even if the index was built without trigrams. However, for
brevity they are suppressed from the <code>FACTORS()</code> output:</p>
<div class="sourceCode" id="cb340"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb340-1"><a href="#cb340-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, title, pp(factors()) <span class="kw">from</span> index_regular</span>
<span id="cb340-2"><a href="#cb340-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">where</span> match(<span class="st">&#39;Test It&#39;</span>) <span class="kw">limit</span> <span class="dv">1</span></span>
<span id="cb340-3"><a href="#cb340-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">option</span> ranker<span class="op">=</span>expr(<span class="st">&#39;sum(lcs)*10000+bm15&#39;</span>) \G</span>
<span id="cb340-4"><a href="#cb340-4" aria-hidden="true" tabindex="-1"></a><span class="op">***************************</span> <span class="fl">1.</span> <span class="kw">row</span> <span class="op">***************************</span></span>
<span id="cb340-5"><a href="#cb340-5" aria-hidden="true" tabindex="-1"></a>           <span class="kw">id</span>: <span class="dv">2702</span></span>
<span id="cb340-6"><a href="#cb340-6" aria-hidden="true" tabindex="-1"></a>        title: Flu<span class="op">....</span>test<span class="op">..</span>.</span>
<span id="cb340-7"><a href="#cb340-7" aria-hidden="true" tabindex="-1"></a>pp(factors()): {</span>
<span id="cb340-8"><a href="#cb340-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">&quot;bm15&quot;</span>: <span class="dv">728</span>,</span>
<span id="cb340-9"><a href="#cb340-9" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb340-10"><a href="#cb340-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">&quot;fields&quot;</span>: [</span>
<span id="cb340-11"><a href="#cb340-11" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb340-12"><a href="#cb340-12" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;field&quot;</span>: <span class="dv">0</span>,</span>
<span id="cb340-13"><a href="#cb340-13" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;lcs&quot;</span>: <span class="dv">1</span>,</span>
<span id="cb340-14"><a href="#cb340-14" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb340-15"><a href="#cb340-15" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;is_number_hits&quot;</span>: <span class="dv">0</span>,</span>
<span id="cb340-16"><a href="#cb340-16" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;has_digit_hits&quot;</span>: <span class="dv">0</span></span>
<span id="cb340-17"><a href="#cb340-17" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb340-18"><a href="#cb340-18" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb340-19"><a href="#cb340-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb340-20"><a href="#cb340-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-21"><a href="#cb340-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-22"><a href="#cb340-22" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, title, pp(factors()) <span class="kw">from</span> index_title_trigrams</span>
<span id="cb340-23"><a href="#cb340-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">where</span> match(<span class="st">&#39;Test It&#39;</span>) <span class="kw">limit</span> <span class="dv">1</span></span>
<span id="cb340-24"><a href="#cb340-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">option</span> ranker<span class="op">=</span>expr(<span class="st">&#39;sum(lcs)*10000+bm15&#39;</span>) \G</span>
<span id="cb340-25"><a href="#cb340-25" aria-hidden="true" tabindex="-1"></a><span class="op">***************************</span> <span class="fl">1.</span> <span class="kw">row</span> <span class="op">***************************</span></span>
<span id="cb340-26"><a href="#cb340-26" aria-hidden="true" tabindex="-1"></a>           <span class="kw">id</span>: <span class="dv">2702</span></span>
<span id="cb340-27"><a href="#cb340-27" aria-hidden="true" tabindex="-1"></a>        title: Flu<span class="op">....</span>test<span class="op">..</span>.</span>
<span id="cb340-28"><a href="#cb340-28" aria-hidden="true" tabindex="-1"></a>pp(factors()): {</span>
<span id="cb340-29"><a href="#cb340-29" aria-hidden="true" tabindex="-1"></a>  <span class="ot">&quot;bm15&quot;</span>: <span class="dv">728</span>,</span>
<span id="cb340-30"><a href="#cb340-30" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb340-31"><a href="#cb340-31" aria-hidden="true" tabindex="-1"></a>  <span class="ot">&quot;fields&quot;</span>: [</span>
<span id="cb340-32"><a href="#cb340-32" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb340-33"><a href="#cb340-33" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;field&quot;</span>: <span class="dv">0</span>,</span>
<span id="cb340-34"><a href="#cb340-34" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;lcs&quot;</span>: <span class="dv">1</span>,</span>
<span id="cb340-35"><a href="#cb340-35" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb340-36"><a href="#cb340-36" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;is_number_hits&quot;</span>: <span class="dv">0</span>,</span>
<span id="cb340-37"><a href="#cb340-37" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;has_digit_hits&quot;</span>: <span class="dv">0</span>,</span>
<span id="cb340-38"><a href="#cb340-38" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;trf_qt&quot;</span>: <span class="fl">0.666667</span>,</span>
<span id="cb340-39"><a href="#cb340-39" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;trf_i2u&quot;</span>: <span class="fl">0.181818</span>,</span>
<span id="cb340-40"><a href="#cb340-40" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;trf_i2q&quot;</span>: <span class="fl">0.666667</span>,</span>
<span id="cb340-41"><a href="#cb340-41" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;trf_i2f&quot;</span>: <span class="fl">0.200000</span>,</span>
<span id="cb340-42"><a href="#cb340-42" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;trf_aqt&quot;</span>: <span class="fl">0.666667</span>,</span>
<span id="cb340-43"><a href="#cb340-43" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;trf_naqt&quot;</span>: <span class="fl">3.000000</span></span>
<span id="cb340-44"><a href="#cb340-44" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb340-45"><a href="#cb340-45" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb340-46"><a href="#cb340-46" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Note how in the super simple example above the ratios are rather as
expected, after all. Query and field have just 3 trigrams each (“it”
also makes a trigram, despite being short). All text here is
alphanumeric, 2 out of 3 trigrams match, and all the respective ratios
are 0.666667, as they should.</p>
<h3 id="trigram-tokenizer-details">Trigram tokenizer details</h3>
<p>The <strong>trigram tokenizer</strong> simply extracts all sequences
of 1 to 3 consecutive, non-whitespace characters from its input text.
For example!</p>
<p>Assume that our input <code>title</code> field contains just
<code>Hi World!</code> and assume that our <code>charset_table</code> is
a default one. Assume that <code>hi</code> is a stopwords. So what
trigrams exactly are going to be extracted (and stored in a Bloom
filter)?</p>
<p>Quick reminder, alt-tokens are computed over almost raw text, only
applying <code>charset_table</code> for case folding. Without
<em>any</em> other processing, retaining any special characters like the
exclamation sign, ignoring stopwords, etc.</p>
<p>After folding, we get <code>hi world!</code> which produces the
following trigrams.</p>
<div class="sourceCode" id="cb341"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb341-1"><a href="#cb341-1" aria-hidden="true" tabindex="-1"></a><span class="ex">hi</span></span>
<span id="cb341-2"><a href="#cb341-2" aria-hidden="true" tabindex="-1"></a><span class="ex">wor</span></span>
<span id="cb341-3"><a href="#cb341-3" aria-hidden="true" tabindex="-1"></a><span class="ex">orl</span></span>
<span id="cb341-4"><a href="#cb341-4" aria-hidden="true" tabindex="-1"></a><span class="ex">rld</span></span>
<span id="cb341-5"><a href="#cb341-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ld</span>!</span></code></pre></div>
<p>That’s literally everything that the trigram tokenizer emits in this
example.</p>
<p>To build the Bloom filter, we then loop the 5 resulting trigram
alt-tokens, prune them, compute hashes, and set a few bits per each
token in our 128-bit Bloom filter. That’s it.</p>
<h3 id="bpe-tokenizer-details">BPE tokenizer details</h3>
<p>The <strong>Byte Pair Encoding (BPE) tokenizer</strong> is a popular
NLP (natural language processing) method for subword tokenization.</p>
<p>The key idea is this. We begin by simply splitting input text into
individual characters and call that our (initial) vocabulary. We then
iteratively compute the most frequent <strong>pairs</strong> of
vocabulary entries, and <strong>merge</strong> those into new, longer
entries. We can stop iterating at any target size, producing a compact
vocabulary that balances between individual bytes and full words (and
parts).</p>
<p>In the original BPE scheme the characters were
<strong>bytes</strong>, hence the “byte pair” naming. Sphinx uses
Unicode characters, though.</p>
<p>Discussing BPE in more detail is out of scope. Should you want to
dive deeper, here are a couple seminal papers to start with.</p>
<ul>
<li>https://arxiv.org/abs/1508.07909</li>
<li>https://github.com/openai/gpt-2</li>
</ul>
<p>Our BPE tokenizer requires an external <strong>BPE merges
file</strong> (<code>bpe_merges_file</code> directive). It’s a text file
with BPE token merge rules, in this format.</p>
<ul>
<li>UTF-8 encoding;</li>
<li>one line per rule;</li>
<li>two space-separated tokens per line;</li>
<li>comments or empty lines not supported;</li>
<li>sorted by descending rule priority (ie. first rules first);</li>
<li>metaspace (word start marker) must be “fat underscore”
(U+2581).</li>
</ul>
<p>For example, it could look like this.</p>
<div class="sourceCode" id="cb342"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb342-1"><a href="#cb342-1" aria-hidden="true" tabindex="-1"></a><span class="ex">▁</span> t</span>
<span id="cb342-2"><a href="#cb342-2" aria-hidden="true" tabindex="-1"></a><span class="ex">t</span> h</span>
<span id="cb342-3"><a href="#cb342-3" aria-hidden="true" tabindex="-1"></a><span class="ex">th</span> e</span>
<span id="cb342-4"><a href="#cb342-4" aria-hidden="true" tabindex="-1"></a><span class="ex">e</span> r</span>
<span id="cb342-5"><a href="#cb342-5" aria-hidden="true" tabindex="-1"></a><span class="ex">er</span> e</span>
<span id="cb342-6"><a href="#cb342-6" aria-hidden="true" tabindex="-1"></a><span class="ex">o</span> n</span>
<span id="cb342-7"><a href="#cb342-7" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span></code></pre></div>
<p>This file gets produced during <strong>BPE tokenizer
training</strong> (external to Sphinx). Of course, it
<strong>must</strong> be in sync with your ranking models.</p>
<blockquote>
<p>WARNING! The magic special character at the very start is NOT an
underscore! That’s an Unicode symbol U+2581, called “Lower One Eighth
Block” officially (or “fat underscore” colloquially). It basically marks
the start of a word.</p>
</blockquote>
<p>Available models might use other metaspace characters. One pretty
frequent option seems to be U+0120. Also, we don’t support comments yet.
So when using pre-crafted BPE tokenizers, a little tweaking might be
needed.</p>
<div class="sourceCode" id="cb343"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoTokenizer</span>
<span id="cb343-2"><a href="#cb343-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb343-3"><a href="#cb343-3" aria-hidden="true" tabindex="-1"></a>tokenizer <span class="op">=</span> AutoTokenizer.from_pretrained(<span class="st">&quot;gpt2&quot;</span>)</span>
<span id="cb343-4"><a href="#cb343-4" aria-hidden="true" tabindex="-1"></a>merges_file <span class="op">=</span> tokenizer.init_kwargs.get(<span class="st">&quot;merges_file&quot;</span>, <span class="va">None</span>)</span>
<span id="cb343-5"><a href="#cb343-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> line <span class="kw">in</span> <span class="bu">open</span>(merges_file, <span class="st">&quot;r&quot;</span>, encoding<span class="op">=</span><span class="st">&quot;utf-8&quot;</span>):</span>
<span id="cb343-6"><a href="#cb343-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> line.startswith(<span class="st">&quot;#&quot;</span>):</span>
<span id="cb343-7"><a href="#cb343-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(line.strip().replace(<span class="st">&quot;</span><span class="ch">\u0120</span><span class="st">&quot;</span>, <span class="st">&quot;</span><span class="ch">\u2581</span><span class="st">&quot;</span>))</span></code></pre></div>
<h2 id="ranking-clickstats">Ranking: clickstats</h2>
<p>Starting with v.3.5 Sphinx lets you compute a couple static per-field
signals (<code>xxx_tokclicks_avg</code> and
<code>xxx_tokclicks_sum</code>) and one dynamic per-query signal
(<code>words_clickstat</code>) based on per-keyword “clicks” statistics,
or “clickstats” for short.</p>
<p>Basically, clickstats work as follows.</p>
<p>At indexing time, for all the “interesting” keywords, you create a
simple 3-column TSV table with the keywords, and per-keyword “clicks”
and “events” counters. You then bind that table (or multiple tables) to
fields using <code>index_words_clickstat_fields</code> directive, and
<code>indexer</code> computes and stores 2 per-field floats,
<code>xxx_tokclicks_avg</code> and <code>xxx_tokclicks_sum</code>, where
<code>xxx</code> is the field name.</p>
<p>At query time, you use <code>query_clickstats</code> directive to
have <code>searchd</code> apply the clickstats table to queries, and
compute per-query signal, <code>words_clickstat</code>.</p>
<p>While these signals are quite simple, we found that they do improve
our ranking models. Now, more details and examples!</p>
<p><strong>Clickstats TSV file format.</strong> Here goes a simple
example. Quick reminder, our columns here are “keyword”, “clicks”, and
“events”.</p>
<pre><code># WARNING: spaces here in docs because Markdown can&#39;t tabs
mazda   100 200
toyota  150 300</code></pre>
<p>To avoid noisy signals, you can zero them out for fields (or queries)
where <code>sum(events)</code> is lower than a given threshold. To
configure that threshold, use the following syntax:</p>
<pre><code># WARNING: spaces here in docs because Markdown can&#39;t tabs
$COUNT_THRESHOLD    20
mazda   100 200
toyota  150 300</code></pre>
<p>You can reuse one TSV table for everything, or you can use multiple
separate tables for individual fields and/or queries.</p>
<p><strong>Config directives format.</strong> The indexing-time
directive should contain a small dictionary that binds individual TSV
tables to fields:</p>
<div class="sourceCode" id="cb346"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb346-1"><a href="#cb346-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index_words_clickstat_fields</span> = title:t1.tsv, body:t2.tsv</span></code></pre></div>
<p>The query-time directive should simply mention the table:</p>
<div class="sourceCode" id="cb347"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a><span class="ex">query_words_clickstat</span> = qt.tsv</span></code></pre></div>
<p><strong>Computed (static) attributes and (dynamic) query
signal.</strong> Two static autocomputed attributes,
<code>xxx_tokclicks_avg</code> and <code>xxx_tokclicks_sum</code>, are
defined as <code>avg(clicks/events)</code> and <code>sum(clicks)</code>
respectively, over all the postings found in the <code>xxx</code> field
while indexing.</p>
<p>Dynamic <code>words_clickstat</code> signal is defined as
<code>sum(clicks)/sum(events)</code> over all the postings found in the
current query.</p>
<h2 id="ranking-tokhashes-and-wordpair_ctr">Ranking: tokhashes and
<code>wordpair_ctr</code></h2>
<p>Starting with v.3.5 Sphinx can build internal field token hashes
(“tokhashes” for short) while indexing, then utilize those for ranking.
To enable tokhashes, just add the following directive to your index
config.</p>
<div class="sourceCode" id="cb348"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb348-1"><a href="#cb348-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index_tokhash_fields</span> = title, keywords</span></code></pre></div>
<p>Keep in mind that tokhashes are stored as attributes, and therefore
require additional disk and RAM. They are intended for short fields like
titles where that should not be an issue. Also, tokhashes are based on
raw tokens (keywords), ie. hashes are stored before morphology.</p>
<p>The first new signal based on tokhashes is <code>wordpair_ctr</code>
and it computes <code>sum(clicks) / sum(views)</code> over all the
matching <code>{query_token, field_token}</code> pairs. This is a
per-field signal that only applies to tokhash-indexed fields. It also
requires that you configure a global wordpairs table for
<code>searchd</code> using the <code>wordpairs_ctr_file</code> directive
in <code>searchd</code> section.</p>
<p>The table must be in TSV format (tab separated) and it must contain 4
columns exactly: <strong>query_token, field_token, clicks,
views</strong>. Naturally, clicks must not be negative, and views must
be strictly greater than zero. Bad lines failing to meet these
requirements are ignored. Empty lines and comment lines (starting with
<code>#</code> sign) are allowed.</p>
<div class="sourceCode" id="cb349"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in sphinx.conf</span></span>
<span id="cb349-2"><a href="#cb349-2" aria-hidden="true" tabindex="-1"></a><span class="ex">searchd</span></span>
<span id="cb349-3"><a href="#cb349-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb349-4"><a href="#cb349-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">wordpairs_ctr_file</span> = wordpairs.tsv</span>
<span id="cb349-5"><a href="#cb349-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb349-6"><a href="#cb349-6" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb349-7"><a href="#cb349-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-8"><a href="#cb349-8" aria-hidden="true" tabindex="-1"></a><span class="co"># in wordpairs.tsv</span></span>
<span id="cb349-9"><a href="#cb349-9" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">WARNING</span><span class="co">: spaces here in docs because Markdown can&#39;t tabs</span></span>
<span id="cb349-10"><a href="#cb349-10" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">WARNING</span><span class="co">: MUST be single tab separator in prod!</span></span>
<span id="cb349-11"><a href="#cb349-11" aria-hidden="true" tabindex="-1"></a><span class="ex">whale</span>   blue    117 1000</span>
<span id="cb349-12"><a href="#cb349-12" aria-hidden="true" tabindex="-1"></a><span class="ex">whale</span>   moby    56  1000</span>
<span id="cb349-13"><a href="#cb349-13" aria-hidden="true" tabindex="-1"></a><span class="ex">angels</span>  blue    42  1000</span>
<span id="cb349-14"><a href="#cb349-14" aria-hidden="true" tabindex="-1"></a><span class="ex">angels</span>  red     3   1000</span></code></pre></div>
<p>So in this example when we query for <code>whale</code>, documents
that mention <code>blue</code> in their respective tokhash fields must
get <code>wordpair_ctr = 0.117</code> in those fields, documents with
<code>moby</code> must get <code>wordpair_ctr = 0.056</code>, etc.</p>
<p>Current implementation is that at most 100 “viable” wordpairs (ie.
ones with “interesting” query words from the 1st column) are looked up.
This is to avoid performance issues when there are too many query and/or
field words. Both this straightforward “lookup them all” implementation
and the specific limit may change in the future.</p>
<p>Note that a special value <code>wordpair_ctr = -1</code> must be
handled as NULL in your ranking formulas or UDFs. Zero value means that
<code>wordpair_ctr</code> is defined, but computes to zero. A value of
-1 means NULL in a sense that <code>wordpair_ctr</code> is not even
defined (not a tokhash field, or no table configured).
<code>FACTORS()</code> output skips the <code>wordpair_ctr</code> key in
this case. One easy way to handle -1 is to simply clamp it by 0.</p>
<p>You can also impose a minimum <code>sum(views)</code> threshold in
your wordpairs table as follows.</p>
<div class="sourceCode" id="cb350"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb350-1"><a href="#cb350-1" aria-hidden="true" tabindex="-1"></a><span class="va">$VIEWS_THRESHOLD</span>    100</span></code></pre></div>
<p>Values that had <code>sum(views) &lt; $VIEWS_THRESHOLD</code> are
zeroed out. By default this threshold is set to 1 and any non-zero sum
goes. Raising it higher is useful to filter out weak/noisy ratios.</p>
<p>Last but not least, note that everything (clicks, views, sums, etc)
is currently computed in signed 32-bit integers, and overflows at
INT_MAX. Beware.</p>
<h2 id="ranking-token-classes">Ranking: token classes</h2>
<p>Starting with v.3.5 you can configure a number of (raw) token
classes, and have Sphinx compute per-field and per-query token class
bitmasks.</p>
<p>Configuring this requires just 2 directives, <code>tokclasses</code>
to define the classes, and <code>index_tokclass_fields</code> to tag the
“interesting” fields.</p>
<div class="sourceCode" id="cb351"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a><span class="co"># somewhere in sphinx.conf</span></span>
<span id="cb351-2"><a href="#cb351-2" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> tctest</span>
<span id="cb351-3"><a href="#cb351-3" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb351-4"><a href="#cb351-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb351-5"><a href="#cb351-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">tokclasses</span> = 0:colors.txt, 3:articles.txt, 7:swearing.txt</span>
<span id="cb351-6"><a href="#cb351-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">index_tokclass_fields</span> = title</span>
<span id="cb351-7"><a href="#cb351-7" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb351-8"><a href="#cb351-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-9"><a href="#cb351-9" aria-hidden="true" tabindex="-1"></a><span class="co"># cat colors.txt</span></span>
<span id="cb351-10"><a href="#cb351-10" aria-hidden="true" tabindex="-1"></a><span class="fu">red</span> orange yellow green</span>
<span id="cb351-11"><a href="#cb351-11" aria-hidden="true" tabindex="-1"></a><span class="ex">blue</span> indigo violet</span>
<span id="cb351-12"><a href="#cb351-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-13"><a href="#cb351-13" aria-hidden="true" tabindex="-1"></a><span class="co"># cat articles.txt</span></span>
<span id="cb351-14"><a href="#cb351-14" aria-hidden="true" tabindex="-1"></a><span class="ex">a</span></span>
<span id="cb351-15"><a href="#cb351-15" aria-hidden="true" tabindex="-1"></a><span class="ex">an</span></span>
<span id="cb351-16"><a href="#cb351-16" aria-hidden="true" tabindex="-1"></a><span class="ex">the</span></span></code></pre></div>
<p><strong>The tokclass values are bit masks of the matched
classes.</strong> As you can see, <code>tokclasses</code> contains
several entries, each with a class number and a file name. Now, the
class number is a mask bit position. The respective mask bit gets set
once any (raw) token matches the class.</p>
<p>So tokens from <code>colors.txt</code> will have bit 0 in the
per-field mask set, tokens from <code>articles.txt</code> will have bit
3 set, and so on.</p>
<p><strong>Per-field tokclasses are computed when indexing.</strong> Raw
tokens from fields listed in <code>index_tokclass_fields</code> are
matched against classes from <code>tokclasses</code> while indexing. The
respective <code>tokclass_xxx</code> mask attribute gets automatically
created for every field from the list. The attribute type is
<code>UINT</code>.</p>
<p><strong>Query tokclass is computed when searching.</strong> And
<code>FACTORS()</code> now returns a new
<code>query_tokclass_mask</code> signal with that.</p>
<p>To finish off with the bits and masks and values, let’s dissect a
small example.</p>
<div class="sourceCode" id="cb352"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb352-1"><a href="#cb352-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, title, tokclass_title <span class="kw">FROM</span> tctest;</span>
<span id="cb352-2"><a href="#cb352-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------------------------+--------------+</span></span>
<span id="cb352-3"><a href="#cb352-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | title                  | tokclass_title |</span>
<span id="cb352-4"><a href="#cb352-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------------------+----------------+</span></span>
<span id="cb352-5"><a href="#cb352-5" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | <span class="kw">the</span> cat <span class="kw">in</span> <span class="kw">the</span> red hat |              <span class="dv">9</span> |</span>
<span id="cb352-6"><a href="#cb352-6" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">234</span> | beige poodle           |              <span class="dv">0</span> |</span>
<span id="cb352-7"><a href="#cb352-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------------------+----------------+</span></span>
<span id="cb352-8"><a href="#cb352-8" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>We get <code>tokclass_title = 9</code> computed from
<code>the cat in the red hat</code> title here, seeing as
<code>the</code> belongs to class 3 and <code>red</code> to class 0. The
bitmask with bits 0 and 3 set yields 9, because
<code>(1 &lt;&lt; 0) + (1 &lt;&lt; 3) = 1 + 8 = 9</code>. The other
title matches no interesting tokens, hence we get
<code>tokclass_title = 0</code> from that one.</p>
<p>Likewise, a query with “swearing” and “articles” (but no “colors”)
would yield <code>query_tokclass_mask</code> to 129, because bits 7 and
0 (with values 128 and 1) would get set for any tokens from “swearing”
and “articles” lists. And so on.</p>
<p><strong>The maximum allowed number of classes is 30</strong>, so
class numbers 0 to 29 (inclusive) are accepted. Other numbers should
fail.</p>
<p><strong>The maximum <code>tokclasses</code> text file line length is
4096</strong>, the remainder is truncated, so don’t put all your tokens
on one huge line.</p>
<p><strong>Tokens may belong to multiple classes</strong>, and multiple
bits will then be set.</p>
<p><code>query_tokclass_mask</code> with all bits set, ie. -1 signed or
4294967295 unsigned, <strong>must be interpreted as a null
value</strong> in ranking UDFs and formulas.</p>
<p><strong>Token classes are designed for comparatively “small”
lists</strong>. Think lists of articles, prepositions, colors, etc.
Thousands of entries are quite okay, millions less so. While there
aren’t any size limits just yet, take note that huge lists may impact
performance here.</p>
<p>For one, <strong>all tokens classes are always fully stored in the
index header</strong>, ie. those text files <em>contents</em> from
<code>tokclasses</code> are all copied into the index. File names too
get stored, but just for reference, not further access.</p>
<h2 id="ranking-two-stage-ranking">Ranking: two-stage ranking</h2>
<p>With larger collections and more complex models there’s inevitably a
situation when ranking <em>everything</em> using your best-quality model
just is not fast enough.</p>
<p>One common solution to that is <strong>two-stage ranking</strong>,
when at the first stage you rank everything using a faster model, and at
the second stage you rerank the top-N results from the first stage using
a slower model.</p>
<p><strong>Sphinx supports two-stage ranking with subselects</strong>
and certain guarantees on <code>FACTORS()</code> behavior vs subselects
and UDFs.</p>
<p>For the sake of example, assume that your queries can match up to 1
million documents, and that you have a custom <code>SLOWRANK()</code>
UDF that would be just too heavy to compute 1 million times per query in
reasonable time. Also assume that reranking the top 3000 results
obtained using even the simple default Sphinx ranking formula with
<code>SLOWRANK()</code> yields a negligible NDCG loss.</p>
<p>We can then <strong>use a subselect</strong> that uses a simple
formula for the fast ranking stage, and then reranks on
<code>SLOWRANK()</code> in its outer sort condition, as follows.</p>
<div class="sourceCode" id="cb353"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> (</span>
<span id="cb353-2"><a href="#cb353-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="kw">id</span>, title, weight() fr, slowrank(factors()) sr</span>
<span id="cb353-3"><a href="#cb353-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> myindex <span class="kw">WHERE</span> match(<span class="st">&#39;hello&#39;</span>)</span>
<span id="cb353-4"><a href="#cb353-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">OPTION</span> ranker<span class="op">=</span>expr(<span class="st">&#39;sum(lcs)*10000+bm15&#39;</span>)</span>
<span id="cb353-5"><a href="#cb353-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> fr <span class="kw">DESC</span> <span class="kw">LIMIT</span> <span class="dv">3000</span></span>
<span id="cb353-6"><a href="#cb353-6" aria-hidden="true" tabindex="-1"></a>) <span class="kw">ORDER</span> <span class="kw">BY</span> sr <span class="kw">DESC</span> <span class="kw">LIMIT</span> <span class="dv">20</span></span></code></pre></div>
<p>What happens here?</p>
<p>Even though <code>slowrank(factors())</code> is in the inner select,
its evaluation can be postponed until the <em>outer</em> reordering. And
that does happen, because there are the following 2 guarantees.</p>
<ol type="1">
<li><code>FACTORS()</code> blobs for the top inner documents are
<em>guaranteed</em> to be available for the outer reordering.</li>
<li>Inner UDF expressions that can be postponed until the outer stage
are <em>guaranteed</em> to be postponed.</li>
</ol>
<p>So during the inner select Sphinx still honestly matches 1,000,000
documents and still computes the <code>FACTORS()</code> blobs and the
ranking expression a million times. But then it keeps just the top 3000
documents (and their signals), as requested by the inner limit. Then it
reranks just those documents, and calls <code>slowrank()</code> just
3000 times. The it applies the final outer limit to returns the top-20
out of the <em>reranked</em> documents. Voila.</p>
<p>Note how it’s vital that you must <strong>not</strong> reference
<code>sr</code> anywhere in the inner query except the select list.
Naturally, if you mention it in any inner <code>WHERE</code> or
<code>ORDER BY</code> or whatever other clause, Sphinx is
<strong>required</strong> to compute that during the inner select, can
not postpone the heavy UDF evaluation anymore, and the performance
sinks.</p>
<h2 id="operations-rt-index-internals">Operations: RT index
internals</h2>
<p>This section covers internal RT index design details that we think
are important to understand from operational perspective. Mostly it’s
all about the “how do RT indexes actually do writes” theme!</p>
<p>TLDR is as follows.</p>
<ul>
<li>RT index = RAM segments + disk segments.</li>
<li>1 <code>INSERT</code> = 1 RAM segment, so the less INSERTs, the
better (batch them).</li>
<li><code>rt_mem_limit</code> imposes a (soft) limit on total RAM
segments size.</li>
<li>“Overflown” RAM segments get stored as 1 new disk segment.</li>
<li>“Real” appends happen in RAM, new data = only stored in RAM
segments.</li>
<li>“Lazy” deletions happen on disk, deleted/updated data = disk
bloat.</li>
<li><code>OPTIMIZE</code> cleans up that disk bloat. Must run it
manually.</li>
<li>Writes are protected by WALs. Don’t disable them.</li>
</ul>
<p>There are two major types of writes that Sphinx supports: writes with
full-text data in them (<code>INSERT</code> and <code>REPLACE</code>),
and without it (<code>DELETE</code> and <code>UPDATE</code>). And
internally, they are handled very differently. They just must be.</p>
<p>Because, shockingly, <strong>full-text indexes are effectively
read-only!</strong> In most (if not all) the modern search engines,
including Sphinx.</p>
<p>How come?! Surely that’s either a mistake, or a blatant
exaggeration?! We very definitely <strong>can</strong> flood Sphinx with
a healthy mix of INSERTs and DELETEs and UPDATEs and that’d work
alright, how that could possibly be “read-only”?!</p>
<p>But no, that’s not even an exaggeration. There’s a low-level data
structure called <strong>the inverted index</strong> that enables fast
text searches. Inverted indexes can be built over arbitrary sized sets
of documents. Could be just 1 document, could be 1 million or 1 billion,
inverted indexes do not really care. However, while it’s easy to
<strong>build</strong> an inverted index, <strong>updating</strong> an
inverted index in-place is much more complex. So very complex that, in
fact, it’s easier and faster to create a new one instead; then
<strong>merge</strong> that with an existing one; then use the final
“freshly merged” inverted index. (And ditch the other two.)</p>
<p>And that’s exactly what’s happening in Sphinx (and Lucene, and other
engines) internally. Yes, low-level inverted indexes (ie. structures
that make full-text searches happen) are effectively read-only. Once
they’re created, they’re never ever modified.</p>
<p>And that’s how we arrive at <strong>segments</strong>. Sphinx RT
index internally consists of a bunch of segments, some of them smaller
and so RAM-based, some of them larger and disk-based. <strong>1 segment
= 1 inverted index.</strong></p>
<p>To reiterate, <strong>RT index consists of multiple RAM segments and
disk segments.</strong> Every segment is completely independent from
each other. For every single search (ie. any <code>SELECT</code>
statement), segments are searched separately, and per-segment results
are merged together. <code>SHOW INDEX STATUS</code> statement displays
the number of both RAM and disk segments.</p>
<p><strong>Writes with any full-text data always create new RAM
segments.</strong> Even when that data is empty! Yes,
<code>INSERT INTO myrtindex VALUES (123, '')</code> creates a new
segment for that row 123, even though the inverted index part is
empty.</p>
<p><strong>Writes without full-text data modify the existing RAM or disk
segments.</strong> Because
<code>UPDATE myrtindex SET price=123 WHERE id=456</code> does not
involve modifying the inverted index. In fact, we can just patch the
<code>price</code> value for row 456 in-place, and we do.</p>
<p><strong>Per-index RAM segments count is limited internally.</strong>
Search-wise, the less segments, the better. Searching through 100+ tiny
individual segments on every single <code>SELECT</code> is too
inefficient, so Sphinx never goes over a certain internal hard-coded
limit. (For the really curious, it’s currently 32 RAM segments max.)</p>
<p><strong>Per-index RAM segments size is limited by the
<code>rt_mem_limit</code> directive.</strong> Sphinx creates a new disk
segment every time when all RAM segments (combined) breach this limit.
So effectively it’s going to affect <strong>disk</strong> segment
sizing! For example, if you insert 100 GB into Sphinx, and
<code>rt_mem_limit</code> is 1 GB, then you can expect 100 disk
segments.</p>
<p><strong>The default <code>rt_mem_limit</code> is currently only 128
MB.</strong> You actually <strong>MUST</strong> set it higher for larger
indexes. For example, 100 GB of data means about 800 disk segments with
the default limit, which is way too much.</p>
<p>We currently recommend setting <code>rt_mem_limit</code> to a few
gigabytes. Specifically, anything in 1 GB to 16 GB range is a solid,
safe baseline. Ideally, it should also be within the total available
RAM, but it’s actually okay to completely overshoot!</p>
<p>For instance, what if you set <code>rt_mem_limit = 256G</code> on a
512 MB server or VM?! Sounds scary, right? But in fact, as long as your
actual index is small enough and fits into those 512 MB, everything
works <strong>exactly</strong> the same with 256G as it would have with
512M. And even with a bigger index that doesn’t fit into RAM the
differences essentially boil down to disk access patterns. Because
swapping <strong>will</strong> occur in <strong>both</strong> these
cases.</p>
<p>Values under 1 GB make very little sense in the era of $1 VPSes with
1 GB RAM.</p>
<p>Values over 16 GB are also perfectly viable for certain workloads.
For instance, if you have a very actively updated working set sized at
30 GB (and enough RAM), the <strong>best</strong>
<code>rt_mem_limit</code> setting is to keep that entire working set in
RAM, so maybe 32G for now, or 48G if you expect growth.</p>
<p>At the same time, higher values might have the downsides of slower
startup times and/or bigger, less manageable disk segments. Exercise
caution.</p>
<p><strong>Exactly one RAM segment gets created on each
<code>INSERT</code> (and <code>REPLACE</code>).</strong> And then,
almost always, two (smallest) RAM segments get merged, to enforce the
RAM segment count limit. And then the newly added data becomes available
in search.</p>
<p>There’s an <strong>extremely</strong> important corollary to that.
Smaller <code>INSERT</code> batches yield better write latency, but
worse bandwidth. Because of RAM segment merges. Inserting 1K rows
one-by-one means almost 1K extra merges compared to inserting them in a
single big batch! Of course, most such merges will be tiny, but they
still add some overheads. How much overheads? Short answer, maybe up to
2-3x.</p>
<p>Long answer, your mileage may vary severely, but to provide
<em>some</em> baseline, here goes a quick-n-dirty benchmark. We insert
30K rows with 36.2 MB of text data (and just 0.12 MB attribute data, so
almost none) into an empty RT index, with a varying number of rows per
<code>INSERT</code> call. (For the record, everything except Sphinx
queries takes around 0.3 sec in this benchmark.)</p>
<table>
<thead>
<tr class="header">
<th>Rows/batch</th>
<th>Time</th>
<th>Slowdown</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>5.2 sec</td>
<td>2.4x</td>
</tr>
<tr class="even">
<td>3</td>
<td>3.9 sec</td>
<td>1.8x</td>
</tr>
<tr class="odd">
<td>10</td>
<td>3.1 sec</td>
<td>1.5x</td>
</tr>
<tr class="even">
<td>30</td>
<td>2.8 sec</td>
<td>1.3x</td>
</tr>
<tr class="odd">
<td>100</td>
<td>2.5 sec</td>
<td>1.2x</td>
</tr>
<tr class="even">
<td>300</td>
<td>2.4 sec</td>
<td>1.1x</td>
</tr>
<tr class="odd">
<td>1000</td>
<td>2.2 sec</td>
<td>-</td>
</tr>
<tr class="even">
<td>3000</td>
<td>2.2 sec</td>
<td>-</td>
</tr>
<tr class="odd">
<td>10000</td>
<td>2.2 sec</td>
<td>-</td>
</tr>
</tbody>
</table>
<p>So we reach the best bandwidth at 1000 rows per batch. Average
latency at that size is just 73 msec. Which is fine for most
applications. Bigger batches have no effect for <em>this</em> particular
workload. Of course, inserting rows individually yields great
<em>average</em> latency (0.17 msec vs 73 msec on average). But that
comes at a cost of 2.4x worse bandwidth. And <em>maximum</em> latency
can get arbitrarily big anyway. All that should be considered when
choosing the “ideal” batch size for your specific application.</p>
<p><strong>Saving a new disk segment should <em>not</em> noticeably
stall INSERTs.</strong> Even while saving a new disk segment, Sphinx
processes concurrent writes (<code>INSERT</code> queries) normally. New
data is stored into a small second set of RAM segments, capped at 10% of
<code>rt_mem_limit</code>, and if <em>that</em> RAM is also exhausted,
then (and only then) writes can be stalled until the new disk segment is
brought online.</p>
<p>As indexing is usually CPU-bound anyway (say 10-30 MB/sec/core in
early 2025), this potential disk-bound write stall is almost never an
issue. That’s not much even for an older laptop HDD, not to mention DC
SSD RAID.</p>
<p><strong>Deletes in both RAM and disk segments are logical.</strong>
That is, <code>DELETE</code> and <code>REPLACE</code> only quickly mark
rows as logically deleted, but they stay physically present in the
full-text index, until cleanup.</p>
<p><strong>Physical cleanup in disk segments only happens on
<code>OPTIMIZE</code>.</strong> There is no automatic cleanup yet. Even
if you <code>DELETE</code> all the (disk based) rows from your index,
they will stay there and slow down queries, until the explicit
<code>OPTIMIZE</code> statement! And <code>OPTIMIZE</code> cleans them
up, analogous to <code>VACUUM</code> in PostgreSQL.</p>
<p><strong>UPDATEs during OPTIMIZE may temporarily fail, depending on
settings.</strong> <code>UPDATE</code> queries conflict with
<code>OPTIMIZE</code> that locks and temporary “freezes” all the
pre-existing index data. By default, updates will internally wait for a
few seconds, then timeout and fail, asking the client application to
retry.</p>
<p>However, starting with v.3.8 Sphinx can automatically convert
incoming <code>UPDATE</code> queries into <code>REPLACE</code> ones that
work fine even during <code>OPTIMIZE</code> (because they append new
data, and do not modify any pre-existing data). That conversion only
engages when <strong>all the original field contents are somehow
stored</strong>, either in disk-based DocStore (see <a
href="#stored_fields-directive"><code>stored_fields</code></a>), or as
RAM-based attributes (see <a
href="#field_string-directive"><code>field_string</code></a>).</p>
<p><strong>Physical cleanup in RAM segments is automatic.</strong>
Unlike disk segments, RAM segments are (very) frequently merged
automatically, so physical cleanup happens along the merges.</p>
<p><strong>All writes (even to RAM segments) are made durable by WALs
(aka binlogs).</strong> WALs (Write Ahead Logs) are enabled by default,
so writes are safe by default, because <code>searchd</code> can recover
from crashes by replaying WALs. You can manually disable them. One
semi-imaginary scenario would be, say, to improve one-off bulk import
performance.</p>
<p>But you must not. <strong>We very strongly recommend against</strong>
running without WALs. Think twice, then think more, and then just
don’t.</p>
<h2 id="siege-mode">Operations: “siege mode”, temporary global query
limits</h2>
<p>Sphinx <code>searchd</code> now has a so-called “siege mode” that
temporarily imposes server-wide limits on <em>all</em> the incoming
<code>SELECT</code> queries, for a given amount of time. This is useful
when some client is flooding <code>searchd</code> with heavy requests
and, for whatever reason, stopping those requests at other levels is
complicated.</p>
<p>Siege mode is controlled via a few global server variables. The
example just below will introduce a siege mode for 15 seconds, and
impose limits of at most 1000 processed documents and at most 0.3
seconds (wall clock) per query:</p>
<div class="sourceCode" id="cb354"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb354-1"><a href="#cb354-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="kw">global</span> siege<span class="op">=</span><span class="dv">15</span></span>
<span id="cb354-2"><a href="#cb354-2" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="kw">global</span> siege_max_fetched_docs<span class="op">=</span><span class="dv">1000</span></span>
<span id="cb354-3"><a href="#cb354-3" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="kw">global</span> siege_max_query_msec<span class="op">=</span><span class="dv">300</span></span></code></pre></div>
<p>Once the timeout reaches zero, the siege mode will be automatically
lifted.</p>
<p>There also are intentionally hardcoded limits you can’t change,
namely:</p>
<ul>
<li>upper limit for <code>siege</code> is 300 seconds, ie. 5
minutes</li>
<li>upper limit for <code>siege_max_fetched_docs</code> is 1,000,000
documents</li>
<li>upper limit for <code>siege_max_query_msec</code> is 1 second, ie.
1000 msec</li>
</ul>
<p>Note that <strong>current siege limits are reset when the siege
stops.</strong> So in the example above, if you start another siege in
20 seconds, then that next siege will be restarted with 1M docs and 1000
msec limits, and <em>not</em> the 1000 docs and 300 msec limits from the
previous one.</p>
<p>Siege mode can be turned off at any moment by zeroing out the
timeout:</p>
<div class="sourceCode" id="cb355"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb355-1"><a href="#cb355-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="kw">global</span> siege<span class="op">=</span><span class="dv">0</span></span></code></pre></div>
<p>The current siege duration left (if any) is reported in
<code>SHOW STATUS</code>:</p>
<div class="sourceCode" id="cb356"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb356-1"><a href="#cb356-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show status <span class="kw">like</span> <span class="st">&#39;siege%&#39;</span>;</span>
<span id="cb356-2"><a href="#cb356-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+---------+</span></span>
<span id="cb356-3"><a href="#cb356-3" aria-hidden="true" tabindex="-1"></a>| Counter                | <span class="fu">Value</span>   |</span>
<span id="cb356-4"><a href="#cb356-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+---------+</span></span>
<span id="cb356-5"><a href="#cb356-5" aria-hidden="true" tabindex="-1"></a>| siege_sec_left         | <span class="dv">296</span>     |</span>
<span id="cb356-6"><a href="#cb356-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+---------+</span></span>
<span id="cb356-7"><a href="#cb356-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>And to check the current limits, you can check
<code>SHOW VARIABLES</code>:</p>
<div class="sourceCode" id="cb357"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb357-1"><a href="#cb357-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show variables <span class="kw">like</span> <span class="st">&#39;siege%&#39;</span>;</span>
<span id="cb357-2"><a href="#cb357-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+---------+</span></span>
<span id="cb357-3"><a href="#cb357-3" aria-hidden="true" tabindex="-1"></a>| Counter                | <span class="fu">Value</span>   |</span>
<span id="cb357-4"><a href="#cb357-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+---------+</span></span>
<span id="cb357-5"><a href="#cb357-5" aria-hidden="true" tabindex="-1"></a>| siege_max_query_msec   | <span class="dv">1000</span>    |</span>
<span id="cb357-6"><a href="#cb357-6" aria-hidden="true" tabindex="-1"></a>| siege_max_fetched_docs | <span class="dv">1000000</span> |</span>
<span id="cb357-7"><a href="#cb357-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+---------+</span></span>
<span id="cb357-8"><a href="#cb357-8" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Next order of business, the document limit has a couple interesting
details that require explanation.</p>
<p>First, the <code>fetched_docs</code> counter is calculated a bit
differently for term and non-term searches. For term searches, it counts
all the (non-unique!) rows that were fetched by full-text term readers,
batch by batch. For non-term searches, it counts all the (unique) alive
rows that were matched (either by an attribute index read, or by a full
scan).</p>
<p>Second, for multi-index searches, the
<code>siege_max_fetched_docs</code> limit will be split across the local
indexes (shards), weighted by their document count.</p>
<p>If you’re really curious, let’s discuss those bits in more
detail.</p>
<p>The non-term search case is rather easy. All the actually stored rows
(whether coming either from a full scan or an attribute index reads)
will be first checked for liveness, then accounted in the
<code>fetched_docs</code> counter, then either further processed (with
extra calculations, filters, etc). Bottom line, a query limited this way
will run “hard” calculations, filter checks, etc on at most N rows. So
best case scenario (if all <code>WHERE</code> filters pass), the query
will return N rows, and never even a single row more.</p>
<p>Now, the term search case is more interesting. The lowest-level term
readers will also emit individual rows, but as opposed to the “scan”
case, either the terms or the rows might be duplicated. The
<code>fetched_docs</code> counter merely counts those emitted rows, as
it needs to limit the total amount of work done. So, for example, with a
2-term query like <code>(foo bar)</code> the processing will stop when
<em>both</em> terms fetch N documents total from the full-text index…
even if not a single document was <em>matched</em> just yet! If a term
is duplicated, for example, like in a <code>(foo foo)</code> query, then
<em>both</em> the occurrences will contribute to the counter. Thus, for
a query with M required terms all AND-ed together, the upper limit on
the <em>matched</em> documents should be roughly equal to N/M, because
every matched document will be counted as “processed” M times in every
term reader. So either <code>(foo bar)</code> or <code>(foo foo)</code>
example queries with a limit of 1000 should result in roughly 500
matches tops.</p>
<p>That “roughly” just above means that, occasionally, there might be
slightly more matches. As for performance reasons the term readers work
in batches, the actual <code>fetched_docs</code> counter might get
slightly bigger than the imposed limit, by the batch size at the most.
But that must be insignificant as processing just a single small batch
is very quick.</p>
<p>And as for splitting the limit between the indexes, it’s simply
pro-rata, based on the per-index document count. For example, assume
that <code>siege_max_fetched_docs</code> is set to 1000, and that you
have 2 local indexes in your query, one with 1400K docs and one with
600K docs respectively. (It does not matter whether those are referenced
directly or via a distributed index.) Then the per-index limits will be
set to 700 and 300 documents respectively. Easy.</p>
<p>Last but not least, beware that the entire point of the “siege mode”
is to <strong>intentionally degrade the search results for too complex
searches</strong>! Use with extreme care; essentially only use it to
stomp out cluster fires that can not be quickly alleviated any other
way; and at this point we recommend to only <em>ever</em> use it
manually.</p>
<h2 id="operations-network-internals">Operations: network internals</h2>
<p>Let’s look into a few various <code>searchd</code> network
implementation details that might be useful from an operational
standpoint: how it handles incoming client queries, how it handles
outgoing queries to other machines in the cluster, etc.</p>
<h3 id="incoming-client-queries">Incoming (client) queries</h3>
<h4 id="threading-and-networking-modes">Threading and networking
modes</h4>
<p><code>searchd</code> currently supports two threading modes,
<code>threads</code> and <code>thread_pool</code>, and two networking
modes are naturally tied to those threading modes.</p>
<p>In the first mode (<code>threads</code>), a separate dedicated
per-client thread gets spawned for every incoming network connection. It
then handles everything, both network IO and request processing. Having
processing and network IO in the same thread is optimal latency-wise,
but unfortunately there are several other major issues:</p>
<ul>
<li>classic C10K problem: each inactive client stalls its thread, many
inactive clients stall all available threads and DoS the server;</li>
<li>synchronous processing problem: thread that works on a request can’t
react to <em>any</em> network events such as client going away;</li>
<li>slow client problem: active but slow client stalls its thread while
doing either network request reads or response writes.</li>
</ul>
<p>In the second mode (<code>thread_pool</code>), worker threads are
isolated from client IO, and only work on the requests. All client
network IO is performed in a dedicated network thread. It runs the
so-called <strong>net loop</strong> that multiplexes (many) open
connections and handles them (very) efficiently.</p>
<p>What does the network thread actually do? It does all network reads
and writes, for all the protocols (SphinxAPI and SphinxQL) too, by the
way. It also does a tiny bit of its own packet processing (basically
parsing just a few required headers). For full packet parsing and
request processing, it sends the request packets to worker threads from
the pool, and gets the response packets back.</p>
<p>You can create more than 1 network thread using the
<code>net_workers</code> directive. That helps when the query pressure
is so extreme that 1 thread gets maxed out. On a quick and dirty
benchmark with v.3.4 (default <code>searchd</code> settings; 96-core
server; 128 clients doing point selects), we got ~110K RPS with 1
thread. Using 2 threads (ie. <code>net_workers = 2</code>) improved that
to ~140K RPS, 3 threads got us ~170K RPS, 4 threads got ~180K-190K RPS,
and then 5 and 6 threads did not yield any further improvements.</p>
<p>Having a dedicated network thread (with some <code>epoll(7)</code>
magic of course) solves all the aforementioned problems. 10K (and more)
open connections with reasonable total RPS are now easily handled even
with 1 thread, instead of forever blocking 10K OS threads. Ditto for
slow clients, also nicely handled by just 1 thread. And last but not
least, it asynchronously watches all the sockets even while worker
threads process the requests, and signals the workers as needed.
Nice!</p>
<p>Of course all those solutions come at a price: there is a rather
inevitable <strong>tiny latency impact</strong>, caused by packet data
traveling between network and worker threads. On our benchmarks with
v.3.4 we observe anywhere between 0.0 and 0.4 msec average extra latency
per query, depending on specific benchmark setup. Now, given that
<em>average</em> full-text queries usually take 20-100 msec and more, in
most cases this extra latency impact would be under 2%, if not
negligible.</p>
<p>Still, take note that in a <em>borderline</em> case when your
<em>average</em> latency is at ~1 msec range, ie. when practically
<em>all</em> your queries are quick and tiny, even those 0.4 msec might
matter. Our point select benchmark is exactly like that, and
<code>threads</code> mode very expectedly shines! At 128 clients we get
~180 Krps in <code>thread_pool</code> mode and ~420 Krps in
<code>threads</code> mode. The respective average latencies are 0.304
msec and 0.711 msec, the difference is 0.407 msec, everything
computes.</p>
<p>Now, <em>client</em> application approaches to networking are also
different:</p>
<ul>
<li>one-off connections, ie. new one established for every query;</li>
<li>small pool, ie. say up to 100-200 “active enough” connections;</li>
<li>huge pool, ie. 1K..10K+ “lazy enough” connections (aka C10K).</li>
</ul>
<p><strong>Net loop mode handles all these cases gracefully</strong>
when properly configured, even under suddenly high load. As the workers
threads count is limited, incoming requests that we do not have the
capacity to process are simply going to be enqueued and and wait for a
free worker thread.</p>
<p><strong>Client thread mode does not</strong>. When the
<code>max_children</code> thread limit is too small, any connections
over the limit are rejected. Even if threads currently using up that
limit are sitting doing nothing! And when the limit is too high,
<code>searchd</code> is at risk, <code>threads</code> could fail
<em>miserably</em> and kill the server. Because if we allow “just” 1000
expectedly lazy clients, then we have to raise <code>max_children</code>
to 1000, but then nothing prevents the clients from becoming active and
firing a volley of <em>simultaneous</em> heavy queries. Instantly
converting 1000 mostly sleeping threads to 1000 very active ones. Boom,
your server is dead now, <code>ssh</code> does not work, where was that
bloody KVM password?</p>
<p>With net loop, defending the castle is (much) easier. Even 1 network
thread can handle network IO for 1000 lazy clients alright. So we can
keep <code>max_children</code> reasonable, properly based on the server
core count, <em>not</em> the expected open connections count. Of course,
a sudden volley of 1000 simultaneous heavy queries will never go
completely unnoticed. It will still max out the worker threads. For the
sake of example, say we set our limit at 40 threads. Those 40 threads
will get instantly busy processing 40 requests, but 960 more requests
will be merely enqueued rather than using up 960 more threads. In fact,
queue length can also be limited by <code>queue_max_length</code>
directive, but the default value is 0 (unlimited). Boom, your server is
now quite busy, and the request queue length might be massive. But at
least <code>ssh</code> works, and just 40 cores are busy, and there are
might be a few spare ones. Much better.</p>
<p>Quick summary?</p>
<p><code>thread_pool</code> threading and net loop networking are better
in most of the production scenarios, and hence they are the default
mode. Yes, sometimes they <em>might</em> add tiny extra latency, but
then again, sometimes they would not.</p>
<p>However, in one very special case (when all your queries are
sub-millisecond and you are actually gunning for 500K+ RPS), consider
using <code>threads</code> mode, because less overheads and better
RPS.</p>
<h4 id="client-disconnects">Client disconnects</h4>
<p>Clients can suddenly disconnect for any reason, at any time.
Including while the server is busy processing a heavy read request.
Which the server could then cancel, and save itself some CPU and
disk.</p>
<p>In client thread mode, we can not do anything about that disconnect,
though. Basically, because while the per-client thread is busy
processing the request, it can not afford to constantly check the client
socket.</p>
<p>In net loop mode, yes we can! Net loop constantly watches
<em>all</em> the client sockets using a dedicated thread, catches such
disconnects ASAP, and then either automatically raises the early
termination flag if there is a respective worker thread (exactly as
manual <a href="#kill-syntax"><code>KILL</code> statement</a> would), or
removes the previously enqueued request if it was still waiting for a
worker.</p>
<p>Therefore, <strong>in net loop mode, client disconnect auto-KILLs its
current query</strong>. Which might sounds dangerous but really is not.
Basically because the affected queries are reads.</p>
<h3 id="outgoing-distributed-queries">Outgoing (distributed)
queries</h3>
<p>Queries that involve remote instances generally work as follows:</p>
<ol type="1">
<li><code>searchd</code> connects to all the required remote
<code>searchd</code> instances (we call them “agents”,) and sends the
respective queries to those instances.</li>
<li>Then it runs all the required local queries, if any.</li>
<li>Then it waits for the remote responses, and does query retries as
needed.</li>
<li>Then it aggregates the final result set, and serves that back to
client.</li>
</ol>
<p>Generally quite simple, but of course there are quite a few
under-the-hood implementation details and quirks. Let’s cover the bigger
ones.</p>
<p>The inter-instance protocol is SphinxAPI, so all instances in the
cluster <em>must</em> have a SphinxAPI listener.</p>
<p>By default every query creates multiple new connections, one for
every agent. <code>agent_persistent</code> and
<code>persistent_connections_limit</code> directives can optimize that.
For agents specified with <code>agent_persistent</code>, master keeps a
pool of open persistent connections, and reuses the connections from
that pool. (Even across different distributed indexes, too.)</p>
<p><code>persistent_connections_limit</code> limits the pool size, on a
<strong>per-agent</strong> basis. Meaning, if you have 10 distributed
indexes that refer to 90 remote indexes on 30 different agents (aka
remote machines, aka unique <code>host:port</code> pairs), <em>and</em>
if you set <code>persistent_connections_limit</code> to 10, then the max
<strong>total</strong> number of open <strong>persistent</strong>
connections will be 300 (because 30 agents by 10 pconns).</p>
<p>Connection step timeout is controlled by
<code>agent_connect_timeout</code> directive, and defaults to 1000 msec
(1 sec). Also, searches (<code>SELECT</code> queries) might retry on
connection failures, up to <code>agent_retry_count</code> times (default
is 0 though), and they will sleep for <code>agent_retry_delay</code>
msec on each retry.</p>
<p>Note that if network connections attempts to some agent stall and
timeout (rather than failing quickly), you can end up with <em>all</em>
distributed queries also stalling for at least 1 sec. The root cause
here is usually more of a host configuration issue; say, a firewall
dropping packets. Still, it makes sense to lower the
<code>agent_connect_timeout</code> preemptively, to reduce the overall
latency even in the unfortunate event of such configuration issues
suddenly popping up. We find that timeouts from 100 to 300 msec work
well within a single DC.</p>
<p>Querying step timeout is in turn controlled by
<code>agent_query_timeout</code>, and defaults to 3000 msec, or 3
sec. Same retrying rules apply. Except that query timeouts are usually
caused by slow queries rather than network issues! Meaning that the
default <code>agent_query_timeout</code> should be adjusted with quite
more care, taking into account your typical queries, SLAs, etc.</p>
<p>Note that these timeouts can (and sometimes must!) be overridden by
the client application on a per-query basis. For instance, what if 99%
of the time we run quick searches that must complete say within 0.5 sec
according to our SLA, but occasionally we still need to fire an
analytical search query taking much more, say up to 1 minute? One
solution here would be to set <code>searchd</code> defaults at
<code>agent_query_timeout = 500</code> for the majority of the queries,
and specify <code>OPTION agent_query_timeout = 60000</code> in the
individual special queries.</p>
<p><code>agent_retry_count</code> applies to <em>both</em> connection
and querying attempts. Example, <code>agent_retry_count = 1</code> means
that either connection <em>or</em> query attempt would be retried, but
not both. More verbosely, if <code>connect()</code> failed initially,
but then succeeded on retry, and then the query timed out, then the
query does <em>not</em> get retried because we were only allowed 1 retry
total and we spent it connecting.</p>
<h3 id="request-hedging">Request hedging</h3>
<p>Occasionally, a single perfectly health agent (out of many) is going
to randomly complete its part of work much, <strong>much</strong> slower
than all the other ones, because reasons. (Maybe because of networks
stalls, or maybe CPU stalls, or whatever.)</p>
<p>We’re talking literally 100x slower here, not 10% slower! We are
seeing random queries with 3 agents out of 4 completing in 0.01 sec and
the last one taking up to 1-2 sec on a daily basis.</p>
<p>With just a few agents per query, these random slowdowns might be
infrequent. They might only show up at p999 query percentile graphs, or
in slow query logs. However, the more agents, the higher the chances of
such a random slowdown, and so Sphinx now supports <strong>request
hedging</strong> to alleviate that.</p>
<p>How does it generally work?</p>
<ul>
<li>We wait for N-1 agents, and track their times.</li>
<li>If the last one is “too slow”, we duplicate the request to another
mirror.</li>
<li>We then accept the fastest response, and terminate the other
request.</li>
</ul>
<p><strong>Request hedging is disabled by default.</strong> You can
enable it either via config with <code>agent_hedge = 1</code>, or via
SphinxQL with <code>SET GLOBAL agent_hedge = 1</code> query.</p>
<p><strong>Request hedging currently requires agent mirrors.</strong> We
don’t retry the very same agent (to avoid additional self-inflicted
overload).</p>
<p><strong>Request hedging only happens for “slow enough”
requests.</strong> This is to avoid duplicating the requests too much.
We will first wait for the slowest agent for some “extra” time (“extra”
compared to all other agents), and only hedge after that “extra” time is
out. There’s a <strong>static</strong> absolute delay (ie. “never hedge
until we waited for N msec”), and there’s a <strong>dynamic</strong>
delay proportional to the elapsed time (ie. “allow the slowest agent to
be X percent slower than everyone else”), and we use the
<strong>maximum</strong> of the two. So hedging only happens when
<strong>both</strong> “is it slow enough?” conditions are met.</p>
<p>The respective <code>searchd</code> config settings are
<code>agent_hedge_delay_min_msec = N</code> and
<code>agent_hedge_delay_pct = X</code>. They can be set online via
<code>SET GLOBAL</code> too.</p>
<p>Bringing all that together, here’s a complete hedging configuration
example.</p>
<div class="sourceCode" id="cb358"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb358-1"><a href="#cb358-1" aria-hidden="true" tabindex="-1"></a><span class="ex">searchd</span></span>
<span id="cb358-2"><a href="#cb358-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb358-3"><a href="#cb358-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">agent_hedge</span> = 1 <span class="co"># enable hedging</span></span>
<span id="cb358-4"><a href="#cb358-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">agent_hedge_delay_pct</span> = 30 <span class="co"># hedge after +30% of &quot;all the others&quot; time..</span></span>
<span id="cb358-5"><a href="#cb358-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">agent_hedge_delay_min_msec</span> = 10 <span class="co"># ..or after 10 msec, whichever is more</span></span>
<span id="cb358-6"><a href="#cb358-6" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>So formally, given N agents, we first wait for (N-1) replies, track
how much time did all those take (called
<code>other_agents_elapsed_msec</code> just below), then wait for the
N-th agent for a bit more.</p>
<div class="sourceCode" id="cb359"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb359-1"><a href="#cb359-1" aria-hidden="true" tabindex="-1"></a>extra_hedge_delay_msec <span class="op">=</span> <span class="bu">max</span>(</span>
<span id="cb359-2"><a href="#cb359-2" aria-hidden="true" tabindex="-1"></a>  agent_hedge_delay_min_msec,</span>
<span id="cb359-3"><a href="#cb359-3" aria-hidden="true" tabindex="-1"></a>  agent_hedge_delay_pct <span class="op">*</span> other_agents_elapsed_msec <span class="op">/</span> <span class="dv">100</span>)</span></code></pre></div>
<p>Then we finally lose patience, hedge our bets, duplicate our request
to another mirror, and let them race. And, of course, hedged requests
are going to complete at more than 2x of their “ideal” time. But that’s
much better than the unhedged alternative (aka huge delay, with a
potential fail on top after that).</p>
<p>For example, when 3 agents out of 4 complete in 200 msec, we compute
our extra hedging delay will be
<code>max(30, 10 * 200 / 100) = max(30, 20) = 30 msec</code> (static
delay is 30 msec, dynamic delay is 20 msec, the bigger one wins). Then
we wait for 30 more msec as computed, and if the slowest agent completes
in 230 msec, nothing happens. Then at 230 msec from the query start we
hedge and issue our second request. Unless that also stalls (which is
possible but extremely rare), our total query time can be expected to be
around 430 msec. Or faster! Because if our first request manages to
complete earlier after all (say, at 270 msec), perfect, we will just use
those results and kill the second request.</p>
<p>The worst case scenario for hedging is perhaps a super fast query,
where, say, most agents complete in 3 msec. But then the last one stalls
for 1000+ msec or even more (and these example values are too from
production, not theory). With our example “wait at least 30% and at
least 10 msec” settings form above we are going to hedge in 10 msec and
complete in 13 msec on average. Yes, this is 4x worse than ideal, but
the randomly stalled request was never going to be ideal anyway. And the
alternative 1000+ msec wait would have been literally 80x worse. Hedging
to the rescue!</p>
<p><strong>The default settings are 20% dynamic delay and 20 msec static
delay.</strong> YMMV, but those currently work well for us.</p>
<h2 id="operations-dumping-data">Operations: dumping data</h2>
<p>Version 3.5 adds very initial <code>mysqldump</code> support to
<code>searchd</code>. SphinxQL dialect differences and schema quirks
currently dictate that you must:</p>
<ol type="1">
<li>Use <code>-c</code> (aka <code>--complete-insert</code>)
option.</li>
<li>Use <code>--skip-opt</code> option (or
<code>--skip-lock-tables --add-locks=off</code>).</li>
<li>Use <code>--where</code> to adjust <code>LIMIT</code> at the very
least.</li>
</ol>
<p>For example:</p>
<div class="sourceCode" id="cb360"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb360-1"><a href="#cb360-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mysqldump</span> <span class="at">-P</span> 9306 <span class="at">-c</span> <span class="at">--skip-opt</span> dummydb test1 <span class="at">--where</span> <span class="st">&quot;id!=0 limit 100&quot;</span></span></code></pre></div>
<p>A few more things will be rough with this initial implementation:</p>
<ul>
<li>Stored fields are not included just yet.</li>
<li>Some of the queries <code>mysqldump</code> tries are expected to
fail. Non-fatally if you’re lucky enough.</li>
<li>Huge result sets are expected to fail, on <code>searchd</code>
side.</li>
</ul>
<p>Anyway, it’s a start.</p>
<h2 id="operations-binlogs">Operations: binlogs</h2>
<p>Binlogs are our write-ahead logs, or WALs. They ensure data safety on
crashes, OOM kills, etc.</p>
<p>You can tweak their behavior using the following directives:</p>
<ul>
<li><a href="#binlog-directive"><code>binlog</code></a> to enable or
disable binlogs in datadir mode;</li>
<li><a
href="#binlog_flush_mode-directive"><code>binlog_flush_mode</code></a>
to tweak the flushing;</li>
<li><a
href="#binlog_max_log_size-directive"><code>binlog_max_log_size</code></a>
to tweak the single log file size threshold.</li>
</ul>
<p>In legacy non-datadir mode there’s the <a
href="#binlog_path-directive"><code>binlog_path</code></a> directive
instead of <code>binlog</code>. It lets you either disable binlogs, or
change their storage location.</p>
<p><strong>WE STRONGLY RECOMMEND AGAINST DISABLING BINLOGS.</strong>
That puts <em>any</em> writes to Sphinx indexes at constant risk of data
loss.</p>
<p>The current defaults are as follows.</p>
<ul>
<li><code>binlog = 1</code>, binlogs are enabled</li>
<li><code>binlog_flush_mode = 2</code>, <code>fflush()</code> and
<code>fsync()</code> every 1 sec</li>
<li><code>binlog_max_log_size = 128M</code>, open a new log file every
128 mb</li>
</ul>
<p>Binlogs are per-index. The settings above apply to all indexes (and
their respective binlogs) at once.</p>
<p>All the binlogs files are stored in the
<code>$datadir/binlogs/</code> folder in the datadir mode, or in
<code>binlog_path</code> (which defaults to <code>.</code>) in the
legacy mode.</p>
<p>Binlogs are automatically replayed after any unclean shutdown. Replay
should recover any freshly written index data that was already stored in
binlogs, but not yet stored in the index disk files.</p>
<p>Single-index binlog replay is single-threaded. However, multi-index
replay is multi-threaded. It uses a small thread pool, sized at 2 to 8
threads, depending on how many indexes there are. The upper limit of 8
is a hardcoded limit that worked well on our testing.</p>
<h2 id="operations-query-logs">Operations: query logs</h2>
<p>By default, <code>searchd</code> keeps a query log file, with
erroneous and/or slow queries logged for later analysis. The default
slow query threshold is 1 sec. The output format is valid SphinxQL, and
the required query metainfo (timestamps, execution timings, error
messages, etc) is <em>always</em> formatted as a comment. So that logged
queries could be easily repeated for testing purposes.</p>
<p>To disable the query log completely, set <code>query_log = no</code>
in your config file.</p>
<blockquote>
<p>NOTE! In legacy non-datadir mode this behavior was pretty much
inverted: <code>query_log</code> defaulted to an empty path, so disabled
by default; and log format defaulted to the legacy “plain” format (that
only logs searches but not query errors nor other query types); and the
slow query threshold defaulted to zero, which causes problems under load
(see below). Meh. We <strong>strongly</strong> suggest switching to
datadir mode, anyway.</p>
</blockquote>
<p>Erroneous queries are logged along with the specific error message.
Both query syntax errors (for example, “unexpected IDENT” on a
<code>selcet 1</code> typo) and server errors (such as the dreaded
“maxed out”) get logged.</p>
<p>Slow queries are logged along with the elapsed wall time at the very
least, and other metainfo such as agent timings where available.</p>
<p>Slow query threshold is set by the <code>query_log_min_msec</code>
directive. The allowed range is from 0 to 3600000 (1 hour in msec), and
the default is 1000 (1 sec).</p>
<p><code>SET GLOBAL query_log_min_msec = &lt;new_value&gt;</code>
changes the threshold on the fly, but beware that the <em>config</em>
value will be used again after <code>searchd</code> restart.</p>
<p>Logged SphinxQL statements currently include <code>SELECT</code>,
<code>INSERT</code>, and <code>REPLACE</code>; this list will likely
grow in the future.</p>
<p>Slow searches are logged over <em>any</em> protocol, ie. slow
SphinxAPI queries get logged too. They are formatted as equivalent
SphinxQL SELECTs.</p>
<p>Technically, you can set <code>query_log_min_msec</code> threshold to
0 and make <code>searchd</code> log all queries, but almost always that
would be a mistake. After all, this log is designed for errors and slow
queries, which are comparatively infrequent. While attempting to “always
log everything” this way might be okay on a small scale, it
<em>will</em> break under heavier loads: it <em>will</em> affect
performance at some point, it risks overflowing the disk, etc. And it
doesn’t log “everything” anyway, as the list of statements “eligible”
for query log is limited.</p>
<p>To capture everything, you should use a different mechanism that
<code>searchd</code> has: the raw SphinxQL logger, aka <a
href="#sql_log_file-variable"><code>sql_log_file</code></a>. Now, that
one is designed to handle extreme loads, it works really fast, and it
guarantees to capture pretty much <em>everything</em> at all. Even the
queries that crash the SQL parser should get caught, because the raw
logger triggers right after the socket reads! However, exhausting the
free disk space is still a risk.</p>
<h2 id="operations-user-auth">Operations: user auth</h2>
<p>We support basic MySQL user auth for SphinxQL. Here’s the gist.</p>
<p>The key directive is <code>auth_users</code>, and it takes a CSV file
name, so for example <code>auth_users = users.csv</code> in the full
form. Note that in datadir mode the users file must reside in the VFS,
ie. in <code>$datadir/extra</code> (or any subfolders).</p>
<p>There must be 3 columns named <code>user</code>, <code>auth</code>,
and <code>flags</code>, and a header line must explicitly list them, as
follows. Briefly, the columns are the user name, the password hash, and
the access permissions.</p>
<div class="sourceCode" id="cb361"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb361-1"><a href="#cb361-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat users.csv</span>
<span id="cb361-2"><a href="#cb361-2" aria-hidden="true" tabindex="-1"></a><span class="ex">user,</span> auth, flags</span>
<span id="cb361-3"><a href="#cb361-3" aria-hidden="true" tabindex="-1"></a><span class="ex">root,</span> a94a8fe5ccb19ba61c4c0873d391e987982fbbd3</span></code></pre></div>
<p>The <code>user</code> column must contain the user name. The names
are case-insensitive, and get forcibly lowercased.</p>
<p>An empty user name is allowed. You can also use a single dash instead
(it gets replaced with an empty string). An empty password is required
when the user name is empty. This re-enables anonymous connections, with
some permissions control. <strong>Temporarily</strong> allowing
anonymous connections (in addition to properly authed ones) helps
transitions from unsecured to secured setups.</p>
<p>The <code>auth</code> column must either be empty or contain a single
dash (both meaning “no password”), or contain the SHA1 or SHA256
password hash. At the moment, <strong>all hashes must have the same
type</strong> (ie. either all SHA1, or all SHA256, mixing not
allowed).</p>
<p>This is dictated by MySQL protocol. We piggyback on its
<code>mysql_native_password</code> and
<code>caching_sha2_password</code> auth methods, based respectively on
SHA1 and SHA256 hashes. Older MySQL clients (before 8.0) support
<code>mysql_native_password</code> method only, which uses SHA1 hash.
Newer clients (since MySQL 9.0), however, support
<code>caching_sha2_password</code> only, which uses SHA256. And 8.x
clients support both methods. Consider this when picking the hashes
type.</p>
<p>You can generate the hash as follows. Mind the gap: the
<code>-n</code> switch is essential here, or the line feed also gets
hashed, and you get a very different hash.</p>
<div class="sourceCode" id="cb362"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb362-1"><a href="#cb362-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> echo <span class="at">-n</span> <span class="st">&quot;test&quot;</span> <span class="kw">|</span> <span class="fu">sha1sum</span></span>
<span id="cb362-2"><a href="#cb362-2" aria-hidden="true" tabindex="-1"></a><span class="ex">a94a8fe5ccb19ba61c4c0873d391e987982fbbd3</span>  <span class="at">-</span></span></code></pre></div>
<p>Use <code>sha256sum</code> instead of <code>sha1sum</code> for SHA256
hashes.</p>
<p>The <code>flags</code> column is optional. Currently, the only
supported flags are access permissions.</p>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>read_only</code></td>
<td>Only reading SQL statements (<code>SELECT</code> etc) are
allowed</td>
</tr>
<tr class="even">
<td><code>write_only</code></td>
<td>Only writing SQL statements (<code>INSERT</code> etc) are
allowed</td>
</tr>
<tr class="odd">
<td><code>read_write</code></td>
<td>All SQL statements allowed</td>
</tr>
</tbody>
</table>
<p>As these are mutually exclusive, exactly one flag is currently
expected. That is highly likely to change in the future, as we add more
flags.</p>
<p>The default permissions (ie. when <code>flags</code> is empty) are
<code>read_write</code>, allowing the user to run any and all SQL
queries, without restrictions.</p>
<p>Here’s an example that limits a password-less user to reads.</p>
<div class="sourceCode" id="cb363"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat users.csv</span>
<span id="cb363-2"><a href="#cb363-2" aria-hidden="true" tabindex="-1"></a><span class="ex">user,</span> auth, flags</span>
<span id="cb363-3"><a href="#cb363-3" aria-hidden="true" tabindex="-1"></a><span class="ex">root,</span> a94a8fe5ccb19ba61c4c0873d391e987982fbbd3</span>
<span id="cb363-4"><a href="#cb363-4" aria-hidden="true" tabindex="-1"></a><span class="ex">reader,</span> <span class="at">-,</span> read_only</span></code></pre></div>
<p>Invalid lines are reported and skipped. At least one valid line is
required.</p>
<p>For security reasons, <code>searchd</code> will <strong>NOT</strong>
start if <code>auth_users</code> file fails to load, or does not have
<em>any</em> valid user entries at all. This is intentional. We believe
that once you explicitly enable and require auth, you do
<strong>not</strong> want the server automatically reverting to “no
auth” mode because of config typos, bad permissions, etc.</p>
<p><a href="#reload-users-syntax">RELOAD USERS</a> statement can reload
the <code>auth_users</code> file on the fly. New sessions will use the
reloaded auth. However, existing sessions are <strong>not</strong>
killed automatically.</p>
<p><strong>Authentication can be disabled on specific MySQL listeners
(aka TCP ports).</strong> The <code>noauth</code> listener flag disables
it completely, and the <code>nolocalauth</code> flag disables it for
local TCP connections originating from the 127.0.0.1 IP address.</p>
<div class="sourceCode" id="cb364"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb364-1"><a href="#cb364-1" aria-hidden="true" tabindex="-1"></a><span class="ex">searchd</span></span>
<span id="cb364-2"><a href="#cb364-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb364-3"><a href="#cb364-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># regular port, requires auth (and does overload checks)</span></span>
<span id="cb364-4"><a href="#cb364-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">listen</span> = 9306:mysql</span>
<span id="cb364-5"><a href="#cb364-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-6"><a href="#cb364-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># admin port, skips auth for local logins (and skips overload checks)</span></span>
<span id="cb364-7"><a href="#cb364-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">listen</span> = 8306:mysql,vip,nolocalauth</span>
<span id="cb364-8"><a href="#cb364-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-9"><a href="#cb364-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb364-10"><a href="#cb364-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">auth_users</span> = users.csv</span>
<span id="cb364-11"><a href="#cb364-11" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p><strong><code>SHOW STATUS</code> displays global authentication
statistics</strong> (only when using authentication). We currently count
total authentication successes and failures, and anonymous
successes.</p>
<div class="sourceCode" id="cb365"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb365-1"><a href="#cb365-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mysql</span><span class="op">&gt;</span> show status like <span class="st">&#39;auth_%&#39;</span><span class="kw">;</span></span>
<span id="cb365-2"><a href="#cb365-2" aria-hidden="true" tabindex="-1"></a><span class="ex">+-------------+-------+</span></span>
<span id="cb365-3"><a href="#cb365-3" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">Counter</span>     <span class="kw">|</span> <span class="ex">Value</span> <span class="kw">|</span></span>
<span id="cb365-4"><a href="#cb365-4" aria-hidden="true" tabindex="-1"></a><span class="ex">+-------------+-------+</span></span>
<span id="cb365-5"><a href="#cb365-5" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">auth_passes</span> <span class="kw">|</span> <span class="ex">2</span>     <span class="kw">|</span></span>
<span id="cb365-6"><a href="#cb365-6" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">auth_anons</span>  <span class="kw">|</span> <span class="ex">0</span>     <span class="kw">|</span></span>
<span id="cb365-7"><a href="#cb365-7" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">auth_fails</span>  <span class="kw">|</span> <span class="ex">8</span>     <span class="kw">|</span></span>
<span id="cb365-8"><a href="#cb365-8" aria-hidden="true" tabindex="-1"></a><span class="ex">+-------------+-------+</span></span>
<span id="cb365-9"><a href="#cb365-9" aria-hidden="true" tabindex="-1"></a><span class="ex">3</span> rows in set <span class="er">(</span><span class="ex">0.00</span> sec<span class="kw">)</span></span></code></pre></div>
<p><strong>Users can be temporarily locked out and unlocked on the
fly.</strong> <code>LOCK USER</code> and <code>UNLOCK USER</code>
statements do that. They take a string argument (so the anonymous user
is also subject to locking).</p>
<div class="sourceCode" id="cb366"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb366-1"><a href="#cb366-1" aria-hidden="true" tabindex="-1"></a><span class="kw">LOCK</span> <span class="fu">USER</span> <span class="st">&#39;embeddings_service&#39;</span>;</span>
<span id="cb366-2"><a href="#cb366-2" aria-hidden="true" tabindex="-1"></a><span class="kw">UNLOCK</span> <span class="fu">USER</span> <span class="st">&#39;&#39;</span>;</span></code></pre></div>
<p>A locked out user won’t be able to connect.</p>
<p>The only intended use (for now!) is emergency maintenance, to
<em>temporarily</em> disable certain offending clients. That will likely
change in the future, but for now, that’s the primary goal.</p>
<p>So locking is ephemeral, ie. after <code>searchd</code> restart all
users are going to be automatically unlocked again. For emergency
maintenance, that suffices. And any permanent access changes must happen
in the <code>auth_users</code> file.</p>
<p>Existing queries and open connections are <strong>not</strong>
terminated automatically, though, giving them a chance to complete
normally. (We should probably add more statements or options for that,
though.)</p>
<blockquote>
<p>WARNING! No safeguards are currently implemented.
<code>LOCK USER</code> <strong>can</strong> lock out
<strong>all</strong> existing users. Use with care.</p>
</blockquote>
<p>See also <a href="#lock-user-syntax">“<code>LOCK USER</code>
syntax”</a>.</p>
<h3 id="sha1-security-notes">SHA1 security notes</h3>
<p>Let’s briefly discuss “broken” SHA1 hashes, how Sphinx uses them, and
what are the possible attack vectors here.</p>
<p><strong>Sphinx never stores plain text passwords.</strong> So
grabbing the <em>passwords</em> themselves is not possible.</p>
<p><strong>Sphinx stores SHA1 hashes of the passwords.</strong> And if
an attacker gains access to those, they can:</p>
<ul>
<li>access any other Sphinx or MySQL instances that use that hash;
or</li>
<li>attempt to reverse the hash for the password (which may or may not
succeed).</li>
</ul>
<p>Therefore, <strong>SHA1 hashes must be secured just as well as plain
text passwords</strong>.</p>
<p>Now, a bit of good news, even though hash leak means access leak, the
original password <em>text</em> itself is not <em>necessarily</em> at
risk.</p>
<p>SHA1 is considered “broken” since 2020 but that only applies to the
so-called collision attacks, basically affecting the digital signatures.
The feasibility of recovering the password does still depend on its
quality. That includes any previous leaks.</p>
<p>For instance, bruteforcing SHA1 for <em>all</em> mixed 9-char
letter-digit passwords should only take 3 days on a single Nvidia RTX
4090 GPU. But make that a good, strong, truly random 12-char mix and
we’re looking at 2000 GPU-years. But leak that password just once, and
eventually attackers only needs seconds.</p>
<p>Bottom line here? <strong>Use strong random passwords, and never
reuse them.</strong></p>
<p>Next item, <strong>traffic sniffing is actually at the same ballpark
as a hash leak</strong>, security-wise. Sniffing a successfully authed
session provides enough data to attempt bruteforcing your passwords!
Strong passwords will hold, weak ones will break. This isn’t even
Sphinx-specific and applies to MySQL just as well.</p>
<p>Last but not least, <strong>why implement old SHA1 in 2023?</strong>
Because MySQL protocol. We naturally <em>have</em> to use its auth
methods too. And we wanna be as compatible with various clients
(including older ones) as possible. And that’s a priority, especially
given that Sphinx must be normally used within a secure perimeter
anyway.</p>
<p>So despite that MySQL server defaults to
<code>caching_sha2_password</code> auth method these days, the most
<strong>compatible</strong> auth method that <strong>clients</strong>
support still would be <code>mysql_native_password</code> based on
SHA1.</p>
<p><strong>Most of the above applies to SHA256 hashes just as
well</strong>, except those are <strong>much</strong> harder to
brute-force.</p>
<h2 id="operations-altering-distributed-indexes">Operations: altering
distributed indexes</h2>
<p>Distributed index is essentially a list of local indexes and/or
remote agents, aka indexes on remote machines. These participants lists
are fully manageable online via SphinxQL statements (specifically,
<code>DESCRIBE</code>, <code>SHOW AGENT STATUS</code>,
<code>ALTER REMOTE</code>, and <code>ALTER LOCAL</code>). Let’s walk
through how!</p>
<p><strong>To examine an existing distributed index</strong>, just use
<code>DESCRIBE</code>, which should give you the list of agents and
their mirrors (if any). For instance, let’s add the following example
distributed index to our config file.</p>
<div class="sourceCode" id="cb367"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> distr</span>
<span id="cb367-2"><a href="#cb367-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb367-3"><a href="#cb367-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">type</span> = distributed</span>
<span id="cb367-4"><a href="#cb367-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ha_strategy</span> = roundrobin</span>
<span id="cb367-5"><a href="#cb367-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">agent</span> = host1.int:7013:testindex<span class="kw">|</span><span class="ex">host2.int:7013:testindex</span></span>
<span id="cb367-6"><a href="#cb367-6" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<p>We have just 1 agent here, but define 2 mirrors for it. In this
example, <code>host1.int</code> and <code>host2.int</code> are the
network host names (or they could be IP addresses), 7013 is the TCP
port, and <code>testindex</code> is the remote index name,
respectively.</p>
<p><code>DESCRIBE</code> enumerates all the agents and mirrors, as
expected. Note the numbers that it reports. They matter! We will use
them shortly in our <code>ALTER</code> queries.</p>
<div class="sourceCode" id="cb368"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb368-1"><a href="#cb368-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> DESCRIBE distr;</span>
<span id="cb368-2"><a href="#cb368-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------+-------------------+</span></span>
<span id="cb368-3"><a href="#cb368-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">Agent</span>                    | <span class="kw">Type</span>              |</span>
<span id="cb368-4"><a href="#cb368-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------+-------------------+</span></span>
<span id="cb368-5"><a href="#cb368-5" aria-hidden="true" tabindex="-1"></a>| host1.<span class="dt">int</span><span class="ch">:7013:testindex</span> | remote_1_mirror_1 |</span>
<span id="cb368-6"><a href="#cb368-6" aria-hidden="true" tabindex="-1"></a>| host2.<span class="dt">int</span><span class="ch">:7013:testindex</span> | remote_1_mirror_2 |</span>
<span id="cb368-7"><a href="#cb368-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------+-------------------+</span></span>
<span id="cb368-8"><a href="#cb368-8" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p><strong>To add or drop a local index</strong>, use
<code>ALTER ... {ADD | DROP} LOCAL</code> statements. They require a
local FT-index name.</p>
<div class="sourceCode" id="cb369"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a># syntax</span>
<span id="cb369-2"><a href="#cb369-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>distr_index<span class="op">&gt;</span> <span class="kw">ADD</span> <span class="kw">LOCAL</span> <span class="op">&lt;</span>local_index_name<span class="op">&gt;</span></span>
<span id="cb369-3"><a href="#cb369-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>distr_index<span class="op">&gt;</span> <span class="kw">DROP</span> <span class="kw">LOCAL</span> <span class="op">&lt;</span>local_index_name<span class="op">&gt;</span></span>
<span id="cb369-4"><a href="#cb369-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb369-5"><a href="#cb369-5" aria-hidden="true" tabindex="-1"></a># example</span>
<span id="cb369-6"><a href="#cb369-6" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> distr <span class="kw">ADD</span> <span class="kw">LOCAL</span> foo</span>
<span id="cb369-7"><a href="#cb369-7" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> distr <span class="kw">DROP</span> <span class="kw">LOCAL</span> bar</span></code></pre></div>
<p>And to immediately apply that example…</p>
<div class="sourceCode" id="cb370"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb370-1"><a href="#cb370-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">ALTER</span> <span class="kw">TABLE</span> distr <span class="kw">ADD</span> <span class="kw">LOCAL</span> foo;</span>
<span id="cb370-2"><a href="#cb370-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb370-3"><a href="#cb370-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb370-4"><a href="#cb370-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">ALTER</span> <span class="kw">TABLE</span> distr <span class="kw">DROP</span> <span class="kw">LOCAL</span> bar;</span>
<span id="cb370-5"><a href="#cb370-5" aria-hidden="true" tabindex="-1"></a>ERROR <span class="dv">1064</span> (<span class="dv">42000</span>): <span class="kw">no</span> such <span class="kw">local</span> <span class="kw">index</span> <span class="st">&#39;bar&#39;</span> <span class="kw">in</span> <span class="kw">distributed</span> <span class="kw">index</span> <span class="st">&#39;distr&#39;</span></span>
<span id="cb370-6"><a href="#cb370-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb370-7"><a href="#cb370-7" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> DESCRIBE distr;</span>
<span id="cb370-8"><a href="#cb370-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------+-------------------+</span></span>
<span id="cb370-9"><a href="#cb370-9" aria-hidden="true" tabindex="-1"></a>| <span class="kw">Agent</span>                    | <span class="kw">Type</span>              |</span>
<span id="cb370-10"><a href="#cb370-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------+-------------------+</span></span>
<span id="cb370-11"><a href="#cb370-11" aria-hidden="true" tabindex="-1"></a>| foo                      | <span class="kw">local</span>             |</span>
<span id="cb370-12"><a href="#cb370-12" aria-hidden="true" tabindex="-1"></a>| host1.<span class="dt">int</span><span class="ch">:7013:testindex</span> | remote_1_mirror_1 |</span>
<span id="cb370-13"><a href="#cb370-13" aria-hidden="true" tabindex="-1"></a>| host2.<span class="dt">int</span><span class="ch">:7013:testindex</span> | remote_1_mirror_2 |</span>
<span id="cb370-14"><a href="#cb370-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------+-------------------+</span></span>
<span id="cb370-15"><a href="#cb370-15" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>We can remove that test participant with
<code>ALTER TABLE distr DROP LOCAL foo</code> now. (For the record, that
only removes it from <code>distr</code>, not generally. No worries.)</p>
<p><strong>To add or drop an agent</strong>, we use
<code>ALTER ... {ADD | DROP} REMOTE</code> statements. <code>ADD</code>
requires an agent specification string (spec string for short) that
shares its syntax with the <code>agent</code> directive.
<code>DROP</code> requires a number.</p>
<div class="sourceCode" id="cb371"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb371-1"><a href="#cb371-1" aria-hidden="true" tabindex="-1"></a># syntax</span>
<span id="cb371-2"><a href="#cb371-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>distr_index<span class="op">&gt;</span> <span class="kw">ADD</span> REMOTE <span class="st">&#39;&lt;agent_spec&gt;&#39;</span></span>
<span id="cb371-3"><a href="#cb371-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>distr_index<span class="op">&gt;</span> <span class="kw">DROP</span> REMOTE <span class="op">&lt;</span>remote_num<span class="op">&gt;</span></span>
<span id="cb371-4"><a href="#cb371-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb371-5"><a href="#cb371-5" aria-hidden="true" tabindex="-1"></a># example</span>
<span id="cb371-6"><a href="#cb371-6" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> foo <span class="kw">ADD</span> REMOTE <span class="st">&#39;box123.dc4.internal:9306:bar&#39;</span></span>
<span id="cb371-7"><a href="#cb371-7" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> foo <span class="kw">DROP</span> REMOTE <span class="dv">7</span></span></code></pre></div>
<p>Let’s make that somewhat more interesting, and add a special,
mirrored blackhole agent. Because we can. Because <code>agent</code>
spec syntax <em>does</em> allow that!</p>
<div class="sourceCode" id="cb372"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb372-1"><a href="#cb372-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">ALTER</span> <span class="kw">TABLE</span> distr <span class="kw">ADD</span> REMOTE</span>
<span id="cb372-2"><a href="#cb372-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="st">&#39;host4.int:7016:testindex|host5.int:7016:testindex[blackhole=1]&#39;</span>;</span>
<span id="cb372-3"><a href="#cb372-3" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb372-4"><a href="#cb372-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-5"><a href="#cb372-5" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> DESCRIBE distr;</span>
<span id="cb372-6"><a href="#cb372-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------+-----------------------------+</span></span>
<span id="cb372-7"><a href="#cb372-7" aria-hidden="true" tabindex="-1"></a>| <span class="kw">Agent</span>                    | <span class="kw">Type</span>                        |</span>
<span id="cb372-8"><a href="#cb372-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------+-----------------------------+</span></span>
<span id="cb372-9"><a href="#cb372-9" aria-hidden="true" tabindex="-1"></a>| host1.<span class="dt">int</span><span class="ch">:7013:testindex</span> | remote_1_mirror_1           |</span>
<span id="cb372-10"><a href="#cb372-10" aria-hidden="true" tabindex="-1"></a>| host2.<span class="dt">int</span><span class="ch">:7013:testindex</span> | remote_1_mirror_2           |</span>
<span id="cb372-11"><a href="#cb372-11" aria-hidden="true" tabindex="-1"></a>| host4.<span class="dt">int</span><span class="ch">:7016:testindex</span> | remote_2_mirror_1_blackhole |</span>
<span id="cb372-12"><a href="#cb372-12" aria-hidden="true" tabindex="-1"></a>| host5.<span class="dt">int</span><span class="ch">:7016:testindex</span> | remote_2_mirror_2_blackhole |</span>
<span id="cb372-13"><a href="#cb372-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------+-----------------------------+</span></span>
<span id="cb372-14"><a href="#cb372-14" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Okay, we can see the second agent (aka remote #2) and see it’s a
blackhole. (For the record, <code>SHOW AGENT STATUS</code> statement
also reports that flag.)</p>
<div class="sourceCode" id="cb373"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW <span class="kw">AGENT</span> distr STATUS <span class="kw">like</span> <span class="st">&#39;%blackhole%&#39;</span>;</span>
<span id="cb373-2"><a href="#cb373-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------+-------+</span></span>
<span id="cb373-3"><a href="#cb373-3" aria-hidden="true" tabindex="-1"></a>| Variable_name                  | <span class="fu">Value</span> |</span>
<span id="cb373-4"><a href="#cb373-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------+-------+</span></span>
<span id="cb373-5"><a href="#cb373-5" aria-hidden="true" tabindex="-1"></a>| dstindex_1mirror1_is_blackhole | <span class="dv">0</span>     |</span>
<span id="cb373-6"><a href="#cb373-6" aria-hidden="true" tabindex="-1"></a>| dstindex_1mirror2_is_blackhole | <span class="dv">0</span>     |</span>
<span id="cb373-7"><a href="#cb373-7" aria-hidden="true" tabindex="-1"></a>| dstindex_2mirror1_is_blackhole | <span class="dv">1</span>     |</span>
<span id="cb373-8"><a href="#cb373-8" aria-hidden="true" tabindex="-1"></a>| dstindex_2mirror2_is_blackhole | <span class="dv">1</span>     |</span>
<span id="cb373-9"><a href="#cb373-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------+-------+</span></span>
<span id="cb373-10"><a href="#cb373-10" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>All went well. Note how the magic <code>[blackhole=1]</code> option
was applied to both mirrors that we added, same as it would if we used
the <code>agent</code> config directive. (Yep, the syntax is crazy ugly,
we know.) To finish this bit off, let’s drop this agent.</p>
<div class="sourceCode" id="cb374"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb374-1"><a href="#cb374-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">ALTER</span> <span class="kw">TABLE</span> distr <span class="kw">DROP</span> REMOTE <span class="dv">2</span>;</span>
<span id="cb374-2"><a href="#cb374-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb374-3"><a href="#cb374-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb374-4"><a href="#cb374-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> DESCRIBE distr;</span>
<span id="cb374-5"><a href="#cb374-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------+-------------------+</span></span>
<span id="cb374-6"><a href="#cb374-6" aria-hidden="true" tabindex="-1"></a>| <span class="kw">Agent</span>                    | <span class="kw">Type</span>              |</span>
<span id="cb374-7"><a href="#cb374-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------+-------------------+</span></span>
<span id="cb374-8"><a href="#cb374-8" aria-hidden="true" tabindex="-1"></a>| host1.<span class="dt">int</span><span class="ch">:7013:testindex</span> | remote_1_mirror_1 |</span>
<span id="cb374-9"><a href="#cb374-9" aria-hidden="true" tabindex="-1"></a>| host2.<span class="dt">int</span><span class="ch">:7013:testindex</span> | remote_1_mirror_2 |</span>
<span id="cb374-10"><a href="#cb374-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------+-------------------+</span></span>
<span id="cb374-11"><a href="#cb374-11" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Okay, back to square one. Now let’s see how to manage individual
mirrors.</p>
<p><strong>To add or drop a mirror</strong>, we use the
<code>ALTER REMOTE MIRROR</code> statement, always identifying our
remotes (aka agents) by their numbers, and now using mirror spec string
for adds, and either mirror numbers or mirror spec patterns for
removals.</p>
<div class="sourceCode" id="cb375"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb375-1"><a href="#cb375-1" aria-hidden="true" tabindex="-1"></a># syntax</span>
<span id="cb375-2"><a href="#cb375-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>distr_index<span class="op">&gt;</span> <span class="kw">ADD</span> REMOTE <span class="op">&lt;</span>remote_num<span class="op">&gt;</span> MIRROR <span class="st">&#39;&lt;mirror_spec&gt;&#39;</span></span>
<span id="cb375-3"><a href="#cb375-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>distr_index<span class="op">&gt;</span> <span class="kw">DROP</span> REMOTE <span class="op">&lt;</span>remote_num<span class="op">&gt;</span> MIRROR <span class="op">&lt;</span>mirror_num<span class="op">&gt;</span></span>
<span id="cb375-4"><a href="#cb375-4" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>distr_index<span class="op">&gt;</span> <span class="kw">DROP</span> REMOTE <span class="op">&lt;</span>remote_num<span class="op">&gt;</span> MIRROR <span class="kw">LIKE</span> <span class="st">&#39;&lt;mask&gt;&#39;</span></span></code></pre></div>
<p>For example, let’s add another mirror. We will use a different remote
index name this time. Again, because we can.</p>
<div class="sourceCode" id="cb376"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb376-1"><a href="#cb376-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">ALTER</span> <span class="kw">TABLE</span> distr <span class="kw">ADD</span> REMOTE <span class="dv">1</span> MIRROR <span class="st">&#39;host3.int:7013:indexalias&#39;</span>;</span>
<span id="cb376-2"><a href="#cb376-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb376-3"><a href="#cb376-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb376-4"><a href="#cb376-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> describe distr;</span>
<span id="cb376-5"><a href="#cb376-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------+-------------------+</span></span>
<span id="cb376-6"><a href="#cb376-6" aria-hidden="true" tabindex="-1"></a>| <span class="kw">Agent</span>                     | <span class="kw">Type</span>              |</span>
<span id="cb376-7"><a href="#cb376-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------+-------------------+</span></span>
<span id="cb376-8"><a href="#cb376-8" aria-hidden="true" tabindex="-1"></a>| host1.<span class="dt">int</span><span class="ch">:7013:testindex</span>  | remote_1_mirror_1 |</span>
<span id="cb376-9"><a href="#cb376-9" aria-hidden="true" tabindex="-1"></a>| host2.<span class="dt">int</span><span class="ch">:7013:testindex</span>  | remote_1_mirror_2 |</span>
<span id="cb376-10"><a href="#cb376-10" aria-hidden="true" tabindex="-1"></a>| host3.<span class="dt">int</span><span class="ch">:7013:indexalias</span> | remote_1_mirror_3 |</span>
<span id="cb376-11"><a href="#cb376-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------+-------------------+</span></span>
<span id="cb376-12"><a href="#cb376-12" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>And let’s test dropping the mirror. Perhaps <code>host2.int</code>
went down, and we now want to remove it.</p>
<div class="sourceCode" id="cb377"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">ALTER</span> <span class="kw">TABLE</span> distr <span class="kw">DROP</span> REMOTE <span class="dv">1</span> MIRROR <span class="dv">2</span>;</span>
<span id="cb377-2"><a href="#cb377-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb377-3"><a href="#cb377-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-4"><a href="#cb377-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> DESCRIBE distr;</span>
<span id="cb377-5"><a href="#cb377-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------+-------------------+</span></span>
<span id="cb377-6"><a href="#cb377-6" aria-hidden="true" tabindex="-1"></a>| <span class="kw">Agent</span>                     | <span class="kw">Type</span>              |</span>
<span id="cb377-7"><a href="#cb377-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------+-------------------+</span></span>
<span id="cb377-8"><a href="#cb377-8" aria-hidden="true" tabindex="-1"></a>| host1.<span class="dt">int</span><span class="ch">:7013:testindex</span>  | remote_1_mirror_1 |</span>
<span id="cb377-9"><a href="#cb377-9" aria-hidden="true" tabindex="-1"></a>| host3.<span class="dt">int</span><span class="ch">:7013:indexalias</span> | remote_1_mirror_2 |</span>
<span id="cb377-10"><a href="#cb377-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------+-------------------+</span></span>
<span id="cb377-11"><a href="#cb377-11" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p><strong>Mirror spec patterns</strong> (instead of numbers) can be
useful to remove multiple mirrors at once. They apply to the complete
<code>&lt;host&gt;:&lt;port&gt;:&lt;index&gt;</code> spec string, so you
can pick mirrors by host, or index name, or whatever. The pattern syntax
is the standard SQL one; see <a href="#like-and-ignore-clause">LIKE and
IGNORE clause</a> for details.</p>
<p>Continuing our running example, to drop that now-second mirror with
<code>host3.int</code> from our first (and only) remote, any of the
following would work.</p>
<div class="sourceCode" id="cb378"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb378-1"><a href="#cb378-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> distr <span class="kw">DROP</span> REMOTE <span class="dv">1</span> MIRROR <span class="kw">LIKE</span> <span class="st">&#39;host3%indexalias&#39;</span></span>
<span id="cb378-2"><a href="#cb378-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> distr <span class="kw">DROP</span> REMOTE <span class="dv">1</span> MIRROR <span class="kw">LIKE</span> <span class="st">&#39;host3%&#39;</span></span>
<span id="cb378-3"><a href="#cb378-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> distr <span class="kw">DROP</span> REMOTE <span class="dv">1</span> MIRROR <span class="kw">LIKE</span> <span class="st">&#39;%indexalias&#39;</span></span></code></pre></div>
<p>Proof-pic! Let’s drop all the mirrors with a very specific remote
index name. (Yeah, we currently have just one, but what if we had ten
“bad” mirrors?)</p>
<div class="sourceCode" id="cb379"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb379-1"><a href="#cb379-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">ALTER</span> <span class="kw">TABLE</span> distr <span class="kw">DROP</span> REMOTE <span class="dv">1</span> MIRROR <span class="kw">LIKE</span> <span class="st">&#39;%:indexalias&#39;</span>;</span>
<span id="cb379-2"><a href="#cb379-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb379-3"><a href="#cb379-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb379-4"><a href="#cb379-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> DESCRIBE distr;</span>
<span id="cb379-5"><a href="#cb379-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------+----------+</span></span>
<span id="cb379-6"><a href="#cb379-6" aria-hidden="true" tabindex="-1"></a>| <span class="kw">Agent</span>                    | <span class="kw">Type</span>     |</span>
<span id="cb379-7"><a href="#cb379-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------+----------+</span></span>
<span id="cb379-8"><a href="#cb379-8" aria-hidden="true" tabindex="-1"></a>| host1.<span class="dt">int</span><span class="ch">:7013:testindex</span> | remote_1 |</span>
<span id="cb379-9"><a href="#cb379-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------+----------+</span></span>
<span id="cb379-10"><a href="#cb379-10" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>All good! Now, just a few more nitpicks.</p>
<p>First, <strong>agent and mirror numbers are simply array
indexes</strong>. See how they do not change on adds, and how they
“shift” on deletions? When we add a new agent, it’s appended to the
array (of agents), so any existing indexes do not change. When we drop
one, all subsequent agents are shifted left, and their indexes decrease
by one. Ditto for mirrors.</p>
<p>Second, <strong>you can not drop the last mirror standing</strong>.
For that, you have to <strong>explicitly</strong> drop the entire
agent.</p>
<p>Third, <strong>adding multiple mirrors is allowed, and options apply
to all mirrors.</strong> Just as in the <code>agent</code> config
directive, to reiterate a bit.</p>
<p>Fourth, <strong>mirror options must match across a given
remote</strong>. For example, when some remote already has 2 regular
mirrors, we can’t add a 3rd blackhole mirror. That’s why options are
banned in the <code>ADD REMOTE ... MIRROR</code> statements.</p>
<p>Last but not least, <strong>agents, mirrors and options survive
restarts.</strong> Moreover, <strong>config now behaves as
<code>CREATE TABLE IF NOT EXISTS</code> for distributed
indexes.</strong></p>
<p><strong>Online changes take precedence over config changes.</strong>
Distributed indexes settings that were ever changed (with
<code>ALTER</code>) online via SphinxQL take full precedence over
whatever’s in the config file.</p>
<p>In other words, <code>ALTER</code> statement instantly sticks! Target
distributed index <strong>immediately</strong> starts
<strong>ignoring</strong> any further <code>sphinx.conf</code> changes.
However, as long as a distributed index is never ever ALTER-ed online,
the config changes should still take effect on restart. (At the moment,
the only way to “unstick” it is by tweaking <code>searchd.state</code>
manually.)</p>
<h2 id="sphinxql-reference">SphinxQL reference</h2>
<p>This section should eventually contain the complete SphinxQL
reference.</p>
<p>If the statement you’re looking for is not yet documented here,
please refer to the legacy <a
href="sphinx2.html#sphinxql-reference">Sphinx v.2.x reference</a>.
Beware that the legacy reference may not be up to date.</p>
<p>Here’s a complete list of SphinxQL statements.</p>
<ul>
<li><a href="#alter-syntax">ALTER syntax</a></li>
<li><a href="#alter-column-syntax">ALTER COLUMN syntax</a></li>
<li><a href="#alter-option-syntax">ALTER OPTION syntax</a></li>
<li><a href="#alter-remote-syntax">ALTER REMOTE syntax</a></li>
<li><a href="#attach-index-syntax">ATTACH INDEX syntax</a></li>
<li><a href="sphinx2.html#sphinxql-begin">BEGIN syntax</a></li>
<li><a href="#bulk-update-syntax">BULK UPDATE syntax</a></li>
<li><a href="#call-syntax">CALL syntax</a></li>
<li><a href="#call-keywords-syntax">CALL KEYWORDS syntax</a></li>
<li><a href="sphinx2.html#sphinxql-call-qsuggest">CALL QSUGGEST
syntax</a></li>
<li><a href="sphinx2.html#sphinxql-call-snippets">CALL SNIPPETS
syntax</a></li>
<li><a href="sphinx2.html#sphinxql-call-suggest">CALL SUGGEST
syntax</a></li>
<li><a href="#clone-syntax">CLONE syntax</a></li>
<li><a href="#clone-index-syntax">CLONE INDEX syntax</a></li>
<li><a href="sphinx2.html#sphinxql-commit">COMMIT syntax</a></li>
<li><a href="sphinx2.html#sphinxql-create-function">CREATE FUNCTION
syntax</a></li>
<li><a href="#create-index-syntax">CREATE INDEX syntax</a></li>
<li><a href="sphinx2.html#sphinxql-create-plugin">CREATE PLUGIN
syntax</a></li>
<li><a href="#create-table-syntax">CREATE TABLE syntax</a></li>
<li><a href="#create-universal-index-syntax">CREATE UNIVERSAL INDEX
syntax</a></li>
<li><a href="sphinx2.html#sphinxql-delete">DELETE syntax</a></li>
<li><a href="#describe-syntax">DESCRIBE syntax</a></li>
<li><a href="sphinx2.html#sphinxql-drop-function">DROP FUNCTION
syntax</a></li>
<li><a href="#drop-index-syntax">DROP INDEX syntax</a></li>
<li><a href="sphinx2.html#sphinxql-drop-plugin">DROP PLUGIN
syntax</a></li>
<li><a href="#drop-table-syntax">DROP TABLE syntax</a></li>
<li><a href="#drop-universal-index-syntax">DROP UNIVERSAL INDEX
syntax</a></li>
<li><a href="#explain-select-syntax">EXPLAIN SELECT syntax</a></li>
<li><a href="sphinx2.html#sphinxql-flush-attributes">FLUSH ATTRIBUTES
syntax</a></li>
<li><a href="sphinx2.html#sphinxql-flush-hostnames">FLUSH HOSTNAMES
syntax</a></li>
<li><a href="#flush-index-syntax">FLUSH INDEX syntax</a></li>
<li><a href="#flush-manifest-syntax">FLUSH MANIFEST syntax</a></li>
<li><a href="sphinx2.html#sphinxql-flush-ramchunk">FLUSH RAMCHUNK
syntax</a></li>
<li><a href="#insert-syntax">INSERT syntax</a></li>
<li><a href="#kill-syntax">KILL syntax</a></li>
<li><a href="#lock-user-syntax">LOCK USER syntax</a></li>
<li><a href="sphinx2.html#sphinxql-optimize-index">OPTIMIZE INDEX
syntax</a></li>
<li><a href="#pull-syntax">PULL syntax</a></li>
<li><a href="sphinx2.html#sphinxql-reload-index">RELOAD INDEX
syntax</a></li>
<li><a href="sphinx2.html#sphinxql-reload-plugins">RELOAD PLUGINS
syntax</a></li>
<li><a href="#reload-users-syntax">RELOAD USERS syntax</a></li>
<li><a href="#replace-syntax">REPLACE syntax</a></li>
<li><a href="sphinx2.html#sphinxql-rollback">ROLLBACK syntax</a></li>
<li><a href="#select-syntax">SELECT syntax</a></li>
<li><a href="#select-expr-syntax">SELECT expr syntax</a></li>
<li><a href="#select-uservar-syntax">SELECT <span class="citation"
data-cites="uservar">@uservar</span> syntax</a></li>
<li><a href="#select-sysvar-syntax">SELECT @<span class="citation"
data-cites="sysvar">@sysvar</span> syntax</a></li>
<li><a href="sphinx2.html#sphinxql-set">SET syntax</a></li>
<li><a href="sphinx2.html#sphinxql-set-transaction">SET TRANSACTION
syntax</a></li>
<li><a href="sphinx2.html#sphinxql-show-agent-status">SHOW AGENT STATUS
syntax</a></li>
<li><a href="sphinx2.html#sphinxql-show-character-set">SHOW CHARACTER
SET syntax</a></li>
<li><a href="sphinx2.html#sphinxql-show-collation">SHOW COLLATION
syntax</a></li>
<li><a href="#show-create-table-syntax">SHOW CREATE TABLE
syntax</a></li>
<li><a href="sphinx2.html#sphinxql-show-databases">SHOW DATABASES
syntax</a></li>
<li><a href="#show-followers-syntax">SHOW FOLLOWERS syntax</a></li>
<li><a href="#show-index-agent-status-syntax">SHOW INDEX AGENT STATUS
syntax</a></li>
<li><a href="#show-index-from-syntax">SHOW INDEX FROM syntax</a></li>
<li><a href="sphinx2.html#sphinxql-show-index-settings">SHOW INDEX
SETTINGS syntax</a></li>
<li><a href="#show-index-status-syntax">SHOW INDEX STATUS
syntax</a></li>
<li><a href="#show-index-segment-status-syntax">SHOW INDEX SEGMENT
STATUS syntax</a></li>
<li><a href="#show-manifest-syntax">SHOW MANIFEST syntax</a></li>
<li><a href="#show-meta-syntax">SHOW META syntax</a></li>
<li><a href="#show-optimize-status-syntax">SHOW OPTIMIZE STATUS
syntax</a></li>
<li><a href="sphinx2.html#sphinxql-show-plan">SHOW PLAN syntax</a></li>
<li><a href="sphinx2.html#sphinxql-show-plugins">SHOW PLUGINS
syntax</a></li>
<li><a href="#show-profile-syntax">SHOW PROFILE syntax</a></li>
<li><a href="#show-replicas-syntax">SHOW REPLICAS syntax</a></li>
<li><a href="#show-status-syntax">SHOW STATUS syntax</a></li>
<li><a href="#show-index-status-syntax">SHOW TABLE STATUS
syntax</a></li>
<li><a href="sphinx2.html#sphinxql-show-tables">SHOW TABLES
syntax</a></li>
<li><a href="#show-threads-syntax">SHOW THREADS syntax</a></li>
<li><a href="#show-variables-syntax">SHOW VARIABLES syntax</a></li>
<li><a href="sphinx2.html#sphinxql-show-warnings">SHOW WARNINGS
syntax</a></li>
<li><a href="#truncate-index-syntax">TRUNCATE INDEX syntax</a></li>
<li><a href="#lock-user-syntax">UNLOCK USER syntax</a></li>
<li><a href="#update-syntax">UPDATE syntax</a></li>
</ul>
<h3 id="alter-syntax">ALTER syntax</h3>
<div class="sourceCode" id="cb380"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb380-1"><a href="#cb380-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>ftindex<span class="op">&gt;</span> {<span class="kw">ADD</span> | <span class="kw">DROP</span>} <span class="kw">COLUMN</span> <span class="op">&lt;</span>colname<span class="op">&gt;</span> <span class="op">&lt;</span>coltype<span class="op">&gt;</span></span>
<span id="cb380-2"><a href="#cb380-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>distindex<span class="op">&gt;</span> {<span class="kw">ADD</span> | <span class="kw">DROP</span>} REMOTE <span class="op">&lt;</span>spec | num<span class="op">&gt;</span> [MIRROR <span class="op">..</span>.]</span>
<span id="cb380-3"><a href="#cb380-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>ftindex<span class="op">&gt;</span> <span class="kw">SET</span> <span class="kw">OPTION</span> <span class="op">&lt;</span>name<span class="op">&gt;</span> <span class="op">=</span> <span class="op">&lt;</span><span class="fu">value</span><span class="op">&gt;</span></span></code></pre></div>
<p>Statements of the <code>ALTER</code> family can reconfigure existing
indexes on the fly. Essentially, they let you “edit” the existing
indexes (aka tables), and change their columns, or agents, or certain
settings.</p>
<ul>
<li><a href="#alter-column-syntax"><code>ALTER COLUMN</code></a> “edits”
columns on local indexes.</li>
<li><a href="#alter-remote-syntax"><code>ALTER REMOTE</code></a> “edits”
distributed index agents.</li>
<li><a href="#alter-option-syntax"><code>ALTER OPTION</code></a> “edits”
a few runtime settings.</li>
</ul>
<h3 id="alter-column-syntax">ALTER COLUMN syntax</h3>
<div class="sourceCode" id="cb381"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb381-1"><a href="#cb381-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>ftindex<span class="op">&gt;</span> {<span class="kw">ADD</span> | <span class="kw">DROP</span>} <span class="kw">COLUMN</span> <span class="op">&lt;</span>colname<span class="op">&gt;</span> <span class="op">&lt;</span>coltype<span class="op">&gt;</span></span></code></pre></div>
<p><code>ALTER COLUMN</code> statement lets you add or remove columns
from existing full-text indexes on the fly. It only supports local
indexes, not distributed.</p>
<p>As of v.3.6, most of the column types are supported, except
arrays.</p>
<p>Beware that <code>ALTER</code> exclusively locks the index for its
entire duration. Any concurrent writes <em>and</em> reads will stall.
That might be an operational issue for larger indexes. However, given
that <code>ALTER</code> affects attributes only, and given that
attributes are expected to fit in RAM, that is frequently okay
anyway.</p>
<p>You can expect <code>ALTER</code> to complete in approximately the
time needed to read and write the attribute data once, and you can
estimate that with a simple <code>cp</code> run on the respective data
files.</p>
<p>Newly added columns are initialized with default values, so 0 for
numerics, empty for strings and JSON, etc.</p>
<p>Here are a few examples.</p>
<div class="sourceCode" id="cb382"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb382-1"><a href="#cb382-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">ALTER</span> <span class="kw">TABLE</span> plain <span class="kw">ADD</span> <span class="kw">COLUMN</span> test_col UINT;</span>
<span id="cb382-2"><a href="#cb382-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.04</span> sec)</span>
<span id="cb382-3"><a href="#cb382-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-4"><a href="#cb382-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">DESC</span> plain;</span>
<span id="cb382-5"><a href="#cb382-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+--------+</span></span>
<span id="cb382-6"><a href="#cb382-6" aria-hidden="true" tabindex="-1"></a>| Field    | <span class="kw">Type</span>   |</span>
<span id="cb382-7"><a href="#cb382-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+--------+</span></span>
<span id="cb382-8"><a href="#cb382-8" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>       | bigint |</span>
<span id="cb382-9"><a href="#cb382-9" aria-hidden="true" tabindex="-1"></a>| text     | field  |</span>
<span id="cb382-10"><a href="#cb382-10" aria-hidden="true" tabindex="-1"></a>| <span class="fu">group_id</span> | uint   |</span>
<span id="cb382-11"><a href="#cb382-11" aria-hidden="true" tabindex="-1"></a>| ts_added | uint   |</span>
<span id="cb382-12"><a href="#cb382-12" aria-hidden="true" tabindex="-1"></a>| test_col | uint   |</span>
<span id="cb382-13"><a href="#cb382-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+--------+</span></span>
<span id="cb382-14"><a href="#cb382-14" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb382-15"><a href="#cb382-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-16"><a href="#cb382-16" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">ALTER</span> <span class="kw">TABLE</span> plain <span class="kw">DROP</span> <span class="kw">COLUMN</span> <span class="fu">group_id</span>;</span>
<span id="cb382-17"><a href="#cb382-17" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.01</span> sec)</span>
<span id="cb382-18"><a href="#cb382-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-19"><a href="#cb382-19" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">DESC</span> plain;</span>
<span id="cb382-20"><a href="#cb382-20" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+--------+</span></span>
<span id="cb382-21"><a href="#cb382-21" aria-hidden="true" tabindex="-1"></a>| Field    | <span class="kw">Type</span>   |</span>
<span id="cb382-22"><a href="#cb382-22" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+--------+</span></span>
<span id="cb382-23"><a href="#cb382-23" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>       | bigint |</span>
<span id="cb382-24"><a href="#cb382-24" aria-hidden="true" tabindex="-1"></a>| text     | field  |</span>
<span id="cb382-25"><a href="#cb382-25" aria-hidden="true" tabindex="-1"></a>| ts_added | uint   |</span>
<span id="cb382-26"><a href="#cb382-26" aria-hidden="true" tabindex="-1"></a>| test_col | uint   |</span>
<span id="cb382-27"><a href="#cb382-27" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+--------+</span></span>
<span id="cb382-28"><a href="#cb382-28" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="alter-remote-syntax">ALTER REMOTE syntax</h3>
<div class="sourceCode" id="cb383"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb383-1"><a href="#cb383-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>distindex<span class="op">&gt;</span> <span class="kw">ADD</span> REMOTE <span class="st">&#39;&lt;agent_spec&gt;&#39;</span></span>
<span id="cb383-2"><a href="#cb383-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>distindex<span class="op">&gt;</span> <span class="kw">DROP</span> REMOTE <span class="op">&lt;</span>remote_num<span class="op">&gt;</span></span>
<span id="cb383-3"><a href="#cb383-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb383-4"><a href="#cb383-4" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>distindex<span class="op">&gt;</span> <span class="kw">ADD</span> REMOTE <span class="op">&lt;</span>remote_num<span class="op">&gt;</span> MIRROR <span class="st">&#39;&lt;mirror_spec&gt;&#39;</span></span>
<span id="cb383-5"><a href="#cb383-5" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>distindex<span class="op">&gt;</span> <span class="kw">DROP</span> REMOTE <span class="op">&lt;</span>remote_num<span class="op">&gt;</span> MIRROR <span class="op">&lt;</span>mirror_num<span class="op">&gt;</span></span></code></pre></div>
<p><code>ALTER REMOTE</code> statement lets you reconfigure distributed
indexes on the fly, by adding or deleting entire agents (in the first
form), or individual mirrors (in the second one).
<code>&lt;agent_spec&gt;</code> and <code>&lt;mirror_spec&gt;</code> are
the spec strings that share the <code>agent</code> directive syntax.
<code>&lt;remote_num&gt;</code> and <code>&lt;mirror_num&gt;</code> are
the internal “serial numbers” as reported by <code>DESCRIBE</code>
statement.</p>
<div class="sourceCode" id="cb384"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb384-1"><a href="#cb384-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- example: drop retired remote agent, by index</span></span>
<span id="cb384-2"><a href="#cb384-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> dist1 <span class="kw">DROP</span> REMOTE <span class="dv">3</span></span>
<span id="cb384-3"><a href="#cb384-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb384-4"><a href="#cb384-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- example: add new remote agent, by spec</span></span>
<span id="cb384-5"><a href="#cb384-5" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> dist1 <span class="kw">ADD</span> REMOTE <span class="st">&#39;host123:9306:shard123&#39;</span></span></code></pre></div>
<p>Refer to <a
href="#operations-altering-distributed-indexes">“Operations: altering
distributed indexes”</a> for a quick tutorial and a few more
examples.</p>
<h3 id="alter-option-syntax">ALTER OPTION syntax</h3>
<div class="sourceCode" id="cb385"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb385-1"><a href="#cb385-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>ftindex<span class="op">&gt;</span> <span class="kw">SET</span> <span class="kw">OPTION</span> <span class="op">&lt;</span>name<span class="op">&gt;</span> <span class="op">=</span> <span class="op">&lt;</span><span class="fu">value</span><span class="op">&gt;</span></span></code></pre></div>
<p>The <code>ALTER ... SET OPTION ...</code> statement lets you modify
certain index settings on the fly.</p>
<p>At the moment, the supported options are:</p>
<ul>
<li><a href="#blackhole-directive"><code>blackhole</code></a> for
distributed indexes.</li>
<li><a href="#pq_max_rows-directive"><code>pq_max_rows</code></a> for PQ
indexes.</li>
<li><a href="#rt_mem_limit-directive"><code>rt_mem_limit</code></a> for
RT indexes.</li>
</ul>
<h3 id="attach-index-syntax">ATTACH INDEX syntax</h3>
<div class="sourceCode" id="cb386"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb386-1"><a href="#cb386-1" aria-hidden="true" tabindex="-1"></a>ATTACH <span class="kw">INDEX</span> <span class="op">&lt;</span>plainindex<span class="op">&gt;</span> <span class="kw">TO</span> RTINDEX <span class="op">&lt;</span>rtindex<span class="op">&gt;</span> [<span class="kw">WITH</span> <span class="kw">TRUNCATE</span>]</span></code></pre></div>
<p><code>ATTACH INDEX</code> statement lets you move data from a plain
index to a RT index.</p>
<p>After a successful ATTACH, the data originally stored in the source
plain index becomes a part of the target RT index. The source disk index
becomes unavailable (until its next rebuild).</p>
<p><code>ATTACH</code> does not result in any physical index data
changes. Basically, it just renames the files (and making the source
index a new disk segment of the target RT index), and updates the
metadata. So it is a generally quick operation which might (frequently)
complete as fast as under a second.</p>
<p>Note that when attaching to an <strong>empty</strong> RT index, the
fields, attributes, secondary indexes and text processing settings
(tokenizer, wordforms, etc) from the <strong>source</strong> index are
copied over and take effect. The respective parts of the RT index
definition from the <strong>configuration file will be
ignored</strong>.</p>
<p>And when attaching to a non-empty RT index, it acts as just one more
disk segment, and data from both indexes appears in requests. So the
index settings <strong>must</strong> match, otherwise
<code>ATTACH</code> will fail.</p>
<p>Optional <code>WITH TRUNCATE</code> clause empties RT index before
attaching plain index, which is useful for full rebuilds.</p>
<h3 id="bulk-update-syntax">BULK UPDATE syntax</h3>
<div class="sourceCode" id="cb387"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb387-1"><a href="#cb387-1" aria-hidden="true" tabindex="-1"></a><span class="kw">BULK</span> <span class="kw">UPDATE</span> [INPLACE] ftindex (<span class="kw">id</span>, col1 [, col2 [, col3 <span class="op">..</span>.]]) <span class="kw">VALUES</span></span>
<span id="cb387-2"><a href="#cb387-2" aria-hidden="true" tabindex="-1"></a>(id1, val1_1 [, val1_2 [, val1_3 <span class="op">..</span>.]]),</span>
<span id="cb387-3"><a href="#cb387-3" aria-hidden="true" tabindex="-1"></a>(id2, val2_1 [, val2_2 [, val2_3 <span class="op">..</span>.]]),</span>
<span id="cb387-4"><a href="#cb387-4" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb387-5"><a href="#cb387-5" aria-hidden="true" tabindex="-1"></a>(idN, valN_1 [, valN_2 [, valN_3 <span class="op">..</span>.]])</span></code></pre></div>
<p><code>BULK UPDATE</code> lets you update multiple rows with a single
statement. Compared to running N individual statements, bulk updates
provide both cleaner syntax and better performance.</p>
<p>Overall they are quite similar to regular updates. To summarize
quickly:</p>
<ul>
<li>you can update (entire) attributes, naturally keeping their types
(even when changing the width, ie. when updating a string, or entire
JSON, etc);</li>
<li>you can update numeric values within JSON, also keeping their types
(and naturally keeping the width).</li>
</ul>
<p>First column in the list must always be the <code>id</code> column.
Rows are uniquely identified by document ids.</p>
<p>Other columns to update can either be regular attributes, or
individual JSON keys, also just as with regular <code>UPDATE</code>
queries. Here are a couple examples:</p>
<div class="sourceCode" id="cb388"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb388-1"><a href="#cb388-1" aria-hidden="true" tabindex="-1"></a><span class="kw">BULK</span> <span class="kw">UPDATE</span> test1 (<span class="kw">id</span>, price) <span class="kw">VALUES</span> (<span class="dv">1</span>, <span class="fl">100.00</span>), (<span class="dv">2</span>, <span class="fl">123.45</span>), (<span class="dv">3</span>, <span class="fl">299.99</span>)</span>
<span id="cb388-2"><a href="#cb388-2" aria-hidden="true" tabindex="-1"></a><span class="kw">BULK</span> <span class="kw">UPDATE</span> test2 (<span class="kw">id</span>, json.price) <span class="kw">VALUES</span> (<span class="dv">1</span>, <span class="fl">100.00</span>), (<span class="dv">2</span>, <span class="fl">123.45</span>), (<span class="dv">3</span>, <span class="fl">299.99</span>)</span></code></pre></div>
<p>All the value types that the regular <code>UPDATE</code> supports
(ie. numerics, strings, JSON, etc) are also supported by the bulk
updates.</p>
<p>The <code>INPLACE</code> variant behavior matches the regular
<code>UPDATE INPLACE</code> behavior, and ensures that the updates are
either performed in-place, or fail.</p>
<p><strong>Bulk updates of existing values <em>must</em> keep the
type.</strong> This is a natural restriction for regular attributes, but
it also applies to JSON values. For example, if you update an integer
JSON value with a float, then that float will get converted (truncated)
to the current integer type.</p>
<p>Compatible value type conversions will happen. Truncations are
allowed.</p>
<p>Incompatible conversions will fail. For example, strings will
<em>not</em> be auto-converted to numeric values.</p>
<p>Attempts to update non-existent JSON keys will fail.</p>
<p><strong>Bulk updates may only apply partially, and then fail. They
are NOT atomic.</strong> For simplicity and performance reasons, they
process rows one by one, they may fail mid-flight, and there will be no
rollback in that case.</p>
<p>For example, if you’re doing an in-place bulk update over 10 rows,
that may update the first 3 rows alright, then fail on the 4-th row
because of, say, an incompatible JSON type. The remaining 6 rows will
not be updated further, even if they actually <em>could</em> be updated.
But neither will the 3 successful updates be rolled back. One should
treat the entire bulk update as failed in these cases anyway.</p>
<h3 id="call-syntax">CALL syntax</h3>
<div class="sourceCode" id="cb389"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb389-1"><a href="#cb389-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CALL</span> <span class="op">&lt;</span>built_in_proc<span class="op">&gt;</span>([<span class="op">&lt;</span>arg<span class="op">&gt;</span> [, <span class="op">&lt;</span>arg [, <span class="op">..</span>.]]])</span></code></pre></div>
<p><code>CALL</code> statement lets you call a few special built-in
“procedures” that expose various additional tools. The specific tools
and their specific arguments vary, and you should refer to the
respective <code>CALL_xxx</code> section for that. This section only
discusses a few common syntax things.</p>
<p>The reasons for even having a separate <code>CALL</code> statement
rather than exposing those tools as functions accessible using the
<code>SELECT expr</code> statement were:</p>
<ul>
<li><strong>Limited scope.</strong> Regular function expressions are
available in <em>any</em> <code>SELECT</code>, not just the row-less
expr-form. However, some (or even all) CALL-able procedures do not
support being called in a per-row context.</li>
<li><strong>Return type.</strong> Functions can’t return an arbitrary
table, procedures can.</li>
<li><strong>Named arguments.</strong> Functions only support positional
arguments, procedures can have named ones. (Though frankly, these days
this can be alleviated with a map-typed function argument, too.)</li>
</ul>
<p>Those reasons actually summarize most of the rest of this section,
too!</p>
<p><strong>Procedures and functions are very different things.</strong>
They don’t mingle much. Functions (such as <code>SIN()</code> etc) are
something that you can meaningfully compute in your <code>SELECT</code>
for every single row. Procedures (like <code>CALL KEYWORDS</code>)
usually are something that makes little since in the per-row context,
something that you are supposed to invoke individually.</p>
<p><strong>Procedure <code>CALL</code> will generally return an
arbitrary table.</strong> The specific columns and rows depend on the
specific procedure.</p>
<p><strong>Procedures can have named arguments.</strong> A few first
arguments would usually still be positional, for example, 1st argument
must always be an index name (for a certain procedure), etc. But then
starting from a certain position you would specify the “name-value”
argument pairs using the SQL style <code>value AS name</code> syntax,
like this:</p>
<div class="sourceCode" id="cb390"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb390-1"><a href="#cb390-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CALL</span> FOO(<span class="st">&#39;myindex&#39;</span>, <span class="dv">0</span> <span class="kw">AS</span> strict, <span class="dv">1</span> <span class="kw">AS</span> verbose)</span></code></pre></div>
<p><strong>There only are built-in procedures.</strong> We do not plan
to implement PL/SQL.</p>
<p>From here, refer to the respective “CALL xxx syntax” documentation
sections for the specific per-procedure details.</p>
<h3 id="call-keywords-syntax">CALL KEYWORDS syntax</h3>
<div class="sourceCode" id="cb391"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb391-1"><a href="#cb391-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CALL</span> KEYWORDS(<span class="op">&lt;</span>text<span class="op">&gt;</span>, <span class="op">&lt;</span>ftindex<span class="op">&gt;</span> [, <span class="op">&lt;</span>options<span class="op">&gt;</span> <span class="op">..</span>.])</span></code></pre></div>
<p><code>CALL KEYWORDS</code> statement <strong>tokenizes the given
input text</strong>. That is, it splits input text into actual keywords,
according to FT index settings. It returns both “tokenized” (ie.
pre-morphology) and “normalized” (ie. post-morphology) forms of those
keywords. It can also optionally return some per-keyword statistics,
in-query positions, etc.</p>
<p>First <code>&lt;text&gt;</code> argument text is the body of text to
break down into keywords. Usually that would be a search query to
examine. Because <code>CALL KEYWORDS</code> mostly follows query
tokenization rules, with wildcards and such.</p>
<p>Second <code>&lt;ftindex&gt;</code> argument is the name of the FT
index to take the text processing settings from (think tokenization,
morphology, mappings, etc).</p>
<p>Further arguments should be named, and the available options are as
follows.</p>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 12%" />
<col style="width: 61%" />
</colgroup>
<thead>
<tr class="header">
<th>Option</th>
<th>Default</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>expansion_limit</code></td>
<td>0</td>
<td>Config limit override (0 means use config)</td>
</tr>
<tr class="even">
<td><code>fold_blended</code></td>
<td>0</td>
<td>Fold blended keywords</td>
</tr>
<tr class="odd">
<td><code>fold_lemmas</code></td>
<td>0</td>
<td>Fold morphological lemmas</td>
</tr>
<tr class="even">
<td><code>fold_wildcards</code></td>
<td>1</td>
<td>Fold wildcards</td>
</tr>
<tr class="odd">
<td><code>stats</code></td>
<td>0</td>
<td>Show per-keyword statistics</td>
</tr>
</tbody>
</table>
<p>Example!</p>
<div class="sourceCode" id="cb392"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb392-1"><a href="#cb392-1" aria-hidden="true" tabindex="-1"></a><span class="kw">call</span> keywords(<span class="st">&#39;que*&#39;</span>, <span class="st">&#39;myindex&#39;</span>,</span>
<span id="cb392-2"><a href="#cb392-2" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="kw">as</span> stats,</span>
<span id="cb392-3"><a href="#cb392-3" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="kw">as</span> fold_wildcards,</span>
<span id="cb392-4"><a href="#cb392-4" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="kw">as</span> fold_lemmas,</span>
<span id="cb392-5"><a href="#cb392-5" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="kw">as</span> fold_blended,</span>
<span id="cb392-6"><a href="#cb392-6" aria-hidden="true" tabindex="-1"></a>  <span class="dv">5</span> <span class="kw">as</span> expansion_limit);</span></code></pre></div>
<h3 id="clone-syntax">CLONE syntax</h3>
<div class="sourceCode" id="cb393"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb393-1"><a href="#cb393-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CLONE</span> <span class="kw">FROM</span> <span class="st">&#39;&lt;srchost&gt;:&lt;apiport&gt;&#39;</span> [<span class="kw">OPTION</span> <span class="kw">force</span><span class="op">=</span> {<span class="dv">0</span> | <span class="dv">1</span>}]</span></code></pre></div>
<p>Starts one-off cloning all the “matching” indexes, ie. RT indexes
that currently exist on both current (target) host, and the remote
(source) host.</p>
<p>Only clones into <strong>empty</strong> target indexes by default,
use <code>OPTION force=1</code> to override.</p>
<p>Refer to <a href="#cloning-via-replication">“Cloning via
replication”</a> for details.</p>
<h3 id="clone-index-syntax">CLONE INDEX syntax</h3>
<div class="sourceCode" id="cb394"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb394-1"><a href="#cb394-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CLONE</span> <span class="kw">INDEX</span> <span class="op">&lt;</span>rtindex<span class="op">&gt;</span> <span class="kw">FROM</span> <span class="st">&#39;&lt;srchost&gt;:&lt;apiport&gt;&#39;</span> [<span class="kw">OPTION</span> <span class="kw">force</span><span class="op">=</span> {<span class="dv">0</span> | <span class="dv">1</span>}]</span></code></pre></div>
<p>Starts one-off cloning an individual index
<code>&lt;rtindex&gt;</code> from the remote host
<code>&lt;srchost&gt;</code> (via replication).</p>
<p>Only clones into <strong>empty</strong> target indexes by default,
use <code>OPTION force=1</code> to override.</p>
<p>Refer to <a href="#cloning-via-replication">“Cloning via
replication”</a> for details.</p>
<h3 id="create-index-syntax">CREATE INDEX syntax</h3>
<div class="sourceCode" id="cb395"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb395-1"><a href="#cb395-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> [<span class="op">&lt;</span>name<span class="op">&gt;</span>]</span>
<span id="cb395-2"><a href="#cb395-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> <span class="op">&lt;</span>ftindex<span class="op">&gt;</span>({<span class="op">&lt;</span>col_name<span class="op">&gt;</span></span>
<span id="cb395-3"><a href="#cb395-3" aria-hidden="true" tabindex="-1"></a>    | <span class="op">&lt;</span>json_field<span class="op">&gt;</span></span>
<span id="cb395-4"><a href="#cb395-4" aria-hidden="true" tabindex="-1"></a>    | {UINT | BIGINT | <span class="dt">FLOAT</span>}(<span class="op">&lt;</span>json_field<span class="op">&gt;</span>)})</span>
<span id="cb395-5"><a href="#cb395-5" aria-hidden="true" tabindex="-1"></a>  [<span class="kw">USING</span> <span class="op">&lt;</span>index_subtype<span class="op">&gt;</span>]</span>
<span id="cb395-6"><a href="#cb395-6" aria-hidden="true" tabindex="-1"></a>  [<span class="kw">OPTION</span> <span class="op">&lt;</span><span class="kw">option</span><span class="op">&gt;</span> <span class="op">=</span> <span class="op">&lt;</span><span class="fu">value</span><span class="op">&gt;</span>]</span></code></pre></div>
<p><code>CREATE INDEX</code> statement lets you create attribute indexes
(aka secondary indexes) either over regular columns, or JSON fields.</p>
<p>Attribute indexes are identified and managed by names. Names must be
unique. You can use either <a
href="#describe-syntax"><code>DESCRIBE</code></a> or (more verbose and
complete) <a
href="#show-index-from-syntax"><code>SHOW INDEX FROM</code></a>
statements to examine what indexes (and index names) already exist.</p>
<p>If an explicit attribute index name is not specified,
<code>CREATE INDEX</code> will generate one automatically from the
indexed value expression. Names generated from JSON expressions are
simplified for brevity, and might conflict, even with other
autogenerated names. In that case, just use the full syntax, and provide
a different attribute index name explicitly.</p>
<p>Up to 64 attribute indexes per (full-text) index are allowed.</p>
<p>Currently supported indexable value types are:</p>
<ul>
<li>numeric types (ie. <code>UINT</code>, <code>BIGINT</code>,
<code>FLOAT</code>)</li>
<li>integer sets (ie. <code>UINT_SET</code>,
<code>BIGINT_SET</code>)</li>
<li>array types (ie. <code>FLOAT_ARRAY</code>,
<code>INT8_ARRAY</code>)</li>
</ul>
<p>Indexing of other types (strings, blobs, etc) is not yet
supported.</p>
<p>Indexing both regular columns and JSON fields is pretty
straightforward, for example:</p>
<div class="sourceCode" id="cb396"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb396-1"><a href="#cb396-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_price <span class="kw">ON</span> products(price)</span>
<span id="cb396-2"><a href="#cb396-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_tags <span class="kw">ON</span> products(tags_mva)</span>
<span id="cb396-3"><a href="#cb396-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_foo <span class="kw">ON</span> product(json.foo)</span>
<span id="cb396-4"><a href="#cb396-4" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_bar <span class="kw">ON</span> product(json.qux[<span class="dv">0</span>].bar)</span></code></pre></div>
<p>JSON fields are not typed statically, but attributes indexes are, so
we <em>must</em> cast JSON field values when indexing. Currently
supported casts are <code>UINT</code>, <code>BIGINT</code>, and
<code>FLOAT</code> only. Casting from JSON field to integer set is not
yet supported. When the explicit type is missing, casting defaults to
<code>UINT</code>, and produces a warning:</p>
<div class="sourceCode" id="cb397"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb397-1"><a href="#cb397-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_foo <span class="kw">ON</span> rt1(j.foo);</span>
<span id="cb397-2"><a href="#cb397-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected, <span class="dv">1</span> warning (<span class="fl">0.08</span> sec)</span>
<span id="cb397-3"><a href="#cb397-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-4"><a href="#cb397-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW WARNINGS;</span>
<span id="cb397-5"><a href="#cb397-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+------------------------------------------------------------------------------+</span></span>
<span id="cb397-6"><a href="#cb397-6" aria-hidden="true" tabindex="-1"></a>| <span class="kw">Level</span>   | Code | Message                                                                      |</span>
<span id="cb397-7"><a href="#cb397-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+------------------------------------------------------------------------------+</span></span>
<span id="cb397-8"><a href="#cb397-8" aria-hidden="true" tabindex="-1"></a>| warning | <span class="dv">1000</span> | <span class="kw">index</span> <span class="st">&#39;rt1&#39;</span>: json field <span class="kw">type</span> <span class="kw">not</span> specified <span class="cf">for</span> <span class="st">&#39;j.foo&#39;</span>; defaulting <span class="kw">to</span> <span class="st">&#39;UINT&#39;</span> |</span>
<span id="cb397-9"><a href="#cb397-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+------------------------------------------------------------------------------+</span></span>
<span id="cb397-10"><a href="#cb397-10" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb397-11"><a href="#cb397-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-12"><a href="#cb397-12" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">DROP</span> <span class="kw">INDEX</span> idx_foo <span class="kw">ON</span> t1;</span>
<span id="cb397-13"><a href="#cb397-13" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb397-14"><a href="#cb397-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-15"><a href="#cb397-15" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_foo <span class="kw">ON</span> t1(<span class="dt">FLOAT</span>(j.foo));</span>
<span id="cb397-16"><a href="#cb397-16" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.09</span> sec)</span></code></pre></div>
<p>Note that <code>CREATE INDEX</code> locks the target full-text index
exclusively, and larger indexes may take a while to create.</p>
<p>There are two additional clauses, <code>USING</code> clause and
<code>OPTION</code> clause. Currently they both apply to <a
href="#searching-vector-indexes">vector indexes</a> only.</p>
<p><code>USING &lt;subtype&gt;</code> picks a specific index subtype.
For details on those, refer to <a href="#ann-index-types">“ANN index
types”</a> section. Known subtypes are <code>FAISS_DOT</code>,
<code>FAISS_L1</code>, <code>HNSW_L1</code>, <code>HNSW_L2</code>,
<code>HNSW_DOT</code>, <code>SQ4</code>, and <code>SQ8</code>.</p>
<div class="sourceCode" id="cb398"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb398-1"><a href="#cb398-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- example: create FAISS HNSW index (FAISS_L1) instead of</span></span>
<span id="cb398-2"><a href="#cb398-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- the (currently) default FAISS IVFPQ one (FAISS_DOT)</span></span>
<span id="cb398-3"><a href="#cb398-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_vec <span class="kw">ON</span> rt(vec) <span class="kw">USING</span> FAISS_L1</span></code></pre></div>
<p><code>OPTION &lt;name&gt; = &lt;value&gt;</code> options can further
fine-tune specific index subtype. Known options are as follows.</p>
<table>
<colgroup>
<col style="width: 27%" />
<col style="width: 17%" />
<col style="width: 54%" />
</colgroup>
<thead>
<tr class="header">
<th>Option</th>
<th>Index type</th>
<th>Quick Summary</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>ivf_clusters</code></td>
<td><code>FAISS_DOT</code></td>
<td>Number of IVF clusters</td>
</tr>
<tr class="even">
<td><code>pretrained_index</code></td>
<td><code>FAISS_DOT</code></td>
<td>Pretrained clusters file</td>
</tr>
<tr class="odd">
<td><code>hnsw_conn</code></td>
<td><code>HNSW_xxx</code></td>
<td>Non-base level graph connectivity</td>
</tr>
<tr class="even">
<td><code>hnsw_connbase</code></td>
<td><code>HNSW_xxx</code></td>
<td>Base-level graph connectivity</td>
</tr>
<tr class="odd">
<td><code>hnsw_expbuild</code></td>
<td><code>HNSW_xxx</code></td>
<td>Expansion (top-N) level at build time</td>
</tr>
<tr class="even">
<td><code>hnsw_exp</code></td>
<td><code>HNSW_xxx</code></td>
<td>Minimum expansion (top-N) for searches</td>
</tr>
</tbody>
</table>
<p>For details, refer to the respective sections.</p>
<ul>
<li><a href="#indexing-pretraining-faiss_dot-indexes">“Pretraining
FAISS_DOT indexes”</a> section</li>
<li><a href="#hnsw-indexes">“HNSW indexes”</a> section</li>
</ul>
<div class="sourceCode" id="cb399"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb399-1"><a href="#cb399-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- example: use pretrained clusters to speed up FAISS_DOT construction</span></span>
<span id="cb399-2"><a href="#cb399-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_vec <span class="kw">ON</span> rt(vec) <span class="kw">OPTION</span> pretrained_index<span class="op">=</span><span class="st">&#39;pretrain.bin&#39;</span></span>
<span id="cb399-3"><a href="#cb399-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-4"><a href="#cb399-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- example: use non-default HNSW_L2 connectivity settings</span></span>
<span id="cb399-5"><a href="#cb399-5" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_vec <span class="kw">ON</span> rt(vec) <span class="kw">USING</span> HNSW_L2</span>
<span id="cb399-6"><a href="#cb399-6" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> hnsw_conn<span class="op">=</span><span class="dv">32</span>, hnsw_connbase<span class="op">=</span><span class="dv">64</span>`</span></code></pre></div>
<h3 id="create-table-syntax">CREATE TABLE syntax</h3>
<div class="sourceCode" id="cb400"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb400-1"><a href="#cb400-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>name<span class="op">&gt;</span> (<span class="kw">id</span> BIGINT, <span class="op">&lt;</span>field<span class="op">&gt;</span> [, <span class="op">&lt;</span>field<span class="op">&gt;</span> <span class="op">..</span>.] [, <span class="op">&lt;</span>attr<span class="op">&gt;</span> <span class="op">..</span>.])</span>
<span id="cb400-2"><a href="#cb400-2" aria-hidden="true" tabindex="-1"></a>[<span class="kw">OPTION</span> <span class="op">&lt;</span>opt_name<span class="op">&gt;</span> <span class="op">=</span> <span class="op">&lt;</span>opt_value<span class="op">&gt;</span> [, <span class="op">&lt;</span>opt_name<span class="op">&gt;</span> <span class="op">=</span> <span class="op">&lt;</span>opt_value [ <span class="op">..</span>. ]]]</span>
<span id="cb400-3"><a href="#cb400-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb400-4"><a href="#cb400-4" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>field<span class="op">&gt;</span> <span class="op">:=</span> <span class="op">&lt;</span>field_name<span class="op">&gt;</span> {FIELD | FIELD_STRING}</span>
<span id="cb400-5"><a href="#cb400-5" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>attr<span class="op">&gt;</span> <span class="op">:=</span> <span class="op">&lt;</span>attr_name<span class="op">&gt;</span> <span class="op">&lt;</span>attr_type<span class="op">&gt;</span></span></code></pre></div>
<p><code>CREATE TABLE</code> lets you dynamically create a new RT
full-text index. It requires datadir mode to work.</p>
<p>The specified column order must follow the “id/fields/attrs” rule, as
discussed in the <a href="#using-index-schemas">“Using index
schemas”</a> section. Also, there <em>must</em> be at least 1 field
defined. The attributes are optional. Here’s an example.</p>
<div class="sourceCode" id="cb401"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb401-1"><a href="#cb401-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> dyntest (<span class="kw">id</span> BIGINT, title FIELD_STRING, content FIELD,</span>
<span id="cb401-2"><a href="#cb401-2" aria-hidden="true" tabindex="-1"></a>  price BIGINT, lat <span class="dt">FLOAT</span>, lon <span class="dt">FLOAT</span>, vec1 INT8[<span class="dv">128</span>])</span></code></pre></div>
<p>All column types should be supported. The complete type names list is
available in the <a href="#attributes">“Attributes”</a> section.</p>
<p>Array types are also supported now. Their dimensions must be given
along with the element type, see example above. <code>INT[N]</code>,
<code>INT8[N]</code>, and <code>FLOAT[N]</code> types are all good.</p>
<p>Bitfields are also supported now with the <code>UINT:N</code> syntax
where <code>N</code> is the bit width. <code>N</code> must be in 1 to 31
range. See <a href="#attr_uint-directive">attr_uint docs</a> for a bit
more.</p>
<p>Most of the <a href="#index-config-reference">index configuration
directives</a> available in the config file can now also be specified as
options to <code>CREATE TABLE</code>, just as follows.</p>
<div class="sourceCode" id="cb402"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb402-1"><a href="#cb402-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> test2 (<span class="kw">id</span> BIGINT, title FIELD)</span>
<span id="cb402-2"><a href="#cb402-2" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> rt_mem_limit<span class="op">=</span>256M, min_prefix_len<span class="op">=</span><span class="dv">3</span>, charset_table<span class="op">=</span><span class="st">&#39;english, 0..9&#39;</span></span></code></pre></div>
<p>Directives that aren’t supported in the <code>OPTION</code> clause
are:</p>
<ul>
<li>schema definition ones, ie. <code>attr_xxx</code> etc (use
<code>CREATE TABLE</code> instead)</li>
<li>distributed index ones (dynamic distributed indexes not supported
yet)</li>
<li><code>path</code>, <code>source</code>, <code>type</code> (not
applicable to dynamic RT indexes)</li>
<li><code>create_index</code> (use <code>CREATE INDEX</code>
instead)</li>
<li><code>mlock</code>, <code>ondisk_attrs</code>, <code>preopen</code>,
<code>regexp_filter</code> (maybe sometime)</li>
</ul>
<p>Note that repeated <code>OPTION</code> entries are silently ignored,
and only the first entry takes effect. So to specify multiple files for
<code>stopwords</code>, <code>mappings</code>, or
<code>morphdict</code>, just list them all in a single
<code>OPTION</code> entry.</p>
<div class="sourceCode" id="cb403"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb403-1"><a href="#cb403-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> test2 (<span class="kw">id</span> BIGINT, title FIELD)</span>
<span id="cb403-2"><a href="#cb403-2" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> stopwords<span class="op">=</span><span class="st">&#39;stops1.txt stops2.txt stops3.txt&#39;</span></span></code></pre></div>
<h3 id="create-universal-index-syntax">CREATE UNIVERSAL INDEX
syntax</h3>
<div class="sourceCode" id="cb404"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb404-1"><a href="#cb404-1" aria-hidden="true" tabindex="-1"></a># syntax</span>
<span id="cb404-2"><a href="#cb404-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> UNIVERSAL <span class="kw">INDEX</span> <span class="kw">ON</span> <span class="op">&lt;</span>ftindex<span class="op">&gt;</span>(<span class="op">&lt;</span>attr1<span class="op">&gt;</span> [, <span class="op">&lt;</span>attr2<span class="op">&gt;</span> [, <span class="op">..</span>.]])</span>
<span id="cb404-3"><a href="#cb404-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-4"><a href="#cb404-4" aria-hidden="true" tabindex="-1"></a># example</span>
<span id="cb404-5"><a href="#cb404-5" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> UNIVERSAL <span class="kw">INDEX</span> <span class="kw">ON</span> products(price, jsonparams)</span></code></pre></div>
<p><code>CREATE UNIVERSAL INDEX</code> initially creates the universal
index on a given FT-index (RT or plain index).</p>
<p>Already existing universal index will not get re-created or changed.
To manage that, use the <code>ALTER UNIVERSAL INDEX</code>
statement.</p>
<p>Attributes must all have supported types. Currently supported types
are JSONs, integral scalar types and strings.</p>
<p>Refer to <a href="#using-universal-index">“Using universal index”</a>
for details.</p>
<h3 id="describe-syntax">DESCRIBE syntax</h3>
<div class="sourceCode" id="cb405"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb405-1"><a href="#cb405-1" aria-hidden="true" tabindex="-1"></a>{DESCRIBE | <span class="kw">DESC</span>} <span class="op">&lt;</span><span class="kw">index</span><span class="op">&gt;</span> [<span class="kw">LIKE</span> <span class="st">&#39;&lt;mask&gt;&#39;</span>] [IGNORE <span class="st">&#39;&lt;mask&gt;&#39;</span>]</span></code></pre></div>
<p><code>DESCRIBE</code> statement (or <code>DESC</code> for short)
displays the schema of a given index, with one line per column (field or
attribute).</p>
<p>The returned order of columns must match the order as expected by
<code>INSERT</code> statements. See <a
href="#using-index-schemas">“Using index schemas”</a> for details.</p>
<div class="sourceCode" id="cb406"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb406-1"><a href="#cb406-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">desc</span> lj;</span>
<span id="cb406-2"><a href="#cb406-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------+--------------+------------+------------+</span></span>
<span id="cb406-3"><a href="#cb406-3" aria-hidden="true" tabindex="-1"></a>| Field       | <span class="kw">Type</span>         | Properties | <span class="kw">Key</span>        |</span>
<span id="cb406-4"><a href="#cb406-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------+--------------+------------+------------+</span></span>
<span id="cb406-5"><a href="#cb406-5" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>          | bigint       |            |            |</span>
<span id="cb406-6"><a href="#cb406-6" aria-hidden="true" tabindex="-1"></a>| title       | field_string | <span class="kw">indexed</span>    |            |</span>
<span id="cb406-7"><a href="#cb406-7" aria-hidden="true" tabindex="-1"></a>| content     | field        | <span class="kw">indexed</span>    |            |</span>
<span id="cb406-8"><a href="#cb406-8" aria-hidden="true" tabindex="-1"></a>| channel_id  | bigint       |            | channel_id |</span>
<span id="cb406-9"><a href="#cb406-9" aria-hidden="true" tabindex="-1"></a>| j           | json         |            |            |</span>
<span id="cb406-10"><a href="#cb406-10" aria-hidden="true" tabindex="-1"></a>| title_len   | token_count  |            |            |</span>
<span id="cb406-11"><a href="#cb406-11" aria-hidden="true" tabindex="-1"></a>| content_len | token_count  |            |            |</span>
<span id="cb406-12"><a href="#cb406-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------+--------------+------------+------------+</span></span>
<span id="cb406-13"><a href="#cb406-13" aria-hidden="true" tabindex="-1"></a><span class="dv">7</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>The “Properties” output column only applies to full-text fields (and
should be always empty for attributes). Field flags are as follows.</p>
<ul>
<li><code>indexed</code>, field is full-text indexed</li>
<li><code>stored</code>, original field content is stored in
DocStore</li>
<li><code>highlighted</code>, data for field snippets speedup is stored
in DocStore</li>
<li><code>annotations</code>, field is a special
<code>annot_field</code></li>
</ul>
<p>The “Key” output column, on the contrary, only applies to attributes.
It lists all the secondary indexes involving the current column.
(Usually there would be at most one such index, but JSON columns can
produce multiple ones.)</p>
<p>You can limit <code>DESCRIBE</code> output with optional
<code>LIKE</code> and <code>IGNORE</code> clauses, see <a
href="#like-and-ignore-clause">“LIKE and IGNORE clause”</a> for details.
For example.</p>
<div class="sourceCode" id="cb407"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb407-1"><a href="#cb407-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">desc</span> lj <span class="kw">like</span> <span class="st">&#39;%len&#39;</span>;</span>
<span id="cb407-2"><a href="#cb407-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------+-------------+------------+------+</span></span>
<span id="cb407-3"><a href="#cb407-3" aria-hidden="true" tabindex="-1"></a>| Field       | <span class="kw">Type</span>        | Properties | <span class="kw">Key</span>  |</span>
<span id="cb407-4"><a href="#cb407-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------+-------------+------------+------+</span></span>
<span id="cb407-5"><a href="#cb407-5" aria-hidden="true" tabindex="-1"></a>| title_len   | token_count |            |      |</span>
<span id="cb407-6"><a href="#cb407-6" aria-hidden="true" tabindex="-1"></a>| content_len | token_count |            |      |</span>
<span id="cb407-7"><a href="#cb407-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------+-------------+------------+------+</span></span>
<span id="cb407-8"><a href="#cb407-8" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="drop-index-syntax">DROP INDEX syntax</h3>
<div class="sourceCode" id="cb408"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb408-1"><a href="#cb408-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">INDEX</span> <span class="op">&lt;</span>name<span class="op">&gt;</span> <span class="kw">ON</span> <span class="op">&lt;</span>ftindex<span class="op">&gt;</span></span></code></pre></div>
<p><code>DROP INDEX</code> statement lets you remove no longer needed
attribute index from a given full-text index.</p>
<p>Note that <code>DROP INDEX</code> locks the target full-text index
exclusively. Usually dropping an index should complete pretty quickly
(say a few seconds), but your mileage may vary.</p>
<h3 id="drop-table-syntax">DROP TABLE syntax</h3>
<div class="sourceCode" id="cb409"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb409-1"><a href="#cb409-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> [<span class="cf">IF</span> <span class="kw">EXISTS</span>] <span class="op">&lt;</span>ftindex<span class="op">&gt;</span></span></code></pre></div>
<p><code>DROP TABLE</code> drops a previously created full-text index.
It requires datadir mode to work.</p>
<p>The optional <code>IF EXISTS</code> clause makes <code>DROP</code>
succeed even the target index does not exist. Otherwise, it fails.</p>
<h3 id="drop-universal-index-syntax">DROP UNIVERSAL INDEX syntax</h3>
<div class="sourceCode" id="cb410"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb410-1"><a href="#cb410-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> UNIVERSAL <span class="kw">INDEX</span> <span class="kw">ON</span> <span class="op">&lt;</span>ftindex<span class="op">&gt;</span></span></code></pre></div>
<p><code>DROP UNIVERSAL INDEX</code> statement removes the existing
universal index from a given FT-index.</p>
<p>Refer to <a href="#using-universal-index">“Using universal index”</a>
for details.</p>
<h3 id="explain-select-syntax">EXPLAIN SELECT syntax</h3>
<div class="sourceCode" id="cb411"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb411-1"><a href="#cb411-1" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPLAIN</span> <span class="kw">SELECT</span> <span class="op">..</span>.</span></code></pre></div>
<p><code>EXPLAIN</code> prepended to (any) legal <code>SELECT</code>
query collects and display the query plan details: what indexes could be
used at all, what indexes were chosen, etc.</p>
<p>The actual query does <em>not</em> get executed, only the planning
phase, and therefore any <code>EXPLAIN</code> must return rather
quickly.</p>
<h3 id="flush-index-syntax">FLUSH INDEX syntax</h3>
<div class="sourceCode" id="cb412"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb412-1"><a href="#cb412-1" aria-hidden="true" tabindex="-1"></a><span class="kw">FLUSH</span> <span class="kw">INDEX</span> <span class="op">&lt;</span><span class="kw">index</span><span class="op">&gt;</span></span></code></pre></div>
<p><code>FLUSH INDEX</code> forcibly syncs the given index from RAM to
disk. On success, all index RAM data gets written (synced) to disk.
Either an RT or PQ index argument is required.</p>
<p>Running this sync does <em>not</em> evict any RAM-based data from
RAM. All that data stays resident and, actually, completely unaffected.
It’s only the on-disk copy of the data that gets synced with the most
current RAM state. This is the very same sync-to-disk operation that
gets internally called on clean shutdown and periodic flushes
(controlled by <code>rt_flush_period</code> setting).</p>
<p>So an explicit <code>FLUSH INDEX</code> speeds up crash recovery.
Because <code>searchd</code> only needs to replay WAL (binlog)
operations logged since last good sync. That makes it useful for
quick-n-dirty backups. (Or, when you can pause writes, make that
quick-n-clean ones.) Because index backups made immediately after an
explicit <code>FLUSH INDEX</code> can be used without any WAL replay
delays.</p>
<p>This statement was previously called <code>FLUSH RTINDEX</code>, and
that now-legacy syntax will be supported as an alias for a bit more
time.</p>
<h3 id="flush-manifest-syntax">FLUSH MANIFEST syntax</h3>
<div class="sourceCode" id="cb413"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb413-1"><a href="#cb413-1" aria-hidden="true" tabindex="-1"></a><span class="kw">FLUSH</span> MANIFEST <span class="op">&lt;</span>rtindex<span class="op">&gt;</span></span></code></pre></div>
<p><code>FLUSH MANIFEST</code> computes and writes the current manifest
(ie. index data files and RAM segments checksums) to binlog. So that
<code>searchd</code> could verify those when needed (during binlog
replay on an unclean restart, or during replica join).</p>
<p>Checksum mismatches on binlog replay should <strong>not</strong>
prevent <code>searchd</code> startup. They must however emit a warning
into <code>searchd</code> log.</p>
<p><code>binlog_manifest_flush</code> directive can enable automatic
manifest flushes.</p>
<p>Note that computing the manifest may take a while, especially on
bigger indexes. However, most DML queries (except <code>UPDATE</code>)
are <strong>not</strong> stalled, just as with (even lengthier)
<code>OPTIMIZE</code> operations.</p>
<h3 id="insert-syntax">INSERT syntax</h3>
<div class="sourceCode" id="cb414"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb414-1"><a href="#cb414-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> <span class="op">&lt;</span>ftindex<span class="op">&gt;</span> [(<span class="op">&lt;</span><span class="kw">column</span><span class="op">&gt;</span>, <span class="op">..</span>.)]</span>
<span id="cb414-2"><a href="#cb414-2" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="op">&lt;</span><span class="fu">value</span><span class="op">&gt;</span>, <span class="op">..</span>.) [, (<span class="op">..</span>.)]</span></code></pre></div>
<p><code>INSERT</code> statement inserts new, not-yet-existing rows
(documents) into a given RT index. Attempts to insert an already
existing row (as identified by id) must fail.</p>
<p>There’s also the <code>REPLACE</code> statement (aka “upsert”) that,
basically, won’t fail and will always insert the new data. See
[<code>REPLACE</code> docs] for details.</p>
<p>Here go a few simple examples, with and without the explicit column
list.</p>
<div class="sourceCode" id="cb415"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb415-1"><a href="#cb415-1" aria-hidden="true" tabindex="-1"></a># implicit <span class="kw">column</span> <span class="kw">list</span> example</span>
<span id="cb415-2"><a href="#cb415-2" aria-hidden="true" tabindex="-1"></a># assuming that <span class="kw">the</span> <span class="kw">index</span> has (<span class="kw">id</span>, title, content, userid)</span>
<span id="cb415-3"><a href="#cb415-3" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> test1 <span class="kw">VALUES</span> (<span class="dv">123</span>, <span class="st">&#39;hello world&#39;</span>, <span class="st">&#39;some content&#39;</span>, <span class="dv">456</span>);</span>
<span id="cb415-4"><a href="#cb415-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb415-5"><a href="#cb415-5" aria-hidden="true" tabindex="-1"></a># explicit <span class="kw">column</span> <span class="kw">list</span></span>
<span id="cb415-6"><a href="#cb415-6" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> test1 (<span class="kw">id</span>, userid, title) <span class="kw">VALUES</span> (<span class="dv">234</span>, <span class="dv">456</span>, <span class="st">&#39;another world&#39;</span>);</span></code></pre></div>
<p>The list of columns is optional. You can omit it and rely on the
schema order, which is “id first, fields next, attributes last”. For a
bit more details, see the <a href="#schemas-query-order">“Schemas: query
order”</a> section.</p>
<p>When specified, the list of columns <strong>must</strong> contain the
<code>id</code> column. Because that is how Sphinx identifies the
documents. Otherwise, inserts will fail.</p>
<p>Any other columns <em>can</em> be omitted from the explicit list.
They are then filled with the respective default values for their type
(zeroes, empty strings, etc). So in the example just above,
<code>content</code> field will be empty for document 234 (and if we
omit <code>userid</code>, it will be 0, and so on).</p>
<p>Expressions are <strong>not</strong> yet supported, all values must
be provided explicitly, so
<code>INSERT ... VALUES (100 + 23, 'hello world')</code> is
<strong>not</strong> legal.</p>
<p>Last but not least, <code>INSERT</code> can insert multiple rows at a
time if you specify multiple lists of values, as follows.</p>
<div class="sourceCode" id="cb416"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb416-1"><a href="#cb416-1" aria-hidden="true" tabindex="-1"></a># multi<span class="op">-</span><span class="kw">row</span> <span class="kw">insert</span> example</span>
<span id="cb416-2"><a href="#cb416-2" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> test1 (<span class="kw">id</span>, title) <span class="kw">VALUES</span></span>
<span id="cb416-3"><a href="#cb416-3" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span>, <span class="st">&#39;test one&#39;</span>),</span>
<span id="cb416-4"><a href="#cb416-4" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">2</span>, <span class="st">&#39;test two&#39;</span>),</span>
<span id="cb416-5"><a href="#cb416-5" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">3</span>, <span class="st">&#39;test three&#39;</span>)</span></code></pre></div>
<h3 id="pull-syntax">PULL syntax</h3>
<div class="sourceCode" id="cb417"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb417-1"><a href="#cb417-1" aria-hidden="true" tabindex="-1"></a>PULL <span class="op">&lt;</span>rtindex<span class="op">&gt;</span> [<span class="kw">OPTION</span> <span class="kw">timeout</span><span class="op">=&lt;</span>num_sec<span class="op">&gt;</span>]</span></code></pre></div>
<p><code>PULL</code> forces a replicated index to immediately fetch new
transactions from master, ignoring the current
<code>repl_sync_tick_msec</code> setting.</p>
<p>The <code>timeout</code> option is in seconds, and defaults to 10
seconds.</p>
<div class="sourceCode" id="cb418"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb418-1"><a href="#cb418-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> PULL rt_index;</span>
<span id="cb418-2"><a href="#cb418-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+---------+</span></span>
<span id="cb418-3"><a href="#cb418-3" aria-hidden="true" tabindex="-1"></a>| prev TID | <span class="kw">new</span> TID |</span>
<span id="cb418-4"><a href="#cb418-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+---------+</span></span>
<span id="cb418-5"><a href="#cb418-5" aria-hidden="true" tabindex="-1"></a>| <span class="dv">1134</span>     | <span class="dv">1136</span>    |</span>
<span id="cb418-6"><a href="#cb418-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+---------+</span></span>
<span id="cb418-7"><a href="#cb418-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span></span></code></pre></div>
<p>Refer to <a href="#using-replication">“Using replication”</a> for
details.</p>
<h3 id="kill-syntax">KILL syntax</h3>
<div class="sourceCode" id="cb419"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb419-1"><a href="#cb419-1" aria-hidden="true" tabindex="-1"></a><span class="kw">KILL</span> <span class="op">&lt;</span>thread_id<span class="op">&gt;</span></span>
<span id="cb419-2"><a href="#cb419-2" aria-hidden="true" tabindex="-1"></a><span class="kw">KILL</span> SLOW <span class="op">&lt;</span>min_msec<span class="op">&gt;</span> MSEC</span></code></pre></div>
<p><code>KILL</code> lets you forcibly terminate long-running statements
based either on thread ID, or on their current running time.</p>
<p>For the first version, you can obtain the thread IDs using the <a
href="#show-threads-syntax"><code>SHOW THREADS</code></a> statement.</p>
<p>Note that forcibly killed queries are going to return almost as if
they completed OK rather than raise an error. They will return a partial
result set accumulated so far, and raise a “query was killed” warning.
For example:</p>
<div class="sourceCode" id="cb420"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb420-1"><a href="#cb420-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> rt <span class="kw">LIMIT</span> <span class="dv">3</span>;</span>
<span id="cb420-2"><a href="#cb420-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+</span></span>
<span id="cb420-3"><a href="#cb420-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | gid  |</span>
<span id="cb420-4"><a href="#cb420-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+</span></span>
<span id="cb420-5"><a href="#cb420-5" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">27</span> |  <span class="dv">123</span> |</span>
<span id="cb420-6"><a href="#cb420-6" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">28</span> |  <span class="dv">123</span> |</span>
<span id="cb420-7"><a href="#cb420-7" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">29</span> |  <span class="dv">123</span> |</span>
<span id="cb420-8"><a href="#cb420-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+</span></span>
<span id="cb420-9"><a href="#cb420-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span>, <span class="dv">1</span> warning (<span class="fl">0.54</span> sec)</span>
<span id="cb420-10"><a href="#cb420-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb420-11"><a href="#cb420-11" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW WARNINGS;</span>
<span id="cb420-12"><a href="#cb420-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+------------------+</span></span>
<span id="cb420-13"><a href="#cb420-13" aria-hidden="true" tabindex="-1"></a>| <span class="kw">Level</span>   | Code | Message          |</span>
<span id="cb420-14"><a href="#cb420-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+------------------+</span></span>
<span id="cb420-15"><a href="#cb420-15" aria-hidden="true" tabindex="-1"></a>| warning | <span class="dv">1000</span> | <span class="kw">query</span> was killed |</span>
<span id="cb420-16"><a href="#cb420-16" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------+------+------------------+</span></span>
<span id="cb420-17"><a href="#cb420-17" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>The respective network connections are not going to be forcibly
closed.</p>
<p>At the moment, the only statements that can be killed are
<code>SELECT</code>, <code>UPDATE</code>, and <code>DELETE</code>.
Additional statement types might begin to support <code>KILL</code> in
the future.</p>
<p>In both versions, <code>KILL</code> returns the number of threads
marked for termination via the affected rows count:</p>
<div class="sourceCode" id="cb421"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb421-1"><a href="#cb421-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">KILL</span> SLOW <span class="dv">2500</span> MSEC;</span>
<span id="cb421-2"><a href="#cb421-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">3</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Threads already marked will not be marked again and reported this
way.</p>
<p>There are no limits on the <code>&lt;min_msec&gt;</code> parameter
for the second version, and therefore, <code>KILL SLOW 0 MSEC</code> is
perfectly legal syntax. That specific statement is going to kill
<em>all</em> the currently running queries. So please use with a pinch
of care.</p>
<h3 id="lock-user-syntax">LOCK USER syntax</h3>
<div class="sourceCode" id="cb422"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb422-1"><a href="#cb422-1" aria-hidden="true" tabindex="-1"></a>{<span class="kw">LOCK</span> | <span class="kw">UNLOCK</span>} <span class="fu">USER</span> <span class="st">&#39;&lt;user_name&gt;&#39;</span></span></code></pre></div>
<p><code>LOCK USER</code> and <code>UNLOCK USER</code> respectively
temporarily lock and unlock future connections with a given user
name.</p>
<p>Locking is ephemeral (yet), so <code>searchd</code> restart
auto-unlocks all users. Running queries and open connections are not
forcibly terminated, either.</p>
<p>Refer to <a href="#operations-user-auth">“Operations: user auth”</a>
section for details.</p>
<h3 id="reload-users-syntax">RELOAD USERS syntax</h3>
<div class="sourceCode" id="cb423"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb423-1"><a href="#cb423-1" aria-hidden="true" tabindex="-1"></a>RELOAD USERS</span></code></pre></div>
<p><code>RELOAD USERS</code> is used to parse actual list of available
users from <code>auth_users</code> section. If that statement raises an
error, user list doesn’t change.</p>
<p>Refer to <a href="#operations-user-auth">“Operations: user auth”</a>
section for details.</p>
<h3 id="replace-syntax">REPLACE syntax</h3>
<div class="sourceCode" id="cb424"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb424-1"><a href="#cb424-1" aria-hidden="true" tabindex="-1"></a><span class="kw">REPLACE</span> <span class="kw">INTO</span> <span class="op">&lt;</span>ftindex<span class="op">&gt;</span> [(<span class="op">&lt;</span><span class="kw">column</span><span class="op">&gt;</span>, <span class="op">..</span>.)]</span>
<span id="cb424-2"><a href="#cb424-2" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="op">&lt;</span><span class="fu">value</span><span class="op">&gt;</span>, <span class="op">..</span>.) [, (<span class="op">..</span>.)]</span>
<span id="cb424-3"><a href="#cb424-3" aria-hidden="true" tabindex="-1"></a>[<span class="kw">KEEP</span> (<span class="op">&lt;</span><span class="kw">column</span><span class="op">&gt;</span> | <span class="op">&lt;</span>json_path<span class="op">&gt;</span> [, <span class="op">..</span>.])]</span></code></pre></div>
<p><code>REPLACE</code> is similar to <code>INSERT</code>, so for the
common background you should also refer to the <a
href="#insert-syntax">INSERT syntax</a> section). But there are two
quite important differences.</p>
<p>First, it never raises an error on existing rows (aka ids). It
basically should always succeed, one way or another: by either “just”
inserting the new row, or by overwriting (aka replacing!) the existing
one.</p>
<p>Second, <code>REPLACE</code> has a <code>KEEP</code> clause that lets
you keep <em>some</em> attribute values from the existing (aka
committed!) rows. For non-existing rows, the respective columns will be
filled with default values.</p>
<p><code>KEEP</code> values must be either regular attributes or JSON
subkeys, and not full-text indexed fields. You can’t “keep” fields. All
attributes types are supported (numerics, strings, JSONs, etc).</p>
<p>Full columns from <code>KEEP</code> must <strong>not</strong> be
mentioned in the explicit column list when you have one. Because,
naturally, you’re either inserting a certain new value, or keeping an
old one.</p>
<p>JSON subkeys in <code>KEEP</code>, on the contrary,
<strong>require</strong> their enclosing JSON column in the explicit
column list. Because <code>REPLACE</code> refuses to <em>implicitly</em>
clear out the entire JSON value.</p>
<p>When <strong>not</strong> using an explicit column list, the number
of expected <code>VALUES</code> changes. It gets adjusted for
<code>KEEP</code> clause, meaning that you must <strong>not</strong> put
the columns you’re keeping in your <code>VALUES</code> entries. Here’s
an example.</p>
<div class="sourceCode" id="cb425"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb425-1"><a href="#cb425-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> test (<span class="kw">id</span> bigint, title field_string, k1 uint, k2 uint);</span>
<span id="cb425-2"><a href="#cb425-2" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> test <span class="kw">values</span> (<span class="dv">123</span>, <span class="st">&#39;version one&#39;</span>, <span class="dv">1</span>, <span class="dv">1</span>);</span>
<span id="cb425-3"><a href="#cb425-3" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> <span class="kw">into</span> test <span class="kw">values</span> (<span class="dv">123</span>, <span class="st">&#39;version two&#39;</span>, <span class="dv">2</span>, <span class="dv">2</span>);</span>
<span id="cb425-4"><a href="#cb425-4" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> <span class="kw">into</span> test <span class="kw">values</span> (<span class="dv">123</span>, <span class="st">&#39;version three&#39;</span>, <span class="dv">3</span>) <span class="kw">keep</span> (k1); <span class="co">-- changes k2</span></span>
<span id="cb425-5"><a href="#cb425-5" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> <span class="kw">into</span> test <span class="kw">values</span> (<span class="dv">123</span>, <span class="st">&#39;version four&#39;</span>, <span class="dv">4</span>) <span class="kw">keep</span> (k2); <span class="co">-- changes k1</span></span></code></pre></div>
<p>Note how we’re “normally” inserting all 4 columns, but with
<code>KEEP</code> we omit whatever we’re keeping, and so we must provide
just 3 columns. For the record, let’s check the final result.</p>
<pre><code>mysql&gt; select * from test;
+------+--------------+------+------+
| id   | title        | k1   | k2   |
+------+--------------+------+------+
|  123 | version four |    4 |    3 |
+------+--------------+------+------+
1 row in set (0.00 sec)</code></pre>
<p>Well, everything as expected. In version 3 we kept <code>k1</code>,
it got excluded from our explicit columns list, and the value 3 landed
into <code>k2</code>. Then in version 4 we kept <code>k2</code>, the
value 4 landed into <code>k1</code>, replacing the previous value (which
was 2).</p>
<p>Existing rows mean <strong>committed</strong> rows. So the following
pseudo-transaction results in the <strong>index</strong> value 3 being
kept, not the in-transaction value 55.</p>
<div class="sourceCode" id="cb427"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb427-1"><a href="#cb427-1" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span>;</span>
<span id="cb427-2"><a href="#cb427-2" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> <span class="kw">into</span> test <span class="kw">values</span> (<span class="dv">123</span>, <span class="st">&#39;version 5&#39;</span>, <span class="dv">55</span>, <span class="dv">55</span>);</span>
<span id="cb427-3"><a href="#cb427-3" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> <span class="kw">into</span> test <span class="kw">values</span> (<span class="dv">123</span>, <span class="st">&#39;version 6&#39;</span>, <span class="dv">66</span>) <span class="kw">keep</span> (k2);</span>
<span id="cb427-4"><a href="#cb427-4" aria-hidden="true" tabindex="-1"></a><span class="kw">commit</span>;</span></code></pre></div>
<pre><code>mysql&gt; select * from test;
+------+-----------+------+------+
| id   | title     | k1   | k2   |
+------+-----------+------+------+
|  123 | version 6 |   66 |    3 |
+------+-----------+------+------+
1 row in set (0.00 sec)</code></pre>
<p><strong>JSON keeps must not overlap.</strong> That is, if you decide
to keep individual JSON fields, then you can’t keep the entire
(enclosing!) JSON column anymore, nor any nested subfields of those
(enclosing!) fields.</p>
<div class="sourceCode" id="cb429"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb429-1"><a href="#cb429-1" aria-hidden="true" tabindex="-1"></a># okay, keeping <span class="dv">2</span> unrelated fields</span>
<span id="cb429-2"><a href="#cb429-2" aria-hidden="true" tabindex="-1"></a><span class="kw">REPLACE</span> <span class="op">..</span>. <span class="kw">KEEP</span> (j.params.k1, j.params.k2)</span>
<span id="cb429-3"><a href="#cb429-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb429-4"><a href="#cb429-4" aria-hidden="true" tabindex="-1"></a># ILLEGAL, there can be <span class="kw">only</span> one</span>
<span id="cb429-5"><a href="#cb429-5" aria-hidden="true" tabindex="-1"></a><span class="kw">REPLACE</span> <span class="op">..</span>. <span class="kw">KEEP</span> (j, j.params.k1)</span>
<span id="cb429-6"><a href="#cb429-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb429-7"><a href="#cb429-7" aria-hidden="true" tabindex="-1"></a># ILLEGAL, ditto</span>
<span id="cb429-8"><a href="#cb429-8" aria-hidden="true" tabindex="-1"></a><span class="kw">REPLACE</span> <span class="op">..</span>. <span class="kw">KEEP</span> (j.params, j.params.k1)</span></code></pre></div>
<p><strong>JSON keeps require an explicit “base” JSON.</strong> You can
keep individual JSON fields if and only if there’s an
<strong>explicit</strong> new JSON column value (that those keeps could
be then merged into).</p>
<div class="sourceCode" id="cb430"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb430-1"><a href="#cb430-1" aria-hidden="true" tabindex="-1"></a># ILLEGAL, can<span class="st">&#39;t keep &quot;into nothing&quot;</span></span>
<span id="cb430-2"><a href="#cb430-2" aria-hidden="true" tabindex="-1"></a><span class="st">REPLACE INTO test (id, title) VALUES (123, &#39;</span>title<span class="st">&#39;)</span></span>
<span id="cb430-3"><a href="#cb430-3" aria-hidden="true" tabindex="-1"></a><span class="st">KEEP (j.some.field);</span></span>
<span id="cb430-4"><a href="#cb430-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-5"><a href="#cb430-5" aria-hidden="true" tabindex="-1"></a><span class="st"># should be legal (got an explicit new value)</span></span>
<span id="cb430-6"><a href="#cb430-6" aria-hidden="true" tabindex="-1"></a><span class="st">REPLACE INTO test (id, title, j) VALUES (123, &#39;</span>title<span class="st">&#39;, &#39;</span>{}<span class="st">&#39;)</span></span>
<span id="cb430-7"><a href="#cb430-7" aria-hidden="true" tabindex="-1"></a><span class="st">KEEP (j.some.field);</span></span></code></pre></div>
<p><strong>Array elements are not supported.</strong> Because JSON keeps
are not intended for array manipulation.</p>
<div class="sourceCode" id="cb431"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb431-1"><a href="#cb431-1" aria-hidden="true" tabindex="-1"></a># ILLEGAL, <span class="kw">no</span> <span class="dt">array</span> manipulation</span>
<span id="cb431-2"><a href="#cb431-2" aria-hidden="true" tabindex="-1"></a><span class="kw">REPLACE</span> <span class="op">..</span>. <span class="kw">KEEP</span> (j.params[<span class="dv">0</span>]);</span>
<span id="cb431-3"><a href="#cb431-3" aria-hidden="true" tabindex="-1"></a><span class="kw">REPLACE</span> <span class="op">..</span>. <span class="kw">KEEP</span> (j.params[<span class="dv">3</span>], j.params[<span class="dv">7</span>]);</span></code></pre></div>
<p><strong>Conflicting JSON keeps have priority, and can override new
<em>parent</em> values.</strong> Or in other words,
<strong><code>KEEP</code> clause wins conflicts with <code>VALUES</code>
clause.</strong> That means that any parent objects must stay
objects!</p>
<p>When any old parent object along any <code>KEEP</code> value path
becomes a non-object in the new JSON column value in a conflicting way,
we actively preserve old values <em>and</em> their required paths,
<strong>dropping conflicting new (non-object) values.</strong></p>
<p>Consider the following example, where a parent object
<code>j.foo</code> tries to change into an array, introducing a
conflict.</p>
<div class="sourceCode" id="cb432"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb432-1"><a href="#cb432-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> test (<span class="kw">id</span> BIGINT, title FIELD_STRING, j JSON);</span>
<span id="cb432-2"><a href="#cb432-2" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> test <span class="kw">VALUES</span></span>
<span id="cb432-3"><a href="#cb432-3" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">123</span>, <span class="st">&#39;hello&#39;</span>, <span class="st">&#39;{&quot;foo&quot;: {&quot;b&quot;: 100, &quot;c&quot;: 60}}&#39;</span>);</span>
<span id="cb432-4"><a href="#cb432-4" aria-hidden="true" tabindex="-1"></a><span class="kw">REPLACE</span> <span class="kw">INTO</span> test (<span class="kw">id</span>, title, j) <span class="kw">VALUES</span></span>
<span id="cb432-5"><a href="#cb432-5" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">123</span>, <span class="st">&#39;version two&#39;</span>, <span class="st">&#39;{&quot;foo&quot;: [1, 2, 3], &quot;d&quot;: 70}&#39;</span>)</span>
<span id="cb432-6"><a href="#cb432-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">KEEP</span> (j.foo.b, j.foo.missing);</span></code></pre></div>
<p><code>KEEP</code> requires keeping <code>foo.b</code>, which requires
keeping <code>foo</code> an object, which conflicts with
<code>VALUES</code>, because the new <code>foo</code> value is an array.
This conflict can’t be reconciled. We <strong>must</strong> lose either
the old <code>foo.b</code> value or the new <code>foo</code> value.</p>
<p>According to “KEEP wins” rule <code>foo.b</code> must win, therefore
<code>foo</code> must stay being an object, therefore the incoming
non-object (array) value must get discarded. Let’s check!</p>
<div class="sourceCode" id="cb433"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb433-1"><a href="#cb433-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test;</span>
<span id="cb433-2"><a href="#cb433-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------+--------------------------+</span></span>
<span id="cb433-3"><a href="#cb433-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | title       | j                        |</span>
<span id="cb433-4"><a href="#cb433-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------+--------------------------+</span></span>
<span id="cb433-5"><a href="#cb433-5" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | version two | {<span class="ot">&quot;d&quot;</span><span class="ch">:70</span>,<span class="ot">&quot;foo&quot;</span>:{<span class="ot">&quot;b&quot;</span><span class="ch">:100</span>}} |</span>
<span id="cb433-6"><a href="#cb433-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------+--------------------------+</span></span>
<span id="cb433-7"><a href="#cb433-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="dv">0</span>,<span class="dv">00</span> sec)</span></code></pre></div>
<p>Yep, keeping and merging JSON objects is a bit tricky that way.</p>
<p><strong>Non-conflicting JSON keeps are merged into the new column
value.</strong> Object values are recursively merged. Old non-object
values are preserved. The common “KEEP wins vs VALUES” rule does
apply.</p>
<p>Let’s start with the simplest example where we <code>KEEP</code> one
non-object value.</p>
<div class="sourceCode" id="cb434"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb434-1"><a href="#cb434-1" aria-hidden="true" tabindex="-1"></a><span class="kw">REPLACE</span> <span class="kw">INTO</span> test (<span class="kw">id</span>, title, j)</span>
<span id="cb434-2"><a href="#cb434-2" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="dv">123</span>, <span class="st">&#39;v1&#39;</span>, <span class="st">&#39;{&quot;a&quot;: {&quot;b&quot;: 100, &quot;c&quot;:60}}&#39;</span>);</span>
<span id="cb434-3"><a href="#cb434-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-4"><a href="#cb434-4" aria-hidden="true" tabindex="-1"></a><span class="kw">REPLACE</span> <span class="kw">INTO</span> test (<span class="kw">id</span>, title, j)</span>
<span id="cb434-5"><a href="#cb434-5" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="dv">123</span>, <span class="st">&#39;v2&#39;</span>, <span class="st">&#39;{&quot;a&quot;: {&quot;b&quot;: 1, &quot;c&quot;:1, &quot;d&quot;: 1}}&#39;</span>)</span>
<span id="cb434-6"><a href="#cb434-6" aria-hidden="true" tabindex="-1"></a><span class="kw">KEEP</span> (j.a.b);</span>
<span id="cb434-7"><a href="#cb434-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-8"><a href="#cb434-8" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test;</span>
<span id="cb434-9"><a href="#cb434-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+-----------------------------+</span></span>
<span id="cb434-10"><a href="#cb434-10" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | title | j                           |</span>
<span id="cb434-11"><a href="#cb434-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+-----------------------------+</span></span>
<span id="cb434-12"><a href="#cb434-12" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | v2    | {<span class="ot">&quot;a&quot;</span>:{<span class="ot">&quot;c&quot;</span><span class="ch">:1</span>,<span class="ot">&quot;d&quot;</span><span class="ch">:1</span>,<span class="ot">&quot;b&quot;</span><span class="ch">:100</span>}} |</span>
<span id="cb434-13"><a href="#cb434-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+-----------------------------+</span></span>
<span id="cb434-14"><a href="#cb434-14" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="dv">0</span>,<span class="dv">00</span> sec)</span></code></pre></div>
<p>We wanted to keep <code>j.a.b</code> value, we kept it, no surprises
there. Technically it did “merge” the old value into new one. But the
non-object merge simply reverts to keeping the old value. It gets more
interesting when the merged values are full-blown objects. Objects are
properly recursively merged, as follows.</p>
<div class="sourceCode" id="cb435"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb435-1"><a href="#cb435-1" aria-hidden="true" tabindex="-1"></a><span class="kw">REPLACE</span> <span class="kw">INTO</span> test (<span class="kw">id</span>, title, j)</span>
<span id="cb435-2"><a href="#cb435-2" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="dv">123</span>, <span class="st">&#39;v1&#39;</span>, <span class="st">&#39;{&quot;a&quot;: {&quot;b&quot;: 100, &quot;c&quot;: 60}}&#39;</span>);</span>
<span id="cb435-3"><a href="#cb435-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-4"><a href="#cb435-4" aria-hidden="true" tabindex="-1"></a><span class="kw">REPLACE</span> <span class="kw">INTO</span> test (<span class="kw">id</span>, title, j)</span>
<span id="cb435-5"><a href="#cb435-5" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="dv">123</span>, <span class="st">&#39;v2&#39;</span>, <span class="st">&#39;{&quot;a&quot;: {&quot;b&quot;: 1, &quot;c&quot;: 1, &quot;d&quot;: 1}}&#39;</span>)</span>
<span id="cb435-6"><a href="#cb435-6" aria-hidden="true" tabindex="-1"></a><span class="kw">KEEP</span> (j.a);</span>
<span id="cb435-7"><a href="#cb435-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-8"><a href="#cb435-8" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test;</span>
<span id="cb435-9"><a href="#cb435-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+------------------------------+</span></span>
<span id="cb435-10"><a href="#cb435-10" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | title | j                            |</span>
<span id="cb435-11"><a href="#cb435-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+------------------------------+</span></span>
<span id="cb435-12"><a href="#cb435-12" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | v2    | {<span class="ot">&quot;a&quot;</span>:{<span class="ot">&quot;d&quot;</span><span class="ch">:1</span>,<span class="ot">&quot;b&quot;</span><span class="ch">:100</span>,<span class="ot">&quot;c&quot;</span><span class="ch">:60</span>}} |</span>
<span id="cb435-13"><a href="#cb435-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+------------------------------+</span></span>
<span id="cb435-14"><a href="#cb435-14" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="dv">0</span>,<span class="dv">00</span> sec)</span></code></pre></div>
<p>Unlike the non-object <code>j.a.b</code> example above,
<code>j.a</code> is a proper object, and so the old <code>j.a</code>
value melds into the new <code>j.a</code> value. Old values for
<code>j.a.b</code> and <code>j.a.c</code> are preserved, new
<code>j.a.d</code> value is <em>not</em> ditched either. It’s merging,
not replacing.</p>
<p>For the record, <strong>JSON keeps are explicit, and no data gets
<em>implicitly</em> kept.</strong> Any old values that were explicitly
listed in <code>KEEP</code> do survive. Any other old values do not.
They are either removed or replaced with new ones.</p>
<p>For example, note how <code>j.a.c</code> value gets removed. As it
should.</p>
<div class="sourceCode" id="cb436"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb436-1"><a href="#cb436-1" aria-hidden="true" tabindex="-1"></a><span class="kw">REPLACE</span> <span class="kw">INTO</span> test (<span class="kw">id</span>, title, j)</span>
<span id="cb436-2"><a href="#cb436-2" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="dv">123</span>, <span class="st">&#39;hello&#39;</span>, <span class="st">&#39;{&quot;a&quot;: {&quot;b&quot;: 100, &quot;c&quot;: 60}}&#39;</span>);</span>
<span id="cb436-3"><a href="#cb436-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-4"><a href="#cb436-4" aria-hidden="true" tabindex="-1"></a><span class="kw">REPLACE</span> <span class="kw">INTO</span> test (<span class="kw">id</span>, title, j)</span>
<span id="cb436-5"><a href="#cb436-5" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="dv">123</span>, <span class="st">&#39;version two&#39;</span>, <span class="st">&#39;{&quot;k&quot;: 4}&#39;</span>) <span class="kw">keep</span> (j.a.b);</span>
<span id="cb436-6"><a href="#cb436-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-7"><a href="#cb436-7" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test;</span>
<span id="cb436-8"><a href="#cb436-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------+-----------------------+</span></span>
<span id="cb436-9"><a href="#cb436-9" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | title       | j                     |</span>
<span id="cb436-10"><a href="#cb436-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------+-----------------------+</span></span>
<span id="cb436-11"><a href="#cb436-11" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | version two | {<span class="ot">&quot;k&quot;</span><span class="ch">:4</span>,<span class="ot">&quot;a&quot;</span>:{<span class="ot">&quot;b&quot;</span><span class="ch">:100</span>}} |</span>
<span id="cb436-12"><a href="#cb436-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------------+-----------------------+</span></span>
<span id="cb436-13"><a href="#cb436-13" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="dv">0</span>,<span class="dv">00</span> sec)</span></code></pre></div>
<p><code>j.a.b</code> value was kept explicitly, <code>j.a</code> path
was kept implicitly, but <code>j.a.c</code> value was removed because it
was <strong>not</strong> listed explicitly.</p>
<p><strong>Nested <code>KEEP</code> paths (ie. a subkey of another
subkey) are forbidden.</strong> But that makes zero sense anyway. The
topmost key already does the job.</p>
<div class="sourceCode" id="cb437"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb437-1"><a href="#cb437-1" aria-hidden="true" tabindex="-1"></a># ILLEGAL, because <span class="ot">&quot;j.a.b&quot;</span> <span class="kw">is</span> a <span class="kw">nested</span> path <span class="cf">for</span> <span class="ot">&quot;j.a&quot;</span></span>
<span id="cb437-2"><a href="#cb437-2" aria-hidden="true" tabindex="-1"></a><span class="kw">REPLACE</span> <span class="kw">INTO</span> test (<span class="kw">id</span>, title, j) <span class="kw">VALUES</span> <span class="op">..</span>.</span>
<span id="cb437-3"><a href="#cb437-3" aria-hidden="true" tabindex="-1"></a><span class="kw">KEEP</span> (j.a, j.a.b)</span></code></pre></div>
<h3 id="select-syntax">SELECT syntax</h3>
<div class="sourceCode" id="cb438"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb438-1"><a href="#cb438-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">&lt;</span>expr<span class="op">&gt;</span> [<span class="kw">BETWEEN</span> <span class="op">&lt;</span><span class="fu">min</span><span class="op">&gt;</span> <span class="kw">AND</span> <span class="op">&lt;</span><span class="fu">max</span><span class="op">&gt;</span>] [[<span class="kw">AS</span>] <span class="op">&lt;</span>alias<span class="op">&gt;</span>] [, <span class="op">..</span>.]</span>
<span id="cb438-2"><a href="#cb438-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="op">&lt;</span>ftindex<span class="op">&gt;</span> [, <span class="op">..</span>.]</span>
<span id="cb438-3"><a href="#cb438-3" aria-hidden="true" tabindex="-1"></a>    [{<span class="kw">USE</span> | IGNORE | <span class="kw">FORCE</span>} <span class="kw">INDEX</span> (<span class="op">&lt;</span>attr_index<span class="op">&gt;</span> [, <span class="op">..</span>.]) [<span class="op">..</span>.]]</span>
<span id="cb438-4"><a href="#cb438-4" aria-hidden="true" tabindex="-1"></a>[<span class="kw">WHERE</span></span>
<span id="cb438-5"><a href="#cb438-5" aria-hidden="true" tabindex="-1"></a>    [MATCH(<span class="st">&#39;&lt;text_query&gt;&#39;</span>) [<span class="kw">AND</span>]]</span>
<span id="cb438-6"><a href="#cb438-6" aria-hidden="true" tabindex="-1"></a>    [<span class="op">&lt;</span>where_condition<span class="op">&gt;</span> [<span class="kw">AND</span> <span class="op">&lt;</span>where_condition<span class="op">&gt;</span> [<span class="op">..</span>.]]]]</span>
<span id="cb438-7"><a href="#cb438-7" aria-hidden="true" tabindex="-1"></a>[<span class="kw">GROUP</span> [<span class="op">&lt;</span>N<span class="op">&gt;</span>] <span class="kw">BY</span> <span class="op">&lt;</span><span class="kw">column</span><span class="op">&gt;</span> [, <span class="op">..</span>.]</span>
<span id="cb438-8"><a href="#cb438-8" aria-hidden="true" tabindex="-1"></a>    [WITHIN <span class="kw">GROUP</span> <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="op">&lt;</span><span class="kw">column</span><span class="op">&gt;</span> {<span class="kw">ASC</span> | <span class="kw">DESC</span>} [, <span class="op">..</span>.]]</span>
<span id="cb438-9"><a href="#cb438-9" aria-hidden="true" tabindex="-1"></a>    [<span class="kw">HAVING</span> <span class="op">&lt;</span>having_condition<span class="op">&gt;</span>]]</span>
<span id="cb438-10"><a href="#cb438-10" aria-hidden="true" tabindex="-1"></a>[<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="op">&lt;</span><span class="kw">column</span><span class="op">&gt;</span> {<span class="kw">ASC</span> | <span class="kw">DESC</span>} [, <span class="op">..</span>.]]</span>
<span id="cb438-11"><a href="#cb438-11" aria-hidden="true" tabindex="-1"></a>[<span class="kw">LIMIT</span> [<span class="op">&lt;</span>offset<span class="op">&gt;</span>,] <span class="op">&lt;</span>row_count<span class="op">&gt;</span>]</span>
<span id="cb438-12"><a href="#cb438-12" aria-hidden="true" tabindex="-1"></a>[<span class="kw">OPTION</span> <span class="op">&lt;</span>opt_name<span class="op">&gt;</span> <span class="op">=</span> <span class="op">&lt;</span>opt_value<span class="op">&gt;</span> [, <span class="op">..</span>.]]</span>
<span id="cb438-13"><a href="#cb438-13" aria-hidden="true" tabindex="-1"></a>[FACET <span class="op">&lt;</span>facet_options<span class="op">&gt;</span> [<span class="op">..</span>.]]</span></code></pre></div>
<p><code>SELECT</code> is the main querying workhorse, and as such,
comes with a rather extensive (and perhaps a little complicated) syntax.
There are many different parts (aka clauses) in that syntax. Thankfully,
most of them are optional.</p>
<p>Briefly, they are as follows:</p>
<ul>
<li>required <code>SELECT</code> columns list (aka items list, aka
expressions list)</li>
<li>required <code>FROM</code> clause, with the full-text index
list</li>
<li>optional <code>&lt;hint&gt; INDEX</code> clauses, with the attribute
index usage hints</li>
<li>optional <code>WHERE</code> condition clause, with the row filtering
conditions</li>
<li>optional <code>GROUP BY</code> clause, with the row grouping
conditions</li>
<li>optional <code>ORDER BY</code> clause, with the row sorting
conditions</li>
<li>optional <code>LIMIT</code> clause, with the result set size and
offset</li>
<li>optional <code>OPTION</code> clause, with all the special
options</li>
<li>optional <code>FACET</code> clauses, with a list of requested
additional facets</li>
</ul>
<p>The most notable differences from regular SQL are these:</p>
<ul>
<li><code>FROM</code> list is <strong>NOT</strong> an implicit
<code>JOIN</code>, but more like a <code>UNION</code></li>
<li><code>ORDER BY</code> is always present, default is
<code>ORDER BY WEIGHT() DESC, id ASC</code></li>
<li><code>LIMIT</code> is always present, default is
<code>LIMIT 0,20</code></li>
<li><code>GROUP BY</code> always picks a specific “best” row to
represent the group</li>
</ul>
<h4 id="index-hints-clause">Index hints clause</h4>
<p>Index hints can be used to tweak query optimizer behavior and
attribute index usage, for either performance or debugging reasons. Note
that usually you should <em>not</em> have to use them.</p>
<p>Multiple hints can be used, and multiple attribute indexes can be
listed, in any order. For example, the following syntax is legal:</p>
<div class="sourceCode" id="cb439"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb439-1"><a href="#cb439-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> test1</span>
<span id="cb439-2"><a href="#cb439-2" aria-hidden="true" tabindex="-1"></a><span class="kw">USE</span> <span class="kw">INDEX</span> (idx_lat)</span>
<span id="cb439-3"><a href="#cb439-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FORCE</span> <span class="kw">INDEX</span> (idx_price)</span>
<span id="cb439-4"><a href="#cb439-4" aria-hidden="true" tabindex="-1"></a>IGNORE <span class="kw">INDEX</span> (idx_time)</span>
<span id="cb439-5"><a href="#cb439-5" aria-hidden="true" tabindex="-1"></a><span class="kw">USE</span> <span class="kw">INDEX</span> (idx_lon) <span class="op">..</span>.</span></code></pre></div>
<p>All flavors of <code>&lt;hint&gt; INDEX</code> clause take an index
list as their argument, for example:</p>
<div class="sourceCode" id="cb440"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb440-1"><a href="#cb440-1" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>. <span class="kw">USE</span> <span class="kw">INDEX</span> (idx_lat, idx_lon, idx_price)</span></code></pre></div>
<p>Summarily, hints work this way:</p>
<ul>
<li><code>USE INDEX</code> limits the optimizer to only use a subset of
given indexes;</li>
<li><code>IGNORE INDEX</code> strictly forbids given indexes from being
used;</li>
<li><code>FORCE INDEX</code> strictly forces the given indexes to be
used.</li>
</ul>
<p><code>USE INDEX</code> tells the optimizer that it must only consider
the given indexes, rather than <em>all</em> the applicable ones. In
other words, in the absence of the <code>USE</code> clause, all indexes
are fair game. In its presence, only those that were mentioned in the
<code>USE</code> list are. The optimizer still decides whether to
actually to use or ignore any specific index. In the example above it
still might choose to use <code>idx_lat</code> only, but it must never
use <code>idx_time</code>, on the grounds that it was not mentioned
explicitly.</p>
<p><code>IGNORE INDEX</code> completely forbids the optimizer from using
the given indexes. Ignores take priority, they override both
<code>USE INDEX</code> and <code>FORCE INDEX</code>. Thus, while it is
legal to <code>USE INDEX (foo, bar) IGNORE INDEX (bar)</code>, it is way
too verbose. Simple <code>USE INDEX (foo)</code> achieves exactly the
same result.</p>
<p><code>FORCE INDEX</code> makes the optimizer forcibly use the given
indexes (that is, if they are applicable at all) despite the query cost
estimates.</p>
<p>For more discussion and details on attributes indexes and hints,
refer to <a href="#using-attribute-indexes">“Using attribute
indexes”</a>.</p>
<h4 id="star-expansion-quirks">Star expansion quirks</h4>
<p>Ideally any stars (as in <code>SELECT *</code>) would just expand to
“all the columns” as in regular SQL. Except that Sphinx has a couple
peculiarities worth a mention.</p>
<p><strong>Stars skip the indexed-only fields.</strong> Fields that are
not anyhow stored (either in an attribute or in DocStore) can not be
included in <code>SELECT</code>, and will not be included in the star
expansion.</p>
<p>While Sphinx <em>lets</em> one store the original field content, it
still does not <em>require</em> that. So the fields can be full-text
indexed, but not stored in any way, shape, or form. Moreover, that still
is the default behavior.</p>
<p>In SphinxQL terms these indexed-only fields are columns that one
perfectly can (and should) <code>INSERT</code> to, but can not
<code>SELECT</code> from, and they are not included in the star
expansion. Because the original field content to return does not even
exist. Only the full-text index does.</p>
<p><strong>Stars skip the already-selected columns.</strong> Star
expansion currently skips any columns that are explicitly selected
<em>before</em> the star.</p>
<p>For example, assume that we run <code>SELECT cc,ee,*</code> from an
index with 5 attributes named <code>aa</code> to <code>ee</code> (and of
course the required <code>id</code> too). We would expect to get a
result set with 8 columns ordered <code>cc,ee,id,aa,bb,cc,dd,ee</code>
here. But in fact Sphinx would return just 6 columns in the
<code>cc,ee,id,aa,bb,dd</code> order. Because of this “skip the explicit
dupes” quirk.</p>
<p>For the record, this was a requirement a while ago, the result set
column names were required to be unique. Today it’s only a legacy
implementation quirk, going to be eventually fixed.</p>
<h4 id="select-options">SELECT options</h4>
<p>Here’s a brief summary of all the (non-deprecated) options that
<code>SELECT</code> supports.</p>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 48%" />
<col style="width: 10%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr class="header">
<th>Option</th>
<th>Description</th>
<th>Type</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ann_refine</td>
<td>Whether to refine ANN index distances</td>
<td>bool</td>
<td>1</td>
</tr>
<tr class="even">
<td>ann_top</td>
<td>Max matches to fetch from ANN index</td>
<td>int</td>
<td>2000</td>
</tr>
<tr class="odd">
<td>agent_query_timeout</td>
<td>Max agent query timeout, in msec</td>
<td>int</td>
<td>3000</td>
</tr>
<tr class="even">
<td>boolean_simplify</td>
<td>Use boolean query simplification</td>
<td>bool</td>
<td>0</td>
</tr>
<tr class="odd">
<td>comment</td>
<td>Set user comment (gets logged!)</td>
<td>string</td>
<td>’’</td>
</tr>
<tr class="even">
<td>cutoff</td>
<td>Max matches to process per-index</td>
<td>int</td>
<td>0</td>
</tr>
<tr class="odd">
<td>expansion_limit</td>
<td>Per-query keyword expansion limit</td>
<td>int</td>
<td>0</td>
</tr>
<tr class="even">
<td>field_weights</td>
<td>Per-field weights map</td>
<td>map</td>
<td>(…)</td>
</tr>
<tr class="odd">
<td>global_idf</td>
<td>Enable global IDF</td>
<td>bool</td>
<td>0</td>
</tr>
<tr class="even">
<td>index_weights</td>
<td>Per-index weights map</td>
<td>map</td>
<td>(…)</td>
</tr>
<tr class="odd">
<td>inner_limit_per_index</td>
<td>Forcibly use per-index inner LIMIT</td>
<td>bool</td>
<td>0</td>
</tr>
<tr class="even">
<td>lax_agent_errors</td>
<td>Lax agent error handling (treat as warnings)</td>
<td>bool</td>
<td>0</td>
</tr>
<tr class="odd">
<td>local_df</td>
<td>Compute IDF over all the local query indexes</td>
<td>bool</td>
<td>0</td>
</tr>
<tr class="even">
<td>low_priority</td>
<td>Use a low priority thread</td>
<td>bool</td>
<td>0</td>
</tr>
<tr class="odd">
<td>max_predicted_time</td>
<td>Impose a virtual time limit, in units</td>
<td>int</td>
<td>0</td>
</tr>
<tr class="even">
<td>max_query_time</td>
<td>Impose a wall time limit, in msec</td>
<td>int</td>
<td>0</td>
</tr>
<tr class="odd">
<td>rand_seed</td>
<td>Use a specific RAND() seed</td>
<td>int</td>
<td>-1</td>
</tr>
<tr class="even">
<td>rank_fields</td>
<td>Use the listed fields only in FACTORS()</td>
<td>string</td>
<td>’’</td>
</tr>
<tr class="odd">
<td>ranker</td>
<td>Use a given ranker function (and expression)</td>
<td>enum</td>
<td>proximity_bm15</td>
</tr>
<tr class="even">
<td>retry_count</td>
<td>Max agent query retries count</td>
<td>int</td>
<td>0</td>
</tr>
<tr class="odd">
<td>retry_delay</td>
<td>Agent query retry delay, in msec</td>
<td>int</td>
<td>500</td>
</tr>
<tr class="even">
<td>sample_div</td>
<td>Enable sampling with this divisor</td>
<td>int</td>
<td>0</td>
</tr>
<tr class="odd">
<td>sample_min</td>
<td>Start sampling after this many matches</td>
<td>int</td>
<td>0</td>
</tr>
<tr class="even">
<td>sort_mem</td>
<td>Per-sorter memory budget, in bytes</td>
<td>size</td>
<td>50M</td>
</tr>
<tr class="odd">
<td>sort_method</td>
<td>Match sorting method (<code>pq</code> or <code>kbuffer</code>)</td>
<td>enum</td>
<td>pq</td>
</tr>
<tr class="even">
<td>threads</td>
<td>Threads to use for PQ/ANN searches</td>
<td>int</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>Most of the options take integer values. Boolean flags such as
<code>global_idf</code> also take integers, either 0 (off) or 1 (on).
For convenience, <code>sort_mem</code> budget option takes either an
integer value in bytes, or with a size postfix (K/M/G).</p>
<p><code>field_weights</code> and <code>index_weights</code> options
take a map that maps names to (integer) values, as follows:</p>
<div class="sourceCode" id="cb441"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb441-1"><a href="#cb441-1" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>. <span class="kw">OPTION</span> field_weights<span class="op">=</span>(title<span class="op">=</span><span class="dv">10</span>, content<span class="op">=</span><span class="dv">3</span>)</span></code></pre></div>
<p><code>rank_fields</code> option takes a list of fields as a string,
for example:</p>
<div class="sourceCode" id="cb442"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb442-1"><a href="#cb442-1" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>. <span class="kw">OPTION</span> rank_fields<span class="op">=</span><span class="st">&#39;title content&#39;</span></span></code></pre></div>
<p>Refer to <a href="#fine-tuning-ann-searches">“Fine-tuning ANN
searches”</a> for details on <code>ann_refine</code>,
<code>ann_top</code> and <code>threads</code> for ANN queries.</p>
<p>Refer to <a href="#searching-percolate-queries">“Searching: percolate
queries”</a> for details on <code>threads</code> for PQ queries.</p>
<h4 id="index-sampling">Index sampling</h4>
<p>You can get sampled search results using the <code>sample_div</code>
and <code>sample_min</code> options, usually in a fraction of time
compared to the regular, “full” search. The key idea is to only process
every N-th row at the lowest possible level, and skip everything
else.</p>
<p>To enable index sampling simply set the <code>sample_div</code>
divisor to anything greater or equal than 2. For example, the following
runs a query over approximately 5% of the entire index.</p>
<div class="sourceCode" id="cb443"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb443-1"><a href="#cb443-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, WEIGHT() <span class="kw">FROM</span> test1 <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>)</span>
<span id="cb443-2"><a href="#cb443-2" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> sample_div<span class="op">=</span><span class="dv">20</span></span></code></pre></div>
<p>To initially pause sampling additionally set the
<code>sample_min</code> threshold to anything greater than the default
0. Sampling will then only engage later, once <code>sample_min</code>
matches are collected. So, naturally, sampled result sets up to
<code>sample_min</code> matches (inclusive) must be exact. For
example.</p>
<div class="sourceCode" id="cb444"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb444-1"><a href="#cb444-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, WEIGHT() <span class="kw">FROM</span> test1 <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>)</span>
<span id="cb444-2"><a href="#cb444-2" aria-hidden="true" tabindex="-1"></a><span class="kw">OPTION</span> sample_div<span class="op">=</span><span class="dv">20</span>, sample_min<span class="op">=</span><span class="dv">1000</span></span></code></pre></div>
<p>Sampling works with distributed indexes too. However, in that case,
the minimum threshold applies to each component index. For example, if
<code>test1</code> is actually a distributed index with 4 shards in the
example above, then <em>each</em> shard will collect 1000 matches first,
and then only sample every 20-th row next.</p>
<p>Last but not least, <strong>beware that sampling works on rows and
NOT matches!</strong> The sampled result is equivalent to running the
query against a sampled index built from a fraction of the data (every
N-th row, where N is <code>sample_div</code>). <strong>Non-sampled rows
are skipped very early, even before matching.</strong></p>
<p>And this <em>is</em> somewhat different from sampling the final
results. If your <code>WHERE</code> conditions are heavily correlated
with the sampled rowids, then the sampled results might be severely
biased (as in, way off).</p>
<p>Here’s an extreme example of that bias. What if we have an index with
1 million documents having almost sequential docids (with just a few
numbering gaps), and filter on a docid remainder using the very same
divisor as with sampling?!</p>
<div class="sourceCode" id="cb445"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb445-1"><a href="#cb445-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, <span class="kw">id</span>%<span class="dv">10</span> rem <span class="kw">FROM</span> test1m <span class="kw">WHERE</span> rem<span class="op">=</span><span class="dv">3</span></span>
<span id="cb445-2"><a href="#cb445-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">LIMIT</span> <span class="dv">5</span> <span class="kw">OPTION</span> sample_div<span class="op">=</span><span class="dv">10</span>;</span>
<span id="cb445-3"><a href="#cb445-3" aria-hidden="true" tabindex="-1"></a><span class="kw">Empty</span> <span class="kw">set</span> (<span class="fl">0.10</span> sec)</span></code></pre></div>
<p>Well, in the extreme example the results are <em>extremely</em>
skewed. Without sampling, we <em>do</em> get about 100K matches from
that query (99994 to be precise). With 1/10-th sampling, normally we
would expect (and get!) about 10K matches.</p>
<p>Except that “thanks” to the heavily correlated (practically
dependent) condition we get 0 matches! Way, waaay off. Well, it’s as if
we were searching for “odd” docids in the “even” half of the index. Of
course we would get zero matches.</p>
<p>But once we tweak the divisor just a little and decorrelate, the
situation is immediately back to normal.</p>
<div class="sourceCode" id="cb446"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb446-1"><a href="#cb446-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, <span class="kw">id</span>%<span class="dv">10</span> rem <span class="kw">FROM</span> test1m <span class="kw">WHERE</span> rem<span class="op">=</span><span class="dv">3</span></span>
<span id="cb446-2"><a href="#cb446-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">LIMIT</span> <span class="dv">3</span> <span class="kw">OPTION</span> sample_div<span class="op">=</span><span class="dv">11</span>;</span>
<span id="cb446-3"><a href="#cb446-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+</span></span>
<span id="cb446-4"><a href="#cb446-4" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | rem  |</span>
<span id="cb446-5"><a href="#cb446-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+</span></span>
<span id="cb446-6"><a href="#cb446-6" aria-hidden="true" tabindex="-1"></a>|   <span class="dv">23</span> |    <span class="dv">3</span> |</span>
<span id="cb446-7"><a href="#cb446-7" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">133</span> |    <span class="dv">3</span> |</span>
<span id="cb446-8"><a href="#cb446-8" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">243</span> |    <span class="dv">3</span> |</span>
<span id="cb446-9"><a href="#cb446-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+</span></span>
<span id="cb446-10"><a href="#cb446-10" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.08</span> sec)</span>
<span id="cb446-11"><a href="#cb446-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-12"><a href="#cb446-12" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW META <span class="kw">like</span> <span class="st">&#39;total_found&#39;</span>;</span>
<span id="cb446-13"><a href="#cb446-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+-------+</span></span>
<span id="cb446-14"><a href="#cb446-14" aria-hidden="true" tabindex="-1"></a>| Variable_name | <span class="fu">Value</span> |</span>
<span id="cb446-15"><a href="#cb446-15" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+-------+</span></span>
<span id="cb446-16"><a href="#cb446-16" aria-hidden="true" tabindex="-1"></a>| total_found   | <span class="dv">9090</span>  |</span>
<span id="cb446-17"><a href="#cb446-17" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+-------+</span></span>
<span id="cb446-18"><a href="#cb446-18" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Actually, ideal sampling, that. Instead of a complete and utter miss
we had just before. (For the record, as the exact count is 99994, so any
<code>total_found</code> from 9000 to 9180 would still be within a very
reasonable 1% margin of error away from the ideal 9090 sample size.)
Bottom line, beware of the correlations and take good care of them.</p>
<h3 id="select-expr-syntax">SELECT expr syntax</h3>
<div class="sourceCode" id="cb447"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb447-1"><a href="#cb447-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">&lt;</span>expression<span class="op">&gt;</span></span></code></pre></div>
<p>This special <code>SELECT</code> form lets you use Sphinx as a
calculator, and evaluate an individual expression on Sphinx side. For
instance!</p>
<div class="sourceCode" id="cb448"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb448-1"><a href="#cb448-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="fu">sin</span>(<span class="dv">1</span>)<span class="op">+</span><span class="dv">2</span>;</span>
<span id="cb448-2"><a href="#cb448-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+</span></span>
<span id="cb448-3"><a href="#cb448-3" aria-hidden="true" tabindex="-1"></a>| <span class="fu">sin</span>(<span class="dv">1</span>)<span class="op">+</span><span class="dv">2</span> |</span>
<span id="cb448-4"><a href="#cb448-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+</span></span>
<span id="cb448-5"><a href="#cb448-5" aria-hidden="true" tabindex="-1"></a>| <span class="fl">2.841471</span> |</span>
<span id="cb448-6"><a href="#cb448-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+</span></span>
<span id="cb448-7"><a href="#cb448-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb448-8"><a href="#cb448-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb448-9"><a href="#cb448-9" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> crc32(<span class="st">&#39;eisenhower&#39;</span>);</span>
<span id="cb448-10"><a href="#cb448-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------+</span></span>
<span id="cb448-11"><a href="#cb448-11" aria-hidden="true" tabindex="-1"></a>| crc32(<span class="st">&#39;eisenhower&#39;</span>) |</span>
<span id="cb448-12"><a href="#cb448-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------+</span></span>
<span id="cb448-13"><a href="#cb448-13" aria-hidden="true" tabindex="-1"></a>| <span class="op">-</span><span class="dv">804052648</span>          |</span>
<span id="cb448-14"><a href="#cb448-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------+</span></span>
<span id="cb448-15"><a href="#cb448-15" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="select-uservar-syntax">SELECT <span class="citation"
data-cites="uservar">@uservar</span> syntax</h3>
<div class="sourceCode" id="cb449"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb449-1"><a href="#cb449-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">&lt;</span>@uservar<span class="op">&gt;</span></span></code></pre></div>
<p>This special <code>SELECT</code> form lets you examine a specific
user variable. Unknown variable will return NULL. Known variable will
return its value.</p>
<div class="sourceCode" id="cb450"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb450-1"><a href="#cb450-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">set</span> <span class="kw">global</span> @foo<span class="op">=</span>(<span class="dv">9</span>,<span class="dv">1</span>,<span class="dv">13</span>);</span>
<span id="cb450-2"><a href="#cb450-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb450-3"><a href="#cb450-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-4"><a href="#cb450-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> @foo;</span>
<span id="cb450-5"><a href="#cb450-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+</span></span>
<span id="cb450-6"><a href="#cb450-6" aria-hidden="true" tabindex="-1"></a>| @foo     |</span>
<span id="cb450-7"><a href="#cb450-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+</span></span>
<span id="cb450-8"><a href="#cb450-8" aria-hidden="true" tabindex="-1"></a>| (<span class="dv">1</span>,<span class="dv">9</span>,<span class="dv">13</span>) |</span>
<span id="cb450-9"><a href="#cb450-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------+</span></span>
<span id="cb450-10"><a href="#cb450-10" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb450-11"><a href="#cb450-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-12"><a href="#cb450-12" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> @bar;</span>
<span id="cb450-13"><a href="#cb450-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+</span></span>
<span id="cb450-14"><a href="#cb450-14" aria-hidden="true" tabindex="-1"></a>| @bar |</span>
<span id="cb450-15"><a href="#cb450-15" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+</span></span>
<span id="cb450-16"><a href="#cb450-16" aria-hidden="true" tabindex="-1"></a>| <span class="kw">NULL</span> |</span>
<span id="cb450-17"><a href="#cb450-17" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+</span></span>
<span id="cb450-18"><a href="#cb450-18" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="select-sysvar-syntax">SELECT @<span class="citation"
data-cites="sysvar">@sysvar</span> syntax</h3>
<div class="sourceCode" id="cb451"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb451-1"><a href="#cb451-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">&lt;</span>@@sysvar<span class="op">&gt;</span> [<span class="kw">LIMIT</span> [<span class="op">&lt;</span>offset<span class="op">&gt;</span> ,] row_count]</span></code></pre></div>
<p>This special <code>SELECT</code> form is a placeholder that does
nothing. This is just for compatibility with frameworks and/or MySQL
client libraries that automatically execute this kind of statement.</p>
<h3 id="show-create-table-syntax">SHOW CREATE TABLE syntax</h3>
<div class="sourceCode" id="cb452"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb452-1"><a href="#cb452-1" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">CREATE</span> <span class="kw">TABLE</span> <span class="op">&lt;</span>ftindex<span class="op">&gt;</span></span></code></pre></div>
<p>This statement prints a <code>CREATE TABLE</code> statement matching
the given full-text index schema and settings. It works for both plain
and RT indexes.</p>
<p>The initial purpose of this statement was to support
<code>mysqldump</code> which requires at least <em>some</em>
<code>CREATE TABLE</code> text.</p>
<p>However, it should also be a useful tool to examine index settings on
the fly, because it also prints out any non-default settings.</p>
<pre><code>mysql&gt; SHOW CREATE TABLE jsontest \G
*************************** 1. row ***************************
       Table: jsontest
Create Table: CREATE TABLE jsontest (
  id bigint,
  title field indexed,
  content field indexed,
  uid bigint,
  j json
)
OPTION rt_mem_limit = 10485760,
  min_infix_len = 3
1 row in set (0.00 sec)</code></pre>
<h3 id="show-followers-syntax">SHOW FOLLOWERS syntax</h3>
<div class="sourceCode" id="cb454"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb454-1"><a href="#cb454-1" aria-hidden="true" tabindex="-1"></a>SHOW FOLLOWERS</span></code></pre></div>
<p><code>SHOW FOLLOWERS</code> displays all the currently connected
followers (remote hosts) and their replicas (replicated indexes), if
any.</p>
<div class="sourceCode" id="cb455"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb455-1"><a href="#cb455-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show followers;</span>
<span id="cb455-2"><a href="#cb455-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------+------------------+-----+----------+</span></span>
<span id="cb455-3"><a href="#cb455-3" aria-hidden="true" tabindex="-1"></a>| replica                   | addr             | tid | <span class="fu">lag</span>      |</span>
<span id="cb455-4"><a href="#cb455-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------+------------------+-----+----------+</span></span>
<span id="cb455-5"><a href="#cb455-5" aria-hidden="true" tabindex="-1"></a>| 512494f3<span class="op">-</span>c3a772e8<span class="ch">:rt_test</span> | <span class="dv">127</span>.<span class="dv">0</span>.<span class="fl">0.1</span><span class="ch">:45702</span>  | <span class="dv">4</span>   | <span class="dv">409</span> msec |</span>
<span id="cb455-6"><a href="#cb455-6" aria-hidden="true" tabindex="-1"></a>| b472e866<span class="op">-</span>ca5dc07e<span class="ch">:rt_test</span> | <span class="dv">127</span>.<span class="dv">0</span>.<span class="fl">0.1</span><span class="ch">:45817</span>  | <span class="dv">8</span>   | <span class="dv">102</span> msec |</span>
<span id="cb455-7"><a href="#cb455-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------+------------------+-----+----------+</span></span>
<span id="cb455-8"><a href="#cb455-8" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Refer to <a href="#using-replication">“Using replication”</a> for
details.</p>
<h3 id="show-index-agent-status-syntax">SHOW INDEX AGENT STATUS
syntax</h3>
<div class="sourceCode" id="cb456"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb456-1"><a href="#cb456-1" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">INDEX</span> <span class="op">&lt;</span>distindex<span class="op">&gt;</span> <span class="kw">AGENT</span> STATUS [<span class="kw">LIKE</span> <span class="st">&#39;&lt;mask&gt;&#39;</span>] [IGNORE <span class="st">&#39;&lt;mask&gt;&#39;</span>]</span></code></pre></div>
<p><code>SHOW INDEX AGENT STATUS</code> lets you examine a number
internal per-agent counters associated with every agent (and then every
mirror host of an agent) in a given distributed index.</p>
<p>The agents are numbered in the config order. The mirrors within each
agent are also numbered in the config order. All timers must internally
have microsecond precision, but should be displayed as floats and in
milliseconds, for example:</p>
<div class="sourceCode" id="cb457"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb457-1"><a href="#cb457-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW <span class="kw">INDEX</span> dist1 <span class="kw">AGENT</span> STATUS <span class="kw">LIKE</span> <span class="st">&#39;%que%&#39;</span>;</span>
<span id="cb457-2"><a href="#cb457-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------+-------+</span></span>
<span id="cb457-3"><a href="#cb457-3" aria-hidden="true" tabindex="-1"></a>| Variable_name                  | <span class="fu">Value</span> |</span>
<span id="cb457-4"><a href="#cb457-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------+-------+</span></span>
<span id="cb457-5"><a href="#cb457-5" aria-hidden="true" tabindex="-1"></a>| agent1_host1_query_timeouts    | <span class="dv">0</span>     |</span>
<span id="cb457-6"><a href="#cb457-6" aria-hidden="true" tabindex="-1"></a>| agent1_host1_succeeded_queries | <span class="dv">1</span>     |</span>
<span id="cb457-7"><a href="#cb457-7" aria-hidden="true" tabindex="-1"></a>| agent1_host1_total_query_msec  | <span class="fl">2.943</span> |</span>
<span id="cb457-8"><a href="#cb457-8" aria-hidden="true" tabindex="-1"></a>| agent2_host1_query_timeouts    | <span class="dv">0</span>     |</span>
<span id="cb457-9"><a href="#cb457-9" aria-hidden="true" tabindex="-1"></a>| agent2_host1_succeeded_queries | <span class="dv">1</span>     |</span>
<span id="cb457-10"><a href="#cb457-10" aria-hidden="true" tabindex="-1"></a>| agent2_host1_total_query_msec  | <span class="fl">3.586</span> |</span>
<span id="cb457-11"><a href="#cb457-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------+-------+</span></span>
<span id="cb457-12"><a href="#cb457-12" aria-hidden="true" tabindex="-1"></a><span class="dv">6</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>As we can see from the output, there was just 1 query sent to each
agent since <code>searchd</code> start, that query went well on both
agents, and it took approx 2.9 ms and 3.6 ms respectively. The specific
agents are addresses are intentionally not part of this status output to
avoid clutter; they can in turn be examined using <code>DESCRIBE</code>
statement:</p>
<div class="sourceCode" id="cb458"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb458-1"><a href="#cb458-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">DESC</span> dist1</span>
<span id="cb458-2"><a href="#cb458-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------+----------+</span></span>
<span id="cb458-3"><a href="#cb458-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">Agent</span>               | <span class="kw">Type</span>     |</span>
<span id="cb458-4"><a href="#cb458-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------+----------+</span></span>
<span id="cb458-5"><a href="#cb458-5" aria-hidden="true" tabindex="-1"></a>| <span class="dv">127</span>.<span class="dv">0</span>.<span class="fl">0.1</span><span class="ch">:7013:loc1</span> | remote_1 |</span>
<span id="cb458-6"><a href="#cb458-6" aria-hidden="true" tabindex="-1"></a>| <span class="dv">127</span>.<span class="dv">0</span>.<span class="fl">0.1</span><span class="ch">:7015:loc2</span> | remote_2 |</span>
<span id="cb458-7"><a href="#cb458-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------+----------+</span></span>
<span id="cb458-8"><a href="#cb458-8" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>In this case (ie. without mirrors) the mapping is straightforward, we
can see that we only have two agents, <code>agent1</code> on port 7013
and <code>agent2</code> on port 7015, and we now know what statistics
are associated with which agent exactly. Easy.</p>
<h3 id="show-index-from-syntax">SHOW INDEX FROM syntax</h3>
<div class="sourceCode" id="cb459"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb459-1"><a href="#cb459-1" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">INDEX</span> <span class="kw">FROM</span> <span class="op">&lt;</span>ftindex<span class="op">&gt;</span></span></code></pre></div>
<p><code>SHOW INDEX</code> lists all attribute indexes from the given FT
index, along with their types, and column names or JSON paths (where
applicable). For example:</p>
<pre><code>mysql&gt; SHOW INDEX FROM test;
+-----+--------------+-----------+--------------+------------+--------------+
| Seq | IndexName    | IndexType | AttrName     | ExprType   | Expr         |
+-----+--------------+-----------+--------------+------------+--------------+
| 1   | idx_bigint   | btree     | tag_bigint   | bigint     | tag_bigint   |
| 2   | idx_multi    | btree     | tag_multi    | uint_set   | tag_multi    |
+-----+--------------+-----------+--------------+------------+--------------+
2 rows in set (0.00 sec)</code></pre>
<p>Note that just the attribute indexes names for the given FT index can
be listed by both <code>SHOW INDEX</code> and <code>DESCRIBE</code>
statements:</p>
<pre><code>mysql&gt; DESCRIBE test;
+--------------+------------+------------+--------------+
| Field        | Type       | Properties | Key          |
+--------------+------------+------------+--------------+
| id           | bigint     |            |              |
| title        | field      | indexed    |              |
| tag_bigint   | bigint     |            | idx_bigint   |
| tag_multi    | uint_set   |            | idx_multi    |
+--------------+------------+------------+--------------+
4 rows in set (0.00 sec)</code></pre>
<p>However, <code>SHOW INDEX</code> also provides additional details,
namely the value type, physical index type, the exact JSON expression
indexed, etc. (As a side note, for “simple” indexes on non-JSON columns,
<code>Expr</code> just equals <code>AttrName</code>.)</p>
<h3 id="show-index-status-syntax">SHOW INDEX STATUS syntax</h3>
<div class="sourceCode" id="cb462"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb462-1"><a href="#cb462-1" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">INDEX</span> <span class="op">&lt;</span>ftindex<span class="op">&gt;</span> STATUS [<span class="kw">LIKE</span> <span class="st">&#39;&lt;mask&gt;&#39;</span>] [IGNORE <span class="st">&#39;&lt;mask&gt;&#39;</span>]</span>
<span id="cb462-2"><a href="#cb462-2" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">TABLE</span> <span class="op">&lt;</span>ftindex<span class="op">&gt;</span> STATUS [<span class="kw">LIKE</span> <span class="st">&#39;&lt;mask&gt;&#39;</span>] [IGNORE <span class="st">&#39;&lt;mask&gt;&#39;</span>] # alias</span></code></pre></div>
<p>Displays various per-ftindex aka per-“table” counters (sizes in
documents and bytes, query statistics, etc). Supports local and
distributed indexes.</p>
<p>Optional <code>LIKE</code> and <code>IGNORE</code> clauses can help
filter results, see <a href="#like-and-ignore-clause">“LIKE and IGNORE
clause”</a> for details.</p>
<p>Here’s an example output against a local index named <code>lj</code>.
To make it concise, let’s only keep counters that contain
<code>ind</code> anywhere in their name.</p>
<div class="sourceCode" id="cb463"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb463-1"><a href="#cb463-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show <span class="kw">index</span> lj status <span class="kw">like</span> <span class="st">&#39;%ind%&#39;</span>;</span>
<span id="cb463-2"><a href="#cb463-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------------+----------+</span></span>
<span id="cb463-3"><a href="#cb463-3" aria-hidden="true" tabindex="-1"></a>| Variable_name        | <span class="fu">Value</span>    |</span>
<span id="cb463-4"><a href="#cb463-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------------+----------+</span></span>
<span id="cb463-5"><a href="#cb463-5" aria-hidden="true" tabindex="-1"></a>| index_type           | <span class="kw">local</span>    |</span>
<span id="cb463-6"><a href="#cb463-6" aria-hidden="true" tabindex="-1"></a>| indexed_documents    | <span class="dv">10000</span>    |</span>
<span id="cb463-7"><a href="#cb463-7" aria-hidden="true" tabindex="-1"></a>| indexed_bytes        | <span class="dv">12155329</span> |</span>
<span id="cb463-8"><a href="#cb463-8" aria-hidden="true" tabindex="-1"></a>| attrindex_ram_bytes  | <span class="dv">0</span>        |</span>
<span id="cb463-9"><a href="#cb463-9" aria-hidden="true" tabindex="-1"></a>| attrindex_disk_bytes | <span class="dv">778549</span>   |</span>
<span id="cb463-10"><a href="#cb463-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------------+----------+</span></span>
<span id="cb463-11"><a href="#cb463-11" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>There are more counters than that. Some are returned as individual
numeric or string values, but some are grouped together and then
formatted as small JSON documents, for convenience. For instance,
Sphinx-side query timing percentiles over the last 1 minute window are
returned as 1 JSON instead of 6 individual counters, as follows.</p>
<div class="sourceCode" id="cb464"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb464-1"><a href="#cb464-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show <span class="kw">index</span> lj status <span class="kw">like</span> <span class="st">&#39;query_time_1min&#39;</span> \G</span>
<span id="cb464-2"><a href="#cb464-2" aria-hidden="true" tabindex="-1"></a><span class="op">***************************</span> <span class="fl">1.</span> <span class="kw">row</span> <span class="op">***************************</span></span>
<span id="cb464-3"><a href="#cb464-3" aria-hidden="true" tabindex="-1"></a>Variable_name: query_time_1min</span>
<span id="cb464-4"><a href="#cb464-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Value</span>: {<span class="ot">&quot;queries&quot;</span><span class="ch">:3</span>, <span class="ot">&quot;avg_sec&quot;</span><span class="ch">:0</span><span class="fl">.001</span>, <span class="ot">&quot;min_sec&quot;</span><span class="ch">:0</span><span class="fl">.001</span>,</span>
<span id="cb464-5"><a href="#cb464-5" aria-hidden="true" tabindex="-1"></a>               <span class="ot">&quot;max_sec&quot;</span><span class="ch">:0</span><span class="fl">.002</span>, <span class="ot">&quot;pct95_sec&quot;</span><span class="ch">:0</span><span class="fl">.002</span>, <span class="ot">&quot;pct99_sec&quot;</span><span class="ch">:0</span><span class="fl">.002</span>}</span>
<span id="cb464-6"><a href="#cb464-6" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Here are brief descriptions of the currently implemented counters,
organized by specific index type.</p>
<p><strong>Counters for local (plain/RT/PQ) indexes.</strong></p>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="header">
<th>Counter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>index_type</code></td>
<td>Type name (“local”, “distributed”, “rt”, “template”, or “pq”)</td>
</tr>
<tr class="even">
<td><code>indexed_documents</code></td>
<td>Total number of ever-indexed documents (including deleted ones)</td>
</tr>
<tr class="odd">
<td><code>indexed_bytes</code></td>
<td>Total number of ever-indexed text bytes (including deleted too)</td>
</tr>
<tr class="even">
<td><code>ram_bytes</code></td>
<td>Current RAM use, in bytes</td>
</tr>
<tr class="odd">
<td><code>disk_bytes</code></td>
<td>Current disk use, in bytes</td>
</tr>
</tbody>
</table>
<p>Note how <code>indexed_xxx</code> counters refer to the total number
of documents ever indexed, <strong>NOT</strong> the number of documents
currently present in the index! What’s the difference?</p>
<p>Imagine you insert 1000 new rows and delete 995 existing rows from a
RT index every minute for 60 minutes. By the end, a total of 60000
documents would have been indexed, and 59700 would have been deleted.
Simple <code>SELECT COUNT(*)</code> query would then return 300 (the
documents still present, aka alive documents), but the
<code>indexed_documents</code> counter would return 60000 (the total
ever indexed).</p>
<p><strong>Counters for full-text (plain/RT) indexes.</strong></p>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 74%" />
</colgroup>
<thead>
<tr class="header">
<th>Counter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>field_tokens_xxx</code></td>
<td>Dynamic per-field token counts (requires
<code>index_field_lengths</code>)</td>
</tr>
<tr class="even">
<td><code>total_tokens</code></td>
<td>Dynamic total per-index token count (requires
<code>index_field_lengths</code>)</td>
</tr>
<tr class="odd">
<td><code>avg_tokens_xxx</code></td>
<td>Static per-field token counts (requires
<code>global_avg_field_lengths</code>)</td>
</tr>
<tr class="even">
<td><code>attrindex_ram_bytes</code></td>
<td>Current secondary indexes RAM use, in bytes</td>
</tr>
<tr class="odd">
<td><code>attrindex_disk_bytes</code></td>
<td>Current secondary indexes disk use, in bytes</td>
</tr>
<tr class="even">
<td><code>alive_rows</code></td>
<td>The number of alive documents (excluding soft-deleted ones)</td>
</tr>
<tr class="odd">
<td><code>alive_rows_pct</code></td>
<td>The percentage of alive documents in the total number</td>
</tr>
<tr class="even">
<td><code>total_rows</code></td>
<td>Total number of documents in the index (including soft-deleted
ones)</td>
</tr>
</tbody>
</table>
<p><code>xxx</code> is the respective full-text field name. For example,
in an index with two fields (<code>title</code> and
<code>content</code>) we get this.</p>
<div class="sourceCode" id="cb465"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb465-1"><a href="#cb465-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show <span class="kw">index</span> lj status <span class="kw">like</span> <span class="st">&#39;field_tok%&#39;</span>;</span>
<span id="cb465-2"><a href="#cb465-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------------+---------+</span></span>
<span id="cb465-3"><a href="#cb465-3" aria-hidden="true" tabindex="-1"></a>| Variable_name        | <span class="fu">Value</span>   |</span>
<span id="cb465-4"><a href="#cb465-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------------+---------+</span></span>
<span id="cb465-5"><a href="#cb465-5" aria-hidden="true" tabindex="-1"></a>| field_tokens_title   | <span class="dv">19118</span>   |</span>
<span id="cb465-6"><a href="#cb465-6" aria-hidden="true" tabindex="-1"></a>| field_tokens_content | <span class="dv">1373745</span> |</span>
<span id="cb465-7"><a href="#cb465-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------------+---------+</span></span>
<span id="cb465-8"><a href="#cb465-8" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>The <code>alive_rows</code> counter exactly equals
<code>SELECT COUNT(*) FROM &lt;ftindex&gt;</code>, and
<code>alive_rows_pct = 100 * alive_rows / total_rows</code> by
definition, so formally just the <code>total_rows</code> is sufficient.
But that’s inconvenient!</p>
<p><strong>Counters specific to RT indexes.</strong></p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 70%" />
</colgroup>
<thead>
<tr class="header">
<th>Counter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>ram_segments</code></td>
<td>Current number of RAM segments</td>
</tr>
<tr class="even">
<td><code>disk_segments</code></td>
<td>Current number of disk segments</td>
</tr>
<tr class="odd">
<td><code>ram_segments_bytes</code></td>
<td>Current RAM use by RAM segments only, in bytes</td>
</tr>
<tr class="even">
<td><code>mem_limit</code></td>
<td><code>rt_mem_limit</code> setting, in bytes</td>
</tr>
<tr class="odd">
<td><code>last_attach_tm</code></td>
<td>Local server date and time of the last <code>ATTACH</code></td>
</tr>
<tr class="even">
<td><code>last_optimize_tm</code></td>
<td>Local server date and time of the last <code>OPTIMIZE</code></td>
</tr>
</tbody>
</table>
<p>Only the last <strong>successful</strong> <code>ATTACH</code> or
<code>OPTIMIZE</code> operations are tracked.</p>
<p><strong>Counters specific to distributed indexes.</strong></p>
<table>
<colgroup>
<col style="width: 30%" />
<col style="width: 69%" />
</colgroup>
<thead>
<tr class="header">
<th>Counter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>local_disk_segments</code></td>
<td>Total number of disk segments over local RT indexes</td>
</tr>
<tr class="even">
<td><code>local_ram_segments</code></td>
<td>Total number of RAM segments over local RT indexes</td>
</tr>
<tr class="odd">
<td><code>alive_rows</code></td>
<td>The number of alive documents (w/o soft-deleted)</td>
</tr>
<tr class="even">
<td><code>alive_rows_pct</code></td>
<td>The percentage of alive documents in the total</td>
</tr>
<tr class="odd">
<td><code>total_rows</code></td>
<td>Total number of documents (with soft-deleted)</td>
</tr>
</tbody>
</table>
<p>The rows counters are aggregated from all the machines in the
distributed index, over all the physical (RT or plain) indexes.</p>
<p><strong>Query counters for all indexes
(local/distributed/PQ).</strong></p>
<table>
<colgroup>
<col style="width: 22%" />
<col style="width: 77%" />
</colgroup>
<thead>
<tr class="header">
<th>Counter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>query_time_xxx</code></td>
<td>Search query timings percentiles, over the last <code>xxx</code>
period</td>
</tr>
<tr class="even">
<td><code>found_rows_xxx</code></td>
<td>Found rows counts percentiles, over the last <code>xxx</code>
period</td>
</tr>
<tr class="odd">
<td><code>warnings</code></td>
<td>Warnings returned, over all tracked periods</td>
</tr>
</tbody>
</table>
<p><code>xxx</code> is the name of the time period (aka time window).
It’s one of <code>1min</code>, <code>5min</code>, <code>15min</code>, or
<code>total</code> (since last <code>searchd</code> restart). Here’s an
example.</p>
<div class="sourceCode" id="cb466"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb466-1"><a href="#cb466-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show <span class="kw">index</span> lj status <span class="kw">like</span> <span class="st">&#39;query%&#39;</span>;</span>
<span id="cb466-2"><a href="#cb466-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------+--------------------------------------------------------------------------------------------------------+</span></span>
<span id="cb466-3"><a href="#cb466-3" aria-hidden="true" tabindex="-1"></a>| Variable_name    | <span class="fu">Value</span>                                                                                                  |</span>
<span id="cb466-4"><a href="#cb466-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------+--------------------------------------------------------------------------------------------------------+</span></span>
<span id="cb466-5"><a href="#cb466-5" aria-hidden="true" tabindex="-1"></a>| query_time_1min  | {<span class="ot">&quot;queries&quot;</span><span class="ch">:0</span>, <span class="ot">&quot;avg_sec&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;min_sec&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;max_sec&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;pct95_sec&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;pct99_sec&quot;</span>:<span class="ot">&quot;-&quot;</span>}           |</span>
<span id="cb466-6"><a href="#cb466-6" aria-hidden="true" tabindex="-1"></a>| query_time_5min  | {<span class="ot">&quot;queries&quot;</span><span class="ch">:0</span>, <span class="ot">&quot;avg_sec&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;min_sec&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;max_sec&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;pct95_sec&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;pct99_sec&quot;</span>:<span class="ot">&quot;-&quot;</span>}           |</span>
<span id="cb466-7"><a href="#cb466-7" aria-hidden="true" tabindex="-1"></a>| query_time_15min | {<span class="ot">&quot;queries&quot;</span><span class="ch">:0</span>, <span class="ot">&quot;avg_sec&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;min_sec&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;max_sec&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;pct95_sec&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;pct99_sec&quot;</span>:<span class="ot">&quot;-&quot;</span>}           |</span>
<span id="cb466-8"><a href="#cb466-8" aria-hidden="true" tabindex="-1"></a>| query_time_total | {<span class="ot">&quot;queries&quot;</span><span class="ch">:3</span>, <span class="ot">&quot;avg_sec&quot;</span><span class="ch">:0</span><span class="fl">.001</span>, <span class="ot">&quot;min_sec&quot;</span><span class="ch">:0</span><span class="fl">.001</span>, <span class="ot">&quot;max_sec&quot;</span><span class="ch">:0</span><span class="fl">.002</span>, <span class="ot">&quot;pct95_sec&quot;</span><span class="ch">:0</span><span class="fl">.002</span>, <span class="ot">&quot;pct99_sec&quot;</span><span class="ch">:0</span><span class="fl">.002</span>} |</span>
<span id="cb466-9"><a href="#cb466-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------+--------------------------------------------------------------------------------------------------------+</span></span>
<span id="cb466-10"><a href="#cb466-10" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Note how that’s from the exact same instance, but 20 minutes later.
Earlier, we recorded our <code>query_time_1min</code> status immediately
after a few test queries. Those queries were accounted in
<code>1min</code> window back then. (For the record, yes, they were also
accounted in all the other windows back then.)</p>
<p>Then as time passed, and the instance sat completely idle for 20
minutes, query stats over the “recent N minutes” windows got reset.
Indeed, we had zero queries over the last 1, or 5, or 15 minutes. And
the respective windows confirm that.</p>
<p>However, the <code>query_time_total</code> window tracks everything
between restarts, as does the <code>found_rows_total</code> window.</p>
<div class="sourceCode" id="cb467"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb467-1"><a href="#cb467-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show <span class="kw">index</span> lj status <span class="kw">like</span> <span class="st">&#39;found%&#39;</span>;</span>
<span id="cb467-2"><a href="#cb467-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------+---------------------------------------------------------------------------+</span></span>
<span id="cb467-3"><a href="#cb467-3" aria-hidden="true" tabindex="-1"></a>| Variable_name    | <span class="fu">Value</span>                                                                     |</span>
<span id="cb467-4"><a href="#cb467-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------+---------------------------------------------------------------------------+</span></span>
<span id="cb467-5"><a href="#cb467-5" aria-hidden="true" tabindex="-1"></a>| found_rows_1min  | {<span class="ot">&quot;queries&quot;</span><span class="ch">:0</span>, <span class="ot">&quot;avg&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;min&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;max&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;pct95&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;pct99&quot;</span>:<span class="ot">&quot;-&quot;</span>}  |</span>
<span id="cb467-6"><a href="#cb467-6" aria-hidden="true" tabindex="-1"></a>| found_rows_5min  | {<span class="ot">&quot;queries&quot;</span><span class="ch">:0</span>, <span class="ot">&quot;avg&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;min&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;max&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;pct95&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;pct99&quot;</span>:<span class="ot">&quot;-&quot;</span>}  |</span>
<span id="cb467-7"><a href="#cb467-7" aria-hidden="true" tabindex="-1"></a>| found_rows_15min | {<span class="ot">&quot;queries&quot;</span><span class="ch">:0</span>, <span class="ot">&quot;avg&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;min&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;max&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;pct95&quot;</span>:<span class="ot">&quot;-&quot;</span>, <span class="ot">&quot;pct99&quot;</span>:<span class="ot">&quot;-&quot;</span>}  |</span>
<span id="cb467-8"><a href="#cb467-8" aria-hidden="true" tabindex="-1"></a>| found_rows_total | {<span class="ot">&quot;queries&quot;</span><span class="ch">:3</span>, <span class="ot">&quot;avg&quot;</span><span class="ch">:478</span>, <span class="ot">&quot;min&quot;</span><span class="ch">:3</span>, <span class="ot">&quot;max&quot;</span><span class="ch">:1422</span>, <span class="ot">&quot;pct95&quot;</span><span class="ch">:1422</span>, <span class="ot">&quot;pct99&quot;</span><span class="ch">:1422</span>} |</span>
<span id="cb467-9"><a href="#cb467-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------+---------------------------------------------------------------------------+</span></span>
<span id="cb467-10"><a href="#cb467-10" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>So those 3 initial queries from 20 mins ago are still accounted
for.</p>
<h3 id="show-index-segment-status-syntax">SHOW INDEX SEGMENT STATUS
syntax</h3>
<div class="sourceCode" id="cb468"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb468-1"><a href="#cb468-1" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">INDEX</span> <span class="op">&lt;</span>ftindex<span class="op">&gt;</span> <span class="kw">SEGMENT</span> STATUS</span></code></pre></div>
<p>Displays per-segment counters of total and “alive” (ie. non-deleted)
rows for the given index, and the alive rows percentage (for
convenience). This statement supports distributed, plain, and RT
indexes.</p>
<div class="sourceCode" id="cb469"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb469-1"><a href="#cb469-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show <span class="kw">index</span> test1 <span class="kw">segment</span> status;</span>
<span id="cb469-2"><a href="#cb469-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------+---------+------------+------------+-----------+</span></span>
<span id="cb469-3"><a href="#cb469-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">Index</span> | <span class="kw">Segment</span> | Total_rows | Alive_rows | Alive_pct |</span>
<span id="cb469-4"><a href="#cb469-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------+---------+------------+------------+-----------+</span></span>
<span id="cb469-5"><a href="#cb469-5" aria-hidden="true" tabindex="-1"></a>| test1 | <span class="dv">0</span>       | <span class="dv">1899</span>       | <span class="dv">1899</span>       | <span class="fl">100.00</span>    |</span>
<span id="cb469-6"><a href="#cb469-6" aria-hidden="true" tabindex="-1"></a>| test1 | <span class="dv">1</span>       | <span class="dv">1899</span>       | <span class="dv">1899</span>       | <span class="fl">100.00</span>    |</span>
<span id="cb469-7"><a href="#cb469-7" aria-hidden="true" tabindex="-1"></a>| test1 | RAM     | <span class="dv">0</span>          | <span class="dv">0</span>          | <span class="fl">0.00</span>      |</span>
<span id="cb469-8"><a href="#cb469-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------+---------+------------+------------+-----------+</span></span></code></pre></div>
<p>For RT and plain indexes, we display per-disk-segment counters, and
aggregate all RAM segments into a single entry. (And a plain index
effectively <strong>is</strong> just a single disk segment.)</p>
<p>For distributed indexes, we currently support indexes
<em>without</em> remote indexes only, and combine the counters from all
their participating local indexes.</p>
<h3 id="show-meta-syntax">SHOW META syntax</h3>
<div class="sourceCode" id="cb470"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb470-1"><a href="#cb470-1" aria-hidden="true" tabindex="-1"></a>SHOW META [<span class="kw">LIKE</span> <span class="st">&#39;&lt;mask&gt;&#39;</span>] [IGNORE <span class="st">&#39;&lt;mask&gt;&#39;</span>]</span></code></pre></div>
<p>This statement shows additional metadata about the most recent query
(that was issued on the current connection), such as wall query time,
keyword statistics, and a few other useful counters.</p>
<p>Many of the reported rows are conditional. For instance, empty error
or warning messages do not get reported. Per-query IO and CPU counters
are only reported when <code>searchd</code> was started with
<code>--iostats</code> and <code>--cpustats</code> switches. Counters
related to predicted query time are only reported when
<code>max_predicted_time</code> option was used in the query. And so
on.</p>
<div class="sourceCode" id="cb471"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb471-1"><a href="#cb471-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test1 <span class="kw">WHERE</span> MATCH(<span class="st">&#39;test|one|two&#39;</span>);</span>
<span id="cb471-2"><a href="#cb471-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------+----------+------------+</span></span>
<span id="cb471-3"><a href="#cb471-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | weight | <span class="fu">group_id</span> | date_added |</span>
<span id="cb471-4"><a href="#cb471-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------+----------+------------+</span></span>
<span id="cb471-5"><a href="#cb471-5" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> |   <span class="dv">3563</span> |      <span class="dv">456</span> | <span class="dv">1231721236</span> |</span>
<span id="cb471-6"><a href="#cb471-6" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> |   <span class="dv">2563</span> |      <span class="dv">123</span> | <span class="dv">1231721236</span> |</span>
<span id="cb471-7"><a href="#cb471-7" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">4</span> |   <span class="dv">1480</span> |        <span class="dv">2</span> | <span class="dv">1231721236</span> |</span>
<span id="cb471-8"><a href="#cb471-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------+----------+------------+</span></span>
<span id="cb471-9"><a href="#cb471-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.01</span> sec)</span>
<span id="cb471-10"><a href="#cb471-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb471-11"><a href="#cb471-11" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW META;</span>
<span id="cb471-12"><a href="#cb471-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------------+---------------------+</span></span>
<span id="cb471-13"><a href="#cb471-13" aria-hidden="true" tabindex="-1"></a>| Variable_name         | <span class="fu">Value</span>               |</span>
<span id="cb471-14"><a href="#cb471-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------------+---------------------+</span></span>
<span id="cb471-15"><a href="#cb471-15" aria-hidden="true" tabindex="-1"></a>| total                 | <span class="dv">3</span>                   |</span>
<span id="cb471-16"><a href="#cb471-16" aria-hidden="true" tabindex="-1"></a>| total_found           | <span class="dv">3</span>                   |</span>
<span id="cb471-17"><a href="#cb471-17" aria-hidden="true" tabindex="-1"></a>| <span class="dt">time</span>                  | <span class="fl">0.005</span>               |</span>
<span id="cb471-18"><a href="#cb471-18" aria-hidden="true" tabindex="-1"></a>| cpu_time              | <span class="fl">0.350</span>               |</span>
<span id="cb471-19"><a href="#cb471-19" aria-hidden="true" tabindex="-1"></a>| agents_cpu_time       | <span class="fl">0.000</span>               |</span>
<span id="cb471-20"><a href="#cb471-20" aria-hidden="true" tabindex="-1"></a>| keyword[<span class="dv">0</span>]            | test                |</span>
<span id="cb471-21"><a href="#cb471-21" aria-hidden="true" tabindex="-1"></a>| docs[<span class="dv">0</span>]               | <span class="dv">3</span>                   |</span>
<span id="cb471-22"><a href="#cb471-22" aria-hidden="true" tabindex="-1"></a>| hits[<span class="dv">0</span>]               | <span class="dv">5</span>                   |</span>
<span id="cb471-23"><a href="#cb471-23" aria-hidden="true" tabindex="-1"></a>| keyword[<span class="dv">1</span>]            | one                 |</span>
<span id="cb471-24"><a href="#cb471-24" aria-hidden="true" tabindex="-1"></a>| docs[<span class="dv">1</span>]               | <span class="dv">1</span>                   |</span>
<span id="cb471-25"><a href="#cb471-25" aria-hidden="true" tabindex="-1"></a>| hits[<span class="dv">1</span>]               | <span class="dv">2</span>                   |</span>
<span id="cb471-26"><a href="#cb471-26" aria-hidden="true" tabindex="-1"></a>| keyword[<span class="dv">2</span>]            | two                 |</span>
<span id="cb471-27"><a href="#cb471-27" aria-hidden="true" tabindex="-1"></a>| docs[<span class="dv">2</span>]               | <span class="dv">1</span>                   |</span>
<span id="cb471-28"><a href="#cb471-28" aria-hidden="true" tabindex="-1"></a>| hits[<span class="dv">2</span>]               | <span class="dv">2</span>                   |</span>
<span id="cb471-29"><a href="#cb471-29" aria-hidden="true" tabindex="-1"></a>| slug                  | hostname1,hostname2 |</span>
<span id="cb471-30"><a href="#cb471-30" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------------+---------------------+</span></span>
<span id="cb471-31"><a href="#cb471-31" aria-hidden="true" tabindex="-1"></a><span class="dv">15</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>The available counters include the following. (This list is
<strong>not</strong> yet checked automatically, and might be
incomplete.)</p>
<table>
<colgroup>
<col style="width: 30%" />
<col style="width: 70%" />
</colgroup>
<thead>
<tr class="header">
<th>Counter</th>
<th>Short description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>agent_response_bytes</code></td>
<td>Total bytes that master received over network</td>
</tr>
<tr class="even">
<td><code>agents_cpu_time</code></td>
<td>Total CPU time that agents spent on the query, in msec</td>
</tr>
<tr class="odd">
<td><code>batch_size</code></td>
<td>Facets and/or multi-queries execution batch size</td>
</tr>
<tr class="even">
<td><code>cpu_time</code></td>
<td>CPU time spent on the query, in msec</td>
</tr>
<tr class="odd">
<td><code>cutoff_reached</code></td>
<td>Whether the <code>cutoff</code> threshold was reached</td>
</tr>
<tr class="even">
<td><code>dist_fetched_docs</code></td>
<td>Total (agents + master) <code>fetched_docs</code> counter</td>
</tr>
<tr class="odd">
<td><code>dist_fetched_fields</code></td>
<td>Total (agents + master) <code>fetched_fields</code> counter</td>
</tr>
<tr class="even">
<td><code>dist_fetched_hits</code></td>
<td>Total (agents + master) <code>fetched_hits</code> counter</td>
</tr>
<tr class="odd">
<td><code>dist_fetched_skips</code></td>
<td>Total (agents + master) <code>fetched_skips</code> counter</td>
</tr>
<tr class="even">
<td><code>dist_predicted_time</code></td>
<td>Agent-only <code>predicted_time</code> counter</td>
</tr>
<tr class="odd">
<td><code>docs[&lt;N&gt;]</code></td>
<td>Number of documents matched by the N-th keyword</td>
</tr>
<tr class="even">
<td><code>error</code></td>
<td>Error message, if any</td>
</tr>
<tr class="odd">
<td><code>hits[&lt;N&gt;]</code></td>
<td>Number of postings for the N-th keyword</td>
</tr>
<tr class="even">
<td><code>keyword[&lt;N&gt;]</code></td>
<td>N-th keyword</td>
</tr>
<tr class="odd">
<td><code>local_fetched_docs</code></td>
<td>Local <code>fetched_docs</code> counter</td>
</tr>
<tr class="even">
<td><code>local_fetched_fields</code></td>
<td>Local <code>fetched_fields</code> counter</td>
</tr>
<tr class="odd">
<td><code>local_fetched_hits</code></td>
<td>Local <code>fetched_hits</code> counter</td>
</tr>
<tr class="even">
<td><code>local_fetched_skips</code></td>
<td>Local <code>fetched_skips</code> counter</td>
</tr>
<tr class="odd">
<td><code>predicted_time</code></td>
<td>Local <code>predicted_time</code> counter</td>
</tr>
<tr class="even">
<td><code>slug</code></td>
<td>A list of <code>meta_slug</code> from all agents</td>
</tr>
<tr class="odd">
<td><code>time</code></td>
<td>Total query time, in sec</td>
</tr>
<tr class="even">
<td><code>total_found</code></td>
<td>Total matches found</td>
</tr>
<tr class="odd">
<td><code>total</code></td>
<td>Total matches returned (adjusted for <code>LIMIT</code>)</td>
</tr>
<tr class="even">
<td><code>warning</code></td>
<td>Warning message, if any</td>
</tr>
</tbody>
</table>
<p>Optional <code>LIKE</code> and <code>IGNORE</code> clauses can help
filter results, see <a href="#like-and-ignore-clause">“LIKE and IGNORE
clause”</a> for details.</p>
<h3 id="show-optimize-status-syntax">SHOW OPTIMIZE STATUS syntax</h3>
<div class="sourceCode" id="cb472"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb472-1"><a href="#cb472-1" aria-hidden="true" tabindex="-1"></a>SHOW OPTIMIZE STATUS [<span class="kw">LIKE</span> <span class="st">&#39;&lt;mask&gt;&#39;</span>] [IGNORE <span class="st">&#39;&lt;mask&gt;&#39;</span>]</span></code></pre></div>
<p>This statement shows the status of current full-text index
<code>OPTIMIZE</code> requests queue, in a human-readable format, as
follows.</p>
<div class="sourceCode" id="cb473"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb473-1"><a href="#cb473-1" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------+-------------------------------------------------------------------+</span></span>
<span id="cb473-2"><a href="#cb473-2" aria-hidden="true" tabindex="-1"></a>| Variable_name      | <span class="fu">Value</span>                                                             |</span>
<span id="cb473-3"><a href="#cb473-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------+-------------------------------------------------------------------+</span></span>
<span id="cb473-4"><a href="#cb473-4" aria-hidden="true" tabindex="-1"></a>| index_1_name       | rt2                                                               |</span>
<span id="cb473-5"><a href="#cb473-5" aria-hidden="true" tabindex="-1"></a>| index_1_start      | <span class="dv">2023</span><span class="op">-</span><span class="dv">07</span><span class="op">-</span><span class="dv">06</span> <span class="dv">23</span><span class="ch">:35:55</span>                                               |</span>
<span id="cb473-6"><a href="#cb473-6" aria-hidden="true" tabindex="-1"></a>| index_1_progress   | <span class="dv">0</span> <span class="kw">of</span> <span class="dv">2</span> disk segments done, merged <span class="kw">to</span> <span class="fl">0.0</span> Kb, <span class="fl">1.0</span> Kb <span class="kw">left</span> <span class="kw">to</span> <span class="kw">merge</span> |</span>
<span id="cb473-7"><a href="#cb473-7" aria-hidden="true" tabindex="-1"></a>| total_in_progress  | <span class="dv">1</span>                                                                 |</span>
<span id="cb473-8"><a href="#cb473-8" aria-hidden="true" tabindex="-1"></a>| total_queue_length | <span class="dv">0</span>                                                                 |</span>
<span id="cb473-9"><a href="#cb473-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------+-------------------------------------------------------------------+</span></span>
<span id="cb473-10"><a href="#cb473-10" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Optional <code>LIKE</code> and <code>IGNORE</code> clauses can help
filter results, see <a href="#like-and-ignore-clause">“LIKE and IGNORE
clause”</a> for details.</p>
<h3 id="show-profile-syntax">SHOW PROFILE syntax</h3>
<div class="sourceCode" id="cb474"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb474-1"><a href="#cb474-1" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">PROFILE</span> [<span class="kw">LIKE</span> <span class="st">&#39;&lt;mask&gt;&#39;</span>] [IGNORE <span class="st">&#39;&lt;mask&gt;&#39;</span>]</span></code></pre></div>
<p><code>SHOW PROFILE</code> statement shows a detailed execution
profile for the most recent (profiled) SQL statement in the current
SphinxQL session.</p>
<p>You <strong>must</strong> explicitly enable profiling first, by
running a <code>SET profiling=1</code> statement. Profiles are disabled
by default to avoid any performance impact.</p>
<p>Optional <code>LIKE</code> and <code>IGNORE</code> clauses can help
filter results, see <a href="#like-and-ignore-clause">“LIKE and IGNORE
clause”</a> for details.</p>
<p>Profiles should work on distributed indexes too, and aggregate the
timings across all the agents.</p>
<p>Here’s a complete instrumentation example.</p>
<div class="sourceCode" id="cb475"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb475-1"><a href="#cb475-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SET</span> profiling<span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb475-2"><a href="#cb475-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb475-3"><a href="#cb475-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb475-4"><a href="#cb475-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> lj <span class="kw">WHERE</span> MATCH(<span class="st">&#39;the test&#39;</span>) <span class="kw">LIMIT</span> <span class="dv">1</span>;</span>
<span id="cb475-5"><a href="#cb475-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------+</span></span>
<span id="cb475-6"><a href="#cb475-6" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>     |</span>
<span id="cb475-7"><a href="#cb475-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------+</span></span>
<span id="cb475-8"><a href="#cb475-8" aria-hidden="true" tabindex="-1"></a>| <span class="dv">946418</span> |</span>
<span id="cb475-9"><a href="#cb475-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------+</span></span>
<span id="cb475-10"><a href="#cb475-10" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.03</span> sec)</span>
<span id="cb475-11"><a href="#cb475-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb475-12"><a href="#cb475-12" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW <span class="kw">PROFILE</span>;</span>
<span id="cb475-13"><a href="#cb475-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------+----------+----------+---------+</span></span>
<span id="cb475-14"><a href="#cb475-14" aria-hidden="true" tabindex="-1"></a>| Status       | Duration | Switches | <span class="kw">Percent</span> |</span>
<span id="cb475-15"><a href="#cb475-15" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------+----------+----------+---------+</span></span>
<span id="cb475-16"><a href="#cb475-16" aria-hidden="true" tabindex="-1"></a>| unknown      | <span class="fl">0.000278</span> | <span class="dv">6</span>        | <span class="fl">0.55</span>    |</span>
<span id="cb475-17"><a href="#cb475-17" aria-hidden="true" tabindex="-1"></a>| local_search | <span class="fl">0.025201</span> | <span class="dv">1</span>        | <span class="fl">49.83</span>   |</span>
<span id="cb475-18"><a href="#cb475-18" aria-hidden="true" tabindex="-1"></a>| sql_parse    | <span class="fl">0.000041</span> | <span class="dv">1</span>        | <span class="fl">0.08</span>    |</span>
<span id="cb475-19"><a href="#cb475-19" aria-hidden="true" tabindex="-1"></a>| dict_setup   | <span class="fl">0.000000</span> | <span class="dv">1</span>        | <span class="fl">0.00</span>    |</span>
<span id="cb475-20"><a href="#cb475-20" aria-hidden="true" tabindex="-1"></a>| parse        | <span class="fl">0.000049</span> | <span class="dv">1</span>        | <span class="fl">0.10</span>    |</span>
<span id="cb475-21"><a href="#cb475-21" aria-hidden="true" tabindex="-1"></a>| transforms   | <span class="fl">0.000005</span> | <span class="dv">1</span>        | <span class="fl">0.01</span>    |</span>
<span id="cb475-22"><a href="#cb475-22" aria-hidden="true" tabindex="-1"></a>| init         | <span class="fl">0.000242</span> | <span class="dv">2</span>        | <span class="fl">0.48</span>    |</span>
<span id="cb475-23"><a href="#cb475-23" aria-hidden="true" tabindex="-1"></a>| read_docs    | <span class="fl">0.000315</span> | <span class="dv">2</span>        | <span class="fl">0.62</span>    |</span>
<span id="cb475-24"><a href="#cb475-24" aria-hidden="true" tabindex="-1"></a>| read_hits    | <span class="fl">0.000080</span> | <span class="dv">2</span>        | <span class="fl">0.16</span>    |</span>
<span id="cb475-25"><a href="#cb475-25" aria-hidden="true" tabindex="-1"></a>| get_docs     | <span class="fl">0.014230</span> | <span class="dv">1954</span>     | <span class="fl">28.14</span>   |</span>
<span id="cb475-26"><a href="#cb475-26" aria-hidden="true" tabindex="-1"></a>| get_hits     | <span class="fl">0.007491</span> | <span class="dv">1352</span>     | <span class="fl">14.81</span>   |</span>
<span id="cb475-27"><a href="#cb475-27" aria-hidden="true" tabindex="-1"></a>| <span class="kw">filter</span>       | <span class="fl">0.000263</span> | <span class="dv">904</span>      | <span class="fl">0.52</span>    |</span>
<span id="cb475-28"><a href="#cb475-28" aria-hidden="true" tabindex="-1"></a>| <span class="fu">rank</span>         | <span class="fl">0.002076</span> | <span class="dv">2687</span>     | <span class="fl">4.11</span>    |</span>
<span id="cb475-29"><a href="#cb475-29" aria-hidden="true" tabindex="-1"></a>| <span class="kw">sort</span>         | <span class="fl">0.000283</span> | <span class="dv">219</span>      | <span class="fl">0.56</span>    |</span>
<span id="cb475-30"><a href="#cb475-30" aria-hidden="true" tabindex="-1"></a>| finalize     | <span class="fl">0.000000</span> | <span class="dv">1</span>        | <span class="fl">0.00</span>    |</span>
<span id="cb475-31"><a href="#cb475-31" aria-hidden="true" tabindex="-1"></a>| aggregate    | <span class="fl">0.000018</span> | <span class="dv">2</span>        | <span class="fl">0.04</span>    |</span>
<span id="cb475-32"><a href="#cb475-32" aria-hidden="true" tabindex="-1"></a>| eval_post    | <span class="fl">0.000000</span> | <span class="dv">1</span>        | <span class="fl">0.00</span>    |</span>
<span id="cb475-33"><a href="#cb475-33" aria-hidden="true" tabindex="-1"></a>| total        | <span class="fl">0.050572</span> | <span class="dv">7137</span>     | <span class="dv">0</span>       |</span>
<span id="cb475-34"><a href="#cb475-34" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------+----------+----------+---------+</span></span>
<span id="cb475-35"><a href="#cb475-35" aria-hidden="true" tabindex="-1"></a><span class="dv">18</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb475-36"><a href="#cb475-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb475-37"><a href="#cb475-37" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show <span class="kw">profile</span> <span class="kw">like</span> <span class="st">&#39;read_%&#39;</span>;</span>
<span id="cb475-38"><a href="#cb475-38" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+----------+----------+---------+</span></span>
<span id="cb475-39"><a href="#cb475-39" aria-hidden="true" tabindex="-1"></a>| Status    | Duration | Switches | <span class="kw">Percent</span> |</span>
<span id="cb475-40"><a href="#cb475-40" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+----------+----------+---------+</span></span>
<span id="cb475-41"><a href="#cb475-41" aria-hidden="true" tabindex="-1"></a>| read_docs | <span class="fl">0.000315</span> | <span class="dv">2</span>        | <span class="fl">0.62</span>    |</span>
<span id="cb475-42"><a href="#cb475-42" aria-hidden="true" tabindex="-1"></a>| read_hits | <span class="fl">0.000080</span> | <span class="dv">2</span>        | <span class="fl">0.16</span>    |</span>
<span id="cb475-43"><a href="#cb475-43" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+----------+----------+---------+</span></span>
<span id="cb475-44"><a href="#cb475-44" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>“Status” column briefly describes how exactly (in which execution
state) was the time spent.</p>
<p>“Duration” column shows the total wall clock time taken (by the
respective state), in seconds.</p>
<p>“Switches” column shows how many times the engine switched to this
state. Those are just logical engine state switches and <em>not</em> any
OS level context switches nor even function calls. So they do not
necessarily have any direct effect on the performance, and having lots
of switches (thousands or even millions) is not really an issue per se.
Because, essentially, this is just a number of times when the respective
instrumentation point was hit.</p>
<p>“Percent” column shows the relative state duration, as percentage of
the total time profiled.</p>
<p>At the moment, the profile states are returned in a certain
prerecorded order that roughly maps (but is not completely identical) to
the actual query order.</p>
<p>A list of states varies over time, as we refine it. Here’s a brief
description of the current profile states.</p>
<table>
<colgroup>
<col style="width: 15%" />
<col style="width: 84%" />
</colgroup>
<thead>
<tr class="header">
<th>State</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>aggregate</td>
<td>aggregating multiple result sets</td>
</tr>
<tr class="even">
<td>dict_setup</td>
<td>setting up the dictionary and tokenizer</td>
</tr>
<tr class="odd">
<td>dist_connect</td>
<td>distributed index connecting to remote agents</td>
</tr>
<tr class="even">
<td>dist_wait</td>
<td>distributed index waiting for remote agents results</td>
</tr>
<tr class="odd">
<td>eval_post</td>
<td>evaluating special post-LIMIT expressions (except snippets)</td>
</tr>
<tr class="even">
<td>eval_snippet</td>
<td>evaluating snippets</td>
</tr>
<tr class="odd">
<td>eval_udf</td>
<td>evaluating UDFs</td>
</tr>
<tr class="even">
<td>filter</td>
<td>filtering the full-text matches</td>
</tr>
<tr class="odd">
<td>finalize</td>
<td>finalizing the per-index search result set (last stage expressions,
etc)</td>
</tr>
<tr class="even">
<td>fullscan</td>
<td>executing the “fullscan” (more formally, non-full-text) search</td>
</tr>
<tr class="odd">
<td>get_docs</td>
<td>computing the matching documents</td>
</tr>
<tr class="even">
<td>get_hits</td>
<td>computing the matching positions</td>
</tr>
<tr class="odd">
<td>init</td>
<td>setting up the query evaluation in general</td>
</tr>
<tr class="even">
<td>init_attr</td>
<td>setting up attribute index(-es) usage</td>
</tr>
<tr class="odd">
<td>init_segment</td>
<td>setting up RT segments</td>
</tr>
<tr class="even">
<td>io</td>
<td>generic file IO time (deprecated)</td>
</tr>
<tr class="odd">
<td>local_df</td>
<td>setting up <code>local_df</code> values, aka the “sharded” IDFs</td>
</tr>
<tr class="even">
<td>local_search</td>
<td>executing local query (for distributed and sharded cases)</td>
</tr>
<tr class="odd">
<td>net_read</td>
<td>network reads (usually from the client application)</td>
</tr>
<tr class="even">
<td>net_write</td>
<td>network writes (usually to the client application)</td>
</tr>
<tr class="odd">
<td>open</td>
<td>opening the index files</td>
</tr>
<tr class="even">
<td>parse</td>
<td>parsing the full-text query syntax</td>
</tr>
<tr class="odd">
<td>rank</td>
<td>computing the ranking signals and/or the relevance rank</td>
</tr>
<tr class="even">
<td>read_docs</td>
<td>disk IO time spent reading document lists</td>
</tr>
<tr class="odd">
<td>read_hits</td>
<td>disk IO time spent reading keyword positions</td>
</tr>
<tr class="even">
<td>sort</td>
<td>sorting the matches</td>
</tr>
<tr class="odd">
<td>sql_parse</td>
<td>parsing the SphinxQL syntax</td>
</tr>
<tr class="even">
<td>table_func</td>
<td>processing table functions</td>
</tr>
<tr class="odd">
<td>transforms</td>
<td>full-text query transformations (wildcard expansions,
simplification, etc)</td>
</tr>
<tr class="even">
<td>unknown</td>
<td>generic catch-all state: not-yet-profiled code plus misc “too small”
things</td>
</tr>
</tbody>
</table>
<p>The final entry is always “total” and it reports the sums of all the
profiled durations and switches respectively. Percentage is
intentionally reported as 0 rather than 100 because “total” is not a
real execution state.</p>
<h3 id="show-replicas-syntax">SHOW REPLICAS syntax</h3>
<div class="sourceCode" id="cb476"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb476-1"><a href="#cb476-1" aria-hidden="true" tabindex="-1"></a>SHOW REPLICAS</span></code></pre></div>
<p><code>SHOW REPLICAS</code> displays the replica side status of all
the replicated indexes.</p>
<div class="sourceCode" id="cb477"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb477-1"><a href="#cb477-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show replicas;</span>
<span id="cb477-2"><a href="#cb477-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------------------+----------------+-----+------------------+-----------+----------------+------------+-------+----------+</span></span>
<span id="cb477-3"><a href="#cb477-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">index</span>                      | host           | tid | state            | <span class="fu">lag</span>       | download       | uptime     | error | manifest |</span>
<span id="cb477-4"><a href="#cb477-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------------------+----------------+-----+------------------+-----------+----------------+------------+-------+----------+</span></span>
<span id="cb477-5"><a href="#cb477-5" aria-hidden="true" tabindex="-1"></a>| 512494f3<span class="op">-</span>c3a772e8<span class="ch">:rt_attr</span>  | <span class="dv">127</span>.<span class="dv">0</span>.<span class="fl">0.1</span><span class="ch">:7000</span> | <span class="dv">0</span>   | IDLE             | <span class="dv">150</span> msec  | <span class="op">-/-</span>            | <span class="kw">offline</span>    | <span class="op">-</span>     | {}       |</span>
<span id="cb477-6"><a href="#cb477-6" aria-hidden="true" tabindex="-1"></a>| 512494f3<span class="op">-</span>c3a772e8<span class="ch">:rt_test</span>  | <span class="dv">127</span>.<span class="dv">0</span>.<span class="fl">0.1</span><span class="ch">:7000</span> | <span class="dv">4</span>   | IDLE             | <span class="dv">151</span> msec  | <span class="op">-/-</span>            | 0h<span class="ch">:03m:23s</span> | <span class="op">-</span>     | {}       |</span>
<span id="cb477-7"><a href="#cb477-7" aria-hidden="true" tabindex="-1"></a>| 512494f3<span class="op">-</span>c3a772e8<span class="ch">:rt_test2</span> | <span class="dv">127</span>.<span class="dv">0</span>.<span class="fl">0.1</span><span class="ch">:7000</span> | <span class="dv">6</span>   | <span class="kw">JOIN</span> REQUESTING  | <span class="dv">2268</span> msec | <span class="fl">5.1</span> Mb<span class="op">/</span><span class="fl">23.1</span> Mb | 1h<span class="ch">:20m:00s</span> | <span class="op">-</span>     | {}       |</span>
<span id="cb477-8"><a href="#cb477-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------------------+----------------+-----+------------------+-----------+--------------- +------------+-------+----------+</span></span>
<span id="cb477-9"><a href="#cb477-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Refer to <a href="#using-replication">“Using replication”</a> for
details.</p>
<h3 id="show-status-syntax">SHOW STATUS syntax</h3>
<div class="sourceCode" id="cb478"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb478-1"><a href="#cb478-1" aria-hidden="true" tabindex="-1"></a>SHOW [INTERNAL] STATUS [<span class="kw">LIKE</span> <span class="st">&#39;&lt;mask&gt;&#39;</span>] [IGNORE <span class="st">&#39;&lt;mask&gt;&#39;</span>]</span></code></pre></div>
<p><code>SHOW STATUS</code> displays a number of useful server-wide
performance and statistics counters. Those are (briefly) documented just
below, and should be generally useful for health checks, monitoring,
etc.</p>
<p>In <code>SHOW INTERNAL STATUS</code> mode, however, it only displays
a few currently experimental internal counters. Those counters might or
might not later make it into GA releases, and are intentionally
<strong>not</strong> documented here.</p>
<p>All the aggregate counters (ie. total this, average that) are since
startup.</p>
<p>Several IO and CPU counters are only available when you start
<code>searchd</code> with explicit <code>--iostats</code> and
<code>--cpustats</code> accounting switches, respectively. Those are not
enabled by default because of a measurable performance impact.</p>
<p>Zeroed out or disabled counters can be intentionally omitted from the
output, for brevity. For instance, if the server did not ever see any
<code>REPLACE</code> queries via SphinxQL, the respective
<code>sql_replace</code> counter will be omitted.</p>
<p>Optional <code>LIKE</code> and <code>IGNORE</code> clauses can help
filter results, see <a href="#like-and-ignore-clause">“LIKE and IGNORE
clause”</a> for details. For example:</p>
<div class="sourceCode" id="cb479"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb479-1"><a href="#cb479-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show status <span class="kw">like</span> <span class="st">&#39;local%&#39;</span>;</span>
<span id="cb479-2"><a href="#cb479-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+---------+</span></span>
<span id="cb479-3"><a href="#cb479-3" aria-hidden="true" tabindex="-1"></a>| Counter                | <span class="fu">Value</span>   |</span>
<span id="cb479-4"><a href="#cb479-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+---------+</span></span>
<span id="cb479-5"><a href="#cb479-5" aria-hidden="true" tabindex="-1"></a>| local_indexes          | <span class="dv">6</span>       |</span>
<span id="cb479-6"><a href="#cb479-6" aria-hidden="true" tabindex="-1"></a>| local_indexes_disabled | <span class="dv">5</span>       |</span>
<span id="cb479-7"><a href="#cb479-7" aria-hidden="true" tabindex="-1"></a>| local_docs             | <span class="dv">2866967</span> |</span>
<span id="cb479-8"><a href="#cb479-8" aria-hidden="true" tabindex="-1"></a>| local_disk_mb          | <span class="fl">2786.2</span>  |</span>
<span id="cb479-9"><a href="#cb479-9" aria-hidden="true" tabindex="-1"></a>| local_ram_mb           | <span class="fl">1522.0</span>  |</span>
<span id="cb479-10"><a href="#cb479-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+---------+</span></span>
<span id="cb479-11"><a href="#cb479-11" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Quick counters reference is as follows.</p>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 79%" />
</colgroup>
<thead>
<tr class="header">
<th>Counter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>agent_connect</td>
<td>Total remote agent connection attempts</td>
</tr>
<tr class="even">
<td>agent_retry</td>
<td>Total remote agent query retry attempts</td>
</tr>
<tr class="odd">
<td>auth_anons</td>
<td>Anonymous authentication successes (ie. with empty user name)</td>
</tr>
<tr class="even">
<td>auth_fails</td>
<td>Authentication failures</td>
</tr>
<tr class="odd">
<td>auth_passes</td>
<td>Authentication successes total (including anonymous)</td>
</tr>
<tr class="even">
<td>avg_dist_local</td>
<td>Average time spent querying local indexes in queries to distributed
indexes, in seconds</td>
</tr>
<tr class="odd">
<td>avg_dist_wait</td>
<td>Average time spent waiting for remote agents in queries to
distributed indexes, in seconds</td>
</tr>
<tr class="even">
<td>avg_dist_wall</td>
<td>Average overall time spent in queries to distributed indexes, in
seconds</td>
</tr>
<tr class="odd">
<td>avg_query_cpu</td>
<td>Average CPU time spent per query (as reported by OS; requires
<code>--cpustats</code>)</td>
</tr>
<tr class="even">
<td>avg_query_readkb</td>
<td>Average bytes read from disk per query, in KiB (KiB is 1024 bytes;
requires <code>--iostats</code>)</td>
</tr>
<tr class="odd">
<td>avg_query_reads</td>
<td>Average disk <code>read()</code> calls per query (requires
<code>--iostats</code>)</td>
</tr>
<tr class="even">
<td>avg_query_readtime</td>
<td>Average time per <code>read()</code> call, in seconds (requires
<code>--iostats</code>)</td>
</tr>
<tr class="odd">
<td>avg_query_wall</td>
<td>Average elapsed query time, in seconds</td>
</tr>
<tr class="even">
<td>command_XXX</td>
<td>Total number of SphinxAPI “XXX” commands (for example,
<code>command_search</code>)</td>
</tr>
<tr class="odd">
<td>connections</td>
<td>Total accepted network connections</td>
</tr>
<tr class="even">
<td>dist_local</td>
<td>Total time spent querying local indexes in queries to distributed
indexes, in seconds</td>
</tr>
<tr class="odd">
<td>dist_predicted_time</td>
<td>Total predicted query time (in msec) reported by remote agents</td>
</tr>
<tr class="even">
<td>dist_queries</td>
<td>Total queries to distributed indexes</td>
</tr>
<tr class="odd">
<td>dist_wait</td>
<td>Total time spent waiting for remote agents in queries to distributed
indexes, in seconds</td>
</tr>
<tr class="even">
<td>dist_wall</td>
<td>Total time spent in queries to distributed indexes, in seconds</td>
</tr>
<tr class="odd">
<td>killed_queries</td>
<td>Total queries that were auto-killed on client network failure</td>
</tr>
<tr class="even">
<td>local_disk_mb</td>
<td>Total disk use over all enabled local indexes, in MB (MB is 1
million bytes)</td>
</tr>
<tr class="odd">
<td>local_docs</td>
<td>Total document count over all enabled local indexes</td>
</tr>
<tr class="even">
<td>local_indexes</td>
<td>Total enabled local indexes (both plain and RT)</td>
</tr>
<tr class="odd">
<td>local_indexes_disabled</td>
<td>Total disabled local indexes</td>
</tr>
<tr class="even">
<td>local_ram_mb</td>
<td>Total RAM use over all enabled local indexes, in MB (MB is 1 million
bytes)</td>
</tr>
<tr class="odd">
<td>maxed_out</td>
<td>Total accepted network connections forcibly closed because the
server was maxed out</td>
</tr>
<tr class="even">
<td>predicted_time</td>
<td>Total predicted query time (in msec) report by local searches</td>
</tr>
<tr class="odd">
<td>qcache_cached_queries</td>
<td>Current number of queries stored in the query cache</td>
</tr>
<tr class="even">
<td>qcache_hits</td>
<td>Total number of query cache hits</td>
</tr>
<tr class="odd">
<td>qcache_used_bytes</td>
<td>Current query cache storage size, in bytes</td>
</tr>
<tr class="even">
<td>queries</td>
<td>Total number of search queries served (either via SphinxAPI or
SphinxQL)</td>
</tr>
<tr class="odd">
<td>query_cpu</td>
<td>Total CPU time spent on search queries, in seconds (as reported by
OS; requires <code>--cpustats</code>)</td>
</tr>
<tr class="even">
<td>query_readkb</td>
<td>Total bytes read from disk by queries, in KiB (KiB is 1024 bytes;
requires <code>--iostats</code>)</td>
</tr>
<tr class="odd">
<td>query_reads</td>
<td>Total disk <code>read()</code> calls by queries (requires
<code>--iostats</code>)</td>
</tr>
<tr class="even">
<td>query_readtime</td>
<td>Total time spend in <code>read()</code> call by queries, in seconds
(requires <code>--iostats</code>)</td>
</tr>
<tr class="odd">
<td>query_wall</td>
<td>Total elapsed search queries time, in seconds</td>
</tr>
<tr class="even">
<td>siege_sec_left</td>
<td>Current time left until “siege mode” auto-expires, in seconds</td>
</tr>
<tr class="odd">
<td>sql_XXX</td>
<td>Total number of SphinxQL “XXX” statements (for example,
<code>sql_select</code>)</td>
</tr>
<tr class="even">
<td>uptime</td>
<td>Uptime, in seconds</td>
</tr>
<tr class="odd">
<td>work_queue_length</td>
<td>Current thread pool work queue length (ie. number of jobs waiting
for workers)</td>
</tr>
<tr class="even">
<td>workers_active</td>
<td>Current number of active thread pool workers</td>
</tr>
<tr class="odd">
<td>workers_total</td>
<td>Total thread pool workers count</td>
</tr>
</tbody>
</table>
<p>Last but not least, here goes some example output, taken from v.3.4.
Beware, it’s a bit longish.</p>
<div class="sourceCode" id="cb480"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb480-1"><a href="#cb480-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW STATUS;</span>
<span id="cb480-2"><a href="#cb480-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+---------+</span></span>
<span id="cb480-3"><a href="#cb480-3" aria-hidden="true" tabindex="-1"></a>| Counter                | <span class="fu">Value</span>   |</span>
<span id="cb480-4"><a href="#cb480-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+---------+</span></span>
<span id="cb480-5"><a href="#cb480-5" aria-hidden="true" tabindex="-1"></a>| uptime                 | <span class="dv">25</span>      |</span>
<span id="cb480-6"><a href="#cb480-6" aria-hidden="true" tabindex="-1"></a>| connections            | <span class="dv">1</span>       |</span>
<span id="cb480-7"><a href="#cb480-7" aria-hidden="true" tabindex="-1"></a>| maxed_out              | <span class="dv">0</span>       |</span>
<span id="cb480-8"><a href="#cb480-8" aria-hidden="true" tabindex="-1"></a>| command_search         | <span class="dv">0</span>       |</span>
<span id="cb480-9"><a href="#cb480-9" aria-hidden="true" tabindex="-1"></a>| command_snippet        | <span class="dv">0</span>       |</span>
<span id="cb480-10"><a href="#cb480-10" aria-hidden="true" tabindex="-1"></a>| command_update         | <span class="dv">0</span>       |</span>
<span id="cb480-11"><a href="#cb480-11" aria-hidden="true" tabindex="-1"></a>| command_delete         | <span class="dv">0</span>       |</span>
<span id="cb480-12"><a href="#cb480-12" aria-hidden="true" tabindex="-1"></a>| command_keywords       | <span class="dv">0</span>       |</span>
<span id="cb480-13"><a href="#cb480-13" aria-hidden="true" tabindex="-1"></a>| command_persist        | <span class="dv">0</span>       |</span>
<span id="cb480-14"><a href="#cb480-14" aria-hidden="true" tabindex="-1"></a>| command_status         | <span class="dv">3</span>       |</span>
<span id="cb480-15"><a href="#cb480-15" aria-hidden="true" tabindex="-1"></a>| command_flushattrs     | <span class="dv">0</span>       |</span>
<span id="cb480-16"><a href="#cb480-16" aria-hidden="true" tabindex="-1"></a>| agent_connect          | <span class="dv">0</span>       |</span>
<span id="cb480-17"><a href="#cb480-17" aria-hidden="true" tabindex="-1"></a>| agent_retry            | <span class="dv">0</span>       |</span>
<span id="cb480-18"><a href="#cb480-18" aria-hidden="true" tabindex="-1"></a>| queries                | <span class="dv">0</span>       |</span>
<span id="cb480-19"><a href="#cb480-19" aria-hidden="true" tabindex="-1"></a>| dist_queries           | <span class="dv">0</span>       |</span>
<span id="cb480-20"><a href="#cb480-20" aria-hidden="true" tabindex="-1"></a>| killed_queries         | <span class="dv">0</span>       |</span>
<span id="cb480-21"><a href="#cb480-21" aria-hidden="true" tabindex="-1"></a>| workers_total          | <span class="dv">20</span>      |</span>
<span id="cb480-22"><a href="#cb480-22" aria-hidden="true" tabindex="-1"></a>| workers_active         | <span class="dv">1</span>       |</span>
<span id="cb480-23"><a href="#cb480-23" aria-hidden="true" tabindex="-1"></a>| work_queue_length      | <span class="dv">0</span>       |</span>
<span id="cb480-24"><a href="#cb480-24" aria-hidden="true" tabindex="-1"></a>| query_wall             | <span class="fl">0.000</span>   |</span>
<span id="cb480-25"><a href="#cb480-25" aria-hidden="true" tabindex="-1"></a>| query_cpu              | <span class="kw">OFF</span>     |</span>
<span id="cb480-26"><a href="#cb480-26" aria-hidden="true" tabindex="-1"></a>| dist_wall              | <span class="fl">0.000</span>   |</span>
<span id="cb480-27"><a href="#cb480-27" aria-hidden="true" tabindex="-1"></a>| dist_local             | <span class="fl">0.000</span>   |</span>
<span id="cb480-28"><a href="#cb480-28" aria-hidden="true" tabindex="-1"></a>| dist_wait              | <span class="fl">0.000</span>   |</span>
<span id="cb480-29"><a href="#cb480-29" aria-hidden="true" tabindex="-1"></a>| query_reads            | <span class="kw">OFF</span>     |</span>
<span id="cb480-30"><a href="#cb480-30" aria-hidden="true" tabindex="-1"></a>| query_readkb           | <span class="kw">OFF</span>     |</span>
<span id="cb480-31"><a href="#cb480-31" aria-hidden="true" tabindex="-1"></a>| query_readtime         | <span class="kw">OFF</span>     |</span>
<span id="cb480-32"><a href="#cb480-32" aria-hidden="true" tabindex="-1"></a>| avg_query_wall         | <span class="fl">0.000</span>   |</span>
<span id="cb480-33"><a href="#cb480-33" aria-hidden="true" tabindex="-1"></a>| avg_query_cpu          | <span class="kw">OFF</span>     |</span>
<span id="cb480-34"><a href="#cb480-34" aria-hidden="true" tabindex="-1"></a>| avg_dist_wall          | <span class="fl">0.000</span>   |</span>
<span id="cb480-35"><a href="#cb480-35" aria-hidden="true" tabindex="-1"></a>| avg_dist_local         | <span class="fl">0.000</span>   |</span>
<span id="cb480-36"><a href="#cb480-36" aria-hidden="true" tabindex="-1"></a>| avg_dist_wait          | <span class="fl">0.000</span>   |</span>
<span id="cb480-37"><a href="#cb480-37" aria-hidden="true" tabindex="-1"></a>| avg_query_reads        | <span class="kw">OFF</span>     |</span>
<span id="cb480-38"><a href="#cb480-38" aria-hidden="true" tabindex="-1"></a>| avg_query_readkb       | <span class="kw">OFF</span>     |</span>
<span id="cb480-39"><a href="#cb480-39" aria-hidden="true" tabindex="-1"></a>| avg_query_readtime     | <span class="kw">OFF</span>     |</span>
<span id="cb480-40"><a href="#cb480-40" aria-hidden="true" tabindex="-1"></a>| qcache_cached_queries  | <span class="dv">0</span>       |</span>
<span id="cb480-41"><a href="#cb480-41" aria-hidden="true" tabindex="-1"></a>| qcache_used_bytes      | <span class="dv">0</span>       |</span>
<span id="cb480-42"><a href="#cb480-42" aria-hidden="true" tabindex="-1"></a>| qcache_hits            | <span class="dv">0</span>       |</span>
<span id="cb480-43"><a href="#cb480-43" aria-hidden="true" tabindex="-1"></a>| sql_parse_error        | <span class="dv">1</span>       |</span>
<span id="cb480-44"><a href="#cb480-44" aria-hidden="true" tabindex="-1"></a>| sql_show_status        | <span class="dv">3</span>       |</span>
<span id="cb480-45"><a href="#cb480-45" aria-hidden="true" tabindex="-1"></a>| local_indexes          | <span class="dv">6</span>       |</span>
<span id="cb480-46"><a href="#cb480-46" aria-hidden="true" tabindex="-1"></a>| local_indexes_disabled | <span class="dv">5</span>       |</span>
<span id="cb480-47"><a href="#cb480-47" aria-hidden="true" tabindex="-1"></a>| local_docs             | <span class="dv">2866967</span> |</span>
<span id="cb480-48"><a href="#cb480-48" aria-hidden="true" tabindex="-1"></a>| local_disk_mb          | <span class="fl">2786.2</span>  |</span>
<span id="cb480-49"><a href="#cb480-49" aria-hidden="true" tabindex="-1"></a>| local_ram_mb           | <span class="fl">1522.0</span>  |</span>
<span id="cb480-50"><a href="#cb480-50" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+---------+</span></span>
<span id="cb480-51"><a href="#cb480-51" aria-hidden="true" tabindex="-1"></a><span class="dv">44</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="show-manifest-syntax">SHOW MANIFEST syntax</h3>
<div class="sourceCode" id="cb481"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb481-1"><a href="#cb481-1" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">TABLE</span> <span class="op">&lt;</span>rtindex<span class="op">&gt;</span> MANIFEST</span></code></pre></div>
<p><code>SHOW MANIFEST</code> computes and displays the current index
manifest (ie. index data files and RAM segments checksums). This is
useful for (manually) comparing index contents across replicas.</p>
<p>For the record, <code>SHOW MANIFEST</code> does <strong>not</strong>
write anything to binlog, unlike its sister <code>FLUSH MANIFEST</code>
statement. It just displays whatever it computed.</p>
<div class="sourceCode" id="cb482"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb482-1"><a href="#cb482-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show <span class="kw">table</span> rt manifest;</span>
<span id="cb482-2"><a href="#cb482-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+----------------------------------+</span></span>
<span id="cb482-3"><a href="#cb482-3" aria-hidden="true" tabindex="-1"></a>| Name      | <span class="fu">Value</span>                            |</span>
<span id="cb482-4"><a href="#cb482-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+----------------------------------+</span></span>
<span id="cb482-5"><a href="#cb482-5" aria-hidden="true" tabindex="-1"></a>| rt.<span class="fl">0.</span>spa  | ae41a81a15bcca38bca5aa05b8066496 |</span>
<span id="cb482-6"><a href="#cb482-6" aria-hidden="true" tabindex="-1"></a>| rt.<span class="fl">0.</span>spb  | 6abb66453aca5f1fb8bd9f40920d32ab |</span>
<span id="cb482-7"><a href="#cb482-7" aria-hidden="true" tabindex="-1"></a>| rt.<span class="fl">0.</span>spc  | 99aa06d3014798d86001c324468d497f |</span>
<span id="cb482-8"><a href="#cb482-8" aria-hidden="true" tabindex="-1"></a>| rt.<span class="fl">0.</span>spd  | 6d43e948059530b3217f0564a1716b2d |</span>
<span id="cb482-9"><a href="#cb482-9" aria-hidden="true" tabindex="-1"></a>| rt.<span class="fl">0.</span>spe  | 51025a4491835505e12ef9d2eb86ceeb |</span>
<span id="cb482-10"><a href="#cb482-10" aria-hidden="true" tabindex="-1"></a>| rt.<span class="fl">0.</span>sph  | c6c7da3023b6f5b36a01d63ce1da7229 |</span>
<span id="cb482-11"><a href="#cb482-11" aria-hidden="true" tabindex="-1"></a>| rt.<span class="fl">0.</span>spi  | 58714b5c787eb4c1f8b313f3714b16bc |</span>
<span id="cb482-12"><a href="#cb482-12" aria-hidden="true" tabindex="-1"></a>| rt.<span class="fl">0.</span>spk  | 2a33816ed7e0c373dbe563c737220b65 |</span>
<span id="cb482-13"><a href="#cb482-13" aria-hidden="true" tabindex="-1"></a>| rt.<span class="fl">0.</span>spp  | 51025a4491835505e12ef9d2eb86ceeb |</span>
<span id="cb482-14"><a href="#cb482-14" aria-hidden="true" tabindex="-1"></a>| rt.meta   | e7c9b8a86d923e9a4775dfbed2b579bf |</span>
<span id="cb482-15"><a href="#cb482-15" aria-hidden="true" tabindex="-1"></a>| rt.ram    | eccb374a927b8d0b0b3af8638486bb96 |</span>
<span id="cb482-16"><a href="#cb482-16" aria-hidden="true" tabindex="-1"></a>| Ram       | 29aafb56466353fe703657e9a5762bb2 |</span>
<span id="cb482-17"><a href="#cb482-17" aria-hidden="true" tabindex="-1"></a>| <span class="kw">Full</span>      | c5091745b9038b4493b50bd46e602a65 |</span>
<span id="cb482-18"><a href="#cb482-18" aria-hidden="true" tabindex="-1"></a>| Tid       | <span class="dv">2</span>                                |</span>
<span id="cb482-19"><a href="#cb482-19" aria-hidden="true" tabindex="-1"></a>| <span class="dt">Timestamp</span> | <span class="dv">1738853324350522</span>                 |</span>
<span id="cb482-20"><a href="#cb482-20" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+----------------------------------+</span></span>
<span id="cb482-21"><a href="#cb482-21" aria-hidden="true" tabindex="-1"></a><span class="dv">15</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="dv">0</span>,<span class="dv">01</span> sec)</span></code></pre></div>
<p>Note that computing the manifest may take a while, especially on
bigger indexes. However, most DML queries (except <code>UPDATE</code>)
are <strong>not</strong> stalled, just as with (even lengthier)
<code>OPTIMIZE</code> operations.</p>
<h3 id="show-threads-syntax">SHOW THREADS syntax</h3>
<div class="sourceCode" id="cb483"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb483-1"><a href="#cb483-1" aria-hidden="true" tabindex="-1"></a>SHOW THREADS [<span class="kw">OPTION</span> <span class="kw">columns</span> <span class="op">=</span> <span class="op">&lt;</span>width<span class="op">&gt;</span>]</span></code></pre></div>
<p><code>SHOW THREADS</code> shows all the currently active client
worker threads, along with the thread states, queries they are
executing, elapsed time, and so on. (Note that there also always are
internal system threads. Those are <em>not</em> shown.)</p>
<p>This is quite useful for troubleshooting (generally taking a peek at
what exactly is the server doing right now; identifying problematic
query patterns; killing off individual “runaway” queries, etc). Here’s a
simple example.</p>
<div class="sourceCode" id="cb484"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb484-1"><a href="#cb484-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW THREADS <span class="kw">OPTION</span> <span class="kw">columns</span><span class="op">=</span><span class="dv">50</span>;</span>
<span id="cb484-2"><a href="#cb484-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+------+-------+----------+----------------------------------------------------+</span></span>
<span id="cb484-3"><a href="#cb484-3" aria-hidden="true" tabindex="-1"></a>| Tid  | Proto    | <span class="fu">User</span> | State | <span class="dt">Time</span>     | Info                                               |</span>
<span id="cb484-4"><a href="#cb484-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+------+-------+----------+----------------------------------------------------+</span></span>
<span id="cb484-5"><a href="#cb484-5" aria-hidden="true" tabindex="-1"></a>| <span class="dv">1181</span> | sphinxql |      | <span class="kw">query</span> | <span class="fl">0.000001</span> | show threads <span class="kw">option</span> <span class="kw">columns</span><span class="op">=</span><span class="dv">50</span>                     |</span>
<span id="cb484-6"><a href="#cb484-6" aria-hidden="true" tabindex="-1"></a>| <span class="dv">1177</span> | sphinxql |      | <span class="kw">query</span> | <span class="fl">0.000148</span> | <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> rt <span class="kw">option</span> <span class="kw">comment</span><span class="op">=</span><span class="st">&#39;fullscan&#39;</span>         |</span>
<span id="cb484-7"><a href="#cb484-7" aria-hidden="true" tabindex="-1"></a>| <span class="dv">1168</span> | sphinxql |      | <span class="kw">query</span> | <span class="fl">0.005432</span> | <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> rt <span class="kw">where</span> m <span class="op">..</span>. <span class="kw">comment</span><span class="op">=</span><span class="st">&#39;text-search&#39;</span> |</span>
<span id="cb484-8"><a href="#cb484-8" aria-hidden="true" tabindex="-1"></a>| <span class="dv">1132</span> | sphinxql |      | <span class="kw">query</span> | <span class="fl">0.885282</span> | <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> testwhere match(<span class="st">&#39;the&#39;</span>)               |</span>
<span id="cb484-9"><a href="#cb484-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------+------+-------+----------+----------------------------------------------------+</span></span>
<span id="cb484-10"><a href="#cb484-10" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>The columns are:</p>
<table>
<colgroup>
<col style="width: 10%" />
<col style="width: 89%" />
</colgroup>
<thead>
<tr class="header">
<th>Column</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Tid</td>
<td>Internal thread ID, can be passed to KILL</td>
</tr>
<tr class="even">
<td>Proto</td>
<td>Client connection protocol, <code>sphinxapi</code> or
<code>sphinxql</code></td>
</tr>
<tr class="odd">
<td>User</td>
<td>Client user name, as in <code>auth_users</code> (if enabled)</td>
</tr>
<tr class="even">
<td>State</td>
<td>Thread state,
<code>{handshake | net_read | net_write | query | net_idle}</code></td>
</tr>
<tr class="odd">
<td>Time</td>
<td>Time spent in current state, in seconds, with microsecond
precision</td>
</tr>
<tr class="even">
<td>Info</td>
<td>Query text, or other available data</td>
</tr>
</tbody>
</table>
<p>“Info” is usually the most interesting part. With SphinxQL it
basically shows the raw query text; with SphinxAPI the full-text query,
comment, and data size; and so on.</p>
<p><code>OPTION columns = &lt;width&gt;</code> enforces a limit on the
“Info” column width. That helps with concise overviews when the queries
are huge.</p>
<p>The default width is 4 KB, or 4096 bytes. The minimum width is set at
10 bytes. There always is <em>some</em> width limit, because queries can
get <em>extremely</em> long. Say, consider a big batch
<code>INSERT</code> that spans several megabytes. We would pretty much
never want its <em>entire</em> content dumped by
<code>SHOW THREADS</code>, hence the limit.</p>
<p>Comments (as in <code>OPTION comment</code>) are prioritized when
cutting SphinxQL queries down to the requested width. If the comment can
fit at all, we do that, even if that means removing everything else. In
the example above that’s exactly what happens in the 3rd row. Otherwise,
we simply truncate the query.</p>
<h3 id="show-variables-syntax">SHOW VARIABLES syntax</h3>
<div class="sourceCode" id="cb485"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb485-1"><a href="#cb485-1" aria-hidden="true" tabindex="-1"></a>SHOW [{<span class="kw">GLOBAL</span> | <span class="kw">SESSION</span>}] VARIABLES</span>
<span id="cb485-2"><a href="#cb485-2" aria-hidden="true" tabindex="-1"></a>    [{<span class="kw">WHERE</span> variable_name<span class="op">=</span><span class="st">&#39;&lt;varname&gt;&#39;</span> [<span class="kw">OR</span> <span class="op">..</span>.] |</span>
<span id="cb485-3"><a href="#cb485-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">LIKE</span> <span class="st">&#39;&lt;mask&gt;&#39;</span>}]</span></code></pre></div>
<p><code>SHOW VARIABLES</code> statement serves two very different
purposes:</p>
<ul>
<li>to provide compatibility with 3rd party MySQL clients;</li>
<li>to examine the current status of <code>searchd</code> server
variables.</li>
</ul>
<p>Compatibility mode is required to support connections from certain
MySQL clients that automatically run <code>SHOW VARIABLES</code> on
connection and fail if that statement raises an error.</p>
<p>At the moment, optional <code>GLOBAL</code> or <code>SESSION</code>
scope condition syntax is used for MySQL compatibility only. But Sphinx
ignores the scope, and all variables, both global and per-session, are
always displayed.</p>
<p><code>WHERE variable_name ...</code> clause is also for compatibility
only, and ignored.</p>
<p><code>LIKE '&lt;mask&gt;'</code> clause is however supported; for
instance:</p>
<div class="sourceCode" id="cb486"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb486-1"><a href="#cb486-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show variables <span class="kw">like</span> <span class="st">&#39;%comm%&#39;</span>;</span>
<span id="cb486-2"><a href="#cb486-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+-------+</span></span>
<span id="cb486-3"><a href="#cb486-3" aria-hidden="true" tabindex="-1"></a>| Variable_name | <span class="fu">Value</span> |</span>
<span id="cb486-4"><a href="#cb486-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+-------+</span></span>
<span id="cb486-5"><a href="#cb486-5" aria-hidden="true" tabindex="-1"></a>| autocommit    | <span class="dv">1</span>     |</span>
<span id="cb486-6"><a href="#cb486-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+-------+</span></span>
<span id="cb486-7"><a href="#cb486-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Some of the variables displayed in <code>SHOW VARIABLES</code> are
<em>mutable</em>, and can be changed on the fly using the
<code>SET GLOBAL</code> statement. For example, you can tweak
<code>log_level</code> or <code>sql_log_file</code> on the fly.</p>
<p>Some are <em>read-only</em> though, that is, they can be changed, but
only by editing the config file and restarting the daemon. For example,
<code>max_allowed_packet</code> and <code>listen</code> are read-only.
You can only change them in <code>sphinx.conf</code> and restart.</p>
<p>And finally, some of the variiables are <em>constant</em>, compiled
into the binary and never changed, such as <code>version</code> and a
few more informational variables.</p>
<div class="sourceCode" id="cb487"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb487-1"><a href="#cb487-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show variables;</span>
<span id="cb487-2"><a href="#cb487-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------------+-------------------------------------+</span></span>
<span id="cb487-3"><a href="#cb487-3" aria-hidden="true" tabindex="-1"></a>| Variable_name                | <span class="fu">Value</span>                               |</span>
<span id="cb487-4"><a href="#cb487-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------------+-------------------------------------+</span></span>
<span id="cb487-5"><a href="#cb487-5" aria-hidden="true" tabindex="-1"></a>| agent_connect_timeout        | <span class="dv">1000</span>                                |</span>
<span id="cb487-6"><a href="#cb487-6" aria-hidden="true" tabindex="-1"></a>| agent_query_timeout          | <span class="dv">3000</span>                                |</span>
<span id="cb487-7"><a href="#cb487-7" aria-hidden="true" tabindex="-1"></a>| agent_retry_delay            | <span class="dv">500</span>                                 |</span>
<span id="cb487-8"><a href="#cb487-8" aria-hidden="true" tabindex="-1"></a>| attrindex_thresh             | <span class="dv">1024</span>                                |</span>
<span id="cb487-9"><a href="#cb487-9" aria-hidden="true" tabindex="-1"></a>| autocommit                   | <span class="dv">1</span>                                   |</span>
<span id="cb487-10"><a href="#cb487-10" aria-hidden="true" tabindex="-1"></a>| binlog_flush_mode            | <span class="dv">2</span>                                   |</span>
<span id="cb487-11"><a href="#cb487-11" aria-hidden="true" tabindex="-1"></a>| binlog_max_log_size          | <span class="dv">0</span>                                   |</span>
<span id="cb487-12"><a href="#cb487-12" aria-hidden="true" tabindex="-1"></a>| binlog_path                  |                                     |</span>
<span id="cb487-13"><a href="#cb487-13" aria-hidden="true" tabindex="-1"></a>| character_set_client         | utf8                                |</span>
<span id="cb487-14"><a href="#cb487-14" aria-hidden="true" tabindex="-1"></a>| character_set_connection     | utf8                                |</span>
<span id="cb487-15"><a href="#cb487-15" aria-hidden="true" tabindex="-1"></a>| client_timeout               | <span class="dv">300</span>                                 |</span>
<span id="cb487-16"><a href="#cb487-16" aria-hidden="true" tabindex="-1"></a>| collation_connection         | libc_ci                             |</span>
<span id="cb487-17"><a href="#cb487-17" aria-hidden="true" tabindex="-1"></a>| collation_libc_locale        |                                     |</span>
<span id="cb487-18"><a href="#cb487-18" aria-hidden="true" tabindex="-1"></a>| dist_threads                 | <span class="dv">0</span>                                   |</span>
<span id="cb487-19"><a href="#cb487-19" aria-hidden="true" tabindex="-1"></a>| docstore_cache_size          | <span class="dv">10485760</span>                            |</span>
<span id="cb487-20"><a href="#cb487-20" aria-hidden="true" tabindex="-1"></a>| expansion_limit              | <span class="dv">0</span>                                   |</span>
<span id="cb487-21"><a href="#cb487-21" aria-hidden="true" tabindex="-1"></a>| ha_period_karma              | <span class="dv">60</span>                                  |</span>
<span id="cb487-22"><a href="#cb487-22" aria-hidden="true" tabindex="-1"></a>| ha_ping_interval             | <span class="dv">1000</span>                                |</span>
<span id="cb487-23"><a href="#cb487-23" aria-hidden="true" tabindex="-1"></a>| ha_weight                    | <span class="dv">100</span>                                 |</span>
<span id="cb487-24"><a href="#cb487-24" aria-hidden="true" tabindex="-1"></a>| hostname_lookup              | <span class="dv">0</span>                                   |</span>
<span id="cb487-25"><a href="#cb487-25" aria-hidden="true" tabindex="-1"></a>| listen                       | <span class="dv">9306</span><span class="ch">:mysql41</span>                        |</span>
<span id="cb487-26"><a href="#cb487-26" aria-hidden="true" tabindex="-1"></a>| listen                       | <span class="dv">9312</span>                                |</span>
<span id="cb487-27"><a href="#cb487-27" aria-hidden="true" tabindex="-1"></a>| listen_backlog               | <span class="dv">64</span>                                  |</span>
<span id="cb487-28"><a href="#cb487-28" aria-hidden="true" tabindex="-1"></a>| <span class="fu">log</span>                          | .<span class="op">/</span><span class="kw">data</span><span class="op">/</span>searchd.<span class="fu">log</span>                  |</span>
<span id="cb487-29"><a href="#cb487-29" aria-hidden="true" tabindex="-1"></a>| log_debug_filter             |                                     |</span>
<span id="cb487-30"><a href="#cb487-30" aria-hidden="true" tabindex="-1"></a>| log_level                    | info                                |</span>
<span id="cb487-31"><a href="#cb487-31" aria-hidden="true" tabindex="-1"></a>| max_allowed_packet           | <span class="dv">8388608</span>                             |</span>
<span id="cb487-32"><a href="#cb487-32" aria-hidden="true" tabindex="-1"></a>| max_batch_queries            | <span class="dv">32</span>                                  |</span>
<span id="cb487-33"><a href="#cb487-33" aria-hidden="true" tabindex="-1"></a>| max_children                 | <span class="dv">20</span>                                  |</span>
<span id="cb487-34"><a href="#cb487-34" aria-hidden="true" tabindex="-1"></a>| max_filter_values            | <span class="dv">4096</span>                                |</span>
<span id="cb487-35"><a href="#cb487-35" aria-hidden="true" tabindex="-1"></a>| max_filters                  | <span class="dv">256</span>                                 |</span>
<span id="cb487-36"><a href="#cb487-36" aria-hidden="true" tabindex="-1"></a>| my_net_address               |                                     |</span>
<span id="cb487-37"><a href="#cb487-37" aria-hidden="true" tabindex="-1"></a>| mysql_version_string         | <span class="dv">3</span>.<span class="fl">4.1</span><span class="op">-</span>dev (<span class="kw">commit</span> 6d01467e1)        |</span>
<span id="cb487-38"><a href="#cb487-38" aria-hidden="true" tabindex="-1"></a>| net_spin_msec                | <span class="dv">10</span>                                  |</span>
<span id="cb487-39"><a href="#cb487-39" aria-hidden="true" tabindex="-1"></a>| net_throttle_accept          | <span class="dv">0</span>                                   |</span>
<span id="cb487-40"><a href="#cb487-40" aria-hidden="true" tabindex="-1"></a>| net_throttle_action          | <span class="dv">0</span>                                   |</span>
<span id="cb487-41"><a href="#cb487-41" aria-hidden="true" tabindex="-1"></a>| net_workers                  | <span class="dv">1</span>                                   |</span>
<span id="cb487-42"><a href="#cb487-42" aria-hidden="true" tabindex="-1"></a>| ondisk_attrs_default         | <span class="dv">0</span>                                   |</span>
<span id="cb487-43"><a href="#cb487-43" aria-hidden="true" tabindex="-1"></a>| persistent_connections_limit | <span class="dv">0</span>                                   |</span>
<span id="cb487-44"><a href="#cb487-44" aria-hidden="true" tabindex="-1"></a>| pid_file                     |                                     |</span>
<span id="cb487-45"><a href="#cb487-45" aria-hidden="true" tabindex="-1"></a>| predicted_time_costs         | doc<span class="op">=</span><span class="dv">64</span>, hit<span class="op">=</span><span class="dv">48</span>, <span class="kw">skip</span><span class="op">=</span><span class="dv">2048</span>, match<span class="op">=</span><span class="dv">64</span> |</span>
<span id="cb487-46"><a href="#cb487-46" aria-hidden="true" tabindex="-1"></a>| preopen_indexes              | <span class="dv">0</span>                                   |</span>
<span id="cb487-47"><a href="#cb487-47" aria-hidden="true" tabindex="-1"></a>| qcache_max_bytes             | <span class="dv">0</span>                                   |</span>
<span id="cb487-48"><a href="#cb487-48" aria-hidden="true" tabindex="-1"></a>| qcache_thresh_msec           | <span class="dv">3000</span>                                |</span>
<span id="cb487-49"><a href="#cb487-49" aria-hidden="true" tabindex="-1"></a>| qcache_ttl_sec               | <span class="dv">60</span>                                  |</span>
<span id="cb487-50"><a href="#cb487-50" aria-hidden="true" tabindex="-1"></a>| query_log                    | .<span class="op">/</span><span class="kw">data</span><span class="op">/</span><span class="kw">query</span>.<span class="fu">log</span>                    |</span>
<span id="cb487-51"><a href="#cb487-51" aria-hidden="true" tabindex="-1"></a>| query_log_format             | sphinxql                            |</span>
<span id="cb487-52"><a href="#cb487-52" aria-hidden="true" tabindex="-1"></a>| query_log_min_msec           | <span class="dv">0</span>                                   |</span>
<span id="cb487-53"><a href="#cb487-53" aria-hidden="true" tabindex="-1"></a>| queue_max_length             | <span class="dv">0</span>                                   |</span>
<span id="cb487-54"><a href="#cb487-54" aria-hidden="true" tabindex="-1"></a>| read_buffer                  | <span class="dv">0</span>                                   |</span>
<span id="cb487-55"><a href="#cb487-55" aria-hidden="true" tabindex="-1"></a>| read_timeout                 | <span class="dv">5</span>                                   |</span>
<span id="cb487-56"><a href="#cb487-56" aria-hidden="true" tabindex="-1"></a>| read_unhinted                | <span class="dv">0</span>                                   |</span>
<span id="cb487-57"><a href="#cb487-57" aria-hidden="true" tabindex="-1"></a>| repl_blacklist               |                                     |</span>
<span id="cb487-58"><a href="#cb487-58" aria-hidden="true" tabindex="-1"></a>| rid                          | fe34aa59<span class="op">-</span>7eb4db30                   |</span>
<span id="cb487-59"><a href="#cb487-59" aria-hidden="true" tabindex="-1"></a>| rt_flush_period              | <span class="dv">36000</span>                               |</span>
<span id="cb487-60"><a href="#cb487-60" aria-hidden="true" tabindex="-1"></a>| rt_merge_iops                | <span class="dv">0</span>                                   |</span>
<span id="cb487-61"><a href="#cb487-61" aria-hidden="true" tabindex="-1"></a>| rt_merge_maxiosize           | <span class="dv">0</span>                                   |</span>
<span id="cb487-62"><a href="#cb487-62" aria-hidden="true" tabindex="-1"></a>| seamless_rotate              | <span class="dv">0</span>                                   |</span>
<span id="cb487-63"><a href="#cb487-63" aria-hidden="true" tabindex="-1"></a>| shutdown_timeout             | <span class="dv">3000000</span>                             |</span>
<span id="cb487-64"><a href="#cb487-64" aria-hidden="true" tabindex="-1"></a>| siege                        | <span class="dv">0</span>                                   |</span>
<span id="cb487-65"><a href="#cb487-65" aria-hidden="true" tabindex="-1"></a>| siege_max_fetched_docs       | <span class="dv">1000000</span>                             |</span>
<span id="cb487-66"><a href="#cb487-66" aria-hidden="true" tabindex="-1"></a>| siege_max_query_msec         | <span class="dv">1000</span>                                |</span>
<span id="cb487-67"><a href="#cb487-67" aria-hidden="true" tabindex="-1"></a>| snippets_file_prefix         |                                     |</span>
<span id="cb487-68"><a href="#cb487-68" aria-hidden="true" tabindex="-1"></a>| sphinxql_state               | state.sql                           |</span>
<span id="cb487-69"><a href="#cb487-69" aria-hidden="true" tabindex="-1"></a>| sphinxql_timeout             | <span class="dv">900</span>                                 |</span>
<span id="cb487-70"><a href="#cb487-70" aria-hidden="true" tabindex="-1"></a>| sql_fail_filter              |                                     |</span>
<span id="cb487-71"><a href="#cb487-71" aria-hidden="true" tabindex="-1"></a>| sql_log_file                 |                                     |</span>
<span id="cb487-72"><a href="#cb487-72" aria-hidden="true" tabindex="-1"></a>| thread_stack                 | <span class="dv">131072</span>                              |</span>
<span id="cb487-73"><a href="#cb487-73" aria-hidden="true" tabindex="-1"></a>| unlink_old                   | <span class="dv">1</span>                                   |</span>
<span id="cb487-74"><a href="#cb487-74" aria-hidden="true" tabindex="-1"></a>| version                      | <span class="dv">3</span>.<span class="fl">4.1</span><span class="op">-</span>dev (<span class="kw">commit</span> 6d01467e1)        |</span>
<span id="cb487-75"><a href="#cb487-75" aria-hidden="true" tabindex="-1"></a>| version_api_master           | <span class="dv">23</span>                                  |</span>
<span id="cb487-76"><a href="#cb487-76" aria-hidden="true" tabindex="-1"></a>| version_api_search           | <span class="fl">1.34</span>                                |</span>
<span id="cb487-77"><a href="#cb487-77" aria-hidden="true" tabindex="-1"></a>| version_binlog_format        | <span class="dv">8</span>                                   |</span>
<span id="cb487-78"><a href="#cb487-78" aria-hidden="true" tabindex="-1"></a>| version_index_format         | <span class="dv">55</span>                                  |</span>
<span id="cb487-79"><a href="#cb487-79" aria-hidden="true" tabindex="-1"></a>| version_udf_api              | <span class="dv">17</span>                                  |</span>
<span id="cb487-80"><a href="#cb487-80" aria-hidden="true" tabindex="-1"></a>| watchdog                     | <span class="dv">1</span>                                   |</span>
<span id="cb487-81"><a href="#cb487-81" aria-hidden="true" tabindex="-1"></a>| workers                      | <span class="dv">1</span>                                   |</span>
<span id="cb487-82"><a href="#cb487-82" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------------+-------------------------------------+</span></span></code></pre></div>
<p>Specific per-variable documentation can be found in the <a
href="#server-variables-reference">“Server variables reference”</a>
section.</p>
<h3 id="truncate-index-syntax">TRUNCATE INDEX syntax</h3>
<div class="sourceCode" id="cb488"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb488-1"><a href="#cb488-1" aria-hidden="true" tabindex="-1"></a><span class="kw">TRUNCATE</span> <span class="kw">INDEX</span> <span class="op">&lt;</span><span class="kw">index</span><span class="op">&gt;</span></span></code></pre></div>
<p><code>TRUNCATE INDEX</code> statement removes all data from RT/PQ
indexes completely, and quite quickly. It disposes all the index data
(ie. RAM segments, disk segments files, binlog files), but keeps the
existing index schema and other settings.</p>
<div class="sourceCode" id="cb489"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb489-1"><a href="#cb489-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">TRUNCATE</span> <span class="kw">INDEX</span> rt;</span>
<span id="cb489-2"><a href="#cb489-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.05</span> sec)</span></code></pre></div>
<p>One boring usecase is recreating staging indexes on the fly.</p>
<p>One interesting usecase are RT delta indexes over plain main indexes:
every time you successfully rebuild the main index, you naturally need
to wipe the deltas, and <code>TRUNCATE INDEX</code> does exactly
that.</p>
<h3 id="update-syntax">UPDATE syntax</h3>
<div class="sourceCode" id="cb490"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb490-1"><a href="#cb490-1" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> [INPLACE] <span class="op">&lt;</span>ftindex<span class="op">&gt;</span> <span class="kw">SET</span> <span class="op">&lt;</span>col1<span class="op">&gt;</span> <span class="op">=</span> <span class="op">&lt;</span>val1<span class="op">&gt;</span> [, <span class="op">&lt;</span>col2<span class="op">&gt;</span> <span class="op">=</span> <span class="op">&lt;</span>val2<span class="op">&gt;</span> [<span class="op">..</span>.]]</span>
<span id="cb490-2"><a href="#cb490-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="op">&lt;</span>where_cond<span class="op">&gt;</span> [<span class="kw">OPTION</span> opt_name <span class="op">=</span> opt_value [, <span class="op">..</span>.]]</span></code></pre></div>
<p><code>UPDATE</code> lets you update existing FT indexes with new
column (aka attribute) values. <strong>The new values must be constant
and explicit</strong>, ie. expressions such as
<code>UPDATE ... SET price = price + 10 ...</code> are <em>not</em>
(yet) supported. You need to use <code>SET price = 100</code> instead.
Multiple columns can be updated at once, though, ie.
<code>SET price = 100, quantity = 15</code> is okay.</p>
<p><strong>Updates work with both RT and plain indexes</strong>, as they
only modify attributes and not the full-text fields.</p>
<p>As of v.3.8 <strong>almost all attributes types can be
updated.</strong> The only current exception is blobs.</p>
<p><strong>Rows to update must be selected using the <code>WHERE</code>
condition clause.</strong> Refer to <a
href="#select-syntax"><code>SELECT</code> statement</a> for its syntax
details.</p>
<p><strong>The new values are type-checked and range-checked.</strong>
For instance, attempts to update an <code>UINT</code> column with floats
or too-big integers should fail.</p>
<div class="sourceCode" id="cb491"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb491-1"><a href="#cb491-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">UPDATE</span> rt <span class="kw">SET</span> c1<span class="op">=</span><span class="fl">1.23</span> <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">=</span><span class="dv">123</span>;</span>
<span id="cb491-2"><a href="#cb491-2" aria-hidden="true" tabindex="-1"></a>ERROR <span class="dv">1064</span> (<span class="dv">42000</span>): <span class="kw">index</span> <span class="st">&#39;rt&#39;</span>: <span class="kw">attribute</span> <span class="st">&#39;c1&#39;</span> <span class="kw">is</span> <span class="dt">integer</span></span>
<span id="cb491-3"><a href="#cb491-3" aria-hidden="true" tabindex="-1"></a><span class="kw">and</span> can <span class="kw">not</span> <span class="kw">store</span> floating<span class="op">-</span>point <span class="kw">values</span></span>
<span id="cb491-4"><a href="#cb491-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb491-5"><a href="#cb491-5" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">UPDATE</span> rt <span class="kw">SET</span> c1<span class="op">=</span><span class="dv">5000111222</span> <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">=</span><span class="dv">123</span>;</span>
<span id="cb491-6"><a href="#cb491-6" aria-hidden="true" tabindex="-1"></a>ERROR <span class="dv">1064</span> (<span class="dv">42000</span>): <span class="kw">index</span> <span class="st">&#39;rt&#39;</span>: <span class="fu">value</span> <span class="st">&#39;5000111222&#39;</span> <span class="kw">is</span> <span class="kw">out</span> <span class="kw">of</span> <span class="kw">range</span></span>
<span id="cb491-7"><a href="#cb491-7" aria-hidden="true" tabindex="-1"></a><span class="kw">and</span> can <span class="kw">not</span> be stored <span class="kw">to</span> UINT</span></code></pre></div>
<p>We do not (yet!) claim complete safety here, some edge cases may have
slipped through the cracks. So if you find any, please report them.</p>
<p><strong>MVA values must be specified as comma-separated lists in
parentheses.</strong> And to erase a MVA value just use an empty list,
ie. <code>()</code>. For the record, MVA updates are naturally
non-inplace.</p>
<div class="sourceCode" id="cb492"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb492-1"><a href="#cb492-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">UPDATE</span> rt <span class="kw">SET</span> m1<span class="op">=</span>(<span class="dv">3</span>,<span class="dv">6</span>,<span class="dv">4</span>), m2<span class="op">=</span>()</span>
<span id="cb492-2"><a href="#cb492-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">WHERE</span> MATCH(<span class="st">&#39;test&#39;</span>) <span class="kw">AND</span> enabled<span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb492-3"><a href="#cb492-3" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">148</span> <span class="kw">rows</span> affected (<span class="fl">0.01</span> sec)</span></code></pre></div>
<p><strong>Array columns and their elements can also be
updated.</strong> The array values use the usual square brace syntax, as
follows. For the record, array updates are naturally inplace.</p>
<div class="sourceCode" id="cb493"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb493-1"><a href="#cb493-1" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> myindex <span class="kw">SET</span> arr<span class="op">=</span>[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>] <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">=</span><span class="dv">123</span></span>
<span id="cb493-2"><a href="#cb493-2" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> myindex <span class="kw">SET</span> arr[<span class="dv">3</span>]<span class="op">=</span><span class="dv">987</span> <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">=</span><span class="dv">123</span></span></code></pre></div>
<p>Element values are also type-checked and range-checked. For example,
attempts to update <code>INT8</code> arrays with out-of-bounds integer
values must fail.</p>
<p><strong>Partial JSON updates are now allowed</strong>, ie. you can
now update individual key-value pairs within a JSON column, rather than
overwriting the entire JSON.</p>
<blockquote>
<p>NOTE! <code>JSON('...')</code> value syntax <strong>must</strong> be
used for a structured update, that is, for an update that wants to place
a new subobject (or an array value) into a given JSON column key.</p>
</blockquote>
<p>Otherwise, there’s just no good way for Sphinx to figure out whether
it was given a regular string value, or a JSON document. (Moreover,
sometimes people <em>do</em> actually <em>want</em> to store a
serialized JSON string as a value within a JSON column.) So unless you
<strong>explicitly</strong> use <code>JSON()</code> type hint, Sphinx
assumes that a string is a string.</p>
<p>Here’s an example.</p>
<div class="sourceCode" id="cb494"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb494-1"><a href="#cb494-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> rt <span class="kw">where</span> <span class="kw">id</span><span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb494-2"><a href="#cb494-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----+------+----------------------------------+</span></span>
<span id="cb494-3"><a href="#cb494-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span> | <span class="kw">body</span> | json1                            |</span>
<span id="cb494-4"><a href="#cb494-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----+------+----------------------------------+</span></span>
<span id="cb494-5"><a href="#cb494-5" aria-hidden="true" tabindex="-1"></a>| <span class="dv">1</span>  | test | {<span class="ot">&quot;a&quot;</span>:[<span class="fl">2.0</span>,<span class="ot">&quot;doggy&quot;</span>,<span class="dv">50</span>],<span class="ot">&quot;b&quot;</span>:<span class="ot">&quot;cat&quot;</span>} |</span>
<span id="cb494-6"><a href="#cb494-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----+------+----------------------------------+</span></span>
<span id="cb494-7"><a href="#cb494-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span></span>
<span id="cb494-8"><a href="#cb494-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb494-9"><a href="#cb494-9" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">update</span> rt <span class="kw">set</span> json1.a<span class="op">=</span><span class="st">&#39;{&quot;c&quot;: &quot;dog&quot;}&#39;</span> <span class="kw">where</span> <span class="kw">id</span><span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb494-10"><a href="#cb494-10" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">rows</span> affected</span>
<span id="cb494-11"><a href="#cb494-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb494-12"><a href="#cb494-12" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> rt <span class="kw">where</span> <span class="kw">id</span><span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb494-13"><a href="#cb494-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----+------+------------------------------------+</span></span>
<span id="cb494-14"><a href="#cb494-14" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span> | <span class="kw">body</span> | json1                              |</span>
<span id="cb494-15"><a href="#cb494-15" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----+------+------------------------------------+</span></span>
<span id="cb494-16"><a href="#cb494-16" aria-hidden="true" tabindex="-1"></a>| <span class="dv">1</span>  | test | {<span class="ot">&quot;a&quot;</span>:<span class="ot">&quot;{\&quot;</span>c\<span class="ot">&quot;: \&quot;</span>dog\<span class="ot">&quot;}&quot;</span>,<span class="ot">&quot;b&quot;</span>:<span class="ot">&quot;cat&quot;</span>} |</span>
<span id="cb494-17"><a href="#cb494-17" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----+------+------------------------------------+</span></span>
<span id="cb494-18"><a href="#cb494-18" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span></span></code></pre></div>
<p>Oops, that’s not what we really intended. We passed our new value as
a string, but forgot to tell Sphinx it’s actually JSON.
<code>JSON()</code> syntax to the rescue!</p>
<div class="sourceCode" id="cb495"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb495-1"><a href="#cb495-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">update</span> rt <span class="kw">set</span> json1.a<span class="op">=</span>JSON(<span class="st">&#39;{&quot;c&quot;: &quot;dog&quot;}&#39;</span>) <span class="kw">where</span> <span class="kw">id</span><span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb495-2"><a href="#cb495-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">rows</span> affected</span>
<span id="cb495-3"><a href="#cb495-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb495-4"><a href="#cb495-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> rt <span class="kw">where</span> <span class="kw">id</span><span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb495-5"><a href="#cb495-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----+------+-----------------------------+</span></span>
<span id="cb495-6"><a href="#cb495-6" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span> | <span class="kw">body</span> | json1                       |</span>
<span id="cb495-7"><a href="#cb495-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----+------+-----------------------------+</span></span>
<span id="cb495-8"><a href="#cb495-8" aria-hidden="true" tabindex="-1"></a>| <span class="dv">1</span>  | test | {<span class="ot">&quot;a&quot;</span>:{<span class="ot">&quot;c&quot;</span>:<span class="ot">&quot;dog&quot;</span>},<span class="ot">&quot;b&quot;</span>:<span class="ot">&quot;cat&quot;</span>} |</span>
<span id="cb495-9"><a href="#cb495-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----+------+-----------------------------+</span></span>
<span id="cb495-10"><a href="#cb495-10" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span></span></code></pre></div>
<p>And now we’ve placed a new JSON subobject into <code>json1.a</code>,
as intended.</p>
<h4 id="in-place-updates">In-place updates</h4>
<p>Updates fundamentally fall into two different major categories.</p>
<p>The first one is <strong>in-place</strong> updates that only modify
the value but keep the length intact. (And type too, in the JSON field
update case.) Naturally, all the numeric column updates are like
that.</p>
<p>The second one is <strong>non-inplace</strong> updates that need to
modify the value length. Any string or MVA update is like that.</p>
<p>With an in-place update, the new values overwrite the eligible old
values wherever those are stored, and that is as efficient as
possible.</p>
<p><strong>Any fixed-width attributes and any fixed-width JSON fields
can be efficiently updated in-place.</strong></p>
<p>At the moment, in-place updates are supported for any numeric values
(ie. bool, integer, or float) stored either as attributes or within
JSON, for fixed arrays, and for JSON arrays, ie. optimized
<code>FLOAT</code> or <code>INT32</code> vectors stored in JSON.</p>
<p><strong>You can use the <code>UPDATE INPLACE</code> syntax to
<em>force</em> an in-place update</strong>, where applicable. Adding
that <code>INPLACE</code> keyword <em>ensures</em> that the types and
widths are supported, and that the update happens in-place. Otherwise,
the update must fail, while without <code>INPLACE</code> it could still
attempt (slower) non-inplace path.</p>
<p>This isn’t much of an issue when updating simple numeric columns that
naturally <em>only</em> support in-place updates, but this does makes a
difference when updating values in JSON. Consider the following two
queries.</p>
<pre><code>UPDATE myindex SET j.foo=123 WHERE id=1
UPDATE myindex SET j.bar=json(&#39;[1,2,3]&#39;) WHERE id=1</code></pre>
<p>They seem innocuous, but depending on what data is <em>actually</em>
stored in <code>foo</code> and <code>bar</code>, these may not be able
to quickly update just the value in-place, and would need to replace the
entire JSON. What if <code>foo</code> is a string? What if
<code>bar</code> is an array of a matching type but different length?
Oops, we can’t (quickly!) change neither the data type nor length
in-place, so we need to (slowly!) remove the old values, and insert the
new values, and store the resulting new version of our JSON
somewhere.</p>
<p>And that might not be our intent. We sometimes <em>require</em> that
certain updates are carried out either quickly and in-place, or not at
all, and <code>UPDATE INPLACE</code> lets us do exactly that.</p>
<p><strong>Multi-row in-place updates only affect eligible JSON
values.</strong> That is, if some of the JSON values can be updated and
some can not, the entire update will <em>not</em> fail, but only the
eligible JSON values (those of matching type) will be updated. See an
example just below.</p>
<p><strong>In-place JSON array updates keep the pre-existing array
length.</strong> New arrays that are too short are zero-padded. New
arrays that are too long are truncated. As follows.</p>
<div class="sourceCode" id="cb497"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb497-1"><a href="#cb497-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> rt;</span>
<span id="cb497-2"><a href="#cb497-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------------------+</span></span>
<span id="cb497-3"><a href="#cb497-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | gid  | j                       |</span>
<span id="cb497-4"><a href="#cb497-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------------------+</span></span>
<span id="cb497-5"><a href="#cb497-5" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> |    <span class="dv">0</span> | {<span class="ot">&quot;foo&quot;</span>:[<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>]}       |</span>
<span id="cb497-6"><a href="#cb497-6" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> |    <span class="dv">0</span> | {<span class="ot">&quot;foo&quot;</span>:<span class="ot">&quot;bar&quot;</span>}           |</span>
<span id="cb497-7"><a href="#cb497-7" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> |    <span class="dv">0</span> | {<span class="ot">&quot;foo&quot;</span>:[<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>]} |</span>
<span id="cb497-8"><a href="#cb497-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------------------+</span></span>
<span id="cb497-9"><a href="#cb497-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb497-10"><a href="#cb497-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb497-11"><a href="#cb497-11" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">update</span> inplace rt <span class="kw">set</span> gid<span class="op">=</span><span class="dv">123</span>, j.foo<span class="op">=</span>json(<span class="st">&#39;[5,4,3,2,1]&#39;</span>) <span class="kw">where</span> <span class="kw">id</span><span class="op">&lt;</span><span class="dv">5</span>;</span>
<span id="cb497-12"><a href="#cb497-12" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">3</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb497-13"><a href="#cb497-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb497-14"><a href="#cb497-14" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> rt;</span>
<span id="cb497-15"><a href="#cb497-15" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------------------+</span></span>
<span id="cb497-16"><a href="#cb497-16" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | gid  | j                       |</span>
<span id="cb497-17"><a href="#cb497-17" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------------------+</span></span>
<span id="cb497-18"><a href="#cb497-18" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> |  <span class="dv">123</span> | {<span class="ot">&quot;foo&quot;</span>:[<span class="dv">5</span>,<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>]}       |</span>
<span id="cb497-19"><a href="#cb497-19" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> |  <span class="dv">123</span> | {<span class="ot">&quot;foo&quot;</span>:<span class="ot">&quot;bar&quot;</span>}           |</span>
<span id="cb497-20"><a href="#cb497-20" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> |  <span class="dv">123</span> | {<span class="ot">&quot;foo&quot;</span>:[<span class="dv">5</span>,<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>]} |</span>
<span id="cb497-21"><a href="#cb497-21" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------------------+</span></span>
<span id="cb497-22"><a href="#cb497-22" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>As a side note, note that the <code>gid=123</code> update part
applied even to those rows where the <code>j.foo</code> could not be
applied. This is rather intentional, multi-value updates are not atomic,
they may update whatever parts they can.</p>
<p><strong>Syntax error is raised for unsupported (non-fixed-width)
column types.</strong> <code>UPDATE INPLACE</code> fails early on those,
at the query parsing stage.</p>
<div class="sourceCode" id="cb498"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb498-1"><a href="#cb498-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">UPDATE</span> rt <span class="kw">SET</span> str<span class="op">=</span><span class="st">&#39;text&#39;</span> <span class="kw">WHERE</span> MATCH(<span class="st">&#39;test&#39;</span>) <span class="kw">AND</span> enabled<span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb498-2"><a href="#cb498-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">148</span> <span class="kw">rows</span> affected (<span class="fl">0.01</span> sec)</span>
<span id="cb498-3"><a href="#cb498-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb498-4"><a href="#cb498-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">UPDATE</span> INPLACE rt <span class="kw">SET</span> str<span class="op">=</span><span class="st">&#39;text&#39;</span> <span class="kw">WHERE</span> MATCH(<span class="st">&#39;test&#39;</span>) <span class="kw">AND</span> enabled<span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb498-5"><a href="#cb498-5" aria-hidden="true" tabindex="-1"></a>ERROR <span class="dv">1064</span>: sphinxql: syntax error, unexpected QUOTED_STRING, expecting</span>
<span id="cb498-6"><a href="#cb498-6" aria-hidden="true" tabindex="-1"></a>    CONST_INT <span class="kw">or</span> CONST_FLOAT <span class="kw">or</span> DOT_NUMBER <span class="kw">or</span> <span class="st">&#39;-&#39;</span> near <span class="op">..</span>.</span></code></pre></div>
<p><strong>Individual JSON array elements can be updated.</strong> For
performance reasons, inplace updates (ie. those that don’t change the
value type) are somewhat better for those.</p>
<p>(For the curious: Sphinx internally stores JSONs in an efficient
binary format. Inplace updates directly patch indiviual values within
that binary format, and only change a few bytes. However, non-inplace
updates <em>must</em> rewrite the entire JSON column with a newly
updated version.)</p>
<div class="sourceCode" id="cb499"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb499-1"><a href="#cb499-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">update</span> inplace rt <span class="kw">set</span> j.foo[<span class="dv">1</span>]<span class="op">=</span><span class="dv">33</span> <span class="kw">where</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">1</span>;</span>
<span id="cb499-2"><a href="#cb499-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb499-3"><a href="#cb499-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb499-4"><a href="#cb499-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> rt;</span>
<span id="cb499-5"><a href="#cb499-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------------------+</span></span>
<span id="cb499-6"><a href="#cb499-6" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | gid  | j                       |</span>
<span id="cb499-7"><a href="#cb499-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------------------+</span></span>
<span id="cb499-8"><a href="#cb499-8" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> |  <span class="dv">123</span> | {<span class="ot">&quot;foo&quot;</span>:[<span class="dv">5</span>,<span class="dv">33</span>,<span class="dv">3</span>,<span class="dv">2</span>]}      |</span>
<span id="cb499-9"><a href="#cb499-9" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> |  <span class="dv">123</span> | {<span class="ot">&quot;foo&quot;</span>:<span class="ot">&quot;bar&quot;</span>}           |</span>
<span id="cb499-10"><a href="#cb499-10" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> |  <span class="dv">123</span> | {<span class="ot">&quot;foo&quot;</span>:[<span class="dv">5</span>,<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>]} |</span>
<span id="cb499-11"><a href="#cb499-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+-------------------------+</span></span>
<span id="cb499-12"><a href="#cb499-12" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p><strong>In-place value updates are NOT atomic, dirty single-value
reads CAN happen.</strong> A concurrent reader thread running a
<code>SELECT</code> may (rather rarely) end up reading a value that is
neither here nor there, and “mixes” the old and new values.</p>
<p>The chances of reading a “mixed” value are naturally (much) higher
with larger arrays that simple numeric values. Imagine that you’re
updating 128D embeddings vectors, and that the <code>UPDATE</code>
thread gets stalled after just a few values while still working on some
row. Concurrent readers then can (and will!) occasionally read a “mixed”
vector for that row at that moment.</p>
<p>How frequently does that actually happen? We tested that with 1M rows
and 100D vectors, write workload that was constantly updating ~15K rows
per second, and read workload that ran selects scanning the entire 1M
rows. The “mixed read” error rate was roughly 1 in ~1M rows, that is,
100 selects reading 1M rows each would on average report just ~100
“mixed” rows out of the 100M rows processed total. We deem that an
acceptable rate for our applications; of course, your workload may be
different and your mileage may vary.</p>
<h4 id="update-options"><code>UPDATE</code> options</h4>
<p>Finally, <code>UPDATE</code> supports a few <code>OPTION</code>
clauses. Namely.</p>
<ol type="1">
<li><p><code>OPTION ignore_nonexistent_columns=1</code> suppresses any
errors when trying to update non-existent columns. This may be useful
for updates on distributed indexes that combine participants with
differing schemas. The default is 0.</p></li>
<li><p><code>OPTION strict=1</code> affects JSON updates. In strict
mode, any JSON update warnings (eg. in-place update type mismatches) are
promoted to hard errors, the entire update is cancelled. In non-strict
mode, multi-column or multi-key updates may apply partially, ie. change
column number one but not the JSON key number two. The default is 0, but
we strongly suggest using 1, because the strict mode <em>will</em>
eventually become either the default or even the only option.</p></li>
</ol>
<div class="sourceCode" id="cb500"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb500-1"><a href="#cb500-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">update</span> inplace rt <span class="kw">set</span> j.foo[<span class="dv">1</span>]<span class="op">=</span><span class="dv">22</span> <span class="kw">where</span> <span class="kw">id</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">option</span> strict<span class="op">=</span><span class="dv">0</span>;</span>
<span id="cb500-2"><a href="#cb500-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">2</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb500-3"><a href="#cb500-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb500-4"><a href="#cb500-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> rt;</span>
<span id="cb500-5"><a href="#cb500-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+--------------------------+</span></span>
<span id="cb500-6"><a href="#cb500-6" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | gid  | j                        |</span>
<span id="cb500-7"><a href="#cb500-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+--------------------------+</span></span>
<span id="cb500-8"><a href="#cb500-8" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> |  <span class="dv">123</span> | {<span class="ot">&quot;foo&quot;</span>:[<span class="dv">5</span>,<span class="dv">22</span>,<span class="dv">3</span>,<span class="dv">2</span>]}       |</span>
<span id="cb500-9"><a href="#cb500-9" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> |  <span class="dv">123</span> | {<span class="ot">&quot;foo&quot;</span>:<span class="ot">&quot;bar&quot;</span>}            |</span>
<span id="cb500-10"><a href="#cb500-10" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> |  <span class="dv">123</span> | {<span class="ot">&quot;foo&quot;</span>:[<span class="dv">5</span>,<span class="dv">22</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>]} |</span>
<span id="cb500-11"><a href="#cb500-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+--------------------------+</span></span>
<span id="cb500-12"><a href="#cb500-12" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb500-13"><a href="#cb500-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb500-14"><a href="#cb500-14" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">update</span> inplace rt <span class="kw">set</span> j.foo[<span class="dv">1</span>]<span class="op">=</span><span class="dv">33</span> <span class="kw">where</span> <span class="kw">id</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">option</span> strict<span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb500-15"><a href="#cb500-15" aria-hidden="true" tabindex="-1"></a>ERROR <span class="dv">1064</span> (<span class="dv">42000</span>): <span class="kw">index</span> <span class="st">&#39;rt&#39;</span>: document <span class="dv">2</span>, <span class="fu">value</span> <span class="st">&#39;j.foo[1]&#39;</span>: can <span class="kw">not</span> <span class="kw">update</span> (<span class="kw">not</span> found)</span>
<span id="cb500-16"><a href="#cb500-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb500-17"><a href="#cb500-17" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> rt;</span>
<span id="cb500-18"><a href="#cb500-18" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+--------------------------+</span></span>
<span id="cb500-19"><a href="#cb500-19" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | gid  | j                        |</span>
<span id="cb500-20"><a href="#cb500-20" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+--------------------------+</span></span>
<span id="cb500-21"><a href="#cb500-21" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> |  <span class="dv">123</span> | {<span class="ot">&quot;foo&quot;</span>:[<span class="dv">5</span>,<span class="dv">22</span>,<span class="dv">3</span>,<span class="dv">2</span>]}       |</span>
<span id="cb500-22"><a href="#cb500-22" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> |  <span class="dv">123</span> | {<span class="ot">&quot;foo&quot;</span>:<span class="ot">&quot;bar&quot;</span>}            |</span>
<span id="cb500-23"><a href="#cb500-23" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> |  <span class="dv">123</span> | {<span class="ot">&quot;foo&quot;</span>:[<span class="dv">5</span>,<span class="dv">22</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>]} |</span>
<span id="cb500-24"><a href="#cb500-24" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+--------------------------+</span></span>
<span id="cb500-25"><a href="#cb500-25" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.01</span> sec)</span></code></pre></div>
<h3 id="like-and-ignore-clause">LIKE and IGNORE clause</h3>
<div class="sourceCode" id="cb501"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb501-1"><a href="#cb501-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>statement<span class="op">&gt;</span> [<span class="kw">LIKE</span> <span class="st">&#39;&lt;mask&gt;&#39;</span>] [IGNORE <span class="st">&#39;&lt;mask&gt;&#39;</span>]</span></code></pre></div>
<p>Several SphinxQL statements support optional <code>LIKE</code> and
<code>IGNORE</code> clauses which, respectively, include or exclude the
rows based on a mask.</p>
<p>Mask matching only checks the <strong>first column</strong> that
contains some sort of a key (index name, or variable name, etc). Mask
syntax follows the “SQL style” rather than the “OS style” or the regexp
style; that is:</p>
<ul>
<li><code>%</code> matches any number of characters;</li>
<li><code>_</code> matches exactly 1 character.</li>
</ul>
<p><code>LIKE</code> includes and <code>IGNORE</code> excludes the rows
that match a mask; for example.</p>
<div class="sourceCode" id="cb502"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb502-1"><a href="#cb502-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW <span class="kw">TABLES</span>;</span>
<span id="cb502-2"><a href="#cb502-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------+------+</span></span>
<span id="cb502-3"><a href="#cb502-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">Index</span>      | <span class="kw">Type</span> |</span>
<span id="cb502-4"><a href="#cb502-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------+------+</span></span>
<span id="cb502-5"><a href="#cb502-5" aria-hidden="true" tabindex="-1"></a>| prices     | rt   |</span>
<span id="cb502-6"><a href="#cb502-6" aria-hidden="true" tabindex="-1"></a>| user_stats | rt   |</span>
<span id="cb502-7"><a href="#cb502-7" aria-hidden="true" tabindex="-1"></a>| users      | rt   |</span>
<span id="cb502-8"><a href="#cb502-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------+------+</span></span>
<span id="cb502-9"><a href="#cb502-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb502-10"><a href="#cb502-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-11"><a href="#cb502-11" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW <span class="kw">TABLES</span> <span class="kw">LIKE</span> <span class="st">&#39;user%&#39;</span> IGNORE <span class="st">&#39;%stats&#39;</span>;</span>
<span id="cb502-12"><a href="#cb502-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------+------+</span></span>
<span id="cb502-13"><a href="#cb502-13" aria-hidden="true" tabindex="-1"></a>| <span class="kw">Index</span> | <span class="kw">Type</span> |</span>
<span id="cb502-14"><a href="#cb502-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------+------+</span></span>
<span id="cb502-15"><a href="#cb502-15" aria-hidden="true" tabindex="-1"></a>| users | rt   |</span>
<span id="cb502-16"><a href="#cb502-16" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------+------+</span></span>
<span id="cb502-17"><a href="#cb502-17" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Also note that a regular-characters-only mask means an exact match,
and <strong>not</strong> a substring match, like so.</p>
<div class="sourceCode" id="cb503"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb503-1"><a href="#cb503-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW <span class="kw">TABLES</span> <span class="kw">LIKE</span> <span class="st">&#39;user&#39;</span>;</span>
<span id="cb503-2"><a href="#cb503-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Empty</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Statements that support <code>LIKE</code> and <code>IGNORE</code>
clauses include the following ones. (This list is <strong>not</strong>
yet checked automatically, and might be incomplete.)</p>
<ul>
<li><a href="#describe-syntax">DESCRIBE</a></li>
<li><a href="sphinx2.html#sphinxql-show-agent-status">SHOW AGENT
STATUS</a></li>
<li><a href="sphinx2.html#sphinxql-show-databases">SHOW
DATABASES</a></li>
<li><a href="#show-meta-syntax">SHOW META</a></li>
<li><a href="#show-optimize-status-syntax">SHOW OPTIMIZE STATUS</a></li>
<li><a href="#show-profile-syntax">SHOW PROFILE</a></li>
<li><a href="#show-status-syntax">SHOW STATUS</a></li>
<li><a href="#show-index-status-syntax">SHOW TABLE STATUS</a></li>
<li><a href="sphinx2.html#sphinxql-show-tables">SHOW TABLES</a></li>
</ul>
<h2 id="functions-reference">Functions reference</h2>
<p>This section should eventually contain the complete reference on
functions that are supported in <code>SELECT</code> and other applicable
places.</p>
<p>If the function you’re looking for is not yet documented here, please
refer to the legacy <a href="sphinx2.html#expressions">Sphinx v.2.x
reference</a>. Beware that the legacy reference may not be up to
date.</p>
<p>Here’s a complete list of built-in Sphinx functions.</p>
<ul>
<li><a href="sphinx2.html#expr-func-abs">ABS</a></li>
<li><a href="sphinx2.html#expr-func-all">ALL</a></li>
<li><a href="sphinx2.html#expr-func-any">ANY</a></li>
<li><a href="#annots-function">ANNOTS</a></li>
<li><a href="sphinx2.html#expr-func-atan2">ATAN2</a></li>
<li><a href="sphinx2.html#expr-func-bigint">BIGINT</a></li>
<li><a href="#bigint_set-function">BIGINT_SET</a></li>
<li><a href="#bitcount-function">BITCOUNT</a></li>
<li><a href="sphinx2.html#expr-func-bitdot">BITDOT</a></li>
<li><a href="#bitscmpseq-function">BITSCMPSEQ</a></li>
<li><a href="#bitscountseq-function">BITSCOUNTSEQ</a></li>
<li><a href="#bitsget-function">BITSGET</a></li>
<li><a href="#bm25f">BM25F</a></li>
<li><a href="sphinx2.html#expr-func-ceil">CEIL</a></li>
<li><a href="#coalesce-function">COALESCE</a></li>
<li><a href="#contains-function">CONTAINS</a></li>
<li><a href="#containsany-function">CONTAINSANY</a></li>
<li><a href="sphinx2.html#expr-func-cos">COS</a></li>
<li><a href="sphinx2.html#expr-func-crc32">CRC32</a></li>
<li><a href="#curtime-function">CURTIME</a></li>
<li><a href="sphinx2.html#expr-func-day">DAY</a></li>
<li><a href="#document-function">DOCUMENT</a></li>
<li><a href="#dot-function">DOT</a></li>
<li><a href="sphinx2.html#expr-func-double">DOUBLE</a></li>
<li><a href="#dump-function">DUMP</a></li>
<li><a href="#exist-function">EXIST</a></li>
<li><a href="sphinx2.html#expr-func-exp">EXP</a></li>
<li><a href="#factors-function">FACTORS</a></li>
<li><a href="sphinx2.html#expr-func-fibonacci">FIBONACCI</a></li>
<li><a href="#float-function">FLOAT</a></li>
<li><a href="sphinx2.html#expr-func-floor">FLOOR</a></li>
<li><a href="#fvec-function">FVEC</a></li>
<li><a href="#fvec-function">FVECX</a></li>
<li><a href="#geodist-function">GEODIST</a></li>
<li><a href="sphinx2.html#expr-func-geopoly2d">GEOPOLY2D</a></li>
<li><a href="sphinx2.html#expr-func-greatest">GREATEST</a></li>
<li><a href="#group_count-function">GROUP_COUNT</a></li>
<li><a href="sphinx2.html#expr-func-hour">HOUR</a></li>
<li><a href="sphinx2.html#expr-func-idiv">IDIV</a></li>
<li><a href="sphinx2.html#expr-func-if">IF</a></li>
<li><a href="sphinx2.html#expr-func-in">IN</a></li>
<li><a href="sphinx2.html#expr-func-indexof">INDEXOF</a></li>
<li><a href="#integer-function">INTEGER</a></li>
<li><a href="#intersect_len-function">INTERSECT_LEN</a></li>
<li><a href="sphinx2.html#expr-func-interval">INTERVAL</a></li>
<li><a href="#l1dist-function">L1DIST</a></li>
<li><a href="#l2dist-function">L2DIST</a></li>
<li><a href="sphinx2.html#expr-func-least">LEAST</a></li>
<li><a href="sphinx2.html#expr-func-length">LENGTH</a></li>
<li><a href="sphinx2.html#expr-func-ln">LN</a></li>
<li><a href="sphinx2.html#expr-func-log10">LOG10</a></li>
<li><a href="sphinx2.html#expr-func-log2">LOG2</a></li>
<li><a href="sphinx2.html#expr-func-max">MAX</a></li>
<li><a href="sphinx2.html#expr-func-min">MIN</a></li>
<li><a href="#mingeodist-function">MINGEODIST</a></li>
<li><a href="#mingeodistex-function">MINGEODISTEX</a></li>
<li><a
href="sphinx2.html#expr-func-min-top-sortval">MIN_TOP_SORTVAL</a></li>
<li><a
href="sphinx2.html#expr-func-min-top-weight">MIN_TOP_WEIGHT</a></li>
<li><a href="sphinx2.html#expr-func-minute">MINUTE</a></li>
<li><a href="sphinx2.html#expr-func-month">MONTH</a></li>
<li><a href="sphinx2.html#expr-func-now">NOW</a></li>
<li><a
href="sphinx2.html#expr-func-packedfactors">PACKEDFACTORS</a></li>
<li><a href="sphinx2.html#expr-func-poly2d">POLY2D</a></li>
<li><a href="sphinx2.html#expr-func-pow">POW</a></li>
<li><a href="#pp-function">PP</a></li>
<li><a href="#pqmatched-function">PQMATCHED</a></li>
<li><a href="#query-function">QUERY</a></li>
<li><a href="sphinx2.html#expr-func-rand">RAND</a></li>
<li><a href="sphinx2.html#expr-func-remap">REMAP</a></li>
<li><a href="sphinx2.html#expr-func-second">SECOND</a></li>
<li><a href="sphinx2.html#expr-func-sin">SIN</a></li>
<li><a href="sphinx2.html#expr-func-sint">SINT</a></li>
<li><a href="#slice-functions">SLICEAVG</a></li>
<li><a href="#slice-functions">SLICEMAX</a></li>
<li><a href="#slice-functions">SLICEMIN</a></li>
<li><a href="#snippet-function">SNIPPET</a></li>
<li><a href="sphinx2.html#expr-func-sqrt">SQRT</a></li>
<li><a href="#strpos-function">STRPOS</a></li>
<li><a href="#timediff-function">TIMEDIFF</a></li>
<li><a href="#uint-function">UINT</a></li>
<li><a href="#utc_time-function">UTC_TIME</a></li>
<li><a href="#utc_timestamp-function">UTC_TIMESTAMP</a></li>
<li><a href="#vadd-function">VADD</a></li>
<li><a href="#vmul-function">VMUL</a></li>
<li><a href="#vslice-function">VSLICE</a></li>
<li><a href="#vsort-function">VSORT</a></li>
<li><a href="#vsum-function">VSUM</a></li>
<li><a href="#wordpairctr-function">WORDPAIRCTR</a></li>
<li><a href="sphinx2.html#expr-func-year">YEAR</a></li>
<li><a href="sphinx2.html#expr-func-yearmonth">YEARMONTH</a></li>
<li><a href="sphinx2.html#expr-func-yearmonthday">YEARMONTHDAY</a></li>
<li><a href="#zonespanlist-function">ZONESPANLIST</a></li>
</ul>
<h3 id="annots-function"><code>ANNOTS()</code> function</h3>
<div class="sourceCode" id="cb504"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb504-1"><a href="#cb504-1" aria-hidden="true" tabindex="-1"></a>ANNOTS()</span>
<span id="cb504-2"><a href="#cb504-2" aria-hidden="true" tabindex="-1"></a>ANNOTS(json_array)</span></code></pre></div>
<p><code>ANNOTS()</code> returns the individual matched annotations. In
the no-argument form, it returns a list of annotations indexes matched
in the field (the “numbers” of the matched “lines” within the field). In
the 1-argument form, it slices a given JSON array using that index list,
and returns the slice.</p>
<p>For details, refer either to <a href="#using-annotations">annotations
docs</a> in general, or the <a
href="#accessing-matched-annotations">“Accessing matched annotations”
article</a> specifically.</p>
<h3 id="bigint_set-function"><code>BIGINT_SET()</code> function</h3>
<div class="sourceCode" id="cb505"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb505-1"><a href="#cb505-1" aria-hidden="true" tabindex="-1"></a>BIGINT_SET(const_int1 [, const_int2, <span class="op">..</span>.]])</span></code></pre></div>
<p><code>BIGINT_SET()</code> is a helper function that creates a
constant <code>BIGINT_SET</code> value. As of v.3.5, it is only required
for <code>INTERSECT_LEN()</code>.</p>
<h3 id="bitcount-function"><code>BITCOUNT()</code> function</h3>
<div class="sourceCode" id="cb506"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb506-1"><a href="#cb506-1" aria-hidden="true" tabindex="-1"></a>BITCOUNT(int_expr)</span></code></pre></div>
<p><code>BITCOUNT()</code> returns the number of bits set to 1 in its
argument. The argument must evaluate to any integer type, ie. either
<code>UINT</code> or <code>BIGINT</code> type. This is useful for
processing various bit masks on Sphinx side.</p>
<h3 id="bitscmpseq-function"><code>BITSCMPSEQ()</code> function</h3>
<div class="sourceCode" id="cb507"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb507-1"><a href="#cb507-1" aria-hidden="true" tabindex="-1"></a>BITSCMPSEQ(json.<span class="kw">key</span>, offset, <span class="fu">count</span>, span_len [, bit])</span></code></pre></div>
<p><code>BITSCMPSEQ()</code> checks if a given bitmask subset has a
continuous span of bits. Returns 1 if it does, 0 if not, and -1 if “not
applicable” (eg. not a bitmask).</p>
<p><code>json.key</code> must contain the bitmask; <code>offset</code>
and <code>count</code> define the bits range to check (so the range is
<code>[offset, offset + count)</code>); <code>span_len</code> is the
target span length; and <code>bit</code> is the target bit value, so
either 0 or 1.</p>
<p>Effectively it’s only syntax sugar, because “manual” span length
checks such as
<code>INTERVAL(BITSCOUNTSEQ(json.key, offset, count, bit), 0, span_len) - 1</code>
<strong>must</strong> yield the same result. It should also be
(slightly) faster though.</p>
<p>Here’s an example: let’s check if we have sequences of four and five
consecutive 1s in the first 64 bits of a 96-bit bitmask (stored as three
32-bit integers).</p>
<div class="sourceCode" id="cb508"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb508-1"><a href="#cb508-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span>,</span>
<span id="cb508-2"><a href="#cb508-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> bitscmpseq(j.arr, <span class="dv">0</span>, <span class="dv">64</span>, <span class="dv">4</span>, <span class="dv">1</span>) s4,</span>
<span id="cb508-3"><a href="#cb508-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> bitscmpseq(j.arr, <span class="dv">0</span>, <span class="dv">64</span>, <span class="dv">5</span>, <span class="dv">1</span>) s5 <span class="kw">from</span> test;</span>
<span id="cb508-4"><a href="#cb508-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+------+------+</span></span>
<span id="cb508-5"><a href="#cb508-5" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | j                                | s4   | s5   |</span>
<span id="cb508-6"><a href="#cb508-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+------+------+</span></span>
<span id="cb508-7"><a href="#cb508-7" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | {<span class="ot">&quot;arr&quot;</span>:[<span class="dv">15791776</span>,<span class="dv">1727067808</span>,<span class="op">-</span><span class="dv">1</span>]} |    <span class="dv">1</span> |    <span class="dv">0</span> |</span>
<span id="cb508-8"><a href="#cb508-8" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">124</span> | {<span class="ot">&quot;arr&quot;</span>:<span class="ot">&quot;foobar&quot;</span>}                 |   <span class="op">-</span><span class="dv">1</span> |   <span class="op">-</span><span class="dv">1</span> |</span>
<span id="cb508-9"><a href="#cb508-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+------+------+</span></span>
<span id="cb508-10"><a href="#cb508-10" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="bitscountseq-function"><code>BITSCOUNTSEQ()</code> function</h3>
<div class="sourceCode" id="cb509"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb509-1"><a href="#cb509-1" aria-hidden="true" tabindex="-1"></a>BITSCOUNTSEQ(json.<span class="kw">key</span>, offset, <span class="fu">count</span> [, bit])</span></code></pre></div>
<p><code>BITSCOUNTSEQ()</code> returns the longest continuous bits span
length within a given bitmask subset, or -1 when “not applicable” (eg.
not a bitmask).</p>
<p>First <code>json.key</code> argument <strong>must</strong> contain
the bitmask, ie. an integer array. Moreover, the values
<strong>must</strong> have the same type. <code>int32</code> and
<code>int64</code> mixes are <strong>not</strong> treated as bitmasks.
The <code>[offset, offset + count)</code> range <strong>must
not</strong> be out of bounds, ie. it must select at least 1 actual
bitmask bit, and it must not start at a negative offset. If any one of
these conditions does not hold, <code>BITSCOUNTSEQ()</code> returns
-1.</p>
<p>Example, let’s check our what are our longest 0s and 1s spans, within
the first 64 bits of a 96-bit bitmask (stored as three 32-bit
integers).</p>
<div class="sourceCode" id="cb510"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb510-1"><a href="#cb510-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span>,</span>
<span id="cb510-2"><a href="#cb510-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> bitscountseq(j.arr, <span class="dv">0</span>, <span class="dv">64</span>, <span class="dv">0</span>) c0,</span>
<span id="cb510-3"><a href="#cb510-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> bitscountseq(j.arr, <span class="dv">0</span>, <span class="dv">64</span>, <span class="dv">1</span>) c1 <span class="kw">from</span> test;</span>
<span id="cb510-4"><a href="#cb510-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+------+------+</span></span>
<span id="cb510-5"><a href="#cb510-5" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | j                                | c0   | c1   |</span>
<span id="cb510-6"><a href="#cb510-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+------+------+</span></span>
<span id="cb510-7"><a href="#cb510-7" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | {<span class="ot">&quot;arr&quot;</span>:[<span class="dv">15791776</span>,<span class="dv">1727067808</span>,<span class="op">-</span><span class="dv">1</span>]} |   <span class="dv">13</span> |    <span class="dv">4</span> |</span>
<span id="cb510-8"><a href="#cb510-8" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">124</span> | {<span class="ot">&quot;arr&quot;</span>:<span class="ot">&quot;foobar&quot;</span>}                 |   <span class="op">-</span><span class="dv">1</span> |   <span class="op">-</span><span class="dv">1</span> |</span>
<span id="cb510-9"><a href="#cb510-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+------+------+</span></span>
<span id="cb510-10"><a href="#cb510-10" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="bitsget-function"><code>BITSGET()</code> function</h3>
<div class="sourceCode" id="cb511"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb511-1"><a href="#cb511-1" aria-hidden="true" tabindex="-1"></a>BITSGET(json.<span class="kw">key</span>, offset, <span class="fu">count</span>)</span></code></pre></div>
<p><code>BITSGET()</code> returns a slice of up to 64 bits from a given
bitmask, as a <code>BIGINT</code> integer.</p>
<p>First <code>json.key</code> argument <strong>must</strong> contain
the bitmask, ie. an integer array. When it’s not, <code>BITSGET()</code>
returns zero.</p>
<p><code>offset</code> is the bit offset in the bitmask, and
<code>count</code> is the number of bits to return. The selected
<code>[offset, offset + count)</code> range must fit
<strong>completely</strong> within the bitmask! Also, <code>count</code>
must be from 1 to 64, inclusive. Otherwise, <code>BITSGET()</code>
returns 0.</p>
<p>So in other words, it returns 1 to 64 <strong>existing</strong> bits.
But if you try to fetch even a single non-existing bit, then boom, zero.
Here’s an example that tries to fetch 32 bits from different locations
in a 96-bit bitmask.</p>
<div class="sourceCode" id="cb512"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb512-1"><a href="#cb512-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span>,</span>
<span id="cb512-2"><a href="#cb512-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> bitsget(j.arr, <span class="dv">16</span>, <span class="dv">32</span>) b16,</span>
<span id="cb512-3"><a href="#cb512-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> bitsget(j.arr, <span class="dv">64</span>, <span class="dv">32</span>) b64,</span>
<span id="cb512-4"><a href="#cb512-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> bitsget(j.arr, <span class="dv">65</span>, <span class="dv">32</span>) b65 <span class="kw">from</span> test;</span>
<span id="cb512-5"><a href="#cb512-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+------------+------------+------+</span></span>
<span id="cb512-6"><a href="#cb512-6" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | j                                | b16        | b64        | b65  |</span>
<span id="cb512-7"><a href="#cb512-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+------------+------------+------+</span></span>
<span id="cb512-8"><a href="#cb512-8" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | {<span class="ot">&quot;arr&quot;</span>:[<span class="dv">15791776</span>,<span class="dv">1727067808</span>,<span class="op">-</span><span class="dv">1</span>]} | <span class="dv">4137681136</span> | <span class="dv">4294967295</span> |    <span class="dv">0</span> |</span>
<span id="cb512-9"><a href="#cb512-9" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">124</span> | {<span class="ot">&quot;arr&quot;</span>:<span class="ot">&quot;foobar&quot;</span>}                 |          <span class="dv">0</span> |          <span class="dv">0</span> |    <span class="dv">0</span> |</span>
<span id="cb512-10"><a href="#cb512-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------------------------+------------+------------+------+</span></span>
<span id="cb512-11"><a href="#cb512-11" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="coalesce-function"><code>COALESCE()</code> function</h3>
<div class="sourceCode" id="cb513"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb513-1"><a href="#cb513-1" aria-hidden="true" tabindex="-1"></a><span class="fu">COALESCE</span>(json.<span class="kw">key</span>, numeric_expr)</span></code></pre></div>
<p><code>COALESCE()</code> function returns either the first argument if
it is not <code>NULL</code>, or the second argument otherwise.</p>
<p>As pretty much everything except JSON is not nullable in Sphinx, the
first argument must be a JSON key.</p>
<p>The second argument is currently limited to numeric types. Moreover,
at the moment <code>COALESCE()</code> always returns <code>float</code>
typed result, thus forcibly casting whatever argument it returns to
float. Beware that this loses precision when returning bigger integer
values from either argument!</p>
<p>The second argument does <em>not</em> need to be a constant. An
arbitrary expression is allowed.</p>
<p>Examples:</p>
<div class="sourceCode" id="cb514"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb514-1"><a href="#cb514-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="fu">coalesce</span>(j.existing, <span class="dv">123</span>) val</span>
<span id="cb514-2"><a href="#cb514-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">from</span> test1 <span class="kw">where</span> <span class="kw">id</span><span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb514-3"><a href="#cb514-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+</span></span>
<span id="cb514-4"><a href="#cb514-4" aria-hidden="true" tabindex="-1"></a>| val       |</span>
<span id="cb514-5"><a href="#cb514-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+</span></span>
<span id="cb514-6"><a href="#cb514-6" aria-hidden="true" tabindex="-1"></a>| <span class="fl">1107024.0</span> |</span>
<span id="cb514-7"><a href="#cb514-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+</span></span>
<span id="cb514-8"><a href="#cb514-8" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb514-9"><a href="#cb514-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb514-10"><a href="#cb514-10" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="fu">coalesce</span>(j.missing, <span class="dv">123</span>) val</span>
<span id="cb514-11"><a href="#cb514-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">from</span> test1 <span class="kw">where</span> <span class="kw">id</span><span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb514-12"><a href="#cb514-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------+</span></span>
<span id="cb514-13"><a href="#cb514-13" aria-hidden="true" tabindex="-1"></a>| val   |</span>
<span id="cb514-14"><a href="#cb514-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------+</span></span>
<span id="cb514-15"><a href="#cb514-15" aria-hidden="true" tabindex="-1"></a>| <span class="fl">123.0</span> |</span>
<span id="cb514-16"><a href="#cb514-16" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------+</span></span>
<span id="cb514-17"><a href="#cb514-17" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb514-18"><a href="#cb514-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb514-19"><a href="#cb514-19" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="fu">coalesce</span>(j.missing, <span class="dv">16777217</span>) val</span>
<span id="cb514-20"><a href="#cb514-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">from</span> test1 <span class="kw">where</span> <span class="kw">id</span><span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb514-21"><a href="#cb514-21" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------+</span></span>
<span id="cb514-22"><a href="#cb514-22" aria-hidden="true" tabindex="-1"></a>| val        |</span>
<span id="cb514-23"><a href="#cb514-23" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------+</span></span>
<span id="cb514-24"><a href="#cb514-24" aria-hidden="true" tabindex="-1"></a>| <span class="fl">16777216.0</span> |</span>
<span id="cb514-25"><a href="#cb514-25" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------+</span></span>
<span id="cb514-26"><a href="#cb514-26" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb514-27"><a href="#cb514-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb514-28"><a href="#cb514-28" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="fu">coalesce</span>(j.missing, <span class="fu">sin</span>(<span class="kw">id</span>)<span class="op">+</span><span class="dv">3</span>) val <span class="kw">from</span> lj <span class="kw">where</span> <span class="kw">id</span><span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb514-29"><a href="#cb514-29" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------+</span></span>
<span id="cb514-30"><a href="#cb514-30" aria-hidden="true" tabindex="-1"></a>| val        |</span>
<span id="cb514-31"><a href="#cb514-31" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------+</span></span>
<span id="cb514-32"><a href="#cb514-32" aria-hidden="true" tabindex="-1"></a>| <span class="fl">3.84147096</span> |</span>
<span id="cb514-33"><a href="#cb514-33" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------+</span></span>
<span id="cb514-34"><a href="#cb514-34" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="contains-function"><code>CONTAINS()</code> function</h3>
<div class="sourceCode" id="cb515"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb515-1"><a href="#cb515-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CONTAINS</span>(POLY2D(<span class="op">..</span>.), x, y)</span>
<span id="cb515-2"><a href="#cb515-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CONTAINS</span>(GEOPOLY2D(<span class="op">..</span>.), lat, lon)</span></code></pre></div>
<p><code>CONTAINS()</code> function checks whether its argument point
(defined by the 2nd and 3rd arguments) lies within the given polygon,
and returns 1 if it does, or 0 otherwise.</p>
<p>Two types of polygons are supported, regular “plain” 2D polygons
(that are just checked against the point as is), and special “geo”
polygons (that might require further processing).</p>
<p>In the <code>POLY2D()</code> case there are no restrictions on the
input data, both polygons and points are just “pure” 2D objects.
Naturally you must use the same units and axis order, but that’s it.</p>
<p>With regards to geosearches, you can use <code>POLY2D()</code> for
“small” polygons with sides up to 500 km (aka 300 miles). According to
our tests, the Earth curvature introduces a relative error of just 0.03%
at that lengths, meaning that results might be off by just 3 meters (or
less) for polygons with sides up to 10 km.</p>
<p>Keep an eye out how this error only applies to sides, to individual
segments. Even if you have a really huge polygon (say over 3000 km in
diameter) but built with small enough segments (say under 10 km each),
the “in or out” error will <em>still</em> be under just 3 meters for the
entire huge polygon!</p>
<p>When in doubt and/or dealing with huge distances, you should use
<code>GEOPOLY2D()</code> which checks every segment length against the
500 km threshold, and tessellates (splits) too large segments in smaller
parts, properly accounting for the Earth curvature.</p>
<p>Small-sided polygons must pass through <code>GEOPOLY2D()</code>
unchanged and must produce exactly the same result as
<code>POLY2D()</code> would. There’s a tiny overhead for the length
check itself, of course, but in most all cases it’s a negligible
one.</p>
<h3 id="containsany-function"><code>CONTAINSANY()</code> function</h3>
<div class="sourceCode" id="cb516"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb516-1"><a href="#cb516-1" aria-hidden="true" tabindex="-1"></a>CONTAINSANY(POLY2D(<span class="op">..</span>.), json.<span class="kw">key</span>)</span>
<span id="cb516-2"><a href="#cb516-2" aria-hidden="true" tabindex="-1"></a>CONTAINSANY(GEOPOLY2D(<span class="op">..</span>.), json.<span class="kw">key</span>)</span></code></pre></div>
<p><code>CONTAINSANY()</code> checks if a 2D polygon specified in the
1st argument contains any of the 2D points stored in the 2nd
argument.</p>
<p>The 2nd argument must be a JSON array of 2D coordinate pairs, that
is, an even number of float values. They must be in the same order and
units as the polygon.</p>
<p>So with <code>POLY2D()</code> you can choose whatever units (and even
axes order), just ensure you use the same units (and axes) in both your
polygon and JSON data.</p>
<p>However, with <code>GEOPOLY2D()</code> you <strong>must</strong> keep
all your data in the (lat,lon) order, you <strong>must</strong> use
degrees, and you <strong>must</strong> use the properly normalized
ranges (-90 to 90 for latitudes and -180 to 180 for longitudes
respectively), because that’s what <code>GEOPOLY2D()</code> expects and
emits. All your <code>GEOPOLY2D()</code> arguments and your JSON data
must be in that format: degrees, lat/lon order, normalized.</p>
<p>Examples:</p>
<div class="sourceCode" id="cb517"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb517-1"><a href="#cb517-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> j, containsany(poly2d(<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>,<span class="dv">1</span>, <span class="dv">1</span>,<span class="dv">1</span>, <span class="dv">1</span>,<span class="dv">0</span>), j.points) q <span class="kw">from</span> test;</span>
<span id="cb517-2"><a href="#cb517-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------------+------+</span></span>
<span id="cb517-3"><a href="#cb517-3" aria-hidden="true" tabindex="-1"></a>| j                            | q    |</span>
<span id="cb517-4"><a href="#cb517-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------------+------+</span></span>
<span id="cb517-5"><a href="#cb517-5" aria-hidden="true" tabindex="-1"></a>| {<span class="ot">&quot;points&quot;</span>:[<span class="fl">0.3</span>,<span class="fl">0.5</span>]}         |    <span class="dv">1</span> |</span>
<span id="cb517-6"><a href="#cb517-6" aria-hidden="true" tabindex="-1"></a>| {<span class="ot">&quot;points&quot;</span>:[<span class="fl">0.4</span>,<span class="fl">1.7</span>]}         |    <span class="dv">0</span> |</span>
<span id="cb517-7"><a href="#cb517-7" aria-hidden="true" tabindex="-1"></a>| {<span class="ot">&quot;points&quot;</span>:[<span class="fl">0.3</span>,<span class="fl">0.5</span>,<span class="fl">0.4</span>,<span class="fl">1.7</span>]} |    <span class="dv">1</span> |</span>
<span id="cb517-8"><a href="#cb517-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------------+------+</span></span>
<span id="cb517-9"><a href="#cb517-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="curtime-function"><code>CURTIME()</code> function</h3>
<div class="sourceCode" id="cb518"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb518-1"><a href="#cb518-1" aria-hidden="true" tabindex="-1"></a>CURTIME()</span></code></pre></div>
<p><code>CURTIME()</code> returns the current server time, in server
time zone, as a string in <code>HH:MM:SS</code> format. It was added for
better MySQL connector compatibility.</p>
<h3 id="document-function"><code>DOCUMENT()</code> function</h3>
<div class="sourceCode" id="cb519"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb519-1"><a href="#cb519-1" aria-hidden="true" tabindex="-1"></a>DOCUMENT([{field1 [, field2, <span class="op">..</span>.]]}])</span></code></pre></div>
<p><code>DOCUMENT()</code> is a helper function that retrieves full-text
document fields from docstore, and returns those as an field-to-content
map that can then be passed to other built-in functions. It naturally
requires docstore, and its only usage is now limited to passing it to
<code>SNIPPET()</code> calls, as follows.</p>
<div class="sourceCode" id="cb520"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb520-1"><a href="#cb520-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, SNIPPET(DOCUMENT(), <span class="kw">QUERY</span>())</span>
<span id="cb520-2"><a href="#cb520-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> test <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>)</span>
<span id="cb520-3"><a href="#cb520-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb520-4"><a href="#cb520-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, SNIPPET(DOCUMENT({title,<span class="kw">body</span>}), <span class="kw">QUERY</span>())</span>
<span id="cb520-5"><a href="#cb520-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> test <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>)</span></code></pre></div>
<p>Without arguments, it fetches all the stored full-text fields. In the
1-argument form, it expects a list of fields, and fetches just the
specified ones.</p>
<p>Refer to the <a href="#using-docstore">DocStore documentation
section</a> for more details.</p>
<h3 id="dot-function"><code>DOT()</code> function</h3>
<div class="sourceCode" id="cb521"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb521-1"><a href="#cb521-1" aria-hidden="true" tabindex="-1"></a>DOT(vector1, vector2)</span>
<span id="cb521-2"><a href="#cb521-2" aria-hidden="true" tabindex="-1"></a>vector <span class="op">=</span> {json.<span class="kw">key</span> | array_attr | FVEC(<span class="op">..</span>.)}</span></code></pre></div>
<p><code>DOT()</code> function computes a dot product over two vector
arguments.</p>
<p>Vectors can be taken either from JSON, or from array attributes, or
specified as constants using <code>FVEC()</code> function. All
combinations should generally work.</p>
<p>The result type is always <code>FLOAT</code> for consistency and
simplicity. (According to our benchmarks, performance gain from using
<code>UINT</code> or <code>BIGINT</code> for the result type, where
applicable, is pretty much nonexistent anyway.)</p>
<p>Note that <em>internal</em> calculations are optimized for specific
input argument types anyway. For instance, <code>int8</code> vs
<code>int8</code> vectors should be quite noticeably faster than
<code>float</code> by <code>double</code> vectors containing the same
data, both because integer multiplication is less expensive, and because
<code>int8</code> would utilize 6x less memory.</p>
<p>So as a rule of thumb, use the narrowest possible type, that yields
both better RAM use and better performance.</p>
<p>When one of the arguments is either NULL, or not a numeric vector
(that can very well happen with JSON), or when both arguments are
vectors of different sizes, <code>DOT()</code> returns 0.</p>
<p>On Intel, we have SIMD optimized codepaths that automatically engage
where possible. So for best performance, use SIMD-friendly vector
dimensions (that means multiples of at least 16 bytes in all cases,
multiples of 32 bytes on AVX2 CPUs, etc).</p>
<h3 id="dump-function"><code>DUMP()</code> function</h3>
<div class="sourceCode" id="cb522"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb522-1"><a href="#cb522-1" aria-hidden="true" tabindex="-1"></a><span class="fu">DUMP</span>(json[.<span class="kw">key</span>])</span></code></pre></div>
<p><code>DUMP()</code> formats JSON (either the entire field or a given
key) with additional internal type information.</p>
<p>This is a semi-internal function, intended for manual troubleshooting
only. Hence, its output format is <em>not</em> well-formed JSON, it may
(and will) change arbitrarily, and you must <em>not</em> rely on that
format anyhow.</p>
<p>That said, <code>PP()</code> function still works with
<code>DUMP()</code> anyway, and pretty-prints the default compact output
of that format, too.</p>
<div class="sourceCode" id="cb523"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb523-1"><a href="#cb523-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, j, PP(<span class="fu">DUMP</span>(j)) <span class="kw">FROM</span> rt \G</span>
<span id="cb523-2"><a href="#cb523-2" aria-hidden="true" tabindex="-1"></a><span class="op">***************************</span> <span class="fl">1.</span> <span class="kw">row</span> <span class="op">***************************</span></span>
<span id="cb523-3"><a href="#cb523-3" aria-hidden="true" tabindex="-1"></a>         <span class="kw">id</span>: <span class="dv">123</span></span>
<span id="cb523-4"><a href="#cb523-4" aria-hidden="true" tabindex="-1"></a>          j: {<span class="ot">&quot;foo&quot;</span>:<span class="ot">&quot;bar&quot;</span>,<span class="ot">&quot;test&quot;</span><span class="ch">:1</span><span class="fl">.23</span>}</span>
<span id="cb523-5"><a href="#cb523-5" aria-hidden="true" tabindex="-1"></a>pp(<span class="fu">dump</span>(j)): (root){</span>
<span id="cb523-6"><a href="#cb523-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">&quot;foo&quot;</span>: (string)<span class="ot">&quot;bar&quot;</span>,</span>
<span id="cb523-7"><a href="#cb523-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">&quot;test&quot;</span>: (<span class="dt">double</span>)<span class="fl">1.23</span></span>
<span id="cb523-8"><a href="#cb523-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb523-9"><a href="#cb523-9" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="exist-function"><code>EXIST()</code> function</h3>
<div class="sourceCode" id="cb524"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb524-1"><a href="#cb524-1" aria-hidden="true" tabindex="-1"></a>EXIST(<span class="st">&#39;attr_name&#39;</span>, default_value)</span></code></pre></div>
<p><code>EXIST()</code> lets you substitute non-existing numeric columns
with a default value. That may be handy when searching through several
indexes with different schemas.</p>
<p>It returns either the column value in those indexes that have the
column, or the default value in those that do not. So it’s rather
useless for single-index searches.</p>
<p>The first argument must be a quoted string with a column name. The
second one must be a numeric default value (either integer or float).
When the column does exist, it must also be of a matching type.</p>
<div class="sourceCode" id="cb525"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb525-1"><a href="#cb525-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, EXIST(v2intcol, <span class="dv">0</span>) <span class="kw">FROM</span> indexv1, indexv2</span></code></pre></div>
<h3 id="factors-function"><code>FACTORS()</code> function</h3>
<div class="sourceCode" id="cb526"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb526-1"><a href="#cb526-1" aria-hidden="true" tabindex="-1"></a>FACTORS([<span class="st">&#39;alt_keywords&#39;</span>], [{<span class="kw">option</span><span class="op">=</span><span class="fu">value</span> [, option2<span class="op">=</span>value2, <span class="op">..</span>.]}])</span>
<span id="cb526-2"><a href="#cb526-2" aria-hidden="true" tabindex="-1"></a>FACTORS(<span class="op">..</span>.)[.<span class="kw">key</span>[.<span class="kw">key</span>[<span class="op">..</span>.]]]</span></code></pre></div>
<p><code>FACTORS()</code> provides both SQL statements and UDFs with
access to the dynamic text ranking factors (aka signals) that Sphinx
expression ranker computes. This function is key to advanced ranking
implementation.</p>
<p>Internally in the engine the signals are stored in an efficient
binary format, one signals blob per match. <code>FACTORS()</code> is
essentially an accessor to those.</p>
<p>When used directly, ie. in a <code>SELECT FACTORS(...)</code>
statement, the signals blob simply gets formatted as a JSON string.</p>
<p>However, when <code>FACTORS()</code> is passed to an UDF, the UDF
receives a special <code>SPH_UDF_TYPE_FACTORS</code> type with an
efficient direct access API instead. Very definitely not a string, as
that would obliterate the performance. See the <a
href="#using-factors-in-udfs">“Using FACTORS() in UDFs”</a> section for
details.</p>
<p>Now, in its simplest form you can simply invoke
<code>FACTORS()</code> and get all the signals. But as the syntax spec
suggests, there’s more than just that.</p>
<ul>
<li><p><code>FACTORS()</code> can take a string argument with
alternative keywords, and rank matches against those <em>arbitrary</em>
keywords rather than the original query from <code>MATCH()</code>.
Moreover, in that form <code>FACTORS()</code> works even with non-text
queries. Refer to <a href="#xfactors">“Ranking: using different
keywords…”</a> section for more details on that.</p></li>
<li><p><code>FACTORS()</code> can take an options map argument that
fine-tunes the ranking behavior. As of v.3.5, it supports the following
two performance flags.</p>
<ul>
<li><code>no_atc=1</code> disables the <code>atc</code> signal
evaluation.</li>
<li><code>no_decay=1</code> disables the <code>phrase_decayXX</code>
signals evaluation.</li>
</ul></li>
<li><p><code>FACTORS()</code> with a key path suffix (aka subscript) can
access individual signals, and return the respective numeric values
(typed <code>UINT</code> or <code>FLOAT</code>). This is primarily
intended to simplify researching or debugging individual signals, as the
full <code>FACTORS()</code> output can get pretty large.</p></li>
</ul>
<p>Examples!</p>
<div class="sourceCode" id="cb527"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb527-1"><a href="#cb527-1" aria-hidden="true" tabindex="-1"></a># alt keywords</span>
<span id="cb527-2"><a href="#cb527-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, FACTORS(<span class="st">&#39;here there be alternative keywords&#39;</span>)</span>
<span id="cb527-3"><a href="#cb527-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> test <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>)</span>
<span id="cb527-4"><a href="#cb527-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb527-5"><a href="#cb527-5" aria-hidden="true" tabindex="-1"></a># <span class="fu">max</span> perf options</span>
<span id="cb527-6"><a href="#cb527-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, FACTORS({no_act<span class="op">=</span><span class="dv">1</span>, no_decay<span class="op">=</span><span class="dv">1</span>}</span>
<span id="cb527-7"><a href="#cb527-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> test <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>)</span>
<span id="cb527-8"><a href="#cb527-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb527-9"><a href="#cb527-9" aria-hidden="true" tabindex="-1"></a># <span class="dt">single</span> field signal <span class="kw">access</span>, via name</span>
<span id="cb527-10"><a href="#cb527-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, FACTORS().factors().fields.title.wlccs</span>
<span id="cb527-11"><a href="#cb527-11" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> test <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>)</span>
<span id="cb527-12"><a href="#cb527-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb527-13"><a href="#cb527-13" aria-hidden="true" tabindex="-1"></a># <span class="dt">single</span> field signal <span class="kw">access</span>, via <span class="dt">number</span></span>
<span id="cb527-14"><a href="#cb527-14" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, FACTORS().factors().fields[<span class="dv">2</span>].wlccs</span>
<span id="cb527-15"><a href="#cb527-15" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> test <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>)</span>
<span id="cb527-16"><a href="#cb527-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb527-17"><a href="#cb527-17" aria-hidden="true" tabindex="-1"></a># everything everywhere <span class="kw">all</span> <span class="kw">at</span> once</span>
<span id="cb527-18"><a href="#cb527-18" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, FACTORS(<span class="st">&#39;terra incognita&#39;</span>, {no_atc<span class="op">=</span><span class="dv">1</span>}).fields.title.atc</span>
<span id="cb527-19"><a href="#cb527-19" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> test <span class="kw">WHERE</span> MATCH(<span class="st">&#39;hello world&#39;</span>)</span></code></pre></div>
<p><code>FACTORS()</code> requires an expression ranker, and
auto-switches to that ranker (even with the proper default expression),
unless there was an explicit ranker specified.</p>
<p>JSON output from <code>FACTORS()</code> defaults to compact format,
and you can use <code>PP(FACTORS())</code> to pretty-print that.</p>
<p>As a side note, in the distributed search case agents send the
signals blobs in the binary format, for performance reasons.</p>
<p>Specific signal names to use with the <code>FACTORS().xxx</code>
subscript syntax can be found in the table in <a
href="#ranking-factors">“Ranking: factors”</a>. Subscripts should be
able to access most of what the <code>ranker=expr('...')</code>
expression can access, except for the parametrized signals such as
<code>bm25()</code>. Namely!</p>
<ol type="1">
<li>All document-level signals, such as <code>FACTORS().bm15</code>,
etc.</li>
<li>Two query-level signals, <code>FACTORS().query_tokclass_mask</code>
and <code>FACTORS().query_word_count</code>.</li>
<li>Most field-level signals, such as
<code>FACTORS().fields[0].has_digit_hits</code>,
<code>FACTORS().fields.title.phrase_decay10</code>, etc.</li>
</ol>
<p>Fields must be accessed via <code>.fields</code> subscript, and after
that, either via their names as in
<code>FACTORS().fields.title.phrase_decay10</code> example, or via their
indexes as in <code>FACTORS().fields[0].has_digit_hits</code> example.
The indexes match the declaration and the order you get out of the
<code>DESCRIBE</code> statement.</p>
<p>Last but not least, <code>FACTORS()</code> works okay with
subselects, and that enables <a
href="#ranking-two-stage-ranking">two-stage ranking</a>, ie. using a
faster ranking model for all the matches, then reranking the top-N
results using a slower but better model. More details in the respective
section.</p>
<h3 id="float-function"><code>FLOAT()</code> function</h3>
<div class="sourceCode" id="cb528"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb528-1"><a href="#cb528-1" aria-hidden="true" tabindex="-1"></a><span class="dt">FLOAT</span>(arg)</span></code></pre></div>
<p>This function converts its argument to <code>FLOAT</code> type, ie.
32-bit floating point value.</p>
<h3 id="fvec-function"><code>FVEC()</code> function</h3>
<div class="sourceCode" id="cb529"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb529-1"><a href="#cb529-1" aria-hidden="true" tabindex="-1"></a>FVEC(const1 [, const2, <span class="op">..</span>.])</span>
<span id="cb529-2"><a href="#cb529-2" aria-hidden="true" tabindex="-1"></a>FVEC(json.<span class="kw">key</span>)</span></code></pre></div>
<p><code>FVEC()</code> function makes a vector out of (constant-ish)
floats. Two current usecases are:</p>
<ul>
<li>to define a constant vector for subsequent use with <a
href="#dot-function"><code>DOT()</code></a></li>
<li>to pass optimized scalar vectors stored in JSON to UDFs and vector
functions</li>
</ul>
<p>Note that <code>FVEC()</code> function currently can <em>not</em>
make a vector out of arbitrary non-constant expressions. For that, use
<a href="#fvecx-function"><code>FVECX()</code> function</a>.</p>
<p><strong>Constant vector form.</strong></p>
<p>In the first form, the arguments are a list of numeric constants. And
note that there <em>can</em> be a difference whether we use integers or
floats here!</p>
<p>When both arguments to <code>DOT()</code> are integer vectors,
<code>DOT()</code> can use an optimized integer implementation, and to
define such a vector using <code>FVEC()</code>, you should only use
integers.</p>
<p>The rule of thumb with vectors generally is: just use the narrowest
possible type. Because that way, extra optimizations just might kick in.
And the other way, they very definitely will not.</p>
<p>For instance, the optimizer is allowed to widen
<code>FVEC(1,2,3,4)</code> from integers to floats alright, no surprise
there. Now, in <em>this</em> case it is also allowed to narrow the
resulting <code>float</code> vector back to integers where applicable,
because we can know that all the <em>original</em> values were integers
before widening.</p>
<p>And narrowing down from the floating point form like
<code>FVEC(1.0, 2.0, 3.0, 4.0)</code> to integers is strictly
prohibited. So even though the values actually are the same, in the
first case additional integer-only optimizations can be used, and in the
second case they can’t.</p>
<p><strong>JSON value wrapper form.</strong></p>
<p>In the second form, the only argument must be a JSON key, and the
result is only intended as an argument for either UDF functions, or for
vector functions (such as <code>VADD()</code> or <code>VSORT()</code>).
Because otherwise the wrapper should not be needed, and you should be
able to simply use the key itself.</p>
<p>The associated JSON value type gets checked; optimized float vectors
are passed to calling functions as is (zero copying and thus most
effieciently); optimized integer vectors are converted to floats; and
all other types are replaced with a null vector (zero length and no data
pointer). Thus, the respective UDF type always stays
<code>SPH_UDF_TYPE_FLOAT_VEC</code>, even when the underlying JSON key
stores integers.</p>
<p>Note that this form was originally designed as a fast accessor for
UDFs that just passes <code>float</code> vectors to them, to avoid any
data copying and conversion. And it still is <strong>not</strong>
intended to be a generic conversion tool (for that, consider
<code>FVECX()</code> that builds a vector out of arbitrarily
expressions).</p>
<p>That’s why if you attempt to wrap a JSON value that does not convert
easily enough, null vector is returned. For one, beware of mixed vectors
that store numeric values of different types, or even optimized
<code>double</code> vectors. <code>FVEC()</code> will not convert those
and that’s intentional, for performance reasons.</p>
<div class="sourceCode" id="cb530"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb530-1"><a href="#cb530-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">insert</span> <span class="kw">into</span> test (<span class="kw">id</span>, j) <span class="kw">values</span></span>
<span id="cb530-2"><a href="#cb530-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> (<span class="dv">4</span>, <span class="st">&#39;{&quot;foo&quot;: [3, 141, 592]}&#39;</span>),</span>
<span id="cb530-3"><a href="#cb530-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> (<span class="dv">5</span>, <span class="st">&#39;{&quot;foo&quot;: [3.0, 141.0, 592.0]}&#39;</span>),</span>
<span id="cb530-4"><a href="#cb530-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> (<span class="dv">6</span>, <span class="st">&#39;{&quot;foo&quot;: [3, 141.0, 592]}&#39;</span>);</span>
<span id="cb530-5"><a href="#cb530-5" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">3</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb530-6"><a href="#cb530-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb530-7"><a href="#cb530-7" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, to_string(vmul(fvec(j.foo), <span class="fl">1.5</span>)) <span class="kw">from</span> test;</span>
<span id="cb530-8"><a href="#cb530-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------------------------------+</span></span>
<span id="cb530-9"><a href="#cb530-9" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | to_string(vmul(fvec(j.foo), <span class="fl">1.5</span>)) |</span>
<span id="cb530-10"><a href="#cb530-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------------------------------+</span></span>
<span id="cb530-11"><a href="#cb530-11" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">4</span> | <span class="fl">4.5</span>, <span class="fl">211.5</span>, <span class="fl">888.0</span>                 |</span>
<span id="cb530-12"><a href="#cb530-12" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">5</span> | <span class="fl">4.5</span>, <span class="fl">211.5</span>, <span class="fl">888.0</span>                 |</span>
<span id="cb530-13"><a href="#cb530-13" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">6</span> | <span class="kw">NULL</span>                              |</span>
<span id="cb530-14"><a href="#cb530-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------------------------------+</span></span>
<span id="cb530-15"><a href="#cb530-15" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb530-16"><a href="#cb530-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb530-17"><a href="#cb530-17" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, <span class="fu">dump</span>(j.foo) <span class="kw">from</span> test;</span>
<span id="cb530-18"><a href="#cb530-18" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------------------------------------------------+</span></span>
<span id="cb530-19"><a href="#cb530-19" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | <span class="fu">dump</span>(j.foo)                                      |</span>
<span id="cb530-20"><a href="#cb530-20" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------------------------------------------------+</span></span>
<span id="cb530-21"><a href="#cb530-21" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">4</span> | (int32_vector)[<span class="dv">3</span>,<span class="dv">141</span>,<span class="dv">592</span>]                        |</span>
<span id="cb530-22"><a href="#cb530-22" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">5</span> | (float_vector)[<span class="fl">3.0</span>,<span class="fl">141.0</span>,<span class="fl">592.0</span>]                  |</span>
<span id="cb530-23"><a href="#cb530-23" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">6</span> | (mixed_vector)[(int32)<span class="dv">3</span>,(<span class="dt">float</span>)<span class="fl">141.0</span>,(int32)<span class="dv">592</span>] |</span>
<span id="cb530-24"><a href="#cb530-24" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+--------------------------------------------------+</span></span>
<span id="cb530-25"><a href="#cb530-25" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>For the record, when in doubt, use <code>DUMP()</code> to examine the
actual JSON types. In terms of <code>DUMP()</code> output types,
<code>FVEC(jsoncol.key)</code> supports <code>float_vector</code> (the
best), <code>int32_vector</code>, <code>int64_vector</code>, and
<code>int8_vector</code>; everything else must return a null vector.</p>
<h3 id="fvecx-function"><code>FVECX()</code> function</h3>
<div class="sourceCode" id="cb531"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb531-1"><a href="#cb531-1" aria-hidden="true" tabindex="-1"></a>FVECX(expr1 [, expr2, <span class="op">..</span>.])</span></code></pre></div>
<p><code>FVECX()</code> function makes a vector of floats out of
arbitrary expressions for subsequent use with vector functions, such as
<code>DOT()</code> or <code>VSUM()</code>.</p>
<p>Normally this would be just done by one of the <code>FVEC()</code>
forms. But for technical reasons a separate <code>FVECX()</code> was
much simpler to implement. So here we are.</p>
<p>All its arguments <strong>must</strong> be numeric as they are
converted to <code>FLOAT</code> type after evaluation.</p>
<p>No automatic narrowing to integers is done (unlike constant
<code>FVEC()</code> form), meaning that expressions such as
<code>DOT(FVECX(1,2,3), myarray)</code> will <strong>not</strong> use
any optimized integer computation paths.</p>
<p><code>FVECX()</code> vectors can however be passed to UDF functions
just as <code>FVEC()</code> ones.</p>
<p>Bottom line, do <strong>not</strong> use <code>FVECX()</code> for
constant vectors, as that disables certain optimizations. But other than
that, do consider it a complete <code>FVEC()</code> equivalent.</p>
<h3 id="geodist-function"><code>GEODIST()</code> function</h3>
<div class="sourceCode" id="cb532"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb532-1"><a href="#cb532-1" aria-hidden="true" tabindex="-1"></a>GEODIST(lat1, lon1, lat2, lon2, [{opt<span class="op">=</span><span class="fu">value</span>, [ <span class="op">..</span>.]}])</span></code></pre></div>
<p><code>GEODIST()</code> computes geosphere distance between two given
points specified by their coordinates.</p>
<p><strong>The default units are radians and meters.</strong> In other
words, by default input latitudes and longitudes are treated as radians,
and the output distance is in meters. You can change all that using the
4th options map argument, see below.</p>
<p><strong>We now strongly suggest using explicit <code>{in=rad}</code>
instead of the defaults.</strong> Because radians by default were a bad
choice and we plan to change that default.</p>
<p><strong>Constant vs attribute lat/lon (and other cases) are
optimized.</strong> You can put completely arbitrary expressions in any
of the four inputs, and <code>GEODIST()</code> will honestly compute
those, no surprise there. But the most common cases (notably, the
constant lat/lon pair vs the float lat/lon attribute pair) are
internally optimized, and they execute faster. For one, you really
should <em>not</em> convert between radians and degrees manually, and
use the in/out options instead.</p>
<div class="sourceCode" id="cb533"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb533-1"><a href="#cb533-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- slow, manual, and never indexed</span></span>
<span id="cb533-2"><a href="#cb533-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, GEODIST(lat<span class="op">*</span><span class="fl">3.141592</span><span class="op">/</span><span class="dv">180</span>, lon<span class="op">*</span><span class="fl">3.141592</span><span class="op">/</span><span class="dv">180</span>,</span>
<span id="cb533-3"><a href="#cb533-3" aria-hidden="true" tabindex="-1"></a>  <span class="fl">30.0</span><span class="op">*</span><span class="fl">3.141592</span><span class="op">/</span><span class="dv">180</span>, <span class="fl">60.0</span><span class="op">*</span><span class="fl">3.141592</span><span class="op">/</span><span class="dv">180</span>) <span class="op">..</span>.</span>
<span id="cb533-4"><a href="#cb533-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb533-5"><a href="#cb533-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- fast, automatic, and can use indexes</span></span>
<span id="cb533-6"><a href="#cb533-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, GEODIST(lat, lon, <span class="fl">30.0</span>, <span class="fl">60.0</span>, {<span class="kw">in</span><span class="op">=</span>deg})</span></code></pre></div>
<p><strong>Options map lets you specify units and the calculation method
(formula).</strong> Here is the list of known options and their
values:</p>
<ul>
<li><code>in = {deg | degrees | rad | radians}</code>, specifies the
input units;</li>
<li><code>out = {m | meters | km | kilometers | ft | feet | mi | miles}</code>,
specifies the output units;</li>
<li><code>method = {haversine | adaptive}</code>, specifies the
geodistance calculation method.</li>
</ul>
<p>The current defaults are
<code>{in=rad, out=m, method=adaptive}</code> but, to reiterate, we now
plan to eventually change to <code>{in=deg}</code>, and therefore
strongly suggest putting explicit <code>{in=rad}</code> in your
queries.</p>
<p><code>{method=adaptive}</code> is our current default, well-optimized
implementation that is both more precise and (much) faster than
<code>haversine</code> at all times.</p>
<p><code>{method=haversine}</code> is the industry-standard method that
was our default (and only implementation) before, and is still included,
because why not.</p>
<h3 id="group_count-function"><code>GROUP_COUNT()</code> function</h3>
<div class="sourceCode" id="cb534"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb534-1"><a href="#cb534-1" aria-hidden="true" tabindex="-1"></a>GROUP_COUNT(int_col, no_group_value)</span></code></pre></div>
<p>Very basically, <code>GROUP_COUNT()</code> quickly computes per-group
counts, without the full grouping.</p>
<p>Bit more formally, <code>GROUP_COUNT()</code> computes an element
count for a group of matched documents defined by a specific
<code>int_col</code> column value. Except when <code>int_col</code>
value equals <code>no_group_value</code>, in which case it returns
1.</p>
<p>First argument must be a <code>UINT</code> or <code>BIGINT</code>
column (more details below). Second argument must be a constant.</p>
<p><code>GROUP_COUNT()</code> value for all documents where
<code>int_col != no_group_value</code> condition is true must be
<em>exactly</em> what <code>SELECT COUNT(*) .. GROUP BY int_col</code>
would have computed, just without the actual grouping. Key differences
between <code>GROUP_COUNT()</code> and “regular” <code>GROUP BY</code>
queries are:</p>
<ol type="1">
<li><p><strong>No actual grouping occurs.</strong> For example, if a
query matches 7 documents with <code>user_id=123</code>, all these
documents will be included in the result set, and
<code>GROUP_COUNT(user_id,0)</code> will return 7.</p></li>
<li><p><strong>Documents “without” a group are considered
unique.</strong> Documents with <code>no_group_value</code> in the
<code>int_col</code> column are <strong>intentionally</strong>
considered unique entries, and <code>GROUP_COUNT()</code> must return 1
for those documents.</p></li>
<li><p><strong>Better performance.</strong> Avoiding the actual grouping
and skipping any work for “unique” documents where
<code>int_col = no_group_value</code> means that we can compute
<code>GROUP_COUNT()</code> somewhat faster.</p></li>
</ol>
<p>Naturally, <code>GROUP_COUNT()</code> result can not be available
until we scan through all the matches. So you can <em>not</em> use it in
<code>GROUP BY</code>, <code>ORDER BY</code>, <code>WHERE</code>, or any
other clause that gets evaluated “earlier” on a per-match basis.</p>
<p>Beware that using this function anyhow else than simply SELECT-ing
its value is <em>not</em> supported. Queries that do anything else
<em>should</em> fail with an error. If they do not, the results will be
undefined.</p>
<p>At the moment, first argument <em>must</em> be a column, and the
column type <em>must</em> be integer, ie. UINT or BIGINT. That is, it
may refer either to an index attribute, or to an aliased expression.
Directly doing a <code>GROUP_COUNT()</code> over an expression is not
supported yet. Note that JSON key accesses are also expressions. So for
instance:</p>
<div class="sourceCode" id="cb535"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb535-1"><a href="#cb535-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> GROUP_COUNT(x, <span class="dv">0</span>) <span class="kw">FROM</span> test; # ok</span>
<span id="cb535-2"><a href="#cb535-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> y <span class="op">+</span> <span class="dv">1</span> <span class="kw">as</span> gid, GROUP_COUNT(gid, <span class="dv">0</span>) <span class="kw">FROM</span> test; # ok</span>
<span id="cb535-3"><a href="#cb535-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> UINT(json.foo) <span class="kw">as</span> gid, GROUP_COUNT(gid, <span class="dv">0</span>) <span class="kw">FROM</span> test; # ok</span>
<span id="cb535-4"><a href="#cb535-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb535-5"><a href="#cb535-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> GROUP_COUNT(<span class="dv">1</span> <span class="op">+</span> user_id, <span class="dv">0</span>) <span class="kw">FROM</span> test; # error!</span></code></pre></div>
<p>Here’s an example that should exemplify the difference between
<code>GROUP_COUNT()</code> and regular <code>GROUP BY</code>
queries.</p>
<div class="sourceCode" id="cb536"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb536-1"><a href="#cb536-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span>, <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">from</span> rt <span class="kw">group</span> <span class="kw">by</span> x;</span>
<span id="cb536-2"><a href="#cb536-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+----------+</span></span>
<span id="cb536-3"><a href="#cb536-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | x    | <span class="fu">count</span>(<span class="op">*</span>) |</span>
<span id="cb536-4"><a href="#cb536-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+----------+</span></span>
<span id="cb536-5"><a href="#cb536-5" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> |   <span class="dv">10</span> |        <span class="dv">2</span> |</span>
<span id="cb536-6"><a href="#cb536-6" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> |   <span class="dv">20</span> |        <span class="dv">2</span> |</span>
<span id="cb536-7"><a href="#cb536-7" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> |   <span class="dv">30</span> |        <span class="dv">3</span> |</span>
<span id="cb536-8"><a href="#cb536-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+----------+</span></span>
<span id="cb536-9"><a href="#cb536-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb536-10"><a href="#cb536-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb536-11"><a href="#cb536-11" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span>, group_count(x,<span class="dv">0</span>) gc <span class="kw">from</span> rt;</span>
<span id="cb536-12"><a href="#cb536-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+------+</span></span>
<span id="cb536-13"><a href="#cb536-13" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | x    | gc   |</span>
<span id="cb536-14"><a href="#cb536-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+------+</span></span>
<span id="cb536-15"><a href="#cb536-15" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> |   <span class="dv">10</span> |    <span class="dv">2</span> |</span>
<span id="cb536-16"><a href="#cb536-16" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> |   <span class="dv">20</span> |    <span class="dv">2</span> |</span>
<span id="cb536-17"><a href="#cb536-17" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> |   <span class="dv">30</span> |    <span class="dv">3</span> |</span>
<span id="cb536-18"><a href="#cb536-18" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">4</span> |   <span class="dv">20</span> |    <span class="dv">2</span> |</span>
<span id="cb536-19"><a href="#cb536-19" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">5</span> |   <span class="dv">10</span> |    <span class="dv">2</span> |</span>
<span id="cb536-20"><a href="#cb536-20" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">6</span> |   <span class="dv">30</span> |    <span class="dv">3</span> |</span>
<span id="cb536-21"><a href="#cb536-21" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">7</span> |   <span class="dv">30</span> |    <span class="dv">3</span> |</span>
<span id="cb536-22"><a href="#cb536-22" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------+------+</span></span>
<span id="cb536-23"><a href="#cb536-23" aria-hidden="true" tabindex="-1"></a><span class="dv">7</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>We expect <code>GROUP_COUNT()</code> to be particularly useful for
“sparse” grouping, ie. when the vast majority of documents are unique
(not a part of any group), but there also are a few occasional groups of
documents here and there. For example, what if you have 990K unique
documents with <code>gid=0</code>, and 10K more documents divided into
various non-zero <code>gid</code> groups. In order to identify such
groups in your SERP, you could <code>GROUP BY</code> on something like
<code>IF(gid=0,id,gid)</code>, or you could just use
<code>GROUP_COUNT(gid,0)</code> instead. Compared to
<code>GROUP BY</code>, the latter does <em>not</em> fold the occasional
non-zero <code>gid</code> groups into a single result set row. But it
works much, much faster.</p>
<h3 id="integer-function"><code>INTEGER()</code> function</h3>
<div class="sourceCode" id="cb537"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb537-1"><a href="#cb537-1" aria-hidden="true" tabindex="-1"></a><span class="dt">INTEGER</span>(arg)</span></code></pre></div>
<p><strong>THIS IS A DEPRECATED FUNCTION SLATED FOR REMOVAL. USE UINT()
INSTEAD.</strong></p>
<p>This function converts its argument to <code>UINT</code> type, ie.
32-bit unsigned integer.</p>
<h3 id="intersect_len-function"><code>INTERSECT_LEN()</code>
function</h3>
<div class="sourceCode" id="cb538"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb538-1"><a href="#cb538-1" aria-hidden="true" tabindex="-1"></a>INTERSECT_LEN(<span class="op">&lt;</span>mva_column<span class="op">&gt;</span>, BIGINT_SET(<span class="op">..</span>.))</span></code></pre></div>
<p>This function returns the number of common values found both in an
MVA column, and a given constant values set. Or in other words, the
number of intersections between the two. This is useful when you need to
compute the number of the matching tags count on Sphinx side.</p>
<p>The first argument can be either <code>UINT_SET</code> or
<code>BIGINT_SET</code> column. The second argument should be a constant
<code>BIGINT_SET()</code>.</p>
<div class="sourceCode" id="cb539"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb539-1"><a href="#cb539-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, mva,</span>
<span id="cb539-2"><a href="#cb539-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> intersect_len(mva, bigint_set(<span class="dv">20</span>, <span class="op">-</span><span class="dv">100</span>)) n1,</span>
<span id="cb539-3"><a href="#cb539-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> intersect_len(mva, bigint_set(<span class="op">-</span><span class="dv">200</span>)) n2 <span class="kw">from</span> test;</span>
<span id="cb539-4"><a href="#cb539-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------+------+------+</span></span>
<span id="cb539-5"><a href="#cb539-5" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | mva            | n1   | n2   |</span>
<span id="cb539-6"><a href="#cb539-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------+------+------+</span></span>
<span id="cb539-7"><a href="#cb539-7" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> | <span class="op">-</span><span class="dv">100</span>,<span class="op">-</span><span class="dv">50</span>,<span class="dv">20</span>,<span class="dv">70</span> |    <span class="dv">2</span> |    <span class="dv">0</span> |</span>
<span id="cb539-8"><a href="#cb539-8" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> | <span class="op">-</span><span class="dv">350</span>,<span class="op">-</span><span class="dv">200</span>,<span class="op">-</span><span class="dv">100</span> |    <span class="dv">1</span> |    <span class="dv">1</span> |</span>
<span id="cb539-9"><a href="#cb539-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------+------+------+</span></span>
<span id="cb539-10"><a href="#cb539-10" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="l1dist-function"><code>L1DIST()</code> function</h3>
<div class="sourceCode" id="cb540"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb540-1"><a href="#cb540-1" aria-hidden="true" tabindex="-1"></a>L1DIST(array_attr, FVEC(<span class="op">..</span>.))</span></code></pre></div>
<p><code>L1DIST()</code> function computes a L1 distance (aka Manhattan
or grid distance) over two vector arguments. This is really just a sum
of absolute differences, <code>sum(abs(a[i] - b[i]))</code>.</p>
<p>Input types are currently limited to array attributes vs constant
vectors.</p>
<p>The result type is always <code>FLOAT</code> for consistency and
simplicity.</p>
<p>On Intel, we have SIMD optimized codepaths that automatically engage
where possible. So for best performance, use SIMD-friendly vector
dimensions (that means multiples of at least 16 bytes in all cases,
multiples of 32 bytes on AVX2 CPUs, etc).</p>
<h3 id="l2dist-function"><code>L2DIST()</code> function</h3>
<div class="sourceCode" id="cb541"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb541-1"><a href="#cb541-1" aria-hidden="true" tabindex="-1"></a>L2DIST(array_attr, FVEC(<span class="op">..</span>.))</span></code></pre></div>
<p><code>L2DIST()</code> function computes the squared L2 distance (aka
squared Euclidean distance) between two vector arguments. It’s defined
as the sum of the squared component-wise differences,
<code>sum(pow(a[i] - b[i], 2))</code>.</p>
<p>Input types are currently limited to array attributes vs constant
vectors.</p>
<p>The result type is always <code>FLOAT</code> for consistency and
simplicity.</p>
<p>On Intel, we have SIMD optimized codepaths that automatically engage
where possible. So for best performance, use SIMD-friendly vector
dimensions (that means multiples of at least 16 bytes in all cases,
multiples of 32 bytes on AVX2 CPUs, etc).</p>
<h3 id="mingeodist-function"><code>MINGEODIST()</code> function</h3>
<div class="sourceCode" id="cb542"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb542-1"><a href="#cb542-1" aria-hidden="true" tabindex="-1"></a>MINGEODIST(json.<span class="kw">key</span>, lat, lon, [{opt<span class="op">=</span><span class="fu">value</span>, [ <span class="op">..</span>.]}])</span></code></pre></div>
<p><code>MINGEODIST()</code> computes a minimum geodistance between the
(lat,lon) anchor point and all the points stored in the specified JSON
key.</p>
<p>The 1st argument must be a JSON array of (lat,lon) coordinate pairs,
that is, contain an even number of proper float values. The 2nd and 3rd
arguments must also be floats.</p>
<p>The optional 4th argument is an options map, exactly as in the
single-point <code>GEODIST()</code> function.</p>
<p>Example!</p>
<div class="sourceCode" id="cb543"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb543-1"><a href="#cb543-1" aria-hidden="true" tabindex="-1"></a>MINGEODIST(j.coords, <span class="fl">37.8087</span>, <span class="op">-</span><span class="fl">122.41</span>, {<span class="kw">in</span><span class="op">=</span>deg, <span class="kw">out</span><span class="op">=</span>mi})</span></code></pre></div>
<p>That computes the minimum geodistance (in miles) from Pier 39
(because degrees) to any of the points stored in <code>j.coords</code>
array.</p>
<p>Note that queries with a <code>MINGEODIST()</code> condition can
benefit from a <code>MULTIGEO</code> index on the respective JSON field.
See the <a href="#searching-geosearches">Geosearch</a> section for
details.</p>
<h3 id="mingeodistex-function"><code>MINGEODISTEX()</code> function</h3>
<div class="sourceCode" id="cb544"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb544-1"><a href="#cb544-1" aria-hidden="true" tabindex="-1"></a>MINGEODISTEX(json.<span class="kw">key</span>, lat, lon, [{opt<span class="op">=</span><span class="fu">value</span>, [ <span class="op">..</span>.]}])</span></code></pre></div>
<p><code>MINGEODISTEX()</code> works exactly as
<code>MINGEODIST()</code>, but it returns an extended “pair” result
comprised of <em>both</em> the minimum geodistance <em>and</em> the
respective closest geopoint index within the <code>json.key</code>
array. (Beware that for acccess to values back in <code>json.key</code>
you have to scale that index by 2, because they are pairs! See the
examples just below.)</p>
<p>In the final result set, you get a
<code>&lt;distance&gt;, &lt;index&gt;</code> string (instead of only the
<code>&lt;distance&gt;</code> value that you get from
<code>MINGEODIST()</code>), like so.</p>
<div class="sourceCode" id="cb545"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb545-1"><a href="#cb545-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> MINGEODISTEX(j.coords, <span class="fl">37.8087</span>, <span class="op">-</span><span class="fl">122.41</span>,</span>
<span id="cb545-2"><a href="#cb545-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> {<span class="kw">in</span><span class="op">=</span>deg, <span class="kw">out</span><span class="op">=</span>mi}) d <span class="kw">FROM</span> test1;</span>
<span id="cb545-3"><a href="#cb545-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------+</span></span>
<span id="cb545-4"><a href="#cb545-4" aria-hidden="true" tabindex="-1"></a>| d            |</span>
<span id="cb545-5"><a href="#cb545-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------+</span></span>
<span id="cb545-6"><a href="#cb545-6" aria-hidden="true" tabindex="-1"></a>| <span class="fl">1.0110466</span>, <span class="dv">3</span> |</span>
<span id="cb545-7"><a href="#cb545-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------+</span></span>
<span id="cb545-8"><a href="#cb545-8" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb545-9"><a href="#cb545-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb545-10"><a href="#cb545-10" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> MINGEODIST(j.coords, <span class="fl">37.8087</span>, <span class="op">-</span><span class="fl">122.41</span>,</span>
<span id="cb545-11"><a href="#cb545-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> {<span class="kw">in</span><span class="op">=</span>deg, <span class="kw">out</span><span class="op">=</span>mi}) d <span class="kw">FROM</span> test1;</span>
<span id="cb545-12"><a href="#cb545-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+</span></span>
<span id="cb545-13"><a href="#cb545-13" aria-hidden="true" tabindex="-1"></a>| d         |</span>
<span id="cb545-14"><a href="#cb545-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+</span></span>
<span id="cb545-15"><a href="#cb545-15" aria-hidden="true" tabindex="-1"></a>| <span class="fl">1.0110466</span> |</span>
<span id="cb545-16"><a href="#cb545-16" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+</span></span>
<span id="cb545-17"><a href="#cb545-17" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>So the minimum distance (from Pier 39 again) in this example is
1.0110466 miles, and in addition we have that the closest geopoint in
<code>j.coords</code> is lat-lon pair number 3.</p>
<p>So its latitude must be.. right, latitude is at
<code>j.coords[6]</code> and longitude at <code>j.coords[7]</code>,
respectively. Geopoint is a <em>pair</em> of coordinates, so we have to
scale by 2 to convert from <em>geopoint</em> indexes to individual value
indexes. Let’s check that.</p>
<div class="sourceCode" id="cb546"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb546-1"><a href="#cb546-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> GEODIST(j.coords[<span class="dv">6</span>], j.coords[<span class="dv">7</span>], <span class="fl">37.8087</span>, <span class="op">-</span><span class="fl">122.41</span>,</span>
<span id="cb546-2"><a href="#cb546-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> {<span class="kw">in</span><span class="op">=</span>deg,<span class="kw">out</span><span class="op">=</span>mi}) d <span class="kw">FROM</span> test1;</span>
<span id="cb546-3"><a href="#cb546-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+</span></span>
<span id="cb546-4"><a href="#cb546-4" aria-hidden="true" tabindex="-1"></a>| d         |</span>
<span id="cb546-5"><a href="#cb546-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+</span></span>
<span id="cb546-6"><a href="#cb546-6" aria-hidden="true" tabindex="-1"></a>| <span class="fl">1.0110466</span> |</span>
<span id="cb546-7"><a href="#cb546-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+</span></span>
<span id="cb546-8"><a href="#cb546-8" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb546-9"><a href="#cb546-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb546-10"><a href="#cb546-10" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> j.coords <span class="kw">FROM</span> test1;</span>
<span id="cb546-11"><a href="#cb546-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------------------------------------------------------+</span></span>
<span id="cb546-12"><a href="#cb546-12" aria-hidden="true" tabindex="-1"></a>| j.coords                                                                |</span>
<span id="cb546-13"><a href="#cb546-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------------------------------------------------------+</span></span>
<span id="cb546-14"><a href="#cb546-14" aria-hidden="true" tabindex="-1"></a>| [<span class="fl">37.8262</span>,<span class="op">-</span><span class="fl">122.4222</span>,<span class="fl">37.82</span>,<span class="op">-</span><span class="fl">122.4786</span>,<span class="fl">37.7764</span>,<span class="op">-</span><span class="fl">122.4347</span>,<span class="fl">37.7952</span>,<span class="op">-</span><span class="fl">122.4028</span>] |</span>
<span id="cb546-15"><a href="#cb546-15" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------------------------------------------------------+</span></span>
<span id="cb546-16"><a href="#cb546-16" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Well, looks legit.</p>
<p>But what happens if you filter or sort by that “pair” value? Short
answer, it’s going to pretend that it’s just distance.</p>
<p>Longer answer, it’s designed to behave exactly as
<code>MINGEODIST()</code> does in those contexts, so in
<code>WHERE</code> and <code>ORDER BY</code> clauses the
<code>MINGEODISTEX()</code> pair gets reduced to its first component,
and that’s our minimum distance.</p>
<div class="sourceCode" id="cb547"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb547-1"><a href="#cb547-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> MINGEODISTEX(j.coords, <span class="fl">37.8087</span>, <span class="op">-</span><span class="fl">122.41</span>,</span>
<span id="cb547-2"><a href="#cb547-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> {<span class="kw">in</span><span class="op">=</span>deg, <span class="kw">out</span><span class="op">=</span>mi}) d <span class="kw">from</span> test1 <span class="kw">WHERE</span> d <span class="op">&lt;</span> <span class="fl">2.0</span>;</span>
<span id="cb547-3"><a href="#cb547-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------+</span></span>
<span id="cb547-4"><a href="#cb547-4" aria-hidden="true" tabindex="-1"></a>| d            |</span>
<span id="cb547-5"><a href="#cb547-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------+</span></span>
<span id="cb547-6"><a href="#cb547-6" aria-hidden="true" tabindex="-1"></a>| <span class="fl">1.0110466</span>, <span class="dv">3</span> |</span>
<span id="cb547-7"><a href="#cb547-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------+</span></span>
<span id="cb547-8"><a href="#cb547-8" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Well, 1.011 miles is indeed less than 2.0 miles, still legit. (And
yes, those extra 2.953 inches that we have here over 1.011 miles do sooo
<em>extremely</em> annoy my inner Sheldon, but what can one do.)</p>
<h3 id="pp-function"><code>PP()</code> function</h3>
<div class="sourceCode" id="cb548"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb548-1"><a href="#cb548-1" aria-hidden="true" tabindex="-1"></a>PP(json[.<span class="kw">key</span>])</span>
<span id="cb548-2"><a href="#cb548-2" aria-hidden="true" tabindex="-1"></a>PP(<span class="fu">DUMP</span>(json.<span class="kw">key</span>))</span>
<span id="cb548-3"><a href="#cb548-3" aria-hidden="true" tabindex="-1"></a>PP(FACTORS())</span></code></pre></div>
<p><code>PP()</code> function pretty-prints JSON output (which by
default would be compact rather than prettified). It can be used either
with JSON columns (and fields), or with <code>FACTORS()</code> function.
For example:</p>
<div class="sourceCode" id="cb549"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb549-1"><a href="#cb549-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, j <span class="kw">from</span> lj <span class="kw">limit</span> <span class="dv">1</span> \G</span>
<span id="cb549-2"><a href="#cb549-2" aria-hidden="true" tabindex="-1"></a><span class="op">***************************</span> <span class="fl">1.</span> <span class="kw">row</span> <span class="op">***************************</span></span>
<span id="cb549-3"><a href="#cb549-3" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span>: <span class="dv">1</span></span>
<span id="cb549-4"><a href="#cb549-4" aria-hidden="true" tabindex="-1"></a> j: {<span class="ot">&quot;gid&quot;</span><span class="ch">:1107024</span>, <span class="ot">&quot;urlcrc&quot;</span><span class="ch">:2557061282</span>}</span>
<span id="cb549-5"><a href="#cb549-5" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.01</span> sec)</span>
<span id="cb549-6"><a href="#cb549-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb549-7"><a href="#cb549-7" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, pp(j) <span class="kw">from</span> lj <span class="kw">limit</span> <span class="dv">1</span> \G</span>
<span id="cb549-8"><a href="#cb549-8" aria-hidden="true" tabindex="-1"></a><span class="op">***************************</span> <span class="fl">1.</span> <span class="kw">row</span> <span class="op">***************************</span></span>
<span id="cb549-9"><a href="#cb549-9" aria-hidden="true" tabindex="-1"></a>   <span class="kw">id</span>: <span class="dv">1</span></span>
<span id="cb549-10"><a href="#cb549-10" aria-hidden="true" tabindex="-1"></a>pp(j): {</span>
<span id="cb549-11"><a href="#cb549-11" aria-hidden="true" tabindex="-1"></a>  <span class="ot">&quot;gid&quot;</span>: <span class="dv">1107024</span>,</span>
<span id="cb549-12"><a href="#cb549-12" aria-hidden="true" tabindex="-1"></a>  <span class="ot">&quot;urlcrc&quot;</span>: <span class="dv">2557061282</span></span>
<span id="cb549-13"><a href="#cb549-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb549-14"><a href="#cb549-14" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.01</span> sec)</span>
<span id="cb549-15"><a href="#cb549-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb549-16"><a href="#cb549-16" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, factors() <span class="kw">from</span> lj <span class="kw">where</span> match(<span class="st">&#39;hello world&#39;</span>)</span>
<span id="cb549-17"><a href="#cb549-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">limit</span> <span class="dv">1</span> <span class="kw">option</span> ranker<span class="op">=</span>expr(<span class="st">&#39;1&#39;</span>) \G</span>
<span id="cb549-18"><a href="#cb549-18" aria-hidden="true" tabindex="-1"></a><span class="op">***************************</span> <span class="fl">1.</span> <span class="kw">row</span> <span class="op">***************************</span></span>
<span id="cb549-19"><a href="#cb549-19" aria-hidden="true" tabindex="-1"></a>       <span class="kw">id</span>: <span class="dv">5332</span></span>
<span id="cb549-20"><a href="#cb549-20" aria-hidden="true" tabindex="-1"></a>factors(): {<span class="ot">&quot;bm15&quot;</span><span class="ch">:735</span>, <span class="ot">&quot;bm25a&quot;</span><span class="ch">:0</span><span class="fl">.898329</span>, <span class="ot">&quot;field_mask&quot;</span><span class="ch">:2</span>, <span class="op">..</span>.}</span>
<span id="cb549-21"><a href="#cb549-21" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb549-22"><a href="#cb549-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb549-23"><a href="#cb549-23" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, pp(factors()) <span class="kw">from</span> lj <span class="kw">where</span> match(<span class="st">&#39;hello world&#39;</span>)</span>
<span id="cb549-24"><a href="#cb549-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">limit</span> <span class="dv">1</span> <span class="kw">option</span> ranker<span class="op">=</span>expr(<span class="st">&#39;1&#39;</span>) \G</span>
<span id="cb549-25"><a href="#cb549-25" aria-hidden="true" tabindex="-1"></a><span class="op">***************************</span> <span class="fl">1.</span> <span class="kw">row</span> <span class="op">***************************</span></span>
<span id="cb549-26"><a href="#cb549-26" aria-hidden="true" tabindex="-1"></a>       <span class="kw">id</span>: <span class="dv">5332</span></span>
<span id="cb549-27"><a href="#cb549-27" aria-hidden="true" tabindex="-1"></a>pp(factors()): {</span>
<span id="cb549-28"><a href="#cb549-28" aria-hidden="true" tabindex="-1"></a>  <span class="ot">&quot;bm15&quot;</span>: <span class="dv">735</span>,</span>
<span id="cb549-29"><a href="#cb549-29" aria-hidden="true" tabindex="-1"></a>  <span class="ot">&quot;bm25a&quot;</span>: <span class="fl">0.898329</span>,</span>
<span id="cb549-30"><a href="#cb549-30" aria-hidden="true" tabindex="-1"></a>  <span class="ot">&quot;field_mask&quot;</span>: <span class="dv">2</span>,</span>
<span id="cb549-31"><a href="#cb549-31" aria-hidden="true" tabindex="-1"></a>  <span class="ot">&quot;doc_word_count&quot;</span>: <span class="dv">2</span>,</span>
<span id="cb549-32"><a href="#cb549-32" aria-hidden="true" tabindex="-1"></a>  <span class="ot">&quot;fields&quot;</span>: [</span>
<span id="cb549-33"><a href="#cb549-33" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb549-34"><a href="#cb549-34" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;field&quot;</span>: <span class="dv">1</span>,</span>
<span id="cb549-35"><a href="#cb549-35" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;lcs&quot;</span>: <span class="dv">2</span>,</span>
<span id="cb549-36"><a href="#cb549-36" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;hit_count&quot;</span>: <span class="dv">2</span>,</span>
<span id="cb549-37"><a href="#cb549-37" aria-hidden="true" tabindex="-1"></a>      <span class="ot">&quot;word_count&quot;</span>: <span class="dv">2</span>,</span>
<span id="cb549-38"><a href="#cb549-38" aria-hidden="true" tabindex="-1"></a>      <span class="op">..</span>.</span>
<span id="cb549-39"><a href="#cb549-39" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="pqmatched-function"><code>PQMATCHED()</code> function</h3>
<div class="sourceCode" id="cb550"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb550-1"><a href="#cb550-1" aria-hidden="true" tabindex="-1"></a>PQMATCHED()</span></code></pre></div>
<p><code>PQMATCHED()</code> returns a comma-separated list of
<code>DOCS()</code> ids that were matched by the respective stored
query. It only works in percolate indexes and requires
<code>PQMATCH()</code> searches. For example.</p>
<div class="sourceCode" id="cb551"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb551-1"><a href="#cb551-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> PQMATCHED(), <span class="kw">id</span> <span class="kw">FROM</span> pqtest</span>
<span id="cb551-2"><a href="#cb551-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="kw">WHERE</span> PQMATCH(DOCS({<span class="dv">1</span>, <span class="st">&#39;one&#39;</span>}, {<span class="dv">2</span>, <span class="st">&#39;two&#39;</span>}, {<span class="dv">3</span>, <span class="st">&#39;three&#39;</span>}));</span>
<span id="cb551-3"><a href="#cb551-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------+-----+</span></span>
<span id="cb551-4"><a href="#cb551-4" aria-hidden="true" tabindex="-1"></a>| pqmatched() | <span class="kw">id</span>  |</span>
<span id="cb551-5"><a href="#cb551-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------+-----+</span></span>
<span id="cb551-6"><a href="#cb551-6" aria-hidden="true" tabindex="-1"></a>| <span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>       | <span class="dv">123</span> |</span>
<span id="cb551-7"><a href="#cb551-7" aria-hidden="true" tabindex="-1"></a>| <span class="dv">2</span>           | <span class="dv">124</span> |</span>
<span id="cb551-8"><a href="#cb551-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------+-----+</span></span>
<span id="cb551-9"><a href="#cb551-9" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>For more details, refer to the <a
href="#searching-percolate-queries">percolate queries</a> section.</p>
<h3 id="query-function"><code>QUERY()</code> function</h3>
<div class="sourceCode" id="cb552"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb552-1"><a href="#cb552-1" aria-hidden="true" tabindex="-1"></a><span class="kw">QUERY</span>()</span></code></pre></div>
<p><code>QUERY()</code> is a helper function that returns the current
full-text query, as is. Originally intended as a syntax sugar for
<code>SNIPPET()</code> calls, to avoid repeating the keywords twice, but
may also be handy when generating ML training data.</p>
<div class="sourceCode" id="cb553"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb553-1"><a href="#cb553-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, weight(), <span class="kw">query</span>() <span class="kw">from</span> lj <span class="kw">where</span> match(<span class="st">&#39;Test It&#39;</span>) <span class="kw">limit</span> <span class="dv">3</span>;</span>
<span id="cb553-2"><a href="#cb553-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------+---------+</span></span>
<span id="cb553-3"><a href="#cb553-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | weight()  | <span class="kw">query</span>() |</span>
<span id="cb553-4"><a href="#cb553-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------+---------+</span></span>
<span id="cb553-5"><a href="#cb553-5" aria-hidden="true" tabindex="-1"></a>| <span class="dv">2709</span> | <span class="fl">24305.277</span> | Test It |</span>
<span id="cb553-6"><a href="#cb553-6" aria-hidden="true" tabindex="-1"></a>| <span class="dv">2702</span> | <span class="fl">24212.217</span> | Test It |</span>
<span id="cb553-7"><a href="#cb553-7" aria-hidden="true" tabindex="-1"></a>| <span class="dv">8888</span> | <span class="fl">24212.217</span> | Test It |</span>
<span id="cb553-8"><a href="#cb553-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-----------+---------+</span></span>
<span id="cb553-9"><a href="#cb553-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="slice-functions">Slice functions</h3>
<div class="sourceCode" id="cb554"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb554-1"><a href="#cb554-1" aria-hidden="true" tabindex="-1"></a>SLICEAVG(json.<span class="kw">key</span>, min_index, sup_index)</span>
<span id="cb554-2"><a href="#cb554-2" aria-hidden="true" tabindex="-1"></a>SLICEMAX(json.<span class="kw">key</span>, min_index, sup_index)</span>
<span id="cb554-3"><a href="#cb554-3" aria-hidden="true" tabindex="-1"></a>SLICEMIN(json.<span class="kw">key</span>, min_index, sup_index)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th>Function call example</th>
<th>Info</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>SLICEAVG(j.prices, 3, 7)</code></td>
<td>Computes average value in a slice</td>
</tr>
<tr class="even">
<td><code>SLICEMAX(j.prices, 3, 7)</code></td>
<td>Computes minimum value in a slice</td>
</tr>
<tr class="odd">
<td><code>SLICEMIN(j.prices, 3, 7)</code></td>
<td>Computes maximum value in a slice</td>
</tr>
</tbody>
</table>
<p>Slice functions (<code>SLICEAVG</code>, <code>SLICEMAX</code>, and
<code>SLICEMIN</code>) expect a JSON array as their 1st argument, and
two constant integer indexes A and B as their 2nd and 3rd arguments,
respectively. Then they compute an aggregate value over the array
elements in the respective slice, that is, from index A inclusive to
index B exclusive (just like in Python and Golang). For instance, in the
example above elements 3, 4, 5, and 6 will be processed, but not element
7. The indexes are, of course, 0-based.</p>
<p>The returned value is <code>float</code>, even when all the input
values are actually integer.</p>
<p>Non-arrays and slices with non-numeric items will return a value of
<code>0.0</code> (subject to change to <code>NULL</code>
eventually).</p>
<h3 id="snippet-function"><code>SNIPPET()</code> function</h3>
<div class="sourceCode" id="cb555"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb555-1"><a href="#cb555-1" aria-hidden="true" tabindex="-1"></a>SNIPPET(<span class="op">&lt;</span>content<span class="op">&gt;</span>, <span class="op">&lt;</span><span class="kw">query</span><span class="op">&gt;</span> [, <span class="st">&#39;&lt;option&gt; = &lt;value&gt;&#39;</span> [, <span class="op">..</span>.]])</span>
<span id="cb555-2"><a href="#cb555-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb555-3"><a href="#cb555-3" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>content<span class="op">&gt;</span> <span class="op">:=</span> {<span class="op">&lt;</span>string_expr<span class="op">&gt;</span> | DOCUMENT([{<span class="op">&lt;</span>field<span class="op">&gt;</span> [, <span class="op">..</span>.]}])}</span>
<span id="cb555-4"><a href="#cb555-4" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span><span class="kw">query</span><span class="op">&gt;</span> <span class="op">:=</span> {<span class="op">&lt;</span>string_expr<span class="op">&gt;</span> | <span class="kw">QUERY</span>()}</span></code></pre></div>
<p><code>SNIPPET()</code> function builds snippets in the
<code>SELECT</code> query. Like the standalone
<code>CALL SNIPPETS()</code> statement, but somewhat more powerful.</p>
<p>The first two required arguments must be the content to extract
snippets from, and the full-text query to generate those, respectively.
Both must basically be strings. As for content, we can store it either
in Sphinx (in a <code>FIELD_STRING</code> column, or in a JSON value, or
in DocStore), or we can store it externally and access it via a custom
UDF. All these four alternatives <strong>are</strong> from production
solutions.</p>
<div class="sourceCode" id="cb556"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb556-1"><a href="#cb556-1" aria-hidden="true" tabindex="-1"></a># we can <span class="kw">store</span> `title` <span class="kw">as</span> `FIELD_STRING` (<span class="kw">the</span> simplest)</span>
<span id="cb556-2"><a href="#cb556-2" aria-hidden="true" tabindex="-1"></a>SNIPPET(title, <span class="kw">QUERY</span>())</span>
<span id="cb556-3"><a href="#cb556-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb556-4"><a href="#cb556-4" aria-hidden="true" tabindex="-1"></a># we can <span class="kw">enable</span> <span class="kw">and</span> <span class="kw">use</span> DocStore</span>
<span id="cb556-5"><a href="#cb556-5" aria-hidden="true" tabindex="-1"></a>SNIPPET(DOCUMENT({title}), <span class="kw">QUERY</span>())</span>
<span id="cb556-6"><a href="#cb556-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb556-7"><a href="#cb556-7" aria-hidden="true" tabindex="-1"></a># we can <span class="kw">use</span> JSON (more indexing<span class="op">/</span><span class="kw">INSERT</span> hoops, but still)</span>
<span id="cb556-8"><a href="#cb556-8" aria-hidden="true" tabindex="-1"></a>SNIPPET(j.doc.title, <span class="kw">QUERY</span>())</span>
<span id="cb556-9"><a href="#cb556-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb556-10"><a href="#cb556-10" aria-hidden="true" tabindex="-1"></a># we can <span class="kw">access</span> an external <span class="kw">file</span> <span class="kw">or</span> <span class="kw">database</span></span>
<span id="cb556-11"><a href="#cb556-11" aria-hidden="true" tabindex="-1"></a>SNIPPET(MYUDF(external_id, <span class="st">&#39;title&#39;</span>), <span class="kw">QUERY</span>())</span></code></pre></div>
<p>As for query argument, <code>QUERY()</code> usually works. It’s a
convenient syntax sugar that copies the <code>MATCH()</code> clause
insides. Sometimes a separate constant string works better though, built
by the client app a bit differently than <code>MATCH()</code> query
(think “no magic keywords” and/or “no full-text operators”).</p>
<div class="sourceCode" id="cb557"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb557-1"><a href="#cb557-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, SNIPPET(title, <span class="st">&#39;what user typed&#39;</span>) <span class="kw">FROM</span> test</span>
<span id="cb557-2"><a href="#cb557-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;@(title,llmkeywords) (what|user|typed) @sys __magic123&#39;</span>)</span></code></pre></div>
<p>(Technically, all the other storage options apply to queries just as
well, except for <em>queries</em> they make zero sense. Yes, you
<em>could</em> use some JSON value as your snippet highlighting query
instead of <code>QUERY()</code>. Absolutely no idea why one’d ever want
that. But it’s possible.)</p>
<p>For the record, you can use <code>SNIPPET()</code> with constant text
strings. Now that <em>might</em> be occasionally useful for
debugging.</p>
<div class="sourceCode" id="cb558"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb558-1"><a href="#cb558-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> SNIPPET(<span class="st">&#39;hello world&#39;</span>, <span class="st">&#39;world&#39;</span>) s <span class="kw">FROM</span> test <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb558-2"><a href="#cb558-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------+</span></span>
<span id="cb558-3"><a href="#cb558-3" aria-hidden="true" tabindex="-1"></a>| s                  |</span>
<span id="cb558-4"><a href="#cb558-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------+</span></span>
<span id="cb558-5"><a href="#cb558-5" aria-hidden="true" tabindex="-1"></a>| hello <span class="op">&lt;</span>b<span class="op">&gt;</span>world<span class="op">&lt;/</span>b<span class="op">&gt;</span> |</span>
<span id="cb558-6"><a href="#cb558-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------+</span></span>
<span id="cb558-7"><a href="#cb558-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Any other arguments also must be strings, and they are going to be
parsed as option-value pairs. <code>SNIPPET()</code> has the very same
options as <code>CALL SNIPPETS()</code>, for example.</p>
<div class="sourceCode" id="cb559"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb559-1"><a href="#cb559-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, SNIPPET(title, <span class="kw">QUERY</span>(), <span class="st">&#39;limit=200&#39;</span>) <span class="kw">FROM</span> test</span>
<span id="cb559-2"><a href="#cb559-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> MATCH(<span class="st">&#39;richard of york gave battle&#39;</span>)</span></code></pre></div>
<p><code>SNIPPET()</code> is a “post-limit” function that evaluates
rather uniquely. Snippets <em>can</em> be pretty expensive to build:
snippet for a short <code>title</code> string stored in RAM will be
quick, but for a long <code>content</code> text stored on disk it will
be slow. So Sphinx postpones evaluating snippets, and tries really
hard.</p>
<p>Most of the other expressions are done computing when a full-text
index returns results to <code>searchd</code>, but
<code>SNIPPET()</code> is not. <code>searchd</code> first waits for
<em>all</em> the local indexes to return results, then combines all such
results together, then applies the final <code>LIMIT</code>, and only
<em>then</em> it evaluates <code>SNIPPET()</code> calls. That’s what
“post-limit” means.</p>
<p>On <code>SNIPPET(DOCUMENT(), ...)</code> route <code>searchd</code>
calls the full-text indexes once again during evaluation. To fetch the
document contents from DocStore. And that introduces an inevitable race:
documents (or indexes) might disappear <em>before</em> the second
“fetch” call, leading to empty snippets. That’s a comparatively rare
occasion, though.</p>
<h3 id="strpos-function"><code>STRPOS()</code> function</h3>
<div class="sourceCode" id="cb560"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb560-1"><a href="#cb560-1" aria-hidden="true" tabindex="-1"></a>STRPOS(haystack, const_needle)</span></code></pre></div>
<p><code>STRPOS()</code> returns the index of the first occurrence of
its second argument (“needle”) in its first argument (“haystack”), or
<code>-1</code> if there are no occurrences.</p>
<p>The index is counted in bytes (rather that Unicode codepoints).</p>
<p>At the moment, needle must be a constant string. If needle is an
empty string, then 0 will be returned.</p>
<h3 id="timediff-function"><code>TIMEDIFF()</code> function</h3>
<div class="sourceCode" id="cb561"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb561-1"><a href="#cb561-1" aria-hidden="true" tabindex="-1"></a>TIMEDIFF(timestamp1, timestamp2)</span></code></pre></div>
<p><code>TIMEDIFF()</code> takes 2 integer timestamps, and returns the
difference between them in a <code>HH:MM:SS</code> format. It was added
for better MySQL connector compatibility.</p>
<h3 id="uint-function"><code>UINT()</code> function</h3>
<div class="sourceCode" id="cb562"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb562-1"><a href="#cb562-1" aria-hidden="true" tabindex="-1"></a>UINT(arg)</span></code></pre></div>
<p>This function converts its argument to <code>UINT</code> type, ie.
32-bit unsigned integer.</p>
<h3 id="utc_time-function"><code>UTC_TIME()</code> function</h3>
<div class="sourceCode" id="cb563"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb563-1"><a href="#cb563-1" aria-hidden="true" tabindex="-1"></a>UTC_TIME()</span></code></pre></div>
<p><code>UTC_TIME()</code> returns the current server time, in UTC time
zone, as a string in <code>HH:MM:SS</code> format. It was added for
better MySQL connector compatibility.</p>
<h3 id="utc_timestamp-function"><code>UTC_TIMESTAMP()</code>
function</h3>
<div class="sourceCode" id="cb564"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb564-1"><a href="#cb564-1" aria-hidden="true" tabindex="-1"></a>UTC_TIMESTAMP()</span></code></pre></div>
<p><code>UTC_TIMESTAMP()</code> returns the current server time, in UTC
time zone, as a string in <code>YYYY-MM-DD HH:MM:SS</code> format. It
was added for better MySQL connector compatibility.</p>
<h3 id="vadd-function"><code>VADD()</code> function</h3>
<div class="sourceCode" id="cb565"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb565-1"><a href="#cb565-1" aria-hidden="true" tabindex="-1"></a>VADD(<span class="op">&lt;</span>vec<span class="op">&gt;</span>, {<span class="op">&lt;</span>vec<span class="op">&gt;</span> | <span class="op">&lt;</span><span class="dt">number</span><span class="op">&gt;</span>})</span></code></pre></div>
<p><code>VADD()</code> returns a per-component sum of its two
arguments.</p>
<p>First argument must always be a float vector. Second argument can be
either a float vector too, or a regular number. Argument vector
dimensions <strong>can</strong> be different!</p>
<p>In the vector-vs-vector case, <code>VADD()</code> truncates both
arguments to the minimum dimensions, and sums the remaining
components.</p>
<div class="sourceCode" id="cb566"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb566-1"><a href="#cb566-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> to_string(vadd(fvecx(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), fvecx(<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>)));</span>
<span id="cb566-2"><a href="#cb566-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------------------------------------+</span></span>
<span id="cb566-3"><a href="#cb566-3" aria-hidden="true" tabindex="-1"></a>| to_string(vadd(fvecx(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), fvecx(<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>))) |</span>
<span id="cb566-4"><a href="#cb566-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------------------------------------+</span></span>
<span id="cb566-5"><a href="#cb566-5" aria-hidden="true" tabindex="-1"></a>| <span class="fl">5.0</span>, <span class="fl">7.0</span>, <span class="fl">9.0</span>                                 |</span>
<span id="cb566-6"><a href="#cb566-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------------------------------------+</span></span>
<span id="cb566-7"><a href="#cb566-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>If either argument is null (an empty vector coming from JSON),
<code>VADD()</code> returns the other one.</p>
<div class="sourceCode" id="cb567"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb567-1"><a href="#cb567-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> to_string(vadd(fvec(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), fvec(j.nosuchkey))) <span class="kw">from</span> test;</span>
<span id="cb567-2"><a href="#cb567-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------------------------------+</span></span>
<span id="cb567-3"><a href="#cb567-3" aria-hidden="true" tabindex="-1"></a>| to_string(vadd(fvec(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), fvec(j.nosuchkey))) |</span>
<span id="cb567-4"><a href="#cb567-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------------------------------+</span></span>
<span id="cb567-5"><a href="#cb567-5" aria-hidden="true" tabindex="-1"></a>| <span class="fl">1.0</span>, <span class="fl">2.0</span>, <span class="fl">3.0</span>                                   |</span>
<span id="cb567-6"><a href="#cb567-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------------------------------+</span></span>
<span id="cb567-7"><a href="#cb567-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb567-8"><a href="#cb567-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb567-9"><a href="#cb567-9" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> to_string(vadd(fvec(j.nosuchkey), fvec(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>))) <span class="kw">from</span> test;</span>
<span id="cb567-10"><a href="#cb567-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------------------------------+</span></span>
<span id="cb567-11"><a href="#cb567-11" aria-hidden="true" tabindex="-1"></a>| to_string(vadd(fvec(j.nosuchkey), fvec(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>))) |</span>
<span id="cb567-12"><a href="#cb567-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------------------------------+</span></span>
<span id="cb567-13"><a href="#cb567-13" aria-hidden="true" tabindex="-1"></a>| <span class="fl">1.0</span>, <span class="fl">2.0</span>, <span class="fl">3.0</span>                                   |</span>
<span id="cb567-14"><a href="#cb567-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------------------------------+</span></span>
<span id="cb567-15"><a href="#cb567-15" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>In the vector-vs-float case, <code>VADD()</code> adds the float from
the 2nd argument to every component of the 1st argument vector.</p>
<div class="sourceCode" id="cb568"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb568-1"><a href="#cb568-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> to_string(vadd(fvecx(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="dv">100</span>));</span>
<span id="cb568-2"><a href="#cb568-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------------------+</span></span>
<span id="cb568-3"><a href="#cb568-3" aria-hidden="true" tabindex="-1"></a>| to_string(vadd(fvecx(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="dv">100</span>)) |</span>
<span id="cb568-4"><a href="#cb568-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------------------+</span></span>
<span id="cb568-5"><a href="#cb568-5" aria-hidden="true" tabindex="-1"></a>| <span class="fl">101.0</span>, <span class="fl">102.0</span>, <span class="fl">103.0</span>                |</span>
<span id="cb568-6"><a href="#cb568-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------------------+</span></span>
<span id="cb568-7"><a href="#cb568-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<blockquote>
<p>NOTE! While we deny <code>TO_STRING()</code> existence and disavow
creating it, those examples may (to our greatest surprise, of course)
still work without change. Those dreaded cases when a purely
hypothetical developer may, perhaps, be too hypothetically lazy to
properly support <code>FLOAT_VEC</code> columns in result sets…</p>
</blockquote>
<h3 id="vdiv-function"><code>VDIV()</code> function</h3>
<div class="sourceCode" id="cb569"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb569-1"><a href="#cb569-1" aria-hidden="true" tabindex="-1"></a>VDIV(<span class="op">&lt;</span>vec<span class="op">&gt;</span>, {<span class="op">&lt;</span>vec<span class="op">&gt;</span> | <span class="op">&lt;</span><span class="dt">number</span><span class="op">&gt;</span>})</span></code></pre></div>
<p><code>VDIV()</code> returns a per-component quotient (aka result of a
division) of its two arguments.</p>
<p>First argument must always be a float vector. Second argument can be
either a float vector too, or a regular number. Argument vector
dimensions <strong>can</strong> be different!</p>
<p>In the vector-vs-vector case, <code>VDIV()</code> truncates both
arguments to the minimum dimensions, and divides the remaining
components.</p>
<div class="sourceCode" id="cb570"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb570-1"><a href="#cb570-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> to_string(vdiv(fvec(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), fvec(<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>)));</span>
<span id="cb570-2"><a href="#cb570-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------------------------+</span></span>
<span id="cb570-3"><a href="#cb570-3" aria-hidden="true" tabindex="-1"></a>| to_string(vdiv(fvec(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), fvec(<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>))) |</span>
<span id="cb570-4"><a href="#cb570-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------------------------+</span></span>
<span id="cb570-5"><a href="#cb570-5" aria-hidden="true" tabindex="-1"></a>| <span class="fl">0.25</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>                              |</span>
<span id="cb570-6"><a href="#cb570-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------------------------+</span></span>
<span id="cb570-7"><a href="#cb570-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>However, when the 2nd argument is an empty vector (coming from JSON),
<code>VDIV()</code> coalesces it and returns the 1st argument as is.</p>
<div class="sourceCode" id="cb571"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb571-1"><a href="#cb571-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, j.foo, to_string(vdiv(fvec(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>), fvec(j.foo))) r <span class="kw">from</span> test;</span>
<span id="cb571-2"><a href="#cb571-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------+----------------------+</span></span>
<span id="cb571-3"><a href="#cb571-3" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | j.foo   | r                    |</span>
<span id="cb571-4"><a href="#cb571-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------+----------------------+</span></span>
<span id="cb571-5"><a href="#cb571-5" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> | [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>] | <span class="fl">3.0</span>, <span class="fl">1.0</span>, <span class="fl">0.33333334</span> |</span>
<span id="cb571-6"><a href="#cb571-6" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> | <span class="kw">NULL</span>    | <span class="fl">3.0</span>, <span class="fl">2.0</span>, <span class="fl">1.0</span>        |</span>
<span id="cb571-7"><a href="#cb571-7" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> | bar     | <span class="fl">3.0</span>, <span class="fl">2.0</span>, <span class="fl">1.0</span>        |</span>
<span id="cb571-8"><a href="#cb571-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------+----------------------+</span></span>
<span id="cb571-9"><a href="#cb571-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Divisions-by-zero currently zero out the respective components. This
behavior <strong>MAY</strong> change in the future (we are considering
emptying the vector instead).</p>
<div class="sourceCode" id="cb572"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb572-1"><a href="#cb572-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> to_string(vdiv(fvec(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), fvec(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)));</span>
<span id="cb572-2"><a href="#cb572-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------------------------+</span></span>
<span id="cb572-3"><a href="#cb572-3" aria-hidden="true" tabindex="-1"></a>| to_string(vdiv(fvec(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), fvec(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>))) |</span>
<span id="cb572-4"><a href="#cb572-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------------------------+</span></span>
<span id="cb572-5"><a href="#cb572-5" aria-hidden="true" tabindex="-1"></a>| <span class="fl">0.0</span>, <span class="fl">2.0</span>, <span class="fl">1.5</span>                             |</span>
<span id="cb572-6"><a href="#cb572-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------------------------------+</span></span>
<span id="cb572-7"><a href="#cb572-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>In the vector-vs-float case, <code>VDIV()</code> divides the 1st
argument vector by the 2nd float argument.</p>
<div class="sourceCode" id="cb573"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb573-1"><a href="#cb573-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> to_string(vdiv(fvec(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="dv">2</span>));</span>
<span id="cb573-2"><a href="#cb573-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------------+</span></span>
<span id="cb573-3"><a href="#cb573-3" aria-hidden="true" tabindex="-1"></a>| to_string(vdiv(fvec(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="dv">2</span>)) |</span>
<span id="cb573-4"><a href="#cb573-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------------+</span></span>
<span id="cb573-5"><a href="#cb573-5" aria-hidden="true" tabindex="-1"></a>| <span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">1.5</span>                   |</span>
<span id="cb573-6"><a href="#cb573-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------------+</span></span>
<span id="cb573-7"><a href="#cb573-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<blockquote>
<p>NOTE! While we deny <code>TO_STRING()</code> existence and disavow
creating it, those examples may (to our greatest surprise, of course)
still work without change. Those dreaded cases when a purely
hypothetical developer may, perhaps, be too hypothetically lazy to
properly support <code>FLOAT_VEC</code> columns in result sets…</p>
</blockquote>
<h3 id="vmul-function"><code>VMUL()</code> function</h3>
<div class="sourceCode" id="cb574"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb574-1"><a href="#cb574-1" aria-hidden="true" tabindex="-1"></a>VMUL(<span class="op">&lt;</span>vec<span class="op">&gt;</span>, {<span class="op">&lt;</span>vec<span class="op">&gt;</span> | <span class="op">&lt;</span><span class="dt">number</span><span class="op">&gt;</span>})</span></code></pre></div>
<p><code>VMUL()</code> returns a per-component product of its two
arguments.</p>
<p>First argument must always be a float vector. Second argument can be
either a float vector too, or a regular number. Argument vector
dimensions <strong>can</strong> be different!</p>
<p>In the vector-vs-vector case, <code>VMUL()</code> truncates both
arguments to the minimum dimensions, and multiplies the remaining
components.</p>
<div class="sourceCode" id="cb575"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb575-1"><a href="#cb575-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> to_string(vmul(fvecx(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), fvecx(<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>)));</span>
<span id="cb575-2"><a href="#cb575-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------------------------------------+</span></span>
<span id="cb575-3"><a href="#cb575-3" aria-hidden="true" tabindex="-1"></a>| to_string(vmul(fvecx(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), fvecx(<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>))) |</span>
<span id="cb575-4"><a href="#cb575-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------------------------------------+</span></span>
<span id="cb575-5"><a href="#cb575-5" aria-hidden="true" tabindex="-1"></a>| <span class="fl">4.0</span>, <span class="fl">10.0</span>, <span class="fl">18.0</span>                               |</span>
<span id="cb575-6"><a href="#cb575-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------------------------------------+</span></span>
<span id="cb575-7"><a href="#cb575-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>If either argument is null (an empty vector coming from JSON),
<code>VMUL()</code> returns the other one. See <a
href="#vadd-function"><code>VADD()</code></a> for examples.</p>
<p>In the vector-float case, <code>VMUL()</code> multiplies every
component of the 1st argument vector by the 2nd argument float.</p>
<div class="sourceCode" id="cb576"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb576-1"><a href="#cb576-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> to_string(vmul(fvecx(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="dv">100</span>));</span>
<span id="cb576-2"><a href="#cb576-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------------------+</span></span>
<span id="cb576-3"><a href="#cb576-3" aria-hidden="true" tabindex="-1"></a>| to_string(vmul(fvecx(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="dv">100</span>)) |</span>
<span id="cb576-4"><a href="#cb576-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------------------+</span></span>
<span id="cb576-5"><a href="#cb576-5" aria-hidden="true" tabindex="-1"></a>| <span class="fl">100.0</span>, <span class="fl">200.0</span>, <span class="fl">300.0</span>                |</span>
<span id="cb576-6"><a href="#cb576-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------------------+</span></span>
<span id="cb576-7"><a href="#cb576-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<blockquote>
<p>NOTE! While we deny <code>TO_STRING()</code> existence and disavow
creating it, those examples may (to our greatest surprise, of course)
still work without change. Those dreaded cases when a purely
hypothetical developer may, perhaps, be too hypothetically lazy to
properly support <code>FLOAT_VEC</code> columns in result sets…</p>
</blockquote>
<h3 id="vslice-function"><code>VSLICE()</code> function</h3>
<div class="sourceCode" id="cb577"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb577-1"><a href="#cb577-1" aria-hidden="true" tabindex="-1"></a>VSLICE(<span class="op">&lt;</span>vec<span class="op">&gt;</span>, <span class="op">&lt;</span><span class="kw">from</span><span class="op">&gt;</span>, <span class="op">&lt;</span><span class="kw">to</span><span class="op">&gt;</span>)</span></code></pre></div>
<p><code>VSLICE()</code> returns a <code>[from, to)</code> slice taken
from its argument vector.</p>
<p>More formally, it returns a sub-vector that starts at index
<code>&lt;from&gt;</code> and ends <em>just before</em> index
<code>&lt;to&gt;</code> in the argument. Note that it may very well
return an empty vector!</p>
<p>First argument must be a float vector (either built with
<code>FVEC()</code> or <code>FVECX()</code> function, or returned from
another vector function).</p>
<p><code>&lt;from&gt;</code> and <code>&lt;to&gt;</code> index arguments
must be integer. Indexes are 0-based. Arbitrary expressions are allowed.
To reiterate, <code>&lt;from&gt;</code> index is inclusive,
<code>&lt;to&gt;</code> is exclusive.</p>
<p><strong>Negative indexes are relative to vector end</strong>. So, for
example, <code>VSLICE(FVEC(1,2,3,4,5,6), 2, -1)</code> chops off two
first elements <em>and</em> one last element, and the result is
<code>(3,4,5)</code>.</p>
<p><strong>Too-wide slices are clipped</strong>, so
<code>VSLICE(FVEC(1,2,3), 2, 1000))</code> simply returns
<code>(3)</code>.</p>
<p><strong>Backwards slices are empty</strong>, ie. any slice where
<code>&lt;to&gt;</code> is less or equal to <code>&lt;from&gt;</code> is
empty. For example, <code>VSLICE(FVEC(1,2,3), 2, -2)</code> returns an
empty vector.</p>
<h3 id="vsort-function"><code>VSORT()</code> function</h3>
<div class="sourceCode" id="cb578"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb578-1"><a href="#cb578-1" aria-hidden="true" tabindex="-1"></a>VSORT(<span class="op">&lt;</span>vec<span class="op">&gt;</span>)</span></code></pre></div>
<p><code>VSORT()</code> returns a sorted argument vector.</p>
<p>Its argument must be a float vector (either built with
<code>FVEC()</code> or <code>FVECX()</code> function, or returned from
another vector function).</p>
<h3 id="vsub-function"><code>VSUB()</code> function</h3>
<div class="sourceCode" id="cb579"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb579-1"><a href="#cb579-1" aria-hidden="true" tabindex="-1"></a>VSUB(<span class="op">&lt;</span>vec<span class="op">&gt;</span>, {<span class="op">&lt;</span>vec<span class="op">&gt;</span> | <span class="op">&lt;</span><span class="dt">number</span><span class="op">&gt;</span>})</span></code></pre></div>
<p><code>VSUB()</code> returns a per-component difference of its two
arguments. (It could be done with
<code>VADD(&lt;arg1&gt;, VMUL(&lt;arg2&gt;), -1))</code>, but hey, we
need sugar.)</p>
<p>First argument must always be a float vector. Second argument can be
either a float vector too, or a regular number. Argument vector
dimensions <strong>can</strong> be different!</p>
<p>In the vector-vs-vector case, <code>VSUB()</code> truncates both
arguments to the minimum dimensions, and subtracts the remaining
components.</p>
<div class="sourceCode" id="cb580"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb580-1"><a href="#cb580-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> to_string(vsub(fvec(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), fvec(<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>)));</span>
<span id="cb580-2"><a href="#cb580-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------------------------+</span></span>
<span id="cb580-3"><a href="#cb580-3" aria-hidden="true" tabindex="-1"></a>| to_string(vsub(fvec(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), fvec(<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>))) |</span>
<span id="cb580-4"><a href="#cb580-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------------------------+</span></span>
<span id="cb580-5"><a href="#cb580-5" aria-hidden="true" tabindex="-1"></a>| <span class="op">-</span><span class="fl">3.0</span>, <span class="op">-</span><span class="fl">3.0</span>, <span class="op">-</span><span class="fl">3.0</span>                            |</span>
<span id="cb580-6"><a href="#cb580-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------------------------------------+</span></span>
<span id="cb580-7"><a href="#cb580-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>If either argument is null (an empty vector coming from JSON),
<code>VSUB()</code> returns the other one. See <a
href="#vadd-function"><code>VADD()</code></a> for examples.</p>
<p>In the vector-vs-float case, <code>VSUB()</code> subtracts the float
from the 2nd argument from every component of the 1st argument
vector.</p>
<div class="sourceCode" id="cb581"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb581-1"><a href="#cb581-1" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------------------------+</span></span>
<span id="cb581-2"><a href="#cb581-2" aria-hidden="true" tabindex="-1"></a>| to_string(vsub(fvec(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="dv">100</span>)) |</span>
<span id="cb581-3"><a href="#cb581-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------------------------+</span></span>
<span id="cb581-4"><a href="#cb581-4" aria-hidden="true" tabindex="-1"></a>| <span class="op">-</span><span class="fl">99.0</span>, <span class="op">-</span><span class="fl">98.0</span>, <span class="op">-</span><span class="fl">97.0</span>               |</span>
<span id="cb581-5"><a href="#cb581-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------------------------+</span></span>
<span id="cb581-6"><a href="#cb581-6" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<blockquote>
<p>NOTE! While we deny <code>TO_STRING()</code> existence and disavow
creating it, those examples may (to our greatest surprise, of course)
still work without change. Those dreaded cases when a purely
hypothetical developer may, perhaps, be too hypothetically lazy to
properly support <code>FLOAT_VEC</code> columns in result sets…</p>
</blockquote>
<h3 id="vsum-function"><code>VSUM()</code> function</h3>
<div class="sourceCode" id="cb582"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb582-1"><a href="#cb582-1" aria-hidden="true" tabindex="-1"></a>VSUM(<span class="op">&lt;</span>vec<span class="op">&gt;</span>)</span></code></pre></div>
<p><code>VSUM()</code> sums all components of an argument vector.</p>
<p>Its argument must be a float vector (either built with
<code>FVEC()</code> or <code>FVECX()</code> function, or returned from
another vector function).</p>
<div class="sourceCode" id="cb583"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb583-1"><a href="#cb583-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> vsum(fvec(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>));</span>
<span id="cb583-2"><a href="#cb583-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------+</span></span>
<span id="cb583-3"><a href="#cb583-3" aria-hidden="true" tabindex="-1"></a>| vsum(fvec(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)) |</span>
<span id="cb583-4"><a href="#cb583-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------+</span></span>
<span id="cb583-5"><a href="#cb583-5" aria-hidden="true" tabindex="-1"></a>| <span class="fl">6.0</span>               |</span>
<span id="cb583-6"><a href="#cb583-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-------------------+</span></span>
<span id="cb583-7"><a href="#cb583-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="wordpairctr-function"><code>WORDPAIRCTR()</code> function</h3>
<div class="sourceCode" id="cb584"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb584-1"><a href="#cb584-1" aria-hidden="true" tabindex="-1"></a>WORDPAIRCTR(<span class="st">&#39;field&#39;</span>, <span class="st">&#39;bag of keywords&#39;</span>)</span></code></pre></div>
<p><code>WORDPAIRCTR()</code> returns the word pairs CTR computed for a
given field (which must be with tokhashes) and a given “replacement
query”, an arbitrary bag of keywords.</p>
<p>Auto-converts to a constant 0 when there are no eligible “query”
keywords, ie. no keywords that were mentioned in the settings file.
Otherwise computes just as <code>wordpair_ctr</code> signal, ie. returns
-1 when the total “views” are strictly under the threshold, or “clicks”
to “views” ratio otherwise.</p>
<p>For more info on how specifically the values are calculated, see the
<a href="#ranking-tokhashes-and-wordpair_ctr">“Ranking: tokhashes…”</a>
section.</p>
<h3 id="zonespanlist-function"><code>ZONESPANLIST()</code> function</h3>
<div class="sourceCode" id="cb585"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb585-1"><a href="#cb585-1" aria-hidden="true" tabindex="-1"></a>ZONESPANLIST()</span></code></pre></div>
<p><code>ZONESPANLIST()</code> returns the list of all the spans matched
by a <code>ZONESPAN</code> operator, using a simple text format. Each
matching (contiguous) span is encoded with a
<code>&lt;query_zone_id&gt;:&lt;doc_span_seq&gt;</code> pair of numbers,
and all such pairs are then joined into a space separated string.</p>
<p>For example!</p>
<div class="sourceCode" id="cb586"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb586-1"><a href="#cb586-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">CREATE</span> <span class="kw">TABLE</span> test (<span class="kw">id</span> BIGINT, title FIELD)</span>
<span id="cb586-2"><a href="#cb586-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">OPTION</span> html_strip<span class="op">=</span><span class="dv">1</span>, index_zones<span class="op">=</span><span class="st">&#39;b,i&#39;</span>;</span>
<span id="cb586-3"><a href="#cb586-3" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb586-4"><a href="#cb586-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb586-5"><a href="#cb586-5" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">INSERT</span> <span class="kw">INTO</span> test <span class="kw">VALUES</span> (<span class="dv">123</span>, <span class="st">&#39;&lt;b&gt;&lt;i&gt;italic text&lt;/i&gt; regular text</span></span>
<span id="cb586-6"><a href="#cb586-6" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;i&gt;red herring text&lt;/i&gt; filler &lt;i&gt;more text is italic&lt;/i&gt;&lt;/b&gt;&#39;</span>);</span>
<span id="cb586-7"><a href="#cb586-7" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb586-8"><a href="#cb586-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb586-9"><a href="#cb586-9" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, ZONESPANLIST() <span class="kw">FROM</span> test</span>
<span id="cb586-10"><a href="#cb586-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> MATCH(<span class="st">&#39;ZONESPAN:(x,y,z,i) italic text&#39;</span>);</span>
<span id="cb586-11"><a href="#cb586-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------+</span></span>
<span id="cb586-12"><a href="#cb586-12" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | zonespanlist() |</span>
<span id="cb586-13"><a href="#cb586-13" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------+</span></span>
<span id="cb586-14"><a href="#cb586-14" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> |  <span class="dv">4</span><span class="ch">:1</span> <span class="dv">4</span><span class="ch">:3</span>       |</span>
<span id="cb586-15"><a href="#cb586-15" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------+</span></span>
<span id="cb586-16"><a href="#cb586-16" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>How to decipher this?</p>
<p>Our document has 1 contiguous span of the “B” zone (covering the
entire field), and 3 spans of the “I” zone. Our query requires that both
keywords (<code>italic</code> and <code>text</code>) match in a
contiguous span of any of the four zones. The “I” zone number <strong>in
the operator</strong> naturally is 4. The matching spans of “I” are
indeed spans number 1 and 3, because the span number 2 does not have
<strong>both</strong> keywords. And so we get <code>4:1 4:3</code>,
meaning that 1st and 3rd spans of the 4th zone matched.</p>
<p>However, beware of the <strong>nested</strong> zones and overlapping
spans.</p>
<div class="sourceCode" id="cb587"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb587-1"><a href="#cb587-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="kw">id</span>, ZONESPANLIST() <span class="kw">FROM</span> test</span>
<span id="cb587-2"><a href="#cb587-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> MATCH(<span class="st">&#39;ZONESPAN:(a,b,c,i) red filler&#39;</span>);</span>
<span id="cb587-3"><a href="#cb587-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------+</span></span>
<span id="cb587-4"><a href="#cb587-4" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | zonespanlist() |</span>
<span id="cb587-5"><a href="#cb587-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------+</span></span>
<span id="cb587-6"><a href="#cb587-6" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> |  <span class="dv">2</span><span class="ch">:1</span> <span class="dv">4</span><span class="ch">:2</span>       |</span>
<span id="cb587-7"><a href="#cb587-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+----------------+</span></span>
<span id="cb587-8"><a href="#cb587-8" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>This correctly claims that 1st span of the 2nd zone (zone “B”)
matches, but why does the 2nd span of the 4th zone (zone “I”) also
matchmatching? That <code>filler</code> keyword is never in the “I” zone
at all, and it is required to match, no?!</p>
<p>Here’s the thing. The matching engine only tracks <em>what</em>
keyword occurrences matched, but not <em>why</em> they matched. Both
<strong>occurrences</strong> of <code>red</code> and <code>filler</code>
get <strong>correctly</strong> marked as matched, because they
<em>do</em> indeed match in the “B” zone. And then, when computing
<code>ZONESPANLIST()</code> and marking <strong>spans</strong> based on
matched <strong>occurences</strong>, the 2nd span of “I” gets
<strong>incorrectly</strong> marked matched, because there’s a matching
occurrence of <code>red</code> in that span, but no more telling
<em>why</em> it matched.</p>
<p>Obviously, that can’t happen with independent zones (not nested, or
otherwise overlapping). The engine can’t <em>easily</em> detect that
zones used in <code>ZONESPAN</code> overlap either (enabling such an
“overlap check” at query time is possible, but not “easy”, it would
impact both index size and build time). Making sure that your zones play
along with your <code>ZONESPAN</code> operators falls entirely on
you.</p>
<p>Zones are tricky!</p>
<h2 id="server-variables-reference">Server variables reference</h2>
<p><code>searchd</code> has a number of server variables that can be
changed on the fly using the <code>SET GLOBAL var = value</code>
statement. Note how some of these are runtime only, and will revert to
the default values on every <code>searchd</code> restart. Others may be
also set via the config file, and will revert to those config values on
restart. This section provides a reference on all those variables.</p>
<ul>
<li><a
href="#agent-connection-variables"><code>agent_connect_timeout</code></a></li>
<li><a
href="#agent-request-hedging-variables"><code>agent_hedge</code></a></li>
<li><a
href="#agent-request-hedging-variables"><code>agent_hedge_delay_min_msec</code></a></li>
<li><a
href="#agent-request-hedging-variables"><code>agent_hedge_delay_pct</code></a></li>
<li><a
href="#agent-connection-variables"><code>agent_query_timeout</code></a></li>
<li><a
href="#agent-connection-variables"><code>agent_retry_count</code></a></li>
<li><a
href="#agent-connection-variables"><code>agent_retry_delay</code></a></li>
<li><a
href="#attrindex_thresh-variable"><code>attrindex_thresh</code></a></li>
<li><a
href="#client_timeout-variable"><code>client_timeout</code></a></li>
<li><a href="#cpu_stats-variable"><code>cpu_stats</code></a></li>
<li><a
href="#ha_period_karma-variable"><code>ha_period_karma</code></a></li>
<li><a
href="#ha_ping_interval-variable"><code>ha_ping_interval</code></a></li>
<li><a href="#ha_weight-variable"><code>ha_weight</code></a></li>
<li><a
href="#log_debug_filter-variable"><code>log_debug_filter</code></a></li>
<li><a href="#log_level-variable"><code>log_level</code></a></li>
<li><a href="#max_filters-variable"><code>max_filters</code></a></li>
<li><a
href="#max_filter_values-variable"><code>max_filter_values</code></a></li>
<li><a
href="#net_spin_msec-variable"><code>net_spin_msec</code></a></li>
<li><a
href="#query-cache-variables"><code>qcache_max_bytes</code></a></li>
<li><a
href="#query-cache-variables"><code>qcache_thresh_msec</code></a></li>
<li><a
href="#query-cache-variables"><code>qcache_ttl_sec</code></a></li>
<li><a
href="#query_log_min_msec-variable"><code>query_log_min_msec</code></a></li>
<li><a href="#read_timeout-variable"><code>read_timeout</code></a></li>
<li><a
href="#repl_blacklist-variable"><code>repl_blacklist</code></a></li>
<li><a href="#siege-mode"><code>siege</code></a></li>
<li><a href="#siege-mode"><code>siege_max_fetched_docs</code></a></li>
<li><a
href="#sphinxql_timeout-variable"><code>sphinxql_timeout</code></a></li>
<li><a
href="#sql_fail_filter-variable"><code>sql_fail_filter</code></a></li>
<li><a href="#sql_log_file-variable"><code>sql_log_file</code></a></li>
<li><a
href="#sql_log_filter-variable"><code>sql_log_filter</code></a></li>
<li><a href="#use_avx512-variable"><code>use_avx512</code></a></li>
</ul>
<h3 id="agent-connection-variables">Agent connection variables</h3>
<div class="sourceCode" id="cb588"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb588-1"><a href="#cb588-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> agent_connect_timeout <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb588-2"><a href="#cb588-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> agent_query_timeout <span class="op">=</span> <span class="dv">3000</span></span>
<span id="cb588-3"><a href="#cb588-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> agent_retry_count <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb588-4"><a href="#cb588-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> agent_retry_delay <span class="op">=</span> <span class="dv">50</span></span></code></pre></div>
<p>Network connections to agents (remote <code>searchd</code> instances)
come with several associated timeout and retry settings. Those can be
adjusted either in config on per-index level, or even in
<code>SELECT</code> on per-query level. However, in absence of any
explicit per-index or per-query settings, the global per-server settings
take effect. Which can, too, be adjusted on the fly.</p>
<p>The specific settings and their defaults are as follows.</p>
<ul>
<li><code>agent_connect_timeout</code> is the connect timeout, in msec.
Defaults to 1000.</li>
<li><code>agent_query_timeout</code> is the query timeout, in msec.
Defaults to 3000.</li>
<li><code>agent_retry_count</code> is the number of retries to make.
Defaults to 0.</li>
<li><code>agent_retry_delay</code> is the delay between retries, in
msec. Defaults to 500.</li>
</ul>
<h3 id="agent-request-hedging-variables">Agent request hedging
variables</h3>
<p>There are a few settings that control when exactly should Sphinx
issue a second, hedged request (for cases when one of the agents seems
likely to be slowing down everyone else).</p>
<ul>
<li><code>agent_hedge</code> is whether we perform hedge request, 0 or
1.</li>
<li><code>agent_hedge_delay_min_msec</code> is the min “static” delay.
Default is 20 ms.</li>
<li><code>agent_hedge_delay_pct</code> is the min “dynamic” delay.
Default is 20 (percent).</li>
</ul>
<p>See <a href="#request-hedging">“Request hedging”</a> for details.</p>
<h3 id="attrindex_thresh-variable"><code>attrindex_thresh</code>
variable</h3>
<div class="sourceCode" id="cb589"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb589-1"><a href="#cb589-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> attrindex_thresh <span class="op">=</span> <span class="dv">256</span></span></code></pre></div>
<p>Minimum segment size required to enable building the <a
href="#using-attribute-indexes">attribute indexes</a>, counted in rows.
Default is 1024.</p>
<p>Sphinx will only create attribute indexes for “large enough” segments
(be those RAM or disk segments). As a corollary, if the entire FT index
is small enough, ie. under this threshold, attribute indexes will not be
engaged at all.</p>
<p>At the moment, this setting seem useful for testing and debugging
only, and normally you must not need to tweak it in production.</p>
<h3 id="client_timeout-variable"><code>client_timeout</code>
variable</h3>
<div class="sourceCode" id="cb590"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb590-1"><a href="#cb590-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> client_timeout <span class="op">=</span> <span class="dv">15</span></span></code></pre></div>
<p>Sets the allowed timeout between requests for SphinxAPI clients using
persistent connections. Counted in sec, default is 300, or 5
minutes.</p>
<p>See also <a
href="#read_timeout-variable"><code>read_timeout</code></a> and <a
href="#sphinxql_timeout-variable"><code>sphinxql_timeout</code></a>.</p>
<h3 id="cpu_stats-variable"><code>cpu_stats</code> variable</h3>
<div class="sourceCode" id="cb591"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb591-1"><a href="#cb591-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> cpu_stats <span class="op">=</span> {<span class="dv">0</span> | <span class="dv">1</span>}</span></code></pre></div>
<p>Whether to compute and return actual CPU time (rather than wall time)
stats. Boolean, default is 0. Can be also set to 1 by
<code>--cpustats</code> CLI switch.</p>
<h3 id="ha_period_karma-variable"><code>ha_period_karma</code>
variable</h3>
<div class="sourceCode" id="cb592"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb592-1"><a href="#cb592-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> ha_period_karma <span class="op">=</span> <span class="dv">120</span></span></code></pre></div>
<p>Sets the size of the time window used to pick a specific HA agent.
Counted in sec, default is 60, or 1 minute.</p>
<h3 id="ha_ping_interval-variable"><code>ha_ping_interval</code>
variable</h3>
<div class="sourceCode" id="cb593"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb593-1"><a href="#cb593-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> ha_ping_interval <span class="op">=</span> <span class="dv">500</span></span></code></pre></div>
<p>Sets the delay between the periodic HA agent pings. Counted in msec,
default is 1000, or 1 second.</p>
<h3 id="ha_weight-variable"><code>ha_weight</code> variable</h3>
<div class="sourceCode" id="cb594"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb594-1"><a href="#cb594-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> ha_weight <span class="op">=</span> <span class="dv">80</span></span></code></pre></div>
<p>Sets the balancing weight for the host. Used with weighted
round-robin strategy. This is a percentage, so naturally it must be in
the 0 to 100 range.</p>
<p>The default weight is 100, meaning “full load” (as determined by the
balancer node). The minimum weight is 0, meaning “no load”, ie. the
balancer should not send any requests to such a host.</p>
<p>This variable gets persisted in <code>sphinxql_state</code> and must
survive the daemon restart.</p>
<h3 id="log_debug_filter-variable"><code>log_debug_filter</code>
variable</h3>
<div class="sourceCode" id="cb595"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb595-1"><a href="#cb595-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> log_debug_filter <span class="op">=</span> <span class="st">&#39;ReadLock&#39;</span></span></code></pre></div>
<p>Suppresses debug-level log entries that start with a given prefix.
Default is empty string, ie. do not suppress any entries.</p>
<p>This makes <code>searchd</code> less chatty at <code>debug</code> and
higher <code>log_level</code> levels.</p>
<p>At the moment, this setting seem useful for testing and debugging
only, and normally you must not need to tweak it in production.</p>
<h3 id="log_level-variable"><code>log_level</code> variable</h3>
<div class="sourceCode" id="cb596"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb596-1"><a href="#cb596-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> log_level <span class="op">=</span> {info | <span class="kw">debug</span> | debugv | debugvv}<span class="st">&#39;</span></span></code></pre></div>
<p>Sets the current logging level. Default (and minimum) level is
<code>info</code>.</p>
<p>This variable is useful to temporarily enable debug logging in
<code>searchd</code>, with this or that verboseness level.</p>
<p>At the moment, this setting seem useful for testing and debugging
only, and normally you must not need to tweak it in production.</p>
<h3 id="max_filters-variable"><code>max_filters</code> variable</h3>
<div class="sourceCode" id="cb597"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb597-1"><a href="#cb597-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> max_filters <span class="op">=</span> <span class="dv">32</span></span></code></pre></div>
<p>Sets the max number of filters (individual <code>WHERE</code>
conditions) that the SphinxAPI clients are allowed to send. Default is
256.</p>
<h3 id="max_filter_values-variable"><code>max_filter_values</code>
variable</h3>
<div class="sourceCode" id="cb598"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb598-1"><a href="#cb598-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> max_filter_values <span class="op">=</span> <span class="dv">32</span></span></code></pre></div>
<p>Sets the max number of values per a single filter (<code>WHERE</code>
condition) that the SphinxAPI clients are allowed to send. Default is
4096.</p>
<h3 id="net_spin_msec-variable"><code>net_spin_msec</code> variable</h3>
<div class="sourceCode" id="cb599"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb599-1"><a href="#cb599-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> net_spin_msec <span class="op">=</span> <span class="dv">30</span></span></code></pre></div>
<p>Sets the poller spinning period in the network thread. Default is 10
msec.</p>
<p>The usual thread CPU slice is basically in 5-10 msec range. (For the
really curious, a rather good starting point are the lines mentioning
“targeted preemption latency” and “minimal preemption granularity” in
<code>kernel/sched/fair.c</code> sources.)</p>
<p>Therefore, if a heavily loaded network thread calls
<code>epoll_wait()</code> with even a seemingly tiny 1 msec timeout,
that thread could occasionally get preempted and waste precious
microseconds. According to an ancient internal benchmark that we can
neither easily reproduce nor disavow these days (or in other words:
under certain circumstances), that can result in quite a significant
difference. More specifically, internal notes report ~3000 rps without
spinning (ie. with <code>net_spin_msec = 0</code>) vs ~5000 rps with
spinning.</p>
<p>Therefore, by default we choose to call <code>epoll_wait()</code>
with zero timeouts for the duration of <code>net_spin_msec</code>, so
that our “actual” slice for network thread is closer to those 10 msec,
just in case we get a lot of incoming queries.</p>
<h3 id="query-cache-variables">Query cache variables</h3>
<div class="sourceCode" id="cb600"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb600-1"><a href="#cb600-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> qcache_max_bytes <span class="op">=</span> <span class="dv">1000000000</span></span>
<span id="cb600-2"><a href="#cb600-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> qcache_thresh_msec <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb600-3"><a href="#cb600-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> qcache_ttl_sec <span class="op">=</span> <span class="dv">5</span></span></code></pre></div>
<p>All the query-cache related settings can be adjusted on the fly.
These variables simply map 1:1 to the respective <code>searchd</code>
config directives, and allow tweaking those on the fly.</p>
<p>For details, see the <a href="#searching-query-cache">“Searching:
query cache”</a> section.</p>
<h3 id="query_log_min_msec-variable"><code>query_log_min_msec</code>
variable</h3>
<div class="sourceCode" id="cb601"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb601-1"><a href="#cb601-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> query_log_min_msec <span class="op">=</span> <span class="dv">1000</span></span></code></pre></div>
<p>Changes the minimum elapsed time threshold for the queries to get
logged. Default is 1000 msec, ie. log all queries over 1 sec. The
allowed range is 0 to 3600000 (1 hour).</p>
<h3 id="read_timeout-variable"><code>read_timeout</code> variable</h3>
<div class="sourceCode" id="cb602"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb602-1"><a href="#cb602-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> read_timeout <span class="op">=</span> <span class="dv">1</span></span></code></pre></div>
<p>Sets the read timeout, aka the timeout to receive a specific request
from the SphinxAPI client. Counted in sec, default is 5.</p>
<p>See also <a
href="#client_timeout-variable"><code>client_timeout</code></a> and <a
href="#sphinxql_timeout-variable"><code>sphinxql_timeout</code></a>.</p>
<h3 id="repl_blacklist-variable"><code>repl_blacklist</code>
variable</h3>
<div class="sourceCode" id="cb603"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb603-1"><a href="#cb603-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> repl_blacklist <span class="op">=</span> <span class="st">&#39;{&lt;ip&gt;|&lt;host&gt;} [, ...]&#39;</span></span>
<span id="cb603-2"><a href="#cb603-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb603-3"><a href="#cb603-3" aria-hidden="true" tabindex="-1"></a># examples</span>
<span id="cb603-4"><a href="#cb603-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> repl_blacklist <span class="op">=</span> <span class="st">&#39;8.8.8.8&#39;</span></span>
<span id="cb603-5"><a href="#cb603-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> repl_blacklist <span class="op">=</span> <span class="st">&#39;192.168.1.21, 192.168.1.22, host-abcd.internal&#39;</span></span>
<span id="cb603-6"><a href="#cb603-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> repl_blacklist <span class="op">=</span> <span class="st">&#39;*&#39;</span></span></code></pre></div>
<p>A master-side list of blocked follower addresses (IPs and/or
hostnames).</p>
<p>Master will reject all replication requests from all blocked follower
hosts. At the moment, hostnames are <strong>not</strong> cached, lookups
happen on every request.</p>
<p>Follower will receive proper error messages when blocked (every
replica on that follower will gets its own error), but in the current
implementation, it will not stop retrying until manually disabled.</p>
<p>The list can contain either specific IPv4 addresses, or hostnames
(resolving to a single specific IPv4 address).</p>
<p>The only currently supported wildcard is <code>*</code> and it blocks
everything.</p>
<p>The empty string naturally blocks nothing.</p>
<p>The intended use is temporary, and for emergency situations only. For
instance, to fully shut off replicas that are fetching snapshots too
actively, and killing master’s disks (and writes!) doing that.</p>
<h3 id="sphinxql_timeout-variable"><code>sphinxql_timeout</code>
variable</h3>
<div class="sourceCode" id="cb604"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb604-1"><a href="#cb604-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> sphinxql_timeout <span class="op">=</span> <span class="dv">1</span></span></code></pre></div>
<p>Sets the timeout between queries for SphinxQL client. Counted in sec,
default is 900, or 15 minutes.</p>
<p>See also <a
href="#client_timeout-variable"><code>client_timeout</code></a> and <a
href="#read_timeout-variable"><code>read_timeout</code></a>.</p>
<h3 id="sql_fail_filter-variable"><code>sql_fail_filter</code>
variable</h3>
<div class="sourceCode" id="cb605"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb605-1"><a href="#cb605-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> sql_fail_filter <span class="op">=</span> <span class="st">&#39;insert&#39;</span></span></code></pre></div>
<p>The “fail filter” is a simple early stage filter imposed on all the
incoming SphinxQL queries. Any incoming queries that match a given
non-empty substring will immediately fail with an error.</p>
<p>This is useful for emergency maintenance, just as <a
href="#siege-mode">siege mode</a>. The two mechanisms are independent of
each other, ie. both fail filter and siege mode can be turned on
simultaneously.</p>
<p>As of v.3.2, the matching is simple, case-sensitive and bytewise.
This is likely to change in the future.</p>
<p>To remove the filter, set the value to an empty string.</p>
<div class="sourceCode" id="cb606"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb606-1"><a href="#cb606-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> sql_fail_filter <span class="op">=</span> <span class="st">&#39;&#39;</span></span></code></pre></div>
<h3 id="sql_log_file-variable"><code>sql_log_file</code> variable</h3>
<div class="sourceCode" id="cb607"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb607-1"><a href="#cb607-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> sql_log_file <span class="op">=</span> <span class="st">&#39;/tmp/sphinxlog.sql&#39;</span></span></code></pre></div>
<p>SQL log lets you (temporarily) enable logging all the incoming
SphinxQL queries, in (almost) raw form. Compared to
<code>query_log</code> directive, this logger:</p>
<ul>
<li>logs <em>all</em> SphinxQL queries, not just searches;</li>
<li>does <em>not</em> log any SphinxAPI calls;</li>
<li>does <em>not</em> have any noticeable performance impact;</li>
<li>is stopped by default.</li>
</ul>
<p>Queries are stored as received. A hardcoded <code>; /* EOQ */</code>
separator and then a newline are stored after every query, for parsing
convenience. It’s useful to capture and later replay a stream of (all)
client SphinxQL queries.</p>
<p>You can filter the stream a bit, see <code>sql_log_filter</code>
variable.</p>
<p>For performance reasons, SQL logging uses a rather big buffer (to the
tune of a few megabytes), so don’t be alarmed when <code>tail</code>
does not immediately display something after your start this log.</p>
<p>To stop SQL logging (and close and flush the log file), set the value
to an empty string.</p>
<div class="sourceCode" id="cb608"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb608-1"><a href="#cb608-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> sql_log_file <span class="op">=</span> <span class="st">&#39;&#39;</span></span></code></pre></div>
<p>We do <em>not</em> recommend keeping SQL logging on for prolonged
periods on loaded systems, as it might use a lot of disk space.</p>
<h3 id="sql_log_filter-variable"><code>sql_log_filter</code>
variable</h3>
<div class="sourceCode" id="cb609"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb609-1"><a href="#cb609-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> sql_log_filter <span class="op">=</span> <span class="st">&#39;UPDATE&#39;</span></span></code></pre></div>
<p>Filters the raw SphinxQL log in <code>sql_log_file</code> using a
given “needle” substring.</p>
<p>When enabled (ie. non-empty), only logs queries that have the given
substring. Matching is case sensitive. The example above aims to log
<code>UPDATE</code> statements. But it will also log anything that
mentions <code>UPDATE</code> as a constant, too.</p>
<h3 id="use_avx512-variable"><code>use_avx512</code> variable</h3>
<div class="sourceCode" id="cb610"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb610-1"><a href="#cb610-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> use_avx512 <span class="op">=</span> {<span class="dv">0</span> | <span class="dv">1</span>}</span></code></pre></div>
<p>Toggles the AVX-512 optimizations. See <a
href="#use_avx512-directive"><code>use_avx512</code></a> config
directive for details.</p>
<h2 id="index-config-reference">Index config reference</h2>
<p>This section should eventually contain the complete full-index
configuration directives reference, for the <code>index</code> sections
of the <code>sphinx.conf</code> file.</p>
<p>If the directive you’re looking for is not yet documented here,
please refer to the legacy <a href="sphinx2.html#confgroup-index">Sphinx
v.2.x reference</a>. Beware that the legacy reference may not be up to
date.</p>
<p>Here’s a complete list of index configuration directives.</p>
<ul>
<li><a href="sphinx2.html#conf-agent"><code>agent</code></a></li>
<li><a
href="sphinx2.html#conf-agent-blackhole"><code>agent_blackhole</code></a></li>
<li><a
href="sphinx2.html#conf-agent-connect-timeout"><code>agent_connect_timeout</code></a></li>
<li><a
href="sphinx2.html#conf-agent-persistent"><code>agent_persistent</code></a></li>
<li><a
href="sphinx2.html#conf-agent-query-timeout"><code>agent_query_timeout</code></a></li>
<li><a href="#annot_eot-directive"><code>annot_eot</code></a></li>
<li><a href="#annot_field-directive"><code>annot_field</code></a></li>
<li><a href="#annot_scores-directive"><code>annot_scores</code></a></li>
<li><a href="#attr_bigint-directive"><code>attr_bigint</code></a></li>
<li><a
href="#attr_bigint_set-directive"><code>attr_bigint_set</code></a></li>
<li><a href="#attr_blob-directive"><code>attr_blob</code></a></li>
<li><a href="#attr_bool-directive"><code>attr_bool</code></a></li>
<li><a href="#attr_float-directive"><code>attr_float</code></a></li>
<li><a
href="#attr_float_array-directive"><code>attr_float_array</code></a></li>
<li><a
href="#attr_int8_array-directive"><code>attr_int8_array</code></a></li>
<li><a
href="#attr_int_array-directive"><code>attr_int_array</code></a></li>
<li><a href="#attr_json-directive"><code>attr_json</code></a></li>
<li><a href="#attr_string-directive"><code>attr_string</code></a></li>
<li><a href="#attr_uint-directive"><code>attr_uint</code></a></li>
<li><a
href="#attr_uint_set-directive"><code>attr_uint_set</code></a></li>
<li><a
href="sphinx2.html#conf-bigram-freq-words"><code>bigram_freq_words</code></a></li>
<li><a
href="sphinx2.html#conf-bigram-index"><code>bigram_index</code></a></li>
<li><a href="#blackhole-directive"><code>blackhole</code></a></li>
<li><a
href="#blackhole_sample_div-directive"><code>blackhole_sample_div</code></a></li>
<li><a
href="sphinx2.html#conf-blend-chars"><code>blend_chars</code></a></li>
<li><a
href="#blend_mixed_codes-directive"><code>blend_mixed_codes</code></a></li>
<li><a
href="sphinx2.html#conf-blend-mode"><code>blend_mode</code></a></li>
<li><a
href="#bpe_merges_file-directive"><code>bpe_merges_file</code></a></li>
<li><a
href="sphinx2.html#conf-charset-table"><code>charset_table</code></a></li>
<li><a href="#create_index-directive"><code>create_index</code></a></li>
<li><a
href="#docstore_block-directive"><code>docstore_block</code></a></li>
<li><a
href="#docstore_comp-directive"><code>docstore_comp</code></a></li>
<li><a
href="#docstore_type-directive"><code>docstore_type</code></a></li>
<li><a
href="sphinx2.html#conf-embedded-limit"><code>embedded_limit</code></a></li>
<li><a
href="sphinx2.html#conf-exceptions"><code>exceptions</code></a></li>
<li><a
href="sphinx2.html#conf-expand-keywords"><code>expand_keywords</code></a></li>
<li><a href="#field-directive"><code>field</code></a></li>
<li><a href="#field_string-directive"><code>field_string</code></a></li>
<li><a
href="#global_avg_field_lengths-directive"><code>global_avg_field_lengths</code></a></li>
<li><a href="#global_idf-directive"><code>global_idf</code></a></li>
<li><a
href="sphinx2.html#conf-ha-strategy"><code>ha_strategy</code></a></li>
<li><a href="#hl_fields-directive"><code>hl_fields</code></a></li>
<li><a
href="sphinx2.html#conf-html-index-attrs"><code>html_index_attrs</code></a></li>
<li><a
href="sphinx2.html#conf-html-remove-elements"><code>html_remove_elements</code></a></li>
<li><a
href="sphinx2.html#conf-html-strip"><code>html_strip</code></a></li>
<li><a
href="sphinx2.html#conf-ignore-chars"><code>ignore_chars</code></a></li>
<li><a
href="#index_bpetok_fields-directive"><code>index_bpetok_fields</code></a></li>
<li><a
href="sphinx2.html#conf-index-exact-words"><code>index_exact_words</code></a></li>
<li><a
href="sphinx2.html#conf-index-field-lengths"><code>index_field_lengths</code></a></li>
<li><a href="sphinx2.html#conf-index-sp"><code>index_sp</code></a></li>
<li><a
href="#index_tokclass_fields-directive"><code>index_tokclass_fields</code></a></li>
<li><a
href="#index_tokhash_fields-directive"><code>index_tokhash_fields</code></a></li>
<li><a
href="#index_trigram_fields-directive"><code>index_trigram_fields</code></a></li>
<li><a
href="#index_words_clickstat_fields-directive"><code>index_words_clickstat_fields</code></a></li>
<li><a
href="sphinx2.html#conf-index-zones"><code>index_zones</code></a></li>
<li><a href="#join_attrs-directive"><code>join_attrs</code></a></li>
<li><a href="#kbatch-directive"><code>kbatch</code></a></li>
<li><a
href="#kbatch_source-directive"><code>kbatch_source</code></a></li>
<li><a href="sphinx2.html#conf-local"><code>local</code></a></li>
<li><a href="#mappings-directive"><code>mappings</code></a></li>
<li><a
href="sphinx2.html#conf-min-infix-len"><code>min_infix_len</code></a></li>
<li><a
href="sphinx2.html#conf-min-prefix-len"><code>min_prefix_len</code></a></li>
<li><a
href="sphinx2.html#conf-min-stemming-len"><code>min_stemming_len</code></a></li>
<li><a
href="sphinx2.html#conf-min-word-len"><code>min_word_len</code></a></li>
<li><a
href="#mixed_codes_fields-directive"><code>mixed_codes_fields</code></a></li>
<li><a href="sphinx2.html#conf-mlock"><code>mlock</code></a></li>
<li><a href="#morphdict-directive"><code>morphdict</code></a></li>
<li><a
href="sphinx2.html#conf-morphology"><code>morphology</code></a></li>
<li><a
href="sphinx2.html#conf-ngram-chars"><code>ngram_chars</code></a></li>
<li><a
href="sphinx2.html#conf-ngram-len"><code>ngram_len</code></a></li>
<li><a
href="sphinx2.html#conf-ondisk-attrs"><code>ondisk_attrs</code></a></li>
<li><a
href="sphinx2.html#conf-overshort-step"><code>overshort_step</code></a></li>
<li><a href="sphinx2.html#conf-path"><code>path</code></a></li>
<li><a href="#pq_max_rows-directive"><code>pq_max_rows</code></a></li>
<li><a href="sphinx2.html#conf-preopen"><code>preopen</code></a></li>
<li><a
href="#pretrained_index-directive"><code>pretrained_index</code></a></li>
<li><a
href="#query_words_clickstat-directive"><code>query_words_clickstat</code></a></li>
<li><a
href="sphinx2.html#conf-regexp-filter"><code>regexp_filter</code></a></li>
<li><a href="#repl_follow-directive"><code>repl_follow</code></a></li>
<li><a href="#required-directive"><code>required</code></a></li>
<li><a href="#rt_mem_limit-directive"><code>rt_mem_limit</code></a></li>
<li><a href="sphinx2.html#conf-source"><code>source</code></a></li>
<li><a
href="sphinx2.html#conf-stopword-step"><code>stopword_step</code></a></li>
<li><a
href="sphinx2.html#conf-stopwords"><code>stopwords</code></a></li>
<li><a
href="sphinx2.html#conf-stopwords-unstemmed"><code>stopwords_unstemmed</code></a></li>
<li><a
href="#stored_fields-directive"><code>stored_fields</code></a></li>
<li><a
href="#stored_only_fields-directive"><code>stored_only_fields</code></a></li>
<li><a href="#tokclasses-directive"><code>tokclasses</code></a></li>
<li><a href="#index-type-directive"><code>type</code></a></li>
<li><a
href="#universal_attrs-directive"><code>universal_attrs</code></a></li>
<li><a href="#updates_pool-directive"><code>updates_pool</code></a></li>
</ul>
<h3 id="annot_eot-directive"><code>annot_eot</code> directive</h3>
<div class="sourceCode" id="cb611"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb611-1"><a href="#cb611-1" aria-hidden="true" tabindex="-1"></a><span class="ex">annot_eot</span> = <span class="op">&lt;</span>separator_token<span class="op">&gt;</span></span>
<span id="cb611-2"><a href="#cb611-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb611-3"><a href="#cb611-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb611-4"><a href="#cb611-4" aria-hidden="true" tabindex="-1"></a><span class="ex">annot_eot</span> = MyMagicSeparator</span></code></pre></div>
<p>This directive configures a raw separator token for the annotations
field, used to separate the individual annotations within the field.</p>
<p>For more details, refer to the <a
href="#using-annotations">annotations docs section</a>.</p>
<h3 id="annot_field-directive"><code>annot_field</code> directive</h3>
<div class="sourceCode" id="cb612"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb612-1"><a href="#cb612-1" aria-hidden="true" tabindex="-1"></a><span class="ex">annot_field</span> = <span class="op">&lt;</span>ft_field<span class="op">&gt;</span></span>
<span id="cb612-2"><a href="#cb612-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb612-3"><a href="#cb612-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb612-4"><a href="#cb612-4" aria-hidden="true" tabindex="-1"></a><span class="ex">annot_field</span> = annots</span></code></pre></div>
<p>This directive marks the specified field as the annotations field.
The field must be present in the index, ie. for RT indexes, it must be
configured using the <code>field</code> directive anyway.</p>
<p>For more details, refer to the <a
href="#using-annotations">annotations docs section</a>.</p>
<h3 id="annot_scores-directive"><code>annot_scores</code> directive</h3>
<div class="sourceCode" id="cb613"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb613-1"><a href="#cb613-1" aria-hidden="true" tabindex="-1"></a><span class="ex">annot_scores</span> = <span class="op">&lt;</span>json_attr<span class="op">&gt;</span>.<span class="op">&lt;</span>scores_array<span class="op">&gt;</span></span>
<span id="cb613-2"><a href="#cb613-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb613-3"><a href="#cb613-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb613-4"><a href="#cb613-4" aria-hidden="true" tabindex="-1"></a><span class="ex">annot_scores</span> = j.annscores</span></code></pre></div>
<p>This directive configures the JSON key to use for
<code>annot_max_score</code> calculation. Must be a top-level key and
must point to a vector of floats (not doubles).</p>
<p>For more details, see the <a href="#annotations-scores">annotations
scores section</a>.</p>
<h3 id="attr_bigint-directive"><code>attr_bigint</code> directive</h3>
<div class="sourceCode" id="cb614"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb614-1"><a href="#cb614-1" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_bigint</span> = <span class="op">&lt;</span>attrname<span class="op">&gt;</span> [, <span class="op">&lt;</span>attrname<span class="op">&gt;</span> [, ...]]</span>
<span id="cb614-2"><a href="#cb614-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb614-3"><a href="#cb614-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb614-4"><a href="#cb614-4" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_bigint</span> = price</span></code></pre></div>
<p>This directive declares one (or more) <code>BIGINT</code> typed
attribute in your index, or in other words, a column that stores signed
64-bit integers.</p>
<p>Note how <code>BIGINT</code> values get <strong>clamped</strong> if
out of range, unfortunately unlike <code>UINT</code> values.</p>
<div class="sourceCode" id="cb615"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb615-1"><a href="#cb615-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">create</span> <span class="kw">table</span> tmp (<span class="kw">id</span> bigint, title field, x1 bigint);</span>
<span id="cb615-2"><a href="#cb615-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb615-3"><a href="#cb615-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb615-4"><a href="#cb615-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">insert</span> <span class="kw">into</span> tmp <span class="kw">values</span> (<span class="dv">123</span>, <span class="st">&#39;&#39;</span>, <span class="dv">13835058055282163712</span>);</span>
<span id="cb615-5"><a href="#cb615-5" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb615-6"><a href="#cb615-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb615-7"><a href="#cb615-7" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> tmp;</span>
<span id="cb615-8"><a href="#cb615-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------------+</span></span>
<span id="cb615-9"><a href="#cb615-9" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | x1                  |</span>
<span id="cb615-10"><a href="#cb615-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------------+</span></span>
<span id="cb615-11"><a href="#cb615-11" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | <span class="dv">9223372036854775807</span> |</span>
<span id="cb615-12"><a href="#cb615-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------------+</span></span>
<span id="cb615-13"><a href="#cb615-13" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>For more details, see the <a href="#using-index-schemas">“Using index
schemas”</a> section.</p>
<h3 id="attr_bigint_set-directive"><code>attr_bigint_set</code>
directive</h3>
<div class="sourceCode" id="cb616"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb616-1"><a href="#cb616-1" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_bigint_set</span> = <span class="op">&lt;</span>attrname<span class="op">&gt;</span> [, <span class="op">&lt;</span>attrname<span class="op">&gt;</span> [, ...]]</span>
<span id="cb616-2"><a href="#cb616-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb616-3"><a href="#cb616-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb616-4"><a href="#cb616-4" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_bigint_set</span> = tags, locations</span></code></pre></div>
<p>This directive declares one (or more) <code>BIGINT_SET</code> typed
attribute in your index, or in other words, a column that stores sets of
unique signed 64-bit integers.</p>
<p>For more details, see the <a href="#using-index-schemas">“Using index
schemas”</a> and the <a href="#using-set-attributes">“Using set
attributes</a> section.</p>
<h3 id="attr_blob-directive"><code>attr_blob</code> directive</h3>
<div class="sourceCode" id="cb617"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb617-1"><a href="#cb617-1" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_blob</span> = <span class="op">&lt;</span>attrname<span class="op">&gt;</span> [, <span class="op">&lt;</span>attrname<span class="op">&gt;</span> [, ...]]</span>
<span id="cb617-2"><a href="#cb617-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb617-3"><a href="#cb617-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb617-4"><a href="#cb617-4" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_blob</span> = guid</span>
<span id="cb617-5"><a href="#cb617-5" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_blob</span> = md5hash, sha1hash</span></code></pre></div>
<p>This directive declares one (or more) <code>BLOB</code> typed
attribute in your index, or in other words, a column that stores binary
strings, with embedded zeroes.</p>
<p>For more details, see the <a href="#using-index-schemas">“Using index
schemas”</a> and the <a href="#using-blob-attributes">“Using blob
attributes”</a> sections.</p>
<h3 id="attr_bool-directive"><code>attr_bool</code> directive</h3>
<div class="sourceCode" id="cb618"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb618-1"><a href="#cb618-1" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_bool</span> = <span class="op">&lt;</span>attrname<span class="op">&gt;</span> [, <span class="op">&lt;</span>attrname<span class="op">&gt;</span> [, ...]]</span>
<span id="cb618-2"><a href="#cb618-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb618-3"><a href="#cb618-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb618-4"><a href="#cb618-4" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_bool</span> = is_test, is_hidden</span></code></pre></div>
<p>This directive declares one (or more) <code>BOOL</code> typed
attribute in your index, or in other words, a column that stores a
boolean flag (0 or 1, false or true).</p>
<p><code>BOOL</code> is functionally equivalent to <code>UINT:1</code>
bitfield, and also saves RAM. Refer to <a
href="#attr_uint-directive">attr_uint docs</a> for details.</p>
<p>For more details, see the <a href="#using-index-schemas">“Using index
schemas”</a> section.</p>
<h3 id="attr_float-directive"><code>attr_float</code> directive</h3>
<div class="sourceCode" id="cb619"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb619-1"><a href="#cb619-1" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_float</span> = <span class="op">&lt;</span>attrname<span class="op">&gt;</span> [, <span class="op">&lt;</span>attrname<span class="op">&gt;</span> [, ...]]</span>
<span id="cb619-2"><a href="#cb619-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb619-3"><a href="#cb619-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb619-4"><a href="#cb619-4" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_float</span> = lat, lon</span></code></pre></div>
<p>This directive declares one (or more) <code>FLOAT</code> typed
attribute in your index, or in other words, a column that stores a
32-bit floating-point value.</p>
<p>The usual rules apply, but here’s the mandatory refresher.
<code>FLOAT</code> is a single precision, 32-bit IEEE 754 format.
Sensibly representable range is 1.175e-38 to 3.403e+38. The amount of
decimal digits that can be stored precisely “normally” varies from 6 to
9. (Meaning that on special boundary values <em>all</em> the digits can
and will change.) Integer values up to 16777216 can be stored exactly,
but anything after that loses precision. Never use <code>FLOAT</code>
type for prices, instead use <code>BIGINT</code> (or in weird cases even
<code>STRING</code>) type.</p>
<p>For more details, see the <a href="#using-index-schemas">“Using index
schemas”</a> section.</p>
<h3 id="attr_float_array-directive"><code>attr_float_array</code>
directive</h3>
<div class="sourceCode" id="cb620"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb620-1"><a href="#cb620-1" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_float_array</span> = <span class="op">&lt;</span>attrname<span class="op">&gt;</span> <span class="st">&#39;[&#39;</span> <span class="op">&lt;</span>arraysize<span class="op">&gt;</span> <span class="st">&#39;]&#39;</span> [, ...]</span>
<span id="cb620-2"><a href="#cb620-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb620-3"><a href="#cb620-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb620-4"><a href="#cb620-4" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_float_array</span> = coeffs[3]</span>
<span id="cb620-5"><a href="#cb620-5" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_float_array</span> = vec1[64], vec2[128]</span></code></pre></div>
<p>This directive declares one (or more) <code>FLOAT_ARRAY</code> typed
attribute in your index, or in other words, a column that stores an
array of 32-bit floating-point values. The dimensions (aka array sizes)
should be specified along with the names.</p>
<p>For more details, see the <a href="#using-index-schemas">“Using index
schemas”</a> and the <a href="#using-array-attributes">“Using array
attributes”</a> sections.</p>
<h3 id="attr_int8_array-directive"><code>attr_int8_array</code>
directive</h3>
<div class="sourceCode" id="cb621"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb621-1"><a href="#cb621-1" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_int8_array</span> = <span class="op">&lt;</span>attrname<span class="op">&gt;</span> <span class="st">&#39;[&#39;</span> <span class="op">&lt;</span>arraysize<span class="op">&gt;</span> <span class="st">&#39;]&#39;</span> [, ...]</span>
<span id="cb621-2"><a href="#cb621-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb621-3"><a href="#cb621-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb621-4"><a href="#cb621-4" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_int8_array</span> = smallguys[3]</span>
<span id="cb621-5"><a href="#cb621-5" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_int8_array</span> = vec1[64], vec2[128]</span></code></pre></div>
<p>This directive declares one (or more) <code>INT8_ARRAY</code> typed
attribute in your index, or in other words, a column that stores an
array of signed 8-bit integer values. The dimensions (aka array sizes)
should be specified along with the names.</p>
<p>For more details, see the <a href="#using-index-schemas">“Using index
schemas”</a> and the <a href="#using-array-attributes">“Using array
attributes”</a> sections.</p>
<h3 id="attr_int_array-directive"><code>attr_int_array</code>
directive</h3>
<div class="sourceCode" id="cb622"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb622-1"><a href="#cb622-1" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_int_array</span> = <span class="op">&lt;</span>attrname<span class="op">&gt;</span> <span class="st">&#39;[&#39;</span> <span class="op">&lt;</span>arraysize<span class="op">&gt;</span> <span class="st">&#39;]&#39;</span> [, ...]</span>
<span id="cb622-2"><a href="#cb622-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb622-3"><a href="#cb622-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb622-4"><a href="#cb622-4" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_int_array</span> = regularguys[3]</span>
<span id="cb622-5"><a href="#cb622-5" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_int_array</span> = vec1[64], vec2[128]</span></code></pre></div>
<p>This directive declares one (or more) <code>INT_ARRAY</code> typed
attribute in your index, or in other words, a column that stores an
array of signed 32-bit integer values. The dimensions (aka array sizes)
should be specified along with the names.</p>
<p>For more details, see the <a href="#using-index-schemas">“Using index
schemas”</a> and the <a href="#using-array-attributes">“Using array
attributes”</a> sections.</p>
<h3 id="attr_json-directive"><code>attr_json</code> directive</h3>
<div class="sourceCode" id="cb623"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb623-1"><a href="#cb623-1" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_json</span> = <span class="op">&lt;</span>attrname<span class="op">&gt;</span> [, <span class="op">&lt;</span>attrname<span class="op">&gt;</span> [, ...]]</span>
<span id="cb623-2"><a href="#cb623-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb623-3"><a href="#cb623-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb623-4"><a href="#cb623-4" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_json</span> = params</span></code></pre></div>
<p>This directive declares one (or more) <code>JSON</code> typed
attribute in your index, or in other words, a column that stores an
arbitrary JSON object.</p>
<p>JSON is internally stored using an efficient binary representation.
Arbitrarily complex JSONs with nested arrays, subobjects, etc are
supported. A few special Sphinx extensions to JSON syntax are also
supported.</p>
<p>Just as other attributes, all JSONs are supposed to fit in RAM. There
is a size limit of 4 MB per object (in the binary format).</p>
<p>For more details, see the <a href="#using-index-schemas">“Using index
schemas”</a> and the <a href="#using-json">“Using JSON”</a>
sections.</p>
<h3 id="attr_string-directive"><code>attr_string</code> directive</h3>
<div class="sourceCode" id="cb624"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb624-1"><a href="#cb624-1" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_string</span> = <span class="op">&lt;</span>attrname<span class="op">&gt;</span> [, <span class="op">&lt;</span>attrname<span class="op">&gt;</span> [, ...]]</span>
<span id="cb624-2"><a href="#cb624-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb624-3"><a href="#cb624-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb624-4"><a href="#cb624-4" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_string</span> = params</span></code></pre></div>
<p>This directive declares one (or more) <code>STRING</code> typed
attribute in your index, or in other words, a column that stores a text
string.</p>
<p><strong>Strings are expected to be UTF-8.</strong> Non-UTF strings
might actually even work to some extent, but at the end of the day,
that’s just asking for trouble. For non-UTF stuff use blobs instead.</p>
<p><strong>Strings are limited to 4 MB per value.</strong> Strings are
stored in RAM, hence some limits. For larger texts, enable DocStore, and
use stored fields.</p>
<p><strong>Strings are not full-text indexed.</strong> Only fields are.
Depending on your use case, you can either declare a special “full-text
field plus attribute” pair via <code>sql_field_string</code> (which
creates <em>both</em> a full-text indexed field and string attribute
sharing the same name), or use DocStore.</p>
<p>For more details, see the <a href="#using-index-schemas">“Using index
schemas”</a> section.</p>
<h3 id="attr_uint-directive"><code>attr_uint</code> directive</h3>
<div class="sourceCode" id="cb625"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb625-1"><a href="#cb625-1" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_uint</span> = <span class="op">&lt;</span>attrname[:bits]<span class="op">&gt;</span> [, <span class="op">&lt;</span>attrname[:bits]<span class="op">&gt;</span> [, ...]]</span>
<span id="cb625-2"><a href="#cb625-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb625-3"><a href="#cb625-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example one, regular uints</span></span>
<span id="cb625-4"><a href="#cb625-4" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_uint</span> = user_id</span>
<span id="cb625-5"><a href="#cb625-5" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_uint</span> = created_ts, verified_ts</span>
<span id="cb625-6"><a href="#cb625-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb625-7"><a href="#cb625-7" aria-hidden="true" tabindex="-1"></a><span class="co"># example two, bitfields</span></span>
<span id="cb625-8"><a href="#cb625-8" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_uint</span> = is_test:1</span>
<span id="cb625-9"><a href="#cb625-9" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_uint</span> = is_vip:1</span>
<span id="cb625-10"><a href="#cb625-10" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_uint</span> = country_id:8</span></code></pre></div>
<p>This directive normally declares one (or more) <code>UINT</code>
typed attribute in your index, or in other words, a column that stores
an unsigned 32-bit integer.</p>
<p>In its second form, it declares bitfields (also unsigned integers,
but shorter than 32 bits).</p>
<p>Out-of-range values <em>may</em> be wrapped around. Meaning that
passing <code>-1</code> <em>may</em> automatically wrap to
<code>4294967295</code> (the value for <code>2^32-1</code>) for regular
<code>UINT</code>, or <code>2^bits-1</code> for a narrower bitfield.
Historically they always were, and they still do, see just below. So why
this sudden “may or may not” semi-legalese?! Point is, just beware that
we <em>might</em> have to eventually tighten our type system in the
future, and somehow change this auto-wrapping behavior.</p>
<div class="sourceCode" id="cb626"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb626-1"><a href="#cb626-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">create</span> <span class="kw">table</span> tmp (<span class="kw">id</span> bigint, title field, i1 uint, i2 uint<span class="ch">:6</span>);</span>
<span id="cb626-2"><a href="#cb626-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">0</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb626-3"><a href="#cb626-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb626-4"><a href="#cb626-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">insert</span> <span class="kw">into</span> tmp <span class="kw">values</span> (<span class="dv">123</span>, <span class="st">&#39;&#39;</span>, <span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>);</span>
<span id="cb626-5"><a href="#cb626-5" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb626-6"><a href="#cb626-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb626-7"><a href="#cb626-7" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> tmp;</span>
<span id="cb626-8"><a href="#cb626-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------+------+</span></span>
<span id="cb626-9"><a href="#cb626-9" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | i1         | i2   |</span>
<span id="cb626-10"><a href="#cb626-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------+------+</span></span>
<span id="cb626-11"><a href="#cb626-11" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">123</span> | <span class="dv">4294967295</span> |   <span class="dv">63</span> |</span>
<span id="cb626-12"><a href="#cb626-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+------------+------+</span></span>
<span id="cb626-13"><a href="#cb626-13" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Bitfields must be from 1 to 31 bits wide.</p>
<p>Bitfields that are 1-bit wide are effectively equivalent to
<code>BOOL</code> type.</p>
<p>Bitfields are slightly slower to access (because masking), but
require less RAM. They are packed together in 4-bytes (32-bit) chunks.
So the very first bitfield (or <code>BOOL</code>) you add adds 4 bytes
per row, but then the <em>next</em> ones are “free” until those 32 bits
are exhausted. Then we rinse and repeat. For example.</p>
<div class="sourceCode" id="cb627"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb627-1"><a href="#cb627-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this takes 8 bytes per row, because 4*9 = 36 bits, which pads to 64 bits</span></span>
<span id="cb627-2"><a href="#cb627-2" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_uint</span> = i1:9, i2:9, i3:9, i4:9</span></code></pre></div>
<p>For more details, see the <a href="#using-index-schemas">“Using index
schemas”</a> section.</p>
<h3 id="attr_uint_set-directive"><code>attr_uint_set</code>
directive</h3>
<div class="sourceCode" id="cb628"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb628-1"><a href="#cb628-1" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_uint_set</span> = <span class="op">&lt;</span>attrname<span class="op">&gt;</span> [, <span class="op">&lt;</span>attrname<span class="op">&gt;</span> [, ...]]</span>
<span id="cb628-2"><a href="#cb628-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb628-3"><a href="#cb628-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb628-4"><a href="#cb628-4" aria-hidden="true" tabindex="-1"></a><span class="ex">attr_uint_set</span> = tags, locations</span></code></pre></div>
<p>This directive declares one (or more) <code>UINT_SET</code> typed
attribute in your index, or in other words, a column that stores sets of
unique unsigned 32-bit integers.</p>
<p>For more details, see the <a href="#using-index-schemas">“Using index
schemas”</a> and the <a href="#using-set-attributes">“Using set
attributes</a> section.</p>
<h3 id="blackhole-directive"><code>blackhole</code> directive</h3>
<div class="sourceCode" id="cb629"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb629-1"><a href="#cb629-1" aria-hidden="true" tabindex="-1"></a><span class="ex">blackhole</span> = {0 <span class="kw">|</span> <span class="ex">1}</span></span>
<span id="cb629-2"><a href="#cb629-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb629-3"><a href="#cb629-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb629-4"><a href="#cb629-4" aria-hidden="true" tabindex="-1"></a><span class="ex">blackhole</span> = 1</span></code></pre></div>
<p>This directive enables index usage in a blackhole agent in a
distributed index (that would be configured on a different remote host).
For details on blackholes see also <a
href="sphinx2.html#conf-agent-blackhole"><code>agent_blackhole</code>
directive</a>.</p>
<p>It applies to both local (plain/RT) indexes, <strong>and</strong> to
distributed indexes. When querying a distributed index configured with
<code>blackhole = 1</code>, all its local indexes will inherit that
setting.</p>
<p>Why is this needed?</p>
<p>Search queries are normally terminated when the client closes the
network connection from its side, to avoid wasting CPU. But search
queries to blackhole agents are usually intended to complete. The
easiest way to quickly implement that was this flag on the receiving
end, ie. at the blackhole agent itself.</p>
<p>So indexes with <code>blackhole = 1</code> do <strong>not</strong>
terminate query processing early, even when the clients goes away.</p>
<h3
id="blackhole_sample_div-directive"><code>blackhole_sample_div</code>
directive</h3>
<div class="sourceCode" id="cb630"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb630-1"><a href="#cb630-1" aria-hidden="true" tabindex="-1"></a><span class="ex">blackhole_sample_div</span> = <span class="op">&lt;</span>N<span class="op">&gt;</span></span>
<span id="cb630-2"><a href="#cb630-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb630-3"><a href="#cb630-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb630-4"><a href="#cb630-4" aria-hidden="true" tabindex="-1"></a><span class="ex">blackhole_sample_div</span> = 3</span></code></pre></div>
<p>This directive controls the fraction of search traffic to forward to
blackhole agents. It’s just a simple divisor that enables sending every
N-th search query. Default is 1, meaning to forward all traffic.</p>
<p>Why is this needed?</p>
<p>Assume that you have an HA cluster with 10 mirrors handling regular
workload, and just 1 blackhole mirror used for testing. Forwarding
<strong>all</strong> the searches to that blackhole mirror would result
in 10 times the regular load. Not great! This directive helps us balance
back the load.</p>
<div class="sourceCode" id="cb631"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb631-1"><a href="#cb631-1" aria-hidden="true" tabindex="-1"></a><span class="ex">agent</span> = box1:9312<span class="kw">|</span><span class="ex">box2:9312</span><span class="kw">|</span><span class="ex">...</span><span class="kw">|</span><span class="ex">box10:9312:shard01</span></span>
<span id="cb631-2"><a href="#cb631-2" aria-hidden="true" tabindex="-1"></a><span class="ex">agent_blackhole</span> = box11:9312:shard01</span>
<span id="cb631-3"><a href="#cb631-3" aria-hidden="true" tabindex="-1"></a><span class="ex">blackhole_sample_div</span> = 10</span></code></pre></div>
<blockquote>
<p>NOTE! This sampling only applies to <strong>search</strong> queries.
Writes (ie. <code>INSERT</code>, <code>REPLACE</code>,
<code>UPDATE</code>, and <code>DELETE</code> queries) are never subject
to sampling.</p>
</blockquote>
<h3 id="blend_mixed_codes-directive"><code>blend_mixed_codes</code>
directive</h3>
<div class="sourceCode" id="cb632"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb632-1"><a href="#cb632-1" aria-hidden="true" tabindex="-1"></a><span class="ex">blend_mixed_codes</span> = {0 <span class="kw">|</span> <span class="ex">1}</span></span>
<span id="cb632-2"><a href="#cb632-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb632-3"><a href="#cb632-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb632-4"><a href="#cb632-4" aria-hidden="true" tabindex="-1"></a><span class="ex">blend_mixed_codes</span> = 1</span></code></pre></div>
<p>Whether to detect and index parts of the “mixed codes” (aka
letter-digit mixes). Defaults to 0, do not index.</p>
<p>For more info, see the <a
href="#mixed-codes-with-letters-and-digits">“Mixed codes”</a>
section.</p>
<h3 id="bpe_merges_file-directive"><code>bpe_merges_file</code>
directive</h3>
<div class="sourceCode" id="cb633"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb633-1"><a href="#cb633-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bpe_merges_file</span> = <span class="op">&lt;</span>filename<span class="op">&gt;</span></span>
<span id="cb633-2"><a href="#cb633-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb633-3"><a href="#cb633-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb633-4"><a href="#cb633-4" aria-hidden="true" tabindex="-1"></a><span class="ex">bpe_merges_file</span> = merges.txt</span></code></pre></div>
<p>Name of the text file with BPE merge rules. Default is empty.</p>
<p>Format is <code>tok1 tok2</code> per line, encoding is UTF-8,
metaspace char is U+2581, comments not supported.</p>
<p>See <a href="#ranking-trigrams-and-bpe-tokens">“Ranking: trigrams and
BPE tokens”</a> section for more details.</p>
<h3 id="create_index-directive"><code>create_index</code> directive</h3>
<div class="sourceCode" id="cb634"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb634-1"><a href="#cb634-1" aria-hidden="true" tabindex="-1"></a><span class="ex">create_index</span> = <span class="op">&lt;</span>index_name<span class="op">&gt;</span> on <span class="op">&lt;</span>attr_or_json_key<span class="op">&gt;</span> [using <span class="op">&lt;</span>subtype<span class="op">&gt;</span>]</span>
<span id="cb634-2"><a href="#cb634-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb634-3"><a href="#cb634-3" aria-hidden="true" tabindex="-1"></a><span class="co"># examples</span></span>
<span id="cb634-4"><a href="#cb634-4" aria-hidden="true" tabindex="-1"></a><span class="ex">create_index</span> = idx_price on price</span>
<span id="cb634-5"><a href="#cb634-5" aria-hidden="true" tabindex="-1"></a><span class="ex">create_index</span> = idx_name on params.author.name</span>
<span id="cb634-6"><a href="#cb634-6" aria-hidden="true" tabindex="-1"></a><span class="ex">create_index</span> = idx_vec on vec1 using faiss_l1</span></code></pre></div>
<p>This directive makes <code>indexer</code> (or <code>searchd</code>)
create secondary indexes on attributes (or JSON keys) when rebuilding
the FT index. It’s supported for both plain and RT indexes.</p>
<p>To create several attribute indexes, specify several respective
<code>create_index</code> directives, one for each index.</p>
<p>Index creation is batched when using <code>indexer</code>, meaning
that <code>indexer</code> makes exactly one extra pass over the
attribute data, and populates <em>all</em> the indexes during that
pass.</p>
<p>As of v.3.8, any index creation errors are reported as
<code>indexer</code> or <code>searchd</code> <strong>warnings</strong>
only, not errors! The resulting FT index should still be generally
usable, even without the attribute indexes.</p>
<p>Note that you should remove the respective <code>create_index</code>
directives (if any) after an online <code>DROP INDEX</code>, otherwise
<code>searchd</code> will keep recreating those indexes on restarts.</p>
<p>There is also an optional <code>USING &lt;subtype&gt;</code> part
that matches the <code>USING</code> clause of the <a
href="#create-index-syntax"><code>CREATE INDEX</code> statement</a>.
This allows configuring the specific index subtype via the config,
too.</p>
<p>For now, there are 2 supported subtypes, both only applicable to
vector indexes, so the only practically useful form is to choose the
<code>L1</code> metric (instead of the default <code>DOT</code> metric)
for a vector index.</p>
<div class="sourceCode" id="cb635"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb635-1"><a href="#cb635-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index</span> mytest</span>
<span id="cb635-2"><a href="#cb635-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="cb635-3"><a href="#cb635-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">...</span></span>
<span id="cb635-4"><a href="#cb635-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the equivalent of:</span></span>
<span id="cb635-5"><a href="#cb635-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># CREATE INDEX idx_vec ON mytest(vec1) USING FAISS_L1</span></span>
<span id="cb635-6"><a href="#cb635-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">create_index</span> = idx_vec on vec1 using faiss_l1</span>
<span id="cb635-7"><a href="#cb635-7" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span></code></pre></div>
<h3 id="docstore_block-directive"><code>docstore_block</code>
directive</h3>
<div class="sourceCode" id="cb636"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb636-1"><a href="#cb636-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docstore_block</span> = <span class="op">&lt;</span>size<span class="op">&gt;</span> # supports k and m suffixes</span>
<span id="cb636-2"><a href="#cb636-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb636-3"><a href="#cb636-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb636-4"><a href="#cb636-4" aria-hidden="true" tabindex="-1"></a><span class="ex">docstore_block</span> = 32k</span></code></pre></div>
<p>Docstore target storage block size. Default is 16K, ie. 16384
bytes.</p>
<p>For more info, see the <a href="#using-docstore">“Using DocStore”</a>
section.</p>
<h3 id="docstore_comp-directive"><code>docstore_comp</code>
directive</h3>
<div class="sourceCode" id="cb637"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb637-1"><a href="#cb637-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docstore_comp</span> = {none <span class="kw">|</span> <span class="ex">lz4</span> <span class="kw">|</span> <span class="ex">lz4hc}</span></span></code></pre></div>
<p>Docstore block compression method. Default is LZ4HC, ie. use slower
but tigher codec.</p>
<p>For more info, see the <a href="#using-docstore">“Using DocStore”</a>
section.</p>
<h3 id="docstore_type-directive"><code>docstore_type</code>
directive</h3>
<div class="sourceCode" id="cb638"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb638-1"><a href="#cb638-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docstore_type</span> = {vblock <span class="kw">|</span> <span class="ex">vblock_solid}</span></span></code></pre></div>
<p>Docstore block compression type. Default is
<code>vblock_solid</code>, ie. compress the entire block rather than
individual documents in it.</p>
<p>For more info, see the <a href="#using-docstore">“Using DocStore”</a>
section.</p>
<h3 id="field-directive"><code>field</code> directive</h3>
<div class="sourceCode" id="cb639"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb639-1"><a href="#cb639-1" aria-hidden="true" tabindex="-1"></a><span class="ex">field</span> = <span class="op">&lt;</span>fieldname<span class="op">&gt;</span> [, <span class="op">&lt;</span>fieldname<span class="op">&gt;</span> [, ...]]</span>
<span id="cb639-2"><a href="#cb639-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb639-3"><a href="#cb639-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb639-4"><a href="#cb639-4" aria-hidden="true" tabindex="-1"></a><span class="ex">field</span> = title</span>
<span id="cb639-5"><a href="#cb639-5" aria-hidden="true" tabindex="-1"></a><span class="ex">field</span> = content, texttags, abstract</span></code></pre></div>
<p>This directive declares one (or more) full-text field in your index.
At least one field is required at all times.</p>
<p>Note that the original field contents are <em>not</em> stored by
default. If required, you can store them either in RAM as attributes, or
on disk using DocStore. For that, either use <a
href="#field_string-directive"><code>field_string</code></a>
<em>instead</em> of <code>field</code> for the in-RAM attributes route,
or <a href="#stored_fields-directive"><code>stored_fields</code></a> in
<em>addition</em> to <code>field</code> for the on-disk DocStore route,
respectively.</p>
<p>For more details, see the <a href="#using-index-schemas">“Using index
schemas”</a> and the <a href="#using-docstore">“Using DocStore”</a>
sections.</p>
<h3 id="field_string-directive"><code>field_string</code> directive</h3>
<div class="sourceCode" id="cb640"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb640-1"><a href="#cb640-1" aria-hidden="true" tabindex="-1"></a><span class="ex">field_string</span> = <span class="op">&lt;</span>fieldname<span class="op">&gt;</span> [, <span class="op">&lt;</span>fieldname<span class="op">&gt;</span> [, ...]]</span>
<span id="cb640-2"><a href="#cb640-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb640-3"><a href="#cb640-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb640-4"><a href="#cb640-4" aria-hidden="true" tabindex="-1"></a><span class="ex">field_string</span> = title, texttags</span></code></pre></div>
<p>This directive double-declares one (or more) full-text field
<em>and</em> the string attribute (that automatically stores a copy of
that field) in your index.</p>
<p>It’s useful to store copies of (short!) full-text fields in RAM for
fast and easy access. Rule of thumb, use this for short fields like
document titles, but use DocStore for huge things like contents.</p>
<p><code>field_string</code> columns should generally behave as a single
column that’s both full-text indexed and stored in RAM. Even though
internally full-text fields and string attributes are completely
independent entities.</p>
<p>For more details, see the <a href="#using-index-schemas">“Using index
schemas”</a> section.</p>
<h3
id="global_avg_field_lengths-directive"><code>global_avg_field_lengths</code>
directive</h3>
<div class="sourceCode" id="cb641"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb641-1"><a href="#cb641-1" aria-hidden="true" tabindex="-1"></a><span class="ex">global_avg_field_lengths</span> = <span class="op">&lt;</span>field1: avglen1<span class="op">&gt;</span> [, <span class="op">&lt;</span>field2: avglen2<span class="op">&gt;</span> ...]</span>
<span id="cb641-2"><a href="#cb641-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb641-3"><a href="#cb641-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb641-4"><a href="#cb641-4" aria-hidden="true" tabindex="-1"></a><span class="ex">global_avg_field_lengths</span> = title: 5.76, content: 138.24</span></code></pre></div>
<p>A static list of field names and their respective average lengths (in
tokens) that overrides the dynamic lengths computed by
<code>index_field_lengths</code> for BMxx calculation purposes.</p>
<p>For more info, see the <a href="#ranking-field-lengths">“Ranking:
field lengths”</a> section.</p>
<h3 id="global_idf-directive"><code>global_idf</code> directive</h3>
<div class="sourceCode" id="cb642"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb642-1"><a href="#cb642-1" aria-hidden="true" tabindex="-1"></a><span class="ex">global_idf</span> = <span class="op">&lt;</span>idf_file_name<span class="op">&gt;</span></span></code></pre></div>
<p>Global (cluster-wide) keyword IDFs file name. Optional, default is
empty (local IDFs will be used instead, resulting in ranking
jitter).</p>
<p>For more info, see the <a href="#ranking-idf-magics">“Ranking: IDF
magics”</a> section.</p>
<h3 id="hl_fields-directive"><code>hl_fields</code> directive</h3>
<div class="sourceCode" id="cb643"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb643-1"><a href="#cb643-1" aria-hidden="true" tabindex="-1"></a><span class="ex">hl_fields</span> = <span class="op">&lt;</span>field1<span class="op">&gt;</span> [, <span class="op">&lt;</span>field2<span class="op">&gt;</span> ...]</span>
<span id="cb643-2"><a href="#cb643-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb643-3"><a href="#cb643-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb643-4"><a href="#cb643-4" aria-hidden="true" tabindex="-1"></a><span class="ex">hl_fields</span> = title, content</span></code></pre></div>
<p>A list of fields that should store precomputed data at indexing time
to speed up snippets highlighting at searching time. Default is
empty.</p>
<p>For more info, see the <a href="#using-docstore">“Using DocStore”</a>
section.</p>
<h3 id="index_bpetok_fields-directive"><code>index_bpetok_fields</code>
directive</h3>
<div class="sourceCode" id="cb644"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb644-1"><a href="#cb644-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index_bpetok_fields</span> = <span class="op">&lt;</span>field1<span class="op">&gt;</span> [, <span class="op">&lt;</span>field2<span class="op">&gt;</span> ...]</span>
<span id="cb644-2"><a href="#cb644-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb644-3"><a href="#cb644-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb644-4"><a href="#cb644-4" aria-hidden="true" tabindex="-1"></a><span class="ex">index_bpetok_fields</span> = title</span></code></pre></div>
<p>A list of fields to create internal BPE Bloom filters for when
indexing. Enables extra <code>bpe_xxx</code>ranking signals. Default is
empty.</p>
<p>See <a href="#ranking-trigrams-and-bpe-tokens">“Ranking: trigrams and
BPE tokens”</a> section for more details.</p>
<h3
id="index_tokclass_fields-directive"><code>index_tokclass_fields</code>
directive</h3>
<div class="sourceCode" id="cb645"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb645-1"><a href="#cb645-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index_tokclass_fields</span> = <span class="op">&lt;</span>field1<span class="op">&gt;</span> [, <span class="op">&lt;</span>field2<span class="op">&gt;</span> ...]</span>
<span id="cb645-2"><a href="#cb645-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb645-3"><a href="#cb645-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb645-4"><a href="#cb645-4" aria-hidden="true" tabindex="-1"></a><span class="ex">index_tokclass_fields</span> = title</span></code></pre></div>
<p>A list of fields to analyze for token classes and store the
respective class masks for, during the indexing time. Default is
empty.</p>
<p>For more info, see the <a href="#ranking-token-classes">“Ranking:
token classes”</a> section.</p>
<h3
id="index_tokhash_fields-directive"><code>index_tokhash_fields</code>
directive</h3>
<div class="sourceCode" id="cb646"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb646-1"><a href="#cb646-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index_tokhash_fields</span> = <span class="op">&lt;</span>field1<span class="op">&gt;</span> [, <span class="op">&lt;</span>field2<span class="op">&gt;</span> ...]</span>
<span id="cb646-2"><a href="#cb646-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb646-3"><a href="#cb646-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb646-4"><a href="#cb646-4" aria-hidden="true" tabindex="-1"></a><span class="ex">index_tokhash_fields</span> = title</span></code></pre></div>
<p>A list of fields to create internal token hashes for, during the
indexing time. Default is empty.</p>
<p>For more info, see the <a
href="#ranking-tokhashes-and-wordpair_ctr">“Ranking: tokhashes…”</a>
section.</p>
<h3
id="index_trigram_fields-directive"><code>index_trigram_fields</code>
directive</h3>
<div class="sourceCode" id="cb647"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb647-1"><a href="#cb647-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index_trigram_fields</span> = <span class="op">&lt;</span>field1<span class="op">&gt;</span> [, <span class="op">&lt;</span>field2<span class="op">&gt;</span> ...]</span>
<span id="cb647-2"><a href="#cb647-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb647-3"><a href="#cb647-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb647-4"><a href="#cb647-4" aria-hidden="true" tabindex="-1"></a><span class="ex">index_trigram_fields</span> = title</span></code></pre></div>
<p>A list of fields to create internal trigram filters for, during the
indexing time. Default is empty.</p>
<p>See <a href="#ranking-trigrams-and-bpe-tokens">“Ranking: trigrams and
BPE tokens”</a> section for more details.</p>
<h3
id="index_words_clickstat_fields-directive"><code>index_words_clickstat_fields</code>
directive</h3>
<div class="sourceCode" id="cb648"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb648-1"><a href="#cb648-1" aria-hidden="true" tabindex="-1"></a><span class="ex">index_words_clickstat_fields</span> = <span class="op">&lt;</span>field1:tsv1<span class="op">&gt;</span> [, <span class="op">&lt;</span>field2:tsv2<span class="op">&gt;</span> ...]</span>
<span id="cb648-2"><a href="#cb648-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb648-3"><a href="#cb648-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb648-4"><a href="#cb648-4" aria-hidden="true" tabindex="-1"></a><span class="ex">index_words_clickstat_fields</span> = title:title_stats.tsv</span></code></pre></div>
<p>A list of fields and their respective clickstats TSV tables, to
compute static <code>tokclicks</code> ranking signals during the
indexing time. Default is empty.</p>
<p>For more info, see the <a href="#ranking-clickstats">“Ranking:
clickstats”</a> section.</p>
<h3 id="join_attrs-directive"><code>join_attrs</code> directive</h3>
<div class="sourceCode" id="cb649"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb649-1"><a href="#cb649-1" aria-hidden="true" tabindex="-1"></a><span class="ex">join_attrs</span> = <span class="op">&lt;</span>index_attr[:joined_column]<span class="op">&gt;</span> [, ...]</span>
<span id="cb649-2"><a href="#cb649-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb649-3"><a href="#cb649-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb649-4"><a href="#cb649-4" aria-hidden="true" tabindex="-1"></a><span class="ex">join_attrs</span> = ts:ts, weight:score, price</span></code></pre></div>
<p>A list of <code>index_attr:joined_column</code> pairs that binds
target index attributes to source joined columns, by their names.</p>
<p>For more info, see the <a href="#indexing-join-sources">“Indexing:
join sources”</a> section.</p>
<h3 id="kbatch-directive"><code>kbatch</code> directive</h3>
<div class="sourceCode" id="cb650"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb650-1"><a href="#cb650-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kbatch</span> = <span class="op">&lt;</span>index1<span class="op">&gt;</span> [, <span class="op">&lt;</span>index2<span class="op">&gt;</span> ...]</span>
<span id="cb650-2"><a href="#cb650-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb650-3"><a href="#cb650-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb650-4"><a href="#cb650-4" aria-hidden="true" tabindex="-1"></a><span class="ex">kbatch</span> = arc2019, arc2020, arc2021</span></code></pre></div>
<p>A list of target K-batch indexes to delete the docids from. Default
is empty.</p>
<p>For more info, see the <a href="#using-k-batches">“Using
K-batches”</a> section.</p>
<h3 id="kbatch_source-directive"><code>kbatch_source</code>
directive</h3>
<div class="sourceCode" id="cb651"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb651-1"><a href="#cb651-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kbatch_source</span> = {kl <span class="kw">|</span> <span class="ex">id}</span> [, {kl <span class="kw">|</span> <span class="ex">id}]</span></span>
<span id="cb651-2"><a href="#cb651-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb651-3"><a href="#cb651-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb651-4"><a href="#cb651-4" aria-hidden="true" tabindex="-1"></a><span class="ex">kbatch_source</span> = kl, id</span></code></pre></div>
<p>A list of docid sets to generate the K-batch from. Default is
<code>kl</code>, ie. only delete any docids if explicitly requested. The
two known sets are:</p>
<ul>
<li><code>kl</code>, the explicitly provided docids (eg. from
<code>sql_query_kbatch</code>)</li>
<li><code>id</code>, all the newly-indexed docids</li>
</ul>
<p>The example <code>kl, id</code> list merges the both sets. The
resulting K-batch will delete both all the explicitly requested docids
<em>and</em> all of the newly indexed docids.</p>
<p>For more info, see the <a href="#using-k-batches">“Using
K-batches”</a> section.</p>
<h3 id="mappings-directive"><code>mappings</code> directive</h3>
<div class="sourceCode" id="cb652"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb652-1"><a href="#cb652-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mappings</span> = <span class="op">&lt;</span>filename_or_mask<span class="op">&gt;</span> [<span class="op">&lt;</span>filename_or_mask<span class="op">&gt;</span> [...]]</span>
<span id="cb652-2"><a href="#cb652-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb652-3"><a href="#cb652-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb652-4"><a href="#cb652-4" aria-hidden="true" tabindex="-1"></a><span class="ex">mappings</span> = common.txt local.txt masked<span class="pp">*</span>.txt</span>
<span id="cb652-5"><a href="#cb652-5" aria-hidden="true" tabindex="-1"></a><span class="ex">mappings</span> = part1.txt</span>
<span id="cb652-6"><a href="#cb652-6" aria-hidden="true" tabindex="-1"></a><span class="ex">mappings</span> = part2.txt</span>
<span id="cb652-7"><a href="#cb652-7" aria-hidden="true" tabindex="-1"></a><span class="ex">mappings</span> = part3.txt</span></code></pre></div>
<p>A space-separated list of file names with the keyword mappings for
this index.</p>
<p>Optional, default is empty. Multi-value, you can specify it multiple
times, and all the values from all the entries will be combined.
Supports names masks aka wildcards, such as the <code>masked*.txt</code>
in the example.</p>
<p>For more info, see the <a href="#using-mappings">“Using mappings”</a>
section.</p>
<h3 id="mixed_codes_fields-directive"><code>mixed_codes_fields</code>
directive</h3>
<div class="sourceCode" id="cb653"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb653-1"><a href="#cb653-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mixed_codes_fields</span> = <span class="op">&lt;</span>field1<span class="op">&gt;</span> [, <span class="op">&lt;</span>field2<span class="op">&gt;</span> ...]</span>
<span id="cb653-2"><a href="#cb653-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb653-3"><a href="#cb653-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb653-4"><a href="#cb653-4" aria-hidden="true" tabindex="-1"></a><span class="ex">mixed_codes_fields</span> = title, keywords</span></code></pre></div>
<p>A list of fields that the mixed codes indexing is limited to.
Optional, default is empty, meaning that mixed codes should be detected
and indexed in <em>all</em> the fields when requested (ie. when
<code>blend_mixed_codes = 1</code> is set).</p>
<p>For more info, see the <a
href="#mixed-codes-with-letters-and-digits">“Mixed codes”</a>
section.</p>
<h3 id="morphdict-directive"><code>morphdict</code> directive</h3>
<div class="sourceCode" id="cb654"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb654-1"><a href="#cb654-1" aria-hidden="true" tabindex="-1"></a><span class="ex">morphdict</span> = <span class="op">&lt;</span>filename_or_mask<span class="op">&gt;</span> [<span class="op">&lt;</span>filename_or_mask<span class="op">&gt;</span> [...]]</span>
<span id="cb654-2"><a href="#cb654-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb654-3"><a href="#cb654-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb654-4"><a href="#cb654-4" aria-hidden="true" tabindex="-1"></a><span class="ex">morphdict</span> = common.txt local.txt masked<span class="pp">*</span>.txt</span>
<span id="cb654-5"><a href="#cb654-5" aria-hidden="true" tabindex="-1"></a><span class="ex">morphdict</span> = part1.txt</span>
<span id="cb654-6"><a href="#cb654-6" aria-hidden="true" tabindex="-1"></a><span class="ex">morphdict</span> = part2.txt</span>
<span id="cb654-7"><a href="#cb654-7" aria-hidden="true" tabindex="-1"></a><span class="ex">morphdict</span> = part3.txt</span></code></pre></div>
<p>A space-separated list of file names with morphdicts, the
(additional) custom morphology dictionary entries for this index.</p>
<p>Optional, default is empty. Multi-value, you can specify it multiple
times, and all the values from all the entries will be combined.
Supports names masks aka wildcards, such as the <code>masked*.txt</code>
entry in the example.</p>
<p>For more info, see the <a href="#using-morphdict">“Using
morphdict”</a> section.</p>
<h3 id="pq_max_rows-directive"><code>pq_max_rows</code> directive</h3>
<div class="sourceCode" id="cb655"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb655-1"><a href="#cb655-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pq_max_rows</span> = <span class="op">&lt;</span>COUNT<span class="op">&gt;</span></span>
<span id="cb655-2"><a href="#cb655-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb655-3"><a href="#cb655-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb655-4"><a href="#cb655-4" aria-hidden="true" tabindex="-1"></a><span class="ex">pq_max_rows</span> = 1000</span></code></pre></div>
<p>Max rows (stored queries) count, for PQ index type only. Optional,
default is 1000000 (one million).</p>
<p>This limit only affects sanity checks, and prevents PQ indexes from
unchecked growth. It can be changed online.</p>
<p>For more info, see the <a
href="#searching-percolate-queries">percolate queries</a> section.</p>
<h3 id="pretrained_index-directive"><code>pretrained_index</code>
directive</h3>
<div class="sourceCode" id="cb656"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb656-1"><a href="#cb656-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pretrained_index</span> = <span class="op">&lt;</span>filename<span class="op">&gt;</span></span>
<span id="cb656-2"><a href="#cb656-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb656-3"><a href="#cb656-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb656-4"><a href="#cb656-4" aria-hidden="true" tabindex="-1"></a><span class="ex">pretrained_index</span> = pretrain01.bin</span></code></pre></div>
<p>Pretrained vector index data file. When present, pretrained indexes
can be used to speed up building (larger) vector indexes. Default is
empty.</p>
<p>For more info, see the <a href="#searching-vector-indexes">vector
indexes</a> section.</p>
<h3
id="query_words_clickstat-directive"><code>query_words_clickstat</code>
directive</h3>
<div class="sourceCode" id="cb657"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb657-1"><a href="#cb657-1" aria-hidden="true" tabindex="-1"></a><span class="ex">query_words_clickstat</span> = <span class="op">&lt;</span>filename<span class="op">&gt;</span></span>
<span id="cb657-2"><a href="#cb657-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb657-3"><a href="#cb657-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb657-4"><a href="#cb657-4" aria-hidden="true" tabindex="-1"></a><span class="ex">query_words_clickstat</span> = my_queries_clickstats.tsv</span></code></pre></div>
<p>A single file name with clickstats for the query words. Its contents
will be used to compute the <code>words_clickstat</code> signal.
Optional, default is empty.</p>
<p>For more info, see the <a href="#ranking-clickstats">“Ranking:
clickstats”</a> section.</p>
<h3 id="repl_follow-directive"><code>repl_follow</code> directive</h3>
<div class="sourceCode" id="cb658"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb658-1"><a href="#cb658-1" aria-hidden="true" tabindex="-1"></a><span class="ex">repl_follow</span> = <span class="op">&lt;</span>ip_addr[:api_port]<span class="op">&gt;</span></span>
<span id="cb658-2"><a href="#cb658-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb658-3"><a href="#cb658-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb658-4"><a href="#cb658-4" aria-hidden="true" tabindex="-1"></a><span class="ex">repl_follow</span> = 127.0.0.1:8787</span></code></pre></div>
<p>Remote master <code>searchd</code> instance address to follow. Makes
an RT index read-only and replicates writes from the specified
master.</p>
<p>The port <strong>must</strong> point to SphinxAPI listener, not
SphinxQL. The default port is 9312.</p>
<p>Refer to <a href="#using-replication">“Using replication”</a> for
details.</p>
<h3 id="required-directive"><code>required</code> directive</h3>
<div class="sourceCode" id="cb659"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb659-1"><a href="#cb659-1" aria-hidden="true" tabindex="-1"></a><span class="ex">required</span> = {0 <span class="kw">|</span> <span class="ex">1}</span></span>
<span id="cb659-2"><a href="#cb659-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb659-3"><a href="#cb659-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb659-4"><a href="#cb659-4" aria-hidden="true" tabindex="-1"></a><span class="ex">required</span> = 1</span></code></pre></div>
<p>Flags the index as required for <code>searchd</code> to start.
Default is 0, meaning that <code>searchd</code> is allowed to skip
serving this index in case of any issues (missing files, corrupted
binlog files or data files, etc).</p>
<p>All indexes marked as <code>required = 1</code> are
<strong>guaranteed</strong> to be available once <code>searchd</code>
successfully (re)starts. So in case of any issues with any of those,
<strong><code>searchd</code> will not even start!</strong></p>
<p>The intended usage is to prevent “partially broken” replicas (that
somehow managed to lose <em>some</em> of the mission-critical indexes)
from seemingly, but not <em>really</em> successfully starting up, and
then inevitably failing (some) queries.</p>
<h3 id="rt_mem_limit-directive"><code>rt_mem_limit</code> directive</h3>
<div class="sourceCode" id="cb660"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb660-1"><a href="#cb660-1" aria-hidden="true" tabindex="-1"></a><span class="ex">rt_mem_limit</span> = <span class="op">&lt;</span>size<span class="op">&gt;</span> # in bytes, supports K/M/G suffixes</span>
<span id="cb660-2"><a href="#cb660-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb660-3"><a href="#cb660-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb660-4"><a href="#cb660-4" aria-hidden="true" tabindex="-1"></a><span class="ex">rt_mem_limit</span> = 2G</span></code></pre></div>
<p>Soft limit on the total RT RAM segments size. Optional, default is
128M.</p>
<p>When RAM segments in RT index exceed this limit, a new disk segment
is created, and all the RAM data segments’ data gets stored into that
new segment.</p>
<p>So this limit actually also affects <strong>disk segment
size</strong>. Say, if you insert 128G of data into an RT index with the
default 128M <code>rt_mem_limit</code>, you will end up with ~1000 disk
segments. Horrendous fragmentation. Abysmal performance. Should had
known better. Should had set <code>rt_mem_limit</code> higher!</p>
<p>Alas, bumping it to 100G (or any other over-the-top value) is only
semi-safe. At least, Sphinx <strong>will not pre-allocate</strong> that
memory upfront. RT index with just 3 MB worth of data will only consume
those actual 3 MB of RAM, even if <code>rt_mem_limit</code> was set to
100G. No worries about actual RAM consumption. But…</p>
<p>Sphinx needs to read and write the <strong>entire</strong> RAM
segments content on every restart, on every shutdown, <em>and</em> on
new disk segment creation. So an RT index with, say, 37 GB worth of data
means a 37 GB read on every startup, and 37 GB write on every shutdown.
That’s okay-ish with a 3 GB/sec NVMe drive, but, uhh, somewhat less fun
with a 0.1 GB/sec HDD.</p>
<p>Worse yet, if that in-RAM data ever breaks a 100 GB limit, Sphinx
will be forced to create a new 100 GB disk segment.</p>
<p><strong>Writes won’t immediately freeze, though.</strong> Sphinx uses
up to 10% extra on top of the original <code>rt_mem_limit</code> for the
incoming writes while saving a new disk segment. While creating a new
100 GB disk segment, it will accept up to 10 GB more data into RAM.
<em>Then</em> it will stall any further writes until the new disk
segment is fully cooked.</p>
<p>Bottom line, <code>rt_mem_limit</code> is an <strong>important
limit</strong>. Set it too low, and you risk ending up over-fragmented.
(That’s fixable with <code>OPTIMIZE</code> though.) Set it too high, and
you risk getting huge, barely manageable segments.</p>
<blockquote>
<p>WARNING! The default 128M is very likely too low for any serious
loads!</p>
</blockquote>
<p>Why default to 128M, then? Because small datasets and cheap 128 MB
VMs do still actually exist. Most people don’t run petabyte-scale
clusters.</p>
<p>What do we currently recommend? These days (ie. as of 2025), limits
anywhere in 4 GB to 16 GB range seem okay, even for larger and busier
indexes. However, your mileage may vary greatly, so
<strong>please</strong> test the depth before you dive.</p>
<h3 id="stored_fields-directive"><code>stored_fields</code>
directive</h3>
<div class="sourceCode" id="cb661"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb661-1"><a href="#cb661-1" aria-hidden="true" tabindex="-1"></a><span class="ex">stored_fields</span> = <span class="op">&lt;</span>field1<span class="op">&gt;</span> [, <span class="op">&lt;</span>field2<span class="op">&gt;</span> ...]</span>
<span id="cb661-2"><a href="#cb661-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb661-3"><a href="#cb661-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb661-4"><a href="#cb661-4" aria-hidden="true" tabindex="-1"></a><span class="ex">stored_fields</span> = abstract, content</span></code></pre></div>
<p>A list of fields that must be both full-text indexed <em>and</em>
stored in DocStore, enabling future retrieval of the original field
content in addition to <code>MATCH()</code> searches. Optional, default
is empty, meaning to store nothing in DocStore.</p>
<p>For more info, see the <a href="#using-docstore">“Using DocStore”</a>
section.</p>
<h3 id="stored_only_fields-directive"><code>stored_only_fields</code>
directive</h3>
<div class="sourceCode" id="cb662"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb662-1"><a href="#cb662-1" aria-hidden="true" tabindex="-1"></a><span class="ex">stored_only_fields</span> = <span class="op">&lt;</span>field1<span class="op">&gt;</span> [, <span class="op">&lt;</span>field2<span class="op">&gt;</span> ...]</span>
<span id="cb662-2"><a href="#cb662-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb662-3"><a href="#cb662-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb662-4"><a href="#cb662-4" aria-hidden="true" tabindex="-1"></a><span class="ex">stored_only_fields</span> = payload</span></code></pre></div>
<p>A list of fields that must be stored in DocStore, and thus possible
to retrieve later, but <em>not</em> full-text indexed, and thus
<em>not</em> searchable by the <code>MATCH()</code> clause. Optional,
default is empty.</p>
<p>For more info, see the <a href="#using-docstore">“Using DocStore”</a>
section.</p>
<h3 id="tokclasses-directive"><code>tokclasses</code> directive</h3>
<div class="sourceCode" id="cb663"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb663-1"><a href="#cb663-1" aria-hidden="true" tabindex="-1"></a><span class="ex">tokclasses</span> = <span class="op">&lt;</span>class_id<span class="op">&gt;</span>:<span class="op">&lt;</span>filename<span class="op">&gt;</span> [, <span class="op">&lt;</span>class_id<span class="op">&gt;</span>:<span class="op">&lt;</span>filename<span class="op">&gt;</span> ...]</span>
<span id="cb663-2"><a href="#cb663-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb663-3"><a href="#cb663-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb663-4"><a href="#cb663-4" aria-hidden="true" tabindex="-1"></a><span class="ex">tokclasses</span> = 3:articles.txt, 15:colors.txt</span></code></pre></div>
<p>A list of class ID number and token filename pairs that configures
the token classes indexing. Mandatory when the
<code>index_tokclass_fields</code> list is set. Allowed class IDs are
from 0 to 29 inclusive.</p>
<p>For more info, see the <a href="#ranking-token-classes">“Ranking:
token classes”</a> section.</p>
<h3 id="index-type-directive">Index <code>type</code> directive</h3>
<div class="sourceCode" id="cb664"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb664-1"><a href="#cb664-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span> = {plain <span class="kw">|</span> <span class="ex">rt</span> <span class="kw">|</span> <span class="ex">distributed</span> <span class="kw">|</span> <span class="ex">template</span> <span class="kw">|</span> <span class="ex">pq}</span></span>
<span id="cb664-2"><a href="#cb664-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb664-3"><a href="#cb664-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb664-4"><a href="#cb664-4" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span> = rt</span></code></pre></div>
<p>Index type. Known values are <code>plain</code>, <code>rt</code>,
<code>distributed</code>, <code>template</code>, and <code>pq</code>.
Optional, default is <code>plain</code>, meaning “plain” local index
with limited writes.</p>
<p>For details, see <a href="#index-types">“Index types”</a>.</p>
<h3 id="universal_attrs-directive"><code>universal_attrs</code>
directive</h3>
<div class="sourceCode" id="cb665"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb665-1"><a href="#cb665-1" aria-hidden="true" tabindex="-1"></a><span class="ex">universal_attrs</span> = <span class="op">&lt;</span>attr_name<span class="op">&gt;</span> [, <span class="op">&lt;</span>attr_name<span class="op">&gt;</span> ...]</span>
<span id="cb665-2"><a href="#cb665-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb665-3"><a href="#cb665-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb665-4"><a href="#cb665-4" aria-hidden="true" tabindex="-1"></a><span class="ex">universal_attrs</span> = json_params, category_id, tind</span></code></pre></div>
<p>List of attributes to create the universal index for.</p>
<p>Refer to <a href="#using-universal-index">“Using universal index”</a>
for details.</p>
<h3 id="updates_pool-directive"><code>updates_pool</code> directive</h3>
<div class="sourceCode" id="cb666"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb666-1"><a href="#cb666-1" aria-hidden="true" tabindex="-1"></a><span class="ex">updates_pool</span> = <span class="op">&lt;</span>size<span class="op">&gt;</span></span>
<span id="cb666-2"><a href="#cb666-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb666-3"><a href="#cb666-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb666-4"><a href="#cb666-4" aria-hidden="true" tabindex="-1"></a><span class="ex">updates_pool</span> = 1M</span></code></pre></div>
<p>Vrow (variable-width row part) storage file growth step. Optional,
supports size suffixes, default is 64K. The allowed range is 64K to
128M.</p>
<h2 id="source-config-reference">Source config reference</h2>
<p>This section should eventually contain the complete data source
configuration directives reference, for the <code>source</code> sections
of the <code>sphinx.conf</code> file.</p>
<p>If the directive you’re looking for is not yet documented here,
please refer to the legacy <a
href="sphinx2.html#confgroup-source">Sphinx v.2.x reference</a>. Beware
that the legacy reference may not be up to date.</p>
<p>Note how all these directives are only legal for certain subtypes of
sources. For instance, <code>sql_pass</code> only works with SQL sources
(<code>mysql</code>, <code>pgsql</code>, etc), and must not be used with
CSV or XML ones.</p>
<p>Here’s a complete list of data source configuration directives.</p>
<ul>
<li><a
href="#csvpipe_command-directive"><code>csvpipe_command</code></a></li>
<li><a
href="#csvpipe_delimiter-directive"><code>csvpipe_delimiter</code></a></li>
<li><a
href="#csvpipe_header-directive"><code>csvpipe_header</code></a></li>
<li><a href="#join_by_attr-directive"><code>join_by_attr</code></a></li>
<li><a href="#join_cache-directive"><code>join_cache</code></a></li>
<li><a href="#join_file-directive"><code>join_file</code></a></li>
<li><a href="#join_header-directive"><code>join_header</code></a></li>
<li><a href="#join_ids-directive"><code>join_ids</code></a></li>
<li><a
href="#join_optional-directive"><code>join_optional</code></a></li>
<li><a href="#join_schema-directive"><code>join_schema</code></a></li>
<li><a
href="sphinx2.html#conf-mssql-winauth"><code>mssql_winauth</code></a></li>
<li><a
href="sphinx2.html#conf-mysql-connect-flags"><code>mysql_connect_flags</code></a></li>
<li><a href="#mysql_ssl_ca-directive"><code>mysql_ssl_ca</code></a></li>
<li><a
href="#mysql_ssl_cert-directive"><code>mysql_ssl_cert</code></a></li>
<li><a
href="#mysql_ssl_key-directive"><code>mysql_ssl_key</code></a></li>
<li><a href="sphinx2.html#conf-odbc-dsn"><code>odbc_dsn</code></a></li>
<li><a
href="sphinx2.html#conf-sql-column-buffers"><code>sql_column_buffers</code></a></li>
<li><a href="#sql_db-directive"><code>sql_db</code></a></li>
<li><a
href="sphinx2.html#conf-sql-file-field"><code>sql_file_field</code></a></li>
<li><a href="#sql_host-directive"><code>sql_host</code></a></li>
<li><a href="#sql_pass-directive"><code>sql_pass</code></a></li>
<li><a href="#sql_port-directive"><code>sql_port</code></a></li>
<li><a
href="sphinx2.html#conf-sql-query"><code>sql_query</code></a></li>
<li><a
href="#sql_query_kbatch-directive"><code>sql_query_kbatch</code></a></li>
<li><a
href="sphinx2.html#conf-sql-query-post"><code>sql_query_post</code></a></li>
<li><a
href="sphinx2.html#conf-sql-query-post-index"><code>sql_query_post_index</code></a></li>
<li><a
href="sphinx2.html#conf-sql-query-pre"><code>sql_query_pre</code></a></li>
<li><a
href="sphinx2.html#conf-sql-query-range"><code>sql_query_range</code></a></li>
<li><a
href="#sql_query_set-directive"><code>sql_query_set</code></a></li>
<li><a
href="#sql_query_set_range-directive"><code>sql_query_set_range</code></a></li>
<li><a
href="sphinx2.html#conf-sql-range-step"><code>sql_range_step</code></a></li>
<li><a
href="sphinx2.html#conf-sql-ranged-throttle"><code>sql_ranged_throttle</code></a></li>
<li><a href="sphinx2.html#conf-sql-sock"><code>sql_sock</code></a></li>
<li><a href="sphinx2.html#conf-sql-user"><code>sql_user</code></a></li>
<li><a
href="#tsvpipe_command-directive"><code>tsvpipe_command</code></a></li>
<li><a
href="#tsvpipe_header-directive"><code>tsvpipe_header</code></a></li>
<li><a href="#source-type-directive"><code>type</code></a></li>
<li><a
href="#unpack_mysqlcompress-directive"><code>unpack_mysqlcompress</code></a></li>
<li><a
href="#unpack_mysqlcompress_maxsize-directive"><code>unpack_mysqlcompress_maxsize</code></a></li>
<li><a href="#unpack_zlib-directive"><code>unpack_zlib</code></a></li>
<li><a
href="sphinx2.html#conf-xmlpipe-command"><code>xmlpipe_command</code></a></li>
<li><a
href="sphinx2.html#conf-xmlpipe-fixup-utf8"><code>xmlpipe_fixup_utf8</code></a></li>
</ul>
<h3 id="csvpipe_command-directive"><code>csvpipe_command</code>
directive</h3>
<div class="sourceCode" id="cb667"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb667-1"><a href="#cb667-1" aria-hidden="true" tabindex="-1"></a><span class="ex">csvpipe_command</span> = <span class="op">&lt;</span>shell_command<span class="op">&gt;</span></span>
<span id="cb667-2"><a href="#cb667-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb667-3"><a href="#cb667-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb667-4"><a href="#cb667-4" aria-hidden="true" tabindex="-1"></a><span class="ex">csvpipe_command</span> = cat mydata.csv</span></code></pre></div>
<p>A shell command to run and index the output as CSV.</p>
<p>See the <a href="#indexing-csv-and-tsv-files">“Indexing: CSV and TSV
files”</a> section for more details.</p>
<h3 id="csvpipe_delimiter-directive"><code>csvpipe_delimiter</code>
directive</h3>
<div class="sourceCode" id="cb668"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb668-1"><a href="#cb668-1" aria-hidden="true" tabindex="-1"></a><span class="ex">csvpipe_delimiter</span> = <span class="op">&lt;</span>delimiter_char<span class="op">&gt;</span></span>
<span id="cb668-2"><a href="#cb668-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb668-3"><a href="#cb668-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb668-4"><a href="#cb668-4" aria-hidden="true" tabindex="-1"></a><span class="ex">csvpipe_delimiter</span> = <span class="kw">;</span></span></code></pre></div>
<p>Column delimiter for indexing CSV sources. A single character,
default is <code>,</code> (the comma character).</p>
<p>See the <a href="#indexing-csv-and-tsv-files">“Indexing: CSV and TSV
files”</a> section for more details.</p>
<h3 id="csvpipe_header-directive"><code>csvpipe_header</code>
directive</h3>
<div class="sourceCode" id="cb669"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb669-1"><a href="#cb669-1" aria-hidden="true" tabindex="-1"></a><span class="ex">csvpipe_header</span> = {0 <span class="kw">|</span> <span class="ex">1}</span></span>
<span id="cb669-2"><a href="#cb669-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb669-3"><a href="#cb669-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb669-4"><a href="#cb669-4" aria-hidden="true" tabindex="-1"></a><span class="ex">csvpipe_header</span> = 1</span></code></pre></div>
<p>Whether to expect and handle a heading row with column names in the
input CSV when indexing CSV sources. Boolean flag (so 0 or 1), default
is 0, no header.</p>
<p>See the <a href="#indexing-csv-and-tsv-files">“Indexing: CSV and TSV
files”</a> section for more details.</p>
<h3 id="join_by_attr-directive"><code>join_by_attr</code> directive</h3>
<div class="sourceCode" id="cb670"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb670-1"><a href="#cb670-1" aria-hidden="true" tabindex="-1"></a><span class="ex">join_by_attr</span> = {0 <span class="kw">|</span> <span class="ex">1}</span></span></code></pre></div>
<p>Whether to perform <code>indexer</code> side joins by document
<code>id</code>, or by an arbitrary document attribute. Defaults to 0
(off), meaning to join by <code>id</code> by default.</p>
<p>When set to 1 (on), the document attribute to join by
<strong>must</strong> the first column in the <code>join_schema</code>
list.</p>
<p>See <a href="#join-by-attribute">“Join by attribute”</a> section for
details.</p>
<h3 id="join_cache-directive"><code>join_cache</code> directive</h3>
<div class="sourceCode" id="cb671"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb671-1"><a href="#cb671-1" aria-hidden="true" tabindex="-1"></a><span class="ex">join_cache</span> = {0 <span class="kw">|</span> <span class="ex">1}</span></span></code></pre></div>
<p>Whether to enable caching the <code>join_file</code> parsing results
(uses more disk, but may save CPU for subsequent joins). Boolean,
default is 0, no caching.</p>
<p>See the <a href="#caching-text-join-sources">“Caching text join
sources”</a> section for more details.</p>
<h3 id="join_file-directive"><code>join_file</code> directive</h3>
<div class="sourceCode" id="cb672"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb672-1"><a href="#cb672-1" aria-hidden="true" tabindex="-1"></a><span class="ex">join_file</span> = <span class="op">&lt;</span>FILENAME<span class="op">&gt;</span></span></code></pre></div>
<p>Data file to read the joined data from (in CSV format for
<code>csvjoin</code> type, TSV for <code>tsvjoin</code> type, or binary
row format for <code>binjoin</code> type). Required for join sources,
forbidden in non-join sources.</p>
<p>For text formats, must store row data as defined in
<code>join_schema</code> in the respective CSV or TSV format.</p>
<p>For <code>binjoin</code> format, must store row data as defined in
<code>join_schema</code> except document IDs, in binary format.</p>
<p>See the <a href="#indexing-join-sources">“Indexing: join sources”</a>
section for more details.</p>
<h3 id="join_header-directive"><code>join_header</code> directive</h3>
<div class="sourceCode" id="cb673"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb673-1"><a href="#cb673-1" aria-hidden="true" tabindex="-1"></a><span class="ex">join_header</span> = {0 <span class="kw">|</span> <span class="ex">1}</span></span></code></pre></div>
<p>Whether the first <code>join_file</code> line contains data, or a
list of columns. Boolean flag (so 0 or 1), default is 0, no header.</p>
<p>See the <a href="#indexing-join-sources">“Indexing: join sources”</a>
section for more details.</p>
<h3 id="join_ids-directive"><code>join_ids</code> directive</h3>
<div class="sourceCode" id="cb674"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb674-1"><a href="#cb674-1" aria-hidden="true" tabindex="-1"></a><span class="ex">join_ids</span> = <span class="op">&lt;</span>FILENAME<span class="op">&gt;</span></span></code></pre></div>
<p>Binary file to read the joined document IDs from. For
<code>binjoin</code> source type only, forbidden in other source
types.</p>
<p>Must store 8-byte document IDs, in binary format.</p>
<p>See the <a href="#indexing-join-sources">“Indexing: join sources”</a>
section for more details.</p>
<h3 id="join_optional-directive"><code>join_optional</code>
directive</h3>
<div class="sourceCode" id="cb675"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb675-1"><a href="#cb675-1" aria-hidden="true" tabindex="-1"></a><span class="ex">join_optional</span> = {1 <span class="kw">|</span> <span class="ex">0}</span></span></code></pre></div>
<p>Whether the join source is optional, and <code>join_file</code> is
allowed to be missing and/or empty. Default is 0, ie. non-empty data
files required.</p>
<p>See the <a href="#indexing-join-sources">“Indexing: join sources”</a>
section for more details.</p>
<h3 id="join_schema-directive"><code>join_schema</code> directive</h3>
<div class="sourceCode" id="cb676"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb676-1"><a href="#cb676-1" aria-hidden="true" tabindex="-1"></a><span class="ex">join_schema</span> = bigint <span class="op">&lt;</span>COLNAME<span class="op">&gt;</span>, <span class="op">&lt;</span>type<span class="op">&gt;</span> <span class="op">&lt;</span>COLNAME<span class="op">&gt;</span> [, ...]</span>
<span id="cb676-2"><a href="#cb676-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb676-3"><a href="#cb676-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb676-4"><a href="#cb676-4" aria-hidden="true" tabindex="-1"></a><span class="ex">join_schema</span> = bigint id, float score, uint discount</span></code></pre></div>
<p>The complete input <code>join_file</code> schema, with types and
columns names. Required for join sources, forbidden in non-join
sources.</p>
<p>The supported types are <code>uint</code>, <code>bigint</code>, and
<code>float</code>. The input column names are case-insensitive.
Arbitrary names are allowed (ie. proper identifiers are not required),
because they are only used for checks and binding.</p>
<p>See the <a href="#indexing-join-sources">“Indexing: join sources”</a>
section for more details.</p>
<h3 id="mysql_ssl_ca-directive"><code>mysql_ssl_ca</code> directive</h3>
<div class="sourceCode" id="cb677"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb677-1"><a href="#cb677-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mysql_ssl_ca</span> = <span class="op">&lt;</span>ca_file<span class="op">&gt;</span></span>
<span id="cb677-2"><a href="#cb677-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb677-3"><a href="#cb677-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb677-4"><a href="#cb677-4" aria-hidden="true" tabindex="-1"></a><span class="ex">mysql_ssl_ca</span> = /etc/ssl/cacert.pem</span></code></pre></div>
<p>SSL CA (Certificate Authority) file for MySQL indexing connections.
If used, must specify the same certificate used by the server. Optional,
default is empty. Applies to <code>mysql</code> source type only.</p>
<p>These directives let you set up secure SSL connection from
<code>indexer</code> to MySQL. For details on creating the certificates
and setting up the MySQL server, refer to MySQL documentation.</p>
<h3 id="mysql_ssl_cert-directive"><code>mysql_ssl_cert</code>
directive</h3>
<div class="sourceCode" id="cb678"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb678-1"><a href="#cb678-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mysql_ssl_cert</span> = <span class="op">&lt;</span>public_key<span class="op">&gt;</span></span>
<span id="cb678-2"><a href="#cb678-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb678-3"><a href="#cb678-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb678-4"><a href="#cb678-4" aria-hidden="true" tabindex="-1"></a><span class="ex">mysql_ssl_cert</span> = /etc/ssl/client-cert.pem</span></code></pre></div>
<p>Public client SSL key certificate file for MySQL indexing
connections. Optional, default is empty. Applies to <code>mysql</code>
source type only.</p>
<p>These directives let you set up secure SSL connection from
<code>indexer</code> to MySQL. For details on creating the certificates
and setting up the MySQL server, refer to MySQL documentation.</p>
<h3 id="mysql_ssl_key-directive"><code>mysql_ssl_key</code>
directive</h3>
<div class="sourceCode" id="cb679"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb679-1"><a href="#cb679-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mysql_ssl_key</span> = <span class="op">&lt;</span>private_key<span class="op">&gt;</span></span>
<span id="cb679-2"><a href="#cb679-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb679-3"><a href="#cb679-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb679-4"><a href="#cb679-4" aria-hidden="true" tabindex="-1"></a><span class="ex">mysql_ssl_key</span> = /etc/ssl/client-key.pem</span></code></pre></div>
<p>Private client SSL key certificate file for MySQL indexing
connections. Optional, default is empty. Applies to <code>mysql</code>
source type only.</p>
<p>These directives let you set up secure SSL connection from
<code>indexer</code> to MySQL. For details on creating the certificates
and setting up the MySQL server, refer to MySQL documentation.</p>
<h3 id="sql_db-directive"><code>sql_db</code> directive</h3>
<div class="sourceCode" id="cb680"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb680-1"><a href="#cb680-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_db</span> = <span class="op">&lt;</span>database<span class="op">&gt;</span></span>
<span id="cb680-2"><a href="#cb680-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb680-3"><a href="#cb680-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb680-4"><a href="#cb680-4" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_db</span> = myforum</span></code></pre></div>
<p>SQL database (aka SQL schema) to use. <strong>Mandatory</strong>, no
default value. Applies to SQL source types only.</p>
<p>For more info, see <a href="#indexing-sql-databases">“Indexing: SQL
databases”</a> section.</p>
<h3 id="sql_host-directive"><code>sql_host</code> directive</h3>
<div class="sourceCode" id="cb681"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb681-1"><a href="#cb681-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_host</span> = <span class="op">&lt;</span>hostname <span class="kw">|</span> <span class="ex">ip_addr</span><span class="op">&gt;</span></span>
<span id="cb681-2"><a href="#cb681-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb681-3"><a href="#cb681-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb681-4"><a href="#cb681-4" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_host</span> = mydb01.mysecretdc.internal</span></code></pre></div>
<p>SQL server host to connect to. <strong>Mandatory</strong>, no default
value. Applies to SQL source types only.</p>
<p>For more info, see <a href="#indexing-sql-databases">“Indexing: SQL
databases”</a> section.</p>
<h3 id="sql_pass-directive"><code>sql_pass</code> directive</h3>
<div class="sourceCode" id="cb682"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb682-1"><a href="#cb682-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_pass</span> = <span class="op">&lt;</span>db_password<span class="op">&gt;</span></span>
<span id="cb682-2"><a href="#cb682-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb682-3"><a href="#cb682-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb682-4"><a href="#cb682-4" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_pass</span> = mysecretpassword123</span></code></pre></div>
<p>SQL database password (for the user specified by
<code>sql_user</code> directive). <strong>Mandatory</strong>, no default
value. Can be legally empty, though. Applies to SQL source types
only.</p>
<p>For more info, see <a href="#indexing-sql-databases">“Indexing: SQL
databases”</a> section.</p>
<h3 id="sql_port-directive"><code>sql_port</code> directive</h3>
<div class="sourceCode" id="cb683"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb683-1"><a href="#cb683-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_port</span> = <span class="op">&lt;</span>tcp_port<span class="op">&gt;</span></span>
<span id="cb683-2"><a href="#cb683-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb683-3"><a href="#cb683-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb683-4"><a href="#cb683-4" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_port</span> = 4306</span></code></pre></div>
<p>TCP port to connect to. Optional, defaults to 3306 for
<code>mysql</code> and 5432 for <code>pgsql</code> source types,
respectively.</p>
<p>For more info, see <a href="#indexing-sql-databases">“Indexing: SQL
databases”</a> section.</p>
<h3 id="sql_query_kbatch-directive"><code>sql_query_kbatch</code>
directive</h3>
<div class="sourceCode" id="cb684"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb684-1"><a href="#cb684-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_query_kbatch</span> = <span class="op">&lt;</span>query<span class="op">&gt;</span></span>
<span id="cb684-2"><a href="#cb684-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-3"><a href="#cb684-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb684-4"><a href="#cb684-4" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_query_kbatch</span> = SELECT docid FROM deleted_queue</span></code></pre></div>
<p>SQL query to fetch “deleted” document IDs to put into the one-off
index K-batch from the source database. Optional, defaults to empty.</p>
<p>On successful FT index load, all the fetched document IDs (as
returned by this query at the indexing time) will get deleted from
<em>other</em> indexes listed in the <code>kbatch</code> list.</p>
<p>For more info, see the <a href="#using-k-batches">“Using
K-batches”</a> section.</p>
<h3 id="sql_query_set-directive"><code>sql_query_set</code>
directive</h3>
<div class="sourceCode" id="cb685"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb685-1"><a href="#cb685-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_query_set</span> = <span class="op">&lt;</span>attr<span class="op">&gt;</span>: <span class="op">&lt;</span>query<span class="op">&gt;</span></span>
<span id="cb685-2"><a href="#cb685-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb685-3"><a href="#cb685-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb685-4"><a href="#cb685-4" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_query_set</span> = tags: SELECT docid, tagid FROM mytags</span></code></pre></div>
<p>SQL query that fetches (all!) the docid-value pairs for a given
integer set attribute from its respective “external” storage. Optional,
defaults to empty.</p>
<p>This is usually just an optimization. Most databases let you simply
join with the “external” table, group on document ID, and concatenate
the tags. However, moving the join to Sphinx indexer side might be
(much) more efficient.</p>
<h3 id="sql_query_set_range-directive"><code>sql_query_set_range</code>
directive</h3>
<div class="sourceCode" id="cb686"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb686-1"><a href="#cb686-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_query_set_range</span> = <span class="op">&lt;</span>attr<span class="op">&gt;</span>: <span class="op">&lt;</span>query<span class="op">&gt;</span></span>
<span id="cb686-2"><a href="#cb686-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb686-3"><a href="#cb686-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb686-4"><a href="#cb686-4" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_query_set_range</span> = tags: SELECT MIN<span class="er">(</span><span class="ex">docid</span><span class="kw">)</span><span class="ex">,</span> MAX<span class="er">(</span><span class="ex">docid</span><span class="kw">)</span> <span class="ex">FROM</span> mytags</span>
<span id="cb686-5"><a href="#cb686-5" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_query_set</span> = tags: SELECT docid, tagid FROM mytags <span class="dt">\</span></span>
<span id="cb686-6"><a href="#cb686-6" aria-hidden="true" tabindex="-1"></a>    WHERE docid BETWEEN <span class="va">$start</span> AND <span class="va">$end</span></span></code></pre></div>
<p>SQL query that fetches some min/max range, and enables
<code>sql_query_set</code> to step through range in chunks, rather than
all once. Optional, defaults to empty.</p>
<p>This is usually just an optimization. Should be useful when the
entire dataset returned by <code>sql_query_set</code> is too large to
handle for whatever reason (network packet limits, super-feeble
database, client library that can’t manage to hold its result set,
whatever).</p>
<h3 id="sql_sock-directive"><code>sql_sock</code> directive</h3>
<div class="sourceCode" id="cb687"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb687-1"><a href="#cb687-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_sock</span> = <span class="op">&lt;</span>unix_socket_path<span class="op">&gt;</span></span>
<span id="cb687-2"><a href="#cb687-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb687-3"><a href="#cb687-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb687-4"><a href="#cb687-4" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_sock</span> = /tmp/mysql.sock</span></code></pre></div>
<p>UNIX socket path to connect to. Optional, default value is empty
(meaning that the client library is free to use its default settings).
Applies to SQL source types only.</p>
<p>For the record, a couple well-known paths are
<code>/var/lib/mysql/mysql.sock</code> (used on some flavors of Linux)
and <code>/tmp/mysql.sock</code> (used on FreeBSD).</p>
<p>For more info, see <a href="#indexing-sql-databases">“Indexing: SQL
databases”</a> section.</p>
<h3 id="sql_user-directive"><code>sql_user</code> directive</h3>
<div class="sourceCode" id="cb688"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb688-1"><a href="#cb688-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_user</span> = <span class="op">&lt;</span>db_user<span class="op">&gt;</span></span>
<span id="cb688-2"><a href="#cb688-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb688-3"><a href="#cb688-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb688-4"><a href="#cb688-4" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_user</span> = test</span></code></pre></div>
<p>SQL database user. <strong>Mandatory</strong>, no default value.
Applies to SQL source types only.</p>
<p>For more info, see <a href="#indexing-sql-databases">“Indexing: SQL
databases”</a> section.</p>
<h3 id="tsvpipe_command-directive"><code>tsvpipe_command</code>
directive</h3>
<div class="sourceCode" id="cb689"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb689-1"><a href="#cb689-1" aria-hidden="true" tabindex="-1"></a><span class="ex">tsvpipe_command</span> = <span class="op">&lt;</span>shell_command<span class="op">&gt;</span></span>
<span id="cb689-2"><a href="#cb689-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb689-3"><a href="#cb689-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb689-4"><a href="#cb689-4" aria-hidden="true" tabindex="-1"></a><span class="ex">tsvpipe_command</span> = cat mydata.tsv</span></code></pre></div>
<p>A shell command to run and index the output as TSV.</p>
<p>See the <a href="#indexing-csv-and-tsv-files">“Indexing: CSV and TSV
files”</a> section for more details.</p>
<h3 id="tsvpipe_header-directive"><code>tsvpipe_header</code>
directive</h3>
<div class="sourceCode" id="cb690"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb690-1"><a href="#cb690-1" aria-hidden="true" tabindex="-1"></a><span class="ex">tsvpipe_header</span> = {0 <span class="kw">|</span> <span class="ex">1}</span></span>
<span id="cb690-2"><a href="#cb690-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb690-3"><a href="#cb690-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb690-4"><a href="#cb690-4" aria-hidden="true" tabindex="-1"></a><span class="ex">tsvpipe_header</span> = 1</span></code></pre></div>
<p>Whether to expect and handle a heading row with column names in the
input TSV when indexing TSV sources. Boolean flag (so 0 or 1), default
is 0, no header.</p>
<p>See the <a href="#indexing-csv-and-tsv-files">“Indexing: CSV and TSV
files”</a> section for more details.</p>
<h3 id="source-type-directive">Source <code>type</code> directive</h3>
<div class="sourceCode" id="cb691"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb691-1"><a href="#cb691-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span> = {mysql <span class="kw">|</span> <span class="ex">pgsql</span> <span class="kw">|</span> <span class="ex">odbc</span> <span class="kw">|</span> <span class="ex">mssql</span> <span class="kw">|</span> <span class="ex">csvpipe</span> <span class="kw">|</span> <span class="ex">tsvpipe</span> <span class="kw">|</span> <span class="ex">xmlpipe2}</span></span>
<span id="cb691-2"><a href="#cb691-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb691-3"><a href="#cb691-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb691-4"><a href="#cb691-4" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span> = mysql</span></code></pre></div>
<p>Data source type. Mandatory, does <strong>not</strong> have a default
value, so you <strong>must</strong> specify one. Known types are
<code>mysql</code>, <code>pgsql</code>, <code>odbc</code>,
<code>mssql</code>, <code>csvpipe</code>, <code>tsvpipe</code>, and
<code>xmlpipe2</code>.</p>
<p>For details, refer to the <a href="#indexing-data-sources">“Indexing:
data sources”</a> section.</p>
<h3
id="unpack_mysqlcompress-directive"><code>unpack_mysqlcompress</code>
directive</h3>
<div class="sourceCode" id="cb692"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb692-1"><a href="#cb692-1" aria-hidden="true" tabindex="-1"></a><span class="ex">unpack_mysqlcompress</span> = <span class="op">&lt;</span>col_name<span class="op">&gt;</span></span>
<span id="cb692-2"><a href="#cb692-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb692-3"><a href="#cb692-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb692-4"><a href="#cb692-4" aria-hidden="true" tabindex="-1"></a><span class="ex">unpack_mysqlcompress</span> = title</span>
<span id="cb692-5"><a href="#cb692-5" aria-hidden="true" tabindex="-1"></a><span class="ex">unpack_mysqlcompress</span> = description</span></code></pre></div>
<p>SQL source columns to unpack with MySQL <code>UNCOMPRESS()</code>
algorithm (a variation of the standard zlib one). Multi-value, optional,
default is none. Applies to SQL source types only.</p>
<p><code>indexer</code> will treat columns mentioned in
<code>unpack_mysqlcompress</code> as compressed with the
<strong>modified</strong> zlib algorithm, as implemented in MySQL
<code>COMPRESS()</code> and <code>UNCOMPRESS()</code> functions, and
decompress them after fetching from the database.</p>
<h3
id="unpack_mysqlcompress_maxsize-directive"><code>unpack_mysqlcompress_maxsize</code>
directive</h3>
<div class="sourceCode" id="cb693"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb693-1"><a href="#cb693-1" aria-hidden="true" tabindex="-1"></a><span class="ex">unpack_mysqlcompress_maxsize</span> = <span class="op">&lt;</span>size<span class="op">&gt;</span></span>
<span id="cb693-2"><a href="#cb693-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb693-3"><a href="#cb693-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb693-4"><a href="#cb693-4" aria-hidden="true" tabindex="-1"></a><span class="ex">unpack_mysqlcompress_maxsize</span> = 32M</span></code></pre></div>
<p>Buffer size for <code>UNCOMPRESS()</code> unpacking. Optional,
default is 16M.</p>
<p>MySQL <code>UNCOMPRESS()</code> implementation does not store the
original data length, and this controls the size of a temporary buffer
that <code>indexer</code> stores the unpacked
<code>unpack_mysqlcompress</code> columns into.</p>
<h3 id="unpack_zlib-directive"><code>unpack_zlib</code> directive</h3>
<div class="sourceCode" id="cb694"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb694-1"><a href="#cb694-1" aria-hidden="true" tabindex="-1"></a><span class="ex">unpack_zlib</span> = <span class="op">&lt;</span>col_name<span class="op">&gt;</span></span>
<span id="cb694-2"><a href="#cb694-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb694-3"><a href="#cb694-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb694-4"><a href="#cb694-4" aria-hidden="true" tabindex="-1"></a><span class="ex">unpack_zlib</span> = title</span>
<span id="cb694-5"><a href="#cb694-5" aria-hidden="true" tabindex="-1"></a><span class="ex">unpack_zlib</span> = description</span></code></pre></div>
<p>SQL source columns to unpack with zlib algorithm. Multi-value,
optional, default is none. Applies to SQL source types only.</p>
<p><code>indexer</code> will treat columns mentioned in
<code>unpack_zlib</code> as compressed with <a
href="https://zlib.net">standard zlib algorithm</a> (called DEFLATE as
implemented in <code>gzip</code>), and decompress them after fetching
from the database.</p>
<h2 id="common-config-reference">Common config reference</h2>
<p>This section covers all the common configuration directives, for the
<code>common</code> section of the <code>sphinx.conf</code> file.</p>
<p>Here’s a complete list.</p>
<ul>
<li><a
href="#attrindex_thresh-directive"><code>attrindex_thresh</code></a></li>
<li><a href="#datadir-directive"><code>datadir</code></a></li>
<li><a
href="#json_autoconv_keynames-directive"><code>json_autoconv_keynames</code></a></li>
<li><a
href="#json_autoconv_numbers-directive"><code>json_autoconv_numbers</code></a></li>
<li><a href="#json_float-directive"><code>json_float</code></a></li>
<li><a
href="#on_json_attr_error-directive"><code>on_json_attr_error</code></a></li>
<li><a
href="#plugin_libinit_arg-directive"><code>plugin_libinit_arg</code></a></li>
<li><a href="#use_avx512-directive"><code>use_avx512</code></a></li>
<li><a
href="#vecindex_builds-directive"><code>vecindex_builds</code></a></li>
<li><a
href="#vecindex_threads-directive"><code>vecindex_threads</code></a></li>
<li><a
href="#vecindex_thresh-directive"><code>vecindex_thresh</code></a></li>
</ul>
<h3 id="attrindex_thresh-directive"><code>attrindex_thresh</code>
directive</h3>
<div class="sourceCode" id="cb695"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb695-1"><a href="#cb695-1" aria-hidden="true" tabindex="-1"></a><span class="ex">attrindex_thresh</span> = <span class="op">&lt;</span>num_rows<span class="op">&gt;</span></span>
<span id="cb695-2"><a href="#cb695-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb695-3"><a href="#cb695-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb695-4"><a href="#cb695-4" aria-hidden="true" tabindex="-1"></a><span class="ex">attrindex_thresh</span> = 10000</span></code></pre></div>
<p>Attribute index segment size threshold. Attribute indexes are only
built for segments with at least that many rows. Default is 1024.</p>
<p>For more info, see the <a href="#using-attribute-indexes">“Using
attribute indexes”</a> section.</p>
<h3 id="datadir-directive"><code>datadir</code> directive</h3>
<div class="sourceCode" id="cb696"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb696-1"><a href="#cb696-1" aria-hidden="true" tabindex="-1"></a><span class="ex">datadir</span> = <span class="op">&lt;</span>some_folder<span class="op">&gt;</span></span>
<span id="cb696-2"><a href="#cb696-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb696-3"><a href="#cb696-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb696-4"><a href="#cb696-4" aria-hidden="true" tabindex="-1"></a><span class="ex">datadir</span> = /home/sphinx/sphinxdata</span></code></pre></div>
<p>Base path for all the Sphinx data files. As of v.3.5, defaults to
<code>./sphinxdata</code> when there is no configuration file, and
defaults to empty string otherwise.</p>
<p>For more info, see the <a href="#using-datadir">“Using datadir”</a>
section.</p>
<h3
id="json_autoconv_keynames-directive"><code>json_autoconv_keynames</code>
directive</h3>
<div class="sourceCode" id="cb697"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb697-1"><a href="#cb697-1" aria-hidden="true" tabindex="-1"></a><span class="ex">json_autoconv_keynames</span> = { <span class="kw">|</span> <span class="ex">lowercase}</span></span></code></pre></div>
<p>Whether to automatically process JSON keys. Defaults to an empty
string, meaning that keys are stored as provided.</p>
<p>The only supported option is for now <code>lowercase</code>, and that
folds Latin capital letters (A to Z), so <code>"FooBar"</code> gets
converted to <code>"foobar"</code> when indexing.</p>
<p>For the record, we would generally recommend to <em>avoid</em> using
this feature, and properly clean up the input JSON data instead. That’s
one of the reasons behind making it global. We don’t want it to be too
flexible and convenient. That said, it can still be useful in some
(hopefully rare) cases, so it’s there.</p>
<h3
id="json_autoconv_numbers-directive"><code>json_autoconv_numbers</code>
directive</h3>
<div class="sourceCode" id="cb698"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb698-1"><a href="#cb698-1" aria-hidden="true" tabindex="-1"></a><span class="ex">json_autoconv_numbers</span> = {0 <span class="kw">|</span> <span class="ex">1}</span></span></code></pre></div>
<p>Whether to automatically convert JSON numbers stored as strings to
numbers, or keep them stored as strings. Defaults to 0, avoid
conversions.</p>
<p>When set to 1, all the JSON string values are checked, and all the
values that are possible to store as numbers are auto-converted to
numbers. For example!</p>
<div class="sourceCode" id="cb699"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb699-1"><a href="#cb699-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">insert</span> <span class="kw">into</span> test (<span class="kw">id</span>, j) <span class="kw">values</span></span>
<span id="cb699-2"><a href="#cb699-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> (<span class="dv">1</span>, <span class="st">&#39;{&quot;foo&quot;: &quot;123&quot;}&#39;</span>),</span>
<span id="cb699-3"><a href="#cb699-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> (<span class="dv">2</span>, <span class="st">&#39;{&quot;foo&quot;: &quot;9876543210&quot;}&#39;</span>),</span>
<span id="cb699-4"><a href="#cb699-4" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">3</span>, <span class="st">&#39;{&quot;foo&quot;: &quot;3.141&quot;}&#39;</span>);</span>
<span id="cb699-5"><a href="#cb699-5" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">3</span> <span class="kw">rows</span> affected (<span class="fl">0.00</span> sec)</span>
<span id="cb699-6"><a href="#cb699-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb699-7"><a href="#cb699-7" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="kw">id</span>, <span class="fu">dump</span>(j) <span class="kw">from</span> test;</span>
<span id="cb699-8"><a href="#cb699-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------------------------+</span></span>
<span id="cb699-9"><a href="#cb699-9" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | <span class="fu">dump</span>(j)                         |</span>
<span id="cb699-10"><a href="#cb699-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------------------------+</span></span>
<span id="cb699-11"><a href="#cb699-11" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">1</span> | (root){<span class="ot">&quot;foo&quot;</span>:(int32)<span class="dv">123</span>}        |</span>
<span id="cb699-12"><a href="#cb699-12" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">2</span> | (root){<span class="ot">&quot;foo&quot;</span>:(int64)<span class="dv">9876543210</span>} |</span>
<span id="cb699-13"><a href="#cb699-13" aria-hidden="true" tabindex="-1"></a>|    <span class="dv">3</span> | (root){<span class="ot">&quot;foo&quot;</span>:(<span class="dt">double</span>)<span class="fl">3.141</span>}     |</span>
<span id="cb699-14"><a href="#cb699-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+---------------------------------+</span></span>
<span id="cb699-15"><a href="#cb699-15" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>In the default <code>json_autoconv_numbers = 0</code> mode all those
values would have been saved as strings, but here they were
auto-converted.</p>
<p>For the record, we would generally recommend to <em>avoid</em> using
this feature, and properly clean up the input JSON data instead. That’s
one of the reasons behind making it global. We don’t want it to be too
flexible and convenient. That said, it can still be useful in some
(hopefully rare) cases, so it’s there.</p>
<h3 id="json_float-directive"><code>json_float</code> directive</h3>
<div class="sourceCode" id="cb700"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb700-1"><a href="#cb700-1" aria-hidden="true" tabindex="-1"></a><span class="ex">json_float</span> = {float <span class="kw">|</span> <span class="ex">double}</span></span></code></pre></div>
<p>Default JSON floating-point values storage precision, used when
there’s no explicit precision suffix. Optional, defaults to
<code>float</code>.</p>
<p><code>float</code> means 32-bit single-precision values and
<code>double</code> means 64-bit double-precision values as in IEEE 754
(or as in any sane C++ compiler).</p>
<h3 id="on_json_attr_error-directive"><code>on_json_attr_error</code>
directive</h3>
<div class="sourceCode" id="cb701"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb701-1"><a href="#cb701-1" aria-hidden="true" tabindex="-1"></a><span class="ex">on_json_attr_error</span> = {ignore_attr <span class="kw">|</span> <span class="ex">fail_index}</span></span></code></pre></div>
<p>How to handle syntax errors when indexing JSON columns. Affects both
<code>indexer</code>, and <code>INSERT</code> and <code>REPLACE</code>
SphinxQL statements. Defaults to <code>ignore_attr</code>, which raises
a warning, clears the offending JSON value, but otherwise keeps the row.
As follows.</p>
<div class="sourceCode" id="cb702"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb702-1"><a href="#cb702-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">insert</span> <span class="kw">into</span> test (<span class="kw">id</span>, j) <span class="kw">values</span> (<span class="dv">777</span>, <span class="st">&#39;bad syntax&#39;</span>);</span>
<span id="cb702-2"><a href="#cb702-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Query</span> OK, <span class="dv">1</span> <span class="kw">row</span> affected, <span class="dv">1</span> warning (<span class="fl">0.00</span> sec)</span>
<span id="cb702-3"><a href="#cb702-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb702-4"><a href="#cb702-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> test <span class="kw">where</span> <span class="kw">id</span><span class="op">=</span><span class="dv">777</span>;</span>
<span id="cb702-5"><a href="#cb702-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+------+</span></span>
<span id="cb702-6"><a href="#cb702-6" aria-hidden="true" tabindex="-1"></a>| <span class="kw">id</span>   | title | j    |</span>
<span id="cb702-7"><a href="#cb702-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+------+</span></span>
<span id="cb702-8"><a href="#cb702-8" aria-hidden="true" tabindex="-1"></a>|  <span class="dv">777</span> |       | <span class="kw">NULL</span> |</span>
<span id="cb702-9"><a href="#cb702-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------+-------+------+</span></span>
<span id="cb702-10"><a href="#cb702-10" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>The alternative strict <code>fail_index</code> mode fails the entire
indexing operation. <strong>BEWARE</strong> that a single error fails
<strong>EVERYTHING</strong>! The entire index rebuild (with
<code>indexer build</code>) or the entire RT <code>INSERT</code> batch
will fail. As follows.</p>
<div class="sourceCode" id="cb703"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb703-1"><a href="#cb703-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">insert</span> <span class="kw">into</span> test (<span class="kw">id</span>, j) <span class="kw">values</span> (<span class="dv">888</span>, <span class="st">&#39;{&quot;foo&quot;:&quot;bar&quot;}&#39;</span>), (<span class="dv">999</span>, <span class="st">&#39;bad&#39;</span>);</span>
<span id="cb703-2"><a href="#cb703-2" aria-hidden="true" tabindex="-1"></a>ERROR <span class="dv">1064</span> (<span class="dv">42000</span>): <span class="kw">column</span> j: JSON error: syntax error, unexpected <span class="cf">end</span> <span class="kw">of</span> <span class="kw">file</span>,</span>
<span id="cb703-3"><a href="#cb703-3" aria-hidden="true" tabindex="-1"></a>expecting <span class="st">&#39;[&#39;</span> near <span class="st">&#39;bad&#39;</span></span>
<span id="cb703-4"><a href="#cb703-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb703-5"><a href="#cb703-5" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> test <span class="kw">where</span> <span class="kw">id</span> <span class="kw">in</span> (<span class="dv">888</span>, <span class="dv">999</span>);</span>
<span id="cb703-6"><a href="#cb703-6" aria-hidden="true" tabindex="-1"></a><span class="kw">Empty</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<h3 id="plugin_libinit_arg-directive"><code>plugin_libinit_arg</code>
directive</h3>
<div class="sourceCode" id="cb704"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb704-1"><a href="#cb704-1" aria-hidden="true" tabindex="-1"></a><span class="ex">plugin_libinit_arg</span> = <span class="op">&lt;</span>string<span class="op">&gt;</span></span>
<span id="cb704-2"><a href="#cb704-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb704-3"><a href="#cb704-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb704-4"><a href="#cb704-4" aria-hidden="true" tabindex="-1"></a><span class="ex">plugin_libinit_arg</span> = hello world</span></code></pre></div>
<p>An arbitrary custom text argument for <code>_libinit</code>, the UDF
initialization call. Optional, default is empty.</p>
<p>For more info, see the <a href="#udf-library-initialization">“UDF
library initialization”</a> section.</p>
<h3 id="use_avx512-directive"><code>use_avx512</code> directive</h3>
<div class="sourceCode" id="cb705"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb705-1"><a href="#cb705-1" aria-hidden="true" tabindex="-1"></a><span class="ex">use_avx512</span> = {0 <span class="kw">|</span> <span class="ex">1}</span></span>
<span id="cb705-2"><a href="#cb705-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb705-3"><a href="#cb705-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb705-4"><a href="#cb705-4" aria-hidden="true" tabindex="-1"></a><span class="ex">use_avx512</span> = 0</span></code></pre></div>
<p>Whether to enable AVX-512 optimizations (where applicable). Default
is 1.</p>
<p>Safe on <strong>all</strong> hardware. AVX-512 optimized functions
will <strong>not</strong> be forcibly executed on any non-AVX-512
hardware.</p>
<p>Can be changed in <code>searchd</code> at runtime with
<code>SET GLOBAL use_avx512 = {0 | 1}</code>, but beware that runtime
changes will <em>not</em> currently persist.</p>
<p>As of v.3.9, affects Sphinx HNSW index performance only. That’s the
only place where we currently have AVX-512 optimized codepaths
implemented.</p>
<p>Last but not least, why? Because on certain (older) CPU models using
AVX-512 optimized functions can actually <em>degrade</em> the overall
performance. Even though those CPUs do support AVX-512. (Because
throttling, basically.) Unfortunately, we can’t currently reliably
auto-detect such CPUs. Hence this switch.</p>
<h3 id="vecindex_threads-directive"><code>vecindex_threads</code>
directive</h3>
<div class="sourceCode" id="cb706"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb706-1"><a href="#cb706-1" aria-hidden="true" tabindex="-1"></a><span class="ex">vecindex_threads</span> = <span class="op">&lt;</span>max_build_threads<span class="op">&gt;</span></span>
<span id="cb706-2"><a href="#cb706-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb706-3"><a href="#cb706-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb706-4"><a href="#cb706-4" aria-hidden="true" tabindex="-1"></a><span class="ex">vecindex_threads</span> = 32</span></code></pre></div>
<p>Maximum allowed thread count for a single vector index construction
operation (ie. affects both <code>CREATE INDEX</code> SphinxQL statement
and <code>create_index</code> directive for <code>indexer</code>).
Default is 20, except on Apple/macOS, where the default is 1.</p>
<p>Must be non-negative. Negative values are ignored. 0 means “use all
threads” (that the hardware reports). Too big values are legal, but they
get clamped, so <code>vecindex_threads = 1024</code> on a 64-core
machine will clamp and only actually launch 64 threads. (Because
overbooking vector index build <em>never</em> works.)</p>
<p>For more info, see the <a href="#searching-vector-indexes">vector
indexes</a> section.</p>
<h3 id="vecindex_thresh-directive"><code>vecindex_thresh</code>
directive</h3>
<div class="sourceCode" id="cb707"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb707-1"><a href="#cb707-1" aria-hidden="true" tabindex="-1"></a><span class="ex">vecindex_thresh</span> = <span class="op">&lt;</span>num_rows<span class="op">&gt;</span></span>
<span id="cb707-2"><a href="#cb707-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb707-3"><a href="#cb707-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb707-4"><a href="#cb707-4" aria-hidden="true" tabindex="-1"></a><span class="ex">vecindex_thresh</span> = 10000</span></code></pre></div>
<p>Vector index segment size threshold. Vector indexes will only get
built for segments with at least that many rows. Default is 170000.</p>
<p>For more info, see the <a href="#searching-vector-indexes">vector
indexes</a> section.</p>
<h3 id="vecindex_builds-directive"><code>vecindex_builds</code>
directive</h3>
<div class="sourceCode" id="cb708"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb708-1"><a href="#cb708-1" aria-hidden="true" tabindex="-1"></a><span class="ex">vecindex_builds</span> = <span class="op">&lt;</span>max_parallel_builds<span class="op">&gt;</span></span>
<span id="cb708-2"><a href="#cb708-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb708-3"><a href="#cb708-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb708-4"><a href="#cb708-4" aria-hidden="true" tabindex="-1"></a><span class="ex">vecindex_builds</span> = 2</span></code></pre></div>
<p>The maximum vector index builds allowed to run in parallel. Default
is 1.</p>
<p>Must be in 1 to 100 range. Bump this one from the default 1 with
certain care, because Sphinx <em>can</em> spawn up to
<code>vecindex_builds * vecindex_threads</code> total.</p>
<p>For more info, see the <a href="#searching-vector-indexes">vector
indexes</a> section.</p>
<h2 id="indexer-config-reference"><code>indexer</code> config
reference</h2>
<p>This section covers all the <code>indexer</code> configuration
directives, for the <code>indexer</code> section of the
<code>sphinx.conf</code> file.</p>
<p>Here’s a complete list.</p>
<ul>
<li><a
href="#lemmatizer_cache-directive"><code>lemmatizer_cache</code></a></li>
<li><a
href="#max_file_field_buffer-directive"><code>max_file_field_buffer</code></a></li>
<li><a href="#max_iops-directive"><code>max_iops</code></a></li>
<li><a href="#max_iosize-directive"><code>max_iosize</code></a></li>
<li><a
href="#max_xmlpipe2_field-directive"><code>max_xmlpipe2_field</code></a></li>
<li><a href="#mem_limit-directive"><code>mem_limit</code></a></li>
<li><a
href="#on_file_field_error-directive"><code>on_file_field_error</code></a></li>
<li><a href="#write_buffer-directive"><code>write_buffer</code></a></li>
</ul>
<h3 id="lemmatizer_cache-directive"><code>lemmatizer_cache</code>
directive</h3>
<div class="sourceCode" id="cb709"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb709-1"><a href="#cb709-1" aria-hidden="true" tabindex="-1"></a><span class="ex">lemmatizer_cache</span> = <span class="op">&lt;</span>size<span class="op">&gt;</span> # in bytes, supports K and M suffixes</span></code></pre></div>
<p>Lemmatizer cache size limit. Optional, default is
<code>256K</code>.</p>
<p>Lemmatizer prebuilds an internal cache when loading each morphology
dictionary (ie. <code>.pak</code> file). This cache may improve
indexing, up to 10-15% overall speedup in extreme cases, though usually
less than that.</p>
<p>This directive limits the maximum per-dictionary cache size. Note
there’s also a natural limit for every <code>.pak</code> file. The
biggest existing one is <code>ru.pak</code> that can use up to 110 MB
for caching. So values over <code>128M</code> won’t currently have any
effect.</p>
<p>Now, cache sizing effects are tricky to predict, and your mileage may
vary. But, unless you are pressed for RAM, we suggest the maximum
<code>128M</code> limit here. If you are (heavily) pressed for RAM, even
the default <code>256K</code> is an alright tradeoff.</p>
<div class="sourceCode" id="cb710"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb710-1"><a href="#cb710-1" aria-hidden="true" tabindex="-1"></a><span class="ex">lemmatizer_cache</span> = 128M <span class="co"># just cache it all</span></span></code></pre></div>
<h3
id="max_file_field_buffer-directive"><code>max_file_field_buffer</code>
directive</h3>
<div class="sourceCode" id="cb711"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb711-1"><a href="#cb711-1" aria-hidden="true" tabindex="-1"></a><span class="ex">max_file_field_buffer</span> = <span class="op">&lt;</span>size<span class="op">&gt;</span> # in bytes, supports K and M suffixes</span></code></pre></div>
<p>Maximum file field buffer size, bytes. Optional, default is
<code>8M</code>.</p>
<p>When indexing SQL sources, <code>sql_file_field</code> fields can
store file names, and <code>indexer</code> then loads such files and
indexes their content.</p>
<p>This directive controls the maximum file size that
<code>indexer</code> can load. Note that files sized over the limit get
completely skipped, not partially loaded! For instance, with the default
settings any files over 8 MB will be ignored.</p>
<p>The minimum value is <code>1M</code>, any smaller values are clamped
to that. (So files up to 1 MB must always load.)</p>
<h3 id="max_iops-directive"><code>max_iops</code> directive</h3>
<div class="sourceCode" id="cb712"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb712-1"><a href="#cb712-1" aria-hidden="true" tabindex="-1"></a><span class="ex">max_iops</span> = <span class="op">&lt;</span>number<span class="op">&gt;</span> # 0 for unlimited</span></code></pre></div>
<p>Maximum IO operations per second. Optional, default is 0, meaning no
limit.</p>
<p>This directive is for IO throttling. It limits the rate of disk
<code>read()</code> and <code>write()</code> calls that
<code>indexer</code> does while indexing.</p>
<p>This might be occasionally useful with slower HDD disks, but should
not be needed with SSD disks or fast enough HDD raids.</p>
<h3 id="max_iosize-directive"><code>max_iosize</code> directive</h3>
<div class="sourceCode" id="cb713"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb713-1"><a href="#cb713-1" aria-hidden="true" tabindex="-1"></a><span class="ex">max_iosize</span> = <span class="op">&lt;</span>size<span class="op">&gt;</span> # in bytes, supports K and M suffixes</span></code></pre></div>
<p>Maximum individual IO size. Optional, default is 0, meaning no
limit.</p>
<p>This directive is for IO throttling. It limits the size of individual
disk <code>read()</code> and <code>write()</code> calls that
<code>indexer</code> does while indexing. (Larger calls get broken down
to smaller pieces.)</p>
<p>This might be occasionally useful with slower HDD disks, but should
not be needed with SSD disks or fast enough HDD raids.</p>
<h3 id="max_xmlpipe2_field-directive"><code>max_xmlpipe2_field</code>
directive</h3>
<div class="sourceCode" id="cb714"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb714-1"><a href="#cb714-1" aria-hidden="true" tabindex="-1"></a><span class="ex">max_xmlpipe2_field</span> = <span class="op">&lt;</span>size<span class="op">&gt;</span> # in bytes, supports K and M suffixes</span></code></pre></div>
<p>Maximum field (element) size for XML sources. Optional, default is
<code>2M</code>.</p>
<p>Our XML sources parser uses an internal buffer to store individual
attributes and full-text fields values when indexing. Values larger than
the buffer might get truncated. This directive controls its size.</p>
<h3 id="mem_limit-directive"><code>mem_limit</code> directive</h3>
<div class="sourceCode" id="cb715"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb715-1"><a href="#cb715-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mem_limit</span> = <span class="op">&lt;</span>size<span class="op">&gt;</span> # in bytes, supports K and M suffixes</span></code></pre></div>
<p>Indexing RAM usage soft limit. Optional, default is
<code>128M</code>.</p>
<p>This limit does apply to <strong>most</strong> of the full-text and
attribute indexing work that <code>indexer</code> does. However, there
are a few (optional) things that might need to ignore it, notably
<code>sql_query_set</code> and <code>join_attrs</code> joins. Also,
occasionally there are things outside of Sphinx control, such as SQL
driver behavior. Hence, this is a <strong>soft</strong> limit only.</p>
<p><strong>The maximum limit is around <code>2047M</code></strong>
(2147483647 bytes), any bigger values are clamped to that.</p>
<p><strong>Too low limit will hurt indexing speed.</strong> The default
<code>128M</code> errs on the other side of caution: it works okay for
quite tiny servers (and indexes), but <strong>can</strong> be too low
for larger indexes (and servers).</p>
<p><strong>Too high limit may not actually improve indexing
speed.</strong> We actually do try higher <code>mem_limit</code> values
internally, every few years or so. That single test case where 4000 MB
limit properly beats 2000 MB one still remains to be built.</p>
<p><strong>Too high limit may cause SQL connections issues.</strong> The
higher the limit, the longer the processing pauses during which
<code>indexer</code> does not talk to SQL sever. That may cause your SQL
server to timeout. (And the solution is to either raise the timeout on
SQL side, or to lower <code>mem_limit</code> on Sphinx side.)</p>
<p><strong>Rule of thumb?</strong> Just use <code>2047M</code> if you
have enough RAM, less if not.</p>
<h3 id="on_file_field_error-directive"><code>on_file_field_error</code>
directive</h3>
<div class="sourceCode" id="cb716"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb716-1"><a href="#cb716-1" aria-hidden="true" tabindex="-1"></a><span class="ex">on_file_field_error</span> = {ignore_field <span class="kw">|</span> <span class="ex">skip_document</span> <span class="kw">|</span> <span class="ex">fail_index}</span></span></code></pre></div>
<p>How to handle IO errors for file fields. Optional, default is
<code>ignore_field</code>.</p>
<p>When indexing SQL sources, <code>sql_file_field</code> fields can
store file names, and <code>indexer</code> then loads such files and
indexes their content.</p>
<p>This directive controls the error handling strategy, ie. what should
<code>indexer</code> do when there’s a problem loading the file. The
possible values are:</p>
<ul>
<li><code>ignore_field</code>, empty the field content, but still index
the document;</li>
<li><code>skip_document</code>, skip the current document, but continue
indexing;</li>
<li><code>fail_index</code>, fail the entire index.</li>
</ul>
<p><code>indexer</code> will also warn about the specific problem and
file at all times.</p>
<p>Note that in <code>on_file_field_error = skip_document</code> case
there’s a certain race window. <code>indexer</code> usually receives SQL
rows in batches. File fields are quickly checked (for existence and
size) immediately after that. But actual loading and processing happens
a tiny bit later, opening a small race window: if a file goes away after
the early check but before the actual load, the document will still get
indexed.</p>
<h3 id="write_buffer-directive"><code>write_buffer</code> directive</h3>
<div class="sourceCode" id="cb717"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb717-1"><a href="#cb717-1" aria-hidden="true" tabindex="-1"></a><span class="ex">write_buffer</span> = <span class="op">&lt;</span>size<span class="op">&gt;</span> # in bytes, supports K and M suffixes</span></code></pre></div>
<p>Write buffer size, bytes. Optional, default is <code>1M</code>.</p>
<p>This directive controls the size of internal buffers that
<code>indexer</code> uses when writing some of the full-text index files
(specifically to document and posting lists related files).</p>
<p>This might be occasionally useful with slower HDD disks, but should
not be needed with SSD disks or fast enough HDD raids.</p>
<h2 id="searchd-config-reference"><code>searchd</code> config
reference</h2>
<p>This section should eventually contain the complete
<code>searchd</code> configuration directives reference, for the
<code>searchd</code> section of the <code>sphinx.conf</code> file.</p>
<p>If the directive you’re looking for is not yet documented here,
please refer to the legacy <a
href="sphinx2.html#confgroup-searchd">Sphinx v.2.x reference</a>. Beware
that the legacy reference may not be up to date.</p>
<p>Here’s a complete list of <code>searchd</code> configuration
directives.</p>
<ul>
<li><a
href="sphinx2.html#conf-agent-connect-timeout"><code>agent_connect_timeout</code></a></li>
<li><a href="#agent_hedge-directive"><code>agent_hedge</code></a></li>
<li><a
href="#agent_hedge_delay_min_msec-directive"><code>agent_hedge_delay_min_msec</code></a></li>
<li><a
href="#agent_hedge_delay_pct-directive"><code>agent_hedge_delay_pct</code></a></li>
<li><a
href="sphinx2.html#conf-agent-query-timeout"><code>agent_query_timeout</code></a></li>
<li><a
href="sphinx2.html#conf-agent-retry-count"><code>agent_retry_count</code></a></li>
<li><a
href="sphinx2.html#conf-agent-retry-delay"><code>agent_retry_delay</code></a></li>
<li><a href="#auth_users-directive"><code>auth_users</code></a></li>
<li><a href="#binlog-directive"><code>binlog</code></a></li>
<li><a
href="#binlog_erase_delay_sec-directive"><code>binlog_erase_delay_sec</code></a></li>
<li><a
href="#binlog_flush_mode-directive"><code>binlog_flush_mode</code></a></li>
<li><a
href="#binlog_manifest_flush-directive"><code>binlog_manifest_flush</code></a></li>
<li><a
href="#binlog_max_log_size-directive"><code>binlog_max_log_size</code></a></li>
<li><a href="#binlog_path-directive"><code>binlog_path</code></a></li>
<li><a
href="sphinx2.html#conf-client-timeout"><code>client_timeout</code></a></li>
<li><a
href="sphinx2.html#conf-collation-libc-locale"><code>collation_libc_locale</code></a></li>
<li><a
href="sphinx2.html#conf-collation-server"><code>collation_server</code></a></li>
<li><a
href="sphinx2.html#conf-dist-threads"><code>dist_threads</code></a></li>
<li><a
href="#docstore_cache_size-directive"><code>docstore_cache_size</code></a></li>
<li><a
href="#expansion_limit-directive"><code>expansion_limit</code></a></li>
<li><a
href="sphinx2.html#conf-ha-period-karma"><code>ha_period_karma</code></a></li>
<li><a
href="sphinx2.html#conf-ha-ping-interval"><code>ha_ping_interval</code></a></li>
<li><a
href="#ha_weight_scales-directive"><code>ha_weight_scales</code></a></li>
<li><a
href="sphinx2.html#conf-hostname-lookup"><code>hostname_lookup</code></a></li>
<li><a href="#listen-directive"><code>listen</code></a></li>
<li><a
href="#listen_backlog-directive"><code>listen_backlog</code></a></li>
<li><a href="sphinx2.html#conf-log"><code>log</code></a></li>
<li><a
href="sphinx2.html#conf-max-batch-queries"><code>max_batch_queries</code></a></li>
<li><a
href="sphinx2.html#conf-max-children"><code>max_children</code></a></li>
<li><a
href="sphinx2.html#conf-max-filter-values"><code>max_filter_values</code></a></li>
<li><a
href="sphinx2.html#conf-max-filters"><code>max_filters</code></a></li>
<li><a
href="sphinx2.html#conf-max-packet-size"><code>max_packet_size</code></a></li>
<li><a href="#meta_slug-directive"><code>meta_slug</code></a></li>
<li><a
href="sphinx2.html#conf-mysql-version-string"><code>mysql_version_string</code></a></li>
<li><a
href="#net_spin_msec-directive"><code>net_spin_msec</code></a></li>
<li><a
href="sphinx2.html#conf-net-workers"><code>net_workers</code></a></li>
<li><a
href="sphinx2.html#conf-ondisk-attrs-default"><code>ondisk_attrs_default</code></a></li>
<li><a
href="#persistent_connections_limit-directive"><code>persistent_connections_limit</code></a></li>
<li><a href="sphinx2.html#conf-pid-file"><code>pid_file</code></a></li>
<li><a
href="#predicted_time_costs-directive"><code>predicted_time_costs</code></a></li>
<li><a
href="sphinx2.html#conf-preopen-indexes"><code>preopen_indexes</code></a></li>
<li><a
href="#qcache_max_bytes-directive"><code>qcache_max_bytes</code></a></li>
<li><a
href="#qcache_thresh_msec-directive"><code>qcache_thresh_msec</code></a></li>
<li><a
href="#qcache_ttl_sec-directive"><code>qcache_ttl_sec</code></a></li>
<li><a
href="sphinx2.html#conf-query-log"><code>query_log</code></a></li>
<li><a
href="sphinx2.html#conf-query-log-min-msec"><code>query_log_min_msec</code></a></li>
<li><a
href="sphinx2.html#conf-queue-max-length"><code>queue_max_length</code></a></li>
<li><a
href="sphinx2.html#conf-read-buffer"><code>read_buffer</code></a></li>
<li><a
href="sphinx2.html#conf-read-timeout"><code>read_timeout</code></a></li>
<li><a
href="sphinx2.html#conf-read-unhinted"><code>read_unhinted</code></a></li>
<li><a
href="#repl_binlog_packet_size-directive"><code>repl_binlog_packet_size</code></a></li>
<li><a
href="#repl_epoll_wait_msec-directive"><code>repl_epoll_wait_msec</code></a></li>
<li><a href="#repl_follow-directive"><code>repl_follow</code></a></li>
<li><a
href="#repl_net_timeout_sec-directive"><code>repl_net_timeout_sec</code></a></li>
<li><a
href="#repl_sync_tick_msec-directive"><code>repl_sync_tick_msec</code></a></li>
<li><a href="#repl_threads-directive"><code>repl_threads</code></a></li>
<li><a href="#repl_uid-directive"><code>repl_uid</code></a></li>
<li><a
href="sphinx2.html#conf-rt-flush-period"><code>rt_flush_period</code></a></li>
<li><a
href="sphinx2.html#conf-rt-merge-iops"><code>rt_merge_iops</code></a></li>
<li><a
href="sphinx2.html#conf-rt-merge-maxiosize"><code>rt_merge_maxiosize</code></a></li>
<li><a
href="sphinx2.html#conf-seamless-rotate"><code>seamless_rotate</code></a></li>
<li><a
href="sphinx2.html#conf-shutdown-timeout"><code>shutdown_timeout</code></a></li>
<li><a
href="sphinx2.html#conf-snippets-file-prefix"><code>snippets_file_prefix</code></a></li>
<li><a
href="sphinx2.html#conf-sphinxql-state"><code>sphinxql_state</code></a></li>
<li><a
href="sphinx2.html#conf-sphinxql-timeout"><code>sphinxql_timeout</code></a></li>
<li><a
href="sphinx2.html#conf-thread-stack"><code>thread_stack</code></a></li>
<li><a
href="sphinx2.html#conf-unlink-old"><code>unlink_old</code></a></li>
<li><a href="sphinx2.html#conf-watchdog"><code>watchdog</code></a></li>
<li><a
href="#wordpairs_ctr_file-directive"><code>wordpairs_ctr_file</code></a></li>
<li><a href="sphinx2.html#conf-workers"><code>workers</code></a></li>
</ul>
<h3 id="agent_hedge-directive"><code>agent_hedge</code> directive</h3>
<div class="sourceCode" id="cb718"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb718-1"><a href="#cb718-1" aria-hidden="true" tabindex="-1"></a><span class="ex">agent_hedge</span> = {0 <span class="kw">|</span> <span class="ex">1}</span></span></code></pre></div>
<p>Whether to enable request hegding. Default is 0 (off).</p>
<p>See <a href="#request-hedging">“Request hedging”</a> for details.</p>
<h3
id="agent_hedge_delay_min_msec-directive"><code>agent_hedge_delay_min_msec</code>
directive</h3>
<div class="sourceCode" id="cb719"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb719-1"><a href="#cb719-1" aria-hidden="true" tabindex="-1"></a><span class="ex">agent_hedge_delay_min_msec</span> = <span class="op">&lt;</span>time_msec<span class="op">&gt;</span></span></code></pre></div>
<p>Minimum “static” hedging delay, ie. the delay between receiving
second-to-last remote agent response, and issuing an extra hedged
request (to any other mirror of the last-and-slowest remote agent).</p>
<p>Default is 20 (percent), meaning that the last-and-slowest agent will
have at least 20 msec more compare to all the other agents time to
complete before the hedged request is issued.</p>
<p>See <a href="#request-hedging">“Request hedging”</a> for details.</p>
<h3
id="agent_hedge_delay_pct-directive"><code>agent_hedge_delay_pct</code>
directive</h3>
<div class="sourceCode" id="cb720"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb720-1"><a href="#cb720-1" aria-hidden="true" tabindex="-1"></a><span class="ex">agent_hedge_delay_pct</span> = <span class="op">&lt;</span>pct<span class="op">&gt;</span></span></code></pre></div>
<p>Minimum “dynamic” hedging delay, ie. the delay between receiving
second-to-last remote agent response, and issuing an extra hedged
request (to any other mirror of the last-and-slowest remote agent).</p>
<p>Default is 20 (percent), meaning that the last-and-slowest agent will
have 120% of all the other agents’ time to complete before the hedged
request is issued.</p>
<p>See <a href="#request-hedging">“Request hedging”</a> for details.</p>
<h3 id="auth_users-directive"><code>auth_users</code> directive</h3>
<div class="sourceCode" id="cb721"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb721-1"><a href="#cb721-1" aria-hidden="true" tabindex="-1"></a><span class="ex">auth_users</span> = <span class="op">&lt;</span>users_file.csv<span class="op">&gt;</span></span></code></pre></div>
<p>Users auth file. Default is empty, meaning that no user auth is
required. When specified, forces the connecting clients to provide a
valid user/password pair.</p>
<p>For more info, see the <a href="#operations-user-auth">“Operations:
user auth”</a> section.</p>
<h3 id="binlog-directive"><code>binlog</code> directive</h3>
<div class="sourceCode" id="cb722"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb722-1"><a href="#cb722-1" aria-hidden="true" tabindex="-1"></a><span class="ex">binlog</span> = {0 <span class="kw">|</span> <span class="ex">1}</span></span></code></pre></div>
<p>Binlog toggle for the datadir mode. Default is 1, meaning that
binlogs (aka WAL, write-ahead log) are enabled, and FT index writes are
safe.</p>
<p>This directive only affects the datadir mode, and is ignored in the
legacy non-datadir mode.</p>
<h3
id="binlog_erase_delay_sec-directive"><code>binlog_erase_delay_sec</code>
directive</h3>
<div class="sourceCode" id="cb723"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb723-1"><a href="#cb723-1" aria-hidden="true" tabindex="-1"></a><span class="ex">binlog_erase_delay_sec</span> = <span class="op">&lt;</span>time_sec<span class="op">&gt;</span></span>
<span id="cb723-2"><a href="#cb723-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb723-3"><a href="#cb723-3" aria-hidden="true" tabindex="-1"></a><span class="co"># retain no-longer-needed binlogs for 10 minutes</span></span>
<span id="cb723-4"><a href="#cb723-4" aria-hidden="true" tabindex="-1"></a><span class="ex">binlog_erase_delay_sec</span> = 600</span></code></pre></div>
<p>The requested delay between the last “touch” time of binlog file and
its automatic deletion, in seconds. Default is 0. Must be set to a
non-zero value (say 5-10 minutes, 300-600 seconds) when replication is
used, basically so that replicas always have a reasonable chance to
download the recent transactions.</p>
<blockquote>
<p>NOTE! Binlog file age (and therefore this delay) only matters during
normal operations. Automatic deletion can happen during clean shutdown,
or automatic periodic flush, or explicit forced flush operations. In
case of an unclean <code>searchd</code> shutdown, <strong>all</strong>
binlog files are <strong>always</strong> preserved.</p>
</blockquote>
<h3 id="binlog_flush_mode-directive"><code>binlog_flush_mode</code>
directive</h3>
<div class="sourceCode" id="cb724"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb724-1"><a href="#cb724-1" aria-hidden="true" tabindex="-1"></a><span class="ex">binlog_flush_mode</span> = {0 <span class="kw">|</span> <span class="ex">1</span> <span class="kw">|</span> <span class="ex">2}</span></span>
<span id="cb724-2"><a href="#cb724-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb724-3"><a href="#cb724-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb724-4"><a href="#cb724-4" aria-hidden="true" tabindex="-1"></a><span class="ex">binlog_flush_mode</span> = 1 <span class="co"># ultimate safety, low speed</span></span></code></pre></div>
<p>Binlog per-transaction flush and sync mode. Optional, defaults to 2,
meaning to call <code>fflush()</code> every transaction, and
<code>fsync()</code> every second.</p>
<p>This directive controls <code>searchd</code> flushing the binlog to
OS, and syncing it to disk. Three modes are supported:</p>
<ul>
<li>mode 0, <code>fflush()</code> and <code>fsync()</code> every
second.</li>
<li>mode 1, <code>fflush()</code> and <code>fsync()</code> every
transaction.</li>
<li>mode 2, <code>fflush()</code> every transaction,
<code>fsync()</code> every second.</li>
</ul>
<p>Mode 0 yields the best performance, but comparatively unsafe, as up
to 1 second of recently committed writes can get lost either on
<code>searchd</code> crash, or server (hardware or OS) crash.</p>
<p>Mode 1 yields the worst performance, but provides the strongest
guarantees. Every single committed write <strong>must</strong> survive
both <code>searchd</code> crashes <em>and</em> server crashes in this
mode.</p>
<p>Mode 2 is a reasonable hybrid, as it yields decent performance, and
guarantees that every single committed write <strong>must</strong>
survive the <code>searchd</code> crash (but not the server crash). You
could still lose up to 1 second worth of confirmed writes on a
(recoverable) server crash, but those are rare, so most frequently this
is a perfectly acceptable tradeoff.</p>
<h3
id="binlog_manifest_flush-directive"><code>binlog_manifest_flush</code>
directive</h3>
<div class="sourceCode" id="cb725"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb725-1"><a href="#cb725-1" aria-hidden="true" tabindex="-1"></a><span class="ex">binlog_manifest_flush</span> = {0 <span class="kw">|</span> <span class="ex">1}</span></span>
<span id="cb725-2"><a href="#cb725-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb725-3"><a href="#cb725-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb725-4"><a href="#cb725-4" aria-hidden="true" tabindex="-1"></a><span class="ex">binlog_manifest_flush</span> = 1 <span class="co"># enable periodic manifest flush to binlog</span></span></code></pre></div>
<p>Whether to periodically dump manifest to binlog or not. Default is 0
(off).</p>
<p>NOTE: when enabled, the checks will run every minute, but manifests
are going to be computed and written infrequently. The current limits
are at most once per 1 hour, <em>and</em> at most once per 10K
transactions.</p>
<h3 id="binlog_max_log_size-directive"><code>binlog_max_log_size</code>
directive</h3>
<div class="sourceCode" id="cb726"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb726-1"><a href="#cb726-1" aria-hidden="true" tabindex="-1"></a><span class="ex">binlog_max_log_size</span> = <span class="op">&lt;</span>size<span class="op">&gt;</span></span>
<span id="cb726-2"><a href="#cb726-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb726-3"><a href="#cb726-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb726-4"><a href="#cb726-4" aria-hidden="true" tabindex="-1"></a><span class="ex">binlog_max_log_size</span> = 1G</span></code></pre></div>
<p>Maximum binlog (WAL) file size. Optional, default is 128 MB.</p>
<p>A new binlog file will be forcibly created once the current file
reaches this size limit. This makes the logs files set a bit more
manageable.</p>
<p>Setting the max size to 0 removes the size limit. The log file will
keep growing until the next FT index flush, or restart, etc.</p>
<h3 id="binlog_path-directive"><code>binlog_path</code> directive</h3>
<div class="sourceCode" id="cb727"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb727-1"><a href="#cb727-1" aria-hidden="true" tabindex="-1"></a><span class="ex">binlog_path</span> = <span class="op">&lt;</span>path<span class="op">&gt;</span></span></code></pre></div>
<p><strong>DEPRECATED. USE DATADIR INSTEAD.</strong></p>
<p>Binlogs (aka WALs) base path, for the non-datadir mode only.
Optional, defaults to an empty string.</p>
<h3 id="docstore_cache_size-directive"><code>docstore_cache_size</code>
directive</h3>
<div class="sourceCode" id="cb728"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb728-1"><a href="#cb728-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docstore_cache_size</span> = <span class="op">&lt;</span>size<span class="op">&gt;</span> # supports k and m suffixes</span>
<span id="cb728-2"><a href="#cb728-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb728-3"><a href="#cb728-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb728-4"><a href="#cb728-4" aria-hidden="true" tabindex="-1"></a><span class="ex">docstore_cache_size</span> = 256M</span></code></pre></div>
<p>Docstore global cache size limit. Default is 10M, ie. 10485760
bytes.</p>
<p>This directive controls how much RAM can <code>searchd</code> spend
for caching individual docstore blocks (for all the indexes).</p>
<p>For more info, see the <a href="#using-docstore">“Using DocStore”</a>
section.</p>
<h3 id="expansion_limit-directive"><code>expansion_limit</code>
directive</h3>
<div class="sourceCode" id="cb729"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb729-1"><a href="#cb729-1" aria-hidden="true" tabindex="-1"></a><span class="ex">expansion_limit</span> = <span class="op">&lt;</span>count<span class="op">&gt;</span></span>
<span id="cb729-2"><a href="#cb729-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb729-3"><a href="#cb729-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb729-4"><a href="#cb729-4" aria-hidden="true" tabindex="-1"></a><span class="ex">expansion_limit</span> = 1000</span></code></pre></div>
<p>The maximum number of keywords to expand a single wildcard into.
Optional, default is 0 (no limit).</p>
<p>Wildcard searches may potentially expand wildcards into thousands and
even millions of individual keywords. Think of matching <code>a*</code>
against the entire Oxford dictionary. While good for recall, that’s not
great for performance.</p>
<p><strong>This directive imposes a server-wide expansion
limit</strong>, restricting wildcard searches and reducing their
performance impact. However, this is <em>not</em> a global hard limit!
Meaning that <strong>individual queries can override it</strong> on the
fly, using the <code>OPTION expansion_limit</code> clause.</p>
<p><code>expansion_limit = N</code> means that every single wildcard may
expand to at most N keywords. Top-N matching keywords by frequency are
guaranteed to be selected for every wildcard. That ensures the best
possible recall.</p>
<p>Note that this always is a tradeoff. Setting a smaller
<code>expansion_limit</code> helps performance, but hurts recall. Search
results will have to omit documents that match on more rare expansions.
The smaller the limit, the more results <em>may</em> get dropped.</p>
<p>But overshooting <code>expansion_limit</code> isn’t great either.
Super-common wildcards can hurt performance brutally. In absence of any
limits, deceptively innocent <code>WHERE MATCH('a*')</code> search might
easily explode into literally 100,000s of individual keywords, and slow
down to a crawl.</p>
<p>Unfortunately, the specific performance-vs-recall sweet spot varies
enormously across datasets and queries. A good tradeoff value can get as
low as just 20, or as high as 50000. To find an
<code>expansion_limit</code> value that works best, you have to analyze
your specific queries, actual expansions, latency targets, etc.</p>
<h3 id="ha_weight_scales-directive"><code>ha_weight_scales</code>
directive</h3>
<div class="sourceCode" id="cb730"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb730-1"><a href="#cb730-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ha_weight_scales</span> = <span class="op">&lt;</span>host<span class="op">&gt;</span>:<span class="op">&lt;</span>scale factor<span class="op">&gt;</span> [, ...]</span>
<span id="cb730-2"><a href="#cb730-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb730-3"><a href="#cb730-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb730-4"><a href="#cb730-4" aria-hidden="true" tabindex="-1"></a><span class="ex">ha_weight_scales</span> = primary01.lan:1, primary02.lan:0, fallback01.lan:0.1</span></code></pre></div>
<p>Scaling factors for (dynamic) host weights when using the SWRR
(Scaled Weighted Round Robin) HA strategy. Optional, default is empty
(meaning all scales are 1).</p>
<p>Scales must be floats in the 0 to 1 range, inclusive.</p>
<p>For details, see the <a
href="#agent-mirror-selection-strategies">“Agent mirror selection
strategies”</a> section.</p>
<h3 id="listen-directive"><code>listen</code> directive</h3>
<div class="sourceCode" id="cb731"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb731-1"><a href="#cb731-1" aria-hidden="true" tabindex="-1"></a><span class="ex">listen</span> = {[<span class="op">&lt;</span>host<span class="op">&gt;</span>:]<span class="op">&lt;</span>port<span class="op">&gt;</span> <span class="kw">|</span> <span class="op">&lt;</span>path<span class="op">&gt;</span>}[:<span class="op">&lt;</span>protocol<span class="op">&gt;</span>[,<span class="op">&lt;</span>flags<span class="op">&gt;</span>]]</span>
<span id="cb731-2"><a href="#cb731-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb731-3"><a href="#cb731-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example listeners with SphinxAPI protocol</span></span>
<span id="cb731-4"><a href="#cb731-4" aria-hidden="true" tabindex="-1"></a><span class="ex">listen</span> = localhost:5000</span>
<span id="cb731-5"><a href="#cb731-5" aria-hidden="true" tabindex="-1"></a><span class="ex">listen</span> = 192.168.0.1:5000:sphinx</span>
<span id="cb731-6"><a href="#cb731-6" aria-hidden="true" tabindex="-1"></a><span class="ex">listen</span> = /var/run/sphinx.s</span>
<span id="cb731-7"><a href="#cb731-7" aria-hidden="true" tabindex="-1"></a><span class="ex">listen</span> = 9312</span>
<span id="cb731-8"><a href="#cb731-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb731-9"><a href="#cb731-9" aria-hidden="true" tabindex="-1"></a><span class="co"># example listeners with SphinxQL protocol</span></span>
<span id="cb731-10"><a href="#cb731-10" aria-hidden="true" tabindex="-1"></a><span class="ex">listen</span> = node123.sphinxcluster.internal:9306:mysql</span>
<span id="cb731-11"><a href="#cb731-11" aria-hidden="true" tabindex="-1"></a><span class="ex">listen</span> = 8306:mysql,vip,nolocalauth</span></code></pre></div>
<p>Network listener that <code>searchd</code> must accept incoming
connections on. Configures the listening address and protocol, and
optional per-listener flags (see below). Multi-value, multiple listeners
are allowed.</p>
<p>The default listeners are as follows. They accept connections on TCP
ports 9312 (using SphinxAPI protocol) and 9306 (using MySQL protocol)
respectively. Both ports are IANA registered for Sphinx. This
Sphinx.</p>
<div class="sourceCode" id="cb732"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb732-1"><a href="#cb732-1" aria-hidden="true" tabindex="-1"></a><span class="co"># default listeners</span></span>
<span id="cb732-2"><a href="#cb732-2" aria-hidden="true" tabindex="-1"></a><span class="ex">listen</span> = 9312:sphinx</span>
<span id="cb732-3"><a href="#cb732-3" aria-hidden="true" tabindex="-1"></a><span class="ex">listen</span> = 9306:mysql</span></code></pre></div>
<p><strong>TCP (port) listeners</strong> (such as the two default ones)
only require a TCP port number. In that case they accept connections on
all network interfaces. They can also be restricted to individual
interfaces. For that, just specify the optional IP address (or a host
name that resolves to that address).</p>
<p>For example, assume that our server has both a public IP and an
internal one, and we want to allow connections to <code>searchd</code>
via the internal IP only.</p>
<div class="sourceCode" id="cb733"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb733-1"><a href="#cb733-1" aria-hidden="true" tabindex="-1"></a><span class="ex">listen</span> = 192.168.1.23:9306:mysql</span></code></pre></div>
<p>Alternatively, we can use a host name (such as
<code>node123.sphinxcluster.internal</code> or <code>localhost</code>
from the examples above). The host name <strong>must</strong> then
resolve to an IP address that our server actually has during
<code>searchd</code> startup, or it will fail to start.</p>
<div class="sourceCode" id="cb734"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb734-1"><a href="#cb734-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> searchd <span class="at">-q</span> <span class="at">--listen</span> dns.google:9306:mysql</span>
<span id="cb734-2"><a href="#cb734-2" aria-hidden="true" tabindex="-1"></a><span class="ex">no</span> config file and no datadir, using <span class="st">&#39;./sphinxdata&#39;</span>...</span>
<span id="cb734-3"><a href="#cb734-3" aria-hidden="true" tabindex="-1"></a><span class="ex">WARNING:</span> multiple addresses found for <span class="st">&#39;dns.google&#39;</span>, using the first one <span class="er">(</span><span class="va">ip</span><span class="op">=</span>8.8.8.8<span class="kw">)</span></span>
<span id="cb734-4"><a href="#cb734-4" aria-hidden="true" tabindex="-1"></a><span class="ex">listening</span> on 8.8.8.8:9306</span>
<span id="cb734-5"><a href="#cb734-5" aria-hidden="true" tabindex="-1"></a><span class="fu">bind()</span> <span class="ex">failed</span> on 8.8.8.8:9306, retrying...</span>
<span id="cb734-6"><a href="#cb734-6" aria-hidden="true" tabindex="-1"></a><span class="fu">bind()</span> <span class="ex">failed</span> on 8.8.8.8:9306, retrying...</span>
<span id="cb734-7"><a href="#cb734-7" aria-hidden="true" tabindex="-1"></a><span class="fu">bind()</span> <span class="ex">failed</span> on 8.8.8.8:9306, retrying...</span></code></pre></div>
<p><strong>UNIX (socket) listeners</strong> require a local socket path
name. Usually those would be placed some well-known shared directory
such as <code>/tmp</code> or <code>/var/run</code>.</p>
<p>The socket path <strong>must</strong> begin with a leading slash.
Anything else gets treated as a host name (or port).</p>
<p>Naturally, UNIX sockets are not supported on Windows. (Not that
anyone I know still runs Sphinx on Windows in production.)</p>
<p><strong>Supported protocols are <code>sphinx</code> (SphinxAPI) and
<code>mysql</code> (MySQL).</strong> Merely historically, the default
value is <code>sphinx</code>, so <code>listen = 9312</code> is still
legal.</p>
<p>For client applications, use <code>mysql</code> listeners, and MySQL
client libraries and programs. <strong>SphinxQL dialect via MySQL wire
protocol is our primary API.</strong></p>
<p>For Sphinx clusters, use <code>sphinx</code> listeners, as
<code>searchd</code> instances <strong>only</strong> talk to each other
via SphinxAPI. Agents in distributed indexes and replication masters
<strong>must</strong> be pointed to SphinxAPI ports.</p>
<p><strong>Supported listener flags are <code>vip</code>,
<code>noauth</code>, and <code>nolocalauth</code>.</strong> Multiple
flags can be specified using a comma-separated list.</p>
<div class="sourceCode" id="cb735"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb735-1"><a href="#cb735-1" aria-hidden="true" tabindex="-1"></a><span class="ex">listen</span> = 8306:mysql,vip,nolocalauth</span></code></pre></div>
<table>
<colgroup>
<col style="width: 21%" />
<col style="width: 78%" />
</colgroup>
<thead>
<tr class="header">
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>noauth</code></td>
<td>Skip <code>auth_users</code> auth for any clients</td>
</tr>
<tr class="even">
<td><code>nolocalauth</code></td>
<td>Skip <code>auth_users</code> auth for local clients only</td>
</tr>
<tr class="odd">
<td><code>vip</code></td>
<td>Skip the overload checks and always accept connections</td>
</tr>
</tbody>
</table>
<p>Connections to <code>vip</code> listeners bypass the
<code>max_children</code> limit on the active workers. They
<strong>always</strong> create a new dedicated thread and connect, even
when <code>searchd</code> is overloaded and connections to regular
listeners fail. This is for emergency maintenance.</p>
<p>See <a href="#operations-user-auth">“Operations: user auth”</a> for
more details regarding auth-related flags.</p>
<h3 id="listen_backlog-directive"><code>listen_backlog</code>
directive</h3>
<div class="sourceCode" id="cb736"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb736-1"><a href="#cb736-1" aria-hidden="true" tabindex="-1"></a><span class="ex">listen_backlog</span> = <span class="op">&lt;</span>number<span class="op">&gt;</span></span>
<span id="cb736-2"><a href="#cb736-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb736-3"><a href="#cb736-3" aria-hidden="true" tabindex="-1"></a><span class="co"># examples</span></span>
<span id="cb736-4"><a href="#cb736-4" aria-hidden="true" tabindex="-1"></a><span class="ex">listen_backlog</span> = 256</span></code></pre></div>
<p>TCP backlog length for <code>listen()</code> calls. Optional, default
is 64.</p>
<p><code>listen_backlog</code> controls the maximum kernel-side pending
connections queue length, that is, the maximum number of incoming
connections that <code>searchd</code> did not yet <code>accept()</code>
for whatever reason, and the OS is allowed to hold.</p>
<p>The defaults are usually fine. Backlog must not be too low, or
kernel-side TCP throttling will happen. Backlog can not be set too high
either. On modern Linux kernels, silent
<code>/proc/sys/net/core/somaxconn</code> upper limit applies, and that
limit defaults to 4096. Refer to <code>man 2 listen</code> for more
details.</p>
<h3 id="meta_slug-directive"><code>meta_slug</code> directive</h3>
<div class="sourceCode" id="cb737"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb737-1"><a href="#cb737-1" aria-hidden="true" tabindex="-1"></a><span class="ex">meta_slug</span> = <span class="op">&lt;</span>slug_string<span class="op">&gt;</span></span>
<span id="cb737-2"><a href="#cb737-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb737-3"><a href="#cb737-3" aria-hidden="true" tabindex="-1"></a><span class="co"># examples</span></span>
<span id="cb737-4"><a href="#cb737-4" aria-hidden="true" tabindex="-1"></a><span class="ex">meta_slug</span> = shard1</span>
<span id="cb737-5"><a href="#cb737-5" aria-hidden="true" tabindex="-1"></a><span class="ex">meta_slug</span> = <span class="va">$hostname</span></span></code></pre></div>
<p>Server-wide query metainfo slug (as returned in
<code>SHOW META</code>). Default is empty. Gets processed once on daemon
startup, and <code>$hostname</code> macro gets expanded to the current
host name, obtained with a <code>gethostname()</code> call.</p>
<p>When non-empty, adds a slug to all the metas, so that
<code>SHOW META</code> query starts returning an additional key
(naturally called <code>slug</code>) with the server-wide slug value.
Furthermore, in distributed indexes metas are aggregated, meaning that
in that case <code>SHOW META</code> is going to return <em>all</em> the
slugs from all the agents.</p>
<p>This helps identify the specific hosts (replicas really) that
produced a specific result set in a scenario when there are several
agent mirrors. Quite useful for tracing and debugging.</p>
<h3 id="net_spin_msec-directive"><code>net_spin_msec</code>
directive</h3>
<div class="sourceCode" id="cb738"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb738-1"><a href="#cb738-1" aria-hidden="true" tabindex="-1"></a><span class="ex">net_spin_msec</span> = <span class="op">&lt;</span>spin_wait_timeout<span class="op">&gt;</span></span>
<span id="cb738-2"><a href="#cb738-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb738-3"><a href="#cb738-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb738-4"><a href="#cb738-4" aria-hidden="true" tabindex="-1"></a><span class="ex">net_spin_msec</span> = 0</span></code></pre></div>
<p>Allows the network thread to spin for this many milliseconds, ie.
call <code>epoll()</code> (or its equivalent) with zero timeout. Default
is 10 msec.</p>
<p>After spinning for <code>net_spin_msec</code> with no incoming
events, the network thread switches to calling <code>epoll()</code> with
1 msec timeout. Setting this to 0 fully disables spinning, and
<code>epoll()</code> is <em>always</em> called with 1 msec timeout.</p>
<p>On some systems, spinning for the default 10 msec value seems to
improve query throughput under high query load (as in 1000 rps and
more). On other systems and/or with different load patterns, the impact
could be negligible, you may waste a bit of CPU for nothing, and zero
spinning would be better. YMMV.</p>
<h3
id="persistent_connections_limit-directive"><code>persistent_connections_limit</code>
directive</h3>
<div class="sourceCode" id="cb739"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb739-1"><a href="#cb739-1" aria-hidden="true" tabindex="-1"></a><span class="ex">persistent_connections_limit</span> = <span class="op">&lt;</span>number<span class="op">&gt;</span></span>
<span id="cb739-2"><a href="#cb739-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb739-3"><a href="#cb739-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb739-4"><a href="#cb739-4" aria-hidden="true" tabindex="-1"></a><span class="ex">persistent_connections_limit</span> = 32</span></code></pre></div>
<p>The maximum number of persistent connections that master is allowed
to keep to an specific agent host. Optional, default is 0 (disabling
<code>agent_persistent</code>).</p>
<p>Agents in <code>workers = threads</code> mode dedicate a worker
thread to each network connection, even an idle one. We thus need a
limiter on the master side to avoid exhausting available workers on the
agent sides. This is it.</p>
<p>It’s a master-side limit. It applies per-agent-instance (ie.
host:port pair), across all the configured distributed indexes.</p>
<h3
id="predicted_time_costs-directive"><code>predicted_time_costs</code>
directive</h3>
<div class="sourceCode" id="cb740"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb740-1"><a href="#cb740-1" aria-hidden="true" tabindex="-1"></a><span class="ex">predicted_time_costs</span> = doc=<span class="op">&lt;</span>A<span class="op">&gt;</span>, hit=<span class="op">&lt;</span>B<span class="op">&gt;</span>, skip=<span class="op">&lt;</span>C<span class="op">&gt;</span>, match=<span class="op">&lt;</span>D<span class="op">&gt;</span></span></code></pre></div>
<p>Sets costs for the <code>max_predicted_time</code> prediction model,
in (virtual) nanoseconds. Optional, the default is
<code>doc=64, hit=48, skip=2048, match=64</code>.</p>
<p>The “predicted time” machinery lets you
<strong>deterministically</strong> terminate queries once they run out
of their allowed (virtual) execution time budget. It’s based on a simple
linear model.</p>
<div class="sourceCode" id="cb741"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb741-1"><a href="#cb741-1" aria-hidden="true" tabindex="-1"></a>predicted_time <span class="op">=</span></span>
<span id="cb741-2"><a href="#cb741-2" aria-hidden="true" tabindex="-1"></a>    doc_cost <span class="op">*</span> processed_documents <span class="op">+</span></span>
<span id="cb741-3"><a href="#cb741-3" aria-hidden="true" tabindex="-1"></a>    hit_cost <span class="op">*</span> processed_hits <span class="op">+</span></span>
<span id="cb741-4"><a href="#cb741-4" aria-hidden="true" tabindex="-1"></a>    skip_cost <span class="op">*</span> skiplist_jumps <span class="op">+</span></span>
<span id="cb741-5"><a href="#cb741-5" aria-hidden="true" tabindex="-1"></a>    match_cost <span class="op">*</span> found_matches</span></code></pre></div>
<p>The matching engine tracks <code>processed_documents</code> and
counters as it goes, updates the current <code>predicted_time</code>
value once per every few rows, and checks whether or not it’s over the
<code>OPTION max_predicted_time=&lt;N&gt;</code> budget. Queries that
run out of the budget are terminated early (with a warning
reported).</p>
<p>Note how for convenience costs are counted in
<strong>nanoseconds</strong>, and the budget is in
<strong>milliseconds</strong> (or alternatively, we can say that the
budget is in <strong>units</strong>, and costs are in
<strong>microunits</strong>, ie. one millionth part of a unit). All
costs are integers.</p>
<p>To collect the actual counters to track/check your costs model, run
your queries with <code>max_query_time</code> set high, and see
<code>SHOW META</code>, as follows.</p>
<div class="sourceCode" id="cb742"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb742-1"><a href="#cb742-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test <span class="kw">WHERE</span> MATCH(<span class="st">&#39;...&#39;</span>)</span>
<span id="cb742-2"><a href="#cb742-2" aria-hidden="true" tabindex="-1"></a>   <span class="kw">OPTION</span> max_predicted_time<span class="op">=</span><span class="dv">1000000</span>;</span>
<span id="cb742-3"><a href="#cb742-3" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb742-4"><a href="#cb742-4" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW META <span class="kw">LIKE</span> <span class="st">&#39;local_fetched_%&#39;</span>;</span>
<span id="cb742-5"><a href="#cb742-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------------+----------+</span></span>
<span id="cb742-6"><a href="#cb742-6" aria-hidden="true" tabindex="-1"></a>| Variable_name        | <span class="fu">Value</span>    |</span>
<span id="cb742-7"><a href="#cb742-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------------+----------+</span></span>
<span id="cb742-8"><a href="#cb742-8" aria-hidden="true" tabindex="-1"></a>| local_fetched_docs   | <span class="dv">1311380</span>  |</span>
<span id="cb742-9"><a href="#cb742-9" aria-hidden="true" tabindex="-1"></a>| local_fetched_hits   | <span class="dv">12573787</span> |</span>
<span id="cb742-10"><a href="#cb742-10" aria-hidden="true" tabindex="-1"></a>| local_fetched_fields | <span class="dv">0</span>        |</span>
<span id="cb742-11"><a href="#cb742-11" aria-hidden="true" tabindex="-1"></a>| local_fetched_skips  | <span class="dv">41758</span>    |</span>
<span id="cb742-12"><a href="#cb742-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------------+----------+</span></span>
<span id="cb742-13"><a href="#cb742-13" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span>
<span id="cb742-14"><a href="#cb742-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb742-15"><a href="#cb742-15" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW META <span class="kw">LIKE</span> <span class="st">&#39;total_found&#39;</span>;</span>
<span id="cb742-16"><a href="#cb742-16" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+--------+</span></span>
<span id="cb742-17"><a href="#cb742-17" aria-hidden="true" tabindex="-1"></a>| Variable_name | <span class="fu">Value</span>  |</span>
<span id="cb742-18"><a href="#cb742-18" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+--------+</span></span>
<span id="cb742-19"><a href="#cb742-19" aria-hidden="true" tabindex="-1"></a>| total_found   | <span class="dv">566397</span> |</span>
<span id="cb742-20"><a href="#cb742-20" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+--------+</span></span>
<span id="cb742-21"><a href="#cb742-21" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>The test query above costs 810 units with the default settings model
costs. Because
<code>(64*1311380 + 48*12573787 + 2048*41758 + 64*566397) / 1000000</code>
equals approximately 809.24 and we should round up. And indeed, if we
set a <strong>smaller</strong> budget than 810 units, we can observe
less time spent, less matches found, and early termination warnings, all
as expected.</p>
<div class="sourceCode" id="cb743"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb743-1"><a href="#cb743-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test <span class="kw">WHERE</span> MATCH(<span class="st">&#39;...&#39;</span>) <span class="kw">LIMIT</span> <span class="dv">3</span></span>
<span id="cb743-2"><a href="#cb743-2" aria-hidden="true" tabindex="-1"></a>   <span class="kw">OPTION</span> max_predicted_time<span class="op">=</span><span class="dv">809</span>;</span>
<span id="cb743-3"><a href="#cb743-3" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb743-4"><a href="#cb743-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb743-5"><a href="#cb743-5" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW META;</span>
<span id="cb743-6"><a href="#cb743-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+----------------------------------------------------------------+</span></span>
<span id="cb743-7"><a href="#cb743-7" aria-hidden="true" tabindex="-1"></a>| Variable_name | <span class="fu">Value</span>                                                          |</span>
<span id="cb743-8"><a href="#cb743-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+----------------------------------------------------------------+</span></span>
<span id="cb743-9"><a href="#cb743-9" aria-hidden="true" tabindex="-1"></a>| warning       | <span class="kw">index</span> <span class="st">&#39;test&#39;</span>: predicted <span class="kw">query</span> <span class="dt">time</span> exceeded max_predicted_time |</span>
<span id="cb743-10"><a href="#cb743-10" aria-hidden="true" tabindex="-1"></a>| total         | <span class="dv">3</span>                                                              |</span>
<span id="cb743-11"><a href="#cb743-11" aria-hidden="true" tabindex="-1"></a>| total_found   | <span class="dv">566218</span>                                                         |</span>
<span id="cb743-12"><a href="#cb743-12" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb743-13"><a href="#cb743-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb743-14"><a href="#cb743-14" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test <span class="kw">WHERE</span> MATCH(<span class="st">&#39;...&#39;</span>) <span class="kw">LIMIT</span> <span class="dv">3</span></span>
<span id="cb743-15"><a href="#cb743-15" aria-hidden="true" tabindex="-1"></a>   <span class="kw">OPTION</span> max_predicted_time<span class="op">=</span><span class="dv">100</span>;</span>
<span id="cb743-16"><a href="#cb743-16" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb743-17"><a href="#cb743-17" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW META <span class="kw">LIKE</span> <span class="st">&#39;total_found&#39;</span>;</span>
<span id="cb743-18"><a href="#cb743-18" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+-------+</span></span>
<span id="cb743-19"><a href="#cb743-19" aria-hidden="true" tabindex="-1"></a>| Variable_name | <span class="fu">Value</span> |</span>
<span id="cb743-20"><a href="#cb743-20" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+-------+</span></span>
<span id="cb743-21"><a href="#cb743-21" aria-hidden="true" tabindex="-1"></a>| total_found   | <span class="dv">70610</span> |</span>
<span id="cb743-22"><a href="#cb743-22" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+-------+</span></span>
<span id="cb743-23"><a href="#cb743-23" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="kw">row</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>With a little model fitting effort units <strong>might</strong>
probably be matched to wall time with reasonable precision. In our
ancient experiments we were able to tune our costs (for a particular
machine, dataset, etc!) so that <em>most</em> queries given a limit of
“100 units” actually executed in 95..105 msec wall time, and
<em>all</em> queries executed in 80..120 msec. Then again, your mileage
may vary.</p>
<p>It is not necessary to specify all 4 costs at once, as the missed
ones just take the default values. However, we strongly suggest
specifying all of them anyway, for readability.</p>
<h3 id="qcache_max_bytes-directive"><code>qcache_max_bytes</code>
directive</h3>
<div class="sourceCode" id="cb744"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb744-1"><a href="#cb744-1" aria-hidden="true" tabindex="-1"></a><span class="ex">qcache_max_bytes</span> = 16777216 <span class="co"># this is 16M</span></span>
<span id="cb744-2"><a href="#cb744-2" aria-hidden="true" tabindex="-1"></a><span class="ex">qcache_max_bytes</span> = 256M <span class="co"># size suffixes allowed</span></span></code></pre></div>
<p>Query cache RAM limit, in bytes. Defaults to 0, which disables the
query cache. Size suffixes such as <code>256M</code> are supported.</p>
<p>For details, see the <a href="#searching-query-cache">“Searching:
query cache”</a> section.</p>
<h3 id="qcache_thresh_msec-directive"><code>qcache_thresh_msec</code>
directive</h3>
<div class="sourceCode" id="cb745"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb745-1"><a href="#cb745-1" aria-hidden="true" tabindex="-1"></a><span class="ex">qcache_thresh_msec</span> = 100 <span class="co"># cache all queries slower than 0.1 sec</span></span></code></pre></div>
<p>Query cache threshold, in milliseconds. The minimum query wall time
required for caching the (intermediate) query result. Defaults to 3000,
or 3 seconds.</p>
<p>Beware that 0 means “cache everything”, so use that with care! To
disable query cache, set its size limit (aka
<code>qcache_max_bytes</code>) to 0 instead.</p>
<p>For details, see the <a href="#searching-query-cache">“Searching:
query cache”</a> section.</p>
<h3 id="qcache_ttl_sec-directive"><code>qcache_ttl_sec</code>
directive</h3>
<div class="sourceCode" id="cb746"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb746-1"><a href="#cb746-1" aria-hidden="true" tabindex="-1"></a><span class="ex">qcache_ttl_sec</span> = 5 <span class="co"># only cache briefly for 5 sec, useful for batched queries</span></span></code></pre></div>
<p>Query cache entry (aka compressed result set) expiration period, in
seconds. Defaults to 60, or 1 minute. The minimum possible value is 1
second.</p>
<p>For details, see the <a href="#searching-query-cache">“Searching:
query cache”</a> section.</p>
<h3
id="repl_binlog_packet_size-directive"><code>repl_binlog_packet_size</code>
directive</h3>
<div class="sourceCode" id="cb747"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb747-1"><a href="#cb747-1" aria-hidden="true" tabindex="-1"></a><span class="ex">repl_binlog_packet_size</span> = <span class="op">&lt;</span>size<span class="op">&gt;</span></span>
<span id="cb747-2"><a href="#cb747-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb747-3"><a href="#cb747-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb747-4"><a href="#cb747-4" aria-hidden="true" tabindex="-1"></a><span class="ex">repl_binlog_packet_size</span> = 240000</span></code></pre></div>
<p>Internal SphinxAPI packet size for streaming binlogs from master to
replicas. Optional, default is 256K. Must be in 128K to 128M range.</p>
<p>Master splits the streamed data into SphinxAPI packets of this size.
(Note: this is our application-level packet size; <strong>completly
unrelated</strong> to TCP or IP or Ethernet packet sizes.)</p>
<p>For the record, this only applies to <code>BINLOG</code> SphinxAPI
command; because during <code>JOIN</code> we rely on the
<code>sendfile()</code> mechanism (available on most UNIX systems).</p>
<p>Refer to <a href="#using-replication">“Using replication”</a> for
details.</p>
<h3
id="repl_epoll_wait_msec-directive"><code>repl_epoll_wait_msec</code>
directive</h3>
<div class="sourceCode" id="cb748"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb748-1"><a href="#cb748-1" aria-hidden="true" tabindex="-1"></a><span class="ex">repl_epoll_wait_msec</span> = <span class="op">&lt;</span>N<span class="op">&gt;</span></span>
<span id="cb748-2"><a href="#cb748-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb748-3"><a href="#cb748-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb748-4"><a href="#cb748-4" aria-hidden="true" tabindex="-1"></a><span class="ex">repl_epoll_wait_msec</span> = 5000</span></code></pre></div>
<p>Internal replica-side <code>epoll()</code> timeout for the
masters-polling loop. Optional, default is 1000 (1 sec), must be in 0 to
10000 (0 to 10 sec) range.</p>
<p>Replication event loop (that handles all the replicated indexes) will
wait this much for at least one response from a master.</p>
<p>Refer to <a href="#using-replication">“Using replication”</a> for
details.</p>
<h3 id="repl_follow-directive-1"><code>repl_follow</code> directive</h3>
<div class="sourceCode" id="cb749"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb749-1"><a href="#cb749-1" aria-hidden="true" tabindex="-1"></a><span class="ex">repl_follow</span> = <span class="op">&lt;</span>ip_addr[:api_port]<span class="op">&gt;</span></span>
<span id="cb749-2"><a href="#cb749-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb749-3"><a href="#cb749-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb749-4"><a href="#cb749-4" aria-hidden="true" tabindex="-1"></a><span class="ex">repl_follow</span> = 127.0.0.1:8787</span></code></pre></div>
<p>The global remote master <code>searchd</code> instance address to
follow. Makes <strong>all</strong> RT indexes served by the current
<code>searchd</code> instance read-only and replicates writes from the
specified master.</p>
<p>The port <strong>must</strong> point to SphinxAPI listener, not
SphinxQL. The default port is 9312.</p>
<p>The per-index <code>repl_follow</code> takes precedence and overrides
this global setting.</p>
<p>Refer to <a href="#using-replication">“Using replication”</a> for
details.</p>
<h3
id="repl_net_timeout_sec-directive"><code>repl_net_timeout_sec</code>
directive</h3>
<div class="sourceCode" id="cb750"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb750-1"><a href="#cb750-1" aria-hidden="true" tabindex="-1"></a><span class="ex">repl_net_timeout_sec</span> = <span class="op">&lt;</span>N<span class="op">&gt;</span></span>
<span id="cb750-2"><a href="#cb750-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb750-3"><a href="#cb750-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb750-4"><a href="#cb750-4" aria-hidden="true" tabindex="-1"></a><span class="ex">repl_net_timeout_sec</span> = 20</span></code></pre></div>
<p>Internal replication network operations timeout (in seconds), on both
master and replica sides, in seconds. Optional, default is 7 sec. Must
be in 1 to 60 sec range.</p>
<p>Refer to <a href="#using-replication">“Using replication”</a> for
details.</p>
<h3 id="repl_sync_tick_msec-directive"><code>repl_sync_tick_msec</code>
directive</h3>
<div class="sourceCode" id="cb751"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb751-1"><a href="#cb751-1" aria-hidden="true" tabindex="-1"></a><span class="ex">repl_sync_tick_msec</span> = <span class="op">&lt;</span>N<span class="op">&gt;</span></span>
<span id="cb751-2"><a href="#cb751-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb751-3"><a href="#cb751-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb751-4"><a href="#cb751-4" aria-hidden="true" tabindex="-1"></a><span class="ex">repl_sync_tick_msec</span> = 200</span></code></pre></div>
<p>Internal replication “ping” frequency, in msec. Optional, default is
100 msec. Must be in 10 msec to 100000 msec (100 sec) range.</p>
<p>Every replicated index sends a <code>BINLOG</code> SphinxAPI command
to its master once per <code>repl_sync_tick_msec</code>
milliseconds.</p>
<p>Refer to <a href="#using-replication">“Using replication”</a> for
details.</p>
<h3 id="repl_threads-directive"><code>repl_threads</code> directive</h3>
<div class="sourceCode" id="cb752"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb752-1"><a href="#cb752-1" aria-hidden="true" tabindex="-1"></a><span class="ex">repl_threads</span> = <span class="op">&lt;</span>N<span class="op">&gt;</span></span>
<span id="cb752-2"><a href="#cb752-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb752-3"><a href="#cb752-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb752-4"><a href="#cb752-4" aria-hidden="true" tabindex="-1"></a><span class="ex">repl_threads</span> = 8</span></code></pre></div>
<p>Replica-side replication worker threads count. Optional, default is 4
threads. Must be in 1 to 32 range.</p>
<p>Replication worker threads parse the received masters responses, and
locally apply the changes (to locally replicated indexes). They use a
separate thread pool, and this setting controls its size.</p>
<p>Each worker thread handles one replicated index at a time. Workers
perform actual socket reads, accumulate master responses until they’re
complete, and then (most importantly) parse them and apply received
changes. This means either applying the received transactions, or
juggling the received files and reloading the replicated RT index.</p>
<p>Refer to <a href="#using-replication">“Using replication”</a> for
details.</p>
<h3 id="repl_uid-directive"><code>repl_uid</code> directive</h3>
<div class="sourceCode" id="cb753"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb753-1"><a href="#cb753-1" aria-hidden="true" tabindex="-1"></a><span class="ex">repl_uid</span> = <span class="op">&lt;</span>uid<span class="op">&gt;</span> # must be <span class="st">&quot;[0-9A-F]{8}-[0-9A-F]{8}&quot;</span></span>
<span id="cb753-2"><a href="#cb753-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb753-3"><a href="#cb753-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb753-4"><a href="#cb753-4" aria-hidden="true" tabindex="-1"></a><span class="ex">repl_uid</span> = CAFEBABE-8BADF00D</span></code></pre></div>
<p>A globally unique replica instance identifier (aka RID). Optional,
default is empty (meaning to generate automatically).</p>
<p>Every single replicated index instance in the cluster is going to be
uniquely identified by <code>searchd</code> RID, and the index name. RID
is usually auto-generated, but <code>repl_uid</code> allows setting it
manually.</p>
<p>Refer to <a href="#using-replication">“Using replication”</a> for
details.</p>
<h3 id="wordpairs_ctr_file-directive"><code>wordpairs_ctr_file</code>
directive</h3>
<div class="sourceCode" id="cb754"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb754-1"><a href="#cb754-1" aria-hidden="true" tabindex="-1"></a><span class="ex">wordpairs_ctr_file</span> = <span class="op">&lt;</span>path<span class="op">&gt;</span></span>
<span id="cb754-2"><a href="#cb754-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb754-3"><a href="#cb754-3" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb754-4"><a href="#cb754-4" aria-hidden="true" tabindex="-1"></a><span class="ex">wordpairs_ctr_file</span> = query2doc.tsv</span></code></pre></div>
<p>Specifies a data file to use for <code>wordpair_ctr</code> ranking
signal and <code>WORDPAIRCTR()</code> function calculations.</p>
<p>For more info, see the <a
href="#ranking-tokhashes-and-wordpair_ctr">“Ranking: tokhashes…”</a>
section.</p>
<h2 id="indexer-cli-reference"><code>indexer</code> CLI reference</h2>
<p><code>indexer</code> is most frequently invoked with the
<code>build</code> subcommand (that fully rebuilds an FT index), but
there’s more to it than that!</p>
<table>
<thead>
<tr class="header">
<th>Command</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>build</td>
<td>reindex one or more FT indexes</td>
</tr>
<tr class="even">
<td>buildstops</td>
<td>build stopwords from FT index data sources</td>
</tr>
<tr class="odd">
<td>help</td>
<td>show help for a given command</td>
</tr>
<tr class="even">
<td>merge</td>
<td>merge two FT indexes</td>
</tr>
<tr class="odd">
<td>prejoin</td>
<td>preparse and cache join sources</td>
</tr>
<tr class="even">
<td>pretrain</td>
<td>pretrain vector index clusters</td>
</tr>
<tr class="odd">
<td>version</td>
<td>show version and build options</td>
</tr>
</tbody>
</table>
<p>Let’s quickly overview those.</p>
<p><strong><code>build</code> subcommand creates a plain FT index from
source data.</strong> You use this one to fully rebuild the entire
index. Depending on your setup, rebuilds might be either as frequent as
every minute (to rebuild and ship tiny delta indexes), or as rare as
“during disaster recovery only” (including drills).</p>
<p><strong><code>buildstops</code> subcommand extracts stopwords without
creating any index.</strong> That’s definitely not an everyday activity,
but a somewhat useful tool when initially configuring your indexes.</p>
<p><strong><code>merge</code> subcommand physically merges two existing
plain FT indexes.</strong> Also, it optimizes the target index as it
goes. Again depending on your specific index setup, this might either be
a part of everyday workflow (think of merging new per-day data into
archives during overnight maintenance), or never ever needed.</p>
<p><strong><code>prejoin</code> subcommand creates or forcibly updates
join files cache.</strong> It helps improve build times when several
indexes reuse the same join sources. It creates or refreshes the
respective <code>.joincache</code> file for each specified source. For
details, see <a href="#caching-text-join-sources">“Caching text join
sources”</a>.</p>
<p><strong><code>pretrain</code> subcommand creates pretrained clusters
for vector indexes.</strong> Very definitely not an everyday activity,
too, but <strong>essential</strong> for vector indexing performance when
rebuilding larger indexes. Because without clusters pretrained on data
that you hand-picked upfront, Sphinx for now defaults to reclustering
the <strong>entire</strong> input dataset. And for 100+ million row
datasets that’s not going to be fast!</p>
<p>All subcommands come with their own options. You can use
<code>help</code> to quickly navigate those. Here’s one example
output.</p>
<pre><code>$ indexer help buildstops
Usage: indexer buildstops --out &lt;top.txt&gt; [OPTIONS] &lt;index1&gt; [&lt;index2&gt; ...]

Builds a list of top-N most frequent keywords from the index data sources.
That provides a useful baseline for stopwords.

Options are:
   --ask-password    prompt for password, override `sql_pass` in SQL sources
   --buildfreqs      include words frequencies in &lt;output.txt&gt;
   --noprogress      do not display progress (automatic when not on a TTY)
   --out &lt;top.txt&gt;   save output in &lt;top.txt&gt; (required)
   --password &lt;secret&gt;
                     override `sql_pass` in SQL sources with &lt;secret&gt;
   --top &lt;N&gt;         pick top &lt;N&gt; keywords (default is 100)</code></pre>
<p>TODO: document all individual indexer subcommands and their
options!</p>
<h2 id="searchd-cli-reference"><code>searchd</code> CLI reference</h2>
<h3 id="searchd-subcommands"><code>searchd</code> subcommands</h3>
<p>The primary <code>searchd</code> operation mode is to run as a
daemon, and serve queries. Unless you specify an explicit subcommand, it
does that. However, it supports a few more subcommands.</p>
<table>
<thead>
<tr class="header">
<th>Command</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>decode</code></td>
<td>decode SphinxAPI query dump (as SphinxQL)</td>
</tr>
<tr class="even">
<td><code>help</code></td>
<td>show help for a given command</td>
</tr>
<tr class="odd">
<td><code>run</code></td>
<td>run the daemon (the default command)</td>
</tr>
<tr class="even">
<td><code>stop</code></td>
<td>stop the running daemon</td>
</tr>
<tr class="odd">
<td><code>version</code></td>
<td>show version and build options</td>
</tr>
</tbody>
</table>
<p>To show the list of commands and common options, run
<code>searchd -?</code> explicitly (<code>searchd -h</code> and
<code>searchd --help</code> also work).</p>
<p>Let’s begin with the common options that apply to
<strong>all</strong> the commands.</p>
<h3 id="common-searchd-options">Common <code>searchd</code> options</h3>
<p>The common options (that apply to all commands including
<code>run</code>) are as follows.</p>
<table>
<thead>
<tr class="header">
<th>Option</th>
<th>Brief description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>--config</code>, <code>-c</code></td>
<td>specify a config file</td>
</tr>
<tr class="even">
<td><code>--datadir</code></td>
<td>specify a (non-default) datadir path</td>
</tr>
<tr class="odd">
<td><code>--quiet</code>, <code>-q</code></td>
<td>be quiet, skip banner etc</td>
</tr>
</tbody>
</table>
<h4 id="searchd---config-option"><code>searchd --config</code>
option</h4>
<p><code>--config &lt;file&gt;</code> (or <code>-c</code> for short)
tells <code>searchd</code> to use a specific config file instead of the
default <code>sphinx.conf</code> file.</p>
<div class="sourceCode" id="cb756"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb756-1"><a href="#cb756-1" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb756-2"><a href="#cb756-2" aria-hidden="true" tabindex="-1"></a><span class="ex">searchd</span> <span class="at">--config</span> /home/myuser/sphinxtest02.conf</span></code></pre></div>
<h4 id="searchd---datadir-option"><code>searchd --datadir</code>
option</h4>
<p><code>--datadir=&lt;path&gt;</code> specifies a non-standard path to
a datadir, a folder that stores all the data and settings. It overrides
any config file settings.</p>
<p>See <a href="#using-datadir">“Using datadir”</a> section for more
details.</p>
<div class="sourceCode" id="cb757"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb757-1"><a href="#cb757-1" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb757-2"><a href="#cb757-2" aria-hidden="true" tabindex="-1"></a><span class="ex">searchd</span> <span class="at">--datadir</span> /home/sphinx/sphinxdata</span></code></pre></div>
<h3 id="searchd-decode-command"><code>searchd decode</code> command</h3>
<div class="sourceCode" id="cb758"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb758-1"><a href="#cb758-1" aria-hidden="true" tabindex="-1"></a><span class="ex">searchd</span> decode <span class="op">&lt;</span>dump<span class="op">&gt;</span></span>
<span id="cb758-2"><a href="#cb758-2" aria-hidden="true" tabindex="-1"></a><span class="ex">searchd</span> decode <span class="at">-</span></span></code></pre></div>
<p>Decodes SphinxAPI query dump (as seen in the dreaded crash reports in
the log), formats that query as SphinxQL, and exits.</p>
<p>You can either pass the entire base64-encoded dump as an argument
string, or have <code>searchd</code> read it from stdin using the
<code>searchd decode -</code> syntax.</p>
<p>Newlines are ignored. Whitespace is not (fails at the base64
decoder).</p>
<p>Examples!</p>
<pre><code>$ searchd decode &quot;ABCDEFGH&quot; -q
FATAL: decode failed: unsupported API command code 16, expected COMMAND_SEARCH

$ cat dump
AAABJAAAAQAAAAAgAAAAAQAAAAAAAAABAAAAAAAAABQAAAAAAAAAAAAAAAQA
AAANd2VpZ2h0KCkgZGVzYwAAAAAAAAAAAAAAA3J0MQAAAAEAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAQAAAAAAyAAAAAAAA1AZ3JvdXBieSBkZXNjAAAAAAAA
AAAAAAH0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEqAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAANd2VpZ2h0KCkgZGVzYwAAAAEAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//////////8A

$ cat dump | searchd decode - -q
SELECT * FROM rt1;</code></pre>
<h3 id="searchd-run-command"><code>searchd run</code> command</h3>
<p>Let’s list the common options just once again, as <code>run</code>
uses them, too.</p>
<table>
<thead>
<tr class="header">
<th>Option</th>
<th>Brief description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>--config</code>, <code>-c</code></td>
<td>specify a config file</td>
</tr>
<tr class="even">
<td><code>--datadir</code></td>
<td>specify a (non-default) datadir path</td>
</tr>
<tr class="odd">
<td><code>--quiet</code>, <code>-q</code></td>
<td>be quiet, skip banner etc</td>
</tr>
</tbody>
</table>
<p>The options specific to <code>run</code> command are as follows.</p>
<table>
<colgroup>
<col style="width: 27%" />
<col style="width: 72%" />
</colgroup>
<thead>
<tr class="header">
<th>Option</th>
<th>Brief description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>--coredump</code></td>
<td>enable system core dumps on crashes</td>
</tr>
<tr class="even">
<td><code>--cpustats</code></td>
<td>log per-query CPU stats</td>
</tr>
<tr class="odd">
<td><code>--dummy &lt;arg&gt;</code></td>
<td>ignored option (useful to mark different instances)</td>
</tr>
<tr class="even">
<td><code>--force-warmup</code></td>
<td>force index warmup before accepting connections</td>
</tr>
<tr class="odd">
<td><code>--iostats</code></td>
<td>log per-query IO stats</td>
</tr>
<tr class="even">
<td><code>--relaxed-replay</code></td>
<td>relaxed WAL replay, allow suspicious data</td>
</tr>
<tr class="odd">
<td><code>--safetrace</code></td>
<td>only use system <code>backtrace()</code> call in crash reports</td>
</tr>
<tr class="even">
<td><code>--strict-replay</code></td>
<td>strict WAL replay, fail on suspicious data</td>
</tr>
</tbody>
</table>
<p>Finally, the debugging options specific to <code>run</code> are as
follows.</p>
<table>
<colgroup>
<col style="width: 31%" />
<col style="width: 68%" />
</colgroup>
<thead>
<tr class="header">
<th>Option</th>
<th>Brief description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>--console</code></td>
<td>run in a special “console” mode</td>
</tr>
<tr class="even">
<td><code>--index</code>, <code>-i</code></td>
<td>only serve a single index, skip all others</td>
</tr>
<tr class="odd">
<td><code>--listen</code>, <code>-l</code></td>
<td>listen on a given address, port, or path</td>
</tr>
<tr class="even">
<td><code>--logdebug</code></td>
<td>enable debug logging</td>
</tr>
<tr class="odd">
<td><code>--logdebugv</code></td>
<td>enable verbose debug logging</td>
</tr>
<tr class="even">
<td><code>--logdebugvv</code></td>
<td>enable very verbose debug logging</td>
</tr>
<tr class="odd">
<td><code>--pidfile</code></td>
<td>use a given PID file</td>
</tr>
<tr class="even">
<td><code>--port</code>, <code>-p</code></td>
<td>listen on a given port</td>
</tr>
<tr class="odd">
<td><code>--show-all-warnings</code></td>
<td>show all (mappings) warnings, not just summaries</td>
</tr>
<tr class="even">
<td><code>--strip-path</code></td>
<td>strip any absolute paths stored in the indexes</td>
</tr>
</tbody>
</table>
<blockquote>
<p>WARNING! Using any of these debugging options on a regular basis in
regular workflows is definitely <strong>NOT</strong> recommended.
Extremely strongly. They are for one-off debugging sessions. They are
<strong>NOT</strong> for everyday use. (Ideally, not for any use ever,
even!)</p>
</blockquote>
<p>Let’s cover them all in a bit more detail.</p>
<h3 id="searchd-run-options"><code>searchd run</code> options</h3>
<h4
id="searchd-run---cpustats-option"><code>searchd run --cpustats</code>
option</h4>
<p><code>--cpustats</code> enables <code>searchd</code> to track and
report both per-query and server-wide CPU time statistics (in addition
to wall clock time ones). That may cause a small performance impact, so
they are disabled by default.</p>
<p>With <code>--cpustats</code> enabled, there will be extra global
counters in <code>SHOW STATUS</code> and per-query counters in
<code>SHOW META</code> output, and extra data in the slow queries log,
just as with <code>--iostats</code> option.</p>
<div class="sourceCode" id="cb760"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb760-1"><a href="#cb760-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show status <span class="kw">like</span> <span class="st">&#39;%cpu%&#39;</span>;</span>
<span id="cb760-2"><a href="#cb760-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+-------------+</span></span>
<span id="cb760-3"><a href="#cb760-3" aria-hidden="true" tabindex="-1"></a>| Counter       | <span class="fu">Value</span>       |</span>
<span id="cb760-4"><a href="#cb760-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+-------------+</span></span>
<span id="cb760-5"><a href="#cb760-5" aria-hidden="true" tabindex="-1"></a>| query_cpu     | <span class="fl">7514412.281</span> |</span>
<span id="cb760-6"><a href="#cb760-6" aria-hidden="true" tabindex="-1"></a>| avg_query_cpu | <span class="fl">0.011</span>       |</span>
<span id="cb760-7"><a href="#cb760-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">---------------+-------------+</span></span>
<span id="cb760-8"><a href="#cb760-8" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.015</span> sec)</span></code></pre></div>
<p><strong>The global counters are in seconds.</strong> Yes, in the
example above, an average query took only 0.011 sec of CPU time, but in
total <code>searchd</code> took 7.5 million CPU-seconds since last
restart (for 661 million queries served).</p>
<p><strong>The per-query counters are in milliseconds.</strong> A known
legacy quirk, but maybe we’ll fix it one day, after all.</p>
<div class="sourceCode" id="cb761"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb761-1"><a href="#cb761-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show meta <span class="kw">like</span> <span class="st">&#39;%time&#39;</span>;</span>
<span id="cb761-2"><a href="#cb761-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------+-------+</span></span>
<span id="cb761-3"><a href="#cb761-3" aria-hidden="true" tabindex="-1"></a>| Variable_name   | <span class="fu">Value</span> |</span>
<span id="cb761-4"><a href="#cb761-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------+-------+</span></span>
<span id="cb761-5"><a href="#cb761-5" aria-hidden="true" tabindex="-1"></a>| <span class="dt">time</span>            | <span class="fl">0.001</span> |</span>
<span id="cb761-6"><a href="#cb761-6" aria-hidden="true" tabindex="-1"></a>| cpu_time        | <span class="fl">2.208</span> |</span>
<span id="cb761-7"><a href="#cb761-7" aria-hidden="true" tabindex="-1"></a>| agents_cpu_time | <span class="fl">0.000</span> |</span>
<span id="cb761-8"><a href="#cb761-8" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------+-------+</span></span></code></pre></div>
<p>The query was pretty fast in this example. According to the wall
clock, it took 0.001 sec total. According to the CPU timer, it took 2.2
msec (or 0.0022 sec) of CPU time.</p>
<p><strong>The CPU time should usually be lower than the wall
time.</strong> Because the latter also includes all the various IO and
network wait times.</p>
<div class="sourceCode" id="cb762"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb762-1"><a href="#cb762-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> show status <span class="kw">like</span> <span class="st">&#39;query%&#39;</span>;</span>
<span id="cb762-2"><a href="#cb762-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------+--------------+</span></span>
<span id="cb762-3"><a href="#cb762-3" aria-hidden="true" tabindex="-1"></a>| Counter        | <span class="fu">Value</span>        |</span>
<span id="cb762-4"><a href="#cb762-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------+--------------+</span></span>
<span id="cb762-5"><a href="#cb762-5" aria-hidden="true" tabindex="-1"></a>| query_wall     | <span class="fl">12644718.036</span> |</span>
<span id="cb762-6"><a href="#cb762-6" aria-hidden="true" tabindex="-1"></a>| query_cpu      | <span class="fl">7517391.790</span>  |</span>
<span id="cb762-7"><a href="#cb762-7" aria-hidden="true" tabindex="-1"></a>| query_reads    | <span class="kw">OFF</span>          |</span>
<span id="cb762-8"><a href="#cb762-8" aria-hidden="true" tabindex="-1"></a>| query_readkb   | <span class="kw">OFF</span>          |</span>
<span id="cb762-9"><a href="#cb762-9" aria-hidden="true" tabindex="-1"></a>| query_readtime | <span class="kw">OFF</span>          |</span>
<span id="cb762-10"><a href="#cb762-10" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------+--------------+</span></span>
<span id="cb762-11"><a href="#cb762-11" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.018</span> sec)</span></code></pre></div>
<p>However, with multi-threaded query execution (with
<code>dist_threads</code>), CPU time can naturally be several times
<strong>higher</strong> than the wall time.</p>
<p>Also, the system calls that return wall and CPU times can be slightly
out of sync. That’s what actually happens in the previous example! That
2-msec query was very definitely <strong>not</strong> multi-threaded,
and yet, 0.001 sec wall time but 0.0022 sec CPU time was reported back
to Sphinx. Timers are fun.</p>
<h4 id="searchd-run---dummy-option"><code>searchd run --dummy</code>
option</h4>
<p><code>--dummy &lt;arg&gt;</code> option takes a single dummy argument
and completely ignores it. It’s useful when launching multiple
<code>searchd</code> instances, to enable telling them apart in the
process list.</p>
<h4
id="searchd-run---force-warmup-option"><code>searchd run --force-warmup</code>
option</h4>
<p><code>--force-warmup</code> postpones accepting connections until the
index warmup is done. Otherwise (by default), warmup happens in a
background thread. That way, queries start being serviced earlier, but
they can be slower until warmup completes.</p>
<h4 id="searchd-run---iostats-option"><code>searchd run --iostats</code>
option</h4>
<p><code>--iostats</code> enables <code>searchd</code> to track and
report both per-query and server-wide I/O statistics. That may cause a
small performance impact, so they are disabled by default.</p>
<p>With <code>--iostats</code> enabled, there will be extra global
counters in <code>SHOW STATUS</code> and per-query counters in
<code>SHOW META</code> output, as follows.</p>
<div class="sourceCode" id="cb763"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb763-1"><a href="#cb763-1" aria-hidden="true" tabindex="-1"></a>mysql<span class="op">&gt;</span> SHOW META <span class="kw">LIKE</span> <span class="st">&#39;io%&#39;</span>;</span>
<span id="cb763-2"><a href="#cb763-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------+---------+</span></span>
<span id="cb763-3"><a href="#cb763-3" aria-hidden="true" tabindex="-1"></a>| Variable_name   | <span class="fu">Value</span>   |</span>
<span id="cb763-4"><a href="#cb763-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------+---------+</span></span>
<span id="cb763-5"><a href="#cb763-5" aria-hidden="true" tabindex="-1"></a>| io_read_sec     | <span class="fl">0.004</span>   |</span>
<span id="cb763-6"><a href="#cb763-6" aria-hidden="true" tabindex="-1"></a>| io_read_ops     | <span class="dv">678</span>     |</span>
<span id="cb763-7"><a href="#cb763-7" aria-hidden="true" tabindex="-1"></a>| io_read_kbytes  | <span class="fl">22368.0</span> |</span>
<span id="cb763-8"><a href="#cb763-8" aria-hidden="true" tabindex="-1"></a>| io_write_sec    | <span class="fl">0.000</span>   |</span>
<span id="cb763-9"><a href="#cb763-9" aria-hidden="true" tabindex="-1"></a>| io_write_ops    | <span class="dv">0</span>       |</span>
<span id="cb763-10"><a href="#cb763-10" aria-hidden="true" tabindex="-1"></a>| io_write_kbytes | <span class="fl">0.0</span>     |</span>
<span id="cb763-11"><a href="#cb763-11" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------------+---------+</span></span>
<span id="cb763-12"><a href="#cb763-12" aria-hidden="true" tabindex="-1"></a><span class="dv">6</span> <span class="kw">rows</span> <span class="kw">in</span> <span class="kw">set</span> (<span class="fl">0.00</span> sec)</span></code></pre></div>
<p>Per-query stats will also appear in the slow queries log.</p>
<div class="sourceCode" id="cb764"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb764-1"><a href="#cb764-1" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>. <span class="kw">WHERE</span> MATCH(<span class="st">&#39;the i&#39;</span>) <span class="co">/* ios=678 kb=22368.0 ioms=4.5 */</span></span></code></pre></div>
<h4 id="searchd-run-wal-replay-options"><code>searchd run</code> WAL
replay options</h4>
<p><code>--relaxed-replay</code> and <code>--strict-replay</code>
options explicitly set strict or relaxed WAL replay mode. They control
how to handle “suspicious” WAL entries during post-crash replay and
recovery.</p>
<p>In <strong>strict mode</strong>, any suspiciously incosistent (but
still seemingly correct and recoverable!) WAL entry triggers a hard
error, <code>searchd</code> does not even try to apply such these
entries, and ceases to start.</p>
<p>In <strong>relaxed mode</strong>, <code>searchd</code> may warn about
these, but applies them anyway, and does its best to restart.</p>
<p>These <strong>recoverable</strong> WAL incosistencies currently
include unexpectedly descending transaction timestamps or IDs, and
missing WAL files. Note that broken transactions (ie. WAL entries with
checksum mismatches) must <strong>never</strong> get reapplied under any
circumstances, even in relaxed mode.</p>
<p>We currently default to strict mode.</p>
<h4
id="searchd-run---safetrace-option"><code>searchd run --safetrace</code>
option</h4>
<p><code>--safetrace</code> limits internal crash reporting to only
collecting stack traces using system <code>backtrace()</code> call.</p>
<p>That provides less post-mortem debugging information, but is slightly
“safer” in the following sense. Occasionally, other stack trace
collection techniques (that we do use by default) can completely freeze
a crashed <code>searchd</code> process, preventing automatic
restarts.</p>
<h3 id="searchd-run-debugging-options"><code>searchd run</code>
debugging options</h3>
<h4
id="searchd-run---console-debugging-option"><code>searchd run --console</code>
debugging option</h4>
<p><code>--console</code> forces <code>searchd</code> to run in a
special “console mode” for debugging convenience: without detaching into
background, with logging to terminal instead of log files, and a few
other differences compared to regular mode.</p>
<div class="sourceCode" id="cb765"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb765-1"><a href="#cb765-1" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb765-2"><a href="#cb765-2" aria-hidden="true" tabindex="-1"></a><span class="ex">searchd</span> <span class="at">--console</span></span></code></pre></div>
<h4
id="searchd-run---index-debugging-option"><code>searchd run --index</code>
debugging option</h4>
<p><code>--index &lt;index&gt;</code> (or <code>-i</code> for short)
forces <code>searchd</code> to serve just one specified index, and skip
all other configured indexes.</p>
<div class="sourceCode" id="cb766"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb766-1"><a href="#cb766-1" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb766-2"><a href="#cb766-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> searchd <span class="at">--index</span> myindex</span></code></pre></div>
<h4
id="searchd-run---listen-debugging-option"><code>searchd run --listen</code>
debugging option</h4>
<p><code>--listen &lt;listener&gt;</code> (or <code>-l</code> for short)
is similar to <code>--port</code>, but lets you specify the entire
listener definition (with IP addresses or UNIX paths).</p>
<p>The formal <code>&lt;listener&gt;</code> syntax is as follows.</p>
<div class="sourceCode" id="cb767"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb767-1"><a href="#cb767-1" aria-hidden="true" tabindex="-1"></a><span class="ex">listener</span> := <span class="er">(</span> <span class="ex">address</span> <span class="st">&quot;:&quot;</span> port <span class="kw">|</span> <span class="ex">port</span> <span class="kw">|</span> <span class="ex">path</span> <span class="kw">)</span> <span class="bu">[</span> <span class="st">&quot;:&quot;</span> protocol <span class="bu">]</span></span></code></pre></div>
<p>So it can be either a specific IP address and port combination; or
just a port; or an Unix-socket path. Also, we can choose the protocol to
use on that port.</p>
<p>For instance, the following makes <code>searchd</code> listen on a
given IP/port using MySQL protocol, and set VIP flag for sessions
connecting to that IP/port.</p>
<div class="sourceCode" id="cb768"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb768-1"><a href="#cb768-1" aria-hidden="true" tabindex="-1"></a><span class="ex">searchd</span> <span class="at">--listen</span> 10.0.0.17:7306:mysql,vip</span></code></pre></div>
<p>Unix socket path is recognized by a leading slash, so use absolute
paths.</p>
<div class="sourceCode" id="cb769"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb769-1"><a href="#cb769-1" aria-hidden="true" tabindex="-1"></a><span class="ex">searchd</span> <span class="at">--listen</span> /tmp/searchd.sock</span></code></pre></div>
<p>Known protocols are <code>sphinx</code> (Sphinx API protocol) and
<code>mysql</code> (MySQL protocol).</p>
<p>Multiple <code>--listen</code> switches are allowed. For example.</p>
<div class="sourceCode" id="cb770"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb770-1"><a href="#cb770-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> searchd <span class="at">-l</span> 127.0.0.1:1337 <span class="at">-l</span> 65069</span>
<span id="cb770-2"><a href="#cb770-2" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb770-3"><a href="#cb770-3" aria-hidden="true" tabindex="-1"></a><span class="ex">listening</span> on 127.0.0.1:1337</span>
<span id="cb770-4"><a href="#cb770-4" aria-hidden="true" tabindex="-1"></a><span class="ex">listening</span> on all interfaces, port=65069</span></code></pre></div>
<h4
id="searchd-run---logdebug-debugging-options"><code>searchd run --logdebug</code>
debugging options</h4>
<p><code>--logdebug</code>, <code>--logdebugv</code>, and
<code>--logdebugvv</code> options enable additional debug output in the
daemon log.</p>
<p>They differ by the logging verboseness level, where
<code>--logdebug</code> is the least talkative, and
<code>--logdebugvv</code> is the most verbose. These are options may
pollute the log a lot, and should <strong>not</strong> be kept enabled
at all times.</p>
<h4
id="searchd-run---nodetach-debugging-option"><code>searchd run --nodetach</code>
debugging option</h4>
<p><code>--nodetach</code> disables detaching into background.</p>
<h4
id="searchd-run---noqlog-debugging-option"><code>searchd run --noqlog</code>
debugging option</h4>
<p><code>--noqlog</code> disables logging (slow) queries into the
<code>query_log</code> file. It only works with <code>--console</code>
debugging mode.</p>
<h4
id="searchd-run---pidfile-debugging-option"><code>searchd run --pidfile</code>
debugging option</h4>
<p><code>--pidfile</code> forces <code>searchd</code> to store it
process ID to a given PID file, overriding any other debugging options
(such as <code>--console</code>).</p>
<div class="sourceCode" id="cb771"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb771-1"><a href="#cb771-1" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb771-2"><a href="#cb771-2" aria-hidden="true" tabindex="-1"></a><span class="ex">searchd</span> <span class="at">--console</span> <span class="at">--pidfile</span> /home/sphinx/searchd.pid</span></code></pre></div>
<h4
id="searchd-run---port-debugging-option"><code>searchd run --port</code>
debugging option</h4>
<p><code>--port &lt;number&gt;</code> (<code>-p</code> for short) tells
<code>searchd</code> to listen on a specific port (on all interfaces),
overriding the config file listener settings.</p>
<p>With <code>--port</code> switch <code>searchd</code> will listen on
all available network interfaces, so use <code>--listen</code> to
specify particular interface(s). Only one <code>--port</code> switch is
allowed.</p>
<p>The valid range is 1 to 65535, but keep in mind that ports numbered
1024 and below usually require a privileged (root) account.</p>
<div class="sourceCode" id="cb772"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb772-1"><a href="#cb772-1" aria-hidden="true" tabindex="-1"></a><span class="co"># example</span></span>
<span id="cb772-2"><a href="#cb772-2" aria-hidden="true" tabindex="-1"></a><span class="ex">searchd</span> <span class="at">--port</span> 1337</span></code></pre></div>
<h4
id="searchd-run---show-all-warnings-debugging-option"><code>searchd run --show-all-warnings</code>
debugging option</h4>
<p><code>--show-all-warnings</code> prints all (mappings-related)
warnings, unthrottled, instead of the shorter summary reports that are
printed by default.</p>
<p>To avoid flooding the logs with (literally)
<strong>thousands</strong> of messages on every single index reload
(ugh), we throttle certain types of warnings by default, and only print
summary reports for them. At the moment, all such warning types are
related to mappings. Here’s a sample summary.</p>
<div class="sourceCode" id="cb773"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb773-1"><a href="#cb773-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> searchd</span>
<span id="cb773-2"><a href="#cb773-2" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb773-3"><a href="#cb773-3" aria-hidden="true" tabindex="-1"></a><span class="ex">WARNING:</span> mappings: index <span class="st">&#39;lj&#39;</span>: all source tokens are stopwords</span>
<span id="cb773-4"><a href="#cb773-4" aria-hidden="true" tabindex="-1"></a> <span class="kw">(</span><span class="va">count</span><span class="op">=</span>2, <span class="va">file</span><span class="op">=</span><span class="st">&#39;./sphinxdata/extra/mappings.txt&#39;</span><span class="kw">);</span> <span class="ex">IGNORED</span></span></code></pre></div>
<p>This option lets us print individual raw warnings and offending
lines.</p>
<div class="sourceCode" id="cb774"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb774-1"><a href="#cb774-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> searchd <span class="at">--show-all-warnings</span></span>
<span id="cb774-2"><a href="#cb774-2" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb774-3"><a href="#cb774-3" aria-hidden="true" tabindex="-1"></a><span class="ex">WARNING:</span> index <span class="st">&#39;lj&#39;</span>: all source tokens are stopwords</span>
<span id="cb774-4"><a href="#cb774-4" aria-hidden="true" tabindex="-1"></a> <span class="kw">(</span><span class="va">mapping</span><span class="op">=</span><span class="st">&#39;the =&gt; a&#39;</span>, <span class="va">file</span><span class="op">=</span><span class="st">&#39;./sphinxdata/extra/mappings.txt&#39;</span><span class="kw">)</span><span class="bu">.</span> IGNORED.</span>
<span id="cb774-5"><a href="#cb774-5" aria-hidden="true" tabindex="-1"></a><span class="ex">WARNING:</span> index <span class="st">&#39;lj&#39;</span>: all source tokens are stopwords</span>
<span id="cb774-6"><a href="#cb774-6" aria-hidden="true" tabindex="-1"></a> <span class="kw">(</span><span class="va">mapping</span><span class="op">=</span><span class="st">&#39;i =&gt; a&#39;</span>, <span class="va">file</span><span class="op">=</span><span class="st">&#39;./sphinxdata/extra/mappings.txt&#39;</span><span class="kw">)</span><span class="bu">.</span> IGNORED.</span></code></pre></div>
<h2 id="changes-in-3.x">Changes in 3.x</h2>
<h3 id="version-3.9.1-18-dec-2025">Version 3.9.1, 18 dec 2025</h3>
<p>Major new features:</p>
<ul>
<li>added <a href="#using-replication">asynchronous RT index
replication</a> (and cloning)</li>
<li>added <a href="#using-universal-index">universal index</a> (indexing
all JSONs and more)</li>
</ul>
<p>New features:</p>
<ul>
<li>added <a href="#operations-altering-distributed-indexes">complete
distributed index management via SphinxQL</a></li>
<li>added persisting for distrubuted agents dynamically created via
<code>ALTER</code></li>
<li>added <a href="#clone-index-syntax"><code>CLONE INDEX</code></a> and
<code>CLONE</code> statements</li>
<li>added <a href="#agent-mirror-selection-strategies">SWRR (Static
Weighted Round Robin)</a> HA strategy</li>
<li>added <code>rt_mem_limit</code> support to <a
href="#alter-option-syntax"><code>ALTER OPTION</code></a> (yeah!)</li>
<li>added AVX512 support to HNSW, and <a
href="#use_avx512-variable"><code>use_avx512</code></a> setting</li>
<li>added <a
href="#fine-tuning-ann-searches"><code>ann_refine</code></a> HNSW
performance tuning option</li>
<li>added <a href="#select-grouping"><code>TDIGEST()</code></a>
aggregate to compute percentiles</li>
<li>added <a href="#searchd-cli-reference"><code>searchd</code> CLI with
subcommands</a></li>
<li>added <a href="#operations-user-auth">read/write user permissions
model</a> to auth</li>
<li>added <a href="#operations-user-auth">anonymous user support</a> to
auth</li>
<li>added <a href="#lock-user-syntax"><code>LOCK/UNLOCK USER</code></a>
statements</li>
<li>added <a href="#reload-users-syntax"><code>RELOAD USERS</code></a>
to reload <code>auth_users</code> on the fly</li>
<li>added <a href="#listen-directive"><code>noauth</code> and
<code>nolocalauth</code> listener flags</a> to enable unauthed access
exceptions</li>
<li>added auth statistics to <a
href="#show-status-syntax"><code>SHOW STATUS</code></a></li>
<li>added <a href="#like-and-ignore-clause"><code>IGNORE</code></a>
clause to most <code>SHOW</code> statements</li>
<li>added <code>agent_response_bytes</code> to <a
href="#show-meta-syntax"><code>SHOW META</code></a></li>
<li>added <a href="#ranking-trigrams-and-bpe-tokens">BPE (Byte Pair
Encoding) based ranking signals</a></li>
<li>added <a href="#fvec-function"><code>FVEC(json.key)</code></a>
support for integer vectors</li>
<li>added <a href="#vadd-function"><code>VADD()</code></a>,
<code>VMUL()</code>, <code>VSUB()</code>, and <code>VDIV()</code>
functions</li>
<li>added <a
href="#show-index-status-syntax"><code>SHOW INDEX STATUS</code></a>
counters for total and alive local rows</li>
<li>added <a
href="#show-index-segment-status-syntax"><code>SHOW INDEX SEGMENT STATUS</code></a></li>
</ul>
<p>Deprecations and removals:</p>
<ul>
<li>removed legacy <code>searchd --status</code> subcommand</li>
<li>removed legacy <code>searchd</code> Windows service mode</li>
<li>removed agent options support from
<code>ADD REMOTE MIRROR</code></li>
<li>banned unsupported <code>IN()</code> 1st argument types</li>
</ul>
<p>Changes and improvements:</p>
<ul>
<li>optimized <code>SELECT</code> in general (added match pooling)</li>
<li>optimized phrase search and <code>OR</code> operators in
<code>MATCH()</code></li>
<li>optimized queries with 2+ active attrindexes (added bitmask
intersects, etc)</li>
<li>optimized master-agent JSON traffic (now sending required partial
data only)</li>
<li>optimized <code>WHERE MATCH(...) AND id IN(...)</code></li>
<li>optimized <code>GROUP_CONCAT()</code></li>
<li>optimized string comparisons in the <code>WHERE</code> clause</li>
<li>enabled <code>COUNT(DISTINCT ...)</code> in the <code>HAVING</code>
clause</li>
<li>changed <code>ATTACH INDEX WITH TRUNCATE</code> to keep the source
index attrindexes</li>
<li>changed <code>COUNT(*)</code> to <code>BIGINT</code> to support
distributed indexes over 4B rows</li>
<li>improved <code>pretrained_index</code> to check the clusters for
being non-zero</li>
<li>improved <code>DROP TABLE</code> so now it drops the index from
distributed indexes too</li>
<li>improved (updated and extended) many warning and error messages</li>
<li>disabled morphology for blended tokens (outputs were fully
unpredictable)</li>
</ul>
<p>Major fixes:</p>
<ul>
<li>fixed that updates in disk segments with over 4 GB attrs could
corrupt data</li>
<li>fixed that HNSW index was not properly rebuilt during
<code>OPTIMIZE</code></li>
<li>fixed that <code>ann_top</code> was ignored on remote agents in
distributed searches</li>
<li>fixed that docstore could return wrong documents after
<code>searchd</code> restart</li>
<li>fixed that rotation ignored new distributed and dynamically created
indexes</li>
</ul>
<p>Fixes:</p>
<ul>
<li>fixed that <code>cutoff</code> could noticeably overshoot when
searching RT disk segments</li>
<li>fixed that conflicting expr alias could wrongly trigger an attrindex
read</li>
<li>fixed that distributed indexes could wrongly retry successful
connections</li>
<li>fixed that <code>agent_persistent</code> agents barely worked</li>
<li>fixed that <code>BIGINT(DOT(...))</code> cast did not work as
expected</li>
<li>fixed that <code>index_&lt;N&gt;_start</code> counter in
<code>SHOW OPTIMIZE STATUS</code> was broken</li>
<li>fixed that <code>searchd</code> (rarely) tried loading the wrong
vector indexes file</li>
<li>fixed that global IDF calculation for <code>=exact</code> query
terms was off</li>
<li>fixed a crash on <code>.csv</code> or <code>.tsv</code> files with
1000+ column headers</li>
<li>fixed a crash on some of the <code>GROUP BY mva</code> cases</li>
<li>fixed a crash on creating an index on a new column with other
indexes present</li>
<li>fixed a rare crash when using JSON attribute indexes vs
<code>IN()</code></li>
<li>fixed 3 rare crashes caused by very specific morphology settings
combinations</li>
<li>fixed a deadlock between <code>DROP TABLE</code> and local
distributed <code>SELECT</code></li>
<li>fixed a race when loading mappings and/or morphdict</li>
<li>fixed a few non-critical internal issues during shutdown</li>
</ul>
<h3 id="version-3.8.1-12-may-2025">Version 3.8.1, 12 may 2025</h3>
<p>Major new features:</p>
<ul>
<li>added <a href="#hnsw-indexes">Sphinx HNSW vector indexes</a>
support</li>
<li>added <a href="#sq-indexes">Sphinx SQ indexes</a> support</li>
<li>added <a href="#faiss_l1-indexes">FAISS L1 HNSW vector indexes</a>
support</li>
<li>added full vector index support in public builds too</li>
<li>added <a href="#sphinxql-vs-regular-sql">full <code>WHERE</code>
expressions support</a></li>
<li>added full support for <a href="#update-syntax">partial JSON
attribute updates</a></li>
<li>added automatic <code>UPDATE</code>-to-<code>REPLACE</code>
conversion during <code>OPTIMIZE</code></li>
<li>added secondary index reads merge support (for
<code>WHERE a=1 OR b=2</code> queries)</li>
<li>added <a href="#request-hedging">request hedging</a> support for
distributed searches</li>
</ul>
<p>New features:</p>
<ul>
<li>added <a href="#alter-remote-syntax"><code>ALTER REMOTE</code>
syntax</a> to manage distributed index agents dynamically</li>
<li>added <a href="#truncate-index-syntax"><code>TRUNCATE</code></a>
support for percolate indexes</li>
<li>added index manifests, and <code>SHOW MANIFEST</code> and
<code>FLUSH MANIFEST</code> statements</li>
<li>added <a
href="#create-index-syntax"><code>CREATE INDEX .. OPTION pretrained_index</code></a></li>
<li>added <a href="#replace-syntax"><code>REPLACE .. KEEP</code>
syntax</a> for individual JSON fields</li>
<li>added <a
href="#select-options"><code>SELECT .. OPTION threads</code></a> for
percolate indexes</li>
<li>added bitfields support to <a
href="#create-table-syntax"><code>CREATE TABLE</code></a></li>
<li>added <code>cutoff</code> limit to <a
href="#select-grouping"><code>GROUP_CONCAT()</code></a> aggregate</li>
<li>added <code>123l</code> and <code>int64[]</code> <a
href="#json-syntax-extensions">JSON syntax extensions</a></li>
<li>added <a
href="#operations-user-auth"><code>caching_sha2_password</code> MySQL 9
client support</a></li>
<li>added <a href="#udfs-that-return-arrays">UDF <code>FLOAT[N]</code>
array return type support</a></li>
<li>added <a
href="#sql_log_filter-variable"><code>sql_log_filter</code></a> to
filter SQL log stream</li>
<li>added JSON key targets support to <a
href="#binding-index-join-targets"><code>join_attrs</code></a></li>
<li>added <a href="#join-by-attribute"><code>join_by_attr</code></a>
support for non-id joins</li>
<li>added <a href="#join_cache-directive"><code>join_cache</code></a> to
only parse joined files once</li>
<li>added <a
href="#binlog_erase_delay_sec-directive"><code>binlog_erase_delay_sec</code></a>
directive</li>
<li>added <a href="#blackhole-directive"><code>blackhole</code></a>
directive to avoid query autokill</li>
<li>added <a
href="#blackhole_sample_div-directive"><code>blackhole_sample_div</code>
sampling</a></li>
<li>added <a href="#create_index-directive"><code>create_index</code>
directive</a> for RT indexes</li>
<li>added <a href="#required-directive"><code>required</code></a>
per-index option</li>
<li>added <a href="#bitwise-operators">bitwise shifts and XOR</a> to
expressions</li>
<li>added <code>array_attr[const]</code> element access syntax support
to expressions</li>
<li>added <code>BETWEEN</code> over numeric types to expressions</li>
<li>added missing <code>SELECT .. BETWEEN</code> expressions support for
distributed indexes</li>
<li>added support for <code>ANY/ALL</code> in intset comparisons
(including <code>BETWEEN</code>)</li>
<li>added <code>BITSxxx()</code> functions to support binary bitmaps
stored in JSON arrays (<a
href="#bitsget-function"><code>BITSGET()</code></a>, <a
href="#bitscountseq-function"><code>BITSCOUNTSEQ()</code></a>, <a
href="#bitscmpseq-function"><code>BITSCMPSEQ()</code></a>)</li>
<li>added several functions to manipulate vectors stored in JSON arrays
(<a href="#fvec-function"><code>FVECX()</code></a>, <a
href="#vsort-function"><code>VSORT()</code></a>, <a
href="#vslice-function"><code>VSLICE()</code></a>, <a
href="#vslice-function"><code>VSLICE()</code></a>, <a
href="#vsum-function"><code>VSUM()</code></a>)</li>
</ul>
<p>Deprecations and removals:</p>
<ul>
<li>removed previously deprecated <code>lemmatizer_base</code> and
<code>plugin_dir</code>directives</li>
<li>banned expressions with aggregates in <code>WHERE</code> clause
(must be <code>HAVING</code>)</li>
<li>banned mistakenly allowed aggregates (ie. <code>SUM()</code> etc) in
certain expressions</li>
<li>banned <code>ATTACH</code> during <code>OPTIMIZE</code> to avoid
extremely long locks</li>
<li>banned <code>indextool</code> vs RT indexes (as it should be)</li>
<li>banned meaningless crashing <code>FACTORS()</code> subscript access
vs empty queries (eg.
<code>select id, factors().bm15 from test</code>)</li>
</ul>
<p>Changes and improvements:</p>
<ul>
<li>changed expressions to <strong>clamp</strong>, not wrap out-of-range
<code>BIGINT</code> constants</li>
<li>fixed missing secondary JSON index updates on (some)
<code>UPDATE</code> queries</li>
<li>fixed that RAM segments could get mistakenly resaved on failed
binlog replays</li>
<li>added more <a href="#searchd-run-wal-replay-options">relaxed binlog
replay flags</a></li>
<li>added more <code>indexer build --profile</code> states, better
profiles now</li>
<li>added <a href="#udfs-overview">UDF <code>FLOAT_ARRAY</code> argument
support</a>, no more <code>FVEC()</code></li>
<li>added physical index type to <a
href="#show-index-from-syntax"><code>SHOW INDEX FROM</code></a></li>
<li>added <code>WHERE</code> checks on percolate index
<code>INSERT</code>, no more fails on <code>SELECT</code></li>
<li>added <code>ORDER BY id ASC</code> support to percolate queries</li>
<li>improved <code>MINGEODISTEX()</code> support, can use it in
subsequent expressions now</li>
<li>improved agent <code>connect()</code> timeout handling in
<code>searchd</code>, less stalls now</li>
<li>improved DocStore data safety by adding it to binlogs</li>
<li>optimized DocStore in RAM segments by enabling in-RAM compression
too</li>
<li>improved docs and messages (eg. redid <a
href="#getting-started">“Getting Started”</a>)</li>
<li>optimized <code>indexer build</code> performance (up to 15% on our
benchmarks, YMMV)</li>
<li>optimized <code>OPTIMIZE</code> by implementing N-way merge<br />
</li>
<li>optimized percolate index loads, made them multi-threaded</li>
<li>optimized <a href="#join_file-directive">XSV file joins</a>, made
them multi-threaded</li>
<li>throttled join sources to 100 warnings max</li>
<li>throttled <code>indexer</code> warnings and errors to 1000 messages
max</li>
</ul>
<p>Fixes:</p>
<ul>
<li>fixed <code>FLUSH INDEX</code> on percolate index not doing an
immediate flush (does now)</li>
<li>fixed missing <code>!=</code> operator support vs querying
distributed indexes</li>
<li>fixed a few cases of ignored JSON casts in <code>WHERE</code>
comparisons leading to incorrect results (eg.
<code>select id from rt uint(j.foo) &lt;= 2</code>)</li>
<li>fixed <code>join_ids</code> that mistakenly required absolute paths
(meh)</li>
<li>fixed <code>searchd.state</code> sync issues on
<code>CREATE/DROP TABLE</code> etc</li>
<li>fixed token lengths (<code>index_field_lengths</code>) not being
updated on <code>DELETE</code></li>
<li>fixed <code>indextool</code> mistakenly complaining about legal dead
varlen entries</li>
<li>fixed a potential crash and/or data corruption on (weirdly sized)
XSV joins</li>
<li>fixed empty reuse code that sometimes ignored valid empty files</li>
<li>fixed a crash when using both asterisk and
<code>WORDPAIRCTR()</code> in <code>SELECT</code></li>
<li>fixed <code>join_attrs</code> sometimes mistaking valid input files
for broken</li>
<li>fixed several issues causing phrase searches to return unexpected
matches</li>
<li>fixed several type casting issues</li>
<li>fixed occasionally failing scans with <code>WHERE</code> on segments
with more than 4 GB of fixed-width attribute data (haha classic)</li>
<li>fixed <code>global_avg_field_lengths</code> settings getting reset
after index rotation</li>
<li>fixed a crash on shutdown while waiting for stalled VIP
requests</li>
<li>fixed a crash on <code>UPDATE</code> or <code>DELETE</code> against
a disabled local index</li>
<li>fixed <code>indexed_documents</code> that was sometimes
double-decreased on <code>OPTIMIZE</code></li>
<li>fixed data source name as reported by
<code>indexer build dump --rows-sql</code></li>
<li>fixed a crash in query cache vs queries with an expression
filter</li>
<li>fixed a potential crash while doing parallel updates vs
attrindexes</li>
<li>fixed intset comparisons in expressions sometimes returning
incorrect results</li>
<li>fixed a crash when using <code>WEIGHT()</code> in <code>WHERE</code>
expression</li>
<li>fixed edge comparison cases in attrindex reads leading to incorrect
results (most importantly, when comparing against zero)</li>
<li>fixed a crash when mixing annotation and wildcard searches (banned
those)</li>
<li>fixed <code>FACTORS()</code> values sometimes being off on seemingly
identical data when using an <code>OR</code> operator</li>
<li>fixed a number of <code>cutoff</code> quirks (mostly,
<code>cutoff</code> not being strict enough)</li>
<li>fixed <code>DROP INDEX</code> binlog replay occasionally failing or
crashing</li>
<li>fixed <code>PESSIMIZE_RANK()</code> not working with
<code>FACET</code> queries</li>
<li>fixed <code>OPTIMIZE</code> issue that (very rarely) lost some
still-alive documents</li>
<li>fixed <code>maxed_out</code> metric in <code>SHOW STATUS</code></li>
<li>fixed FAISS index reads for vector indexes over 2 GB (haha
classic)</li>
<li>fixed <code>CREATE INDEX</code> vs vector indexes vs disk segments
with deleted rows</li>
<li>fixed a few crashes when using <code>AVG()</code> and
<code>GROUP_CONCAT()</code> on JSON fields</li>
<li>fixed a few <code>SNIPPET()</code> vs <code>stored_fields</code>
issues</li>
<li>fixed <code>indextool dumpdict</code> output vs
<code>index_exact_words</code></li>
<li>fixed an overflow when <code>agent_query_timeout</code> was too
high</li>
<li>fixed <code>ALTER .. ADD COLUMN varlen</code> breaking printing out
array attributes</li>
<li>fixed (almost unused) <code>binlog_flush=1</code> mode that failed
to make writes/syncs</li>
<li>fixed a number of network-related issues during shutdown</li>
<li>fixed <code>updates_pool</code> size setting being sometimes
ignored</li>
<li>fixed <code>ALTER</code> adding first varlen column could lead to a
crash loop</li>
<li>fixed <code>REPLACE KEEP</code> vs missing or empty JSON column
values</li>
<li>fixed a crash caused by failed agent validation</li>
<li>fixed wrong TID ranges in binlogs after hard restart in some
cases</li>
<li>fixed plain index <code>docstore</code> settings being lost after
reloads or restarts</li>
<li>fixed <code>sampling</code> vs disk segments sometimes being applied
incorrectly</li>
<li>fixed DocStore vs duplicate IDs within a single
<code>INSERT</code></li>
<li>fixed an extremely rare crash when using
<code>lax_agent_errors</code></li>
<li>fixed incorrect results on stopwords-plus-negations full-text
queries (eg. <code>WHERE MATCH('stopword -one -two -three')</code>)</li>
<li>fixed a few issues when <code>index_exact_words</code> caused
incorrect search results (on specifically structured full-text
queries)</li>
<li>fixed <code>indexer</code> fails vs csv/tsvpipe sources vs table
header only</li>
<li>fixed intsets vs single-value <code>WHERE IN</code> clauses (eg.
<code>WHERE tags IN(123)</code>)</li>
<li>fixed grouping by JSON arrays, now groups by their elements (as
designed)</li>
<li>fixed <code>indexer</code> crash vs csv/tsvpipe source failing with
an error</li>
<li>fixed an extremely rare invalid result vs specific
<code>ORDER/GROUP BY</code> clauses</li>
<li>fixed a crash if casting an intset alias to an unsupported type (eg.
<code>UINT</code>)</li>
<li>fixed CSV parser vs newlines, empty lines are now allowed</li>
<li>fixed overflows vs <code>EXIST()</code> on a <code>BIGINT</code>
column (eg. <code>EXIST('id', 1.23)</code>)</li>
<li>fixed a rare issue when flush could end up damaging binlogs</li>
<li>fixed <code>ATTACH WITH TRUNCATE</code> to a target RT index without
stored fields configured mistakenly losing source stored fields</li>
<li>fixed a number of other leaks, crashes, deadlocks, races, etc (the
usual)</li>
</ul>
<h3 id="version-3.7.1-28-mar-2024">Version 3.7.1, 28 mar 2024</h3>
<p>Major new features:</p>
<ul>
<li>added <a href="#searching-percolate-queries">percolate queries and
indexes</a> support</li>
<li>added <a href="#json_float-directive"><code>json_float</code></a>
directive to set the default JSON float format, and switched to 32-bit
float by default</li>
<li>added <a href="#indexer-cli-reference">new <code>indexer</code>
CLI</a> with proper subcommands</li>
<li>added <a href="#indexing-join-sources">indexer-side joins</a>
support, <code>indexer</code> can now join numeric and array columns
from CSV, TSV, and binary files</li>
</ul>
<p>New features:</p>
<ul>
<li>added <code>KEEP</code> clause support to <a
href="#replace-syntax"><code>REPLACE</code></a></li>
<li>added <a href="#l1dist-function"><code>L1DIST()</code> function</a>
that computes an L1 distance (aka Manhattan or grid distance) between
two vectors</li>
<li>added <a href="#mingeodistex-function"><code>MINGEODISTEX()</code>
function</a> variant that also returns the nearest point’s index</li>
<li>added base64-encoded <code>INT8_ARRAY</code> support to
<code>UPDATE</code> statements too, see <a
href="#using-array-attributes">“Using array attributes”</a></li>
<li>added <a href="#using-json"><code>double[]</code> JSON syntax
extension</a> for 64-bit float arrays</li>
<li>added <a
href="#pessimize_rank-table-function"><code>PESSIMIZE_RANK()</code></a>
table function</li>
<li>added <code>LIMIT</code> clause support to <a
href="#using-table-functions">table functions</a></li>
<li>added optional <code>IF EXISTS</code> clause to <a
href="#drop-table-syntax"><code>DROP TABLE</code></a></li>
<li>added per-query <a
href="#select-options"><code>OPTION expansion_limit</code></a></li>
<li>added missing <code>G</code> (giga) suffix support in some
query/index options</li>
</ul>
<p>Deprecations and removals:</p>
<ul>
<li>removed <code>json_packed_keys</code> directive (deprecated since
early 2023)</li>
<li>banned <code>FACET</code> in subselects, unpredictable (and kinda
meaningless) behavior</li>
<li>banned <code>FACTORS()</code> use in <code>WHERE</code> clause (for
now) to hotfix crashes</li>
<li>deprecated legacy indexer CLI, <a href="#indexer-cli-reference">use
commands!</a></li>
</ul>
<p>Changes and improvements:</p>
<ul>
<li>improved JSON to default to 32-bit floats, this saves both storage
and CPU</li>
<li>improved <code>indexer build --dump-tsv-rows</code> to emit new
<code>attr_xxx</code> directives</li>
<li>improved <code>create_index</code> syntax and distributed agents
syntax checks in <code>indextool checkconfig</code></li>
<li>improved <code>expansion_limit</code> to be properly index-wide, not
per-segment (ugh)</li>
<li>improved vector indexes to better detect “too narrow”
<code>WHERE</code> conditions, and auto-disengage (otherwise some
queries with those would occasionally return partial results)</li>
<li>optimized vector indexes to auto-engage earlier (specifically,
fine-tuned the respective costs in query optimizer)</li>
</ul>
<p>Fixes:</p>
<ul>
<li>fixed a crash on creating an attribute index on an empty disk
segment</li>
<li>fixed a crash on flushing RT segments with zero alive rows</li>
<li>fixed a (rare) crash on saving <code>MULTIGEO</code> and maybe other
attrindexes</li>
<li>fixed a number of (rare) crashes with prefix searches</li>
<li>fixed a bug in multi-row updates WAL replay</li>
<li>fixed a number of int32 overflow related bugs vs “big enough”
indexes</li>
<li>fixed that some types of RAM segment loading issues were not
reported</li>
<li>fixed that wildcard searches (eg. <code>*foo*</code>) failed in
certain corner cases</li>
<li>fixed keyword expansions in <code>SHOW PLAN</code> (made them
properly expanded)</li>
<li>fixed a performance issue with (wrongly) duplicated AST keywords in
RT under certain conditions</li>
<li>fixed a few highlighting issues in <code>SNIPPETS()</code></li>
<li>fixed query parsing errors on certain valid queries (with some very
specific <code>mappings</code> combinations, and phrase operators)</li>
<li>fixed <code>agent_retry_count</code> behavior where 1 actually mean
0 retries (oops)</li>
<li>fixed <code>searchd.pid</code> file handling that would sometimes
break <code>searchd --stop</code></li>
<li>fixed spurious post-ATTACH warnings</li>
<li>fixed spurious <code>searchd.log</code> errors caused by
<code>CREATE INDEX</code> WAL entries</li>
<li>fixed and improved a number of other warning and error messages</li>
</ul>
<h3 id="version-3.6.1-04-oct-2023">Version 3.6.1, 04 oct 2023</h3>
<p>Major new features:</p>
<ul>
<li>added <a href="#multigeo-support">multigeo support</a>, ie. multiple
2D geopoints per document, <code>MINGEODIST()</code> and
<code>CONTAINSANY()</code> query functions, and special
<code>MULTIGEO()</code> attribute indexes that can speed up
<code>MINGEODIST()</code> queries</li>
<li>added unified <a href="#using-index-schemas"><code>attr_xxx</code>
syntax</a> to declare field and attributes at index level (and <a
href="#sql_query_set-directive"><code>sql_query_set</code></a> and <a
href="#sql_query_set_range-directive"><code>sql_query_set_range</code></a>
source directives that must now be used for “external” MVAs)</li>
<li>added initial <a href="#operations-user-auth">user
authentication</a> support</li>
<li>added <a href="#searching-vector-indexes">ANN vector index
support</a> support (for now, in private builds only)</li>
</ul>
<p>New features:</p>
<ul>
<li>added (semi-debugging) <code>indextool dumpjsonkeys</code>
command</li>
<li>added support for most of the index settings and for array
attributes to <a
href="#create-table-syntax"><code>CREATE TABLE</code></a></li>
<li>added distributed indexes support to <a
href="#call-keywords-syntax"><code>CALL KEYWORDS</code></a></li>
<li>added <a href="#index-sampling">runtime index sampling</a> with
<code>sample_div</code> and <code>sample_min</code> query options</li>
<li>added <a href="#using-array-attributes">base64 format support</a>
for incoming <code>INT8_ARRAY</code> values</li>
<li>added <a href="#searchd-decode-command">API crash dump query
decoder</a> to <code>searchd</code></li>
<li>added <a href="#ha_weight-variable">weighted round-robin
strategy</a> for HA agents</li>
<li>added most document-level signals to <a
href="#factors-function"><code>FACTORS().xxx</code></a> subscript syntax
variant</li>
<li>added <a href="#meta_slug-directive"><code>meta_slug</code></a> and
<code>SHOW META</code> slug output</li>
<li>added <a
href="#global_avg_field_lengths-directive"><code>global_avg_field_lengths</code></a>
directive to set static average field lengths for BM25, see <a
href="#ranking-field-lengths">“Ranking: field lengths”</a> for
details</li>
</ul>
<p>Deprecations and removals:</p>
<ul>
<li>removed legacy per-segment <code>SHOW INDEX SETTINGS</code>
syntax</li>
<li>removed legacy (and misleading!) <code>bm25</code> and
<code>proximity_bm25</code> ranker names (use proper <code>bm15</code>
and <code>proximity_bm15</code> names instead)</li>
</ul>
<p>Changes and improvements:</p>
<ul>
<li>improved <code>indextool</code> command syntax and built-in
help</li>
<li>improved <code>SHOW THREADS</code> output (now prioritizing comments
when truncating queries to fit in the width), and removed the internal
width limits</li>
<li>improved <a href="#searching-distributed-query-errors">distributed
error handling</a> and made it more strict by default (ie.
<code>OPTION lax_agent_errors=1</code>); individual component (index or
agent) errors now fail the entire query</li>
<li>improved query optimizer vs unindexed numeric columns, we now
maintain histograms even on unindexed columns for the optimizer to
use</li>
<li>improved <code>INSERT</code> type compatibility checks</li>
<li>improved slow <code>INSERT</code> and <code>REPLACE</code> logging,
added CPU time stats</li>
<li>improved batched select handling, <code>SHOW META</code> is now only
allowed at the very end of the batch (it only ever worked at that
location anyway)</li>
<li>improved slow log output, multi-line queries should now be
folded</li>
<li>updated <code>indextool</code> to support datadir, and fixed a
number of issues there too</li>
<li>optimized <code>GROUP BY</code> finalization pass (helps heavy final
UDFs)</li>
<li>optimized RT disk segments matches finalization pass (helps heavy
final UDFs)</li>
<li>optimized RT segment traversal to RAM-then-disk (helps early-out
searches)</li>
</ul>
<p>Fixes:</p>
<ul>
<li>fixed that <code>SHOW CREATE TABLE</code> misreported simple fields
as <code>field_string</code></li>
<li>fixed a crash caused by mixing <code>GROUP_COUNT</code> vs facets
(or multiqueries)</li>
<li>fixed that JSON column updates with an invalid value (such as
malformed JSON) incorrectly wiped the value instead of failing the
update</li>
<li>fixed that <code>json.key BETWEEN</code> clause failed to parse
negative numbers</li>
<li>fixed “out of sync” SphinxQL client errors vs maxed out
<code>thread_pool</code> server</li>
<li>fixed a rare crash in query parser caused by certain specific
multi-mappings within a phrase operator</li>
<li>fixed that binlog entries could rarely get reordered and prevent
replay</li>
<li>fixed spurious “missing from VFS” errors (caused by empty filename
lookups)</li>
<li>fixed that distributed <code>SELECT</code> queries with a composite
<code>GROUP BY</code> key ignored key parts that originated from
JSON</li>
<li>fixed a crash caused by <code>global_idf</code> vs empty file
paths</li>
<li>fixed a number of data races and halted jobs in distributed
<code>SELECT</code> queries</li>
<li>fixed retry count amplification when using
<code>agent_retry_count</code> and mirrors</li>
<li>fixed <code>id</code> checks in <code>INSERT</code>, and enabled
zero docids via <code>INSERT</code></li>
<li>fixed a rare division-by-zero crash (in one of the
<code>thread_wait</code> metrics)</li>
<li>fixed <code>indexer --rotate</code> vs datadir mode</li>
<li>fixed spurious exceptions warning caused by missing metadata on
<code>ATTACH</code></li>
<li>fixed incorrectly inverted checks in JSON fields comparisons
operators</li>
<li>fixed a possible infinite loop in query parser under certain rare
occasions</li>
<li>fixed subselect sort limits handling differences between local vs
distributed nested <code>SELECT</code> queries</li>
<li>fixed a possible crash on (illegal) empty “agent =” config
directive</li>
<li>fixed incorrect error messages for some of the deprecated config
keys</li>
<li>fixed a crash in (illegal) <code>FLUSH RAMCHUNK</code> or
<code>FLUSH RTINDEX</code> on plain index</li>
<li>fixed a possible deadlock on kbatch vs greedy index reload</li>
<li>fixed a rare crash on extremely long phrases in
<code>MATCH()</code></li>
</ul>
<h3 id="version-3.5.1-02-feb-2023">Version 3.5.1, 02 feb 2023</h3>
<p>Major new features:</p>
<ul>
<li>added <a href="#udf-call-batching">UDF call batching</a> support for
no-text queries without the <code>MATCH()</code> clause</li>
<li>added array attributes support to <code>UPDATE</code> statement</li>
<li>added <a href="#using-datadir">datadir support</a></li>
<li>added <a href="#using-annotations">annotations support</a></li>
<li>added <a href="#ranking-tokhashes-and-wordpair_ctr">token hashes
indexing</a>, also see <code>index_tokhash_fields</code> directive</li>
<li>added <a
href="#ranking-tokhashes-and-wordpair_ctr"><code>wordpair_ctr</code>
ranking signal</a> based on token hashes, and the respective
<code>WORDPAIRCTR()</code> function</li>
<li>added <a href="#ranking-clickstats">clickstat ranking
signals</a></li>
<li>added <a href="#ranking-token-classes">token class ranking
signals</a></li>
<li>added <a href="#group_count-function"><code>GROUP_COUNT()</code>
function</a> that quickly computes per-group counts without doing full
actual <code>GROUP BY</code></li>
<li>added <a href="#using-blob-attributes"><code>BLOB</code> attribute
type</a></li>
<li>added <a href="#operations-binlogs">per-index binlogs</a>, and made
(multi-index) binlog replay multi-threaded, using up to 8 threads</li>
<li>added <a href="#searching-memory-budgets">simpler sorting and
grouping RAM budgets</a>, added <code>sort_mem</code> option in
<code>SELECT</code> (and rewritten <code>ORDER BY</code>,
<code>FACET</code> and <code>GROUP BY</code> internally to support all
that)</li>
<li>added attribute indexes support to “plain” full-text indexes: added
<a href="#create_index-directive"><code>create_index</code>
directive</a>, and enabled <code>EXPLAIN</code> and
<code>CREATE INDEX</code> statements to support plain indexes</li>
<li>added <a
href="#xfactors"><code>FACTORS('alternate ranking terms')</code>
support</a> ie. an option to compute <code>FACTORS()</code> over an
arbitrary text query, even for non-text queries</li>
<li>added <a href="#update-syntax"><code>UPDATE INPLACE</code></a>
support for in-place JSON updates; added <a
href="#bulk-update-syntax"><code>BULK UPDATE INPLACE</code></a> syntax
too</li>
</ul>
<p>New features:</p>
<ul>
<li>added <code>INSERT</code> and <code>REPLACE</code> statement logging
to (slow) <a href="#operations-query-logs">query log</a></li>
<li>added <code>LIKE</code> clause to <a
href="#show-profile-syntax"><code>SHOW PROFILE</code></a> statement</li>
<li>added <a href="#udf-library-initialization">optional xxx_libinit UDF
call</a>, and <code>plugin_libinit_arg</code> directive</li>
<li>added <code>--ask-password</code> and <code>--password</code>
switches to <code>indexer</code></li>
<li>added <code>FACTORS().xxx.yyy</code> syntax support</li>
<li>added <a href="#operations-dumping-data">initial
<code>mysqldump</code> support</a>, including initial
<code>SHOW CREATE TABLE</code> etc statements support</li>
<li>added distributed profiling to <code>SHOW PROFILE</code></li>
<li>added <code>cpu_stats</code> support to <code>SET</code></li>
<li>added initial <a href="https://www.jetbrains.com/datagrip/">DataGrip
IDE</a> support</li>
<li>added <a
href="#intersect_len-function"><code>INTERSECT_LEN()</code></a>
function</li>
<li>added <code>BIGINT_SET()</code> type helper, currently used in
<code>INTERSECT_LEN()</code> only</li>
<li>added <a
href="#select-uservar-syntax"><code>SELECT @uservar</code></a>
support</li>
<li>added both global and per-index warning counters</li>
<li>added top-level array type support to JSON parser</li>
</ul>
<p>Deprecations and removals:</p>
<ul>
<li>deprecated <code>query_log_format</code> config directive (remove it
from the configs; legacy <code>plain</code> format is now scheduled for
removal)</li>
<li>deprecated <code>json_packed_keys</code> config directive (remove it
from the configs; JSON key packing is now scheduled for removal)</li>
<li>deprecated <code>PACKEDFACTORS()</code> function alias (use
<code>FACTORS()</code> now)</li>
<li>deprecated <code>max_matches</code> option (use <code>LIMIT</code>
now)</li>
<li>removed buggy mixing of full JSON updates vs partial, inplace JSON
updates from <code>UPDATE</code> explicitly (that never worked
anyway)</li>
<li>removed <code>RECONFIGURE</code> option from
<code>ALTER RTINDEX ftindex</code></li>
<li>removed legacy <code>wordforms</code> compatibility code (use
<code>mappings</code> now)</li>
<li>removed legacy <code>RANKFACTORS()</code> function and
<code>ranker=export()</code> option (use <code>FACTORS()</code> and
<code>ranker=expr</code> now)</li>
<li>removed buggy <code>BULK UPDATE</code> over JSON fields with string
values</li>
</ul>
<p>Changes and improvements:</p>
<ul>
<li>changed <code>query_log_format</code> (now deprecated) and
<code>query_log_min_msec</code> defaults, to new SphinxQL format and
saner 1000 msec respectively (was plain and 0, duh)</li>
<li>changed how <code>indexer</code> handles explicitly specified
attributes missing from <code>sql_query</code> result, this is now a
hard error (was a warning)</li>
<li>changed <code>bm15</code> signal type from int to float</li>
<li>changed (increased) minimum possible thread stack size to 128K</li>
<li>changed JSON float and double formatting to Sphinx
implementation</li>
<li>changed builds to always bundle jemalloc</li>
<li>optimized DocStore vs <code>OPTIMIZE</code>, now avoiding redundant
recompression</li>
<li>optimized a special “frequent zone vs rare matches” case</li>
<li>optimized indexing a little (getting 2-5% faster on our
benchmarks)</li>
<li>added missing <code>rank_fields</code> support to distributed
indexes</li>
<li>added a few missing query options to SQL parser and logger</li>
<li>added <code>thread_wait_xxx</code> metrics to
<code>SHOW STATUS</code></li>
<li>added a few more server variables support to dynamic
<code>SET GLOBAL</code></li>
<li>added <code>searchd</code> autorestart on contiguous
<code>accept()</code> failure, to autoheal on occasional file descriptor
leaks</li>
<li>added “compiled features” report to <code>-v</code> switch in
<code>indexer</code> and <code>searchd</code></li>
<li>added float column vs integer set support to <code>WHERE</code>, ie.
<code>WHERE f IN (3,15)</code></li>
<li>added checks for illegal less-or-equal-than-zero <code>LIMIT</code>
values</li>
<li>added simple conflicts checks for <code>charset_table</code></li>
<li>added <code>LIKE</code> clause to
<code>SHOW INTERNAL STATUS</code></li>
<li>added missing float/int8 support in arithmetic ops over JSON</li>
<li>improved <code>updates_pool</code> checks, enforcing 64K..128M range
now</li>
<li>improved <code>stopwords</code> directive syntax, multiple
directives, per-line entries, and wildcards are now supported</li>
<li>improved <code>SHOW THREADS</code> and enabled arbitrary high
<code>OPTION columns = &lt;width&gt;</code></li>
<li>improved log deduping, dupes now only flush every 1 second
(previously they also flushed every 100 dupes, which is not enough under
extreme flooding)</li>
<li>improved <code>FACTORS()</code> and <code>BM25F()</code>, made them
autoswitch to expression ranker</li>
<li>improved the “default” aggregate values precision;
<code>GROUP BY</code> queries that fit into the (much higher) default
memory budget must now be completely precise</li>
<li>improved <code>[BULK] UPDATE</code> values and conversions checks,
more strict now (eg. removed error-prone int-vs-float autoconversions in
<code>BULK</code> version)</li>
<li>improved <code>[BULK] UPDATE</code> error reporting, more verbose
now</li>
</ul>
<p>Fixes:</p>
<ul>
<li>fixed that <code>BM25F()</code> parsed integer arguments incorrectly
(expected floats!)</li>
<li>fixed that <code>NULL</code> strings/blobs were changed to empty in
distributed indexes</li>
<li>fixed several rare <code>ORDER BY</code> issues (namely: issues when
attempting to sort on fancier JSON key types such as string arrays; rare
false lookup failures on actually present but “unluckily” named JSON
keys; mistakenly reverting to default order sometimes when doing a
distributed nested select)</li>
<li>fixed a possible division by zero in siege mode</li>
<li>fixed <code>SHOW META</code> vs facet queries</li>
<li>fixed <code>ORDER BY RAND()</code> vs distributed indexes</li>
<li>fixed <code>FACET json.key</code> vs distributed indexes</li>
<li>fixed that individual rows could go missing in certain full-text vs
attribute index search edge cases (off-by-one rowset hints skipping an
extra row)</li>
<li>fixed distributed indexes (and SphinxAPI) vs semi-numeric JSON keys,
such as <code>jsoncol.2022_11</code></li>
<li>fixed <code>rt_flush_period</code> default value and allowed range
to be saner (we now default to flushing every 600 sec, and allow periods
from 10 sec to 1 hour)</li>
<li>fixed a race in docstore that sometimes resulted in missing
documents</li>
<li>fixed that <code>phrase_decayXX</code> signals sometimes yielded NaN
or wrong values</li>
<li>fixed rare <code>searchd</code> deadlocks on rename failures during
rotate/RELOAD, and on a few other kinds of fatal errors</li>
<li>fixed that <code>WHERE json.field BETWEEN const1 AND const2</code>
clause was wrongly forcing numeric conversion</li>
<li>fixed short <code>CREATE INDEX ON</code> statement form vs JSON
columns</li>
<li>fixed broken periodic binlog flushes (they could stop
“forever”)</li>
<li>fixed occasional deadlocks in <code>OPTIMIZE</code></li>
<li>fixed two <code>GEODIST()</code> issues (bad option syntax was not
reported; out of range latitudes sometimes produced wrong
distances)</li>
<li>fixed a few memory leaks (all estimated as small)</li>
<li>fixed a performance issue that huge outliers disengaged attribute
indexes (rewritten the indexed values histograms calculations for
that)</li>
<li>fixed a few messages here and there (errors on <code>--rotate</code>
in <code>indexer</code>, <code>SHOW OPTIMIZE STATUS</code> wording,
etc)</li>
<li>fixed that <code>RELOAD PLUGINS</code> sometimes caused
still-dangling UDF pointers</li>
<li>fixed that file-related issues on index rotation were
misreported</li>
<li>fixed that <code>ATTACH</code> erroneously changed the target RT
index schema for empty targets even when <code>TRUNCATE</code> option
was not specified</li>
<li>fixed occasional range querying issues vs Postgres sources in
<code>indexer</code></li>
<li>fixed that <code>exact_hit</code> and <code>exact_field_hit</code>
signals were sometimes a bit off (in a fringe case with phrase queries
vs mixed codes)</li>
<li>fixed that numeric casts with <code>COALESCE</code> could be
off</li>
<li>fixed invalid hit sorting (resulting in broken indexes and potential
crashes) in some rare mappings-related cases</li>
<li>fixed that (network) autokill did not remove enqueued jobs waiting
on threads</li>
<li>fixed missing error checks on certain attribute index insertion
errors</li>
<li>fixed that disk segment warnings on <code>UPDATE</code> were logged
to stdout only (promoted them to errors)</li>
<li>fixed expression evaluation vs outer <code>ORDER BY</code> vs
distributed index issues</li>
<li>fixed that <code>OPTIMIZE</code> could sometimes lose attribute
indexes</li>
<li>fixed 20+ crashes and major bugs in various rare/complicated edge
cases</li>
</ul>
<h3 id="version-3.4.1-09-jul-2021">Version 3.4.1, 09 jul 2021</h3>
<p>New features:</p>
<ul>
<li>completely refactored our text processing pipeline (morphology etc),
added <a href="#using-mappings"><code>mappings</code></a> and <a
href="#using-morphdict"><code>morphdict</code></a> directives that
replace now-deprecated <code>wordforms</code></li>
<li>added 2 new <a href="#phrase_decay10">phrase decay based</a> based
ranking signals</li>
<li>added 6 new <a href="#ranking-trigrams-and-bpe-tokens">trigram
based</a> ranking signals, and indexing time Bloom filters that enable
those</li>
<li>added <a href="#using-attribute-indexes">attribute index support for
MVA columns</a></li>
<li>added query auto-kill on client disconnect (only in
<code>thread_pool</code> mode), see the <a
href="#client-disconnects">network internals</a> section</li>
<li>added fixed-size arrays support to <a
href="#dot-function"><code>DOT()</code> function</a></li>
<li>added <a
href="#show-index-from-syntax"><code>SHOW INDEX FROM</code></a>
statement to examine attribute indexes</li>
<li>added support for <code>BETWEEN</code> as in
<code>(expr BETWEEN &lt;min&gt; AND &lt;max&gt;)</code> syntax to <a
href="#select-syntax"><code>SELECT</code></a></li>
<li>added <a
href="#show-status-syntax"><code>SHOW INTERNAL STATUS</code></a> mode to
<code>SHOW STATUS</code> statement to observe any experimental,
not-yet-official internal counters</li>
<li>added <code>killed_queries</code> and <code>local_XXX</code>
counters (such as <code>local_disk_mb</code>, <code>local_docs</code>,
etc) to <a href="#show-status-syntax"><code>SHOW STATUS</code></a>
statement.</li>
<li>added <code>--profile</code> switch to <code>indexer</code>
(initially for SQL data sources only)</li>
</ul>
<p>Deprecations:</p>
<ul>
<li>deprecated <code>wordforms</code> directive, see <a
href="#using-mappings"><code>mappings</code></a></li>
<li>deprecated <code>INT</code> and <code>INTEGER</code> types in
SphinxQL, use <code>UINT</code> instead</li>
<li>deprecated <code>OPTION idf</code>, <a
href="#how-sphinx-computes-idf">IDFs are now unified</a></li>
<li>removed legacy <code>FACTORS()</code> output format, always using
JSON now</li>
<li>removed support for embedded stopwords hashes (deprecated since
v.3.2), indexes with those will now fail to load</li>
</ul>
<p>Changes and improvements:</p>
<ul>
<li>changed <a href="#how-sphinx-computes-idf">IDFs to use unified
unscaled range</a>, so now they are (basically) computed as
<code>idf = min(log(N/n), 20.0)</code></li>
<li>added UDF versioning, <code>searchd</code> now also attempts loading
<code>myudf.so.VER</code> if <code>myudf.so</code> fails (this helps
manage UDF API version mismatches)</li>
<li>added automatic <code>ranker=none</code> when <code>WEIGHT()</code>
is not used, to skip ranking and improve performance (note that this
does not affect SphinxQL queries at all, but some legacy SphinxAPI
queries might need slight changes)</li>
<li>improved double value formatting, mostly in SphinxQL and/or JSON
output</li>
<li>improved multi-index searches, all local indexes must be unique now,
and a few locking issues were fixed</li>
<li>improved that siege mode now computes per-local-shard limits more
precisely</li>
<li>increased <a href="#using-mappings"><code>mappings</code></a> line
size limit from ~750 bytes to 32K</li>
<li>optimized queries vs indexes with many static attributes, 1.15x
faster on 250-column synthetic test, 3-5% savings in our prod</li>
<li>optimized <code>atc</code> signal (up to 3.2x faster in extreme
stops-only test case)</li>
<li>optimized <code>ZONE</code> searches (up to 3x faster on average,
50x+ in extreme cases)</li>
<li>optimized indexing about 3-5% with a few small internal
optimizations</li>
<li>disabled query cache by default</li>
<li>disabled arithmetic and other inapplicable operations over array
attributes</li>
</ul>
<p>Fixes:</p>
<ul>
<li>fixed overlong (40+ chars) tokens handling in phrases and similar
operators</li>
<li>fixed error handling for UDFs that return <code>STRING</code></li>
<li>fixed that RT RAM flush could occasionally drop JSON attribute
index(es)</li>
<li>fixed missing dict fileinfos after <code>ATTACH</code> and a
subsequent flush</li>
<li>fixed <code>GEODIST()</code> vs extreme argument value deltas</li>
<li>fixed that searches failed to access docstore after plain-to-RT
<code>ATTACH</code></li>
<li>fixed <code>exact_hit</code> signal calculations vs non-ranked
fields</li>
<li>fixed pretty-printing in pure distributed case (for
<code>FACTORS()</code>, JSON, etc)</li>
<li>fixed that template index name was not properly reported in
errors/warnings</li>
<li>fixed <code>SHOW PROFILE</code> within multi-statement requests</li>
<li>fixed attribute indexes on signed columns</li>
<li>fixed that <code>DESCRIBE</code> only printed out one attribute
index per column</li>
<li>fixed a race and a crash in <code>SHOW TABLES</code></li>
<li>fixed <code>FACTORS()</code> vs missing <code>MATCH()</code>
crash</li>
<li>fixed a rare crash in token len calculation</li>
<li>fixed a number of leaks and races</li>
</ul>
<h3 id="version-3.3.1-06-jul-2020">Version 3.3.1, 06 jul 2020</h3>
<p>New features:</p>
<ul>
<li>added <a href="#udf-call-batching">UDF call batching</a> that
enables UDFs to process multiple matched rows at a time</li>
<li>added <a href="#pp-function"><code>PP()</code></a> pretty-printing
function for <code>FACTORS()</code> and JSON values</li>
<li>added multi-threaded index loading</li>
<li>added <a href="#kill-syntax"><code>KILL &lt;tid&gt;</code></a>
SphinxQL statement</li>
<li>added <a
href="#show-index-agent-status-syntax"><code>SHOW INDEX &lt;idx&gt; AGENT STATUS</code></a>
SphinxQL statement, and moved per-agent counters there from
<code>SHOW STATUS</code></li>
</ul>
<p>Minor new additions:</p>
<ul>
<li>added a number of runtime <a
href="#server-variables-reference">server variables</a> to <a
href="#show-variables-syntax"><code>SHOW VARIABLES</code></a>, namely
<ul>
<li>added <code>log_debug_filter</code>, <code>net_spin_msec</code>,
<code>query_log_min_msec</code>, <code>sql_fail_filter</code>, and
<code>sql_log_file</code></li>
<li>moved <code>attrindex_thresh</code>,
<code>siege_max_fetched_docs</code>, <code>siege_max_query_msec</code>,
<code>qcache_max_bytes</code>, <code>qcache_thresh_msec</code>, and
<code>qcache_ttl_sec</code> from <code>SHOW STATUS</code></li>
</ul></li>
<li>added support for <code>SET GLOBAL server_var</code> in
<code>sphinxql_state</code> startup script</li>
</ul>
<p>Changes and improvements:</p>
<ul>
<li>removed <code>timestamp</code> columns support, use
<code>uint</code> type instead (existing indexes are still supported;
<code>timestamp</code> should automatically work as <code>uint</code> in
those)</li>
<li>removed <code>OPTION idf</code> and unified IDF calculations, see <a
href="#how-sphinx-computes-idf">“How Sphinx computes IDF”</a></li>
<li>changed <code>WEIGHT()</code> from integer to float</li>
<li>changed <code>global_idf</code> behavior; now missing terms get
local IDF instead of zero</li>
<li>changed <code>OPTION cutoff</code> to properly account all processed
matches</li>
<li>changed directives deprecated in v.3.1 and earlier to hard
errors</li>
<li>optimized indexing a little (about 1-2% faster)</li>
<li>optimized <code>DOT()</code> over <code>int8</code> vectors, up to
1.3x faster</li>
<li>optimized query throughput on fast read-only queries up to 350+ Krps
(various internal locking and performance changes, aka “highload
optimizations”)</li>
<li>improved float value formatting, mostly in SphinxQL output</li>
<li>improved <code>UPDATE</code> handling, updates can now execute in
parallel (again)</li>
<li>improved index schema checks (more checks for invalid names,
etc)</li>
<li>increased <code>SHOW THREADS</code> query limit from 512 to 2048
bytes</li>
</ul>
<p>Fixes:</p>
<ul>
<li>fixed UDF memory leak when using a <code>FACTORS()</code> argument,
and optimized that case a little</li>
<li>fixed <code>sql_log_file</code> race that caused (rare-ish) crashes
under high query load</li>
<li>fixed that facets with expressions could occasionally yield either
missing or incorrect resulting rows</li>
<li>fixed an overflow in docid hash (triggered on rather huge
indexes)</li>
<li>fixed that <code>CALL KEYWORDS</code> did not use normalized term on
<code>global_idf</code> lookup</li>
<li>fixed expression types issue when doing mixed int/float const
promotion</li>
<li>fixed that RAM segments did not account the docid hash size</li>
<li>fixed that <code>INSERT</code> only checked RAM segments for
duplicate docids</li>
<li>fixed an internal error on <code>COUNT(*)</code> vs empty RT</li>
</ul>
<h3 id="version-3.2.1-31-jan-2020">Version 3.2.1, 31 jan 2020</h3>
<p>New features:</p>
<ul>
<li>added <a href="#term-or-operator">term-OR operator</a> for proper
query-level synonyms, for example
<code>(red || green || blue) pixel</code></li>
<li>added <a href="#document-only-mappings">document-only wordforms</a>,
for example <code>!indexme =&gt; differently</code></li>
<li>added several <a href="#searching-vector-searches">vector search</a>
improvements
<ul>
<li>added int8/int/float fixed-width <a
href="#using-array-attributes">array attributes</a> support, for example
<code>sql_attr_int8_array = myvec[128]</code></li>
<li>added <a href="#dot-function"><code>DOT()</code></a> support for all
those new array types</li>
<li>added int8 vectors support to JSON, and <code>int8[]</code> and
<code>float[]</code> <a href="#using-json">JSON syntax
extensions</a></li>
<li>added <a href="#fvec-function"><code>FVEC(json.field)</code></a>
support to expressions, and the respective
<code>SPH_UDF_TYPE_FLOAT_VEC</code> support to UDFs</li>
</ul></li>
<li>added <a href="#bulk-update-syntax"><code>BULK UPDATE</code></a>
SphinxQL statement</li>
<li>added attribute index reads for multi-GEODIST-OR queries, up to 15x+
speedup (see section on <a href="#searching-geosearches">geosearches</a>
for details)</li>
<li>added <a href="#siege-mode">siege mode</a>, temporary global query
limits with <code>SET GLOBAL siege</code></li>
<li>added <code>sum_idf_boost</code>, <code>is_noun_hits</code>,
<code>is_latin_hits</code>, <code>is_number_hits</code>,
<code>has_digit_hits</code> per-field ranking
factors](#ranking-factors)</li>
<li>added <code>is_noun</code>, <code>is_latin</code>,
<code>is_number</code>, and <code>has_digit</code> per-term flags; added
the respective <code>is_noun_words</code>, <code>is_latin_words</code>,
<code>is_number_words</code>, and <code>has_digit_words</code> per-query
ranking factors; and added query factors support to UDFs (see
<code>sphinxudf.h</code>)</li>
<li>added online query stream filtering with <a
href="#sql_fail_filter-variable"><code>SET GLOBAL sql_fail_filter</code></a></li>
<li>added online query stream logging with <a
href="#sql_log_file-variable"><code>SET GLOBAL sql_log_file</code></a></li>
<li>added <a href="#slice-functions"><code>SLICEAVG</code>,
<code>SLICEMAX</code>, <code>SLICEMIN</code></a> functions, and <a
href="#strpos-function"><code>STRPOS(str,conststr)</code></a>
function</li>
</ul>
<p>Minor new additions:</p>
<ul>
<li>added hash-comment support to <code>exceptions</code> files</li>
<li>added <code>--dummy &lt;arg&gt;</code> switch to
<code>searchd</code> (useful to quickly identify specific instances in
the process list)</li>
<li>added IDF info, term flags, and JSON format output to
<code>CALL KEYWORDS</code> (for JSON output, call it with
<code>CALL KEYWORDS(..., 1 AS json)</code></li>
<li>added <code>IS NULL</code> and <code>IS NOT NULL</code> checks to
<code>ALL()</code> and <code>ANY()</code> JSON iterators</li>
<li>added <code>last_good_id</code> to TSV indexing error reporting</li>
<li>added <code>ram_segments</code> counter to
<code>SHOW INDEX STATUS</code>, and renamed two counters
(<code>ram_chunk</code> to <code>ram_segments_bytes</code>,
<code>disk_chunks</code> to <code>disk_segments</code>)</li>
<li>added <code>sql_query_kbatch</code> directive, deprecated
<code>sql_query_killlist</code> directive</li>
<li>added <code>&lt;sphinx:kbatch&gt;</code> support to XML source</li>
<li>documented a few semi-hidden options (<code>net_spin_msec</code> for
example)</li>
</ul>
<p>Changes and improvements:</p>
<ul>
<li>improved parsing of long constant lists in expressions, requires
much less <code>thread_stack</code> now</li>
<li>improved <code>stopwords</code> handling, fixed the hash collisions
issue</li>
<li>improved <code>stopwords</code> directive, made it multi-valued</li>
<li>improved <code>global_idf</code> handling, made global IDFs totally
independent from per-index DFs</li>
<li>improved <code>EXPLAIN</code>, ensured that it always reports real
query plan and stats</li>
<li>improved stats precision output for query times under 1 msec, and
generally increased internal query timing precision</li>
<li>improved argument types checking in expressions, and fixed a bunch
of missed cases (issues on <code>GEODIST()</code> vs JSON, crash in
<code>COALESCE()</code> args check, etc)</li>
<li>improved <code>FACET</code> handling, single-search optimization
must now always engage</li>
<li>changed <code>indexer --nohup</code> to rename index files to
<code>.new</code> on success</li>
<li>changed <code>query_time</code> metric behavior for distributed
indexes, now it will account wall time</li>
<li>removed “search all indexes” syntax leftovers that were possible via
SphinxAPI</li>
<li>removed umask on <code>searchd.log</code></li>
</ul>
<p>Major optimizations:</p>
<ul>
<li>optimized frequent 1-part and 2-part <code>ORDER BY</code> clauses,
up to 1.1x speedup</li>
<li>optimized full scan queries, up to 1.2x+ speedup</li>
<li>optimized <code>DOT()</code> for a few cases like <code>int8</code>
vectors, up to 2x+ speedup</li>
<li>optimized facets, up to 1.1x speedup</li>
</ul>
<p>Fixes:</p>
<ul>
<li>fixed that <code>ORDER BY RAND()</code> was breaking
<code>WEIGHT()</code> (also, enabled it for grouping queries)</li>
<li>fixed hash-comment syntax in wordforms</li>
<li>fixed a couple races in wordforms</li>
<li>fixed a couple deadlocks related to <code>ATTACH</code></li>
<li>fixes a few issues with <code>max_window_hits()</code> and
<code>exact_order</code> factors</li>
<li>fixed a rare B-tree crash when inserting duplicate values</li>
<li>fixed a rare TSV indexing issue (well-formed file could fail
indexing because of a very rare buffer boundary issue)</li>
<li>fixed occasional crashes on distributed searches on some CPU and
glibc combos (double release)</li>
<li>fixed incorrect <code>SHOW META</code> after index-less
<code>SELECT</code></li>
<li>fixed <code>ALL()</code> and <code>ANY()</code> vs optimized JSON
vectors, and fixed optimized int64 JSON vector accessor</li>
<li>fixed that <code>SHOW THREADS ... OPTION columns=X</code> limit
permanently clipped the thread descriptions</li>
<li>fixed <code>/searchd</code> HTTP endpoint error format</li>
<li>fixed per-index query stats vs RT indexes</li>
<li>fixed that query parser could occasionally fail on high ASCII
codes</li>
<li>fixed a few issues causing incorrect or unexpected handling of
<code>cutoff</code> and other query limits</li>
<li>fixed a few <code>json_packed_keys</code> issues</li>
<li>fixed MVA64 values clipping on <code>INSERT</code></li>
<li>fixed occasional crashes and/or memory corruption on
<code>UPDATE</code> and <code>INSERT</code></li>
<li>fixed <code>SNIPPET(field,QUERY())</code> case to some extent (we
now filter out query syntax and treat <code>QUERY()</code> as a bag of
words in this case)</li>
<li>fixed that index reads on JSON in RT could erroneously disable other
<code>WHERE</code> conditions from the query</li>
<li>fixed a number of facets-related issues (occasionally non-working
parallel execution, occasional crashes, etc)</li>
<li>fixed a crash on empty index list via SphinxAPI</li>
<li>fixed schema attributes order for XML/TSV/CSV sources</li>
<li>fixed sticky <code>regexp_filter</code> vs <code>ATTACH</code></li>
</ul>
<h3 id="version-3.1.1-17-oct-2018">Version 3.1.1, 17 oct 2018</h3>
<ul>
<li>added <code>indexer --dump-rows-tsv</code> switch, and renamed
<code>--dump-rows</code> to <code>--dump-rows-sql</code></li>
<li>added initial <code>COALESCE()</code> function support for JSONs
(beware that it will compute everything in floats!)</li>
<li>added support for <code>!=</code>, <code>IN</code>, and
<code>NOT IN</code> syntax to expressions</li>
<li>added <code>prefix_tokens</code> and <code>suffix_tokens</code>
options to <code>blend_mode</code> directive</li>
<li>added <code>OPTION rank_fields</code>, lets you specify fields to
use for ranking with either expression or ML (UDF) rankers</li>
<li>added explicit duplicate documents (docids) suppression back into
<code>indexer</code></li>
<li>added <code>batch_size</code> variable to
<code>SHOW META</code></li>
<li>added <code>csvpipe_header</code> and <code>tsvpipe_header</code>
directives</li>
<li>added <code>sql_xxx</code> counters to <code>SHOW STATUS</code>,
generally cleaned up counters</li>
<li>added mixed codes indexing, available via
<code>blend_mixed_codes</code> and <code>mixed_codes_fields</code>
directives</li>
<li>added <code>OPTION inner_limit_per_index</code> to explicitly
control reordering in a nested sharded select</li>
<li>added a hard limit for <code>max_matches</code> (must be under
100M)</li>
<li>optimized Postgres indexing CPU and RAM use quite significantly</li>
<li>optimized <code>FACET</code> queries with expressions and simple
by-attribute (no aliases!) facets; multi-sort optimization now works in
that case</li>
<li>optimized <code>id</code> lookups (queries like
<code>UPDATE ... WHERE id=123</code> should now be much faster)</li>
<li>optimized result set aggregation vs nested sharded selects</li>
<li>optimized <code>PACKEDFACTORS()</code> storage a lot (up to 60x
speedup with <code>max_matches=50000</code>)</li>
<li>improved UDF error handling, the error argument is now a message
buffer instead of just a 1-char flag</li>
<li>improved the nested sharded select reordering, less confusing now
(by default, does <em>not</em> scale the inner <code>LIMIT</code>
anymore)</li>
<li>improved <code>searchd --listen</code> switch, multiple
<code>--listen</code> instances are now allowed, and
<code>--console</code> is <em>not</em> required anymore</li>
<li>improved failed allocation reporting, and added huge allocation
tracking</li>
<li>removed legacy <code>@count</code>, <code>@weight</code>,
<code>@expr</code>, <code>@geodist</code> syntax support</li>
<li>removed legacy <code>SetWeights()</code>,
<code>SetMatchMode()</code>, <code>SetOverride()</code>,
<code>SetGeoAnchor()</code> calls, <code>SPH_MATCH_xxx</code> constants,
and <code>SPH_SORT_EXPR</code> sorting mode from APIs</li>
<li>removed legacy <code>spelldump</code> utility</li>
<li>removed unused <code>.sha</code> index files</li>
<li>removed extraneous “no extra index definitions” warning</li>
</ul>
<p>Major fixes:</p>
<ul>
<li>fixed 9+ crashes caused by certain complex (and usually rare)
conditions and/or settings combinations</li>
<li>fixed 2 crashes caused by broken index data (in vrows and
dictionaries)</li>
<li>fixed plain index locking issues on Windows</li>
<li>fixed JSON fields handling vs strings and NULLs (no more corner
cases like NULL objects passing a test for json.col=0)</li>
<li>fixed matches loss issue in positional (phrase/order/sentence etc)
operators and modifiers under certain conditions</li>
<li>fixed hashing-related hangups under certain (rather rare)
occasions</li>
<li>fixed several type inference issues in expressions when using JSON
fields</li>
</ul>
<p>Other fixes:</p>
<ul>
<li>fixed that <code>min_best_span_pos</code> was sometimes off</li>
<li>fixed the behavior on missing <code>global_idf</code> file</li>
<li>fixed <code>indextool --check</code> vs string attributes, and vs
empty JSONs</li>
<li>fixed blended vs multiforms behavior (works much more predictably
now)</li>
<li>fixed query parser vs wildcard-only tokens</li>
<li>fixed that MySQL 8.0+ clients failed to connect</li>
<li>fixed occasional semaphore races on startup</li>
<li>fixed <code>OPTIMIZE</code> vs <code>UPDATE</code> race;
<code>UPDATE</code> can now fail with a timeout</li>
<li>fixed <code>indexer --merge --rotate</code> vs kbatches</li>
<li>fixed occasional rotation-related deadlock</li>
<li>fixed a few memory leaks</li>
</ul>
<h3 id="version-3.0.3-30-mar-2018">Version 3.0.3, 30 mar 2018</h3>
<ul>
<li>added <code>BITCOUNT()</code> function and bitwise-NOT operator, eg
<code>SELECT BITCOUNT(~3)</code></li>
<li>made <code>searchd</code> config section completely optional</li>
<li>improved <code>min_infix_len</code> behavior, required 2-char
minimum is now enforced</li>
<li>improved docs, added a few sections</li>
<li>fixed binary builds performance</li>
<li>fixed several crashes (related to docstore, snippets, threading,
<code>json_packed_keys</code> in RT)</li>
<li>fixed docid-less SQL sources, forbidden those for now (docid still
required)</li>
<li>fixed int-vs-float precision issues in expressions in certain
cases</li>
<li>fixed <code>uptime</code> counter in <code>SHOW STATUS</code></li>
<li>fixed query cache vs <code>PACKEDFACTORS()</code></li>
</ul>
<h3 id="version-3.0.2-25-feb-2018">Version 3.0.2, 25 feb 2018</h3>
<ul>
<li>added <code>full_field_hit</code> ranking factor</li>
<li>added <code>bm15</code> ranking factor name (legacy
<code>bm25</code> name misleading, to be removed)</li>
<li>optimized RT inserts significantly (up to 2-6x on certain benchmarks
vs 3.0.1)</li>
<li>optimized <code>exact_field_hit</code> ranking factor, impact now
negligible (approx 2-4%)</li>
<li>improved <code>indexer</code> output, less visual noise</li>
<li>improved <code>searchd --safetrace</code> option, now skips
<code>addr2line</code> to avoid occasional freezes</li>
<li>improved <code>indexer</code> MySQL driver lookup, now also checking
for <code>libmariadb.so</code></li>
<li>fixed rare occasional <code>searchd</code> crash caused by attribute
indexes</li>
<li>fixed <code>indexer</code> crash on missing SQL drivers, and
improved error reporting</li>
<li>fixed <code>searchd</code> crash on multi-index searches with
docstore</li>
<li>fixed that expression parser failed on field-shadowing attributes in
<code>BM25F()</code> weights map</li>
<li>fixed that <code>ALTER</code> failed on field-shadowing attributes
vs <code>index_field_lengths</code> case</li>
<li>fixed junk data writes (seemingly harmless but anyway) in certain
cases</li>
<li>fixed rare occasional <code>searchd</code> startup failures
(threading related)</li>
</ul>
<h3 id="version-3.0.1-18-dec-2017">Version 3.0.1, 18 dec 2017</h3>
<ul>
<li>first public release of 3.x branch</li>
</ul>
<h2 id="changes-since-v.2.x">Changes since v.2.x</h2>
<p>The biggest changes in v.3.0.1 (late 2017) since Sphinx v.2.x (late
2016) were:</p>
<ul>
<li>added DocStore, document storage
<ul>
<li>original document contents can now be stored into the index</li>
<li>disk based storage, RAM footprint should be minimal</li>
<li>goodbye, <em>having</em> to query Another Database to fetch
data</li>
</ul></li>
<li>added new attributes storage format
<ul>
<li>arbitrary updates support (including MVA and JSON)</li>
<li>goodbye, sudden size limits</li>
</ul></li>
<li>added attribute indexes, with JSON support
<ul>
<li>… <code>WHERE gid=123</code> queries can now utilize A-indexes</li>
<li>… <code>WHERE MATCH('hello') AND gid=123</code> queries can now
efficiently intersect FT-indexes and A-indexes</li>
<li>goodbye, <em>having</em> to use fake keywords</li>
</ul></li>
<li>added compressed JSON keys</li>
<li>switched to rowids internally, and forced all docids to 64 bits</li>
</ul>
<p>Another two big changes that are already available but still in
pre-alpha are:</p>
<ul>
<li>added “zero config” mode (<code>./sphinxdata</code> folder)</li>
<li>added index replication</li>
</ul>
<p>The additional smaller niceties are:</p>
<ul>
<li>added always-on support for xmlpipe, snowball stemmers, and re2
(regexp filters)</li>
<li>added <code>blend_mode=prefix_tokens</code>, and enabled empty
<code>blend_mode</code></li>
<li>added <code>kbatch_source</code> directive, to auto-generate
k-batches from source docids (in addition to explicit queries)</li>
<li>added <code>SHOW OPTIMIZE STATUS</code> statement</li>
<li>added <code>exact_field_hit</code> ranking factor</li>
<li>added <code>123.45f</code> value syntax in JSON, optimized support
for float32 vectors, and <code>FVEC()</code> and <code>DOT()</code>
functions</li>
<li>added preindexed data in document storage to speed up
<code>SNIPPETS()</code> (via <code>hl_fields</code> directive)</li>
<li>changed field weights, zero and negative weights are now
allowed</li>
<li>changed stemming, keywords with digits are now excluded</li>
</ul>
<p>A bunch of legacy things were removed:</p>
<ul>
<li>removed <code>dict</code>, <code>docinfo</code>,
<code>infix_fields</code>, <code>prefix_fields</code> directives</li>
<li>removed <code>attr_flush_period</code>, <code>hit_format</code>,
<code>hitless_words</code>, <code>inplace_XXX</code>,
<code>max_substring_len</code>, <code>mva_updates_pool</code>,
<code>phrase_boundary_XXX</code>, <code>sql_joined_field</code>,
<code>subtree_XXX</code> directives</li>
<li>removed legacy id32 and id64 modes, mysqlSE plugin, and
<code>indexer --keep-attrs</code> switch</li>
</ul>
<p>And last but not least, the new config directives to play with
are:</p>
<ul>
<li><code>docstore_type</code>, <code>docstore_block</code>,
<code>docstore_comp</code> (per-index) and
<code>docstore_cache_size</code> (global) let you generally configure
DocStore</li>
<li><code>stored_fields</code>, <code>stored_only_fields</code>,
<code>hl_fields</code> (per-index) let you configure what to put in
DocStore</li>
<li><code>kbatch</code>, <code>kbatch_source</code> (per-index) update
the legacy k-lists-related directives</li>
<li><code>updates_pool</code> (per-index) sets vrow file growth
step</li>
<li><code>json_packed_keys</code> (<code>common</code> section) enables
the JSON keys compression</li>
<li><code>binlog_flush_mode</code> (<code>searchd</code> section)
changes the per-op flushing mode (0=none, 1=fsync, 2=fwrite)</li>
</ul>
<p>Quick update caveats:</p>
<ul>
<li>if you were using <code>sql_query_killlist</code> then you now
<em>must</em> explicitly specify <code>kbatch</code> and list all the
indexes that the k-batch should be applied to:</li>
</ul>
<div class="sourceCode" id="cb775"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb775-1"><a href="#cb775-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sql_query_killlist</span> = SELECT deleted_id FROM my_deletes_log</span>
<span id="cb775-2"><a href="#cb775-2" aria-hidden="true" tabindex="-1"></a><span class="ex">kbatch</span> = main</span>
<span id="cb775-3"><a href="#cb775-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb775-4"><a href="#cb775-4" aria-hidden="true" tabindex="-1"></a><span class="co"># or perhaps:</span></span>
<span id="cb775-5"><a href="#cb775-5" aria-hidden="true" tabindex="-1"></a><span class="co"># kbatch = shard1,shard2,shard3,shard4</span></span></code></pre></div>
<h2 id="references">References</h2>
<p>Nothing to see here, just a bunch of Markdown links that are too long
to inline!</p>
<h2 id="copyrights">Copyrights</h2>
<p>This documentation is copyright (c) 2017-2025, Andrew Aksyonoff. The
author hereby grants you the right to redistribute it in a verbatim
form, along with the respective copy of Sphinx it came bundled with. All
other rights are reserved.</p>
</div>
<script>
(function() {
  // Make TOC headings collapse, and install click handlers
  document.querySelectorAll('#TOC > ul > li').forEach(function(li) {
    if (li.children.length <= 1)
      return;

    var t = document.createElement('span');
    t.innerHTML = '&#9655'; // U+25B7 White Right-Pointing Triangle
    t.onclick = function() {
      li.classList.toggle('expn');
      li.classList.toggle('coll');
    };

    li.className = 'toggle coll';
    li.insertBefore(t, li.children[0]);

    a = li.getElementsByTagName('a')[0];
    a.addEventListener("dblclick", function() { t.onclick() });
  });

  // Hovers and active nav tracking for headers
  document.querySelectorAll('.docbody h2, .docbody h3, .docbody h4').forEach(function(h) {
    h.innerHTML = '<a href="#' + h.id + '" onclick="NavScroll(\'#' + h.id + '\')">&nbsp;</a> ' + h.innerHTML;
  });

  // Active nav tracking for TOC
  document.querySelectorAll('#TOC > ul li').forEach(function(li) {
    a = li.getElementsByTagName('a')[0];
    a.addEventListener("click", function(e) { NavActive(li) });
  });

  // Color my blockquotes
  document.querySelectorAll('blockquote').forEach(function(q) {
    p = q.children[0];
    if (p.tagName != 'P' || !(p.textContent.startsWith('NOTE! ') || p.textContent.startsWith('WARNING! ')))
      return;
    is_warn = p.textContent.startsWith('WARNING! ');

    p.textContent = p.textContent.substr(is_warn ? 9 : 5);
    q.className = is_warn ? 'warn' : 'note';

    var t = document.createElement('p');
    t.innerHTML = is_warn ? 'Warning!' : 'Note!';
    t.className = is_warn ? 'warn' : 'note';
    q.insertBefore(t, p);
  });
})();

function SetToggles(state)
{
  document.querySelectorAll('#TOC > ul > li.toggle').forEach(function(li) {
    li.className = 'toggle ' + state;
  });
  return false;
}

function NavActive(li)
{
  document.querySelectorAll('#TOC > ul li.active').forEach(function(x) {
    x.classList.remove('active');
  });
  li.classList.add('active');
}

function NavScroll(to)
{
  document.querySelectorAll('#TOC > ul li').forEach(function(li) {
    a = li.getElementsByTagName('a')[0];
    if (!a.href.endsWith(to))
      return;

    NavActive(li);
    li2 = li.parentNode.parentNode;
    if (li2.classList.contains('toggle')) {
      li2.classList.remove('coll');
      li2.classList.remove('expn');
    }

    var nav = document.querySelectorAll('#TOC')[0];
    var pos = li.offsetTop - (nav.getBoundingClientRect().height - li.getBoundingClientRect().height) / 2;
    nav.scrollTo({top: pos, behavior: 'smooth'});
  });
  return true;
}
</script>
</body>

</html>
<!-- generated from commit 141d2ea -->
